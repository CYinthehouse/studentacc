<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Korean TA Evaluation System - Complete</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', Roboto, Arial, sans-serif;
  background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
  background-size: auto;
  min-height: 100vh;
  color: #333;
  overflow-x: hidden;
}

/* Login page background - same as body now */
body.login-page {
  background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
  background-size: auto;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.auth-container {
  max-width: 450px;
  margin: 40px auto;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  background: transparent;
  box-shadow: none;
}

.auth-container.with-form {
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.auth-logo {
  max-width: 280px;
  margin: 0 auto 20px;
  display: block;
}

.auth-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 28px;
  color: white;
  text-shadow:
    -3px -3px 0 #41c0ff,
    3px -3px 0 #41c0ff,
    -3px 3px 0 #41c0ff,
    3px 3px 0 #41c0ff,
    0 0 20px rgba(65, 192, 255, 0.5);
  margin-bottom: 40px;
}

/* Auth views with fade transitions */
.auth-view {
  opacity: 0;
  transform: translateY(15px);
  transition: opacity 0.5s ease, transform 0.5s ease;
  display: none;
  pointer-events: none;
}

.auth-view.active {
  opacity: 1;
  transform: translateY(0);
  display: block;
  pointer-events: auto;
}

.auth-view.fade-out {
  opacity: 0;
  transform: translateY(-15px);
}

/* Main buttons container */
.auth-main-buttons {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-top: 30px;
}

/* Retro button styling */
.retro-btn {
  font-family: 'Press Start 2P', cursive;
  font-size: 14px;
  padding: 18px 30px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    -2px 0 0 #000,
    2px 0 0 #000,
    0 -2px 0 #000,
    0 2px 0 #000;
  box-shadow: 0 6px 0 rgba(0,0,0,0.3), 0 8px 20px rgba(0,0,0,0.3);
}

.retro-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 9px 0 rgba(0,0,0,0.3), 0 12px 25px rgba(0,0,0,0.4);
}

.retro-btn:active {
  transform: translateY(2px);
  box-shadow: 0 3px 0 rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.3);
}

.retro-btn-blue {
  background: linear-gradient(180deg, #41c0ff 0%, #0099dd 100%);
  color: white;
}

.retro-btn-red {
  background: linear-gradient(180deg, #ff7777 0%, #dd3333 100%);
  color: white;
}

.retro-btn-gray {
  background: linear-gradient(180deg, #888 0%, #555 100%);
  color: white;
  font-size: 10px;
  padding: 12px 20px;
}

/* Getting started message */
.getting-started-message {
  font-family: 'Press Start 2P', cursive;
  font-size: 12px;
  line-height: 2;
  color: white;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    -2px 0 0 #000,
    2px 0 0 #000,
    0 -2px 0 #000,
    0 2px 0 #000;
  padding: 30px 20px;
}

/* Back button */
.back-btn {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  background: transparent;
  border: 2px solid rgba(255,255,255,0.5);
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 20px;
  transition: all 0.3s ease;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    -2px 0 0 #000,
    2px 0 0 #000,
    0 -2px 0 #000,
    0 2px 0 #000;
}

.back-btn:hover {
  background: rgba(255,255,255,0.1);
  border-color: white;
}

/* Login form styling updates */
.auth-container .form-group label {
  color: white;
  font-family: 'Noto Sans', sans-serif;
  font-size: 10px;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
}

.auth-container .form-group input,
.auth-container .form-group select {
  background: rgba(255,255,255,0.9);
  border: 2px solid rgba(255,255,255,0.3);
}

.auth-container .form-group input:focus,
.auth-container .form-group select:focus {
  border-color: #4da6ff;
  box-shadow: 0 0 0 3px rgba(77, 166, 255, 0.3);
}

/* Demo accounts box */
.demo-accounts {
  margin-top: 25px;
  padding: 15px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
}

.demo-accounts h4 {
  color: white;
  font-family: 'Noto Sans', sans-serif;
  font-size: 10px;
  margin-bottom: 10px;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
}

.demo-accounts-box {
  font-size: 11px;
  color: rgba(255,255,255,0.9);
}

.demo-account-item {
  margin: 8px 0;
}

.auth-container h1 {
  text-align: center;
  color: #667eea;
  margin-bottom: 30px;
  font-size: 28px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #555;
  font-weight: 600;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn:hover {
  background: #5a67d8;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: #48bb78;
}

.btn-secondary:hover {
  background: #38a169;
}

.btn-danger {
  background: #f56565;
}

.btn-danger:hover {
  background: #e53e3e;
}

.btn-warning {
  background: #ed8936;
}

.btn-warning:hover {
  background: #dd6b20;
}

.dashboard {
  background: linear-gradient(180deg, #1e1e3a 0%, #151528 100%);
  border-radius: 0;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

/* Light/Dark Mode Toggle - Fixed position top right */
.theme-toggle-container {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 9999;
}

/* From Uiverse.io by andrew-demchenk0 */
.switch {
  font-size: 17px;
  position: relative;
  display: inline-block;
  width: 64px;
  height: 34px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #73C0FC;
  transition: .4s;
  border-radius: 30px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 30px;
  width: 30px;
  border-radius: 20px;
  left: 2px;
  bottom: 2px;
  z-index: 2;
  background-color: #e8e8e8;
  transition: .4s;
}
.sun svg {
  position: absolute;
  top: 6px;
  left: 36px;
  z-index: 1;
  width: 24px;
  height: 24px;
}
.moon svg {
  fill: #73C0FC;
  position: absolute;
  top: 5px;
  left: 5px;
  z-index: 1;
  width: 24px;
  height: 24px;
}
.sun svg {
  animation: rotate 15s linear infinite;
}
@keyframes rotate {
  0% {
    transform: rotate(0);
  }
  100% {
    transform: rotate(360deg);
  }
}
.moon svg {
  animation: tilt 5s linear infinite;
}
@keyframes tilt {
  0% {
    transform: rotate(0deg);
  }
  25% {
    transform: rotate(-10deg);
  }
  75% {
    transform: rotate(10deg);
  }
  100% {
    transform: rotate(0deg);
  }
}
.switch input:checked + .slider {
  background-color: #183153;
}
.switch input:focus + .slider {
  box-shadow: 0 0 1px #183153;
}
.switch input:checked + .slider:before {
  transform: translateX(30px);
}

/* Light mode styles */
body.light-mode .dashboard {
  background: linear-gradient(180deg, #e8f4ff 0%, #d0e8ff 100%);
}

body.light-mode {
  background: #5dd0ff;
}

body.light-mode .dashboard-header {
  background: linear-gradient(135deg, #4a90c2 0%, #3a7ab0 100%);
}

body.light-mode .sidebar {
  background: linear-gradient(180deg, #4a90c2 0%, #3a7ab0 100%);
}

body.light-mode .sidebar-dropdown-header {
  color: white;
}

body.light-mode .sidebar-dropdown-content {
  background: rgba(255, 255, 255, 0.2);
}

body.light-mode .sidebar-item {
  color: rgba(255, 255, 255, 0.9);
}

body.light-mode .main-content-area {
  background: linear-gradient(180deg, #e8f4ff 0%, #d0e8ff 100%);
  color: #1a1a2e;
}

body.light-mode .tab-content {
  color: #1a1a2e;
}

body.light-mode .tab-content h2 {
  color: #2a6090;
}

body.light-mode .tab-content p {
  color: #3a4a5a;
}

body.light-mode .test-card,
body.light-mode .chart-container,
body.light-mode .topic-improvements,
body.light-mode .analytics-summary,
body.light-mode .summary-card {
  background: linear-gradient(180deg, #ffffff 0%, #f0f8ff 100%);
  border: 1px solid #b0d0e8;
  color: #1a1a2e;
}

body.light-mode .test-card h3,
body.light-mode .chart-container h3,
body.light-mode .topic-improvements h3 {
  color: #2a6090;
  border-bottom-color: #b0d0e8;
}

body.light-mode .main-content-area .form-group input,
body.light-mode .main-content-area .form-group select,
body.light-mode .main-content-area .form-group textarea {
  background: #ffffff;
  border: 2px solid #b0d0e8;
  color: #1a1a2e;
}

body.light-mode .main-content-area .form-group label {
  color: #3a4a5a;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 20px;
  border-bottom: none;
  background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
  border-bottom: 3px solid #41c0ff;
}

.dashboard-header h1 {
  color: white;
  font-size: 30px;
  font-family: 'Noto Sans', sans-serif;
  font-weight: 700;
  text-shadow:
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    2px 2px 0 #000,
    -2px 0 0 #000,
    2px 0 0 #000,
    0 -2px 0 #000,
    0 2px 0 #000;
  display: flex;
  align-items: center;
  gap: 15px;
  margin: 0;
  padding: 0;
  line-height: 1;
}

.dashboard-header h1::before {
  content: '';
  display: inline-block;
  width: 105px;
  height: 105px;
  background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221') no-repeat center center;
  background-size: contain;
  flex-shrink: 0;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-info span {
  font-family: 'Noto Sans', sans-serif;
  font-size: 17px;
  font-weight: 600;
  color: white;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
}

.user-info .status-badge {
  font-family: 'Noto Sans', sans-serif;
  font-size: 17px;
  font-weight: 600;
  padding: 10px 16px;
  border-radius: 5px;
}

.user-info .btn-danger {
  font-family: 'Noto Sans', sans-serif;
  font-size: 17px;
  font-weight: 600;
  background: linear-gradient(180deg, #ff7777 0%, #dd3333 100%);
  color: white;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
  border: none;
  padding: 14px 20px;
}

.user-info .btn-danger:hover {
  background: linear-gradient(180deg, #ff8888 0%, #ee4444 100%);
}

/* Sidebar Navigation - Retro Theme */
.dashboard-with-sidebar {
  display: flex;
  gap: 0;
}

.sidebar {
  width: 320px;
  background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
  border-right: 3px solid #41c0ff;
  padding: 20px 15px;
  min-height: calc(100vh - 100px);
  flex-shrink: 0;
}

.sidebar-section {
  margin-bottom: 10px;
}

.sidebar-dropdown-header {
  padding: 12px 15px;
  background: transparent;
  border: none;
  width: 100%;
  text-align: left;
  font-size: 17px;
  font-family: 'Noto Sans', sans-serif;
  font-weight: 600;
  color: white;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  border-left: 4px solid transparent;
  border-radius: 8px;
}

.sidebar-dropdown-header:hover {
  background: rgba(65, 192, 255, 0.2);
  border-left-color: #41c0ff;
}

.sidebar-dropdown-header.active {
  background: rgba(65, 192, 255, 0.3);
  color: #41c0ff;
  border-left-color: #41c0ff;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000,
    0 0 10px rgba(65, 192, 255, 0.5);
}

.dropdown-icon {
  transition: transform 0.3s;
  color: #41c0ff;
}

.sidebar-dropdown-header.active .dropdown-icon {
  transform: rotate(180deg);
}

.sidebar-dropdown-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  margin-top: 5px;
}

.sidebar-dropdown-content.open {
  max-height: 500px;
}

.sidebar-item {
  padding: 10px 15px 10px 30px;
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  font-size: 15px;
  font-family: 'Noto Sans', sans-serif;
  color: rgba(255, 255, 255, 0.8);
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
  cursor: pointer;
  transition: all 0.3s;
  border-left: 4px solid transparent;
}

.sidebar-item:hover {
  background: rgba(65, 192, 255, 0.1);
  color: #41c0ff;
  border-left-color: #41c0ff;
}

.sidebar-item.active {
  background: rgba(65, 192, 255, 0.2);
  color: #41c0ff;
  font-weight: 600;
  border-left-color: #41c0ff;
  text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000,
    0 0 8px rgba(65, 192, 255, 0.4);
}

/* Main content area - Dark mode */
.main-content-area {
  flex: 1;
  padding: 30px;
  background: linear-gradient(180deg, #1e1e3a 0%, #151528 100%);
  color: #e0e0e0;
  font-family: 'Noto Sans', sans-serif;
  font-size: 16px;
  overflow-x: hidden;
  max-width: 100%;
}

/* Dark mode for content cards and sections */
.test-card,
.chart-container,
.topic-improvements,
.analytics-summary,
.summary-card {
  background: linear-gradient(180deg, #2a2a4a 0%, #222240 100%);
  border: 1px solid #3a3a5a;
  color: #e0e0e0;
  font-family: 'Noto Sans', sans-serif;
}

.test-card h3,
.chart-container h3,
.topic-improvements h3 {
  color: #41c0ff;
  border-bottom-color: #3a3a5a;
  font-family: 'Noto Sans', sans-serif;
  font-size: 20px;
  font-weight: 600;
}

/* Dark mode for tab content areas */
.tab-content {
  color: #e0e0e0;
  font-family: 'Noto Sans', sans-serif;
}

.tab-content h2 {
  color: #41c0ff;
  font-family: 'Noto Sans', sans-serif;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 20px;
}

.tab-content p {
  color: #b0b0c0;
  font-family: 'Noto Sans', sans-serif;
  font-size: 15px;
  line-height: 1.8;
}

/* Dark mode form inputs in dashboard */
.main-content-area .form-group input,
.main-content-area .form-group select,
.main-content-area .form-group textarea {
  background: #2a2a4a;
  border: 2px solid #3a3a5a;
  color: #e0e0e0;
  font-family: 'Noto Sans', sans-serif;
  font-size: 15px;
}

.main-content-area .form-group input:focus,
.main-content-area .form-group select:focus,
.main-content-area .form-group textarea:focus {
  border-color: #41c0ff;
  box-shadow: 0 0 0 3px rgba(65, 192, 255, 0.2);
}

.main-content-area .form-group label {
  color: #b0b0c0;
  font-family: 'Noto Sans', sans-serif;
  font-size: 15px;
}

/* Global Noto Sans font for dashboard buttons */
.main-content-area .btn {
  font-family: 'Noto Sans', sans-serif;
  font-size: 15px;
}

/* Tabs for remaining horizontal tabs (like Flashcard Games) */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  border-bottom: 2px solid #e0e0e0;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  color: #666;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  position: relative;
  transition: color 0.3s;
}

.tab.active {
  color: #667eea;
}

.tab.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 3px;
  background: #667eea;
}

.tab-content {
  display: none;
  overflow-x: hidden;
  max-width: 100%;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s;
}

#dailyActivity {
  overflow-x: hidden !important;
  max-width: 100% !important;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes day1Shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  75% { transform: translateX(2px); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes slideDown {
  from { opacity: 1; transform: translateX(-50%) translateY(0); }
  to { opacity: 0; transform: translateX(-50%) translateY(20px); }
}

@keyframes coinPopup {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5);
  }
  30% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
  }
  50% {
    transform: translate(-50%, -50%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -100%) scale(0.8);
  }
}

.test-card {
  background: #f7fafc;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px solid #e2e8f0;
  transition: all 0.3s;
}

.test-card:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.test-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.test-title {
  font-size: 20px;
  font-weight: bold;
  color: #2d3748;
}

.test-date {
  color: #718096;
  font-size: 14px;
}

/* Test Drill/Material Styles */
.test-drill {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.test-drill-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.test-drill-title {
  font-size: 18px;
  font-weight: 600;
  color: #4a5568;
}

.time-limit-badge {
  background: #edf2f7;
  color: #4a5568;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.topic-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 15px 0;
}

.topic-tag {
  background: #667eea;
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.topic-tag button {
  background: white;
  color: #667eea;
  border: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Folder Management Styles */
.folder-container {
  background: #edf2f7;
  border: 2px solid #cbd5e0;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
  cursor: pointer;
  transition: all 0.3s;
}

.folder-container:hover {
  background: #e2e8f0;
  border-color: #667eea;
}

.folder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.folder-name {
  font-size: 18px;
  font-weight: 600;
  color: #2d3748;
  display: flex;
  align-items: center;
  gap: 10px;
}

.folder-icon {
  font-size: 24px;
}

.folder-count {
  background: #667eea;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}

.folder-contents {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid #cbd5e0;
  display: none;
}

.folder-contents.open {
  display: block;
}

.folder-actions {
  display: flex;
  gap: 8px;
}

.folder-actions button {
  padding: 6px 12px;
  font-size: 13px;
}

/* Drag and Drop Styles */
.draggable-item {
  cursor: move;
  position: relative;
}

.draggable-item:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.draggable-item.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.drop-zone {
  border: 2px dashed #cbd5e0;
  border-radius: 8px;
  padding: 20px;
  margin: 10px 0;
  text-align: center;
  color: #718096;
  transition: all 0.3s;
}

.drop-zone.drag-over {
  background: #e6fffa;
  border-color: #38b2ac;
  color: #234e52;
}

.drag-handle {
  cursor: move;
  color: #cbd5e0;
  margin-right: 10px;
  font-size: 18px;
}

.drag-handle:hover {
  color: #667eea;
}

/* Student Folder Styles */
.student-folder {
  background: linear-gradient(180deg, #e8ecf3 0%, #d1d9e6 100%);
  border-radius: 4px 4px 8px 8px;
  padding: 0;
  margin-bottom: 15px;
  transition: all 0.3s ease;
  display: inline-block;
  width: 180px;
  vertical-align: top;
  margin-right: 15px;
  cursor: pointer;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.student-folder::before {
  content: '';
  position: absolute;
  top: -10px;
  left: 10px;
  width: 60px;
  height: 10px;
  background: linear-gradient(180deg, #d1d9e6 0%, #c4ccd9 100%);
  border-radius: 4px 4px 0 0;
}

.student-folder:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* Neon Green - Needs Grading */
.student-folder.needs-grading {
  background: linear-gradient(180deg, #9ae6b4 0%, #68d391 100%);
  box-shadow: 0 0 15px rgba(72, 187, 120, 0.5), 0 0 30px rgba(72, 187, 120, 0.3);
  animation: neon-pulse 2s ease-in-out infinite;
}

.student-folder.needs-grading::before {
  background: linear-gradient(180deg, #68d391 0%, #48bb78 100%);
}

@keyframes neon-pulse {
  0%, 100% { box-shadow: 0 0 15px rgba(72, 187, 120, 0.5), 0 0 30px rgba(72, 187, 120, 0.3); }
  50% { box-shadow: 0 0 25px rgba(72, 187, 120, 0.7), 0 0 50px rgba(72, 187, 120, 0.4); }
}

/* Blue - All Graded */
.student-folder.all-graded {
  background: linear-gradient(180deg, #bee3f8 0%, #90cdf4 100%);
}

.student-folder.all-graded::before {
  background: linear-gradient(180deg, #90cdf4 0%, #63b3ed 100%);
}

/* Test Folder Styles */
.test-folder {
  background: linear-gradient(180deg, #e9d8fd 0%, #d6bcfa 100%);
  border-radius: 4px 4px 8px 8px;
  padding: 0;
  margin-bottom: 15px;
  transition: all 0.3s ease;
  display: inline-block;
  width: 200px;
  vertical-align: top;
  margin-right: 15px;
  cursor: pointer;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.test-folder::before {
  content: '';
  position: absolute;
  top: -10px;
  left: 10px;
  width: 70px;
  height: 10px;
  background: linear-gradient(180deg, #d6bcfa 0%, #b794f4 100%);
  border-radius: 4px 4px 0 0;
}

.test-folder:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(159, 122, 234, 0.3);
}

.test-folder-header {
  padding: 15px 12px;
  text-align: center;
}

.test-folder-header .folder-icon {
  font-size: 32px;
  display: block;
  margin-bottom: 8px;
}

.test-folder-header .folder-name {
  font-size: 12px;
  font-weight: 600;
  color: #553c9a;
  word-break: break-word;
  line-height: 1.3;
}

.test-folder-header .folder-stats {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 8px;
}

.test-folder-header .folder-stats span {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.6);
  color: #553c9a;
}

.test-folder-header .folder-date {
  font-size: 10px;
  color: #805ad5;
  margin-top: 5px;
  opacity: 0.8;
}

/* Test Folder Content Modal */
.test-folder-content {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 16px;
  padding: 25px;
  max-width: 700px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  z-index: 10002;
  box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}

.test-folder-content.open {
  display: block;
}

/* Grammar Test Folder Styles (Green) */
.grammar-test-folder {
  background: linear-gradient(180deg, #c6f6d5 0%, #9ae6b4 100%);
  border-radius: 4px 4px 8px 8px;
  padding: 0;
  margin-bottom: 15px;
  transition: all 0.3s ease;
  display: inline-block;
  width: 200px;
  vertical-align: top;
  margin-right: 15px;
  cursor: pointer;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.grammar-test-folder::before {
  content: '';
  position: absolute;
  top: -10px;
  left: 10px;
  width: 70px;
  height: 10px;
  background: linear-gradient(180deg, #9ae6b4 0%, #68d391 100%);
  border-radius: 4px 4px 0 0;
}

.grammar-test-folder:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
}

.grammar-test-folder .test-folder-header {
  padding: 15px 12px;
  text-align: center;
}

.grammar-test-folder .folder-icon {
  font-size: 32px;
  display: block;
  margin-bottom: 8px;
}

.grammar-test-folder .folder-name {
  font-size: 12px;
  font-weight: 600;
  color: #276749;
  word-break: break-word;
  line-height: 1.3;
}

.grammar-test-folder .folder-stats span {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.6);
  color: #276749;
}

.grammar-test-folder .folder-date {
  font-size: 10px;
  color: #2f855a;
  margin-top: 5px;
  opacity: 0.8;
}

.student-folder-header {
  padding: 15px 12px;
  text-align: center;
}

.student-folder-header .folder-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.student-name {
  font-size: 11px;
  font-weight: 700;
  color: #2d3748;
  word-break: break-all;
  line-height: 1.3;
  margin-bottom: 8px;
}

.student-stats {
  display: flex;
  justify-content: center;
  gap: 8px;
  font-size: 10px;
}

.student-stats .stat-badge {
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: 600;
}

.student-stats .stat-pending {
  background: rgba(245, 158, 11, 0.2);
  color: #b45309;
}

.student-stats .stat-graded {
  background: rgba(16, 185, 129, 0.2);
  color: #047857;
}

.student-folder-content {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 12px;
  padding: 25px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 10001;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.student-folder-content.open {
  display: block;
}

.folder-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10000;
}

.folder-overlay.open {
  display: block;
}

.student-history {
  margin-top: 15px;
  padding-top: 15px;
  display: block;
}

.history-item {
  background: #f7fafc;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #667eea;
}

.history-date {
  color: #718096;
  font-size: 13px;
  margin-bottom: 5px;
}

.history-test {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 8px;
}

.history-score {
  display: inline-block;
  background: #48bb78;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}

/* Test-Based Feedback Organization */
.feedback-folder {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.feedback-folder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.feedback-test-name {
  font-size: 18px;
  font-weight: 600;
  color: #2d3748;
}

.feedback-items {
  margin-top: 15px;
  display: none;
}

.feedback-items.open {
  display: block;
}

.feedback-item {
  background: #f7fafc;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Recording Controls */
.recording-section {
  background: #f7fafc;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  border: 2px solid #e2e8f0;
}

.recording-timer {
  text-align: center;
  margin: 20px 0;
}

.timer-display {
  font-size: 48px;
  font-weight: bold;
  color: #2d3748;
  font-family: 'Courier New', monospace;
}

.timer-progress {
  width: 100%;
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  margin: 15px 0;
  overflow: hidden;
}

.timer-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px;
  transition: width 0.1s linear;
}

.recording-controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 20px 0;
}

.record-btn {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #ef4444;
  border: 4px solid #fff;
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.record-btn:hover {
  transform: scale(1.1);
}

.record-btn.recording {
  animation: pulse 2s infinite;
}

.record-btn.recording .record-icon {
  width: 30px;
  height: 30px;
  background: white;
  border-radius: 4px;
}

.record-btn .record-icon {
  width: 40px;
  height: 40px;
  background: white;
  border-radius: 50%;
}

@keyframes pulse {
  0% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
  50% { box-shadow: 0 4px 25px rgba(239, 68, 68, 0.8); }
  100% { box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
}

.stop-btn {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  background: #4b5563;
  border: none;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.stop-btn:hover {
  background: #374151;
  transform: scale(1.05);
}

/* Video Preview Container */
.video-preview-container {
  position: relative;
  max-width: 400px;
  margin: 15px auto;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.video-preview {
  width: 100%;
  min-height: 225px;
  border-radius: 12px;
  transform: scaleX(-1);
  background: #000;
  object-fit: cover;
}

.video-preview-label {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #ef4444;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 700;
  animation: pulse-rec 1s infinite;
  display: flex;
  align-items: center;
  gap: 6px;
}

.video-preview-label::before {
  content: '';
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
}

@keyframes pulse-rec {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Sticky Timer - Compact Left Side */
.sticky-timer {
  position: fixed;
  top: 80px;
  left: 15px;
  z-index: 100;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
  width: auto;
  min-width: 90px;
}

.sticky-timer .timer-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.sticky-timer .timer-display {
  font-size: 22px;
  font-weight: 700;
  color: white;
  font-family: 'Courier New', monospace;
  line-height: 1;
}

.sticky-timer .timer-label {
  color: rgba(255,255,255,0.85);
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sticky-timer .timer-progress {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
  margin-top: 4px;
  overflow: hidden;
}

.sticky-timer .timer-progress-bar {
  height: 100%;
  background: white;
  border-radius: 2px;
  transition: width 1s linear;
}

.sticky-timer.warning .timer-display {
  color: #fef08a;
  animation: pulse 1s infinite;
}

.sticky-timer.danger .timer-display {
  color: #fca5a5;
  animation: pulse 0.5s infinite;
}

.sticky-timer.danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* Attempt badge in sticky timer */
.sticky-timer .attempt-badge {
  background: rgba(255,255,255,0.2);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
}

/* Stop button in sticky timer */
.sticky-timer .stop-btn {
  padding: 5px 12px !important;
  font-size: 11px !important;
  margin-top: 4px;
}

/* Test Content Locked Overlay */
.test-content-locked {
  position: relative;
  user-select: none;
}

.test-content-locked .test-content-blur {
  filter: blur(8px);
  pointer-events: none;
  user-select: none;
}

.test-content-locked .lock-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(102, 126, 234, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  z-index: 10;
}

.lock-overlay .lock-icon {
  font-size: 64px;
  margin-bottom: 20px;
  animation: pulse-lock 2s infinite;
}

@keyframes pulse-lock {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.lock-overlay h3 {
  color: white;
  font-size: 20px;
  margin-bottom: 10px;
  text-align: center;
}

.lock-overlay p {
  color: rgba(255, 255, 255, 0.9);
  font-size: 14px;
  text-align: center;
  max-width: 300px;
  line-height: 1.5;
}

.lock-overlay .lock-warning {
  background: rgba(255, 255, 255, 0.2);
  padding: 10px 20px;
  border-radius: 8px;
  margin-top: 15px;
  font-size: 12px;
  color: #ffd700;
}

.test-content-revealed {
  animation: reveal-content 0.5s ease-out;
}

@keyframes reveal-content {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Recording started indicator */
.recording-started-badge {
  background: linear-gradient(135deg, #f56565, #c53030);
  color: white;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 10px;
  animation: recording-pulse 1.5s infinite;
}

@keyframes recording-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.5); }
  50% { box-shadow: 0 0 0 10px rgba(245, 101, 101, 0); }
}

/* Camera off placeholder */
.video-off-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  color: #a0aec0;
  border-radius: 12px;
}

.video-off-placeholder .camera-icon {
  font-size: 48px;
  margin-bottom: 10px;
}

.video-off-placeholder p {
  font-size: 14px;
}

/* High Quality Video Badge */
.hd-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(72, 187, 120, 0.9);
  color: white;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: bold;
}

/* Video quality selector */
.video-quality-selector {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 15px;
  padding: 10px 15px;
  background: #f7fafc;
  border-radius: 8px;
}

.video-quality-selector label {
  font-size: 12px;
  color: #4a5568;
  font-weight: 600;
}

.video-quality-selector select {
  padding: 6px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 12px;
  background: white;
}

/* Drill Status */
.drill-status {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}

.status-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.status-icon.completed {
  background: #48bb78;
  color: white;
}

.status-icon.pending {
  background: #edf2f7;
  color: #718096;
}

.status-icon.recording {
  background: #ef4444;
  color: white;
  animation: pulse 2s infinite;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s;
}

.modal.active {
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-title {
  font-size: 24px;
  color: #2d3748;
  font-weight: bold;
}

.close-btn {
  background: none;
  border: none;
  font-size: 28px;
  color: #718096;
  cursor: pointer;
  transition: color 0.3s;
}

.close-btn:hover {
  color: #2d3748;
}

.feedback-editor {
  background: #f7fafc;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
  border: 2px solid #e2e8f0;
}

.feedback-type-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.feedback-type {
  padding: 8px 16px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.feedback-type.active {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.grading-section {
  background: #f7fafc;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
}

.grade-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.grade-btn {
  width: 40px;
  height: 40px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.grade-btn:hover {
  background: #edf2f7;
}

.grade-btn.selected {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

/* Fixed: Add styling for ungraded topics */
.grade-selector.ungraded {
  border-left: 3px solid #ff6b6b;
  padding-left: 10px;
  background: linear-gradient(90deg, rgba(255,107,107,0.1) 0%, transparent 50px);
}

.ungraded-indicator {
  color: #ff6b6b;
  font-size: 12px;
  margin-left: 10px;
  font-weight: normal;
}

.audio-player {
  margin: 20px 0;
}

.audio-player audio {
  width: 100%;
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  margin: 10px 0;
}

.status-submitted {
  background: #fbbf24;
  color: #78350f;
}

.status-graded {
  background: #34d399;
  color: #064e3b;
}

.submission-details {
  background: #f9fafb;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
}

.feedback-display {
  background: #f7fafc;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px solid #e2e8f0;
}

.feedback-title {
  font-size: 18px;
  font-weight: bold;
  color: #2d3748;
  margin-bottom: 15px;
}

.video-container {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  margin: 15px 0;
}

.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 8px;
}

.loading {
  width: 40px;
  height: 40px;
  border: 4px solid #e0e0e0;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: #718096;
}

.empty-state h3 {
  font-size: 20px;
  margin-bottom: 10px;
}

/* Time input styles */
.time-input-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.time-input {
  width: 80px;
  padding: 8px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
}

.time-label {
  font-size: 14px;
  color: #718096;
}

/* Drill list styles */
.drills-list {
  margin-top: 20px;
}

.drill-item {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.drill-info {
  flex: 1;
}

.drill-name {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 5px;
}

.drill-time {
  font-size: 14px;
  color: #718096;
}

.remove-drill-btn {
  background: #ef4444;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.remove-drill-btn:hover {
  background: #dc2626;
}

/* Progress Tracker */
.progress-tracker {
  background: #f7fafc;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.progress-steps {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.progress-step {
  flex: 1;
  text-align: center;
  position: relative;
}

.progress-step:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 50%;
  width: 100%;
  height: 2px;
  background: #e2e8f0;
  z-index: 0;
}

.progress-step.completed:not(:last-child)::after {
  background: #48bb78;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
  border: 3px solid #e2e8f0;
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 1;
  font-weight: bold;
  color: #718096;
}

.progress-step.completed .step-circle {
  background: #48bb78;
  border-color: #48bb78;
  color: white;
}

.progress-step.active .step-circle {
  background: #667eea;
  border-color: #667eea;
  color: white;
  animation: pulse 2s infinite;
}

.step-label {
  font-size: 12px;
  color: #718096;
  font-weight: 600;
}

.hidden {
  display: none !important;
}

.demo-accounts {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 2px solid #e0e0e0;
}

.demo-accounts h4 {
  color: #667eea;
  text-align: center;
  margin-bottom: 15px;
}

.demo-accounts-box {
  background: #f7fafc;
  padding: 15px;
  border-radius: 8px;
}

.demo-account-item {
  margin-bottom: 10px;
}

.demo-account-item strong {
  display: block;
  margin-bottom: 5px;
}

.demo-account-item span {
  color: #4a5568;
}

/* Analytics Styles */
.analytics-container {
  padding: 20px;
}

.analytics-summary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  border-radius: 20px;
  margin-bottom: 30px;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.analytics-summary h2 {
  font-size: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.summary-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-card h3 {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.summary-value {
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 5px;
}

.summary-value.positive {
  color: #68d391;
}

.summary-value.negative {
  color: #fc8181;
}

.improvement-positive {
  color: #48bb78;
  font-weight: bold;
  font-size: 14px;
}

.improvement-negative {
  color: #f56565;
  font-weight: bold;
  font-size: 14px;
}

.summary-details {
  font-size: 14px;
  opacity: 0.8;
  margin-top: 10px;
  line-height: 1.6;
}

.analytics-charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-top: 30px;
}

.chart-container {
  background: white;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
  border: 2px solid #e2e8f0;
}

.chart-container h3 {
  font-size: 18px;
  color: #2d3748;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e2e8f0;
}

.chart-wrapper {
  position: relative;
  height: 300px;
}

.topic-improvements {
  background: white;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
  margin-top: 30px;
}

.topic-improvements h3 {
  font-size: 20px;
  color: #2d3748;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e2e8f0;
}

.topic-item {
  padding: 15px;
  margin-bottom: 15px;
  background: #f7fafc;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}

.topic-item.urgent {
  border-left-color: #f56565;
  background: #fff5f5;
}

.topic-name {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 10px;
  font-size: 16px;
}

.topic-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.topic-stat {
  display: flex;
  flex-direction: column;
}

.stat-label {
  font-size: 12px;
  color: #718096;
  margin-bottom: 5px;
  text-transform: uppercase;
}

.stat-value {
  font-size: 20px;
  font-weight: bold;
  color: #2d3748;
}

.stat-value.high {
  color: #48bb78;
}

.stat-value.low {
  color: #f56565;
}

.no-data-message {
  text-align: center;
  padding: 60px 20px;
  background: #f7fafc;
  border-radius: 16px;
  color: #718096;
}

.no-data-message h3 {
  font-size: 20px;
  margin-bottom: 10px;
  color: #4a5568;
}

/* Flashcard Game Styles */
.flashcard-word-active {
  animation: pulse-highlight 1.5s infinite;
}

@keyframes pulse-highlight {
  0% { background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); }
  50% { background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); }
  100% { background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); }
}

.word-item {
  transition: all 0.3s ease;
}

.word-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.listening-pulse {
  animation: pulse 2s infinite;
}

.game-container {
  max-width: 800px;
  margin: 0 auto;
}

.flashcard {
  position: relative;
  overflow: hidden;
}

.flashcard::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Enhanced Flashcard Gamification Styles */

/* ============= LEITNER BOX STYLES ============= */
:root {
  --box-day1: #f56565;
  --box-day2: #ed8936;
  --box-day3: #ecc94b;
  --box-day4: #48bb78;
  --box-day5: #38b2ac;
  --box-weekly: #4299e1;
  --box-monthly: #667eea;
  --box-mastery: #9f7aea;
}

.leitner-box-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}

.leitner-box-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  border-top: 4px solid;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.leitner-box-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.12);
}

.leitner-box-card.day1 { border-top-color: var(--box-day1); }
.leitner-box-card.day2 { border-top-color: var(--box-day2); }
.leitner-box-card.day3 { border-top-color: var(--box-day3); }
.leitner-box-card.day4 { border-top-color: var(--box-day4); }
.leitner-box-card.day5 { border-top-color: var(--box-day5); }
.leitner-box-card.weekly { border-top-color: var(--box-weekly); }
.leitner-box-card.monthly { border-top-color: var(--box-monthly); }
.leitner-box-card.mastery { border-top-color: var(--box-mastery); }

.leitner-box-card .box-label {
  font-size: 14px;
  color: #718096;
  margin-bottom: 5px;
}

.leitner-box-card .box-count {
  font-size: 32px;
  font-weight: bold;
  color: #2d3748;
}

.leitner-box-card .box-due {
  font-size: 12px;
  color: var(--box-day1);
  margin-top: 5px;
  font-weight: 600;
}

.leitner-due-indicator {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  background: var(--box-day1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  animation: leitnerPulse 2s infinite;
}

.leitner-due-indicator.shake {
  animation: leitnerShake 0.5s infinite;
}

/* Brain Icon Button */
.brain-icon-btn {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid currentColor;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  z-index: 5;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.brain-icon-btn:hover {
  transform: scale(1.15);
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* Brain Popup */
.brain-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.2s ease;
  padding: 20px;
  box-sizing: border-box;
}

.brain-popup {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 450px;
  width: 100%;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.3s ease;
  position: relative;
}

@media (max-width: 768px) {
  .brain-popup {
    max-height: calc(100vh - 160px);
    margin-bottom: 80px;
  }
  
  #dailyDrillStatsBar {
    display: none !important;
  }
  
  #dailyCorrectionsOverlay {
    overflow-x: hidden !important;
  }
  
  #dailyCorrectionsOverlay > div {
    max-width: 100vw !important;
    overflow-x: hidden !important;
  }
  
  #teacherFeedbackGrid {
    grid-template-columns: 1fr !important;
  }
}

@media (min-width: 769px) {
  #teacherFeedbackGrid {
    grid-template-columns: 1fr 1fr !important;
  }
}

.brain-popup-close {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 30px;
  height: 30px;
  border: none;
  background: #e2e8f0;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.brain-popup-close:hover {
  background: #cbd5e0;
}

.brain-popup-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
}

.brain-popup-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
}

.brain-popup-title {
  font-size: 20px;
  font-weight: bold;
  color: #2d3748;
}

.brain-popup-subtitle {
  font-size: 14px;
  color: #718096;
}

.brain-popup-dominant {
  background: #f7fafc;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.brain-popup-dominant-label {
  font-size: 11px;
  text-transform: uppercase;
  color: #a0aec0;
  margin-bottom: 5px;
  letter-spacing: 0.5px;
}

.brain-popup-dominant-text {
  font-size: 16px;
  font-weight: 600;
  color: #2d3748;
}

.brain-popup-short {
  font-size: 18px;
  color: #4a5568;
  font-style: italic;
  margin-bottom: 15px;
  padding: 15px;
  background: linear-gradient(135deg, #faf5ff 0%, #f0fff4 100%);
  border-radius: 12px;
  border-left: 4px solid;
}

.brain-popup-full {
  font-size: 14px;
  color: #718096;
  line-height: 1.7;
}

.brain-diagram {
  width: 100%;
  height: 120px;
  margin: 15px 0;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brain-diagram svg {
  width: 150px;
  height: 100px;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes leitnerPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

@keyframes leitnerShake {
  0%, 100% { transform: translateX(0) rotate(0); }
  25% { transform: translateX(-3px) rotate(-5deg); }
  75% { transform: translateX(3px) rotate(5deg); }
}

/* Leitner Flashcard */
.leitner-flashcard {
  perspective: 1000px;
  width: 100%;
  max-width: 450px;
  min-height: 280px;
  margin: 0 auto 30px;
  cursor: pointer;
}

.leitner-flashcard-inner {
  position: relative;
  width: 100%;
  min-height: 280px;
  transform-style: preserve-3d;
  transition: transform 0.6s;
}

.leitner-flashcard.flipped .leitner-flashcard-inner {
  transform: rotateY(180deg);
}

.leitner-flashcard-face {
  position: absolute;
  width: 100%;
  min-height: 280px;
  backface-visibility: hidden;
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 30px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  box-sizing: border-box;
  overflow: hidden;
}

.leitner-flashcard-front {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.leitner-flashcard-back {
  background: white;
  border: 3px solid #e2e8f0;
  transform: rotateY(180deg);
}

.leitner-answer-btns {
  display: flex;
  gap: 20px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Grammar Drill Interface Styles */
.grammar-drill-container {
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.grammar-drill-passive-view {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 25px 0;
}

.grammar-drill-column {
  background: #f8fafc;
  border-radius: 16px;
  padding: 20px;
  border: 2px solid #e2e8f0;
}

.grammar-drill-column.questions {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-color: #fcd34d;
}

.grammar-drill-column.answers {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  border-color: #6ee7b7;
}

.grammar-drill-column h4 {
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(0,0,0,0.1);
  font-size: 18px;
}

.grammar-drill-sentence {
  padding: 12px 15px;
  margin-bottom: 10px;
  background: rgba(255,255,255,0.7);
  border-radius: 10px;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.grammar-drill-sentence .number {
  background: #667eea;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  flex-shrink: 0;
}

.grammar-drill-timer {
  font-size: 72px;
  font-weight: bold;
  text-align: center;
  color: #667eea;
  font-family: 'Courier New', monospace;
  margin: 20px 0;
}

.grammar-drill-timer.warning { color: #f59e0b; }
.grammar-drill-timer.critical { color: #ef4444; }

.grammar-drill-mic-status {
  text-align: center;
  padding: 20px;
  background: #f0f9ff;
  border-radius: 12px;
  margin: 20px 0;
  border: 2px solid #0ea5e9;
}

.grammar-drill-mic-status.listening {
  background: #fef3c7;
  border-color: #f59e0b;
}

.grammar-drill-recognized {
  font-size: 24px;
  font-weight: 600;
  color: #1e40af;
  margin-top: 10px;
}

.btn-drill-complete:disabled {
  background: #cbd5e1 !important;
  cursor: not-allowed;
}

@media (max-width: 768px) {
  .grammar-drill-passive-view { grid-template-columns: 1fr; }
  .grammar-drill-timer { font-size: 56px; }
  .grammar-drill-container { padding: 20px; }
}

.leitner-answer-btns button {
  padding: 15px 40px;
  font-size: 18px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.leitner-answer-btns button:hover {
  transform: translateY(-2px);
}

.leitner-answer-btns button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.leitner-answer-btns .correct-btn {
  background: #48bb78;
  color: white;
}

.leitner-answer-btns .correct-btn:hover {
  background: #38a169;
}

.leitner-answer-btns .incorrect-btn {
  background: #f56565;
  color: white;
}

.leitner-answer-btns .incorrect-btn:hover {
  background: #e53e3e;
}

/* Leitner Dashboard Cards */
.leitner-dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.leitner-stat-card {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.leitner-stat-card h4 {
  font-size: 14px;
  color: #718096;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.leitner-stat-card .stat-value {
  font-size: 36px;
  font-weight: bold;
  color: #2d3748;
}

.leitner-stat-card .stat-label {
  font-size: 14px;
  color: #a0aec0;
  margin-top: 5px;
}

/* Leitner Leech Cards */
.leitner-leech-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  background: #fff5f5;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid var(--box-day1);
}

.leitner-leech-item .word {
  font-weight: 600;
  color: #2d3748;
}

.leitner-leech-item .lapses {
  color: var(--box-day1);
  font-weight: 600;
}

/* Leitner Consistency Calendar */
.leitner-consistency-week {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-top: 15px;
}

.leitner-consistency-day {
  aspect-ratio: 1;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
}

.leitner-consistency-day.studied {
  background: #48bb78;
  color: white;
}

.leitner-consistency-day.missed {
  background: #fed7d7;
  color: #c53030;
}

.leitner-consistency-day.future {
  background: #f7fafc;
  color: #a0aec0;
}

.leitner-consistency-day.today {
  box-shadow: 0 0 0 3px #667eea;
}

/* Leitner Forecast Bars */
.leitner-forecast-bars {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  height: 100px;
  margin-top: 20px;
  padding-bottom: 30px;
}

.leitner-forecast-bar {
  flex: 1;
  background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px 4px 0 0;
  min-height: 10px;
  position: relative;
  transition: height 0.3s;
}

.leitner-forecast-bar .bar-label {
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: #718096;
  white-space: nowrap;
}

.leitner-forecast-bar .bar-value {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  font-weight: 600;
  color: #2d3748;
}

/* Leitner Tab Badge */
.leitner-tab-badge {
  background: #f56565;
  color: white;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 8px;
}

/* Leitner Empty State */
.leitner-empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #718096;
}

.leitner-empty-state .icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.leitner-empty-state h3 {
  font-size: 20px;
  color: #4a5568;
  margin-bottom: 10px;
}

/* Leitner Session Complete */
.leitner-session-complete {
  text-align: center;
  padding: 40px;
}

.leitner-session-complete .trophy {
  font-size: 80px;
  margin-bottom: 20px;
}

.leitner-session-complete .stats {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin: 30px 0;
  flex-wrap: wrap;
}

.leitner-session-complete .stat-item {
  text-align: center;
}

.leitner-session-complete .stat-item .value {
  font-size: 36px;
  font-weight: bold;
}

.leitner-session-complete .stat-item .label {
  font-size: 14px;
  color: #718096;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .leitner-box-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .leitner-box-card .box-count {
    font-size: 24px;
  }

  .leitner-answer-btns {
    flex-direction: column;
  }

  .leitner-answer-btns button {
    width: 100%;
  }

  .leitner-flashcard-inner {
    height: 240px;
  }
}

/* ============= LEADERBOARD STYLES ============= */
.leaderboard-container {
  max-width: 1200px;
  margin: 0 auto;
}

.leaderboard-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.leaderboard-tab {
  padding: 12px 24px;
  border: none;
  background: #f7fafc;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: #4a5568;
  transition: all 0.3s;
}

.leaderboard-tab:hover {
  background: #edf2f7;
}

.leaderboard-tab.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.leaderboard-section {
  display: none;
}

.leaderboard-section.active {
  display: block;
}

.leaderboard-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  overflow: hidden;
  margin-bottom: 25px;
}

.leaderboard-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 25px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.leaderboard-header .icon {
  font-size: 32px;
}

.leaderboard-header h3 {
  margin: 0;
  font-size: 18px;
}

.leaderboard-header p {
  margin: 5px 0 0 0;
  font-size: 13px;
  opacity: 0.9;
}

.leaderboard-list {
  padding: 0;
  margin: 0;
  list-style: none;
}

.leaderboard-item {
  display: flex;
  align-items: center;
  padding: 15px 25px;
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.2s;
}

.leaderboard-item:hover {
  background: #f7fafc;
}

.leaderboard-item:last-child {
  border-bottom: none;
}

.leaderboard-rank {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
  margin-right: 15px;
}

.leaderboard-rank.gold {
  background: linear-gradient(135deg, #f6e05e 0%, #d69e2e 100%);
  color: #744210;
}

.leaderboard-rank.silver {
  background: linear-gradient(135deg, #e2e8f0 0%, #a0aec0 100%);
  color: #2d3748;
}

.leaderboard-rank.bronze {
  background: linear-gradient(135deg, #ed8936 0%, #c05621 100%);
  color: white;
}

.leaderboard-rank.normal {
  background: #f7fafc;
  color: #718096;
}

.leaderboard-info {
  flex: 1;
}

.leaderboard-name {
  font-weight: 600;
  color: #2d3748;
  font-size: 15px;
}

.leaderboard-detail {
  font-size: 13px;
  color: #718096;
  margin-top: 3px;
}

.leaderboard-score {
  text-align: right;
}

.leaderboard-score .value {
  font-size: 20px;
  font-weight: bold;
  color: #667eea;
}

.leaderboard-score .label {
  font-size: 12px;
  color: #a0aec0;
}

.leaderboard-empty {
  text-align: center;
  padding: 40px;
  color: #718096;
}

.leaderboard-empty .icon {
  font-size: 48px;
  margin-bottom: 15px;
}

/* Leaderboard category colors */
.leaderboard-header.flashcard {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

.leaderboard-header.pronunciation {
  background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
}

.leaderboard-header.test {
  background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
}

.leaderboard-header.overall {
  background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
}

/* Responsive */
@media (max-width: 768px) {
  .leaderboard-tabs {
    flex-direction: column;
  }

  .leaderboard-tab {
    text-align: center;
  }

  .leaderboard-item {
    flex-wrap: wrap;
  }

  .leaderboard-score {
    width: 100%;
    text-align: left;
    margin-top: 10px;
    padding-left: 55px;
  }
}

/* ============= PROFILE & AVATAR STYLES ============= */
.profile-container {
  max-width: 900px;
  margin: 0 auto;
}

.profile-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 40px;
  color: white;
  text-align: center;
  margin-bottom: 30px;
  position: relative;
}

.profile-avatar-wrapper {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
}

.profile-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid white;
  object-fit: cover;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  color: #667eea;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.profile-avatar-edit {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 36px;
  height: 36px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}

.profile-avatar-edit:hover {
  transform: scale(1.1);
}

.profile-name {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 5px;
}

.profile-email {
  opacity: 0.9;
  font-size: 14px;
}

.profile-level-badge {
  display: inline-block;
  background: rgba(255,255,255,0.2);
  padding: 8px 20px;
  border-radius: 20px;
  margin-top: 15px;
  font-weight: 600;
}

.profile-stats-row {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-top: 25px;
  flex-wrap: wrap;
}

.profile-stat {
  text-align: center;
}

.profile-stat-value {
  font-size: 28px;
  font-weight: bold;
}

.profile-stat-label {
  font-size: 12px;
  opacity: 0.9;
}

/* Avatar Selection Modal */
.avatar-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.avatar-modal.active {
  display: flex;
}

.avatar-modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.avatar-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.avatar-modal-header h3 {
  margin: 0;
  font-size: 20px;
}

.avatar-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #718096;
}

.avatar-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.avatar-option {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  font-size: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f7fafc;
  transition: all 0.2s;
}

.avatar-option:hover {
  transform: scale(1.1);
  border-color: #667eea;
}

.avatar-option.selected {
  border-color: #667eea;
  background: #ebf4ff;
}

.avatar-upload-section {
  border-top: 1px solid #e2e8f0;
  padding-top: 20px;
  text-align: center;
}

.avatar-upload-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

/* ============= ACHIEVEMENT BADGES STYLES ============= */
.badges-section {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}

.badges-section h3 {
  margin: 0 0 20px 0;
  font-size: 18px;
  color: #2d3748;
  display: flex;
  align-items: center;
  gap: 10px;
}

.badges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
}

.badge-card {
  background: #f7fafc;
  border-radius: 12px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s;
  border: 2px solid transparent;
}

.badge-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.badge-card.locked {
  opacity: 0.5;
  filter: grayscale(0.8);
}

.badge-card.bronze { border-color: #cd7f32; background: linear-gradient(135deg, #fef3e2 0%, #fde6cc 100%); }
.badge-card.silver { border-color: #c0c0c0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
.badge-card.gold { border-color: #ffd700; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
.badge-card.platinum { border-color: #e5e4e2; background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); }
.badge-card.diamond { border-color: #b9f2ff; background: linear-gradient(135deg, #e0f7ff 0%, #b3ecff 100%); }
.badge-card.legendary { border-color: #ff6b6b; background: linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%); }
.badge-card.mythic { border-color: #9f7aea; background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%); }
.badge-card.transcendent { border-color: #f6e05e; background: linear-gradient(135deg, #fffff0 0%, #fefcbf 100%); box-shadow: 0 0 20px rgba(246, 224, 94, 0.4); }

.badge-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}

.badge-card.bronze .badge-icon { background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%); }
.badge-card.silver .badge-icon { background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%); }
.badge-card.gold .badge-icon { background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%); }
.badge-card.platinum .badge-icon { background: linear-gradient(135deg, #e5e4e2 0%, #bfc0c0 100%); }
.badge-card.diamond .badge-icon { background: linear-gradient(135deg, #b9f2ff 0%, #7dd3fc 100%); }
.badge-card.legendary .badge-icon { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); }
.badge-card.mythic .badge-icon { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); }
.badge-card.transcendent .badge-icon { background: linear-gradient(135deg, #f6e05e 0%, #ecc94b 100%); animation: transcendentGlow 2s infinite; }

@keyframes transcendentGlow {
  0%, 100% { box-shadow: 0 0 10px rgba(246, 224, 94, 0.5); }
  50% { box-shadow: 0 0 25px rgba(246, 224, 94, 0.8); }
}

.badge-info {
  flex: 1;
  min-width: 0;
}

.badge-name {
  font-weight: 700;
  font-size: 14px;
  color: #2d3748;
  margin-bottom: 2px;
}

.badge-tier {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.badge-card.bronze .badge-tier { color: #92400e; }
.badge-card.silver .badge-tier { color: #6b7280; }
.badge-card.gold .badge-tier { color: #b45309; }
.badge-card.platinum .badge-tier { color: #4b5563; }
.badge-card.diamond .badge-tier { color: #0369a1; }
.badge-card.legendary .badge-tier { color: #dc2626; }
.badge-card.mythic .badge-tier { color: #7c3aed; }
.badge-card.transcendent .badge-tier { color: #ca8a04; }

.badge-desc {
  font-size: 12px;
  color: #718096;
}

.badge-progress {
  margin-top: 8px;
}

.badge-progress-bar {
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  overflow: hidden;
}

.badge-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
  transition: width 0.3s;
}

.badge-progress-text {
  font-size: 11px;
  color: #a0aec0;
  margin-top: 4px;
}

/* Leaderboard Avatar */
.leaderboard-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  background: #e2e8f0;
  flex-shrink: 0;
  overflow: hidden;
}

.leaderboard-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Responsive */
@media (max-width: 768px) {
  .profile-header {
    padding: 25px;
  }

  .profile-stats-row {
    gap: 20px;
  }

  .avatar-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .badges-grid {
    grid-template-columns: 1fr;
  }
}

.popup-image {
  position: fixed;
  z-index: 100000;
  animation: popIn 0.5s ease-in-out;
  pointer-events: none;
  border-radius: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

@keyframes popIn {
  0% {
    transform: translateX(-50%) scale(0.3) rotate(-10deg);
    opacity: 0;
  }
  50% {
    transform: translateX(-50%) scale(1.1) rotate(5deg);
    opacity: 1;
  }
  100% {
    transform: translateX(-50%) scale(1) rotate(0deg);
    opacity: 1;
  }
}
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
    opacity: 1;
  }
}

.end-game-gif {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  max-width: 400px;
  max-height: 400px;
  border-radius: 20px;
  animation: slideIn 0.8s ease-out;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

@keyframes slideIn {
  from {
    transform: translate(-50%, -100%) scale(0.8);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}

.upload-section {
  background: #f7fafc;
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  border: 2px solid #e2e8f0;
}

.upload-group {
  margin: 15px 0;
  padding: 15px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.upload-group h5 {
  color: #4a5568;
  margin-bottom: 10px;
  font-size: 14px;
  font-weight: 600;
}

.file-upload-container {
  display: flex;
  gap: 10px;
  align-items: center;
  margin: 8px 0;
}

.file-input-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
}

.file-input-wrapper input[type=file] {
  position: absolute;
  left: -9999px;
}

.file-input-label {
  display: inline-block;
  padding: 8px 16px;
  background: #667eea;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.file-input-label:hover {
  background: #5a67d8;
}

.file-name {
  font-size: 13px;
  color: #718096;
  margin-left: 10px;
}

.uploaded-preview {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  padding: 10px;
  background: #edf2f7;
  border-radius: 6px;
}

.preview-thumbnail {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
}

.score-range-label {
  display: inline-block;
  padding: 4px 8px;
  background: #667eea;
  color: white;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 8px;
}

.streak-indicator {
  position: fixed;
  top: 100px;
  right: 20px;
  background: white;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  z-index: 1000;
  min-width: 150px;
  text-align: center;
}

.streak-number {
  font-size: 36px;
  font-weight: bold;
  color: #48bb78;
}

.streak-label {
  font-size: 14px;
  color: #718096;
  margin-top: 5px;
}

.word-item.correct-animation {
  animation: correctPulse 0.5s ease;
  background: linear-gradient(135deg, #48bb7810 0%, #38a16910 100%) !important;
}

@keyframes correctPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.word-item.incorrect-animation {
  animation: incorrectShake 0.5s ease;
  background: linear-gradient(135deg, #f5656510 0%, #e53e3e10 100%) !important;
}

@keyframes incorrectShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

@keyframes slideDown {
  from {
    transform: translateX(-50%) translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

.filter-btn {
  transition: all 0.3s ease;
}

.filter-btn:not(.active) {
  opacity: 0.7;
}

.filter-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* =============  (JUNBI) PREPARATION PAGE STYLES ============= */
.junbi-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  /* Default background - will be replaced by admin config */
  background-color: #d4c4a8;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow: hidden;
}

.junbi-container {
  width: 95%;
  max-width: 600px;
  height: 100%;
  max-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  padding: 10px;
  box-sizing: border-box;
  overflow: hidden;
}

@media (max-width: 768px) {
  .junbi-container {
    width: 100%;
    padding: 8px;
    max-width: 100%;
  }
}

.junbi-title {
  font-size: 36px;
  color: white;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.7), 0 0 20px rgba(0,0,0,0.5);
  margin-bottom: 5px;
  font-weight: bold;
  flex-shrink: 0;
}

.junbi-subtitle {
  color: white;
  font-size: 14px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
  margin-bottom: 8px;
  flex-shrink: 0;
}

/* Character overlay in dojang */
.junbi-character {
  position: absolute;
  z-index: 1;
  pointer-events: none;
  object-fit: contain;
}

/* Mobile: hide or reposition character to not overlap content */
@media (max-width: 768px) {
  .junbi-character {
    display: none !important;
  }
}

/* Wrinkled Paper Effect - Dynamic Size */
.wrinkled-paper {
  background:
    linear-gradient(135deg, transparent 25%, rgba(0,0,0,0.02) 25%, rgba(0,0,0,0.02) 50%, transparent 50%, transparent 75%, rgba(0,0,0,0.02) 75%),
    linear-gradient(45deg, transparent 25%, rgba(0,0,0,0.02) 25%, rgba(0,0,0,0.02) 50%, transparent 50%, transparent 75%, rgba(0,0,0,0.02) 75%);
  background-size: 20px 20px;
  background-color: #f5f0e6;
  border-radius: 8px;
  padding: 15px;
  box-shadow:
    4px 4px 15px rgba(0,0,0,0.3),
    inset 0 0 40px rgba(0,0,0,0.05),
    inset -5px -5px 15px rgba(0,0,0,0.03);
  position: relative;
  overflow: hidden;
  flex: 1 1 auto;
  width: 100%;
  min-height: 0;
  max-height: none;
  overflow-y: auto;
  transition: all 0.5s ease;
  z-index: 2;
  box-sizing: border-box;
}

@media (max-width: 768px) {
  .wrinkled-paper {
    padding: 12px;
    border-radius: 6px;
  }
}

.wrinkled-paper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    radial-gradient(ellipse at 20% 30%, rgba(0,0,0,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(0,0,0,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.wrinkled-paper.folded {
  transform: perspective(800px) rotateX(5deg);
}

.paper-header {
  text-align: center;
  border-bottom: 2px solid #8B4513;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.paper-header h3 {
  color: #2d3748;
  font-size: 22px;
  margin: 0 0 5px 0;
}

.paper-header .deck-name {
  color: #718096;
  font-size: 14px;
}

.word-list-table {
  width: 100%;
  border-collapse: collapse;
}

.word-list-table th {
  text-align: left;
  padding: 8px 12px;
  border-bottom: 1px solid #d4c4a8;
  color: #4a5568;
  font-size: 14px;
}

.word-list-table td {
  padding: 10px 12px;
  border-bottom: 1px dashed #e2d8c8;
  font-size: 16px;
}

.word-list-table .english-col {
  color: #2d3748;
  font-weight: 500;
}

.word-list-table .korean-col {
  color: #667eea;
  font-weight: 600;
  font-size: 18px;
  transition: opacity 0.3s ease, filter 0.3s ease;
}

.word-list-table .korean-col.hidden-text {
  opacity: 0;
  filter: blur(8px);
}

.junbi-controls {
  display: flex;
  gap: 15px;
  margin-top: 10px;
  flex-shrink: 0;
}

.junbi-btn {
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.junbi-btn.fold-btn {
  background: #4a5568;
  color: white;
}

.junbi-btn.fold-btn:hover {
  background: #2d3748;
  transform: translateY(-2px);
}

.junbi-btn.continue-btn {
  background: linear-gradient(135deg, #c41e3a 0%, #8B0000 100%);
  color: white;
}

.junbi-btn.continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(196, 30, 58, 0.4);
}

/* ============= MASTERY DECK STYLES ============= */
.mastery-deck-card {
  background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.mastery-deck-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.mastery-deck-title {
  font-size: 20px;
  font-weight: bold;
  color: #2d3748;
  display: flex;
  align-items: center;
  gap: 10px;
}

.mastery-count-badge {
  background: white;
  color: #f59e0b;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 16px;
}

.mastery-word-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
}

.mastery-word-tag {
  background: rgba(255,255,255,0.8);
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 13px;
  color: #4a5568;
}

.mastery-practice-btn {
  width: 100%;
  padding: 12px;
  background: white;
  color: #f59e0b;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mastery-practice-btn:hover {
  background: #2d3748;
  color: white;
  transform: translateY(-2px);
}

.mastery-empty-state {
  text-align: center;
  padding: 40px 20px;
  background: #fffbeb;
  border-radius: 15px;
  border: 2px dashed #fcd34d;
}

.mastery-empty-state .icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.mastery-empty-state h4 {
  color: #92400e;
  margin-bottom: 10px;
}

.mastery-empty-state p {
  color: #a16207;
  font-size: 14px;
}

/* Mastery Deck POS Folder Styles */
.mastery-pos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}

.mastery-pos-folder {
  background: white;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid #e2e8f0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.mastery-pos-folder:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  border-color: #fcd34d;
}

.mastery-pos-folder .pos-icon {
  font-size: 36px;
  margin-bottom: 10px;
}

.mastery-pos-folder .pos-name {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 5px;
  font-size: 14px;
}

.mastery-pos-folder .pos-count {
  color: #718096;
  font-size: 13px;
}

.mastery-pos-folder .pos-count strong {
  color: #f59e0b;
  font-size: 18px;
}

/* POS Folder Color Variations */
.mastery-pos-folder.nouns { border-left: 4px solid #3b82f6; }
.mastery-pos-folder.nouns:hover { border-color: #3b82f6; background: #eff6ff; }

.mastery-pos-folder.action-verbs { border-left: 4px solid #ef4444; }
.mastery-pos-folder.action-verbs:hover { border-color: #ef4444; background: #fef2f2; }

.mastery-pos-folder.descriptive-verbs { border-left: 4px solid #8b5cf6; }
.mastery-pos-folder.descriptive-verbs:hover { border-color: #8b5cf6; background: #f5f3ff; }

.mastery-pos-folder.adjectives { border-left: 4px solid #10b981; }
.mastery-pos-folder.adjectives:hover { border-color: #10b981; background: #ecfdf5; }

.mastery-pos-folder.adverbs { border-left: 4px solid #f59e0b; }
.mastery-pos-folder.adverbs:hover { border-color: #f59e0b; background: #fffbeb; }

.mastery-pos-folder.conjunctions { border-left: 4px solid #6366f1; }
.mastery-pos-folder.conjunctions:hover { border-color: #6366f1; background: #eef2ff; }

.mastery-pos-folder.expressions { border-left: 4px solid #ec4899; }
.mastery-pos-folder.expressions:hover { border-color: #ec4899; background: #fdf2f8; }

.mastery-pos-folder.grammar-points { border-left: 4px solid #14b8a6; }
.mastery-pos-folder.grammar-points:hover { border-color: #14b8a6; background: #f0fdfa; }

.mastery-pos-folder.other { border-left: 4px solid #6b7280; }
.mastery-pos-folder.other:hover { border-color: #6b7280; background: #f9fafb; }

.mastery-pos-folder.empty-folder:hover { background: white; }

/* Mastery POS Detail View */
.mastery-pos-detail {
  background: white;
  border-radius: 16px;
  padding: 25px;
  margin-top: 20px;
}

.mastery-pos-detail-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.mastery-pos-detail-header .back-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #e2e8f0;
  background: white;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.mastery-pos-detail-header .back-btn:hover {
  background: #fcd34d;
  border-color: #fcd34d;
}

.mastery-pos-words-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
}

.mastery-pos-word-card {
  background: #fffbeb;
  border: 1px solid #fcd34d;
  border-radius: 10px;
  padding: 12px 15px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mastery-pos-word-card .word-korean {
  font-size: 16px;
  font-weight: 600;
  color: #2d3748;
}

.mastery-pos-word-card .word-english {
  font-size: 13px;
  color: #718096;
}

/* ========== SPACE GAME STYLES ========== */

/* Game Creation Form */
.game-form-section {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 20px;
  border: 2px solid #0f3460;
  color: white;
}

.game-form-section h3 {
  color: #00d9ff;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.game-form-section label {
  color: #a0aec0;
  font-size: 13px;
}

.game-form-section input,
.game-form-section textarea,
.game-form-section select {
  background: #0f3460;
  border: 2px solid #1a1a2e;
  color: white;
  border-radius: 8px;
  padding: 12px;
  width: 100%;
  margin-top: 5px;
}

.game-form-section input:focus,
.game-form-section textarea:focus {
  border-color: #00d9ff;
  outline: none;
  box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
}

.game-form-section input::placeholder,
.game-form-section textarea::placeholder {
  color: #4a5568;
}

/* Question Card */
.question-card {
  background: linear-gradient(135deg, #1e3a5f 0%, #0f3460 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  border: 2px solid #00d9ff;
  position: relative;
}

.question-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(0, 217, 255, 0.3);
}

.question-number {
  background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
  color: #1a1a2e;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
}

/* Answer Option in Creation */
.answer-option-create {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid transparent;
}

.answer-option-create:hover {
  background: rgba(0, 217, 255, 0.1);
  border-color: rgba(0, 217, 255, 0.3);
}

.answer-option-create.correct {
  background: rgba(72, 187, 120, 0.2);
  border-color: #48bb78;
}

.answer-option-create .answer-marker {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  background: #0f3460;
  color: #00d9ff;
  flex-shrink: 0;
}

.answer-option-create.correct .answer-marker {
  background: #48bb78;
  color: white;
}

/* Game Assets Section */
.game-assets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.asset-upload-card {
  background: rgba(15, 52, 96, 0.5);
  border-radius: 12px;
  padding: 15px;
  border: 2px dashed #0f3460;
}

.asset-upload-card h4 {
  color: #00d9ff;
  font-size: 14px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.asset-upload-card input {
  font-size: 13px;
}

/* Score Tier Section */
.score-tier-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.score-tier-card {
  background: linear-gradient(135deg, #1e3a5f 0%, #0f3460 100%);
  border-radius: 12px;
  padding: 15px;
  border: 2px solid;
}

.score-tier-card.tier-1 { border-color: #e53e3e; }
.score-tier-card.tier-2 { border-color: #ed8936; }
.score-tier-card.tier-3 { border-color: #ecc94b; }
.score-tier-card.tier-4 { border-color: #48bb78; }
.score-tier-card.tier-5 { border-color: #00d9ff; }

.score-tier-card h5 {
  font-size: 13px;
  margin-bottom: 10px;
}

.score-tier-card.tier-1 h5 { color: #e53e3e; }
.score-tier-card.tier-2 h5 { color: #ed8936; }
.score-tier-card.tier-3 h5 { color: #ecc94b; }
.score-tier-card.tier-4 h5 { color: #48bb78; }
.score-tier-card.tier-5 h5 { color: #00d9ff; }

/* Game Card in List */
.game-list-card {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 15px;
  border: 2px solid #0f3460;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
}

.game-list-card:hover {
  border-color: #00d9ff;
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0, 217, 255, 0.2);
}

.game-list-card h4 {
  color: white;
  margin-bottom: 5px;
}

.game-list-card p {
  color: #a0aec0;
  font-size: 13px;
}

.game-stats {
  display: flex;
  gap: 15px;
  margin-top: 10px;
}

.game-stat {
  background: rgba(0, 217, 255, 0.1);
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 12px;
  color: #00d9ff;
}

/* ========== FULLSCREEN GAME PRESENTATION ========== */

.game-fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
  z-index: 100000;
  overflow: hidden;
}

/* ============= TEACHER PRESENTATION TOOLS ============= */
.teacher-tools-bar {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 100010;
  display: flex;
  gap: 8px;
  background: rgba(0, 0, 0, 0.85);
  padding: 10px 14px;
  border-radius: 14px;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.teacher-tool-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.teacher-tool-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
}

.teacher-tool-btn.active {
  background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
  box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.5);
}

.teacher-tool-btn.zoom-active {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.5);
}

.teacher-tool-btn.font-btn {
  background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
}

/* Drawing Canvas Overlay - Always on for S Pen but doesn't block touch */
#gameDrawingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 100005;
  pointer-events: none;
  display: block;
  background: transparent;
}

#gameDrawingCanvas {
  width: 100%;
  height: 100%;
  background: transparent;
  pointer-events: none;
}

/* Mini Color Picker */
.color-picker-mini {
  position: fixed;
  top: 140px;
  right: 20px;
  z-index: 100011;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: rgba(0, 0, 0, 0.7);
  padding: 8px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.color-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
}

.color-dot:hover {
  transform: scale(1.15);
}

.color-dot.selected {
  border-color: white;
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
}

/* Drawing Tools Panel - Hidden by default now */
.drawing-tools-panel {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 100011;
  display: none;
  gap: 10px;
  background: rgba(0, 0, 0, 0.92);
  padding: 14px 22px;
  border-radius: 18px;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
  align-items: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.drawing-tools-panel.active {
  display: flex;
}

.color-btn {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
}

.color-btn:hover {
  transform: scale(1.15);
}

.color-btn.selected {
  border-color: white;
  box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
}

.brush-size-btn {
  background: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s;
}

.brush-size-btn:hover {
  background: #e2e8f0;
}

.brush-size-btn.selected {
  background: #667eea;
}

.drawing-action-btn {
  background: #4a5568;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.drawing-action-btn:hover {
  background: #2d3748;
}

.drawing-action-btn.clear-btn {
  background: #f56565;
}

.drawing-action-btn.clear-btn:hover {
  background: #c53030;
}

/* Zoom indicator */
.zoom-indicator {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 10px 18px;
  border-radius: 25px;
  font-size: 15px;
  font-weight: 600;
  z-index: 100010;
  display: none;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.zoom-indicator.visible {
  display: block;
}

/* Zoom Container for Game Content */
.game-zoom-wrapper {
  width: 100%;
  height: 100%;
  transform-origin: center center;
  transition: none;
  user-select: none;
}

.game-zoom-wrapper.panning {
  cursor: grabbing !important;
}

/* ============= END TEACHER PRESENTATION TOOLS ============= */

/* Animated Stars Background */
.stars-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
}

.star {
  position: absolute;
  background: white;
  border-radius: 50%;
  animation: twinkle var(--duration) ease-in-out infinite;
}

@keyframes twinkle {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}

/* Floating Planets */
.planet {
  position: absolute;
  border-radius: 50%;
  animation: float 20s ease-in-out infinite;
}

.planet-1 {
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
  top: 10%;
  right: 5%;
  box-shadow: inset -20px -20px 40px rgba(0,0,0,0.3), 0 0 30px rgba(255, 107, 107, 0.3);
}

.planet-2 {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
  bottom: 15%;
  left: 8%;
  animation-delay: -5s;
  box-shadow: inset -10px -10px 20px rgba(0,0,0,0.3), 0 0 20px rgba(78, 205, 196, 0.3);
}

.planet-3 {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
  top: 60%;
  right: 15%;
  animation-delay: -10s;
  box-shadow: inset -8px -8px 15px rgba(0,0,0,0.3), 0 0 15px rgba(168, 85, 247, 0.3);
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(5deg); }
}

/* Game Header */
.game-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  padding: 20px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 100%);
  z-index: 10;
}

.game-title-display {
  color: #00d9ff;
  font-size: 24px;
  font-weight: bold;
  text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
}

.game-controls {
  display: flex;
  gap: 15px;
  align-items: center;
}

.game-control-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.2);
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.game-control-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: #00d9ff;
}

.game-control-btn.exit-btn {
  background: rgba(229, 62, 62, 0.3);
  border-color: #e53e3e;
}

.game-control-btn.exit-btn:hover {
  background: #e53e3e;
}

/* Score Display */
.score-display {
  background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
  padding: 15px 30px;
  border-radius: 30px;
  color: #1a1a2e;
  font-weight: bold;
  font-size: 20px;
  box-shadow: 0 0 30px rgba(0, 217, 255, 0.4);
}

/* Progress Bar */
.game-progress-container {
  position: absolute;
  top: 80px;
  left: 40px;
  right: 40px;
  z-index: 10;
}

.game-progress-bar {
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  overflow: hidden;
}

.game-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #00d9ff 0%, #48bb78 100%);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.game-progress-text {
  text-align: center;
  color: #a0aec0;
  font-size: 14px;
  margin-top: 8px;
}

/* Question Display */
.game-question-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 900px;
  text-align: center;
  z-index: 5;
}

.game-question-text {
  color: white;
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 40px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  line-height: 1.4;
}

/* Timer Display */
.timer-container {
  position: absolute;
  top: 130px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}

.timer-display {
  font-size: 48px;
  font-weight: bold;
  color: white;
  text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
}

.timer-display.warning {
  color: #f6e05e;
  animation: pulse 0.5s ease-in-out infinite;
}

.timer-display.danger {
  color: #e53e3e;
  animation: pulse 0.3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Answer Options */
.game-answers-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  max-width: 800px;
  margin: 0 auto;
}

.game-answer-btn {
  padding: 25px 30px;
  border-radius: 16px;
  font-size: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  border: 3px solid;
  display: flex;
  align-items: center;
  gap: 15px;
  text-align: left;
}

.game-answer-btn:nth-child(1) {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  border-color: #fc8181;
  color: white;
}

.game-answer-btn:nth-child(2) {
  background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
  border-color: #63b3ed;
  color: white;
}

.game-answer-btn:nth-child(3) {
  background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
  border-color: #f6e05e;
  color: white;
}

.game-answer-btn:nth-child(4) {
  background: linear-gradient(135deg, #38a169 0%, #276749 100%);
  border-color: #68d391;
  color: white;
}

.game-answer-btn:hover {
  transform: scale(1.03);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.game-answer-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.game-answer-btn.correct-reveal {
  animation: correctPulse 0.5s ease-in-out;
  box-shadow: 0 0 40px rgba(72, 187, 120, 0.8);
}

.game-answer-btn.wrong-reveal {
  animation: wrongShake 0.5s ease-in-out;
  opacity: 0.5;
}

@keyframes correctPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes wrongShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.answer-letter {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
  flex-shrink: 0;
}

/* Streak Display - Game Only */
#streakDisplay {
  position: absolute;
  top: 120px;
  left: 40px;
  text-align: center;
  z-index: 10;
  background: rgba(0, 0, 0, 0.6);
  padding: 10px 20px;
  border-radius: 15px;
  border: 2px solid #f6e05e;
}

.streak-flames {
  font-size: 40px;
  animation: flameWiggle 0.5s ease-in-out infinite;
}

@keyframes flameWiggle {
  0%, 100% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
}

.streak-count {
  color: #f6e05e;
  font-size: 24px;
  font-weight: bold;
  text-shadow: 0 0 10px rgba(246, 224, 94, 0.5);
}

/* Feedback Overlay */
.game-feedback-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 20;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.feedback-image {
  max-width: 300px;
  max-height: 300px;
  border-radius: 20px;
  margin-bottom: 30px;
  animation: bounceIn 0.5s ease;
}

@keyframes bounceIn {
  0% { transform: scale(0); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.feedback-text {
  color: white;
  font-size: 36px;
  font-weight: bold;
  margin-bottom: 20px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.feedback-text.correct { color: #48bb78; }
.feedback-text.wrong { color: #e53e3e; }

/* Reason Display */
.reason-container {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 30px;
  max-width: 700px;
  text-align: center;
  margin-top: 20px;
}

.reason-title {
  color: #00d9ff;
  font-size: 20px;
  margin-bottom: 15px;
}

.reason-content {
  color: white;
  font-size: 18px;
  line-height: 1.6;
}

.reason-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 12px;
  margin-top: 15px;
}

.reason-gif {
  max-width: 300px;
  max-height: 200px;
  border-radius: 12px;
  margin-top: 15px;
}

.next-question-btn {
  margin-top: 30px;
  padding: 15px 50px;
  font-size: 20px;
  background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
  color: #1a1a2e;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}

.next-question-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4);
}

/* Start Screen */
.game-start-screen {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 15;
  text-align: center;
  padding: 20px;
  box-sizing: border-box;
}

.game-start-title {
  font-size: 48px;
  font-weight: bold;
  color: white;
  text-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
  margin-bottom: 30px;
  text-align: center;
}

.game-start-image {
  display: block;
  max-width: 90%;
  max-height: 200px;
  width: auto;
  height: auto;
  border-radius: 20px;
  margin: 0 auto 40px auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  object-fit: contain;
}

.game-start-btn {
  padding: 20px 80px;
  font-size: 28px;
  background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
  color: #1a1a2e;
  border: none;
  border-radius: 40px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
  animation: glowPulse 2s ease-in-out infinite;
}

@keyframes glowPulse {
  0%, 100% { box-shadow: 0 0 30px rgba(0, 217, 255, 0.4); }
  50% { box-shadow: 0 0 50px rgba(0, 217, 255, 0.8); }
}

.game-start-btn:hover {
  transform: scale(1.1);
}

/* End Screen */
.game-end-screen {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 15;
}

.end-screen-title {
  font-size: 40px;
  font-weight: bold;
  color: white;
  margin-bottom: 20px;
}

.end-screen-score {
  font-size: 72px;
  font-weight: bold;
  color: #00d9ff;
  text-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
  margin-bottom: 10px;
}

.end-screen-percentage {
  font-size: 36px;
  color: #a0aec0;
  margin-bottom: 30px;
}

.end-screen-gif {
  max-width: 400px;
  max-height: 300px;
  border-radius: 20px;
  margin-bottom: 30px;
}

.end-screen-buttons {
  display: flex;
  gap: 20px;
}

/* Confetti Animation */
.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  animation: confettiFall linear forwards;
}

@keyframes confettiFall {
  0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Lifelines */
.lifelines-container {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 20px;
  z-index: 10;
}

.lifeline-btn {
  padding: 15px 25px;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  border-radius: 30px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.lifeline-btn:hover:not(:disabled) {
  background: rgba(0, 217, 255, 0.2);
  border-color: #00d9ff;
}

.lifeline-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* Paused Overlay */
.game-paused-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 30;
}

.paused-text {
  font-size: 64px;
  color: white;
  margin-bottom: 30px;
  animation: pausePulse 1s ease-in-out infinite;
}

@keyframes pausePulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Question Bank Styles */
.question-bank-item {
  background: linear-gradient(135deg, #1e3a5f 0%, #0f3460 100%);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 10px;
  border: 2px solid #0f3460;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.question-bank-item:hover {
  border-color: #00d9ff;
}

.question-bank-item .question-preview {
  color: white;
  font-size: 14px;
  flex: 1;
}

.question-bank-item .question-category {
  background: rgba(0, 217, 255, 0.2);
  color: #00d9ff;
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 11px;
  margin-left: 10px;
}

.question-bank-item .question-difficulty {
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 11px;
  margin-left: 10px;
}

.question-bank-item .question-difficulty.easy {
  background: rgba(72, 187, 120, 0.2);
  color: #48bb78;
}

.question-bank-item .question-difficulty.medium {
  background: rgba(237, 137, 54, 0.2);
  color: #ed8936;
}

.question-bank-item .question-difficulty.hard {
  background: rgba(229, 62, 62, 0.2);
  color: #e53e3e;
}

/* ============================================== */
/* MY FLASHCARDS & MARKETPLACE STYLES */
/* ============================================== */

/* Folder List Item */
.my-folder-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  margin-bottom: 8px;
  background: #f7fafc;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  color: #1a202c; /* Dark text for readability */
}

.my-folder-item:hover {
  background: #edf2f7;
  transform: translateX(3px);
  color: #1a202c;
}

.my-folder-item.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: transparent;
}

.my-folder-item .folder-count {
  background: rgba(0,0,0,0.1);
  padding: 3px 10px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
  color: #2d3748;
}

.my-folder-item.active .folder-count {
  background: rgba(255,255,255,0.3);
  color: white;
}

.my-folder-item .folder-public-badge {
  font-size: 10px;
  margin-left: 5px;
}

/* Global fix for headings in white/light containers - ensure dark text */
div[style*="background: white"] h3,
div[style*="background: white"] h4,
div[style*="background:#fff"] h3,
div[style*="background:#fff"] h4,
div[style*="background: #fff"] h3,
div[style*="background: #fff"] h4,
div[style*="background: #f7fafc"] h3,
div[style*="background: #f7fafc"] h4 {
  color: #1a202c !important;
}

/* Flashcard Card */
.my-card-item {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 15px;
  transition: all 0.2s;
  position: relative;
}

.my-card-item:hover {
  border-color: #667eea;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
  transform: translateY(-2px);
}

.my-card-item .card-korean {
  font-size: 24px;
  font-weight: bold;
  color: #1a202c;
  margin-bottom: 5px;
}

.my-card-item .card-english {
  font-size: 14px;
  color: #4a5568;
  margin-bottom: 10px;
}

.my-card-item .card-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  color: #718096;
}

.my-card-item .card-box {
  display: flex;
  gap: 2px;
}

.my-card-item .card-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
  opacity: 0;
  transition: opacity 0.2s;
}

.my-card-item:hover .card-actions {
  opacity: 1;
}

.my-card-item .card-actions button {
  width: 28px;
  height: 28px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.my-card-item .card-actions .edit-btn {
  background: #edf2f7;
  color: #4a5568;
}

.my-card-item .card-actions .edit-btn:hover {
  background: #667eea;
  color: white;
}

.my-card-item .card-actions .delete-btn {
  background: #fed7d7;
  color: #c53030;
}

.my-card-item .card-actions .delete-btn:hover {
  background: #c53030;
  color: white;
}

/* Marketplace Tabs */
.marketplace-tab {
  padding: 10px 20px;
  border: 2px solid #e2e8f0;
  border-radius: 25px;
  background: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.marketplace-tab:hover {
  border-color: #667eea;
}

.marketplace-tab.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: transparent;
}

/* Marketplace Set Card */
.marketplace-set-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  transition: all 0.3s;
  border: 2px solid transparent;
}

.marketplace-set-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  border-color: #667eea;
}

.marketplace-set-card .set-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.marketplace-set-card .set-title {
  font-size: 18px;
  font-weight: bold;
  color: #1a202c;
  margin: 0 0 5px 0;
}

.marketplace-set-card .set-creator {
  font-size: 13px;
  color: #718096;
}

.marketplace-set-card .set-price {
  background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
  color: #744210;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  white-space: nowrap;
}

.marketplace-set-card .set-description {
  color: #4a5568;
  font-size: 14px;
  margin-bottom: 15px;
  line-height: 1.5;
}

.marketplace-set-card .set-stats {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.marketplace-set-card .set-stat {
  font-size: 12px;
  color: #718096;
  display: flex;
  align-items: center;
  gap: 5px;
}

.marketplace-set-card .set-category {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
  margin-right: 10px;
}

.marketplace-set-card .set-rating {
  color: #f6ad55;
  font-size: 13px;
}

.marketplace-set-card .set-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.marketplace-set-card .preview-btn {
  flex: 1;
  padding: 10px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.marketplace-set-card .preview-btn:hover {
  border-color: #667eea;
  color: #667eea;
}

.marketplace-set-card .buy-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.marketplace-set-card .buy-btn:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.marketplace-set-card .buy-btn:disabled {
  background: #a0aec0;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Category Cards */
.category-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

/* Study Direction Labels */
input[name="studyDirection"]:checked + span,
label:has(input[name="studyDirection"]:checked) {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

/* Modal Styles for Flashcards */
.flashcard-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.flashcard-modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}

.flashcard-modal-content h3 {
  margin: 0 0 20px 0;
  font-size: 22px;
  color: #1a202c;
}

.flashcard-modal-content .close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 36px;
  height: 36px;
  border: none;
  background: #f7fafc;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.flashcard-modal-content .close-modal:hover {
  background: #e53e3e;
  color: white;
}

/* Purchase Info Card */
.purchase-card {
  background: white;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.purchase-card .purchase-info h4 {
  margin: 0 0 5px 0;
  font-size: 16px;
}

.purchase-card .purchase-info p {
  margin: 0;
  font-size: 12px;
  color: #718096;
}

.purchase-card .purchase-meta {
  text-align: right;
  font-size: 12px;
  color: #a0aec0;
}

/* Star Rating */
.star-rating {
  display: inline-flex;
  gap: 2px;
}

.star-rating .star {
  color: #e2e8f0;
  font-size: 16px;
  cursor: pointer;
  transition: color 0.2s;
}

.star-rating .star.filled {
  color: #f6ad55;
}

.star-rating .star:hover {
  color: #f6ad55;
}

/* Preview Card Grid */
.preview-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  max-height: 200px;
  overflow-y: auto;
  padding: 10px;
  background: #f7fafc;
  border-radius: 10px;
}

.preview-card-mini {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px;
  text-align: center;
}

.preview-card-mini .korean {
  font-size: 18px;
  font-weight: bold;
  color: #1a202c;
}

.preview-card-mini .english {
  font-size: 12px;
  color: #718096;
  margin-top: 3px;
}

/* ============================================== */
/* FLOATING PROFILE BUTTON & PANEL */
/* ============================================== */

.floating-profile-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 8px 15px 8px 8px;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
  transition: all 0.3s;
  border: 3px solid white;
}

.floating-profile-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
}

.floating-profile-img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border: 2px solid white;
}

.floating-profile-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.floating-profile-img .no-photo {
  font-size: 20px;
  color: #a0aec0;
}

.floating-profile-coins {
  color: white;
  font-weight: bold;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* Profile Panel Overlay */
.profile-panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  display: none;
  justify-content: flex-end;
  animation: fadeIn 0.3s;
}

.profile-panel-overlay.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.profile-panel {
  width: 420px;
  max-width: 90vw;
  height: 100vh;
  background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
  overflow-y: auto;
  animation: slideIn 0.3s;
  box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
}

.profile-panel-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 30px 25px;
  text-align: center;
  position: relative;
}

.profile-panel-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s;
}

.profile-panel-close:hover {
  background: rgba(255,255,255,0.3);
}

.profile-panel-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
  margin: 0 auto 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border: 4px solid white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  cursor: pointer;
  position: relative;
}

.profile-panel-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-panel-avatar .no-photo-large {
  font-size: 40px;
  color: #a0aec0;
}

.profile-panel-avatar .edit-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.6);
  color: white;
  font-size: 11px;
  padding: 5px;
  opacity: 0;
  transition: opacity 0.3s;
}

.profile-panel-avatar:hover .edit-overlay {
  opacity: 1;
}

.profile-panel-name {
  color: white;
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 5px;
}

.profile-panel-coins {
  background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
  color: #744210;
  padding: 8px 20px;
  border-radius: 25px;
  font-weight: bold;
  font-size: 18px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}

.profile-panel-section {
  padding: 20px 25px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.profile-panel-section-title {
  color: #a0aec0;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
}

/* Stats Grid */
.profile-stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.profile-stat-card {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  border: 1px solid rgba(255,255,255,0.1);
}

.profile-stat-card .stat-icon {
  font-size: 24px;
  margin-bottom: 8px;
}

.profile-stat-card .stat-value {
  color: white;
  font-size: 22px;
  font-weight: bold;
}

.profile-stat-card .stat-label {
  color: #a0aec0;
  font-size: 11px;
  margin-top: 3px;
}

.profile-stat-card.clickable {
  cursor: pointer;
  transition: all 0.2s ease;
}

.profile-stat-card.clickable:hover {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.4);
  transform: translateY(-2px);
}

.profile-stat-card.clickable:active {
  transform: translateY(0);
}

/* Stat Info Icon with Tooltip */
.stat-info-icon {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 16px;
  height: 16px;
  font-size: 12px;
  color: #718096;
  cursor: help;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
  z-index: 5;
}

.stat-info-icon:hover {
  color: #a0aec0;
  background: rgba(255,255,255,0.1);
}

.stat-info-icon::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 8px);
  right: -10px;
  background: linear-gradient(135deg, #2d3748, #1a202c);
  color: #e2e8f0;
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 11px;
  line-height: 1.4;
  width: 180px;
  text-align: left;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
  pointer-events: none;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  z-index: 100;
}

.stat-info-icon::before {
  content: '';
  position: absolute;
  bottom: calc(100% + 2px);
  right: 4px;
  border: 6px solid transparent;
  border-top-color: #2d3748;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
  z-index: 100;
}

.stat-info-icon:hover::after,
.stat-info-icon:hover::before {
  opacity: 1;
  visibility: visible;
}

.profile-stat-card {
  position: relative;
}

/* Goals Tracker */
.goals-tracker {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  border: 1px solid rgba(255,255,255,0.1);
}

.goals-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.goals-title {
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.goals-edit-btn {
  background: rgba(102, 126, 234, 0.3);
  border: none;
  color: #a78bfa;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.3s;
}

.goals-edit-btn:hover {
  background: rgba(102, 126, 234, 0.5);
}

.goals-progress-bar {
  height: 12px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 8px;
}

.goals-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
  border-radius: 10px;
  transition: width 0.5s;
}

.goals-text {
  color: #a0aec0;
  font-size: 12px;
  display: flex;
  justify-content: space-between;
}

/* Activity Calendar (GitHub-style) */
.activity-calendar {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  border: 1px solid rgba(255,255,255,0.1);
}

.calendar-month-label {
  color: white;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 12px;
  text-align: center;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day-label {
  color: #718096;
  font-size: 10px;
  text-align: center;
  padding: 5px 0;
}

.calendar-day {
  aspect-ratio: 1;
  border-radius: 4px;
  background: rgba(255,255,255,0.1);
  position: relative;
}

.calendar-day.empty {
  background: transparent;
}

.calendar-day.level-0 { background: rgba(255,255,255,0.1); }
.calendar-day.level-1 { background: rgba(72, 187, 120, 0.3); }
.calendar-day.level-2 { background: rgba(72, 187, 120, 0.5); }
.calendar-day.level-3 { background: rgba(72, 187, 120, 0.7); }
.calendar-day.level-4 { background: rgba(72, 187, 120, 1); }

.calendar-day.today {
  border: 2px solid #ffd700;
}

.calendar-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 5px;
  margin-top: 10px;
  font-size: 10px;
  color: #718096;
}

.calendar-legend-box {
  width: 12px;
  height: 12px;
  border-radius: 3px;
}

/* Achievement Badges in Panel */
.badges-panel-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.badge-panel-item {
  text-align: center;
  padding: 10px 5px;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.3s;
}

.badge-panel-item.earned {
  background: rgba(72, 187, 120, 0.1);
  border-color: rgba(72, 187, 120, 0.3);
}

.badge-panel-item.unearned {
  opacity: 0.4;
  filter: grayscale(1);
}

.badge-panel-item .badge-icon {
  font-size: 28px;
  margin-bottom: 5px;
}

.badge-panel-item .badge-name {
  font-size: 9px;
  color: #a0aec0;
  line-height: 1.2;
}

/* Activity Feed */
.activity-feed {
  max-height: 200px;
  overflow-y: auto;
}

.activity-feed-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  margin-bottom: 8px;
  border: 1px solid rgba(255,255,255,0.05);
}

.activity-feed-avatar {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  overflow: hidden;
}

.activity-feed-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.activity-feed-content {
  flex: 1;
}

.activity-feed-text {
  color: #e2e8f0;
  font-size: 13px;
  line-height: 1.4;
}

.activity-feed-time {
  color: #718096;
  font-size: 11px;
  margin-top: 3px;
}

/* Opt-out Toggle */
.opt-out-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.05);
  padding: 12px 15px;
  border-radius: 10px;
  margin-top: 15px;
}

.opt-out-label {
  color: #a0aec0;
  font-size: 13px;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #4a5568;
  transition: 0.4s;
  border-radius: 26px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* Streak Display */
.streak-display {
  background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  margin-bottom: 12px;
}

.streak-number {
  color: white;
  font-size: 36px;
  font-weight: bold;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.streak-label {
  color: rgba(255,255,255,0.9);
  font-size: 12px;
  margin-top: 3px;
}

/* Goals Modal */
.goals-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 3000;
  display: none;
  align-items: center;
  justify-content: center;
}

.goals-modal-overlay.active {
  display: flex;
}

.goals-modal {
  background: white;
  border-radius: 16px;
  padding: 30px;
  width: 400px;
  max-width: 90vw;
}

.goals-modal h3 {
  margin: 0 0 20px 0;
  color: #1a202c;
}

.goals-modal input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 16px;
  margin-bottom: 10px;
  box-sizing: border-box;
}

.goals-modal .warning-text {
  color: #ed8936;
  font-size: 13px;
  padding: 10px;
  background: #fffaf0;
  border-radius: 8px;
  margin-bottom: 15px;
  display: none;
}

.goals-modal .btn-row {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

/* ============================================== */
/* DAILY ACTIVITY STYLES */
/* ============================================== */

/* ============= DAILY ACTIVITY - DARK GLASS MORPHISM DESIGN ============= */
:root {
  --da-bg0: #050512;
  --da-bg1: #07102a;
  --da-text: #eef2ff;
  --da-muted: #aeb8de;
  --da-glass: rgba(255,255,255,.06);
  --da-stroke: rgba(255,255,255,.12);
  --da-shadow: 0 18px 60px rgba(0,0,0,.6);
  --da-r: 16px;
  --da-cardW: clamp(150px, 18vw, 200px);
  --da-cardH: 110px;
  --da-gap: 10px;
}

.daily-activity-container {
  padding: 20px;
  min-height: 100vh;
  background:
    radial-gradient(1000px 650px at 15% 10%, rgba(139,92,246,.18), transparent 60%),
    radial-gradient(900px 650px at 85% 15%, rgba(255,214,130,.10), transparent 55%),
    radial-gradient(750px 650px at 50% 90%, rgba(255,255,255,.08), transparent 55%),
    linear-gradient(180deg, var(--da-bg0), var(--da-bg1));
  position: relative;
  overflow-x: hidden;
  max-width: 100%;
}

.daily-activity-container::before {
  content: "";
  position: absolute;
  inset: -60px;
  pointer-events: none;
  opacity: .55;
  filter: blur(18px) saturate(1.12);
  background:
    radial-gradient(280px 220px at 20% 40%, rgba(139,92,246,.28), transparent 70%),
    radial-gradient(260px 220px at 75% 35%, rgba(255,214,130,.22), transparent 72%),
    radial-gradient(260px 220px at 55% 85%, rgba(255,255,255,.12), transparent 75%);
  animation: da-floaty 14s ease-in-out infinite alternate;
  z-index: 0;
}

@keyframes da-floaty {
  from { transform: translate3d(-20px,-12px,0) rotate(-2deg); }
  to { transform: translate3d(20px,14px,0) rotate(2deg); }
}

.daily-activity-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  position: relative;
  z-index: 1;
}

.daily-activity-title {
  font-size: 28px;
  font-weight: 900;
  color: var(--da-text);
  display: flex;
  align-items: center;
  gap: 12px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.daily-activity-header > div {
  color: var(--da-muted) !important;
}

/* Carousel Section - Glass Card */
.daily-carousel-section {
  margin-bottom: 24px;
  border-radius: calc(var(--da-r) + 10px);
  background: rgba(255,255,255,.035);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: var(--da-shadow);
  overflow: hidden !important;
  padding: 16px;
  position: relative;
  z-index: 1;
  max-width: 100%;
  width: 100%;
  box-sizing: border-box;
}

.daily-carousel-section::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  mix-blend-mode: screen;
  opacity: .72;
}

.daily-carousel-section .sparkles {
  position: absolute;
  inset: 0;
  pointer-events: none;
  mix-blend-mode: screen;
  opacity: .72;
}

.daily-carousel-section .sparkles::before {
  content: "";
  position: absolute;
  inset: -40%;
  background:
    radial-gradient(circle, rgba(255,255,255,.98) 0 1px, transparent 2px),
    radial-gradient(circle, rgba(255,214,130,.70) 0 1px, transparent 2px);
  background-size: 280px 280px, 380px 380px;
  background-position: 0 0, 140px 210px;
  opacity: .14;
  animation: da-twinkle 9.5s linear infinite;
  filter: blur(.2px);
}

@keyframes da-twinkle {
  to { transform: translate3d(70px, 20px, 0) rotate(10deg); }
}

.carousel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  position: relative;
  z-index: 2;
}

.carousel-title {
  font-size: 18px;
  font-weight: 800;
  color: var(--da-text);
  display: flex;
  align-items: center;
  gap: 10px;
}

.carousel-date {
  color: var(--da-muted);
  font-size: 13px;
}

/* Teacher Card - Prominent Upload Area Style */
.da-teacher-card {
  border-radius: var(--da-r);
  border: 1px dashed rgba(255,255,255,.22);
  background: rgba(255,255,255,.03);
  padding: 16px;
  margin-bottom: 14px;
  position: relative;
  z-index: 2;
}

.da-teacher-card.has-content {
  border-style: solid;
  border-color: rgba(255,214,130,.25);
  background: linear-gradient(135deg, rgba(139,92,246,.12), rgba(255,214,130,.08));
}

.da-teacher-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.da-teacher-avatar {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  font-weight: 900;
  background: linear-gradient(135deg, rgba(255,214,130,.92), rgba(255,255,255,.55));
  border: 2px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 20px rgba(255,214,130,.15);
  color: rgba(12,14,30,.92);
  font-size: 18px;
  overflow: hidden;
}

.da-teacher-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.da-teacher-info {
  flex: 1;
  min-width: 0;
}

.da-teacher-name {
  font-weight: 900;
  font-size: 15px;
  color: var(--da-text);
  margin: 0;
}

.da-teacher-label {
  font-size: 11px;
  color: rgba(255,214,130,.9);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.da-script-preview {
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 12px;
  padding: 14px;
  font-size: 14px;
  line-height: 1.8;
  color: var(--da-text);
  max-height: 140px;
  overflow-y: auto;
  margin-bottom: 12px;
}

.da-script-preview::-webkit-scrollbar {
  width: 6px;
}

.da-script-preview::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,.2);
  border-radius: 3px;
}

.da-teacher-audio {
  width: 100%;
  height: 40px;
  border-radius: 20px;
  margin-bottom: 12px;
}

.da-record-btn {
  width: 100%;
  padding: 12px 20px;
  background: var(--da-glass);
  border: 1px solid var(--da-stroke);
  border-radius: 14px;
  color: var(--da-text);
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
}

.da-record-btn:hover {
  background: rgba(255,255,255,.09);
  border-color: rgba(255,255,255,.16);
  transform: translateY(-2px);
}

.da-record-btn:active {
  transform: translateY(0) scale(.99);
}

.da-record-btn.submitted {
  background: rgba(72, 187, 120, 0.2);
  border-color: rgba(72, 187, 120, 0.4);
  color: #68d391;
  cursor: default;
}

.da-record-btn.deadline-passed {
  background: rgba(255,255,255,.03);
  border-color: rgba(255,255,255,.08);
  color: var(--da-muted);
  cursor: default;
  opacity: 0.7;
}

/* Student Carousel - Viewport */
.da-carousel-viewport {
  overflow: hidden !important;
  border-radius: var(--da-r);
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border: 1px solid rgba(255,255,255,.08);
  position: relative;
  z-index: 2;
  max-width: 100%;
  width: 100%;
}

.da-carousel-track {
  display: flex;
  gap: var(--da-gap);
  padding: 10px;
  transform: translate3d(0,0,0);
  transition: transform 430ms cubic-bezier(.2,.85,.2,1);
  will-change: transform;
  user-select: none;
  touch-action: pan-y;
}

/* Student Card - Compact */
.da-student-card {
  flex: 0 0 var(--da-cardW);
  height: var(--da-cardH);
  border-radius: var(--da-r);
  position: relative;
  overflow: hidden;
  background: linear-gradient(180deg, rgba(10,16,42,.68), rgba(10,16,42,.92));
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
  cursor: pointer;
}

.da-student-card::before {
  content: "";
  position: absolute;
  inset: -2px;
  background:
    radial-gradient(460px 200px at 20% 10%, rgba(255,214,130,.18), transparent 60%),
    radial-gradient(460px 220px at 85% 30%, rgba(255,255,255,.10), transparent 62%);
  opacity: .9;
  pointer-events: none;
}

.da-student-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 18px 44px rgba(0,0,0,.44);
  border-color: rgba(255,255,255,.16);
}

.da-student-card.expanded {
  border-color: rgba(255,214,130,.4);
  box-shadow: 0 18px 44px rgba(255,214,130,.15);
}

.da-student-inner {
  position: relative;
  padding: 10px;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.da-student-top {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.da-student-avatar {
  width: 32px;
  height: 32px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  font-weight: 900;
  background: linear-gradient(135deg, rgba(255,214,130,.92), rgba(255,255,255,.55));
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 20px rgba(255,214,130,.12);
  flex: 0 0 auto;
  font-size: 12px;
  color: rgba(12,14,30,.92);
  overflow: hidden;
}

.da-student-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.da-student-name {
  margin: 0;
  font-weight: 900;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.1;
  color: var(--da-text);
}

.da-student-meta {
  margin: 2px 0 0;
  font-size: 10px;
  color: var(--da-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.da-student-stats {
  display: flex;
  gap: 6px;
  margin-top: auto;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,.08);
}

.da-stat-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 7px;
  border-radius: 999px;
  font-size: 10px;
  background: rgba(255,214,130,.10);
  border: 1px solid rgba(255,214,130,.18);
  color: rgba(255,244,220,.96);
  white-space: nowrap;
}

.da-stat-badge.coins {
  background: rgba(255,214,130,.15);
  border-color: rgba(255,214,130,.25);
}

.da-stat-badge.vocab {
  background: rgba(139,92,246,.15);
  border-color: rgba(139,92,246,.25);
  color: rgba(200,180,255,.96);
}

/* Expanded Audio Dropdown */
.da-audio-dropdown {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  transform: translateY(100%);
  background: rgba(10,16,42,.95);
  border: 1px solid rgba(255,255,255,.12);
  border-top: none;
  border-radius: 0 0 var(--da-r) var(--da-r);
  padding: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 200ms ease, transform 200ms ease;
  z-index: 10;
}

.da-student-card.expanded .da-audio-dropdown {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.da-audio-dropdown audio {
  width: 100%;
  height: 36px;
  border-radius: 8px;
}

/* Carousel Controls */
.da-carousel-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  margin-top: 12px;
  padding: 0 4px;
  position: relative;
  z-index: 2;
}

.da-nav-btn {
  appearance: none;
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  background: var(--da-glass);
  border: 1px solid var(--da-stroke);
  color: rgba(238,242,255,.92);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
  user-select: none;
  font-size: 13px;
  font-weight: 600;
}

.da-nav-btn:hover {
  background: rgba(255,255,255,.09);
  border-color: rgba(255,255,255,.16);
  transform: translateY(-1px);
}

.da-nav-btn:active {
  transform: translateY(0) scale(.99);
}

.da-nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.da-nav-counter {
  padding: 10px 14px;
  background: var(--da-glass);
  border: 1px solid var(--da-stroke);
  border-radius: 14px;
  color: var(--da-muted);
  font-size: 13px;
  font-weight: 600;
}

/* Hall of Fame Popup */
.da-hall-overlay {
  position: fixed;
  z-index: 9999;
  width: min(760px, calc(100vw - 24px));
  max-height: min(440px, calc(100vh - 180px));
  opacity: 0;
  transform: translate3d(0, 10px, 0) scale(.92);
  pointer-events: none;
  transition: opacity 140ms ease, transform 160ms cubic-bezier(.2,.9,.2,1);
  border-radius: 22px;
  overflow: hidden;
  box-shadow: 0 28px 90px rgba(0,0,0,.70);
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(16px);
  background: rgba(8,10,25,.78);
}

.da-hall-close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #e2e8f0;
  font-size: 16px;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s, transform 0.2s;
}

.da-hall-close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

@media (max-width: 768px) {
  .da-hall-overlay {
    width: calc(100vw - 20px);
    max-height: calc(100vh - 200px);
    left: 10px !important;
    right: 10px !important;
    top: 50% !important;
    transform: translate3d(0, -50%, 0) scale(.92);
  }
  
  .da-hall-overlay.open {
    transform: translate3d(0, -50%, 0) scale(1);
  }
  
  .da-hall-grid {
    grid-template-columns: repeat(2, 1fr);
    max-height: calc(100vh - 320px);
  }
  
  .da-hall-student {
    padding: 8px;
  }
  
  .da-hall-name {
    font-size: 11px;
  }
  
  .da-hall-stats {
    font-size: 10px;
  }
  
  .da-hall-avatar {
    width: 28px;
    height: 28px;
    font-size: 11px;
  }
}

.da-hall-overlay.open {
  opacity: 1;
  transform: translate3d(0, 0, 0) scale(1);
  pointer-events: auto;
}

.da-hall-overlay .glitter {
  position: absolute;
  inset: 0;
  pointer-events: none;
  mix-blend-mode: screen;
  opacity: .85;
}

.da-hall-overlay .glitter::before {
  content: "";
  position: absolute;
  inset: -40%;
  background:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,.90) 0 1px, transparent 2px),
    radial-gradient(circle at 35% 65%, rgba(255,214,130,.70) 0 1px, transparent 2px),
    radial-gradient(circle at 75% 35%, rgba(255,255,255,.75) 0 1px, transparent 2px),
    radial-gradient(circle at 85% 80%, rgba(255,214,130,.60) 0 1px, transparent 2px);
  background-size: 240px 240px;
  opacity: .20;
  animation: da-glitterMove 7.6s linear infinite;
  filter: blur(.2px);
}

@keyframes da-glitterMove {
  to { transform: translate3d(90px, 25px, 0) rotate(10deg); }
}

.da-hall-content {
  position: relative;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.da-hall-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.da-hall-title {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.da-hall-title strong {
  font-size: 14px;
  letter-spacing: .2px;
  color: var(--da-text);
}

.da-hall-title span {
  font-size: 12px;
  color: var(--da-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 54vw;
}

.da-hall-hint {
  font-size: 12px;
  color: var(--da-muted);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  padding: 7px 9px;
  border-radius: 999px;
  white-space: nowrap;
}

.da-hall-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  overflow: auto;
  padding-right: 4px;
  max-height: 340px;
}

.da-hall-student {
  position: relative;
  border-radius: 16px;
  padding: 10px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 14px 36px rgba(0,0,0,.25);
  cursor: pointer;
  transition: transform 130ms ease, border-color 130ms ease, background 130ms ease;
  overflow: hidden;
  user-select: none;
}

.da-hall-student:hover {
  transform: translateY(-2px);
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
}

.da-hall-student.active-drop {
  outline: 2px solid rgba(255,214,130,.45);
  outline-offset: 2px;
  box-shadow: 0 0 0 6px rgba(255,214,130,.06);
  transform: translateY(-2px) scale(1.01);
}

.da-hall-student-row {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
}

.da-hall-avatar {
  width: 34px;
  height: 34px;
  border-radius: 13px;
  display: grid;
  place-items: center;
  font-weight: 900;
  background: linear-gradient(135deg, rgba(255,214,130,.85), rgba(255,255,255,.55));
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 12px 26px rgba(255,214,130,.10);
  flex: 0 0 auto;
  color: rgba(12,14,30,.92);
  font-size: 13px;
  overflow: hidden;
}

.da-hall-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.da-hall-name {
  font-weight: 900;
  font-size: 12.5px;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.15;
  color: var(--da-text);
}

.da-hall-stats {
  margin: 2px 0 0;
  font-size: 11px;
  color: var(--da-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Empty State */
.da-empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--da-muted);
}

.da-empty-state .empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.da-empty-state p {
  margin: 0;
  font-size: 14px;
}

/* Loading State */
.da-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--da-muted);
  gap: 12px;
}

.da-loading .loading {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(255,255,255,.1);
  border-top-color: rgba(255,214,130,.6);
  border-radius: 50%;
  animation: da-spin 1s linear infinite;
}

@keyframes da-spin {
  to { transform: rotate(360deg); }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .daily-activity-container::before,
  .daily-carousel-section .sparkles::before,
  .da-hall-overlay .glitter::before {
    animation: none !important;
  }
  .da-carousel-track {
    transition: none !important;
  }
  .da-hall-overlay {
    transition: none !important;
  }
}

/* Dark Theme Modal Overlays for Daily Activity */
.grammar-modal,
.teamwork-modal,
.kpop-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(5, 5, 18, 0.85);
  backdrop-filter: blur(8px);
  z-index: 6000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.grammar-modal-content,
.teamwork-modal-content,
.kpop-modal-content {
  background: rgba(8, 10, 25, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.14);
  border-radius: 20px;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 28px 90px rgba(0, 0, 0, 0.7);
  width: 100%;
}

.grammar-modal-header,
.teamwork-modal-header,
.kpop-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.grammar-modal-header h3,
.teamwork-modal-header h3,
.kpop-modal-header h3 {
  margin: 0;
  color: var(--da-text);
  font-size: 18px;
  font-weight: 700;
}

.grammar-modal-body,
.teamwork-modal-body,
.kpop-modal-body {
  padding: 20px;
}

/* Dark themed form inputs */
.daily-activity-container input[type="text"],
.daily-activity-container textarea,
.daily-activity-container select {
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 10px;
  color: var(--da-text);
  padding: 12px;
  font-size: 14px;
  width: 100%;
}

.daily-activity-container input[type="text"]:focus,
.daily-activity-container textarea:focus,
.daily-activity-container select:focus {
  outline: none;
  border-color: rgba(255, 214, 130, 0.4);
  box-shadow: 0 0 0 3px rgba(255, 214, 130, 0.1);
}

.daily-activity-container input[type="text"]::placeholder,
.daily-activity-container textarea::placeholder {
  color: var(--da-muted);
  opacity: 0.6;
}

/* Dark themed audio/video elements */
.daily-activity-container audio,
.daily-activity-container video {
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.3);
}

/* Mobile styles for daily pronunciation challenge video */
@media (max-width: 768px) {
  .da-teacher-card .da-video-container {
    width: 100% !important;
    max-width: 100% !important;
  }

  .da-teacher-card > div[style*="display:flex"][style*="gap:15px"] {
    flex-direction: column !important;
  }

  .da-teacher-card > div[style*="display:flex"][style*="gap:15px"] > div[style*="width:280px"] {
    width: 100% !important;
    max-width: 100% !important;
  }

  #pronTeacherCard video {
    max-width: 100% !important;
    width: 100% !important;
  }
}

/* Kpop post card styling for dark theme */
.kpop-post-card {
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.10);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
}

.kpop-post-card:hover {
  border-color: rgba(236, 72, 153, 0.3);
}

/* Teamwork thread entry styling */
.teamwork-thread-entry {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.10);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
}

.teamwork-thread-entry video,
.teamwork-thread-entry audio {
  width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}

/* ============= FLASHCARD FOLDER SYSTEM ============= */
.fc-folder-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.fc-folder-card {
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
  aspect-ratio: 1 / 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.fc-folder-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

.fc-folder-card.admin-folder {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border: 3px solid #d97706;
}

/* Master folder (contains subfolders) - Bright Yellow */
.fc-folder-card.master-folder {
  background: linear-gradient(135deg, #ffd700 0%, #ffcc00 50%, #f0b800 100%);
  border: 3px solid #b8860b;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
}

.fc-folder-card.master-folder:hover {
  box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
}

.fc-folder-card.master-folder .folder-name {
  color: #5c4600;
}

.fc-folder-card.master-folder .folder-count {
  color: #6b5200;
}

.fc-folder-card.student-folder {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: 3px solid #5a67d8;
}

.fc-folder-card .folder-icon {
  font-size: 36px;
  margin-bottom: 10px;
}

.fc-folder-card .folder-name {
  font-size: 15px;
  font-weight: 700;
  color: white;
  margin-bottom: 6px;
  line-height: 1.3;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.fc-folder-card .folder-count {
  font-size: 12px;
  color: rgba(255,255,255,0.85);
  margin-top: 8px;
}

/* Drag and Drop Styles */
.fc-folder-card.drag-over,
.fc-set-card-teacher.drag-over {
  border: 3px dashed #48bb78 !important;
  background: rgba(72, 187, 120, 0.2) !important;
  transform: scale(1.02);
}

.fc-folder-card.dragging,
.fc-set-card-teacher.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.drop-zone-indicator {
  border: 3px dashed #667eea;
  border-radius: 16px;
  padding: 30px;
  text-align: center;
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
  margin-bottom: 20px;
  transition: all 0.3s;
}

.drop-zone-indicator.active {
  border-color: #48bb78;
  background: rgba(72, 187, 120, 0.15);
  color: #48bb78;
}

/* Bulk Actions Toolbar */
.bulk-actions-toolbar {
  display: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 12px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.bulk-actions-toolbar.visible {
  display: flex;
}

.bulk-actions-toolbar .selected-count {
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.bulk-actions-toolbar button {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.bulk-actions-toolbar button:hover {
  transform: translateY(-2px);
}

.bulk-actions-toolbar .bulk-btn-move {
  background: #48bb78;
  color: white;
}

.bulk-actions-toolbar .bulk-btn-delete {
  background: #f56565;
  color: white;
}

.bulk-actions-toolbar .bulk-btn-cancel {
  background: rgba(255,255,255,0.2);
  color: white;
}

/* Checkbox overlay for bulk selection */
.bulk-select-checkbox {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 22px;
  height: 22px;
  border-radius: 6px;
  border: 2px solid rgba(255,255,255,0.5);
  background: rgba(0,0,0,0.3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  z-index: 10;
}

.bulk-select-checkbox:hover {
  border-color: white;
  background: rgba(0,0,0,0.5);
}

.bulk-select-checkbox.selected {
  background: #48bb78;
  border-color: #48bb78;
}

.bulk-select-checkbox.selected::after {
  content: '';
  color: white;
  font-size: 14px;
  font-weight: bold;
}

.fc-folder-card.selected,
.fc-set-card-teacher.selected {
  box-shadow: 0 0 0 3px #48bb78, 0 8px 25px rgba(72, 187, 120, 0.4);
}

/* Select All checkbox in header */
.select-all-container {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 15px;
  padding: 10px 15px;
  background: #f7fafc;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
}

.select-all-container label {
  font-size: 13px;
  color: #4a5568;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

.select-all-container input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* Move to folder modal */
.move-to-folder-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 7000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.move-to-folder-content {
  background: white;
  border-radius: 16px;
  padding: 25px;
  max-width: 400px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
}

.move-to-folder-content h3 {
  margin: 0 0 20px;
  color: #2d3748;
}

.folder-option {
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.folder-option:hover {
  border-color: #667eea;
  background: #f7fafc;
}

.folder-option.selected {
  border-color: #48bb78;
  background: #f0fff4;
}

.folder-option.root-option {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-color: #f59e0b;
}

/* Teacher Flashcard Sets Grid */
.fc-sets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.fc-set-card-teacher {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 16px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
  aspect-ratio: 1 / 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  border: 3px solid #5a67d8;
}

.fc-set-card-teacher:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

.fc-set-card-teacher .set-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.fc-set-card-teacher .set-title {
  font-size: 13px;
  font-weight: 700;
  color: white;
  margin-bottom: 4px;
  line-height: 1.3;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  word-break: break-word;
}

.fc-set-card-teacher .set-count {
  font-size: 11px;
  color: rgba(255,255,255,0.85);
}

.fc-set-card-teacher .set-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.fc-set-card-teacher:hover .set-actions {
  opacity: 1;
}

.fc-set-card-teacher .set-action-btn {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

.fc-set-card-teacher .set-action-btn:hover {
  transform: scale(1.1);
}

.fc-set-card-teacher .set-action-btn.edit {
  background: rgba(255,255,255,0.9);
  color: #4299e1;
}

.fc-set-card-teacher .set-action-btn.duplicate {
  background: rgba(255,255,255,0.9);
  color: #48bb78;
}

.fc-set-card-teacher .set-action-btn.delete {
  background: rgba(255,255,255,0.9);
  color: #f56565;
}

.fc-folder-card .folder-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.fc-folder-card.admin-folder .folder-badge {
  background: rgba(255,255,255,0.3);
  color: #92400e;
}

.fc-folder-card.student-folder .folder-badge {
  background: rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.9);
}

/* My Cards Synced Folder Styles (Yellow) */
.fc-folder-card.mycards-folder {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border-color: #d97706;
}

.fc-folder-card.mycards-folder .folder-badge {
  background: rgba(255,255,255,0.3);
  color: #78350f;
}

.fc-folder-card.mycards-folder .folder-name {
  color: #78350f;
}

.fc-folder-card.mycards-folder .folder-count {
  color: #92400e;
}

/* My Cards Synced Set Styles (Blue) */
.fc-set-card.mycards-set {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: 2px solid #1d4ed8;
}

.fc-set-card.mycards-set .set-title {
  color: white;
}

.fc-set-card.mycards-set .set-count {
  color: rgba(255,255,255,0.8);
}

/* Info Tooltip for minimum cards */
.folder-info-tooltip {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: rgba(0,0,0,0.15);
  border-radius: 50%;
  font-size: 11px;
  color: rgba(255,255,255,0.9);
  cursor: help;
  margin-left: 6px;
}

.folder-info-tooltip:hover .tooltip-content {
  display: block;
}

.folder-info-tooltip .tooltip-content {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #1a202c;
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  margin-bottom: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  max-width: 250px;
  white-space: normal;
  text-align: left;
  line-height: 1.4;
}

.folder-info-tooltip .tooltip-content::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #1a202c;
}

/* My Cards Section Divider */
.mycards-section-divider {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 15px;
  margin: 20px 0 10px 0;
  padding-top: 20px;
  border-top: 2px dashed #e2e8f0;
}

.mycards-section-divider .divider-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.mycards-section-divider .divider-text {
  font-weight: 600;
  color: #78350f;
  font-size: 14px;
}

.mycards-section-divider .divider-badge {
  background: #fef3c7;
  color: #92400e;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* Disabled folder (less than 5 cards) */
.fc-folder-card.disabled-folder {
  opacity: 0.6;
  cursor: not-allowed;
}

.fc-folder-card.disabled-folder:hover {
  transform: none;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.fc-folder-card .folder-actions {
  position: absolute;
  bottom: 10px;
  right: 10px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s;
}

.fc-folder-card:hover .folder-actions {
  opacity: 1;
}

.fc-folder-card .folder-actions button {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.25);
  color: white;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.fc-folder-card .folder-actions button:hover {
  background: rgba(255,255,255,0.4);
}

.fc-folder-card.admin-folder .folder-actions button.delete-btn {
  display: none;
}

/* Folder contents view */
.fc-folder-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.fc-folder-header .back-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #e2e8f0;
  background: white;
  color: #4a5568;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.fc-folder-header .back-btn:hover {
  background: #667eea;
  border-color: #667eea;
  color: white;
}

.fc-folder-header .folder-title {
  font-size: 22px;
  font-weight: 700;
  color: #2d3748;
}

.fc-folder-header .folder-title-icon {
  font-size: 28px;
}

/* Create folder button */
.fc-create-folder-btn {
  border: 3px dashed #cbd5e0;
  background: transparent;
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 140px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: #718096;
}

.fc-create-folder-btn:hover {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.05);
  color: #667eea;
}

.fc-create-folder-btn .plus-icon {
  font-size: 32px;
  line-height: 1;
}

.fc-create-folder-btn span {
  font-size: 13px;
  font-weight: 600;
}

/* Folder modal */
.fc-folder-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 6000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.fc-folder-modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 450px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0,0,0,0.3);
}

.fc-folder-modal h3 {
  margin: 0 0 20px;
  color: #2d3748;
  font-size: 20px;
}

.fc-folder-modal .form-group {
  margin-bottom: 20px;
}

.fc-folder-modal label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #4a5568;
  font-size: 14px;
}

.fc-folder-modal input[type="text"] {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition: border-color 0.2s;
}

.fc-folder-modal input[type="text"]:focus {
  outline: none;
  border-color: #667eea;
}

.fc-color-picker {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.fc-color-option {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
}

.fc-color-option:hover {
  transform: scale(1.1);
}

.fc-color-option.selected {
  border-color: #2d3748;
  transform: scale(1.15);
}

.fc-folder-modal .modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 25px;
}

.fc-folder-modal .modal-actions button {
  flex: 1;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.fc-folder-modal .cancel-btn {
  background: #e2e8f0;
  border: none;
  color: #4a5568;
}

.fc-folder-modal .cancel-btn:hover {
  background: #cbd5e0;
}

.fc-folder-modal .save-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
}

.fc-folder-modal .save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

/* Unfiled flashcards section */
.fc-unfiled-section {
  margin-top: 30px;
  padding-top: 25px;
  border-top: 2px solid #e2e8f0;
}

.fc-unfiled-section h3 {
  color: #4a5568;
  font-size: 16px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* ============= ADMIN FOLDER DASHBOARD CSS ============= */
.afd-container {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border: 2px solid #f59e0b;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
}

.afd-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.afd-header h3 {
  color: #92400e;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
}

.afd-header-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.afd-btn {
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  display: flex;
  align-items: center;
  gap: 6px;
}

.afd-btn-primary {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}

.afd-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
}

.afd-btn-secondary {
  background: white;
  color: #92400e;
  border: 2px solid #fcd34d;
}

.afd-btn-secondary:hover {
  background: #fef3c7;
}

.afd-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
  border-bottom: 2px solid #fcd34d;
  padding-bottom: 10px;
}

.afd-tab {
  padding: 10px 20px;
  border-radius: 10px 10px 0 0;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  background: transparent;
  border: none;
  color: #a16207;
  transition: all 0.2s;
}

.afd-tab:hover {
  background: rgba(252, 211, 77, 0.3);
}

.afd-tab.active {
  background: #f59e0b;
  color: white;
}

.afd-stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.afd-stat-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  border: 2px solid #fde68a;
}

.afd-stat-value {
  font-size: 28px;
  font-weight: 700;
  color: #92400e;
}

.afd-stat-label {
  font-size: 12px;
  color: #a16207;
  margin-top: 4px;
}

/* Folder Table */
.afd-table-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid #fde68a;
}

.afd-table {
  width: 100%;
  border-collapse: collapse;
}

.afd-table th {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
}

.afd-table td {
  padding: 14px 16px;
  border-bottom: 1px solid #fef3c7;
  font-size: 13px;
  color: #4a5568;
}

.afd-table tr:hover td {
  background: #fffbeb;
}

.afd-table tr:last-child td {
  border-bottom: none;
}

.afd-folder-name {
  font-weight: 600;
  color: #92400e;
  display: flex;
  align-items: center;
  gap: 8px;
}

.afd-badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}

.afd-badge-success {
  background: #d1fae5;
  color: #065f46;
}

.afd-badge-warning {
  background: #fef3c7;
  color: #92400e;
}

.afd-badge-info {
  background: #dbeafe;
  color: #1e40af;
}

.afd-badge-archived {
  background: #e5e7eb;
  color: #6b7280;
}

.afd-actions {
  display: flex;
  gap: 6px;
}

.afd-action-btn {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
  background: #f3f4f6;
}

.afd-action-btn:hover {
  transform: scale(1.1);
}

.afd-action-btn.edit { background: #dbeafe; }
.afd-action-btn.edit:hover { background: #bfdbfe; }
.afd-action-btn.duplicate { background: #d1fae5; }
.afd-action-btn.duplicate:hover { background: #a7f3d0; }
.afd-action-btn.archive { background: #fef3c7; }
.afd-action-btn.archive:hover { background: #fde68a; }
.afd-action-btn.delete { background: #fee2e2; }
.afd-action-btn.delete:hover { background: #fecaca; }
.afd-action-btn.sync { background: #e0e7ff; }
.afd-action-btn.sync:hover { background: #c7d2fe; }
.afd-action-btn.preview { background: #f3e8ff; }
.afd-action-btn.preview:hover { background: #e9d5ff; }

/* Folder Detail View */
.afd-detail-panel {
  background: white;
  border-radius: 12px;
  border: 2px solid #fde68a;
  margin-top: 20px;
}

.afd-detail-header {
  padding: 20px;
  border-bottom: 2px solid #fef3c7;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.afd-detail-title {
  font-size: 18px;
  font-weight: 700;
  color: #92400e;
  display: flex;
  align-items: center;
  gap: 10px;
}

.afd-detail-tabs {
  display: flex;
  gap: 5px;
  padding: 0 20px;
  background: #fffbeb;
}

.afd-detail-tab {
  padding: 12px 20px;
  font-size: 13px;
  font-weight: 600;
  color: #a16207;
  background: transparent;
  border: none;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.afd-detail-tab:hover {
  color: #92400e;
}

.afd-detail-tab.active {
  color: #92400e;
  border-bottom-color: #f59e0b;
}

.afd-detail-content {
  padding: 20px;
}

/* Student List in Detail */
.afd-student-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
}

.afd-student-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.afd-student-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
}

.afd-student-info {
  flex: 1;
  min-width: 0;
}

.afd-student-name {
  font-weight: 600;
  color: #2d3748;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.afd-student-email {
  font-size: 11px;
  color: #718096;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Flashcard Set List in Detail */
.afd-set-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.afd-set-item {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: grab;
}

.afd-set-item:hover {
  background: #f3f4f6;
}

.afd-set-item.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.afd-set-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.afd-set-drag {
  color: #a0aec0;
  cursor: grab;
}

.afd-set-title {
  font-weight: 600;
  color: #2d3748;
}

.afd-set-meta {
  font-size: 12px;
  color: #718096;
}

/* Analytics Section */
.afd-analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.afd-chart-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
}

.afd-chart-title {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Empty State */
.afd-empty {
  text-align: center;
  padding: 60px 20px;
  color: #a16207;
}

.afd-empty-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.afd-empty-text {
  font-size: 16px;
  margin-bottom: 20px;
}

/* Search and Filter */
.afd-search-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.afd-search-input {
  flex: 1;
  min-width: 200px;
  padding: 10px 16px;
  border: 2px solid #fcd34d;
  border-radius: 10px;
  font-size: 14px;
  background: white;
}

.afd-search-input:focus {
  outline: none;
  border-color: #f59e0b;
}

.afd-filter-select {
  padding: 10px 16px;
  border: 2px solid #fcd34d;
  border-radius: 10px;
  font-size: 14px;
  background: white;
  cursor: pointer;
}

/* Drag and Drop Highlight */
.afd-drop-zone {
  border: 2px dashed #fcd34d;
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  color: #a16207;
  transition: all 0.2s;
}

.afd-drop-zone.drag-over {
  border-color: #f59e0b;
  background: #fef3c7;
}

/* Preview Modal */
.afd-preview-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 7000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.afd-preview-content {
  background: white;
  border-radius: 20px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0,0,0,0.3);
}

.afd-preview-header {
  padding: 20px;
  border-bottom: 2px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.afd-preview-body {
  padding: 20px;
}

/* Notification Badge */
.afd-notification-indicator {
  position: absolute;
  top: -5px;
  right: -5px;
  width: 18px;
  height: 18px;
  background: #ef4444;
  border-radius: 50%;
  color: white;
  font-size: 10px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Access Control */
.afd-access-control {
  background: #f0fdf4;
  border: 2px solid #86efac;
  border-radius: 12px;
  padding: 16px;
  margin-top: 15px;
}

.afd-date-inputs {
  display: flex;
  gap: 15px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.afd-date-group {
  flex: 1;
  min-width: 150px;
}

.afd-date-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: #065f46;
  margin-bottom: 5px;
}

.afd-date-group input {
  width: 100%;
  padding: 8px 12px;
  border: 2px solid #86efac;
  border-radius: 8px;
  font-size: 13px;
}

/* Teacher Correction Dropdown */
.correction-dropdown {
  margin-top: 12px;
  border-top: 1px solid #e2e8f0;
  padding-top: 12px;
}

.correction-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #667eea;
  font-size: 13px;
  cursor: pointer;
  font-weight: 500;
}

.correction-toggle:hover {
  color: #5a67d8;
}

.correction-content {
  display: none;
  margin-top: 12px;
}

.correction-content.open {
  display: block;
}

.correction-content video {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 10px;
}

/* Vocabulary Keyword Hover */
.vocab-keyword {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  padding: 2px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-block;
  margin: 2px;
}

.vocab-keyword:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
  transform: translateY(-1px);
}

.vocab-keyword .word-korean {
  font-weight: 600;
  color: #4c51bf;
}

.vocab-keyword .word-english {
  color: #718096;
  font-size: 12px;
  margin-left: 4px;
}

/* Hoverable Korean words in Teacher Feedback */
.hoverable-korean-word:hover {
  background: rgba(159, 122, 234, 0.3) !important;
}

/* Vocab Save Tooltip */
.vocab-save-tooltip {
  position: absolute;
  background: white;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  z-index: 1000;
  min-width: 260px;
  max-width: 320px;
}

.vocab-save-tooltip .tooltip-title {
  font-weight: 600;
  color: #1a202c;
  margin-bottom: 8px;
}

.vocab-save-tooltip button {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}

/* Transcript Comparison */
.transcript-comparison {
  background: #f8fafc;
  border-radius: 10px;
  padding: 12px;
  margin-top: 10px;
  font-size: 13px;
}

.transcript-comparison .original-text {
  color: #2d3748;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #e2e8f0;
}

.transcript-comparison .student-text {
  color: #4a5568;
}

.transcript-comparison .error-highlight {
  background: #fef3c7;
  color: #c53030;
  padding: 1px 4px;
  border-radius: 3px;
}

/* AI Suggestions Box (Teacher View) */
.ai-suggestions-box {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  border: 1px solid #7dd3fc;
  border-radius: 10px;
  padding: 12px;
  margin-top: 10px;
  font-size: 12px;
}

.ai-suggestions-box .suggestions-title {
  font-weight: 600;
  color: #0369a1;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ai-suggestions-box .good-points {
  color: #166534;
  margin-bottom: 8px;
}

.ai-suggestions-box .fix-points {
  color: #9a3412;
}

/* Grading Modal */
.grading-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 3000;
  display: none;
  align-items: center;
  justify-content: center;
}

.grading-modal-overlay.active {
  display: flex;
}

.grading-modal {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
}

.grading-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 25px;
  color: white;
  border-radius: 20px 20px 0 0;
}

.grading-modal-header h2 {
  margin: 0 0 5px 0;
  font-size: 22px;
}

.grading-modal-header .student-info {
  opacity: 0.9;
  font-size: 14px;
}

.grading-modal-body {
  padding: 25px;
}

/* Character/Sound Selection Grid */
.sound-selection-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 25px;
}

.sound-item {
  padding: 12px 18px;
  background: #f1f5f9;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.sound-item:hover:not(.disabled):not(.selected) {
  border-color: #667eea;
  background: #eef2ff;
}

.sound-item.selected {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: transparent;
}

.sound-item.graded {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  border-color: transparent;
}

.sound-item.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.sound-item .sound-char {
  font-size: 20px;
  font-weight: bold;
}

.sound-item .sound-name {
  font-size: 11px;
  margin-top: 3px;
  opacity: 0.8;
}

/* Grade Pop-up */
.grade-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  z-index: 4000;
  text-align: center;
  min-width: 300px;
}

.grade-popup h3 {
  margin: 0 0 20px 0;
  color: #1a202c;
}

.grade-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}

.grade-btn {
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.grade-btn:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: transparent;
}

/* Video Recording */
.video-record-container {
  text-align: center;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px solid #e2e8f0;
}

.video-preview {
  width: 100%;
  max-width: 400px;
  border-radius: 12px;
  background: #1a202c;
  margin-bottom: 15px;
}

.record-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.record-btn {
  padding: 12px 25px;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.record-btn.start {
  background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
  color: white;
  border: none;
}

.record-btn.stop {
  background: #e2e8f0;
  color: #4a5568;
  border: none;
}

.record-timer {
  font-size: 24px;
  font-weight: bold;
  color: #f56565;
  margin-bottom: 10px;
}

/* Teacher Script Creator */
.script-creator-section {
  background: white;
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.script-creator-section h3 {
  margin: 0 0 20px 0;
  color: #1a202c;
  display: flex;
  align-items: center;
  gap: 10px;
}

.topic-input-row {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.topic-input-row input {
  flex: 1;
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
}

.topic-input-row button {
  padding: 12px 25px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

.generated-script-box {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.generated-script-box textarea {
  width: 100%;
  min-height: 200px;
  border: none;
  background: transparent;
  font-size: 15px;
  line-height: 1.8;
  resize: vertical;
}

.vocabulary-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

.vocab-tag {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
}

.vocab-tag .korean {
  font-weight: 600;
  color: #4c51bf;
}

.vocab-tag .english {
  color: #718096;
  margin-left: 5px;
}

/* Schedule Section */
.schedule-section {
  display: flex;
  gap: 15px;
  align-items: center;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px solid #e2e8f0;
}

.schedule-section input[type="datetime-local"] {
  padding: 10px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
}

/* Teacher Audio Recording */
.audio-record-section {
  background: #f8fafc;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-top: 20px;
}

.audio-record-section .status {
  margin-bottom: 15px;
  font-size: 14px;
  color: #718096;
}

.audio-record-section audio {
  width: 100%;
  max-width: 400px;
  margin-bottom: 15px;
}

/* Placeholder Carousel */
.placeholder-carousel {
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  border-radius: 16px;
  padding: 60px 40px;
  text-align: center;
  border: 2px dashed #cbd5e0;
}

.placeholder-carousel .placeholder-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.placeholder-carousel .placeholder-text {
  color: #64748b;
  font-size: 16px;
  font-weight: 500;
}

.placeholder-carousel .coming-soon {
  color: #94a3b8;
  font-size: 13px;
  margin-top: 8px;
}

/* ============================================== */
/* TEAMWORK ACTIVITY STYLES */
/* ============================================== */

.teamwork-section {
  border: 2px solid rgba(72, 187, 120, 0.3);
  background: linear-gradient(135deg, rgba(72, 187, 120, 0.05), rgba(56, 178, 172, 0.05));
}

/* Teamwork Instructions Banner */
.teamwork-instructions-banner {
  display: flex;
  gap: 15px;
  padding: 15px 20px;
  background: linear-gradient(135deg, #ebf8ff, #e6fffa);
  border: 1px solid #38b2ac;
  border-radius: 12px;
  margin: 15px 20px;
  position: relative;
}

.teamwork-instructions-banner .instructions-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.teamwork-instructions-banner .instructions-content {
  flex: 1;
}

.teamwork-instructions-banner .instructions-title {
  font-weight: 700;
  color: #234e52;
  margin-bottom: 8px;
  font-size: 14px;
}

.teamwork-instructions-banner .instructions-steps {
  margin: 0;
  padding-left: 20px;
  color: #285e61;
  font-size: 13px;
  line-height: 1.6;
}

.teamwork-instructions-banner .instructions-steps li {
  margin-bottom: 4px;
}

.teamwork-instructions-banner .instructions-note {
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(56, 178, 172, 0.15);
  border-radius: 8px;
  font-size: 12px;
  color: #234e52;
}

.teamwork-instructions-banner .instructions-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  color: #718096;
  cursor: pointer;
  font-size: 16px;
  padding: 5px;
}

.teamwork-instructions-banner .instructions-close:hover {
  color: #2d3748;
}

/* Example Questions */
.teamwork-example-questions {
  background: #f7fafc;
  border-radius: 10px;
  padding: 15px;
  margin: 15px 0;
  text-align: left;
}

.teamwork-example-questions .example-label {
  font-size: 13px;
  color: #718096;
  margin-bottom: 10px;
}

.teamwork-example-questions .example-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.teamwork-example-questions .example-list span {
  background: white;
  border: 1px solid #e2e8f0;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  color: #2d3748;
}

/* Teamwork Notification Badge */
.teamwork-notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #f56565;
  color: white;
  font-size: 11px;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
}

/* Teamwork Progress Indicator */
.teamwork-progress {
  background: linear-gradient(135deg, #f7fafc, #edf2f7);
  border-radius: 12px;
  padding: 15px 20px;
  margin-bottom: 20px;
}

.teamwork-progress .progress-label {
  font-size: 12px;
  color: #718096;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.teamwork-progress .progress-steps {
  display: flex;
  justify-content: space-between;
  position: relative;
}

.teamwork-progress .progress-steps::before {
  content: '';
  position: absolute;
  top: 15px;
  left: 30px;
  right: 30px;
  height: 3px;
  background: #e2e8f0;
  z-index: 0;
}

.teamwork-progress .progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 1;
}

.teamwork-progress .step-circle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
  color: #a0aec0;
  margin-bottom: 8px;
  transition: all 0.3s;
}

.teamwork-progress .progress-step.completed .step-circle {
  background: linear-gradient(135deg, #48bb78, #38a169);
  color: white;
}

.teamwork-progress .progress-step.current .step-circle {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  animation: pulse 2s infinite;
}

.teamwork-progress .step-label {
  font-size: 11px;
  color: #718096;
}

.teamwork-progress .progress-step.completed .step-label {
  color: #48bb78;
  font-weight: 600;
}

.teamwork-progress .progress-step.current .step-label {
  color: #667eea;
  font-weight: 600;
}

/* Completed State */
.teamwork-completed-state {
  text-align: center;
  padding: 40px 20px;
  background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 178, 172, 0.1));
  border-radius: 16px;
  margin: 20px;
}

.teamwork-completed-state h4 {
  color: #276749;
  margin-bottom: 10px;
}

.teamwork-completed-state p {
  color: #48bb78;
  margin-bottom: 0;
}

/* Teamwork Carousel Display */
.teamwork-carousel-display {
  display: flex;
  gap: 20px;
  padding: 20px;
  align-items: flex-start;
  overflow-x: auto;
}

.teamwork-my-question-card,
.teamwork-question-card {
  flex: 0 0 300px;
  background: linear-gradient(135deg, #1a365d, #2a4365);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.teamwork-card-header {
  padding: 12px 15px;
  background: rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
}

.teamwork-card-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #48bb78, #38a169);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 14px;
}

.teamwork-card-avatar.student-b {
  background: linear-gradient(135deg, #667eea, #764ba2);
}

.teamwork-card-name {
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.teamwork-card-label {
  color: rgba(255,255,255,0.7);
  font-size: 11px;
}

.teamwork-card-video {
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
}

.teamwork-card-video video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.teamwork-card-transcript {
  padding: 12px 15px;
  background: rgba(0,0,0,0.2);
}

.teamwork-card-transcript-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  cursor: pointer;
  padding: 8px 0;
}

.teamwork-card-transcript-toggle:hover {
  color: white;
}

.teamwork-card-korean {
  color: white;
  font-size: 15px;
  line-height: 1.5;
  padding: 10px 0;
  display: none;
  position: relative;
  cursor: help;
}

.teamwork-card-korean.show {
  display: block;
}

.teamwork-card-korean:hover {
  background: rgba(255, 215, 0, 0.15);
  border-radius: 6px;
  padding: 10px;
  margin: 0 -10px;
}

.teamwork-card-korean .hover-translation {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #2d3748, #1a202c);
  color: #68d391;
  padding: 12px 15px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.5;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  border: 1px solid rgba(104, 211, 145, 0.3);
}

.teamwork-card-korean .hover-translation::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 20px;
  border: 8px solid transparent;
  border-top-color: #2d3748;
}

.teamwork-card-korean:hover .hover-translation {
  opacity: 1;
  visibility: visible;
}

.teamwork-card-korean .translation-label {
  font-size: 11px;
  color: #a0aec0;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.teamwork-card-english {
  color: rgba(255,255,255,0.6);
  font-size: 13px;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
  margin-top: 8px;
  display: none;
}

.teamwork-card-english.show {
  display: block;
}

.teamwork-waiting-info,
.teamwork-respond-info {
  flex: 1;
  text-align: center;
  padding: 30px 20px;
}

.teamwork-waiting-info h4,
.teamwork-respond-info h4 {
  color: #2d3748;
  margin-bottom: 10px;
}

.teamwork-waiting-info p,
.teamwork-respond-info p {
  color: #718096;
  font-size: 14px;
}

.waiting-spinner {
  font-size: 40px;
  margin-bottom: 15px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.teamwork-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #a0aec0;
}

.teamwork-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #a0aec0;
}

.teamwork-status.active .status-dot {
  background: #48bb78;
  animation: pulse 2s infinite;
}

.teamwork-status.waiting .status-dot {
  background: #f6ad55;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

/* Empty State */
.teamwork-empty-state,
.teamwork-waiting-state,
.teamwork-respond-state {
  text-align: center;
  padding: 40px 20px;
}

.teamwork-empty-icon,
.teamwork-waiting-icon,
.teamwork-respond-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.teamwork-empty-state h4,
.teamwork-waiting-state h4,
.teamwork-respond-state h4 {
  color: #2d3748;
  margin-bottom: 10px;
  font-size: 18px;
}

.teamwork-empty-state p,
.teamwork-waiting-state p,
.teamwork-respond-state p {
  color: #718096;
  margin-bottom: 20px;
  font-size: 14px;
}

.teamwork-start-btn {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
  padding: 15px 30px !important;
  font-size: 16px !important;
}

.teamwork-respond-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  padding: 15px 30px !important;
  font-size: 16px !important;
}

/* Teamwork Thread */
.teamwork-thread-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 20px;
}

.teamwork-entry {
  background: white;
  border-radius: 16px;
  padding: 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  border: 1px solid #e2e8f0;
  overflow: hidden;
}

.teamwork-entry.student-a {
  border-left: 4px solid #48bb78;
}

.teamwork-entry.student-b {
  border-left: 4px solid #667eea;
}

.teamwork-entry-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  background: #f7fafc;
  border-bottom: 1px solid #e2e8f0;
}

.teamwork-entry-user {
  display: flex;
  align-items: center;
  gap: 10px;
}

.teamwork-entry-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
}

.teamwork-entry-name {
  font-weight: 600;
  color: #2d3748;
  font-size: 14px;
}

.teamwork-entry-badge {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: 600;
}

.teamwork-entry-badge.video {
  background: #fed7e2;
  color: #97266d;
}

.teamwork-entry-badge.audio {
  background: #c6f6d5;
  color: #276749;
}

.teamwork-entry-body {
  display: flex;
  gap: 15px;
  padding: 15px;
}

.teamwork-media-section {
  flex: 0 0 auto;
}

.teamwork-video-container,
.teamwork-audio-container {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  background: #1a202c;
}

.teamwork-video-container {
  width: 200px;
  height: 150px;
}

.teamwork-audio-container {
  width: 200px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 10px 15px;
}

.teamwork-audio-container audio {
  width: 100%;
  height: 40px;
}

.teamwork-video-container video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.teamwork-play-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}

.teamwork-play-overlay:hover {
  background: rgba(0,0,0,0.2);
}

.teamwork-play-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

/* Transcription Section */
.teamwork-transcription-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.teamwork-transcript-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #edf2f7;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  color: #4a5568;
  transition: all 0.2s;
  border: none;
  width: fit-content;
}

.teamwork-transcript-toggle:hover {
  background: #e2e8f0;
}

.teamwork-transcript-content {
  display: none;
  padding: 12px;
  background: #f7fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.teamwork-transcript-content.expanded {
  display: block;
}

.teamwork-korean-text {
  font-size: 16px;
  color: #2d3748;
  line-height: 1.6;
  cursor: help;
  position: relative;
}

.teamwork-korean-text:hover {
  background: #fef3c7;
  border-radius: 4px;
}

.teamwork-korean-text.teamwork-hoverable {
  padding: 8px;
  border-radius: 8px;
  transition: background 0.2s;
}

.teamwork-korean-text.teamwork-hoverable:hover {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.teamwork-hover-tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #1a365d, #2d3748);
  color: white;
  padding: 12px 15px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.5;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  border: 1px solid rgba(104, 211, 145, 0.3);
}

.teamwork-hover-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 20px;
  border: 8px solid transparent;
  border-top-color: #1a365d;
}

.teamwork-korean-text.teamwork-hoverable:hover .teamwork-hover-tooltip {
  opacity: 1;
  visibility: visible;
}

.teamwork-hover-tooltip .tooltip-label {
  font-size: 11px;
  color: #68d391;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.teamwork-hover-tooltip .tooltip-text {
  color: #e2e8f0;
}

/* ============================================== */
/* KPOP/KDRAMA ACTIVITY STYLES */
/* ============================================== */

.kpop-section {
  border: 2px solid rgba(236, 72, 153, 0.3);
  background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(168, 85, 247, 0.05));
}

.kpop-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #718096;
}

.kpop-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #a0aec0;
}

.kpop-status.active .status-dot {
  background: #ec4899;
  animation: pulse 2s infinite;
}

/* Instructions Banner */
.kpop-instructions-banner {
  display: flex;
  gap: 15px;
  padding: 15px 20px;
  background: linear-gradient(135deg, #fdf2f8, #fae8ff);
  border: 1px solid #ec4899;
  border-radius: 12px;
  margin: 15px 20px;
  position: relative;
}

.kpop-instructions-banner .instructions-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.kpop-instructions-banner .instructions-content {
  flex: 1;
}

.kpop-instructions-banner .instructions-title {
  font-weight: 700;
  color: #831843;
  margin-bottom: 8px;
  font-size: 14px;
}

.kpop-instructions-banner .instructions-steps {
  margin: 0;
  padding-left: 20px;
  color: #9d174d;
  font-size: 13px;
  line-height: 1.6;
}

.kpop-instructions-banner .instructions-note {
  margin-top: 10px;
  padding: 8px 12px;
  background: rgba(236, 72, 153, 0.15);
  border-radius: 8px;
  font-size: 12px;
  color: #831843;
}

.kpop-instructions-banner .instructions-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  color: #718096;
  cursor: pointer;
  font-size: 16px;
  padding: 5px;
}

/* Create Section */
.kpop-create-section {
  padding: 20px;
  text-align: center;
}

.kpop-create-btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 15px 30px;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
}

.kpop-create-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
}

/* Feed */
.kpop-feed {
  padding: 0 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.kpop-loading {
  text-align: center;
  padding: 40px;
  color: #718096;
}

/* Post Card */
.kpop-post-card {
  background: rgba(255, 255, 255, 0.06);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border: 1px solid rgba(255, 255, 255, 0.10);
}

.kpop-post-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  gap: 10px;
  flex-wrap: wrap;
}

.kpop-post-user {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
  flex: 1;
}

.kpop-post-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 16px;
  flex-shrink: 0;
}

.kpop-post-user-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.kpop-post-username {
  font-weight: 600;
  color: #e2e8f0;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.kpop-post-meta {
  font-size: 12px;
  color: #a0aec0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.kpop-post-category {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  flex-shrink: 0;
  white-space: nowrap;
}

/* Mobile responsive for kpop post header */
@media (max-width: 480px) {
  .kpop-post-header {
    padding: 12px;
    flex-direction: row;
    align-items: center;
  }
  
  .kpop-post-avatar {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
  
  .kpop-post-user {
    gap: 10px;
  }
  
  .kpop-post-username {
    font-size: 13px;
    max-width: 120px;
  }
  
  .kpop-post-meta {
    font-size: 11px;
    max-width: 140px;
  }
  
  .kpop-post-category {
    padding: 3px 8px;
    font-size: 10px;
  }
}

.kpop-post-category.kpop {
  background: #fce7f3;
  color: #be185d;
}

.kpop-post-category.kdrama {
  background: #ede9fe;
  color: #7c3aed;
}

.kpop-post-category.variety {
  background: #dbeafe;
  color: #2563eb;
}

.kpop-post-category.movie {
  background: #fef3c7;
  color: #d97706;
}

.kpop-post-category.other {
  background: #e2e8f0;
  color: #475569;
}

/* Video Section */
.kpop-post-video {
  position: relative;
  background: #000;
  aspect-ratio: 16/9;
}

.kpop-post-video video {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Audio Section */
.kpop-post-audio {
  padding: 15px;
  background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(168, 85, 247, 0.1));
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.kpop-post-audio-label {
  font-size: 12px;
  color: #f472b6;
  margin-bottom: 8px;
  font-weight: 600;
}

.kpop-post-audio audio {
  width: 100%;
}

/* Transcription Section */
.kpop-post-transcription {
  padding: 15px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.kpop-post-korean {
  font-size: 18px;
  color: #e2e8f0;
  line-height: 1.6;
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  cursor: help;
  position: relative;
}

.kpop-post-korean:hover {
  background: rgba(255, 255, 255, 0.05);
}

.kpop-post-korean .kpop-translation-tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #1a202c, #2d3748);
  color: white;
  padding: 12px 15px;
  border-radius: 10px;
  font-size: 14px;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.kpop-post-korean .kpop-translation-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 20px;
  border: 8px solid transparent;
  border-top-color: #1a202c;
}

.kpop-post-korean:hover .kpop-translation-tooltip {
  opacity: 1;
  visibility: visible;
}

.kpop-translation-label {
  font-size: 11px;
  color: #f472b6;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Explanation */
.kpop-post-explanation {
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.kpop-post-explanation-label {
  font-size: 12px;
  color: #a0aec0;
  margin-bottom: 5px;
}

.kpop-post-explanation-text {
  color: #cbd5e0;
  font-size: 14px;
  line-height: 1.5;
}

.kpop-post-source {
  margin-top: 8px;
  font-size: 12px;
  color: #a0aec0;
  font-style: italic;
}

/* Reactions */
.kpop-post-reactions {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 12px 15px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  gap: 8px;
  flex-wrap: wrap;
}

.kpop-reaction-buttons {
  display: flex;
  gap: 8px;
}

.kpop-reaction-btn {
  padding: 8px 14px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.08);
  color: #e2e8f0;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.kpop-reaction-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.3);
}

.kpop-reaction-btn.active {
  background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(168, 85, 247, 0.2));
  border-color: #ec4899;
}

.kpop-reaction-count {
  font-size: 13px;
  color: #a0aec0;
}

.kpop-comment-btn {
  padding: 8px 14px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.08);
  color: #e2e8f0;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
}

.kpop-comment-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.3);
}

/* Hide "Comments" text, show only emoji */
.kpop-comment-btn-text {
  display: none;
}

/* Mobile responsive for reactions */
@media (max-width: 480px) {
  .kpop-post-reactions {
    padding: 10px 12px;
    gap: 6px;
  }
  
  .kpop-reaction-buttons {
    gap: 6px;
  }
  
  .kpop-reaction-btn {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  .kpop-comment-btn {
    padding: 8px 12px;
    font-size: 14px;
  }
}

/* Modal */
.kpop-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.kpop-modal-content {
  background: white;
  border-radius: 20px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

.kpop-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
  background: linear-gradient(135deg, #fdf2f8, #fae8ff);
  border-radius: 20px 20px 0 0;
}

.kpop-modal-header h3 {
  margin: 0;
  color: #831843;
  font-size: 18px;
}

.kpop-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.1);
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.kpop-modal-body {
  padding: 20px;
}

/* Steps */
.kpop-step {
  margin-bottom: 25px;
  padding-bottom: 25px;
  border-bottom: 1px solid #f1f5f9;
}

.kpop-step:last-child {
  border-bottom: none;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.step-number {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
}

.step-title {
  font-weight: 600;
  color: #1a202c;
  font-size: 15px;
}

.step-instruction {
  color: #718096;
  font-size: 13px;
  margin-bottom: 15px;
}

/* Video Preview */
.kpop-video-preview-area {
  position: relative;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  aspect-ratio: 16/9;
  margin-bottom: 15px;
}

.kpop-video-preview-area video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.recording-indicator {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
}

.rec-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: white;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.kpop-record-controls,
.kpop-audio-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.kpop-record-btn,
.kpop-audio-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.kpop-stop-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

/* Audio Area */
.kpop-audio-area {
  background: linear-gradient(135deg, #fdf2f8, #fae8ff);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.audio-visualizer {
  display: flex;
  align-items: center;
  gap: 4px;
  height: 40px;
}

.audio-visualizer .audio-wave {
  width: 4px;
  height: 20px;
  background: #ec4899;
  border-radius: 2px;
  animation: wave 0.5s ease-in-out infinite;
}

.audio-visualizer .audio-wave:nth-child(2) { animation-delay: 0.1s; }
.audio-visualizer .audio-wave:nth-child(3) { animation-delay: 0.2s; }
.audio-visualizer .audio-wave:nth-child(4) { animation-delay: 0.3s; }
.audio-visualizer .audio-wave:nth-child(5) { animation-delay: 0.4s; }

@keyframes wave {
  0%, 100% { height: 20px; }
  50% { height: 40px; }
}

.audio-timer {
  font-size: 18px;
  font-weight: 600;
  color: #831843;
}

.transcription-result {
  margin-top: 15px;
  padding: 15px;
  background: #f8fafc;
  border-radius: 10px;
}

.transcription-result label {
  font-size: 13px;
  color: #718096;
  display: block;
  margin-bottom: 8px;
}

.transcription-text {
  font-size: 16px;
  color: #1a202c;
  line-height: 1.5;
}

/* Explanation Input */
.kpop-explanation-input {
  width: 100%;
  min-height: 100px;
  padding: 15px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

.kpop-explanation-input:focus {
  outline: none;
  border-color: #ec4899;
}

.kpop-category-select,
.kpop-source-input {
  margin-top: 15px;
}

.kpop-category-select label,
.kpop-source-input label {
  display: block;
  font-size: 13px;
  color: #718096;
  margin-bottom: 5px;
}

.kpop-category-select select,
.kpop-source-input input {
  width: 100%;
  padding: 10px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
}

/* Submit Section */
.kpop-submit-section {
  display: flex;
  justify-content: center;
  gap: 15px;
  padding-top: 20px;
  border-top: 1px solid #f1f5f9;
  margin-top: 20px;
}

.kpop-submit-btn {
  padding: 12px 30px;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

/* Comments Modal */
.kpop-comment-modal-content {
  max-width: 500px;
  width: calc(100% - 40px);
  margin: 0 auto;
}

.kpop-comments-list {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 15px;
}

@media (max-width: 480px) {
  .kpop-comment-modal-content {
    width: calc(100% - 20px);
    max-width: none;
  }
  
  .kpop-modal-body {
    padding: 15px !important;
  }
  
  .kpop-comment-input-area {
    flex-direction: column;
    gap: 8px;
  }
  
  .kpop-comment-input-area input {
    width: 100%;
    box-sizing: border-box;
  }
  
  .kpop-comment-submit-btn {
    width: 100%;
  }
}

.kpop-comment-item {
  display: flex;
  gap: 10px;
  padding: 12px;
  border-bottom: 1px solid #f1f5f9;
}

.kpop-comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: bold;
  flex-shrink: 0;
}

.kpop-comment-content {
  flex: 1;
}

.kpop-comment-username {
  font-weight: 600;
  font-size: 13px;
  color: #1a202c;
}

.kpop-comment-text {
  font-size: 14px;
  color: #4a5568;
  margin-top: 3px;
}

.kpop-comment-time {
  font-size: 11px;
  color: #a0aec0;
  margin-top: 3px;
}

.kpop-comment-input-area {
  display: flex;
  gap: 10px;
}

.kpop-comment-input-area input {
  flex: 1;
  padding: 10px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 20px;
  font-size: 14px;
}

.kpop-comment-submit-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #ec4899, #a855f7);
  color: white;
  border: none;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

/* Empty State */
.kpop-empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #718096;
}

.kpop-empty-state .empty-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.kpop-empty-state h4 {
  color: #4a5568;
  margin-bottom: 10px;
}

.kpop-empty-state p {
  font-size: 14px;
}

/* ============================================== */
/* GRAMMAR BLABBER ACTIVITY STYLES */
/* ============================================== */

.grammar-blabber-section {
  border: 2px solid rgba(99, 102, 241, 0.3);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
}

.grammar-blabber-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #718096;
}

.grammar-blabber-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #a0aec0;
}

.grammar-blabber-status.active .status-dot {
  background: #6366f1;
  animation: pulse 2s infinite;
}

.grammar-blabber-status.completed .status-dot {
  background: #10b981;
}

/* Day Indicator */
.grammar-day-indicator {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px 20px;
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  margin: 0 20px;
  border-radius: 12px;
}

.day-badge {
  padding: 8px 16px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border-radius: 20px;
  font-weight: 700;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.day-activity-type {
  color: #4338ca;
  font-weight: 600;
  font-size: 15px;
}

/* Grammar Loading */
.grammar-loading {
  text-align: center;
  padding: 40px 20px;
  color: #718096;
}

/* Grammar Activity Cards */
.grammar-activity-card {
  margin: 20px;
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border: 1px solid #e2e8f0;
}

.grammar-activity-header {
  padding: 20px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
}

.grammar-activity-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 5px;
}

.grammar-activity-subtitle {
  font-size: 13px;
  opacity: 0.9;
}

.grammar-activity-body {
  padding: 20px;
}

.grammar-activity-description {
  color: #4a5568;
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 20px;
}

.grammar-example-box {
  background: #f8fafc;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.grammar-example-label {
  font-size: 12px;
  color: #718096;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.grammar-example-korean {
  font-size: 18px;
  color: #1a202c;
  margin-bottom: 5px;
}

.grammar-example-english {
  font-size: 14px;
  color: #718096;
}

.grammar-prompts-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.grammar-prompt-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px;
  background: #f8fafc;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  transition: all 0.2s;
}

.grammar-prompt-item:hover {
  border-color: #6366f1;
  background: #eef2ff;
}

.grammar-prompt-item.completed {
  background: #ecfdf5;
  border-color: #10b981;
}

.grammar-prompt-item.completed .prompt-status {
  color: #10b981;
}

.prompt-text {
  flex: 1;
  font-size: 15px;
  color: #2d3748;
}

.prompt-status {
  font-size: 20px;
}

.grammar-start-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.grammar-start-btn:hover {
  transform: scale(1.05);
}

/* Grammar Modal */
.grammar-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.grammar-modal-content {
  background: white;
  border-radius: 20px;
  max-width: 550px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

.grammar-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  border-radius: 20px 20px 0 0;
}

.grammar-modal-header h3 {
  margin: 0;
  color: #3730a3;
  font-size: 18px;
}

.grammar-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.1);
  cursor: pointer;
  font-size: 18px;
}

.grammar-modal-body {
  padding: 20px;
}

/* Prompt Section */
.grammar-prompt-section {
  background: linear-gradient(135deg, #f8fafc, #eef2ff);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
}

.grammar-prompt-label {
  font-size: 12px;
  color: #6366f1;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}

.grammar-prompt-text {
  font-size: 20px;
  color: #1a202c;
  font-weight: 600;
  margin-bottom: 10px;
}

.grammar-prompt-hint {
  font-size: 14px;
  color: #718096;
  font-style: italic;
}

/* Recording Area */
.grammar-record-area {
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.grammar-audio-visualizer {
  display: flex;
  align-items: center;
  gap: 4px;
  height: 50px;
}

.grammar-audio-visualizer .audio-wave {
  width: 6px;
  height: 25px;
  background: #6366f1;
  border-radius: 3px;
}

.grammar-audio-visualizer.recording .audio-wave {
  animation: wave 0.5s ease-in-out infinite;
}

.grammar-audio-visualizer .audio-wave:nth-child(2) { animation-delay: 0.1s; }
.grammar-audio-visualizer .audio-wave:nth-child(3) { animation-delay: 0.2s; }
.grammar-audio-visualizer .audio-wave:nth-child(4) { animation-delay: 0.3s; }
.grammar-audio-visualizer .audio-wave:nth-child(5) { animation-delay: 0.4s; }

.grammar-record-timer {
  font-size: 24px;
  font-weight: 700;
  color: #4338ca;
}

.grammar-record-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

.grammar-record-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 28px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

.grammar-stop-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 28px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

/* Transcription */
.grammar-transcription-box {
  background: #f8fafc;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
}

.grammar-transcription-box label {
  font-size: 13px;
  color: #718096;
  display: block;
  margin-bottom: 8px;
}

.grammar-transcription-text {
  font-size: 18px;
  color: #1a202c;
  line-height: 1.5;
}

/* Feedback */
.grammar-feedback-box {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border: 1px solid #86efac;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.grammar-feedback-loading {
  text-align: center;
  color: #166534;
}

.grammar-feedback-result {
  color: #166534;
  line-height: 1.6;
}

.grammar-feedback-error {
  color: #dc2626;
}

.grammar-feedback-correct {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #166534;
  font-weight: 600;
}

.grammar-feedback-correction {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #86efac;
}

.grammar-action-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.grammar-submit-btn {
  padding: 12px 30px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.grammar-submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Completed responses */
.grammar-responses-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #e2e8f0;
}

.grammar-responses-title {
  font-size: 14px;
  color: #718096;
  margin-bottom: 15px;
}

.grammar-response-item {
  display: flex;
  gap: 12px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  margin-bottom: 10px;
}

.grammar-response-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 14px;
  flex-shrink: 0;
}

.grammar-response-content {
  flex: 1;
}

.grammar-response-name {
  font-weight: 600;
  font-size: 13px;
  color: #1a202c;
}

.grammar-response-text {
  font-size: 15px;
  color: #4a5568;
  margin-top: 3px;
}

.grammar-response-audio {
  margin-top: 8px;
}

.grammar-response-audio audio {
  width: 100%;
  height: 32px;
}

.teamwork-translation-tooltip {
  position: absolute;
  bottom: calc(100% + 5px);
  left: 0;
  background: #1a202c;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
  z-index: 10;
}

.teamwork-korean-text:hover .teamwork-translation-tooltip {
  opacity: 1;
  visibility: visible;
}

/* Response Button in Thread */
.teamwork-response-prompt {
  text-align: center;
  padding: 20px;
  background: linear-gradient(135deg, #ebf8ff, #e6fffa);
  border-radius: 12px;
  border: 2px dashed #38b2ac;
}

.teamwork-response-prompt p {
  color: #234e52;
  margin-bottom: 15px;
  font-size: 14px;
}

/* Modal Styles */
.teamwork-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.85);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.teamwork-modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  border-radius: 20px;
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.teamwork-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.teamwork-modal-header h3 {
  color: white;
  margin: 0;
  font-size: 20px;
}

.teamwork-close-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  transition: background 0.2s;
}

.teamwork-close-btn:hover {
  background: rgba(255,255,255,0.2);
}

.teamwork-modal-body {
  padding: 25px;
}

.teamwork-instructions {
  background: rgba(102, 126, 234, 0.2);
  border: 1px solid rgba(102, 126, 234, 0.3);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}

.teamwork-instructions p {
  color: #a0aec0;
  margin: 0;
  font-size: 14px;
}

/* Video/Audio Preview Area */
.teamwork-preview-area {
  position: relative;
  background: #0f0f1a;
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
  min-height: 250px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.teamwork-preview-area video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  max-height: 300px;
}

#teamworkAudioVisualizer {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  height: 100px;
}

#teamworkAudioVisualizer .audio-wave {
  width: 8px;
  height: 30px;
  background: linear-gradient(135deg, #48bb78, #38a169);
  border-radius: 4px;
  animation: audioWave 0.5s ease-in-out infinite alternate;
}

#teamworkAudioVisualizer .audio-wave:nth-child(2) { animation-delay: 0.1s; height: 50px; }
#teamworkAudioVisualizer .audio-wave:nth-child(3) { animation-delay: 0.2s; height: 70px; }
#teamworkAudioVisualizer .audio-wave:nth-child(4) { animation-delay: 0.3s; height: 50px; }
#teamworkAudioVisualizer .audio-wave:nth-child(5) { animation-delay: 0.4s; height: 30px; }

@keyframes audioWave {
  from { transform: scaleY(0.5); }
  to { transform: scaleY(1.5); }
}

.recording-timer {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(245, 101, 101, 0.9);
  color: white;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  display: none;
}

.recording-timer.active {
  display: block;
  animation: timerPulse 1s infinite;
}

@keyframes timerPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Recording Controls */
.teamwork-controls {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.teamwork-record-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 15px 35px;
  background: linear-gradient(135deg, #f56565, #e53e3e);
  color: white;
  border: none;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.teamwork-record-btn:hover {
  transform: scale(1.05);
}

.teamwork-record-btn.recording {
  background: linear-gradient(135deg, #48bb78, #38a169);
  animation: recordingPulse 1s infinite;
}

@keyframes recordingPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.4); }
  50% { box-shadow: 0 0 0 15px rgba(72, 187, 120, 0); }
}

.record-icon {
  font-size: 20px;
}

/* Transcription & Correction Section */
.teamwork-transcription-box,
.teamwork-correction-box {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
}

.teamwork-transcription-box label,
.teamwork-correction-box label {
  display: block;
  color: #a0aec0;
  font-size: 13px;
  margin-bottom: 10px;
  font-weight: 600;
}

.transcription-display,
.correction-display {
  color: white;
  font-size: 16px;
  line-height: 1.6;
  min-height: 50px;
}

.correction-display {
  color: #68d391;
}

.correction-loading {
  color: #a0aec0;
  font-style: italic;
}

.correction-item {
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.correction-item:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.correction-original {
  color: #f56565;
  text-decoration: line-through;
  margin-right: 10px;
}

.correction-fixed {
  color: #48bb78;
  font-weight: 600;
}

.correction-explanation {
  color: #a0aec0;
  font-size: 13px;
  margin-top: 5px;
}

.correction-suggestion {
  background: rgba(102, 126, 234, 0.2);
  border-left: 3px solid #667eea;
  padding: 10px;
  margin-top: 10px;
  border-radius: 0 8px 8px 0;
}

.correction-suggestion-label {
  color: #667eea;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 5px;
}

/* Action Buttons */
.teamwork-action-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.teamwork-submit-btn {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
  padding: 15px 40px !important;
}

.teamwork-submit-btn:disabled {
  background: #4a5568 !important;
  cursor: not-allowed;
  opacity: 0.6;
}

/* Preview in Waiting/Respond States */
.teamwork-preview {
  background: #f7fafc;
  border-radius: 12px;
  padding: 15px;
  margin: 15px auto;
  max-width: 400px;
  text-align: left;
}

/* Light Mode Adjustments */
body.light-mode .teamwork-entry {
  background: white;
}

body.light-mode .teamwork-empty-state h4,
body.light-mode .teamwork-waiting-state h4,
body.light-mode .teamwork-respond-state h4 {
  color: #1a202c;
}

/* MOBILE COMPLETE */
/* ===========================================================================
   KOREALAND MOBILE NAVIGATION - COMPLETE CLEAN VERSION
   =========================================================================== */

/* ----- MOBILE BOTTOM NAV ----- */
.mobile-bottom-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
  border-top: 3px solid #41c0ff;
  z-index: 99999;
  padding: 0;
  padding-bottom: env(safe-area-inset-bottom, 0);
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px 5px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  background: transparent;
  border: none;
  -webkit-tap-highlight-color: transparent;
}

.mobile-nav-item:active { transform: scale(0.92); }

.mobile-nav-item.active { background: rgba(65, 192, 255, 0.15); }

.mobile-nav-item.active::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 3px;
  background: #41c0ff;
  border-radius: 0 0 3px 3px;
}

.mobile-nav-icon {
  font-size: 24px;
  margin-bottom: 4px;
  filter: drop-shadow(0 0 8px rgba(65, 192, 255, 0.3));
}

.mobile-nav-item.active .mobile-nav-icon {
  transform: scale(1.15);
  filter: drop-shadow(0 0 12px rgba(65, 192, 255, 0.6));
}

.mobile-nav-label {
  font-family: 'Press Start 2P', cursive;
  font-size: 7px;
  color: rgba(255, 255, 255, 0.7);
  text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
  text-transform: uppercase;
}

.mobile-nav-item.active .mobile-nav-label {
  color: #41c0ff;
}

.mobile-nav-badge {
  position: absolute;
  top: 5px;
  right: calc(50% - 20px);
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
  color: white;
  font-family: 'Noto Sans', sans-serif;
  font-size: 10px;
  font-weight: bold;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 5px;
}

/* ----- MOBILE GAMES/DRILLS MENU POPUP ----- */
.mobile-games-menu {
  display: none;
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
  border: 3px solid #41c0ff;
  border-radius: 20px;
  padding: 15px;
  z-index: 99998;
  min-width: 250px;
  box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
}

.mobile-games-menu.active { display: block; }

.mobile-games-menu-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  color: #41c0ff;
  text-align: center;
  margin-bottom: 15px;
}

.mobile-games-menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(65, 192, 255, 0.2);
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.mobile-games-menu-item:last-child { margin-bottom: 0; }

.mobile-games-menu-item:active {
  background: rgba(65, 192, 255, 0.15);
  border-color: #41c0ff;
}

.mobile-games-menu-item .menu-icon { font-size: 24px; }

.mobile-games-menu-item .menu-text {
  font-family: 'Noto Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: white;
}

.mobile-menu-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99997;
}

.mobile-menu-overlay.active { display: block; }

/* ----- MOBILE TOP HEADER ----- */
.mobile-app-header {
  display: none;
  position: sticky;
  top: 0;
  z-index: 1000;
  background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
  border-bottom: 3px solid #41c0ff;
  padding: 12px 15px;
  align-items: center;
  justify-content: center;
}

.mobile-app-header-logo { height: 50px; width: auto; }

.mobile-app-header-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 14px;
  color: white;
  text-shadow: -2px -2px 0 #41c0ff, 2px -2px 0 #41c0ff, -2px 2px 0 #41c0ff, 2px 2px 0 #41c0ff;
  margin-left: 10px;
}

/* ----- MOBILE PROFILE OVERLAY ----- */
.mobile-profile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1e1e3a 0%, #151528 100%);
  z-index: 99996;
  overflow-y: auto;
  padding: 20px;
  padding-bottom: 90px;
}

.mobile-profile-overlay.active { display: block; }

/* Light mode for mobile profile */
body.light-mode .mobile-profile-overlay {
  background: linear-gradient(180deg, #e8f4ff 0%, #d0e8ff 100%);
}

body.light-mode .mobile-profile-section {
  background: rgba(0,0,0,0.05);
  border-color: rgba(0,0,0,0.1);
}

body.light-mode .mobile-section-title {
  color: #1a202c;
}

body.light-mode .mobile-profile-name {
  color: #1a202c;
}

body.light-mode .mobile-streak-section {
  background: linear-gradient(135deg, rgba(255,107,107,0.2) 0%, rgba(255,107,107,0.1) 100%) !important;
}

body.light-mode .mobile-stat-card {
  background: rgba(255,255,255,0.7);
  border-color: rgba(0,0,0,0.1);
}

body.light-mode .mobile-stat-card .stat-label {
  color: rgba(0,0,0,0.6);
}

body.light-mode .mobile-goals-tracker,
body.light-mode .mobile-calendar-container {
  background: rgba(255,255,255,0.5);
}

body.light-mode .mobile-goals-header,
body.light-mode .mobile-goals-text {
  color: #1a202c;
}

body.light-mode .mobile-calendar-month {
  color: #1a202c;
}

body.light-mode .mobile-calendar-day {
  background: rgba(0,0,0,0.05);
  color: #4a5568;
}

body.light-mode .mobile-schedule-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-schedule-item .day {
  color: #1a202c;
}

body.light-mode .mobile-activity-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-activity-text {
  color: #1a202c;
}

body.light-mode .mobile-opt-toggle,
body.light-mode .mobile-dark-mode-row {
  background: rgba(255,255,255,0.7);
  color: #1a202c;
}

body.light-mode .mobile-settings-btn {
  background: rgba(255,255,255,0.7);
  border-color: rgba(0,0,0,0.2);
  color: #1a202c;
}

body.light-mode .mobile-edit-field label {
  color: #4a5568;
}

body.light-mode .mobile-edit-field input,
body.light-mode .mobile-edit-field textarea,
body.light-mode .mobile-edit-field select {
  background: rgba(255,255,255,0.9);
  border-color: rgba(0,0,0,0.2);
  color: #1a202c;
}

body.light-mode .mobile-badge-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-badge-name {
  color: #1a202c;
}

.mobile-profile-header { text-align: center; margin-bottom: 25px; padding-top: 20px; }

.mobile-profile-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #41c0ff, #ff6b9d);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 50px;
  margin: 0 auto 15px;
  border: 3px solid #ffd700;
}

.mobile-profile-name {
  font-family: 'Press Start 2P', cursive;
  font-size: 12px;
  color: white;
  margin-bottom: 5px;
}

.mobile-profile-email {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
}

.mobile-profile-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 25px;
}

.mobile-profile-stat {
  background: linear-gradient(180deg, #2a2a4a 0%, #222240 100%);
  border: 1px solid #3a3a5a;
  border-radius: 12px;
  padding: 15px;
  text-align: center;
}

.mobile-profile-stat .stat-value {
  font-family: 'Press Start 2P', cursive;
  font-size: 16px;
  color: #41c0ff;
  margin-bottom: 5px;
}

.mobile-profile-stat .stat-label {
  font-size: 10px;
  color: rgba(255, 255, 255, 0.7);
}

.mobile-profile-stat.coins .stat-value { color: #ffd700; }
.mobile-profile-stat.streak .stat-value { color: #ff6b6b; }

.mobile-profile-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.mobile-profile-action-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px 20px;
  background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
  border: 1px solid #3a3a5a;
  border-radius: 12px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.mobile-profile-logout {
  padding: 15px;
  background: linear-gradient(135deg, #f56565, #e53e3e);
  border: none;
  border-radius: 12px;
  color: white;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  width: 100%;
  cursor: pointer;
}

/* ----- FLASHCARD GAMES SEARCH ----- */
.fc-games-search-container {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  padding: 15px;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  border-radius: 12px;
  border: 1px solid rgba(102, 126, 234, 0.2);
}

.fc-games-search-input {
  flex: 1;
  min-width: 200px;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
  background: white;
}

.fc-games-search-input:focus {
  outline: none;
  border-color: #667eea;
}

.fc-go-to-my-cards-btn {
  padding: 12px 20px;
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
}

/* ===========================================================================
   MEDIA QUERIES
   =========================================================================== */

@media screen and (max-width: 768px) {
  /* Show mobile header */
  .mobile-app-header { display: flex !important; }

  /* Show bottom nav when logged in */
  body.mobile-logged-in .mobile-bottom-nav {
    display: flex !important;
  }

  /* Hide desktop elements */
  .dashboard-header { display: none !important; }
  .sidebar { display: none !important; }
  .floating-profile-btn { display: none !important; }
  .profile-slideout-panel { display: none !important; }

  /* Hide profile close button */
  .mobile-profile-close { display: none !important; }

  /* Adjust main content */
  .main-content-area {
    padding: 15px !important;
    padding-bottom: 90px !important;
    width: 100% !important;
  }

  /* My Flashcards - stack vertically */
  #myFlashcards > div:nth-child(3) {
    grid-template-columns: 1fr !important;
  }

  #myCardsGrid {
    grid-template-columns: 1fr !important;
    max-height: none !important;
  }

  /* Flashcard Games grids */
  #folderContentsGrid,
  #availableFlashcards {
    grid-template-columns: repeat(2, 1fr) !important;
  }

  /* Search container mobile */
  .fc-games-search-container {
    flex-direction: column;
  }

  .fc-games-search-input,
  .fc-go-to-my-cards-btn {
    width: 100%;
  }

  /* Teamwork - hide empty containers */
  #teamworkWaiting > div,
  #teamworkRespond > div {
    grid-template-columns: 1fr !important;
  }

  #teamworkMyQuestionCard:empty,
  #teamworkQuestionCard:empty,
  .teamwork-card-empty {
    display: none !important;
  }

  /* ===== FLASHCARD GAME MOBILE FIXES ===== */

  /* Junbi page mobile - simple scrollable layout */
  /* Note: display is controlled by JS, don't override here */
  #junbiPage.junbi-overlay[style*="display: flex"],
  #junbiPage.junbi-overlay[style*="display:flex"] {
    padding: 0 !important;
    padding-bottom: 80px !important;
    box-sizing: border-box !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
  }

  #junbiPage .junbi-container {
    padding: 15px 10px !important;
    padding-top: 60px !important;
    height: auto !important;
    max-height: none !important;
    min-height: auto !important;
    overflow: visible !important;
    display: flex !important;
    flex-direction: column !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* X button must be visible */
  #junbiPage > button:first-child {
    position: fixed !important;
    top: 15px !important;
    right: 15px !important;
    z-index: 10001 !important;
    width: 40px !important;
    height: 40px !important;
  }

  #junbiPage .junbi-title {
    font-size: 24px !important;
    margin: 5px 0 !important;
  }

  #junbiPage .junbi-subtitle {
    font-size: 11px !important;
    margin-bottom: 8px !important;
  }

  #junbiPage .wrinkled-paper,
  #junbiPage #junbiPaper {
    max-height: 45vh !important;
    overflow-y: auto !important;
    margin-bottom: 10px !important;
    flex: none !important;
  }

  #junbiPage #flashcardModeToggle,
  #junbiPage #flashcardWalkAwayToggle {
    margin: 8px 0 !important;
    padding: 8px 10px !important;
  }

  #junbiPage #flashcardModeToggle button,
  #junbiPage #flashcardWalkAwayToggle button {
    font-size: 11px !important;
    padding: 5px 10px !important;
  }

  #junbiPage #flashcardModeToggle p,
  #junbiPage #flashcardWalkAwayToggle p {
    font-size: 9px !important;
    margin: 2px 0 0 0 !important;
  }

  #junbiPage #englishVoiceSelector {
    font-size: 10px !important;
    min-width: 100px !important;
  }

  #junbiPage .junbi-controls {
    margin-top: 10px !important;
    margin-bottom: 15px !important;
    flex-direction: row !important;
    gap: 10px !important;
    width: 100% !important;
  }

  #junbiPage .junbi-btn {
    padding: 12px 16px !important;
    font-size: 14px !important;
    flex: 1 !important;
  }

  /* ===== MASTERY DECK, CALENDAR, SRS STATS MOBILE FIXES ===== */

  /* Mastery Deck Tab Mobile */
  #masteryDeck {
    padding: 15px !important;
    padding-bottom: 80px !important;
  }

  #masteryDeck h2 {
    font-size: 22px !important;
    margin-bottom: 10px !important;
  }

  #masteryDeck > p {
    font-size: 13px !important;
    margin-bottom: 15px !important;
  }

  #masteryDeckContainer .mastery-deck-card {
    padding: 15px !important;
    margin-bottom: 12px !important;
  }

  #masteryDeckContainer .mastery-deck-title {
    font-size: 16px !important;
  }

  #masteryPracticeInterface .game-container {
    padding: 15px !important;
  }

  /* Calendar Tab Mobile (leitnerBoxes) */
  #leitnerBoxes {
    padding: 15px !important;
    padding-bottom: 80px !important;
    overflow-x: hidden !important;
  }

  #leitnerBoxes h2 {
    font-size: 22px !important;
    margin-bottom: 10px !important;
  }

  #leitnerBoxes > p {
    font-size: 13px !important;
  }

  /* Fix leitner box grid overflow on mobile */
  #leitnerBoxes .leitner-box-grid,
  #leitnerBoxGrid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 10px !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  #leitnerBoxes .leitner-box-card,
  #leitnerBoxGrid .leitner-box-card {
    padding: 12px 8px !important;
    min-width: 0 !important;
    overflow: visible !important;
  }

  #leitnerBoxes .leitner-box-card .box-label,
  #leitnerBoxGrid .leitner-box-card .box-label {
    font-size: 11px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

  #leitnerBoxes .leitner-box-card .box-count,
  #leitnerBoxGrid .leitner-box-card .box-count {
    font-size: 24px !important;
  }

  #leitnerBoxes .leitner-box-card .box-due,
  #leitnerBoxGrid .leitner-box-card .box-due {
    font-size: 10px !important;
  }

  #leitnerBoxes .leitner-box-card .btn,
  #leitnerBoxGrid .leitner-box-card .btn {
    padding: 6px 10px !important;
    font-size: 11px !important;
  }

  #leitnerCalendarContainer {
    overflow-x: auto !important;
  }

  #leitnerCalendarContainer .calendar-day {
    min-width: 40px !important;
    font-size: 11px !important;
  }

  /* Marketplace Mobile Navigation */
  #mobileMarketplaceNav {
    display: flex !important;
  }

  #mobileCategoriesBack,
  #mobilePurchasesBack {
    display: block !important;
  }

  /* Marketplace mobile styling */
  #marketplacePopular,
  #marketplaceCategories,
  #myPurchases {
    padding-bottom: 80px !important;
  }

  #marketplaceCategories .category-card {
    padding: 20px !important;
  }

  #marketplaceCategories .category-card div:first-child {
    font-size: 36px !important;
  }

  /* Analytics Mobile Buttons */
  #mobileGrammarDrillAnalytics,
  #mobilePronunciationAnalytics,
  #mobileGrammarEvalAnalytics,
  #mobileAnalyticsBack,
  #mobileAnalytics2Back,
  #mobileGrammarAnalyticsBack,
  #mobileAvailableTestsBack {
    display: block !important;
  }

  #mobileGrammarDrillsNav {
    display: flex !important;
  }

  /* Analytics pages mobile styling */
  #analytics,
  #analytics2,
  #grammarAnalytics,
  #availableGrammarTests {
    padding-bottom: 80px !important;
  }

  /* SRS Stats Tab Mobile */
  #leitnerStats {
    padding: 15px !important;
    padding-bottom: 80px !important;
  }

  #leitnerStats h2 {
    font-size: 22px !important;
    margin-bottom: 10px !important;
  }

  #leitnerStats > p {
    font-size: 13px !important;
  }

  #leitnerStats h3 {
    font-size: 16px !important;
    margin-top: 20px !important;
    margin-bottom: 12px !important;
  }

  .leitner-dashboard-grid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }

  .leitner-stat-card {
    padding: 15px !important;
  }

  .leitner-stat-card h4 {
    font-size: 12px !important;
  }

  .leitner-stat-card .stat-value {
    font-size: 28px !important;
  }

  .leitner-stat-card .stat-label {
    font-size: 11px !important;
  }

  /* Game interface mobile */
  #flashcardGameInterface.junbi-overlay {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 10px !important;
    box-sizing: border-box !important;
  }

  #flashcardGameInterface .junbi-container {
    padding-top: 60px !important;
    justify-content: flex-start !important;
  }

  #flashcardGameInterface .junbi-title {
    font-size: 20px !important;
    margin-bottom: 6px !important;
  }

  #flashcardGameInterface .junbi-subtitle {
    font-size: 11px !important;
    margin-bottom: 6px !important;
  }

  #flashcardGameInterface .wrinkled-paper {
    padding: 12px !important;
    max-height: none !important;
    flex: none !important;
    overflow: visible !important;
  }

  #junbiPaper {
    max-height: 40vh !important;
    overflow-y: auto !important;
  }

  .word-list-table th,
  .word-list-table td {
    padding: 6px 8px !important;
    font-size: 13px !important;
  }

  .word-list-table .korean-col {
    font-size: 15px !important;
  }

  #flashcardGameInterface .junbi-controls {
    flex-direction: column !important;
    gap: 10px !important;
    width: 100% !important;
    margin-top: 15px !important;
  }

  #flashcardGameInterface .junbi-btn {
    width: 100% !important;
    padding: 14px 20px !important;
    font-size: 15px !important;
    justify-content: center !important;
  }

  #flashcardGameInterface #flashcardWalkAwayToggle {
    margin: 10px 0 !important;
    padding: 10px !important;
  }

  #flashcardGameInterface #flashcardWalkAwayToggle button {
    font-size: 13px !important;
    padding: 8px 16px !important;
  }

  /* Game interface mobile - word list sizing */
  #flashcardGameInterface .wrinkled-paper {
    min-height: auto !important;
  }

  #wordsList {
    max-height: none !important;
    overflow-y: visible !important;
  }

  #wordsList .word-item {
    padding: 8px 10px !important;
  }

  #gameResults .wrinkled-paper {
    padding: 15px !important;
  }

  #gameResults .wrinkled-paper h3 {
    font-size: 16px !important;
  }

  /* Exit button mobile positioning */
  #junbiPage > button:first-child,
  #flashcardGameInterface > button:first-child {
    top: 10px !important;
    right: 10px !important;
    width: 40px !important;
    height: 40px !important;
    font-size: 18px !important;
  }

  /* Voice section mobile */
  #wordTimer {
    font-size: 28px !important;
  }

  #voiceStatus {
    padding: 6px !important;
  }

  #recognizedText {
    font-size: 14px !important;
  }

  /* ===== DAY 1 POWER PRACTICE MOBILE FIX ===== */
  #day1IntervalsSection {
    margin-bottom: 15px !important;
  }
  
  #day1IntervalsSection > div {
    padding: 12px !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
  }
  
  #day1IntervalsGrid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  #day1IntervalsGrid > div {
    padding: 8px !important;
    font-size: 11px !important;
    min-width: 0 !important;
    word-break: break-word !important;
  }
  
  #day1IntervalsGrid .btn {
    padding: 6px 10px !important;
    font-size: 11px !important;
    white-space: nowrap !important;
  }

  /* ===== FLASHCARD GAME START IMAGE CENTERING ===== */
  .game-start-image {
    display: block !important;
    margin-left: auto !important;
    margin-right: auto !important;
    max-width: 90% !important;
    max-height: 200px !important;
  }
  
  .game-start-screen {
    text-align: center !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 20px !important;
  }

  /* ===== REVIEW PAGE MOVE SELECTED FIX ===== */
  #reviewBulkActions {
    padding: 12px !important;
  }
  
  .review-bulk-actions-container {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 12px !important;
  }
  
  .review-bulk-select {
    width: 100% !important;
    justify-content: flex-start !important;
  }
  
  .review-bulk-move {
    width: 100% !important;
    flex-direction: row !important;
    gap: 8px !important;
  }
  
  #folderReviewPage #reviewMoveToFolder {
    flex: 1 !important;
    min-width: 0 !important;
    max-width: none !important;
  }
  
  #folderReviewPage button[onclick="bulkMoveReviewCards()"] {
    white-space: nowrap !important;
    flex-shrink: 0 !important;
    padding: 8px 12px !important;
  }
  
  /* Review table mobile */
  #reviewTable {
    font-size: 12px !important;
  }
  
  #reviewTable th,
  #reviewTable td {
    padding: 8px 6px !important;
  }
  
  #reviewTable th:first-child,
  #reviewTable td:first-child {
    width: 35px !important;
    padding: 8px 4px !important;
  }
  
  #reviewTable th:nth-child(2),
  #reviewTable td:nth-child(2) {
    width: 30px !important;
    padding: 8px 4px !important;
  }
  
  #reviewTable th:last-child,
  #reviewTable td:last-child {
    width: 50px !important;
  }
}

/* ===== EXTRA SMALL SCREENS (320px - 380px) ===== */
@media screen and (max-width: 380px) {
  /* Day 1 Power Practice - single column on tiny screens */
  #day1IntervalsGrid {
    grid-template-columns: 1fr !important;
  }
  
  /* Leitner boxes - single column on tiny screens */
  #leitnerBoxGrid,
  .leitner-box-grid {
    grid-template-columns: 1fr !important;
  }
  
  /* Review controls stack fully */
  #folderReviewPage #reviewMoveToFolder {
    width: 100% !important;
  }
  
  #folderReviewPage button[onclick="bulkMoveReviewCards()"] {
    width: 100% !important;
  }
  
  /* Kpop reactions even smaller */
  .kpop-reaction-btn {
    padding: 4px 6px !important;
    font-size: 12px !important;
  }
  
  .kpop-comment-btn {
    padding: 4px 6px !important;
    font-size: 10px !important;
  }
  
  /* Game start image smaller */
  .game-start-image {
    max-height: 150px !important;
  }

  /* Flashcard game - compact for very small phones */
  #flashcardGameInterface .junbi-container {
    padding-top: 55px !important;
  }

  #flashcardGameInterface .junbi-title {
    font-size: 18px !important;
  }

  #wordsList .word-item {
    padding: 6px 8px !important;
  }
}

@media screen and (min-width: 769px) {
  .mobile-app-header,
  .mobile-bottom-nav,
  .mobile-games-menu,
  .mobile-menu-overlay,
  .mobile-profile-overlay {
    display: none !important;
  }
}

/* ===========================================================================
   MOBILE PROFILE - COMPLETE STYLES (Matches Desktop)
   =========================================================================== */

.mobile-profile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
  z-index: 99996;
  overflow-y: auto;
  padding: 15px;
  padding-bottom: 100px;
}

.mobile-profile-overlay.active { display: block; }

/* Light mode for mobile profile */
body.light-mode .mobile-profile-overlay {
  background: linear-gradient(180deg, #e8f4ff 0%, #d0e8ff 100%);
}

body.light-mode .mobile-profile-section {
  background: rgba(0,0,0,0.05);
  border-color: rgba(0,0,0,0.1);
}

body.light-mode .mobile-section-title {
  color: #1a202c;
}

body.light-mode .mobile-profile-name {
  color: #1a202c;
}

body.light-mode .mobile-streak-section {
  background: linear-gradient(135deg, rgba(255,107,107,0.2) 0%, rgba(255,107,107,0.1) 100%) !important;
}

body.light-mode .mobile-stat-card {
  background: rgba(255,255,255,0.7);
  border-color: rgba(0,0,0,0.1);
}

body.light-mode .mobile-stat-card .stat-label {
  color: rgba(0,0,0,0.6);
}

body.light-mode .mobile-goals-tracker,
body.light-mode .mobile-calendar-container {
  background: rgba(255,255,255,0.5);
}

body.light-mode .mobile-goals-header,
body.light-mode .mobile-goals-text {
  color: #1a202c;
}

body.light-mode .mobile-calendar-month {
  color: #1a202c;
}

body.light-mode .mobile-calendar-day {
  background: rgba(0,0,0,0.05);
  color: #4a5568;
}

body.light-mode .mobile-schedule-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-schedule-item .day {
  color: #1a202c;
}

body.light-mode .mobile-activity-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-activity-text {
  color: #1a202c;
}

body.light-mode .mobile-opt-toggle,
body.light-mode .mobile-dark-mode-row {
  background: rgba(255,255,255,0.7);
  color: #1a202c;
}

body.light-mode .mobile-settings-btn {
  background: rgba(255,255,255,0.7);
  border-color: rgba(0,0,0,0.2);
  color: #1a202c;
}

body.light-mode .mobile-edit-field label {
  color: #4a5568;
}

body.light-mode .mobile-edit-field input,
body.light-mode .mobile-edit-field textarea,
body.light-mode .mobile-edit-field select {
  background: rgba(255,255,255,0.9);
  border-color: rgba(0,0,0,0.2);
  color: #1a202c;
}

body.light-mode .mobile-badge-item {
  background: rgba(255,255,255,0.7);
}

body.light-mode .mobile-badge-name {
  color: #1a202c;
}

/* Header */
.mobile-profile-header {
  text-align: center;
  padding: 15px 0 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 15px;
}

.mobile-profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 10px;
  border: 3px solid #ffd700;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.mobile-profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.mobile-avatar-edit {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.7);
  color: white;
  font-size: 12px;
  padding: 3px 0;
  opacity: 0;
  transition: opacity 0.2s;
}

.mobile-profile-avatar:active .mobile-avatar-edit {
  opacity: 1;
}

.mobile-profile-name {
  font-family: 'Press Start 2P', cursive;
  font-size: 12px;
  color: white;
  margin-bottom: 10px;
}

.mobile-profile-coins-display {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,193,7,0.2) 100%);
  border: 2px solid #ffd700;
  border-radius: 20px;
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
}

/* Sections */
.mobile-profile-section {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 12px;
  border: 1px solid rgba(255,255,255,0.1);
}

.mobile-section-title {
  font-size: 14px;
  font-weight: 700;
  color: white;
  margin-bottom: 12px;
}

.mobile-section-subtitle {
  font-size: 10px;
  color: rgba(255,255,255,0.5);
  font-weight: normal;
}

/* Streak Section */
.mobile-streak-section {
  text-align: center;
  background: linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,107,107,0.05) 100%) !important;
  border-color: rgba(255,107,107,0.3) !important;
}

.mobile-streak-number {
  font-family: 'Press Start 2P', cursive;
  font-size: 24px;
  color: #ff6b6b;
}

.mobile-streak-label {
  font-size: 12px;
  color: rgba(255,255,255,0.7);
  margin-top: 5px;
}

/* Stats Grid */
.mobile-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.mobile-stat-card {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  padding: 12px 8px;
  text-align: center;
  border: 1px solid rgba(255,255,255,0.1);
}

.mobile-stat-card .stat-icon { font-size: 20px; margin-bottom: 5px; }
.mobile-stat-card .stat-value { font-family: 'Press Start 2P', cursive; font-size: 14px; color: #41c0ff; margin-bottom: 3px; }
.mobile-stat-card .stat-label { font-size: 9px; color: rgba(255,255,255,0.6); }

/* Goals */
.mobile-goals-tracker {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  padding: 12px;
}

.mobile-goals-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 12px;
  color: rgba(255,255,255,0.8);
}

.mobile-goals-edit-btn {
  padding: 5px 12px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  border-radius: 15px;
  color: white;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}

.mobile-goals-progress-bar {
  height: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 5px;
  overflow: hidden;
  margin-bottom: 8px;
}

.mobile-goals-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #48bb78, #38a169);
  border-radius: 5px;
  transition: width 0.5s ease;
}

.mobile-goals-text {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: rgba(255,255,255,0.7);
}

/* Calendar */
.mobile-calendar-container {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  padding: 12px;
}

.mobile-calendar-month {
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  color: white;
  margin-bottom: 10px;
}

.mobile-calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
  margin-bottom: 12px;
}

.mobile-calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  border-radius: 4px;
  background: rgba(255,255,255,0.05);
  color: rgba(255,255,255,0.5);
  position: relative;
}

.mobile-calendar-day.level-1 { background: rgba(72, 187, 120, 0.3); color: white; }
.mobile-calendar-day.level-2 { background: rgba(72, 187, 120, 0.5); color: white; }
.mobile-calendar-day.level-3 { background: rgba(72, 187, 120, 0.7); color: white; }
.mobile-calendar-day.level-4 { background: rgba(72, 187, 120, 0.9); color: white; }
.mobile-calendar-day.today { border: 2px solid #ffd700; }
.mobile-calendar-day-label {
  font-size: 10px;
  font-weight: bold;
  color: #a0aec0;
  text-align: center;
  padding: 4px 0;
}

/* Calendar character bounce animation */
@keyframes calendarBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

.mobile-calendar-day.empty {
  background: transparent;
}

.mobile-calendar-day.has-class::after {
  content: '';
  position: absolute;
  bottom: -2px;
  right: -2px;
  font-size: 8px;
}

/* Daily Corrections */
.mobile-daily-corrections {
  margin-top: 12px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(246, 135, 179, 0.2), rgba(167, 139, 250, 0.2));
  border-radius: 10px;
  border: 1px solid rgba(246, 135, 179, 0.3);
}

.mobile-dc-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.mobile-dc-title { font-size: 13px; font-weight: 600; color: #f687b3; }
.mobile-dc-subtitle { font-size: 11px; color: #a0aec0; margin-top: 2px; }

.mobile-dc-btn {
  padding: 8px 16px;
  background: linear-gradient(135deg, #f687b3, #a78bfa);
  border: none;
  border-radius: 15px;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}

.mobile-dc-preview {
  margin-top: 8px;
  font-size: 11px;
  color: #cbd5e0;
}

/* Weekly Schedule */
.mobile-weekly-schedule {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.mobile-schedule-title {
  font-size: 11px;
  color: #a0aec0;
  margin-bottom: 8px;
}

.mobile-schedule-item {
  display: flex;
  justify-content: space-between;
  background: rgba(255,255,255,0.05);
  padding: 8px 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 11px;
}

.mobile-schedule-item .day { color: #e2e8f0; font-weight: 500; }
.mobile-schedule-item .class { font-size: 10px; }

/* Calendar Legend */
.mobile-calendar-legend {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  margin-top: 12px;
  font-size: 10px;
  color: rgba(255,255,255,0.5);
}

.mobile-calendar-legend .legend-box {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.legend-box.level-0 { background: rgba(255,255,255,0.1); }
.legend-box.level-1 { background: rgba(72, 187, 120, 0.3); }
.legend-box.level-2 { background: rgba(72, 187, 120, 0.5); }
.legend-box.level-3 { background: rgba(72, 187, 120, 0.7); }
.legend-box.level-4 { background: rgba(72, 187, 120, 0.9); }

/* Badges Grid */
.mobile-badges-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.mobile-badge-item {
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 10px 5px;
  text-align: center;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.mobile-badge-item.earned {
  border-color: #ffd700;
  background: rgba(255,215,0,0.15);
}

.mobile-badge-item.unearned {
  opacity: 0.4;
  filter: grayscale(100%);
}

.mobile-badge-icon { font-size: 24px; margin-bottom: 4px; }
.mobile-badge-name { font-size: 8px; color: rgba(255,255,255,0.8); line-height: 1.2; }

/* Activity Feed */
.mobile-activity-feed {
  max-height: 180px;
  overflow-y: auto;
  margin-bottom: 10px;
}

.mobile-activity-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  margin-bottom: 6px;
}

.mobile-activity-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  overflow: hidden;
}

.mobile-activity-avatar img { width: 100%; height: 100%; object-fit: cover; }

.mobile-activity-content { flex: 1; min-width: 0; }
.mobile-activity-text { font-size: 11px; color: rgba(255,255,255,0.9); }
.mobile-activity-time { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.mobile-activity-empty { text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 12px; }

/* Toggle Switch */
.mobile-opt-toggle, .mobile-dark-mode-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 12px;
  color: rgba(255,255,255,0.8);
}

.mobile-dark-mode-toggle { margin-top: 10px; }

.mobile-toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
}

.mobile-toggle-switch input { opacity: 0; width: 0; height: 0; }

.mobile-toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.2);
  border-radius: 24px;
  transition: 0.3s;
}

.mobile-toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

.mobile-toggle-switch input:checked + .mobile-toggle-slider { background: #48bb78; }
.mobile-toggle-switch input:checked + .mobile-toggle-slider:before { transform: translateX(20px); }

/* Settings */
.mobile-settings-btn {
  width: 100%;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  color: white;
  font-size: 13px;
  cursor: pointer;
  margin-bottom: 10px;
}

/* Dark Mode Row - uses existing .switch class from main CSS */
.mobile-dark-mode-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.05);
  padding: 12px 15px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  color: #e2e8f0;
  font-size: 14px;
}

/* Edit Profile */
.mobile-edit-field {
  margin-bottom: 12px;
}

.mobile-edit-field label {
  display: block;
  font-size: 11px;
  color: #a0aec0;
  margin-bottom: 4px;
}

.mobile-edit-field input,
.mobile-edit-field textarea,
.mobile-edit-field select {
  width: 100%;
  padding: 10px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  font-size: 13px;
  color: white;
}

.mobile-edit-field textarea { resize: none; }

.mobile-edit-field select option { background: #1a1a2e; }

.mobile-save-profile-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* Logout */
.mobile-profile-logout {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #f56565, #e53e3e);
  border: none;
  border-radius: 10px;
  color: white;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  cursor: pointer;
  margin-top: 10px;
}

</style>
</head>
<body>

<div class="mobile-app-header" id="mobileAppHeader">
  <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221" alt="KoreaLand" class="mobile-app-header-logo">
  <span class="mobile-app-header-title">KoreaLand</span>
</div>

<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <button class="mobile-nav-item active" data-tab="home" onclick="toggleMobileHomeMenu()">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label">Home</span>
  </button>
  <button class="mobile-nav-item" data-tab="allInOne" onclick="mobileNavTo('allInOne')">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label"></span>
  </button>
  <button class="mobile-nav-item" data-tab="dailyActivity" onclick="mobileNavTo('dailyActivity')">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label">Daily</span>
  </button>
  <button class="mobile-nav-item" data-tab="games" onclick="toggleMobileGamesMenu()">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label">Games</span>
  </button>
  <button class="mobile-nav-item" data-tab="leaderboard" onclick="mobileNavTo('studentLeaderboard')">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label">Rank</span>
  </button>
  <button class="mobile-nav-item" data-tab="profile" onclick="openMobileProfile()">
    <span class="mobile-nav-icon"></span><span class="mobile-nav-label">Profile</span>
  </button>
</nav>

<div class="mobile-menu-overlay" id="mobileHomeOverlay" onclick="closeMobileHomeMenu()"></div>
<div class="mobile-games-menu" id="mobileHomeMenu">
  <div class="mobile-games-menu-title"> MENU</div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('mobileHome'); closeMobileHomeMenu();"><span class="menu-icon"></span><span class="menu-text">Home</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('dailyActivity'); closeMobileHomeMenu();"><span class="menu-icon"></span><span class="menu-text">Daily Activity</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('grammarDrills'); closeMobileHomeMenu();"><span class="menu-icon"></span><span class="menu-text">Grammar Drill</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('pronunciationDrills'); closeMobileHomeMenu();"><span class="menu-icon"></span><span class="menu-text">Pronunciation</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('grammarDrill'); closeMobileHomeMenu();"><span class="menu-icon"></span><span class="menu-text">Grammar Evaluation</span></div>
</div>

<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileGamesMenu()"></div>
<div class="mobile-games-menu" id="mobileGamesMenu">
  <div class="mobile-games-menu-title"> GAMES</div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('flashcardGames'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">Flashcard Games</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('myFlashcards'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">My Flashcards</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('masteryDeck'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">Mastery Deck</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('leitnerBoxes'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">Calendar</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('leitnerStats'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">SRS Stats</span></div>
  <div class="mobile-games-menu-item" onclick="mobileNavTo('marketplacePopular'); closeMobileGamesMenu();"><span class="menu-icon"></span><span class="menu-text">Marketplace</span></div>
</div>

<div class="mobile-profile-overlay" id="mobileProfileOverlay">

  <div class="mobile-profile-header">
    <div class="mobile-profile-avatar" id="mobileProfileAvatar" onclick="openAvatarUpload()">
      <span id="mobileAvatarContent"></span>
      <div class="mobile-avatar-edit"></div>
    </div>
    <div class="mobile-profile-name" id="mobileProfileName">Student</div>
    <div class="mobile-profile-coins-display">
      <span></span>
      <span id="mobileProfileCoinsHeader">0</span>
    </div>
  </div>

  <div class="mobile-profile-section mobile-streak-section">
    <div class="mobile-streak-number"> <span id="mobileStreakCount">0</span></div>
    <div class="mobile-streak-label">Day Streak</div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Your Stats <span class="mobile-section-subtitle">(This Week)</span></div>
    <div class="mobile-stats-grid">
      <div class="mobile-stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value" id="mobileStatStreak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
      <div class="mobile-stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value" id="mobileStatPronDrills">0</div>
        <div class="stat-label">Pron Drills</div>
      </div>
      <div class="mobile-stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value" id="mobileStatLeitnerReps">0</div>
        <div class="stat-label">Leitner Reps</div>
      </div>
      <div class="mobile-stat-card">
        <div class="stat-icon"></div>
        <div class="stat-value" id="mobileStatRecordingTime">0:00</div>
        <div class="stat-label">Recording Time</div>
      </div>
    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Monthly Goal</div>
    <div class="mobile-goals-tracker">
      <div class="mobile-goals-header">
        <span>Words & Phrases to Master</span>
        <button class="mobile-goals-edit-btn" onclick="openGoalsModal()">Edit Goal</button>
      </div>
      <div class="mobile-goals-progress-bar">
        <div class="mobile-goals-progress-fill" id="mobileGoalsProgressFill" style="width: 0%;"></div>
      </div>
      <div class="mobile-goals-text">
        <span id="mobileGoalsProgressText">0 / 50</span>
        <span id="mobileGoalsPercentText">0%</span>
      </div>
    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Class Schedule</div>
    <div class="mobile-calendar-container">
      <div class="mobile-calendar-month" id="mobileCalendarMonth">January 2026</div>
      <div class="mobile-calendar-grid" id="mobileCalendarGrid">

      </div>

      <div class="mobile-daily-corrections">
        <div class="mobile-dc-header">
          <div>
            <div class="mobile-dc-title"> Daily Corrections</div>
            <div class="mobile-dc-subtitle">View feedback & practice drills</div>
          </div>
          <button class="mobile-dc-btn" onclick="openDailyCorrectionsPage(); closeMobileProfile();">View </button>
        </div>
        <div class="mobile-dc-preview" id="mobileDailyCorrectionsPreview">

        </div>
      </div>

      <div class="mobile-weekly-schedule">
        <div class="mobile-schedule-title"> Weekly Class Schedule</div>
        <div class="mobile-schedule-item">
          <span class="day">Monday</span>
          <span class="class" style="color: #a78bfa;">Sentence Building  8:00 PM EST</span>
        </div>
        <div class="mobile-schedule-item">
          <span class="day">Tuesday</span>
          <span class="class" style="color: #f687b3;">Pronunciation  8:00 PM EST</span>
        </div>
        <div class="mobile-schedule-item">
          <span class="day">Wednesday</span>
          <span class="class" style="color: #68d391;">Vocabulary  8:00 PM EST</span>
        </div>
        <div class="mobile-schedule-item">
          <span class="day">Thursday</span>
          <span class="class" style="color: #fbd38d;">Modal Verb  8:00 PM EST</span>
        </div>
        <div class="mobile-schedule-item">
          <span class="day">Friday</span>
          <span class="class" style="color: #63b3ed;">Listening  8:45 PM EST</span>
        </div>
      </div>

      <div class="mobile-calendar-legend">
        <span>Less</span>
        <div class="legend-box level-0"></div>
        <div class="legend-box level-1"></div>
        <div class="legend-box level-2"></div>
        <div class="legend-box level-3"></div>
        <div class="legend-box level-4"></div>
        <span>More activity</span>
      </div>
    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Achievements</div>
    <div class="mobile-badges-grid" id="mobileBadgesGrid">

    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Recent Activity</div>
    <div class="mobile-activity-feed" id="mobileActivityFeed">

    </div>
    <div class="mobile-opt-toggle">
      <span>Show my activity to others</span>
      <label class="mobile-toggle-switch">
        <input type="checkbox" id="mobileActivityOptIn" checked onchange="toggleMobileActivityOptIn()">
        <span class="mobile-toggle-slider"></span>
      </label>
    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Settings</div>
    <button class="mobile-settings-btn" onclick="openAvatarUpload()">
       Upload Profile Picture
    </button>

    <div class="mobile-dark-mode-row">
      <span> Dark Mode</span>
      <label class="switch" style="margin: 0;">
        <input type="checkbox" id="mobileThemeToggle" checked onchange="toggleLightMode(event)">
        <span class="slider">
          <span class="sun">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f9d71c">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="12" y1="21" x2="12" y2="23" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="1" y1="12" x2="3" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="21" y1="12" x2="23" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
            </svg>
          </span>
          <span class="moon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </span>
        </span>
      </label>
    </div>
  </div>

  <div class="mobile-profile-section">
    <div class="mobile-section-title"> Edit Your Profile</div>

    <div class="mobile-edit-field">
      <label>Display Name</label>
      <input type="text" id="mobileEditDisplayName" placeholder="Your name" maxlength="30">
    </div>

    <div class="mobile-edit-field">
      <label>Bio (short intro)</label>
      <textarea id="mobileEditBio" placeholder="Tell us about yourself..." maxlength="150" rows="2"></textarea>
    </div>

    <div class="mobile-edit-field">
      <label>Korean Level</label>
      <select id="mobileEditKoreanLevel">
        <option value="novice"> Novice - Just starting out</option>
        <option value="beginner"> Beginner - Know the basics</option>
        <option value="intermediate"> Intermediate - Can hold conversations</option>
        <option value="advanced"> Advanced - Near fluent</option>
      </select>
    </div>

    <div class="mobile-edit-field">
      <label>Favorite K-Drama or K-Pop</label>
      <input type="text" id="mobileEditFavoriteKContent" placeholder="e.g., BTS, Squid Game, Blackpink..." maxlength="50">
    </div>

    <button class="mobile-save-profile-btn" onclick="saveMobileProfileEdits()">
       Save Profile
    </button>
  </div>

  <button class="mobile-profile-logout" onclick="mobileLogout()"> Logout</button>

</div>

<div class="theme-toggle-container" id="themeToggleContainer" style="display: none;">
  <label class="switch">
    <input type="checkbox" id="themeToggle" checked onchange="toggleLightMode(event)">
    <span class="slider">
      <span class="sun">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f9d71c">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="12" y1="21" x2="12" y2="23" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="1" y1="12" x2="3" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="21" y1="12" x2="23" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
        </svg>
      </span>
      <span class="moon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </span>
    </span>
  </label>
</div>

<div class="container">

  <div id="authContainer" class="auth-container">

    <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221" alt="KoreaLand Logo" class="auth-logo">
    <div class="auth-title">KoreaLand</div>

    <div id="authMainView" class="auth-view active">
      <div class="auth-main-buttons">
        <button class="retro-btn retro-btn-blue" onclick="showGettingStarted()">Getting Started</button>
        <button class="retro-btn retro-btn-red" onclick="showLoginForm()">Login</button>
      </div>
    </div>

    <div id="authGettingStartedView" class="auth-view">
      <button class="back-btn" onclick="showMainView()"> Back</button>
      <div class="getting-started-message">
        Please reach out on our Discord server to get started!
      </div>
    </div>

    <div id="authLoginView" class="auth-view">
      <button class="back-btn" onclick="showMainView()"> Back</button>
      <form id="authForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required>
        </div>
        <div class="form-group">
          <label for="accountType">Account Type</label>
          <select id="accountType">
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="retro-btn retro-btn-red" style="width: 100%;">Login</button>
      </form>
    </div>
  </div>

  <div id="dashboard" class="dashboard hidden">
    <div class="dashboard-header">
      <h1 id="dashboardTitle">Dashboard</h1>
      <div class="user-info">
        <span id="userEmail"></span>
        <span id="userRole" class="status-badge"></span>
        <button onclick="logout()" class="btn btn-danger">Logout</button>
      </div>
    </div>

    <div id="teacherDashboard" class="hidden">
      <div class="dashboard-with-sidebar">

        <div class="sidebar">

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Daily Activity</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('createDailyPronunciation')"> Create Pronunciation</button>
              <button class="sidebar-item" onclick="switchTab('manageDailyActivities')"> Manage Activities</button>
              <button class="sidebar-item" onclick="switchTab('gradeDailyActivities')"> Grade Submissions</button>
              <button class="sidebar-item" onclick="switchTab('teacherProfile')"> My Profile</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header active" onclick="toggleDropdown(this)">
              <span> Grammar Evaluation</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content open">
              <button class="sidebar-item active" onclick="switchTab('createTest')">Create Test</button>
              <button class="sidebar-item" onclick="switchTab('manageTests')">Manage Tests</button>
              <button class="sidebar-item" onclick="switchTab('gradeStudents')">Grade Students</button>
              <button class="sidebar-item" onclick="switchTab('flashcards')">Flashcards</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Pronunciation Evaluation</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('createTest2')">Create Test2</button>
              <button class="sidebar-item" onclick="switchTab('manageTests2')">Manage Tests2</button>
              <button class="sidebar-item" onclick="switchTab('gradeStudents2')">Grade Students2</button>
              <button class="sidebar-item" onclick="switchTab('drillTracking')"> Drill Tracking</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Grammar Drill</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('createGrammarEval')">Create Grammar Test</button>
              <button class="sidebar-item" onclick="switchTab('manageGrammarEvals')">Manage Tests</button>
              <button class="sidebar-item" onclick="switchTab('gradeGrammarEvals')">Grade Students</button>
              <button class="sidebar-item" onclick="switchTab('grammarDrillTracking')"> Drill Tracking</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Leaderboards</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('leaderboard')">View Leaderboards</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Games</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('createGame')">Create Game</button>
              <button class="sidebar-item" onclick="switchTab('manageGames')">Manage Games</button>
              <button class="sidebar-item" onclick="switchTab('questionBank')">Question Bank</button>
            </div>
          </div>
        </div>

        <div class="main-content-area">

      <div id="createDailyPronunciation" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Create Daily Pronunciation Challenge</span>
        </h2>

        <div class="script-creator-section">
          <h3> Step 1: Generate Script</h3>
          <p style="color: #718096; margin-bottom: 20px;">Enter a topic and AI will generate a 5-10 sentence script with vocabulary keywords.</p>

          <div class="topic-input-row">
            <input type="text" id="dailyScriptTopic" placeholder="Enter topic (e.g., 'Going to the hospital for a foot injury')">
            <button onclick="generateDailyScript()" id="generateScriptBtn">
               Generate Script
            </button>
          </div>

          <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <label style="font-weight: 600; color: #4a5568; margin-right: 10px; display: flex; align-items: center;">Speech Level:</label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; border: 2px solid #667eea; border-radius: 20px; background: #667eea; color: white; font-size: 13px;">
              <input type="radio" name="formalityLevel" value="haeyo" checked style="display: none;">
               (Polite)
            </label>
            <label id="seyoLabel" style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; border: 2px solid #e2e8f0; border-radius: 20px; font-size: 13px; color: #4a5568;">
              <input type="radio" name="formalityLevel" value="seyo" style="display: none;">
               (Formal)
            </label>
            <label id="banmalLabel" style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 15px; border: 2px solid #e2e8f0; border-radius: 20px; font-size: 13px; color: #4a5568;">
              <input type="radio" name="formalityLevel" value="banmal" style="display: none;">
               (Informal)
            </label>
          </div>
          <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
            document.querySelectorAll('input[name="formalityLevel"]').forEach(radio => {
              radio.addEventListener('change', function() {
                document.querySelectorAll('input[name="formalityLevel"]').forEach(r => {
                  const label = r.parentElement;
                  if (r.checked) {
                    label.style.background = '#667eea';
                    label.style.color = 'white';
                    label.style.borderColor = '#667eea';
                  } else {
                    label.style.background = 'transparent';
                    label.style.color = '#4a5568';
                    label.style.borderColor = '#e2e8f0';
                  }
                });
              });
            });
          </script>

          <div class="generated-script-box" id="generatedScriptBox" style="display: none;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 10px;">Generated Script (editable):</label>
            <textarea id="dailyScriptContent" placeholder="AI-generated script will appear here..."></textarea>

            <div class="vocabulary-preview" id="vocabPreview">

            </div>
          </div>
        </div>

        <div class="script-creator-section">
          <h3> Step 2: Record Your Video</h3>
          <p style="color: #718096; margin-bottom: 20px;">Record yourself reading the script so students can see and hear you.</p>

          <div class="video-record-section" style="text-align: center;">
            <div class="status" id="teacherVideoStatus">Click to start recording</div>

            <div style="position: relative; margin: 15px auto; max-width: 320px;">
              <video id="teacherVideoPreview" controls style="display: none; width: 100%; border-radius: 12px; background: #000;"></video>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="record-btn start" id="startTeacherVideoBtn" onclick="openTeacherRecordingModal()">
                 Start Recording
              </button>
            </div>
          </div>
        </div>

        <div class="script-creator-section">
          <h3> Step 3: Schedule or Publish</h3>

          <div class="schedule-section">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">Schedule for:</label>
              <input type="datetime-local" id="dailyScriptSchedule">
            </div>
            <div style="color: #718096; font-size: 13px; padding-top: 25px;">
              Default auto-publish: 4:30 AM EST<br>
              Student deadline: 4:00 AM EST next day
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button onclick="scheduleDailyScript()" class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px;">
               Schedule
            </button>
            <button onclick="publishDailyScriptNow()" class="btn" style="flex: 1; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 15px;">
               Publish Now
            </button>
          </div>
        </div>
      </div>

      <div id="manageDailyActivities" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Manage Daily Activities</span>
        </h2>

        <div style="display: flex; gap: 15px; margin-bottom: 25px;">
          <button onclick="filterDailyActivities('all')" class="btn btn-secondary" id="filterAll">All</button>
          <button onclick="filterDailyActivities('scheduled')" class="btn btn-secondary" id="filterScheduled"> Scheduled</button>
          <button onclick="filterDailyActivities('published')" class="btn btn-secondary" id="filterPublished"> Published</button>
          <button onclick="filterDailyActivities('past')" class="btn btn-secondary" id="filterPast"> Past</button>
        </div>

        <div id="dailyActivitiesList">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <p>No daily activities yet. Create one to get started!</p>
          </div>
        </div>
      </div>

      <div id="gradeDailyActivities" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Grade Student Submissions</span>
        </h2>

        <div style="margin-bottom: 25px;">
          <label style="font-weight: 600; margin-bottom: 10px; display: block;">Select Activity:</label>
          <select id="dailyActivitySelector" onchange="loadDailySubmissions()" style="width: 100%; max-width: 400px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
            <option value="">-- Select a daily activity --</option>
          </select>
        </div>

        <div id="dailySubmissionsContainer">
          <div style="text-align: center; padding: 60px; color: #718096;">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <p>Select an activity above to view student submissions</p>
          </div>
        </div>
      </div>

      <div class="grading-modal-overlay" id="dailyGradingModal">
        <div class="grading-modal" style="max-width: 1100px; max-height: 95vh; overflow-y: auto;">
          <div class="grading-modal-header">
            <h2>Grade Pronunciation</h2>
            <div class="student-info" id="gradingStudentInfo">Student Name</div>
          </div>
          <div class="grading-modal-body">

            <div style="background: #f0f4ff; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
              <div style="font-size: 13px; color: #667eea; margin-bottom: 8px; font-weight: 600;"> Student's Recording:</div>
              <audio id="gradingStudentAudio" controls style="width: 100%;"></audio>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">

              <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0;">
                <h4 style="margin: 0 0 15px 0; color: #1a202c;"> Transcript Comparison</h4>

                <div style="margin-bottom: 15px;">
                  <div style="font-size: 12px; color: #667eea; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Original Script:</div>
                  <div id="gradingOriginalText" style="background: white; padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.8; color: #1a202c; max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0;"></div>
                </div>

                <div>
                  <div style="font-size: 12px; color: #48bb78; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Student Said:</div>
                  <div id="gradingStudentText" style="background: white; padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.8; color: #1a202c; max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0;"></div>
                </div>
              </div>

              <div style="display: flex; flex-direction: column; gap: 15px;">

                <div id="aiAnalysisSection" style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 12px; padding: 15px; border: 2px solid #e9d8fd; display: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #9f7aea; font-weight: 600; text-transform: uppercase;"> AI Analysis</div>
                    <button onclick="generateAIAnalysis()" style="padding: 4px 10px; background: rgba(159, 122, 234, 0.2); color: #9f7aea; border: 1px solid #9f7aea; border-radius: 6px; cursor: pointer; font-size: 11px;">
                       Regenerate
                    </button>
                  </div>
                  <div id="aiAnalysisContent" style="font-size: 13px;">
                    <div id="aiGoodPoints" style="color: #276749; margin-bottom: 10px;"></div>
                    <div id="aiSuggestions" style="color: #744210;"></div>
                  </div>
                </div>

                <div id="gradesReferencePanel" style="background: linear-gradient(135deg, #ebf8ff, #e6fffa); border-radius: 12px; padding: 15px; border: 2px solid #81e6d9; display: none;">
                  <div style="font-size: 12px; color: #319795; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;"> Grades Reference (for video)</div>
                  <div id="gradesReferenceList" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 13px;"></div>
                </div>

                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0; flex: 1;">
                  <h4 style="margin: 0 0 15px 0; color: #1a202c;"> Record Video Feedback <span style="font-weight: normal; font-size: 13px; color: #718096;">(Max 1 min)</span></h4>

                  <div style="text-align: center;">
                    <div class="record-timer" id="videoRecordTimer" style="display: none; font-size: 24px; font-weight: bold; color: #f56565; margin-bottom: 10px;">0:00</div>
                    <video id="teacherVideoPreview" style="width: 100%; max-height: 200px; border-radius: 8px; background: #1a202c; display: none;" autoplay muted></video>
                    <video id="teacherVideoPlayback" style="width: 100%; max-height: 200px; border-radius: 8px; background: #1a202c; display: none;" controls></video>
                    <div id="videoPlaceholder" style="width: 100%; height: 150px; background: #1a202c; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #718096;">
                      <span>Camera preview will appear here</span>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                      <button id="startVideoBtn" onclick="startVideoRecording()" style="padding: 10px 20px; background: linear-gradient(135deg, #f56565, #c53030); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                         Start Recording
                      </button>
                      <button id="stopVideoBtn" onclick="stopVideoRecording()" style="display: none; padding: 10px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 20px; font-weight: 600; cursor: pointer;">
                         Stop
                      </button>
                      <button id="retakeVideoBtn" onclick="retakeVideo()" style="display: none; padding: 10px 20px; background: #fef3c7; color: #92400e; border: none; border-radius: 20px; font-weight: 600; cursor: pointer;">
                         Retake
                      </button>
                    </div>
                  </div>

                  <div id="teacherTranscriptBox" style="display: none; margin-top: 15px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; text-align: left;">
                    <div style="font-size: 11px; color: #667eea; font-weight: 600; margin-bottom: 8px;"> TRANSCRIPT (Korean):</div>
                    <div id="teacherTranscriptText" style="font-size: 13px; color: #2d3748; line-height: 1.6; max-height: 100px; overflow-y: auto;">
                      <em style="color: #a0aec0;">Listening...</em>
                    </div>
                    <div style="font-size: 11px; color: #a0aec0; margin-top: 8px;">This transcript will be shown to the student with hoverable word translations.</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 25px;">
              <h4 style="margin-bottom: 10px;"> Select 5 Sounds to Grade</h4>
              <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
                Click on exactly 5 consonants, vowels, or assimilations to grade (1-10 each).
                <span id="soundsSelectedCount" style="font-weight: bold; color: #667eea;">0/5 graded</span>
              </p>

              <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: #667eea; margin-bottom: 8px; font-weight: 600;"> LEVEL 1 - CONSONANTS:</div>
                <div class="sound-selection-grid" id="consonantGrid" style="display: flex; flex-wrap: wrap; gap: 8px;">

                </div>
              </div>

              <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: #9f7aea; margin-bottom: 8px; font-weight: 600;"> LEVEL 1 - VOWELS:</div>
                <div class="sound-selection-grid" id="vowelGrid" style="display: flex; flex-wrap: wrap; gap: 8px;">

                </div>
              </div>

              <div>
                <div style="font-size: 12px; color: #ed8936; margin-bottom: 8px; font-weight: 600;"> LEVEL 2 - CONSONANT ASSIMILATIONS:</div>
                <div class="sound-selection-grid" id="assimilationGrid" style="display: flex; flex-wrap: wrap; gap: 8px;">

                </div>
              </div>
            </div>

            <div id="gradedSoundsSummary" style="margin-bottom: 25px; display: none;">
              <h4 style="margin-bottom: 10px;"> Grades Given</h4>
              <div id="gradedSoundsList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>

            <div style="display: flex; gap: 15px;">
              <button onclick="submitDailyGrade()" class="btn" style="flex: 1; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 600; cursor: pointer;" id="submitDailyGradeBtn" disabled>
                 Submit Grade & Feedback
              </button>
              <button onclick="closeDailyGradingModal()" class="btn" style="background: #e2e8f0; color: #4a5568; border: none; padding: 15px 25px; border-radius: 10px; cursor: pointer;">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="soundGradePopup" class="grade-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 4000; text-align: center; min-width: 300px;">
        <h3 id="soundGradeTitle" style="margin: 0 0 15px 0;">Grade: </h3>
        <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">Select a grade from 1-10</p>
        <div class="grade-buttons" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
          <button class="grade-btn" onclick="assignSoundGrade(1)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">1</button>
          <button class="grade-btn" onclick="assignSoundGrade(2)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">2</button>
          <button class="grade-btn" onclick="assignSoundGrade(3)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">3</button>
          <button class="grade-btn" onclick="assignSoundGrade(4)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">4</button>
          <button class="grade-btn" onclick="assignSoundGrade(5)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">5</button>
          <button class="grade-btn" onclick="assignSoundGrade(6)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">6</button>
          <button class="grade-btn" onclick="assignSoundGrade(7)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">7</button>
          <button class="grade-btn" onclick="assignSoundGrade(8)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">8</button>
          <button class="grade-btn" onclick="assignSoundGrade(9)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">9</button>
          <button class="grade-btn" onclick="assignSoundGrade(10)" style="padding: 15px; font-size: 18px; font-weight: bold; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer;">10</button>
        </div>
        <button onclick="document.getElementById('soundGradePopup').style.display='none'" style="margin-top: 15px; padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
      </div>

      <div id="createTest" class="tab-content active">
        <h2>Create New Test</h2>
        <div class="form-group">
          <label>Main Test Title</label>
          <input type="text" id="mainTestTitle" placeholder="Enter main test title">
        </div>

        <div style="margin-top: 20px;">
          <h3 style="margin-bottom: 15px;">Test Materials</h3>
          <div id="testMaterialsList"></div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #e2e8f0;">
          <h4 style="margin-bottom: 15px; color: #667eea;">Add New Test Material</h4>

          <div class="form-group">
            <label>Material Title</label>
            <input type="text" id="materialTitle" placeholder="Enter material title">
          </div>

          <div class="form-group">
            <label>Test Material Content</label>
            <textarea id="testMaterial" rows="8" placeholder="Enter the test material/content here..."></textarea>
          </div>

          <div class="form-group">
            <label>Time Limit</label>
            <div class="time-input-group">
              <input type="number" id="materialMinutes" class="time-input" min="0" placeholder="0">
              <span class="time-label">minutes</span>
              <input type="number" id="materialSeconds" class="time-input" min="0" max="59" placeholder="30">
              <span class="time-label">seconds</span>
            </div>
          </div>

          <div class="form-group">
            <label>Topics for this Material</label>
            <div class="topic-list" id="currentTopicList"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newTopic" placeholder="Enter topic name">
              <button onclick="addTopicToCurrentMaterial()" class="btn btn-secondary">Add Topic</button>
            </div>
          </div>

          <div id="currentTopicFeedbacks"></div>

          <button onclick="addTestMaterial()" class="btn btn-secondary" style="margin-top: 20px;">Add This Test Material</button>
        </div>

        <div id="editingIndicator" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 15px; margin-top: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <div style="color: #92400e;">
              <strong> Editing Mode:</strong> You are editing an existing test. Changes will update the original.
            </div>
            <button onclick="cancelEditTest()" class="btn btn-secondary" style="background: #f59e0b; color: white; padding: 8px 16px;">
               Cancel Edit
            </button>
          </div>
        </div>

        <button onclick="saveCompleteTest()" class="btn" style="margin-top: 20px; font-size: 18px; padding: 15px 30px;">Save Complete Test</button>
      </div>

      <div id="manageTests" class="tab-content">
        <h2>Manage Tests</h2>

        <div style="background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #86efac;">
          <p style="color: #166534; font-size: 14px; margin: 0;">
             <strong>Click any test folder to view details, edit, copy, or delete.</strong>
          </p>
        </div>

        <div id="testsList"></div>
      </div>

      <div id="gradeStudents" class="tab-content">
        <h2>Grade Student Submissions</h2>
        <div id="submissionsList"></div>
      </div>

      <div id="createTest2" class="tab-content">
        <h2>Create New Test2</h2>
        <div class="form-group">
          <label>Main Test Title</label>
          <input type="text" id="mainTestTitle2" placeholder="Enter main test title">
        </div>

        <div style="margin-top: 20px;">
          <h3 style="margin-bottom: 15px;">Test Materials</h3>
          <div id="testMaterialsList2"></div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #e2e8f0;">
          <h4 style="margin-bottom: 15px; color: #667eea;">Add New Test Material</h4>

          <div class="form-group">
            <label>Material Title</label>
            <input type="text" id="materialTitle2" placeholder="Enter material title">
          </div>

          <div class="form-group">
            <label>Test Material Content</label>
            <textarea id="testMaterial2" rows="8" placeholder="Enter the test material/content here..."></textarea>
          </div>

          <div class="form-group">
            <label>Time Limit</label>
            <div class="time-input-group">
              <input type="number" id="materialMinutes2" class="time-input" min="0" placeholder="0">
              <span class="time-label">minutes</span>
              <input type="number" id="materialSeconds2" class="time-input" min="0" max="59" placeholder="30">
              <span class="time-label">seconds</span>
            </div>
          </div>

          <div class="form-group">
            <label>Topics for this Material</label>
            <div style="margin-bottom: 15px; padding: 12px; background: #e6ffed; border-radius: 8px; border-left: 4px solid #48bb78;">
              <button onclick="loadKoreanCharacters()" class="btn" style="background: #48bb78; padding: 10px 20px;">
                 Load All Korean Characters & Vowels
              </button>
              <p style="margin-top: 8px; font-size: 13px; color: #2d5f4d;">
                Click to auto-load all consonants (,,...) and vowels (,,...) with pre-configured feedback videos
              </p>
            </div>
            <div class="topic-list" id="currentTopicList2"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newTopic2" placeholder="Enter topic name">
              <button onclick="addTopicToCurrentMaterial2()" class="btn btn-secondary">Add Topic</button>
            </div>
          </div>

          <div id="currentTopicFeedbacks2"></div>

          <button onclick="addTestMaterial2()" class="btn btn-secondary" style="margin-top: 20px;">Add This Test Material</button>
        </div>

        <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #d8b4fe;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: #6b21a8; display: flex; align-items: center; gap: 10px;">
               Consonant Assimilation Drills (Level 2)
              <span style="font-size: 12px; font-weight: normal; color: #7c3aed;">22 Rules with Drill Words by Score</span>
            </h4>
            <button onclick="toggleConsonantAssimilationSection()" id="caToggleBtn" class="btn btn-secondary" style="padding: 8px 15px; font-size: 13px;">
               Expand Section
            </button>
          </div>

          <p style="font-size: 13px; color: #6b21a8; margin-bottom: 15px;">
            Configure drill words for each consonant assimilation rule. Students receive drills based on their Level 2 scores.
          </p>

          <div id="consonantAssimilationDrillsContainer" style="display: none;">

            <div id="caRulesList"></div>
          </div>
        </div>

        <button onclick="saveCompleteTest2()" class="btn" style="margin-top: 20px; font-size: 18px; padding: 15px 30px;">Save Complete Test</button>
      </div>

      <div id="manageTests2" class="tab-content">
        <h2>Manage Tests2</h2>

        <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #d8b4fe;">
          <p style="color: #6b21a8; font-size: 14px; margin: 0;">
             <strong>Click any test folder to view details, edit, copy, or delete.</strong>
          </p>
        </div>

        <div id="testsList2"></div>
      </div>

      <div id="gradeStudents2" class="tab-content">
        <h2>Grade Student Submissions2</h2>
        <p style="background: #e6fffa; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #234e52; border-left: 4px solid #38b2ac;">
           <strong>Organized by Student:</strong> Each student has their own folder containing all their test submissions and grading history.
        </p>
        <div id="submissionsList2"></div>
      </div>

      <div id="drillTracking" class="tab-content">
        <h2> Student Drill Tracking</h2>
        <p style="background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #553c9a; border-left: 4px solid #9f7aea;">
           <strong>Monitor Student Progress:</strong> Track daily drill completion for all students. See who's on track and who needs encouragement.
        </p>
        <div id="drillTrackingContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading drill tracking data...</p>
          </div>
        </div>
      </div>

      <div id="createGrammarEval" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Create Grammar Evaluation</span>
        </h2>

        <p style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #92400e; border-left: 4px solid #f59e0b;">
           <strong>Grammar Evaluation:</strong> Select topics from the admin-configured grammar library. Students will be graded on each topic and receive sentence drills based on their scores.
        </p>

        <div class="form-group">
          <label style="font-weight: 600;">Test Title *</label>
          <input type="text" id="grammarEvalTitle" placeholder="e.g., Week 3 Grammar Assessment">
        </div>

        <div class="form-group">
          <label style="font-weight: 600;">Description (Optional)</label>
          <textarea id="grammarEvalDescription" rows="2" placeholder="Brief description of this evaluation..."></textarea>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #667eea;">
          <h3 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px;">
            <span></span> Select Grammar Topics
          </h3>
          <p style="font-size: 13px; color: #718096; margin-bottom: 15px;">
            Choose topics from the admin library. Students will be graded on each selected topic.
          </p>
          <div id="grammarTopicSelectionList">
            <div style="text-align: center; padding: 30px; color: #718096;">
              <div class="loading"></div>
              <p>Loading grammar topics...</p>
            </div>
          </div>
        </div>

        <div id="selectedGrammarTopicsPreview" style="display: none; background: #f0fff4; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #48bb78;">
          <h4 style="margin-bottom: 15px; color: #276749;"> Selected Topics (<span id="selectedGrammarTopicsCount">0</span>)</h4>
          <div id="selectedGrammarTopicsList"></div>
        </div>

        <button onclick="createGrammarEvaluation()" class="btn" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
           CREATE GRAMMAR EVALUATION
        </button>
      </div>

      <div id="manageGrammarEvals" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Manage Grammar Evaluations</span>
        </h2>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button onclick="loadGrammarEvaluations()" class="btn btn-secondary"> Refresh</button>
        </div>

        <div id="grammarEvalsListContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading grammar evaluations...</p>
          </div>
        </div>
      </div>

      <div id="gradeGrammarEvals" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Grade Grammar Submissions</span>
        </h2>

        <p style="background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #234e52; border-left: 4px solid #38b2ac;">
           <strong>Grading:</strong> Rate each grammar topic from 1-10. Score determines which sentence drill set the student receives. Score 10 = Mastered (no drills).
        </p>

        <div id="grammarSubmissionsContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading submissions to grade...</p>
          </div>
        </div>
      </div>

      <div id="grammarDrillTracking" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Grammar Drill Tracking</span>
        </h2>

        <p style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #92400e; border-left: 4px solid #f59e0b;">
           <strong>Track Progress:</strong> Monitor student grammar drill completion. Students practice 5 times per day for 7 days.
        </p>

        <div id="grammarDrillTrackingContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading grammar drill tracking...</p>
          </div>
        </div>
      </div>

      <div id="teacherProfile" class="tab-content">
        <div class="content-header">
          <span> My Teacher Profile</span>
        </div>

        <div class="form-group" style="max-width: 600px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 30px;">
            <div id="teacherProfilePhotoPreview" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 48px; overflow: hidden; border: 4px solid #667eea;">
              
            </div>
            <label style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; cursor: pointer; font-size: 14px;">
               Upload Photo
              <input type="file" id="teacherProfilePhotoInput" accept="image/*" onchange="previewTeacherProfilePhoto()" style="display: none;">
            </label>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 8px;">Display Name</label>
            <input type="text" id="teacherDisplayNameInput" placeholder="Your name" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 8px;">Bio / Description</label>
            <textarea id="teacherBioInput" placeholder="Tell your students about yourself... (e.g., your teaching experience, specialties, hobbies)"
                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; min-height: 120px; resize: vertical;"></textarea>
          </div>

          <button onclick="saveTeacherProfile()" class="btn" style="width: 100%; padding: 15px; font-size: 16px;">
             Save Profile
          </button>
        </div>
      </div>

      <div id="flashcards" class="tab-content">
        <h2> Flashcard Games Management</h2>

        <div class="afd-container" id="adminFolderDashboard">
          <div class="afd-header">
            <h3> Student Folders Dashboard</h3>
            <div class="afd-header-actions">
              <button class="afd-btn afd-btn-secondary" onclick="exportAdminFolders()">
                 Export
              </button>
              <button class="afd-btn afd-btn-secondary" onclick="showImportModal()">
                 Import
              </button>
              <button class="afd-btn afd-btn-primary" onclick="openAdminFolderModal()">
                 Create Folder
              </button>
            </div>
          </div>

          <div class="afd-tabs">
            <button class="afd-tab active" onclick="switchAfdTab('overview')"> Overview</button>
            <button class="afd-tab" onclick="switchAfdTab('folders')"> All Folders</button>
            <button class="afd-tab" onclick="switchAfdTab('analytics')"> Analytics</button>
            <button class="afd-tab" onclick="switchAfdTab('students')"> Student Access</button>
          </div>

          <div id="afdOverviewTab" class="afd-tab-content">
            <div class="afd-stats-row" id="afdStatsRow">
              <div class="afd-stat-card">
                <div class="afd-stat-value" id="afdTotalFolders">0</div>
                <div class="afd-stat-label">Total Folders</div>
              </div>
              <div class="afd-stat-card">
                <div class="afd-stat-value" id="afdActiveFolders">0</div>
                <div class="afd-stat-label">Active Folders</div>
              </div>
              <div class="afd-stat-card">
                <div class="afd-stat-value" id="afdTotalSets">0</div>
                <div class="afd-stat-label">Flashcard Sets</div>
              </div>
              <div class="afd-stat-card">
                <div class="afd-stat-value" id="afdTotalStudents">0</div>
                <div class="afd-stat-label">Students Assigned</div>
              </div>
              <div class="afd-stat-card">
                <div class="afd-stat-value" id="afdAutoAssign">0</div>
                <div class="afd-stat-label">Auto-Assign Enabled</div>
              </div>
            </div>

            <div class="afd-table-container">
              <table class="afd-table">
                <thead>
                  <tr>
                    <th style="width: 30px;"></th>
                    <th>Folder Name</th>
                    <th>Sets</th>
                    <th>Students</th>
                    <th>Status</th>
                    <th>Auto-Assign</th>
                    <th>Created</th>
                    <th style="width: 200px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="afdFoldersTableBody">
                  <tr><td colspan="8" style="text-align: center; padding: 40px;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="afdFoldersTab" class="afd-tab-content" style="display: none;">
            <div class="afd-search-bar">
              <input type="text" class="afd-search-input" id="afdSearchInput" placeholder=" Search folders..." oninput="filterAdminFolders()">
              <select class="afd-filter-select" id="afdStatusFilter" onchange="filterAdminFolders()">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="archived">Archived</option>
                <option value="locked">Locked</option>
              </select>
              <select class="afd-filter-select" id="afdAutoAssignFilter" onchange="filterAdminFolders()">
                <option value="all">All Auto-Assign</option>
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>
            <div id="afdFilteredFoldersList"></div>
          </div>

          <div id="afdAnalyticsTab" class="afd-tab-content" style="display: none;">
            <div class="afd-analytics-grid">
              <div class="afd-chart-card">
                <div class="afd-chart-title"> Most Played Sets</div>
                <div id="afdMostPlayedChart">
                  <canvas id="mostPlayedCanvas" height="200"></canvas>
                </div>
              </div>
              <div class="afd-chart-card">
                <div class="afd-chart-title"> Student Engagement</div>
                <div id="afdEngagementChart">
                  <canvas id="engagementCanvas" height="200"></canvas>
                </div>
              </div>
              <div class="afd-chart-card">
                <div class="afd-chart-title"> Completion Rates by Folder</div>
                <div id="afdCompletionChart">
                  <canvas id="completionCanvas" height="200"></canvas>
                </div>
              </div>
              <div class="afd-chart-card">
                <div class="afd-chart-title"> Activity Over Time</div>
                <div id="afdActivityChart">
                  <canvas id="activityCanvas" height="200"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div id="afdStudentsTab" class="afd-tab-content" style="display: none;">
            <div class="afd-search-bar">
              <input type="text" class="afd-search-input" id="afdStudentSearchInput" placeholder=" Search students..." oninput="filterStudentAccess()">
              <button class="afd-btn afd-btn-secondary" onclick="syncAllStudentFolders()">
                 Sync All Students
              </button>
            </div>
            <div id="afdStudentAccessList"></div>
          </div>

          <div id="afdDetailPanel" class="afd-detail-panel" style="display: none;">
            <div class="afd-detail-header">
              <div class="afd-detail-title">
                <span id="afdDetailIcon"></span>
                <span id="afdDetailName">Folder Name</span>
              </div>
              <button onclick="closeAfdDetailPanel()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;"></button>
            </div>
            <div class="afd-detail-tabs">
              <button class="afd-detail-tab active" onclick="switchAfdDetailTab('sets')"> Flashcard Sets</button>
              <button class="afd-detail-tab" onclick="switchAfdDetailTab('students')"> Students</button>
              <button class="afd-detail-tab" onclick="switchAfdDetailTab('analytics')"> Analytics</button>
              <button class="afd-detail-tab" onclick="switchAfdDetailTab('settings')"> Settings</button>
            </div>
            <div class="afd-detail-content" id="afdDetailContent">

            </div>
          </div>
        </div>

        <div id="adminFolderModal" class="fc-folder-modal" style="display: none;">
          <div class="fc-folder-modal-content" style="max-width: 600px;">
            <h3 id="adminFolderModalTitle"> Create Admin Folder for Students</h3>

            <div class="form-group">
              <label>Folder Name</label>
              <input type="text" id="adminFolderNameInput" placeholder="e.g., TOPIK Vocabulary, Essential Phrases..." maxlength="50">
            </div>

            <div class="form-group">
              <label>Folder Icon</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="folderIconPicker">
                <button type="button" class="folder-icon-option selected" data-icon="" style="padding: 8px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: #fef3c7; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
                <button type="button" class="folder-icon-option" data-icon="" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 18px;"></button>
              </div>
            </div>

            <div class="form-group">
              <label>Parent Folder <span style="color: #718096; font-weight: normal;">(optional - create as subfolder)</span></label>
              <select id="adminFolderParentSelect" onchange="onParentFolderSelected(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white;">
                <option value=""> Root Level (No Parent)</option>
              </select>
              <p style="font-size: 11px; color: #718096; margin-top: 5px;"> Select a parent folder to create this as a subfolder. Students will be inherited from parent.</p>
            </div>

            <div class="form-group">
              <label>Assign to Students</label>
              <div style="max-height: 180px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                <div style="margin-bottom: 10px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: #f0fdf4; border-radius: 6px;">
                    <input type="checkbox" id="selectAllStudentsCheckbox" onchange="toggleAllStudents(this.checked)">
                    <strong>Select All Students</strong>
                  </label>
                </div>
                <div id="studentCheckboxList">

                </div>
              </div>

              <div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 10px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                  <input type="checkbox" id="autoAssignFutureStudents" checked>
                  <div>
                    <strong style="color: #92400e;"> Auto-assign to future students</strong>
                    <p style="font-size: 11px; color: #a16207; margin: 3px 0 0;">New student accounts will automatically receive this folder</p>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label>Add Flashcard Sets</label>
              <div style="max-height: 150px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 10px; padding: 10px;">
                <div id="flashcardCheckboxList">

                </div>
              </div>
            </div>

            <div class="afd-access-control">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="enableAccessControl">
                <div>
                  <strong style="color: #065f46;"> Enable Access Control</strong>
                  <p style="font-size: 11px; color: #047857; margin: 3px 0 0;">Set visibility dates or lock the folder</p>
                </div>
              </label>
              <div id="accessControlOptions" style="display: none;">
                <div class="afd-date-inputs">
                  <div class="afd-date-group">
                    <label>Available From</label>
                    <input type="datetime-local" id="folderStartDate">
                  </div>
                  <div class="afd-date-group">
                    <label>Available Until</label>
                    <input type="datetime-local" id="folderEndDate">
                  </div>
                </div>
                <div style="margin-top: 12px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="folderLocked">
                    <span style="color: #065f46; font-size: 13px;"> Lock folder (students can see but not access)</span>
                  </label>
                </div>
                <div style="margin-top: 8px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="folderRequired">
                    <span style="color: #065f46; font-size: 13px;"> Mark as required</span>
                  </label>
                </div>
              </div>
            </div>

            <div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border: 2px solid #667eea; border-radius: 10px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="notifyStudents" checked>
                <div>
                  <strong style="color: #4c51bf;"> Notify students</strong>
                  <p style="font-size: 11px; color: #667eea; margin: 3px 0 0;">Send notification when folder is created/updated</p>
                </div>
              </label>
            </div>

            <div class="modal-actions">
              <button class="cancel-btn" onclick="closeAdminFolderModal()">Cancel</button>
              <button class="save-btn" id="saveAdminFolderBtn" onclick="saveAdminFolder()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Create & Push to Students</button>
            </div>
          </div>
        </div>

        <div id="afdPreviewModal" class="afd-preview-modal" style="display: none;">
          <div class="afd-preview-content">
            <div class="afd-preview-header">
              <h3 style="margin: 0; color: #2d3748;"> Student Preview</h3>
              <button onclick="closePreviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;"></button>
            </div>
            <div class="afd-preview-body" id="afdPreviewBody">

            </div>
          </div>
        </div>

        <div id="afdImportModal" class="fc-folder-modal" style="display: none;">
          <div class="fc-folder-modal-content" style="max-width: 500px;">
            <h3> Import Folders</h3>
            <div class="form-group">
              <label>Paste exported JSON data</label>
              <textarea id="importJsonData" style="width: 100%; height: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: monospace; font-size: 12px;" placeholder='{"folders": [...], "version": "1.0"}'></textarea>
            </div>
            <div class="modal-actions">
              <button class="cancel-btn" onclick="closeImportModal()">Cancel</button>
              <button class="save-btn" onclick="importAdminFolders()" style="background: linear-gradient(135deg, #667eea, #764ba2);">Import Folders</button>
            </div>
          </div>
        </div>

        <div class="test-card" style="margin-bottom: 30px;">
          <h3>Create New Flashcard Set</h3>
          <div class="form-group">
            <label>Set Title</label>
            <input type="text" id="flashcardSetTitle" placeholder="e.g., Basic Greetings, Food Vocabulary" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
          </div>
          <div class="form-group">
            <label>Timer per Word (seconds)</label>
            <input type="number" id="flashcardTimer" value="7" min="3" max="30" style="width: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
          </div>

          <div style="margin: 20px 0;">
            <h4>Add Word Pairs</h4>

            <div style="background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h5 style="color: #667eea; margin-bottom: 10px;"> Bulk Import from Google Sheets</h5>
              <p style="font-size: 13px; color: #718096; margin-bottom: 15px;">
                Copy a column of English words and a column of Korean words from Google Sheets, then paste them below.
              </p>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="font-size: 13px; font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">
                    English Words (one per line)
                  </label>
                  <textarea id="bulkEnglishWords" placeholder="apple&#10;banana&#10;orange&#10;grape"
                    style="width: 100%; height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div>
                  <label style="font-size: 13px; font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">
                    Korean Words (one per line)
                  </label>
                  <textarea id="bulkKoreanWords" placeholder="&#10;&#10;&#10;"
                    style="width: 100%; height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
              </div>

              <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-secondary" onclick="importBulkWordPairs()" style="padding: 10px 20px;">
                   Import Words
                </button>
                <button class="btn" onclick="clearBulkImport()" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568;">
                  Clear
                </button>
                <span id="bulkImportStatus" style="font-size: 13px; color: #718096;"></span>
              </div>
            </div>

            <div style="display: flex; align-items: center; margin: 20px 0;">
              <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
              <span style="padding: 0 15px; color: #a0aec0; font-size: 14px;">OR add one at a time</span>
              <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <input type="text" id="englishWord" placeholder="English word" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
              <input type="text" id="koreanWord" placeholder="Korean word" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
              <button class="btn" onclick="addWordPair()" style="padding: 10px 20px;">Add Pair</button>
            </div>

            <div id="wordPairsList" style="background: #f7fafc; padding: 20px; border-radius: 12px; min-height: 100px;">
              <p style="color: #718096;">No word pairs added yet. Add at least 5 words to create a set.</p>
            </div>
          </div>

          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <button class="btn btn-secondary" onclick="saveFlashcardSet()" style="font-size: 16px; padding: 12px 30px;">
               Save Flashcard Set
            </button>
            <button class="btn" onclick="generateAIData()" style="font-size: 16px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
               Generate AI Data
            </button>
            <div id="aiGenerationStatus" style="display: none; padding: 10px 15px; border-radius: 8px; font-size: 14px;"></div>
          </div>
        </div>

        <div class="test-card">
          <h3>Existing Flashcard Sets</h3>
          <div id="flashcardSetsList">
            <div class="loading"></div>
          </div>
        </div>
      </div>

      <div id="leaderboard" class="tab-content">
        <h2> Student Leaderboards</h2>
        <p style="color: #718096; margin-bottom: 25px;">Track top performing students across flashcards, pronunciation, and tests.</p>

        <div class="leaderboard-container">

          <div class="leaderboard-tabs">
            <button class="leaderboard-tab active" onclick="switchLeaderboardTab('flashcard')"> Flashcard</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('pronunciation')"> Pronunciation</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('test')"> Test</button>
          </div>

          <div id="leaderboard-flashcard" class="leaderboard-section active">
            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Most Consistent Practice</h3>
                  <p>Students who log in and practice most frequently with best streaks</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-practice-streak">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Most Improvement</h3>
                  <p>Students showing the most progress with flashcards</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-flashcard-improvement">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Most Words Memorized</h3>
                  <p>Students who have mastered the most vocabulary</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-words-mastered">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Best Overall Flashcard Performance</h3>
                  <p>Top performers combining accuracy, speed, and consistency</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-flashcard-overall">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>

          <div id="leaderboard-pronunciation" class="leaderboard-section">
            <div class="leaderboard-card">
              <div class="leaderboard-header pronunciation">
                <div class="icon"></div>
                <div>
                  <h3>Most Improvement in Pronunciation</h3>
                  <p>Students showing the greatest pronunciation improvement</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-pronunciation-improvement">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header pronunciation">
                <div class="icon"></div>
                <div>
                  <h3>Best Pronunciation Accuracy</h3>
                  <p>Students with highest pronunciation scores</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-pronunciation-accuracy">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header overall">
                <div class="icon"></div>
                <div>
                  <h3>Best Overall (Pronunciation + Flashcard)</h3>
                  <p>Top performers combining pronunciation and vocabulary skills</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-combined-overall">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>

          <div id="leaderboard-test" class="leaderboard-section">
            <div class="leaderboard-card">
              <div class="leaderboard-header test">
                <div class="icon"></div>
                <div>
                  <h3>Best Test Scores</h3>
                  <p>Students with highest average test scores</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-test-scores">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header test">
                <div class="icon"></div>
                <div>
                  <h3>Most Test Improvement</h3>
                  <p>Students showing the greatest improvement in test scores</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="leaderboard-test-improvement">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div id="createGame" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;"> Create New Game</h2>

        <div class="game-form-section">
          <h3> Game Details</h3>
          <div class="form-group">
            <label>Game Title</label>
            <input type="text" id="gameTitle" placeholder="Enter an exciting game title...">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>Timer (seconds per question, 0 = no timer)</label>
              <input type="number" id="gameTimer" value="0" min="0" max="300" placeholder="0">
            </div>
            <div class="form-group">
              <label>Randomize Answer Order</label>
              <select id="gameRandomize">
                <option value="true">Yes - Shuffle answers each time</option>
                <option value="false">No - Keep original order</option>
              </select>
            </div>
          </div>
        </div>

        <div class="game-form-section">
          <h3> Game Assets (Audio & Images)</h3>
          <p style="color: #a0aec0; font-size: 13px; margin-bottom: 15px;">Add feedback media that plays during the game</p>

          <div class="game-assets-grid">
            <div class="asset-upload-card">
              <h4> Game Start</h4>
              <div class="form-group" style="margin-bottom: 10px;">
                <label>Image URL</label>
                <input type="text" id="gameStartImage" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameStartAudio" placeholder="https://...">
              </div>
            </div>

            <div class="asset-upload-card">
              <h4> Correct Answer</h4>
              <div class="form-group" style="margin-bottom: 10px;">
                <label>Image URL</label>
                <input type="text" id="gameCorrectImage" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameCorrectAudio" placeholder="https://...">
              </div>
            </div>

            <div class="asset-upload-card">
              <h4> Wrong Answer</h4>
              <div class="form-group" style="margin-bottom: 10px;">
                <label>Image URL</label>
                <input type="text" id="gameWrongImage" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameWrongAudio" placeholder="https://...">
              </div>
            </div>

            <div class="asset-upload-card">
              <h4> Background Music</h4>
              <div class="form-group" style="margin-bottom: 10px;">
                <label>Music URL (loops during game)</label>
                <input type="text" id="gameBackgroundMusic" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Timer Tick Sound (last 5 sec)</label>
                <input type="text" id="gameTickSound" placeholder="https://...">
              </div>
            </div>
          </div>
        </div>

        <div class="game-form-section">
          <h3> End Game Results by Score</h3>
          <p style="color: #a0aec0; font-size: 13px; margin-bottom: 15px;">Different celebrations based on final percentage</p>

          <div class="score-tier-grid">
            <div class="score-tier-card tier-1">
              <h5> 0% - 50%</h5>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>GIF URL</label>
                <input type="text" id="gameTier1Gif" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameTier1Audio" placeholder="https://...">
              </div>
            </div>

            <div class="score-tier-card tier-2">
              <h5> 51% - 74%</h5>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>GIF URL</label>
                <input type="text" id="gameTier2Gif" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameTier2Audio" placeholder="https://...">
              </div>
            </div>

            <div class="score-tier-card tier-3">
              <h5> 75% - 84%</h5>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>GIF URL</label>
                <input type="text" id="gameTier3Gif" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameTier3Audio" placeholder="https://...">
              </div>
            </div>

            <div class="score-tier-card tier-4">
              <h5> 85% - 94%</h5>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>GIF URL</label>
                <input type="text" id="gameTier4Gif" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameTier4Audio" placeholder="https://...">
              </div>
            </div>

            <div class="score-tier-card tier-5">
              <h5> 95% - 100%</h5>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>GIF URL</label>
                <input type="text" id="gameTier5Gif" placeholder="https://...">
              </div>
              <div class="form-group">
                <label>Audio URL</label>
                <input type="text" id="gameTier5Audio" placeholder="https://...">
              </div>
            </div>
          </div>
        </div>

        <div class="game-form-section">
          <h3> Questions</h3>
          <p style="color: #a0aec0; font-size: 13px; margin-bottom: 15px;">Add questions to your game. Click on an answer to mark it as correct.</p>

          <div id="gameQuestionsList"></div>

          <div style="background: rgba(0, 217, 255, 0.1); border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px dashed #00d9ff;">
            <h4 style="color: #00d9ff; margin-bottom: 15px;"> Add New Question</h4>

            <div class="form-group">
              <label>Question Text</label>
              <textarea id="newQuestionText" rows="2" placeholder="Enter your question..."></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
              <div class="form-group">
                <label>Category (optional)</label>
                <input type="text" id="newQuestionCategory" placeholder="e.g., Grammar, Vocabulary">
              </div>
              <div class="form-group">
                <label>Difficulty</label>
                <select id="newQuestionDifficulty">
                  <option value="easy">Easy (1x points)</option>
                  <option value="medium">Medium (2x points)</option>
                  <option value="hard">Hard (3x points)</option>
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
              <div class="form-group">
                <label>Answer A</label>
                <input type="text" id="newAnswerA" placeholder="First answer option">
              </div>
              <div class="form-group">
                <label>Answer B</label>
                <input type="text" id="newAnswerB" placeholder="Second answer option">
              </div>
              <div class="form-group">
                <label>Answer C</label>
                <input type="text" id="newAnswerC" placeholder="Third answer option">
              </div>
              <div class="form-group">
                <label>Answer D</label>
                <input type="text" id="newAnswerD" placeholder="Fourth answer option">
              </div>
            </div>

            <div class="form-group">
              <label>Correct Answer</label>
              <select id="newCorrectAnswer">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>

            <div class="form-group">
              <label>Reason for Correct Answer</label>
              <select id="newReasonType" onchange="toggleReasonInput()">
                <option value="text">Text Explanation</option>
                <option value="image">Image</option>
              </select>
            </div>

            <div id="reasonTextInput" class="form-group">
              <label>Explanation Text</label>
              <textarea id="newReasonText" rows="2" placeholder="Explain why this is the correct answer..."></textarea>
            </div>

            <div id="reasonImageInput" class="form-group" style="display: none;">
              <label>Reason Image URL</label>
              <input type="text" id="newReasonImage" placeholder="https://...">
            </div>

            <div class="form-group">
              <label>Optional GIF (shows below reason)</label>
              <input type="text" id="newReasonGif" placeholder="https://...">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="btn" onclick="addGameQuestion()" style="background: #00d9ff; color: #1a1a2e;">
                 Add Question
              </button>
              <button class="btn btn-secondary" onclick="addFromQuestionBank()">
                 Add from Question Bank
              </button>
            </div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
          <button class="btn" onclick="saveGame()" style="padding: 15px 50px; font-size: 18px; background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); color: #1a1a2e;">
             Save Game
          </button>
          <button class="btn btn-secondary" onclick="previewGame()" style="padding: 15px 50px; font-size: 18px; margin-left: 15px;">
             Preview Game
          </button>
        </div>
      </div>

      <div id="manageGames" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;"> Manage Games</h2>

        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
          <button class="btn" onclick="switchTab('createGame')" style="background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); color: #1a1a2e;">
             Create New Game
          </button>
          <button class="btn btn-secondary" onclick="loadTeacherGames()">
             Refresh List
          </button>
        </div>

        <div id="teacherGamesList">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <p>Loading games...</p>
          </div>
        </div>
      </div>

      <div id="questionBank" class="tab-content">
        <h2 style="color: #667eea; margin-bottom: 20px;"> Question Bank</h2>
        <p style="color: #718096; margin-bottom: 20px;">Save questions here to reuse across multiple games.</p>

        <div class="game-form-section">
          <h3> Add Question to Bank</h3>

          <div class="form-group">
            <label>Question Text</label>
            <textarea id="bankQuestionText" rows="2" placeholder="Enter your question..."></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Category</label>
              <input type="text" id="bankQuestionCategory" placeholder="e.g., Grammar, Vocabulary">
            </div>
            <div class="form-group">
              <label>Difficulty</label>
              <select id="bankQuestionDifficulty">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Answer A</label>
              <input type="text" id="bankAnswerA" placeholder="First answer">
            </div>
            <div class="form-group">
              <label>Answer B</label>
              <input type="text" id="bankAnswerB" placeholder="Second answer">
            </div>
            <div class="form-group">
              <label>Answer C</label>
              <input type="text" id="bankAnswerC" placeholder="Third answer">
            </div>
            <div class="form-group">
              <label>Answer D</label>
              <input type="text" id="bankAnswerD" placeholder="Fourth answer">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Correct Answer</label>
              <select id="bankCorrectAnswer">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div class="form-group">
              <label>Reason Type</label>
              <select id="bankReasonType">
                <option value="text">Text</option>
                <option value="image">Image</option>
              </select>
            </div>
            <div class="form-group">
              <label>Reason Content</label>
              <input type="text" id="bankReasonContent" placeholder="Explanation or image URL">
            </div>
          </div>

          <button class="btn" onclick="saveToQuestionBank()" style="background: #00d9ff; color: #1a1a2e;">
             Save to Bank
          </button>
        </div>

        <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
          <input type="text" id="bankSearchQuery" placeholder=" Search questions..." style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
          <select id="bankFilterCategory" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <option value="">All Categories</option>
          </select>
          <select id="bankFilterDifficulty" style="padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <option value="">All Difficulties</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
          <button class="btn btn-secondary" onclick="filterQuestionBank()">Filter</button>
        </div>

        <div id="questionBankList">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <p>Loading question bank...</p>
          </div>
        </div>
      </div>

      </div>
      </div>
    </div>

    <div id="studentDashboard" class="hidden">
      <div class="dashboard-with-sidebar">

        <div class="floating-profile-btn" id="floatingProfileBtn" onclick="openProfilePanel()">
          <div class="floating-profile-img" id="floatingProfileImg">
            <span class="no-photo"></span>
          </div>
          <div class="floating-profile-coins">
            <span></span>
            <span id="floatingCoinsCount">0</span>
          </div>
        </div>

        <div class="profile-panel-overlay" id="profilePanelOverlay" onclick="closeProfilePanelOnOverlay(event)">
          <div class="profile-panel" onclick="event.stopPropagation()">

            <div class="profile-panel-header">
              <button class="profile-panel-close" onclick="closeProfilePanel()"></button>
              <div class="profile-panel-avatar" onclick="openAvatarUpload()">
                <span class="no-photo-large" id="panelAvatarDisplay"></span>
                <div class="edit-overlay"> Change</div>
              </div>
              <div class="profile-panel-name" id="panelDisplayName">Student</div>
              <div class="profile-panel-coins">
                <span></span>
                <span id="panelCoinsCount">0</span>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="streak-display">
                <div class="streak-number"> <span id="panelStreakCount">0</span></div>
                <div class="streak-label">Day Streak</div>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Your Stats <span style="font-size: 10px; color: #718096; font-weight: normal;">(This Week)</span></div>
              <div class="profile-stats-grid">
                <div class="profile-stat-card clickable" onclick="showStatDetail('streak')">
                  <div class="stat-info-icon" data-tooltip="Complete a pronunciation drill or Leitner flashcard review each day to maintain your streak!"></div>
                  <div class="stat-icon"></div>
                  <div class="stat-value" id="panelStreakDays">0</div>
                  <div class="stat-label">Day Streak</div>
                </div>
                <div class="profile-stat-card clickable" onclick="showStatDetail('pronDrills')">
                  <div class="stat-info-icon" data-tooltip="Complete pronunciation drills in Daily Corrections. Each drill = 20 words of practice."></div>
                  <div class="stat-icon"></div>
                  <div class="stat-value" id="panelPronDrills">0</div>
                  <div class="stat-label">Pron Drills</div>
                </div>
                <div class="profile-stat-card clickable" onclick="showStatDetail('leitnerReps')">
                  <div class="stat-info-icon" data-tooltip="Review flashcards in Flashcard Games or My Cards. Each card reviewed = 1 rep."></div>
                  <div class="stat-icon"></div>
                  <div class="stat-value" id="panelLeitnerReps">0</div>
                  <div class="stat-label">Leitner Reps</div>
                </div>
                <div class="profile-stat-card clickable" onclick="showStatDetail('recordingTime')">
                  <div class="stat-info-icon" data-tooltip="Submit Daily Activity recordings. Your total recording time shows your speaking practice!"></div>
                  <div class="stat-icon"></div>
                  <div class="stat-value" id="panelRecordingTime">0:00</div>
                  <div class="stat-label">Recording Time</div>
                </div>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Monthly Goal</div>
              <div class="goals-tracker">
                <div class="goals-header">
                  <span class="goals-title">Words & Phrases to Master</span>
                  <button class="goals-edit-btn" onclick="openGoalsModal()">Edit Goal</button>
                </div>
                <div class="goals-progress-bar">
                  <div class="goals-progress-fill" id="goalsProgressFill" style="width: 0%;"></div>
                </div>
                <div class="goals-text">
                  <span id="goalsProgressText">0 / 50</span>
                  <span id="goalsPercentText">0%</span>
                </div>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Class Schedule</div>
              <div class="activity-calendar">
                <div class="calendar-month-label" id="calendarMonthLabel">December 2025</div>
                <div class="calendar-grid" id="activityCalendarGrid">

                </div>

                <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(246, 135, 179, 0.2), rgba(167, 139, 250, 0.2)); border-radius: 12px; border: 2px solid rgba(246, 135, 179, 0.3);">
                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <div style="font-size: 14px; font-weight: 600; color: #f687b3;"> Daily Corrections</div>
                      <div style="font-size: 12px; color: #a0aec0; margin-top: 3px;">View feedback & practice drills</div>
                    </div>
                    <button onclick="openDailyCorrectionsPage()" style="padding: 10px 20px; background: linear-gradient(135deg, #f687b3, #a78bfa); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px;">
                      View 
                    </button>
                  </div>
                  <div id="dailyCorrectionsPreview" style="margin-top: 10px; font-size: 12px; color: #cbd5e0;">

                  </div>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 12px; color: #a0aec0; margin-bottom: 10px;"> Weekly Class Schedule</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px;">
                      <span style="color: #e2e8f0; font-weight: 500;">Monday</span>
                      <span style="color: #a78bfa;">Sentence Building  8:00 PM EST</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px;">
                      <span style="color: #e2e8f0; font-weight: 500;">Tuesday</span>
                      <span style="color: #f687b3;">Pronunciation  8:00 PM EST</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px;">
                      <span style="color: #e2e8f0; font-weight: 500;">Wednesday</span>
                      <span style="color: #68d391;">Vocabulary  8:00 PM EST</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px;">
                      <span style="color: #e2e8f0; font-weight: 500;">Thursday</span>
                      <span style="color: #fbd38d;">Modal Verb  8:00 PM EST</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px;">
                      <span style="color: #e2e8f0; font-weight: 500;">Friday</span>
                      <span style="color: #63b3ed;">Listening  8:45 PM EST</span>
                    </div>
                  </div>
                </div>
                <div class="calendar-legend" style="margin-top: 15px;">
                  <span>Less</span>
                  <div class="calendar-legend-box level-0"></div>
                  <div class="calendar-legend-box level-1"></div>
                  <div class="calendar-legend-box level-2"></div>
                  <div class="calendar-legend-box level-3"></div>
                  <div class="calendar-legend-box level-4"></div>
                  <span>More activity</span>
                </div>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Achievements</div>
              <div class="badges-panel-grid" id="badgesPanelGrid">

              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Recent Activity</div>
              <div class="activity-feed" id="activityFeed">

              </div>
              <div class="opt-out-toggle">
                <span class="opt-out-label">Show my activity to others</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="activityOptIn" checked onchange="toggleActivityOptIn()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Settings</div>
              <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
              <button onclick="openAvatarUpload()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 10px;">
                 Upload Profile Picture
              </button>

              <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #e2e8f0; font-size: 14px;"> Dark Mode</span>
                <label class="switch" style="margin: 0;">
                  <input type="checkbox" id="profileThemeToggle" checked onchange="toggleLightMode(event)">
                  <span class="slider">
                    <span class="sun">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#f9d71c">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="12" y1="21" x2="12" y2="23" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="1" y1="12" x2="3" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="21" y1="12" x2="23" y2="12" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#f9d71c" stroke-width="2" stroke-linecap="round"></line>
                      </svg>
                    </span>
                    <span class="moon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                      </svg>
                    </span>
                  </span>
                </label>
              </div>
            </div>

            <div class="profile-panel-section">
              <div class="profile-panel-section-title"> Edit Your Profile</div>

              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Display Name</label>
                <input type="text" id="editDisplayName" placeholder="Your name" maxlength="30"
                       style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; color: white;">
              </div>

              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Bio (short intro)</label>
                <textarea id="editBio" placeholder="Tell us about yourself..." maxlength="150" rows="2"
                          style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; color: white; resize: none;"></textarea>
              </div>

              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Korean Level</label>
                <select id="editKoreanLevel" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; color: white;">
                  <option value="novice" style="background: #1a1a2e;"> Novice - Just starting out</option>
                  <option value="beginner" style="background: #1a1a2e;"> Beginner - Know the basics</option>
                  <option value="intermediate" style="background: #1a1a2e;"> Intermediate - Can hold conversations</option>
                  <option value="advanced" style="background: #1a1a2e;"> Advanced - Near fluent</option>
                </select>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Favorite K-Drama or K-Pop</label>
                <input type="text" id="editFavoriteKContent" placeholder="e.g., BTS, Squid Game, Blackpink..." maxlength="50"
                       style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 14px; color: white;">
              </div>

              <button onclick="saveStudentProfileEdits()" class="btn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-weight: 600; cursor: pointer;">
                 Save Profile
              </button>
            </div>
          </div>
        </div>

        <div class="goals-modal-overlay" id="goalsModalOverlay">
          <div class="goals-modal">
            <h3> Set Your Monthly Goal</h3>
            <p style="color: #718096; margin-bottom: 15px;">How many words & phrases do you want to master this month?</p>
            <input type="number" id="goalsInput" min="50" placeholder="Enter your goal (minimum 50)" value="50" oninput="checkGoalsWarning()">
            <div class="warning-text" id="goalsWarning">
               Setting a goal above 500 may decrease efficiency. Consider pacing yourself at 300 words per month first to avoid burnout.
            </div>
            <div class="btn-row">
              <button onclick="saveGoal()" class="btn" style="flex: 1; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;">Save Goal</button>
              <button onclick="closeGoalsModal()" class="btn" style="flex: 1; background: #e2e8f0; color: #4a5568;">Cancel</button>
            </div>
          </div>
        </div>

        <div class="daily-corrections-overlay" id="dailyCorrectionsOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 5000; overflow-y: auto; overflow-x: hidden; padding-bottom: 100px;">

          <div style="position: sticky; top: 0; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 10; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <button onclick="closeDailyCorrectionsPage()" style="width: 36px; height: 36px; min-width: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 18px; cursor: pointer;"></button>
              <div>
                <div style="font-size: 16px; font-weight: 700; color: white;"> Daily Corrections</div>
                <div style="font-size: 11px; color: #a0aec0;">Practice your pronunciation drills</div>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
              <button onclick="navigateDailyCorrectionsDate(-1)" style="width: 32px; height: 32px; min-width: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 14px; cursor: pointer;"></button>
              <div id="dailyDrillsDate" style="color: #a78bfa; font-size: 12px; min-width: 120px; text-align: center; font-weight: 600;"></div>
              <button onclick="navigateDailyCorrectionsDate(1)" style="width: 32px; height: 32px; min-width: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 14px; cursor: pointer;"></button>
              <button onclick="goToTodayCorrections()" style="padding: 6px 10px; background: rgba(167, 139, 250, 0.2); border: 1px solid rgba(167, 139, 250, 0.4); border-radius: 8px; color: #a78bfa; font-size: 11px; cursor: pointer;">Today</button>
            </div>
          </div>

          <div style="padding: 15px; max-width: 100%; margin: 0 auto; box-sizing: border-box;">

            <div style="background: linear-gradient(135deg, rgba(246, 135, 179, 0.15), rgba(167, 139, 250, 0.15)); border: 2px solid rgba(246, 135, 179, 0.3); border-radius: 16px; padding: 15px; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <span style="font-size: 24px;"></span>
                <div>
                  <div style="font-size: 16px; font-weight: 600; color: #f687b3;">Teacher Feedback</div>
                  <div id="latestCorrectionDate" style="font-size: 12px; color: #a0aec0;"></div>
                </div>
              </div>

              <div id="teacherFeedbackGrid" style="display: grid; grid-template-columns: 1fr; gap: 15px;">

                <div>
                  <div id="latestVideoContainer" style="background: #1a202c; border-radius: 12px; overflow: hidden; min-height: 250px; display: flex; align-items: center; justify-content: center;">
                    <div id="noVideoMessage" style="color: #718096; text-align: center; padding: 40px;">
                      <div style="font-size: 48px; margin-bottom: 10px;"></div>
                      <div>No feedback for this date</div>
                      <div style="font-size: 13px; margin-top: 5px;">Submit a daily activity to receive feedback!</div>
                    </div>
                    <video id="latestCorrectionVideo" controls style="width: 100%; display: none;"></video>
                  </div>

                  <div id="studentRecordingSection" style="display: none; margin-top: 10px;">
                    <button onclick="toggleStudentRecordingDropdown()" style="width: 100%; padding: 12px; background: rgba(102, 126, 234, 0.15); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: #a78bfa; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                      <span> My Original Recording</span>
                      <span id="studentRecordingArrow" style="transition: transform 0.2s;"></span>
                    </button>
                    <div id="studentRecordingDropdown" style="display: none; margin-top: 8px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;">
                      <audio id="studentRecordingAudio" controls style="width: 100%;"></audio>
                      <div id="studentRecordingTranscript" style="margin-top: 10px; font-size: 13px; color: #a0aec0; line-height: 1.6;"></div>
                    </div>
                  </div>

                  <div id="correctionGrades" style="margin-top: 15px; display: none;">
                    <div style="font-size: 13px; color: #a0aec0; margin-bottom: 10px;"> Your Scores:</div>
                    <div id="correctionGradesList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                  </div>
                </div>

                <div id="teacherFeedbackColumn" style="display: none;">
                  <div style="background: rgba(159, 122, 234, 0.1); border: 1px solid rgba(159, 122, 234, 0.3); border-radius: 12px; padding: 20px; height: 100%;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;"></span>
                        <div style="font-size: 14px; font-weight: 600; color: #a78bfa;">Teacher's Feedback</div>
                      </div>
                      <button id="toggleTranslationBtn" onclick="toggleFeedbackTranslation()" style="padding: 4px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #a0aec0; font-size: 11px; cursor: pointer;">
                         English
                      </button>
                    </div>
                    <div id="feedbackTranscriptContent" style="color: #e2e8f0; font-size: 14px; line-height: 2.0;">
                    </div>
                    <div id="feedbackTranslationContent" style="display: none; color: #a0aec0; font-size: 14px; line-height: 1.8; font-style: italic;">
                    </div>
                    <div style="font-size: 11px; color: #718096; margin-top: 12px;"> Hover over Korean words to see translation & add to flashcards</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 25px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 24px;"></span>
                  <div style="font-size: 18px; font-weight: 600; color: white;">Today's Pronunciation Drills</div>
                </div>
                <div id="drillsProgress" style="color: #68d391; font-size: 14px;"></div>
              </div>

              <div id="dailyDrillsContainer">

                <div style="text-align: center; padding: 40px; color: #718096;">
                  <div class="loading" style="margin: 0 auto 15px;"></div>
                  Loading drills...
                </div>
              </div>
            </div>

            <div style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <span style="font-size: 20px;"></span>
                <div style="font-size: 16px; font-weight: 600; color: white;">Past Corrections</div>
              </div>
              <div id="pastCorrectionsContainer">

              </div>
            </div>
          </div>
        </div>

        <div id="dailyDrillPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center;">
          <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; width: 95%; max-width: 600px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.5);">

            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div id="dailyDrillPopupTitle" style="font-size: 18px; font-weight: 700; color: white;">Pronunciation Drill</div>
                <div id="dailyDrillPopupSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.8);"></div>
              </div>
              <button onclick="closeDailyDrillPopup()" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer;"></button>
            </div>

            <div style="padding: 15px 20px; background: rgba(0,0,0,0.2);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #a0aec0;">
                <span id="dailyDrillWordCount">Word 1 of 20</span>
                <span id="dailyDrillRepCount">One-time practice</span>
              </div>
              <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                <div id="dailyDrillProgressBar" style="height: 100%; width: 0%; background: linear-gradient(135deg, #48bb78, #38a169); transition: width 0.3s;"></div>
              </div>
            </div>

            <div style="padding: 30px; text-align: center;">
              <div id="dailyDrillCard" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 40px; margin-bottom: 25px; position: relative;">

                <button id="dailyDrillAudioBtn" onclick="playDailyDrillAudio()" style="position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Listen to pronunciation">
                  
                </button>
                <div id="dailyDrillWord" style="font-size: 48px; font-weight: bold; color: white; margin-bottom: 10px;"></div>
                <div id="dailyDrillMeaning" style="font-size: 16px; color: #a0aec0;">bag</div>
              </div>

              <div id="dailyDrillVoiceStatus" style="margin-bottom: 20px;">
                <div id="dailyDrillListeningIndicator" style="color: #f56565; font-size: 16px; margin-bottom: 10px;">
                  <span class="pulse-dot" style="display: inline-block; width: 12px; height: 12px; background: #f56565; border-radius: 50%; margin-right: 8px; animation: pulse 1s infinite;"></span>
                  <span id="dailyDrillListeningText">Listening... Say the word!</span>
                </div>
                <div id="dailyDrillRecognizedText" style="color: #68d391; font-size: 18px; min-height: 30px;"></div>
              </div>

              <div id="dailyDrillFeedback" style="display: none; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div id="dailyDrillFeedbackText" style="font-size: 16px; font-weight: 600;"></div>
              </div>

              <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="dailyDrillSkipBtn" onclick="skipDailyDrillWord()" style="padding: 15px 25px; background: rgba(255,255,255,0.1); color: #a0aec0; border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; font-size: 14px; cursor: pointer;">
                  Skip 
                </button>
              </div>
            </div>

            <div id="dailyDrillStatsBar" style="padding: 15px 20px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-around; text-align: center;">
              <div>
                <div id="dailyDrillCorrectCount" style="font-size: 24px; font-weight: bold; color: #48bb78;">0</div>
                <div style="font-size: 11px; color: #68d391;">Correct</div>
              </div>
              <div>
                <div id="dailyDrillTotalCount" style="font-size: 24px; font-weight: bold; color: #a0aec0;">0</div>
                <div style="font-size: 11px; color: #718096;">Total</div>
              </div>
              <div>
                <div id="dailyDrillAccuracy" style="font-size: 24px; font-weight: bold; color: #667eea;">0%</div>
                <div style="font-size: 11px; color: #a78bfa;">Accuracy</div>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar">

          <div class="sidebar-section" style="margin-bottom: 15px;">
            <button class="sidebar-item" onclick="switchTab('allInOne')" style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; font-weight: bold; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4);">
              <span style="font-size: 16px;">  </span>
              <span id="allInOneBadge" class="leitner-due-badge" style="display: none; background: white; color: #c53030;">0</span>
            </button>
          </div>

          <div class="sidebar-section" style="margin-bottom: 15px;">
            <button class="sidebar-item" onclick="switchTab('dailyActivity')" style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: white; font-weight: bold; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 4px 15px rgba(56, 178, 172, 0.4);">
              <span style="font-size: 16px;"> Daily Activity</span>
              <span id="dailyActivityBadge" class="leitner-due-badge" style="display: none; background: white; color: #319795;">0</span>
            </button>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Flashcard Games</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('flashcardGames')"> Flashcard Games</button>
              <button class="sidebar-item" onclick="switchTab('masteryDeck')"> Mastery Deck <span id="masteryDeckBadge2" class="leitner-due-badge" style="display: none; background: #ffd700; color: #92400e;">0</span></button>

              <button class="sidebar-item" onclick="switchTab('leitnerBoxes')"> Calendar</button>
              <button class="sidebar-item" onclick="switchTab('leitnerStats')"> SRS Stats</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> My Flashcards</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('myFlashcards')"> My Cards & Folders</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Marketplace</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('marketplacePopular')"> Flashcard Marketplace</button>
              <button class="sidebar-item" onclick="switchTab('marketplaceCategories')"> Categories</button>
              <button class="sidebar-item" onclick="switchTab('myPurchases')"> My Purchases</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Leaderboards</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('studentLeaderboard')">View Rankings</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Grammar Evaluation</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('grammarDrill')"> Grammar Evaluation <span id="grammarLeitnerBadge" class="leitner-due-badge" style="display: none;">0</span></button>
              <button class="sidebar-item" onclick="switchTab('analytics')"> Analytics</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Pronunciation Evaluation</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('pronunciationDrills')"> Pronunciation Drills <span id="pronDrillsBadge" class="leitner-due-badge" style="display: none;">0</span></button>
              <button class="sidebar-item" onclick="switchTab('analytics2')"> Analytics</button>
            </div>
          </div>

          <div class="sidebar-section">
            <button class="sidebar-dropdown-header" onclick="toggleDropdown(this)">
              <span> Grammar Drill</span>
              <span class="dropdown-icon"></span>
            </button>
            <div class="sidebar-dropdown-content">
              <button class="sidebar-item" onclick="switchTab('availableGrammarTests')"> Available Tests <span id="availableGrammarTestsBadge" class="leitner-due-badge" style="display: none; background: #f59e0b;">0</span></button>
              <button class="sidebar-item" onclick="switchTab('grammarDrills')"> Grammar Drill <span id="grammarDrillsBadge" class="leitner-due-badge" style="display: none;">0</span></button>
              <button class="sidebar-item" onclick="switchTab('grammarAnalytics')"> Grammar Analytics</button>
            </div>
          </div>
        </div>

        <div class="main-content-area">

      <div id="dailyActivity" class="tab-content active">
        <div class="daily-activity-container">
          <div class="daily-activity-header">
            <h2 class="daily-activity-title">
              <span></span>
              <span>Daily Activity</span>
            </h2>
            <div style="color: var(--da-muted); font-size: 14px;">
              <span id="dailyActivityDate">Today</span> 
              <span id="dailyActivityDeadline">Deadline: 4:00 AM EST</span>
            </div>
          </div>

          <div class="daily-carousel-section" id="pronSection">
            <div class="sparkles" aria-hidden="true"></div>
            <div class="carousel-header">
              <h3 class="carousel-title">
                <span></span>
                <span>Daily Pronunciation Challenge</span>
              </h3>
              <div class="carousel-date" id="pronChallengeDate"></div>
            </div>

            <div class="da-teacher-card" id="pronTeacherCard">
              <div class="da-loading">
                <div class="loading"></div>
                <p>Loading today's challenge...</p>
              </div>
            </div>

            <div class="da-carousel-viewport" id="pronViewport" style="display: none;">
              <div class="da-carousel-track" id="pronTrack"></div>
            </div>

            <div class="da-carousel-controls" id="pronControls" style="display: none;">
              <button class="da-nav-btn" id="pronPrevBtn" type="button"> Prev</button>
              <div class="da-nav-counter" id="pronCounter">0 / 0</div>
              <button class="da-nav-btn" id="pronNextBtn" type="button">Next </button>
            </div>
          </div>

          <div class="daily-carousel-section teamwork-section" id="teamworkSection">
            <div class="sparkles" aria-hidden="true"></div>
            <div class="carousel-header">
              <h3 class="carousel-title">
                <span></span>
                <span>Teamwork Activity</span>
              </h3>
              <div class="da-nav-counter" id="teamworkStatus">
                <span id="teamworkStatusText">Loading...</span>
              </div>
            </div>

            <div class="da-teacher-card" id="teamworkInstructionsBanner" style="border-style: solid; border-color: rgba(72, 187, 120, 0.3); background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 178, 172, 0.08));">
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="font-size: 28px;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--da-text); margin-bottom: 8px;">How Teamwork Activity Works:</div>
                  <ol style="margin: 0; padding-left: 20px; color: var(--da-muted); font-size: 13px; line-height: 1.8;">
                    <li><strong style="color: var(--da-text);">Step 1:</strong> Record a VIDEO question in Korean for a classmate</li>
                    <li><strong style="color: var(--da-text);">Step 2:</strong> A random classmate answers with AUDIO and asks you a question back</li>
                    <li><strong style="color: var(--da-text);">Step 3:</strong> You respond with AUDIO to complete the conversation!</li>
                  </ol>
                  <div style="margin-top: 10px; padding: 8px 12px; background: rgba(72, 187, 120, 0.15); border-radius: 8px; font-size: 12px; color: #68d391;">
                     AI will check your Korean and suggest improvements before you submit!
                  </div>
                </div>
                <button onclick="hideTeamworkInstructions()" style="background: rgba(255,255,255,0.1); border: none; color: var(--da-muted); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px;"></button>
              </div>
            </div>

            <div id="teamworkContainer" style="position: relative; z-index: 2;">

              <div id="teamworkEmpty" style="display: none;">
                <div class="da-empty-state" style="padding: 50px 20px;">
                  <div class="empty-icon"></div>
                  <h4 style="color: var(--da-text); margin: 12px 0 8px; font-weight: 700;">Start a Teamwork Conversation!</h4>
                  <p style="margin-bottom: 16px;">Record a video question in Korean for a random classmate to answer.</p>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px;">
                    <span class="da-stat-badge">  ?</span>
                    <span class="da-stat-badge">  ?</span>
                    <span class="da-stat-badge">   ?</span>
                  </div>
                  <button onclick="openTeamworkRecorder('start')" class="da-record-btn" style="max-width: 280px; margin: 0 auto;">
                     Record Video Question
                  </button>
                </div>
              </div>

              <div id="teamworkWaiting" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: center;">
                  <div class="da-teacher-card" id="teamworkMyQuestionCard" style="border-style: solid;">

                  </div>
                  <div class="da-empty-state" style="padding: 30px;">
                    <div style="font-size: 40px; animation: da-floaty 2s ease-in-out infinite;"></div>
                    <h4 style="color: var(--da-text); margin: 12px 0 8px;">Waiting for a Classmate</h4>
                    <p>Your question is visible to other students. Someone will answer soon!</p>
                  </div>
                </div>
              </div>

              <div id="teamworkThread" style="display: none;">
                <div class="teamwork-thread-container" style="display: flex; flex-direction: column; gap: 12px;">

                </div>
              </div>

              <div id="teamworkRespond" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: center;">
                  <div class="da-teacher-card" id="teamworkQuestionCard" style="border-style: solid;">

                  </div>
                  <div class="da-empty-state" style="padding: 30px;">
                    <button onclick="openTeamworkRecorder('respond')" class="da-record-btn" style="max-width: 250px; margin: 0 auto 12px;">
                       Record Your Response
                    </button>
                    <p style="font-size: 13px;">Answer their question and ask one back!</p>
                  </div>
                </div>
              </div>

              <div id="teamworkCompleted" style="display: none;">
                <div class="da-empty-state" style="padding: 50px 20px;">
                  <div style="font-size: 48px; margin-bottom: 15px;"></div>
                  <h4 style="color: var(--da-text); margin-bottom: 8px;">Great Teamwork!</h4>
                  <p style="margin-bottom: 20px;">You've completed today's conversation. Start a new one!</p>
                  <button onclick="openTeamworkRecorder('start')" class="da-record-btn" style="max-width: 280px; margin: 0 auto;">
                     Start New Conversation
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="teamworkRecorderModal" class="teamwork-modal" style="display: none;">
            <div class="teamwork-modal-content">
              <div class="teamwork-modal-header">
                <h3 id="teamworkRecorderTitle">Record Your Message</h3>
                <button onclick="closeTeamworkRecorder()" class="teamwork-close-btn"></button>
              </div>

              <div class="teamwork-modal-body">

                <div class="teamwork-modal-instructions" id="teamworkModalInstructions">
                  <p>Speak clearly in Korean. Your recording will be transcribed automatically.</p>
                </div>

                <div class="teamwork-preview-area">
                  <video id="teamworkVideoPreview" autoplay muted playsinline style="display: none;"></video>
                  <div id="teamworkAudioVisualizer" style="display: none;">
                    <div class="audio-wave"></div>
                    <div class="audio-wave"></div>
                    <div class="audio-wave"></div>
                    <div class="audio-wave"></div>
                    <div class="audio-wave"></div>
                  </div>
                  <div id="teamworkRecordingTimer" class="recording-timer">0:00</div>
                </div>

                <div class="teamwork-controls">
                  <button id="teamworkRecordBtn" onclick="toggleTeamworkRecording()" class="teamwork-record-btn">
                    <span class="record-icon"></span>
                    <span id="teamworkRecordText">Start Recording</span>
                  </button>
                </div>

                <div id="teamworkTranscriptionSection" style="display: none;">
                  <div class="teamwork-transcription-box">
                    <label> Your Korean Transcription:</label>
                    <div id="teamworkTranscriptionText" class="transcription-display"></div>
                  </div>

                  <div class="teamwork-correction-box">
                    <label> AI Correction & Suggestions:</label>
                    <div id="teamworkCorrectionText" class="correction-display">
                      <div class="correction-loading">Analyzing your Korean...</div>
                    </div>
                  </div>

                  <div class="teamwork-action-buttons">
                    <button onclick="rerecordTeamwork()" class="btn btn-secondary">
                       Re-record
                    </button>
                    <button onclick="submitTeamworkEntry()" class="btn teamwork-submit-btn" id="teamworkSubmitBtn" disabled>
                       Submit
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="daily-carousel-section kpop-section" id="kpopSection">
            <div class="sparkles" aria-hidden="true"></div>
            <div class="carousel-header">
              <h3 class="carousel-title">
                <span></span>
                <span>Kpop/Kdrama Corner</span>
              </h3>
              <div class="da-nav-counter" id="kpopStatus">
                <span id="kpopStatusText">Loading...</span>
              </div>
            </div>

            <div class="da-teacher-card" id="kpopInstructionsBanner" style="border-style: solid; border-color: rgba(236, 72, 153, 0.3); background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(167, 139, 250, 0.08));">
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="font-size: 28px;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--da-text); margin-bottom: 8px;">Share Your Favorite Korean Media!</div>
                  <ol style="margin: 0; padding-left: 20px; color: var(--da-muted); font-size: 13px; line-height: 1.8;">
                    <li><strong style="color: var(--da-text);">Record:</strong> Capture a clip from your favorite Kpop song or Kdrama</li>
                    <li><strong style="color: var(--da-text);">Repeat:</strong> Say the Korean phrase out loud</li>
                    <li><strong style="color: var(--da-text);">Explain:</strong> Tell us what it means in English!</li>
                  </ol>
                  <div style="margin-top: 10px; padding: 8px 12px; background: rgba(236, 72, 153, 0.15); border-radius: 8px; font-size: 12px; color: #f687b3;">
                     React and comment on your classmates' posts!
                  </div>
                </div>
                <button onclick="hideKpopInstructions()" style="background: rgba(255,255,255,0.1); border: none; color: var(--da-muted); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px;"></button>
              </div>
            </div>

            <div id="kpopContainer" style="position: relative; z-index: 2;">

              <div id="kpopCreateSection" style="margin-bottom: 16px;">
                <button onclick="openKpopRecorder()" class="da-record-btn" style="max-width: 300px;">
                  <span></span>
                  <span>Share Your Favorite Clip</span>
                </button>
              </div>

              <div id="kpopFeed" class="da-carousel-viewport" style="padding: 12px; min-height: 120px;">
                <div class="da-loading">
                  <div class="loading"></div>
                  <p>Loading posts...</p>
                </div>
              </div>
            </div>
          </div>

          <div id="kpopRecorderModal" class="kpop-modal" style="display: none;">
            <div class="kpop-modal-content">
              <div class="kpop-modal-header">
                <h3> Share Your Kpop/Kdrama Clip</h3>
                <button onclick="closeKpopRecorder()" class="kpop-close-btn"></button>
              </div>

              <div class="kpop-modal-body">

                <div class="kpop-step" id="kpopStep1">
                  <div class="step-header">
                    <span class="step-number">1</span>
                    <span class="step-title">Record a clip from your favorite Kpop/Kdrama</span>
                  </div>
                  <div class="step-content">
                    <p class="step-instruction">Play your favorite scene/song and record it with your phone. You can record your screen or film your TV/computer.</p>
                    <div class="kpop-video-preview-area">
                      <video id="kpopVideoPreview" autoplay muted playsinline></video>
                      <div id="kpopRecordingIndicator" class="recording-indicator" style="display: none;">
                        <span class="rec-dot"></span>
                        <span id="kpopRecordingTime">0:00</span>
                      </div>
                    </div>
                    <div class="kpop-record-controls">
                      <button id="kpopStartRecordBtn" onclick="startKpopRecording()" class="btn kpop-record-btn">
                        <span></span> Start Recording
                      </button>
                      <button id="kpopStopRecordBtn" onclick="stopKpopRecording()" class="btn kpop-stop-btn" style="display: none;">
                        <span></span> Stop Recording
                      </button>
                    </div>
                  </div>
                </div>

                <div class="kpop-step" id="kpopStep2" style="display: none;">
                  <div class="step-header">
                    <span class="step-number">2</span>
                    <span class="step-title">Repeat the Korean phrase</span>
                  </div>
                  <div class="step-content">
                    <p class="step-instruction">Now record yourself saying the Korean phrase from the clip!</p>
                    <div class="kpop-audio-area">
                      <div id="kpopAudioVisualizer" class="audio-visualizer">
                        <div class="audio-wave"></div>
                        <div class="audio-wave"></div>
                        <div class="audio-wave"></div>
                        <div class="audio-wave"></div>
                        <div class="audio-wave"></div>
                      </div>
                      <div id="kpopAudioTimer" class="audio-timer">0:00</div>
                    </div>
                    <div class="kpop-audio-controls">
                      <button id="kpopStartAudioBtn" onclick="startKpopAudioRecording()" class="btn kpop-audio-btn">
                        <span></span> Record Your Voice
                      </button>
                      <button id="kpopStopAudioBtn" onclick="stopKpopAudioRecording()" class="btn kpop-stop-btn" style="display: none;">
                        <span></span> Stop
                      </button>
                    </div>
                    <div id="kpopTranscriptionResult" class="transcription-result" style="display: none;">
                      <label> Your Korean (auto-transcribed):</label>
                      <div id="kpopTranscriptionText" class="transcription-text"></div>
                    </div>
                  </div>
                </div>

                <div class="kpop-step" id="kpopStep3" style="display: none;">
                  <div class="step-header">
                    <span class="step-number">3</span>
                    <span class="step-title">Explain what it means</span>
                  </div>
                  <div class="step-content">
                    <p class="step-instruction">Tell us what the phrase means in English and any context!</p>
                    <textarea id="kpopExplanationInput" class="kpop-explanation-input" placeholder="Example: This means 'I love you' - the character says this when confessing their feelings..."></textarea>
                    <div class="kpop-category-select">
                      <label>Category:</label>
                      <select id="kpopCategorySelect">
                        <option value="kpop"> Kpop Song</option>
                        <option value="kdrama"> Kdrama</option>
                        <option value="variety"> Variety Show</option>
                        <option value="movie"> Korean Movie</option>
                        <option value="other"> Other</option>
                      </select>
                    </div>
                    <div class="kpop-source-input">
                      <label>Source (optional):</label>
                      <input type="text" id="kpopSourceInput" placeholder="e.g., BTS - Dynamite, Crash Landing on You Ep 5">
                    </div>
                  </div>
                </div>

                <div class="kpop-submit-section" id="kpopSubmitSection" style="display: none;">
                  <button onclick="rerecordKpop()" class="btn btn-secondary">
                     Start Over
                  </button>
                  <button onclick="submitKpopPost()" class="btn kpop-submit-btn" id="kpopSubmitBtn">
                     Share Post
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="kpopCommentModal" class="kpop-modal" style="display: none;">
            <div class="kpop-modal-content kpop-comment-modal-content">
              <div class="kpop-modal-header">
                <h3> Comments</h3>
                <button onclick="closeKpopCommentModal()" class="kpop-close-btn"></button>
              </div>
              <div class="kpop-modal-body">
                <div id="kpopCommentsList" class="kpop-comments-list">

                </div>
                <div class="kpop-comment-input-area">
                  <input type="text" id="kpopCommentInput" placeholder="Add a comment in Korean or English..." maxlength="200">
                  <button onclick="submitKpopComment()" class="btn kpop-comment-submit-btn">Send</button>
                </div>
              </div>
            </div>
          </div>

          <div class="daily-carousel-section grammar-blabber-section" id="grammarSection">
            <div class="sparkles" aria-hidden="true"></div>
            <div class="carousel-header">
              <h3 class="carousel-title">
                <span></span>
                <span>Grammar Blabber</span>
              </h3>
              <div class="da-nav-counter" id="grammarBlabberStatus">
                <span id="grammarBlabberStatusText">Loading...</span>
              </div>
            </div>

            <div id="grammarDayIndicator" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; position: relative; z-index: 2;">
              <div id="grammarDayBadge" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15)); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 20px; font-weight: 700; font-size: 13px; color: #fbbf24;">Monday</div>
              <div id="grammarActivityType" style="color: var(--da-muted); font-size: 13px;">Conjugation Practice</div>
            </div>

            <div class="da-teacher-card has-content" id="grammarTeacherCard" style="margin-bottom: 16px;">
              <div class="da-teacher-header">
                <div class="da-teacher-avatar"></div>
                <div class="da-teacher-info">
                  <div class="da-teacher-label">Today's Grammar</div>
                  <p class="da-teacher-name" id="grammarTeacherTitle">Loading...</p>
                </div>
              </div>

              <div class="da-script-preview" id="grammarExplanationText" style="margin-bottom: 12px;">
                <div class="da-loading">
                  <div class="loading"></div>
                  <p>Loading grammar activity...</p>
                </div>
              </div>

              <div id="grammarTeacherVideoContainer" style="display: none; margin-bottom: 12px;">
                <video id="grammarTeacherVideo" controls style="width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);"></video>
              </div>

              <button onclick="openGrammarRecorder()" class="da-record-btn" id="grammarPracticeBtn">
                 Practice This Grammar
              </button>
            </div>

            <div class="da-carousel-viewport" id="grammarViewport" style="display: none;">
              <div class="da-carousel-track" id="grammarTrack"></div>
            </div>

            <div class="da-carousel-controls" id="grammarControls" style="display: none;">
              <button class="da-nav-btn" id="grammarPrevBtn" type="button"> Prev</button>
              <div class="da-nav-counter" id="grammarCounter">0 / 0</div>
              <button class="da-nav-btn" id="grammarNextBtn" type="button">Next </button>
            </div>

            <div id="grammarRecorderModal" class="grammar-modal" style="display: none;">
              <div class="grammar-modal-content" style="background: rgba(8,10,25,.95); border: 1px solid rgba(255,255,255,.14); border-radius: 20px;">
                <div class="grammar-modal-header" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15)); padding: 20px; border-radius: 20px 20px 0 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <h3 id="grammarRecorderTitle" style="color: var(--da-text); margin: 0;">Grammar Practice</h3>
                  <button onclick="closeGrammarRecorder()" style="background: rgba(255,255,255,0.1); border: none; color: var(--da-muted); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px;"></button>
                </div>
                <div class="grammar-modal-body" style="padding: 20px;">

                  <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #fbbf24; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Today's Challenge:</div>
                    <div id="grammarPromptText" style="font-size: 16px; color: var(--da-text); line-height: 1.6;"></div>
                    <div id="grammarPromptHint" style="font-size: 13px; color: var(--da-muted); margin-top: 8px;"></div>
                  </div>

                  <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 20px;">
                    <div id="grammarAudioVisualizer" style="display: flex; justify-content: center; gap: 4px; height: 40px; align-items: center; margin-bottom: 12px;">
                      <div class="audio-wave" style="width: 4px; height: 20px; background: #fbbf24; border-radius: 2px;"></div>
                      <div class="audio-wave" style="width: 4px; height: 30px; background: #fbbf24; border-radius: 2px;"></div>
                      <div class="audio-wave" style="width: 4px; height: 25px; background: #fbbf24; border-radius: 2px;"></div>
                      <div class="audio-wave" style="width: 4px; height: 35px; background: #fbbf24; border-radius: 2px;"></div>
                      <div class="audio-wave" style="width: 4px; height: 20px; background: #fbbf24; border-radius: 2px;"></div>
                    </div>
                    <div id="grammarRecordTimer" style="font-size: 24px; font-weight: 700; color: var(--da-text);">0:00</div>
                  </div>

                  <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;">
                    <button id="grammarStartRecordBtn" onclick="startGrammarRecording()" class="da-record-btn" style="max-width: 200px;">
                       Start Recording
                    </button>
                    <button id="grammarStopRecordBtn" onclick="stopGrammarRecording()" class="da-nav-btn" style="display: none; background: rgba(248,113,113,0.2); border-color: rgba(248,113,113,0.3); color: #f87171;">
                       Stop Recording
                    </button>
                  </div>

                  <div id="grammarTranscriptionSection" style="display: none;">
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                      <label style="font-size: 12px; color: var(--da-muted); display: block; margin-bottom: 8px;"> Your Korean:</label>
                      <div id="grammarTranscriptionText" style="font-size: 16px; color: var(--da-text); line-height: 1.6;"></div>
                    </div>

                    <div id="grammarFeedbackBox" style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(167,139,250,0.08)); border: 1px solid rgba(139,92,246,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                      <div class="grammar-feedback-loading" style="color: var(--da-muted);"> Checking your grammar...</div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center;">
                      <button onclick="rerecordGrammar()" class="da-nav-btn"> Try Again</button>
                      <button onclick="submitGrammarResponse()" class="da-record-btn" id="grammarSubmitBtn" disabled style="max-width: 150px;"> Submit</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="dailyVocabTooltip" class="vocab-save-tooltip" style="display: none;">
        <div class="tooltip-title">Save to Vocabulary</div>
        <button onclick="saveDailyVocabWord()">
           Add to Basic Test Vocab
        </button>
      </div>

      <div class="da-hall-overlay" id="daHallPopup" aria-hidden="true">
        <div class="glitter" aria-hidden="true"></div>
        <button class="da-hall-close-btn" onclick="closeHallOfFame()" aria-label="Close Hall of Fame"></button>
        <div class="da-hall-content">
          <div class="da-hall-top">
            <div class="da-hall-title">
              <strong> Hall of Fame</strong>
              <span id="daHallSubtitle">Drop or click a student to jump.</span>
            </div>
            <div class="da-hall-hint">Drop  or Click</div>
          </div>
          <div class="da-hall-grid" id="daHallGrid" role="list"></div>
        </div>
      </div>

      <div id="allInOne" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 36px;"></span>
          <span>  <span style="font-size: 16px; color: #718096; font-weight: normal;">(All at Once)</span></span>
        </h2>

        <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7e2 100%); border: 2px solid #f56565; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
          <p style="color: #742a2a; margin: 0; font-size: 16px;">
             <strong>Complete all your daily practice in one session!</strong> This combines your pronunciation drills, grammar drills, and flashcard reviews into a single focused session.
          </p>
        </div>

        <div id="allInOneContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div class="loading"></div>
            <p>Loading your daily tasks...</p>
          </div>
        </div>
      </div>

      <div id="availableTests" class="tab-content">
        <h2>Available Tests</h2>
        <div id="studentTestsList"></div>
      </div>

      <div id="mySubmissions" class="tab-content">
        <h2>My Submissions</h2>
        <div id="studentSubmissionsList"></div>
      </div>

      <div id="feedback" class="tab-content">
        <h2>My Feedback</h2>
        <div id="studentFeedbackList"></div>
      </div>

      <div id="availableTests2" class="tab-content">
        <h2>Available Tests2</h2>
        <div id="studentTestsList2"></div>
      </div>

      <div id="mySubmissions2" class="tab-content">
        <h2>My Submissions2</h2>
        <div id="studentSubmissionsList2"></div>
      </div>

      <div id="feedback2" class="tab-content">
        <h2>My Feedback2</h2>
        <p style="background: #fef5e7; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #7a5c1a; border-left: 4px solid #f39c12;">
           <strong>Organized by Test:</strong> Feedback is grouped by test name, making it easy to track your progress on specific assessments.
        </p>
        <div id="studentFeedbackList2"></div>
      </div>

      <div id="analytics2" class="tab-content">

        <button id="mobileAnalytics2Back" class="mobile-only" onclick="mobileNavTo('pronunciationDrills')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Pronunciation Drills
        </button>

        <div id="analytics2StudentSelector" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <label for="analytics2StudentSelect" style="margin-right: 10px; font-weight: bold; font-size: 16px;">Select Student:</label>
          <select id="analytics2StudentSelect" onchange="loadAnalytics2()" style="padding: 8px 12px; font-size: 16px; border-radius: 5px; border: 2px solid #ff6b6b; min-width: 250px;">
            <option value="">-- Choose a student --</option>
          </select>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button id="analytics2Level1Btn" onclick="showAnalyticsLevel(1)" class="btn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600;">
             Level 1: Consonant Aspirations
          </button>
          <button id="analytics2Level2Btn" onclick="showAnalyticsLevel(2)" class="btn" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Level 2: Consonant Assimilation
          </button>
        </div>

        <div id="analytics2Level1Section" class="analytics-container">

          <div class="analytics-summary">
            <h2> Level 1: Consonant Aspirations Analytics</h2>
            <div class="summary-cards">
              <div class="summary-card">
                <h3>Overall Improvement</h3>
                <div class="summary-value" id="overallImprovement2">-</div>
                <div class="summary-details" id="overallDetails2">Calculating...</div>
              </div>
              <div class="summary-card">
                <h3>1 Month Progress</h3>
                <div class="summary-value" id="monthlyImprovement2">-</div>
                <div class="summary-details" id="monthlyDetails2">Calculating...</div>
              </div>
              <div class="summary-card">
                <h3>All-Time Progress</h3>
                <div class="summary-value" id="allTimeImprovement2">-</div>
                <div class="summary-details" id="allTimeDetails2">Calculating...</div>
              </div>
            </div>
          </div>

          <div class="analytics-charts">
            <div class="chart-container">
              <h3> Performance by Topic</h3>
              <div class="chart-wrapper">
                <canvas id="topicChart2"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3> Progress Over Time</h3>
              <div class="chart-wrapper">
                <canvas id="progressChart2"></canvas>
              </div>
            </div>
          </div>

          <div class="topic-improvements" id="topicImprovements2">
            <h3> Topic-by-Topic Analysis</h3>
            <div class="filter-buttons" style="margin: 15px 0; display: flex; gap: 10px;">
              <button class="btn filter-btn active" onclick="filterTopics2('all', event)" style="padding: 8px 16px; font-size: 14px;">All Topics</button>
              <button class="btn filter-btn" onclick="filterTopics2('needs-work', event)" style="padding: 8px 16px; font-size: 14px; background: #f56565;">Needs Work</button>
              <button class="btn filter-btn" onclick="filterTopics2('recent', event)" style="padding: 8px 16px; font-size: 14px; background: #ed8936;">Recent</button>
              <button class="btn filter-btn" onclick="filterTopics2('exceptional', event)" style="padding: 8px 16px; font-size: 14px; background: #48bb78;">Exceptional</button>
            </div>
            <div id="topicDetailsList2"></div>
          </div>
        </div>

        <div id="analytics2Level2Section" class="analytics-container" style="display: none;">

          <div class="analytics-summary">
            <h2 style="color: #6b46c1;"> Level 2: Consonant Assimilation Analytics</h2>
            <div class="summary-cards">
              <div class="summary-card" style="border-color: #9f7aea;">
                <h3>Overall Score</h3>
                <div class="summary-value" id="level2OverallScore">-</div>
                <div class="summary-details" id="level2OverallDetails">Calculating...</div>
              </div>
              <div class="summary-card" style="border-color: #9f7aea;">
                <h3>Rules Mastered</h3>
                <div class="summary-value" id="level2RulesMastered">-</div>
                <div class="summary-details" id="level2MasteredDetails">Score 4/4</div>
              </div>
              <div class="summary-card" style="border-color: #9f7aea;">
                <h3>Needs Practice</h3>
                <div class="summary-value" id="level2NeedsPractice">-</div>
                <div class="summary-details" id="level2PracticeDetails">Score 1-3</div>
              </div>
            </div>
          </div>

          <div class="analytics-charts">
            <div class="chart-container">
              <h3 style="color: #6b46c1;"> Performance by Assimilation Rule</h3>
              <div class="chart-wrapper">
                <canvas id="level2RuleChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3 style="color: #6b46c1;"> Rule Categories</h3>
              <div class="chart-wrapper">
                <canvas id="level2CategoryChart"></canvas>
              </div>
            </div>
          </div>

          <div class="topic-improvements" id="level2RuleImprovements">
            <h3 style="color: #6b46c1;"> Rule-by-Rule Analysis</h3>
            <div class="filter-buttons" style="margin: 15px 0; display: flex; gap: 10px;">
              <button class="btn filter-btn active" onclick="filterLevel2Rules('all', event)" style="padding: 8px 16px; font-size: 14px; background: #9f7aea;">All Rules</button>
              <button class="btn filter-btn" onclick="filterLevel2Rules('needs-work', event)" style="padding: 8px 16px; font-size: 14px; background: #f56565;">Needs Work (1-2)</button>
              <button class="btn filter-btn" onclick="filterLevel2Rules('improving', event)" style="padding: 8px 16px; font-size: 14px; background: #ed8936;">Improving (3-4)</button>
              <button class="btn filter-btn" onclick="filterLevel2Rules('mastered', event)" style="padding: 8px 16px; font-size: 14px; background: #48bb78;">Mastered (5)</button>
            </div>
            <div id="level2RuleDetailsList"></div>
          </div>
        </div>
      </div>

      <div id="mobileHome" class="tab-content">
        <div class="mobile-home-container" style="padding: 20px; min-height: calc(100vh - 140px); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">

          <div style="text-align: center; margin-bottom: 30px; padding-top: 20px;">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <h1 style="color: white; font-size: 28px; margin: 0 0 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">Welcome to KoreaLand!</h1>
            <p style="color: #a0aec0; font-size: 14px; margin: 0;">Click an activity to get started</p>
          </div>

          <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">

            <button onclick="mobileNavTo('dailyActivity')" style="display: flex; align-items: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, rgba(56, 178, 172, 0.2), rgba(49, 151, 149, 0.15)); border: 2px solid rgba(56, 178, 172, 0.4); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #38b2ac, #319795); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="color: white; font-size: 16px; font-weight: 700; margin-bottom: 4px;">Daily Activity</div>
                <div style="color: #81e6d9; font-size: 12px;">Complete your daily pronunciation & teamwork challenges</div>
              </div>
              <div style="color: #81e6d9; font-size: 20px;"></div>
            </button>

            <button onclick="mobileNavTo('grammarDrills')" style="display: flex; align-items: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15)); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="color: white; font-size: 16px; font-weight: 700; margin-bottom: 4px;">Grammar Drill</div>
                <div style="color: #b794f4; font-size: 12px;">Test your Korean grammar knowledge</div>
              </div>
              <div style="color: #b794f4; font-size: 20px;"></div>
            </button>

            <button onclick="mobileNavTo('pronunciationDrills')" style="display: flex; align-items: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, rgba(237, 137, 54, 0.2), rgba(221, 107, 32, 0.15)); border: 2px solid rgba(237, 137, 54, 0.4); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ed8936, #dd6b20); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="color: white; font-size: 16px; font-weight: 700; margin-bottom: 4px;">Pronunciation Drill</div>
                <div style="color: #fbd38d; font-size: 12px;">Practice your Korean pronunciation</div>
              </div>
              <div style="color: #fbd38d; font-size: 20px;"></div>
            </button>

            <button onclick="mobileNavTo('grammarDrill')" style="display: flex; align-items: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.15)); border: 2px solid rgba(72, 187, 120, 0.4); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #48bb78, #38a169); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="color: white; font-size: 16px; font-weight: 700; margin-bottom: 4px;">Grammar Evaluation</div>
                <div style="color: #9ae6b4; font-size: 12px;">Practice grammar with interactive exercises</div>
              </div>
              <div style="color: #9ae6b4; font-size: 20px;"></div>
            </button>

          </div>

          <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="text-align: center; color: #a0aec0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">Today's Progress</div>
            <div style="display: flex; justify-content: space-around;">
              <div style="text-align: center;">
                <div id="mobileHomeDailyCoins" style="color: #ffd700; font-size: 28px; font-weight: bold;">0</div>
                <div style="color: #718096; font-size: 11px;"> Coins Earned</div>
              </div>
              <div style="text-align: center;">
                <div id="mobileHomeDailyActivities" style="color: #68d391; font-size: 28px; font-weight: bold;">0</div>
                <div style="color: #718096; font-size: 11px;"> Activities</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="pronunciationDrills" class="tab-content">

        <button id="mobilePronunciationAnalytics" class="mobile-only" onclick="mobileNavTo('analytics2')" style="display: none; margin-bottom: 15px; padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
           Analytics
        </button>

        <h2> Pronunciation Drills</h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Practice pronunciation based on your evaluation scores. The more you drill, the better your pronunciation!
        </p>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button id="pronDrillsViewBtn" onclick="switchPronDrillView('drills')" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600;">
             Active Drills
          </button>
          <button id="pronCalendarViewBtn" onclick="switchPronDrillView('calendar')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Calendar
          </button>
          <button id="pronStatsViewBtn" onclick="switchPronDrillView('stats')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Stats
          </button>
          <button id="pronAvailableTestsViewBtn" onclick="switchPronDrillView('availableTests')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Available Tests
          </button>
        </div>

        <div id="pronunciationDrillsContainer">
          <div class="loading"></div>
        </div>

        <div id="pronunciationCalendarContainer" style="display: none;">
          <div class="loading"></div>
        </div>

        <div id="pronunciationStatsContainer" style="display: none;">
          <div class="loading"></div>
        </div>

        <div id="pronunciationAvailableTestsContainer" style="display: none;">
          <div class="loading"></div>
        </div>
      </div>

      <div id="availableGrammarTests" class="tab-content">

        <button id="mobileAvailableTestsBack" class="mobile-only" onclick="mobileNavTo('grammarDrills')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Grammar Drill
        </button>

        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Available Grammar Tests</span>
        </h2>

        <p style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #92400e; border-left: 4px solid #f59e0b;">
           <strong>Take a Grammar Test:</strong> Complete these evaluations to receive personalized drill assignments based on your scores.
        </p>

        <div id="availableGrammarTestsContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div class="loading"></div>
            <p>Loading available tests...</p>
          </div>
        </div>
      </div>

      <div id="takeGrammarTest" class="tab-content">
        <div id="grammarTestInterface">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <p>Select a test to begin...</p>
          </div>
        </div>
      </div>

      <div id="grammarDrills" class="tab-content">

        <div id="mobileGrammarDrillsNav" class="mobile-only" style="display: none; gap: 10px; margin-bottom: 15px;">
          <button onclick="mobileNavTo('grammarAnalytics')" style="flex: 1; padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 13px; cursor: pointer;">
             Analytics
          </button>
          <button onclick="mobileNavTo('availableGrammarTests')" style="flex: 1; padding: 12px 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 13px; cursor: pointer;">
             Available Tests
          </button>
        </div>

        <h2 style="display: flex; align-items: center; gap: 15px;">
          <span></span>
          <span>Grammar Drill</span>
        </h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Practice grammar based on your evaluation scores. Master sentence patterns through repetition!
        </p>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button id="grammarDrillsViewBtn" onclick="switchGrammarDrillView('drills')" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); font-weight: 600; color: white;">
             Active Drills
          </button>
          <button id="grammarJunbiViewBtn" onclick="switchGrammarDrillView('junbi')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             JUNBI (Practice)
          </button>
          <button id="grammarCalendarViewBtn" onclick="switchGrammarDrillView('calendar')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Calendar
          </button>
          <button id="grammarStatsViewBtn" onclick="switchGrammarDrillView('stats')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Stats
          </button>
        </div>

        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #f59e0b; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div>
            <strong style="color: #92400e; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;"></span> Walk-Away Mode
            </strong>
            <p style="font-size: 12px; color: #78350f; margin-top: 5px;">
              Hands-free practice: Hear English  Speak Korean  Say "yes" to continue
            </p>
          </div>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <span style="font-size: 14px; color: #92400e;">OFF</span>
            <div style="position: relative; width: 60px; height: 30px;">
              <input type="checkbox" id="grammarWalkAwayToggle" onchange="toggleGrammarWalkAwayMode()" style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e0; transition: 0.4s; border-radius: 30px;"></span>
              <span id="grammarWalkAwaySlider" style="position: absolute; content: ''; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
            </div>
            <span style="font-size: 14px; color: #92400e;">ON</span>
          </label>
        </div>

        <div id="grammarDrillsContainer">
          <div style="text-align: center; padding: 60px 20px; color: #718096;">
            <div style="font-size: 80px; margin-bottom: 20px;"></div>
            <h3 style="color: #4a5568; margin-bottom: 10px;">No Grammar Drills Yet</h3>
            <p>Once your teacher grades your grammar evaluations, your drill assignments will appear here.</p>
            <p style="margin-top: 15px; font-size: 14px;">Each topic requires 5 repetitions per day for 7 days to complete.</p>
          </div>
        </div>

        <div id="grammarJunbiContainer" style="display: none;">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Select a drill to practice in JUNBI mode</p>
          </div>
        </div>

        <div id="grammarCalendarContainer" style="display: none;">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading calendar...</p>
          </div>
        </div>

        <div id="grammarStatsContainer" style="display: none;">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading stats...</p>
          </div>
        </div>
      </div>

      <div id="grammarAnalytics" class="tab-content">

        <button id="mobileGrammarAnalyticsBack" class="mobile-only" onclick="mobileNavTo('grammarDrills')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Grammar Drill
        </button>

        <h2 style="display: flex; align-items: center; gap: 15px;">
          <span></span>
          <span>Grammar Analytics</span>
        </h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Track your grammar progress and see which topics need more practice.
        </p>
        <div id="grammarAnalyticsContainer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <div style="font-size: 50px; margin-bottom: 15px;"></div>
            <p>Loading analytics...</p>
          </div>
        </div>
      </div>

      <div id="analytics" class="tab-content">

        <button id="mobileAnalyticsBack" class="mobile-only" onclick="mobileNavTo('grammarDrill')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Grammar Evaluation
        </button>

        <div class="analytics-container">

          <div class="analytics-summary">
            <h2> Your Performance Analytics</h2>
            <div class="summary-cards">
              <div class="summary-card">
                <h3>Overall Improvement</h3>
                <div class="summary-value" id="overallImprovement">-</div>
                <div class="summary-details" id="overallDetails">Calculating...</div>
              </div>
              <div class="summary-card">
                <h3>1 Month Progress</h3>
                <div class="summary-value" id="monthlyImprovement">-</div>
                <div class="summary-details" id="monthlyDetails">Calculating...</div>
              </div>
              <div class="summary-card">
                <h3>All-Time Progress</h3>
                <div class="summary-value" id="allTimeImprovement">-</div>
                <div class="summary-details" id="allTimeDetails">Calculating...</div>
              </div>
            </div>
          </div>

          <div class="analytics-charts">
            <div class="chart-container">
              <h3> Performance by Topic</h3>
              <div class="chart-wrapper">
                <canvas id="topicChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3> Progress Over Time</h3>
              <div class="chart-wrapper">
                <canvas id="progressChart"></canvas>
              </div>
            </div>
          </div>

          <div class="topic-improvements" id="topicImprovements">
            <h3> Topic-by-Topic Analysis</h3>
            <div class="filter-buttons" style="margin: 15px 0; display: flex; gap: 10px;">
              <button class="btn filter-btn active" onclick="filterTopics('all', event)" style="padding: 8px 16px; font-size: 14px;">All Topics</button>
              <button class="btn filter-btn" onclick="filterTopics('needs-work', event)" style="padding: 8px 16px; font-size: 14px; background: #f56565;">Needs Work</button>
              <button class="btn filter-btn" onclick="filterTopics('recent', event)" style="padding: 8px 16px; font-size: 14px; background: #ed8936;">Recent</button>
              <button class="btn filter-btn" onclick="filterTopics('exceptional', event)" style="padding: 8px 16px; font-size: 14px; background: #48bb78;">Exceptional</button>
            </div>
            <div id="topicDetailsList"></div>
          </div>
        </div>
      </div>

      <div id="grammarDrill" class="tab-content">

        <button id="mobileGrammarDrillAnalytics" class="mobile-only" onclick="mobileNavTo('analytics')" style="display: none; margin-bottom: 15px; padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
           Analytics
        </button>

        <h2> Grammar Evaluation</h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Practice grammar based on your evaluation scores. The more you drill, the better your grammar!
        </p>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button id="grammarDrillsViewBtn" onclick="switchGrammarDrillView('drills')" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600;">
             Active Drills
          </button>
          <button id="grammarCalendarViewBtn" onclick="switchGrammarDrillView('calendar')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Calendar
          </button>
          <button id="grammarStatsViewBtn" onclick="switchGrammarDrillView('stats')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Stats
          </button>
          <button id="grammarAvailableTestsViewBtn" onclick="switchGrammarDrillView('availableTests')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Available Tests
          </button>
          <button id="grammarMasteryViewBtn" onclick="switchGrammarDrillView('mastery')" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; font-weight: 600;">
             Grammar Mastery
          </button>
        </div>

        <div id="grammarDrillsContainer">
          <div class="loading"></div>
        </div>

        <div id="grammarCalendarContainer" style="display: none;">
          <div class="loading"></div>
        </div>

        <div id="grammarStatsContainer" style="display: none;">
          <div class="loading"></div>
        </div>

        <div id="grammarAvailableTestsContainer" style="display: none;">
          <div class="loading"></div>
        </div>

        <div id="grammarMasteryContainer2" style="display: none;">
          <div class="loading"></div>
        </div>
      </div>

      <div id="grammarMastery" class="tab-content" style="display: none;">
      </div>

      <div id="grammarLeitner" class="tab-content" style="display: none;">
      </div>

      <div id="grammarCalendar" class="tab-content" style="display: none;">
      </div>

      <div id="grammarStats" class="tab-content" style="display: none;">
      </div>

      <div id="flashcardGames" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
          <h2 style="margin: 0;"> Flashcard Games</h2>
          <button onclick="openCreateFolderModal()" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
             Create Folder
          </button>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 250px; position: relative;">
            <input type="text" id="flashcardGamesSearch" placeholder=" Search folders and flashcard sets..."
              oninput="filterFlashcardGames(this.value)"
              style="width: 100%; padding: 12px 15px 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s;">
          </div>
          <button onclick="scrollToMyCards()" style="padding: 12px 20px; background: linear-gradient(135deg, #f6e05e 0%, #ecc94b 100%); border: 2px solid #d69e2e; color: #744210; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; white-space: nowrap; transition: all 0.3s;"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(214,158,46,0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
             Go to My Cards
          </button>
        </div>

        <div id="flashcardFoldersSection">
          <div class="fc-folder-grid" id="flashcardFoldersGrid">

          </div>
        </div>

        <div id="folderContentsView" style="display: none;">
          <div class="fc-folder-header">
            <button class="back-btn" onclick="closeFolderView()"></button>
            <span class="folder-title-icon" id="folderViewIcon"></span>
            <span class="folder-title" id="folderViewTitle">Folder Name</span>
          </div>
          <div id="folderContentsGrid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">

          </div>
        </div>

        <div id="unfiledFlashcardsSection" class="fc-unfiled-section">
          <h3> Unfiled Flashcard Sets</h3>
          <div id="availableFlashcards" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
            <div class="loading"></div>
          </div>
        </div>

        <div id="folderModal" class="fc-folder-modal" style="display: none;">
          <div class="fc-folder-modal-content">
            <h3 id="folderModalTitle"> Create New Folder</h3>
            <div class="form-group">
              <label>Folder Name</label>
              <input type="text" id="folderNameInput" placeholder="e.g., TOPIK Vocabulary, Food Words..." maxlength="50">
            </div>
            <div class="form-group">
              <label>Folder Color</label>
              <div class="fc-color-picker" id="folderColorPicker">
                <div class="fc-color-option selected" data-color="#667eea" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                <div class="fc-color-option" data-color="#48bb78" style="background: linear-gradient(135deg, #48bb78, #38a169);"></div>
                <div class="fc-color-option" data-color="#ed8936" style="background: linear-gradient(135deg, #ed8936, #dd6b20);"></div>
                <div class="fc-color-option" data-color="#f56565" style="background: linear-gradient(135deg, #f56565, #e53e3e);"></div>
                <div class="fc-color-option" data-color="#38b2ac" style="background: linear-gradient(135deg, #38b2ac, #319795);"></div>
                <div class="fc-color-option" data-color="#9f7aea" style="background: linear-gradient(135deg, #9f7aea, #805ad5);"></div>
                <div class="fc-color-option" data-color="#ed64a6" style="background: linear-gradient(135deg, #ed64a6, #d53f8c);"></div>
                <div class="fc-color-option" data-color="#4299e1" style="background: linear-gradient(135deg, #4299e1, #3182ce);"></div>
              </div>
            </div>
            <div class="modal-actions">
              <button class="cancel-btn" onclick="closeFolderModal()">Cancel</button>
              <button class="save-btn" id="saveFolderBtn" onclick="saveFolder()">Create Folder</button>
            </div>
          </div>
        </div>

        <div id="junbiPage" class="junbi-overlay" style="display: none;">

          <button id="junbiExitBtn" onclick="exitFlashcardGame()" style="position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff7777 0%, #dd3333 100%); border: 3px solid white; color: white; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 10001; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"></button>

          <img id="junbiCharacterOverlay" class="junbi-character" src="" alt="" style="display: none;">

          <div class="junbi-container">
            <div class="junbi-title"></div>
            <div class="junbi-subtitle">Get Ready! Study these words before the game begins.</div>

            <div class="wrinkled-paper" id="junbiPaper">
              <div class="paper-header">
                <h3> Word List</h3>
                <div class="deck-name" id="junbiDeckName">Flashcard Set</div>
              </div>

              <table class="word-list-table">
                <thead>
                  <tr>
                    <th style="width: 8%;">#</th>
                    <th style="width: 46%;">English</th>
                    <th style="width: 46%;">Korean</th>
                  </tr>
                </thead>
                <tbody id="junbiWordList">

                </tbody>
              </table>
            </div>

            <div id="flashcardModeToggle" style="margin: 8px 0; padding: 12px 15px; background: linear-gradient(135deg, rgba(240, 255, 244, 0.95) 0%, rgba(198, 246, 213, 0.95) 100%); border: 2px solid #48bb78; border-radius: 10px; text-align: center; z-index: 3; flex-shrink: 0;">
              <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 8px; flex-wrap: wrap;">
                <button id="flashcardVoiceModeBtn" onclick="setFlashcardMode('voice')" style="flex: 1; min-width: 80px; max-width: 120px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid transparent; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 11px;">
                   Voice
                </button>
                <button id="flashcardWalkAwayModeBtn" onclick="setFlashcardMode('walkaway')" style="flex: 1; min-width: 80px; max-width: 120px; padding: 8px 12px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 11px;">
                   Walk Away
                </button>
                <button id="flashcardSwipeModeBtn" onclick="setFlashcardMode('swipe')" style="flex: 1; min-width: 80px; max-width: 120px; padding: 8px 12px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 11px;">
                   Swipe
                </button>
              </div>
              <p id="flashcardModeDescription" style="color: #276749; font-size: 10px; margin: 4px 0 0 0;">
                Speak Korean words to earn full coins
              </p>

              <div id="englishVoiceSection" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #9ae6b4;">
                <label style="color: #276749; font-size: 10px; display: inline; margin-right: 5px;">
                   English Voice:
                </label>
                <select id="englishVoiceSelector" onchange="saveSelectedEnglishVoice()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #48bb78; font-size: 11px; background: white; color: #2d3748; min-width: 150px; cursor: pointer;">
                  <option value="">Loading voices...</option>
                </select>
                <button onclick="testEnglishVoice()" style="margin-left: 5px; padding: 4px 8px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 10px;">
                   Test
                </button>
              </div>
            </div>

            <div class="junbi-controls" style="z-index: 3;">
              <button class="junbi-btn fold-btn" onclick="togglePaperFold()">
                <span id="foldBtnIcon"></span>
                <span id="foldBtnText">Fold Paper</span>
              </button>
              <button class="junbi-btn continue-btn" onclick="startGameFromJunbi()">
                <span>!</span>
                <span>Continue </span>
              </button>
            </div>
          </div>
        </div>

        <div id="flashcardGameInterface" class="junbi-overlay" style="display: none;">

          <button onclick="exitFlashcardGame()" style="position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #ff7777 0%, #dd3333 100%); border: 2px solid white; color: white; font-size: 20px; font-weight: bold; cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"></button>

          <img id="gameCharacterOverlay" class="junbi-character" src="" alt="" style="display: none;">

          <div class="streak-indicator hidden" id="streakIndicator" style="position: absolute; top: 10px; left: 10px; z-index: 100;">
            <div class="streak-number" id="streakNumber" style="font-size: 18px;">0</div>
            <div class="streak-label" style="font-size: 10px;">Streak</div>
          </div>

          <div class="junbi-container" style="max-width: 500px; justify-content: flex-start; padding-top: 50px;">
            <div class="junbi-title" id="gameSetTitle" style="font-size: 20px; margin-bottom: 8px;">Flashcard Set</div>

            <div style="width: 100%; max-width: 100%; margin-bottom: 10px;">
              <span id="currentSetNumber" style="font-size: 12px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">Set 1 of 1</span>
              <div class="progress-bar" style="width: 100%; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; margin-top: 4px;">
                <div id="gameProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); border-radius: 3px; transition: width 0.3s;"></div>
              </div>
            </div>

            <div class="wrinkled-paper" style="width: 100%; max-width: 100%; padding: 15px; display: flex; flex-direction: column;">
              <h3 style="text-align: center; color: #667eea; margin: 0 0 12px 0; font-size: 14px; flex-shrink: 0;"> Say these words in Korean:</h3>

              <div id="wordsList" style="display: flex; flex-direction: column; gap: 8px;">

              </div>

              <div style="flex-shrink: 0; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #e2e8f0;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">

                  <div style="text-align: center;">
                    <div id="wordTimer" style="font-size: 36px; font-weight: bold; color: #2d3748; font-family: 'Courier New', monospace;">7</div>
                    <div style="color: #718096; font-size: 10px;">seconds</div>
                  </div>

                  <div id="voiceStatus" style="flex: 1; padding: 8px; background: rgba(102,126,234,0.1); border-radius: 8px; text-align: center;">
                    <div id="listeningIndicator" style="display: none;">
                      <span style="color: #f56565; animation: pulse 2s infinite; font-size: 14px;"> Listening...</span>
                    </div>
                    <div id="recognizedText" style="font-size: 16px; color: #2d3748; font-weight: 600; min-height: 20px;"></div>
                  </div>
                </div>

                <!-- Voice mode controls -->
                <div id="voiceControls" style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                  <button id="startGameBtn" class="junbi-btn" onclick="startFlashcardRound()" style="padding: 10px 20px; font-size: 14px;">
                     Start
                  </button>
                  <button class="junbi-btn" onclick="skipFlashcardWordCompletely()" style="padding: 10px 20px; font-size: 14px; background: linear-gradient(135deg, #f56565 0%, #dc2626 100%);">
                     Skip
                  </button>
                </div>

                <!-- Swipe mode controls -->
                <div id="swipeControls" style="display: none; margin-top: 10px;">
                  <p style="color: #718096; font-size: 12px; text-align: center; margin-bottom: 10px;">Tap the word to reveal answer, then mark:</p>
                  <div id="swipeAnswerSection" style="display: none;">
                    <div id="swipeKoreanAnswer" style="font-size: 24px; font-weight: bold; color: #667eea; text-align: center; margin-bottom: 10px;"></div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                      <button onclick="swipeFlashcardAnswer(true)" style="flex: 1; max-width: 120px; padding: 12px 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                         Correct
                      </button>
                      <button onclick="swipeFlashcardAnswer(false)" style="flex: 1; max-width: 120px; padding: 12px 20px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
                         Wrong
                      </button>
                    </div>
                  </div>
                  <div id="swipeTapPrompt" style="text-align: center;">
                    <button onclick="revealSwipeAnswer()" style="padding: 15px 30px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                       Tap to Reveal Answer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="gameResults" style="display: none; width: 100%; margin-top: 10px;">
              <div class="wrinkled-paper" style="padding: 15px; text-align: center;">
                <h3 style="color: #2d3748; margin-bottom: 10px; font-size: 18px;"> Round Complete!</h3>
                <div id="resultsDetails" style="margin-bottom: 10px;"></div>
                <div id="autoAdvanceContainer" style="margin-top: 10px;">
                  <div id="autoAdvanceCountdown" style="font-size: 14px; color: #667eea; margin-bottom: 8px;"></div>

                  <div id="handsFreeContinueStatus" style="margin-bottom: 10px;"></div>

                  <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button class="junbi-btn" onclick="skipToNextSet()" style="padding: 10px 16px; font-size: 13px;">
                      Next 
                    </button>
                    <button class="junbi-btn" onclick="restartGame()" style="padding: 10px 16px; font-size: 13px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                       Again
                    </button>
                    <button class="junbi-btn" onclick="exitFlashcardGame()" style="padding: 10px 16px; font-size: 13px; background: linear-gradient(135deg, #718096 0%, #4a5568 100%);">
                      Exit
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="masteryDeck" class="tab-content">
        <h2> Mastery Deck</h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Words you've mastered from Flashcard Games! Practice them anytime to keep them fresh.
          Miss a word here and it goes back to Day 1 review.
        </p>

        <div id="masteryDeckContainer">
          <div class="loading"></div>
        </div>

        <div id="masteryPracticeInterface" style="display: none;">
          <button class="btn" onclick="exitMasteryPractice()" style="margin-bottom: 20px;"> Back to Mastery Deck</button>

          <div class="game-container" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(255,215,0,0.2); border: 3px solid #fcd34d;">
            <div class="game-header" style="text-align: center; margin-bottom: 30px;">
              <h2 style="color: #92400e;"> Mastery Practice</h2>
              <div class="game-progress" style="margin: 20px 0;">
                <span id="masterySetNumber" style="font-size: 18px; color: #a16207;">Word 1 of 10</span>
                <div class="progress-bar" style="width: 100%; height: 8px; background: #fde68a; border-radius: 4px; margin-top: 10px;">
                  <div id="masteryProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%); border-radius: 4px; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>

            <div id="masteryWordsList" style="margin-bottom: 30px;"></div>

            <div style="display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap;">
              <button id="masteryStartBtn" onclick="startMasteryRound()" class="btn" style="padding: 15px 40px; font-size: 18px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                 Start Speaking
              </button>

              <div id="masteryListeningIndicator" style="display: none; padding: 10px 20px; background: #fef3c7; border-radius: 10px; border: 2px solid #fcd34d;">
                <span style="color: #92400e;"> Listening...</span>
              </div>

              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="color: #a16207;">Timer:</span>
                <span id="masteryWordTimer" style="font-size: 24px; font-weight: bold; color: #92400e;">7</span>
                <span style="color: #a16207;">s</span>
              </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
              <span style="color: #a16207;">You said: </span>
              <span id="masteryRecognizedText" style="font-weight: bold; color: #92400e;">-</span>
            </div>

            <div id="masteryResults" style="display: none; margin-top: 30px; background: white; border-radius: 20px; padding: 30px; border: 2px solid #fcd34d;">
              <h3 style="text-align: center; color: #92400e; margin-bottom: 20px;">Practice Complete!</h3>
              <div id="masteryResultsDetails"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="leitnerReview" class="tab-content">
        <h2> Daily Review</h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Review cards you've gotten wrong. Getting them right moves them forward; wrong sends them back to Day 1.
        </p>

        <div id="leitnerReviewContainer">
          <div class="leitner-empty-state">
            <div class="icon"></div>
            <h3>Loading...</h3>
          </div>
        </div>
      </div>

      <div id="leitnerBoxes" class="tab-content">
        <h2> Review Calendar</h2>
        <p style="color: #718096; margin-bottom: 15px;">
          Cards are organized by review interval. Each box shows when cards are due for review.
        </p>

        <div style="background: linear-gradient(135deg, #f0fff4 0%, #ebf8ff 100%); border: 1px solid #9ae6b4; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 24px;"></span>
            <div>
              <div style="font-weight: 600; color: #276749; margin-bottom: 5px;">Brain System Map</div>
              <p style="font-size: 13px; color: #2f855a; margin: 0;">
                Click the <strong>brain icon</strong> on each box to see which part of your brain is doing most of the work at that stage.
                <em>Remember: Memories don't live in only one place  this shows which system is doing most of the work!</em>
              </p>
            </div>
          </div>
        </div>

        <div id="day1IntervalsSection" style="display: none; margin-bottom: 25px;">
          <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border: 2px solid #fc8181; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
              <span style="font-size: 24px;"></span>
              <div>
                <h3 style="margin: 0; color: #c53030; font-size: 16px;">Day 1 Power Practice</h3>
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #9b2c2c;">Multiple recalls on Day 1 dramatically improve retention!</p>
              </div>
            </div>
            <div id="day1IntervalsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">

            </div>
          </div>
        </div>

        <div class="leitner-box-grid" id="leitnerBoxGrid">

        </div>

        <div id="leitnerBoxDetail" style="display: none; margin-top: 30px;">
          <button class="btn" onclick="closeLeitnerBoxDetail()" style="margin-bottom: 20px;"> Back to Calendar</button>
          <h3 id="leitnerBoxDetailTitle" style="margin-bottom: 20px;">Box Cards</h3>
          <div id="leitnerBoxDetailList"></div>
        </div>
      </div>

      <div id="leitnerStats" class="tab-content">
        <h2> Spaced Repetition Stats</h2>
        <p style="color: #718096; margin-bottom: 20px;">
          Track your learning progress and identify areas for improvement.
        </p>

        <h3 style="color: #4a5568; margin-bottom: 15px; margin-top: 30px;"> Core Progress</h3>
        <div class="leitner-dashboard-grid" id="leitnerCoreProgress">

        </div>

        <h3 style="color: #4a5568; margin-bottom: 15px; margin-top: 30px;"> Recall Quality</h3>
        <div class="leitner-dashboard-grid" id="leitnerRecallQuality">

        </div>

        <h3 style="color: #4a5568; margin-bottom: 15px; margin-top: 30px;"> Struggle Analysis</h3>
        <div class="leitner-dashboard-grid" id="leitnerStruggleAnalysis">

        </div>

        <h3 style="color: #4a5568; margin-bottom: 15px; margin-top: 30px;"> Consistency & Habits</h3>
        <div class="leitner-dashboard-grid" id="leitnerConsistency">

        </div>
      </div>

      <div id="studentLeaderboard" class="tab-content">
        <h2> Leaderboards</h2>
        <p style="color: #718096; margin-bottom: 25px;">See how you rank among your classmates!</p>

        <div class="leaderboard-container">

          <div class="leaderboard-tabs">
            <button class="leaderboard-tab active" onclick="switchLeaderboardTab('flashcard', 'student')"> Flashcard</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('pronunciation', 'student')"> Pronunciation</button>
            <button class="leaderboard-tab" onclick="switchLeaderboardTab('test', 'student')"> Test</button>
          </div>

          <div id="student-leaderboard-flashcard" class="leaderboard-section active">
            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Most Consistent Practice</h3>
                  <p>Top students with best practice streaks</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="student-leaderboard-practice-streak">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>

            <div class="leaderboard-card">
              <div class="leaderboard-header flashcard">
                <div class="icon"></div>
                <div>
                  <h3>Most Words Memorized</h3>
                  <p>Students who have mastered the most vocabulary</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="student-leaderboard-words-mastered">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>

          <div id="student-leaderboard-pronunciation" class="leaderboard-section">
            <div class="leaderboard-card">
              <div class="leaderboard-header pronunciation">
                <div class="icon"></div>
                <div>
                  <h3>Best Pronunciation</h3>
                  <p>Students with highest pronunciation scores</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="student-leaderboard-pronunciation-accuracy">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>

          <div id="student-leaderboard-test" class="leaderboard-section">
            <div class="leaderboard-card">
              <div class="leaderboard-header test">
                <div class="icon"></div>
                <div>
                  <h3>Best Test Scores</h3>
                  <p>Top performers on tests</p>
                </div>
              </div>
              <ul class="leaderboard-list" id="student-leaderboard-test-scores">
                <li class="leaderboard-empty"><div class="icon"></div>Loading...</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div id="studentProfile" class="tab-content">
        <div class="profile-container">

          <div class="profile-header">
            <div class="profile-avatar-wrapper">
              <div class="profile-avatar" id="profileAvatarDisplay">

              </div>
              <div class="profile-avatar-edit" onclick="openAvatarModal()">
                
              </div>
            </div>
            <div class="profile-name" id="profileDisplayName">Student</div>
            <div class="profile-email" id="profileEmail">Loading...</div>
            <div class="profile-level-badge" id="profileLevelBadge"> Beginner</div>

            <div class="profile-stats-row">
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileTotalXP">0</div>
                <div class="profile-stat-label">Total XP</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileWordsMastered">0</div>
                <div class="profile-stat-label">Words Mastered</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileGrammarMastered">0</div>
                <div class="profile-stat-label">Grammar Mastered</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileCurrentStreak">0</div>
                <div class="profile-stat-label">Day Streak</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-value" id="profileBadgesEarned">0</div>
                <div class="profile-stat-label">Badges Earned</div>
              </div>
            </div>
          </div>

          <div class="badges-section">
            <h3> Muscle Achievements</h3>
            <p style="color: #718096; margin-bottom: 20px;">Build your Korean strength! Badges scale infinitely - keep pushing for the next tier!</p>
            <div class="badges-grid" id="badgesGrid">

              <div style="text-align: center; padding: 40px; color: #718096;">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <p>Loading your achievements...</p>
              </div>
            </div>
          </div>

          <div class="badges-section">
            <h3> Badge Tiers</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #fef3e2 0%, #fde6cc 100%); border-radius: 20px; font-size: 13px; border: 2px solid #cd7f32;"> Bronze</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; font-size: 13px; border: 2px solid #c0c0c0;"> Silver</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 20px; font-size: 13px; border: 2px solid #ffd700;"> Gold</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); border-radius: 20px; font-size: 13px; border: 2px solid #e5e4e2;"> Platinum</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #e0f7ff 0%, #b3ecff 100%); border-radius: 20px; font-size: 13px; border: 2px solid #b9f2ff;"> Diamond</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%); border-radius: 20px; font-size: 13px; border: 2px solid #ff6b6b;"> Legendary</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%); border-radius: 20px; font-size: 13px; border: 2px solid #9f7aea;"> Mythic</span>
              <span style="padding: 6px 12px; background: linear-gradient(135deg, #fffff0 0%, #fefcbf 100%); border-radius: 20px; font-size: 13px; border: 2px solid #f6e05e;"> Transcendent</span>
            </div>
          </div>
        </div>
      </div>

      <div id="myFlashcards" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
          <h2 style="display: flex; align-items: center; gap: 15px; margin: 0;">
            <span style="font-size: 36px;"></span>
            <span>My Flashcards</span>
          </h2>
          <button id="syncToGamesBtn" onclick="syncMyCardsToGames()" class="btn" style="padding: 12px 24px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
             Sync to Games
          </button>
        </div>

        <div id="syncProgressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center;">
          <div style="background: white; border-radius: 16px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <h3 style="margin: 0 0 10px 0; color: #2d3748;">Syncing to Flashcard Games</h3>
            <p id="syncProgressText" style="color: #718096; margin-bottom: 20px;">Preparing...</p>
            <div style="background: #e2e8f0; border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 10px;">
              <div id="syncProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <span id="syncProgressCount" style="font-size: 13px; color: #a0aec0;">0 of 0</span>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 25px;">

          <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3 style="margin: 0; font-size: 16px; color: #1a202c;"> My Folders</h3>
              <button onclick="openCreateFolderModal()" class="btn" style="padding: 6px 12px; font-size: 12px;">+ New</button>
            </div>

            <div class="my-folder-item active" onclick="selectMyFolder('all')" id="myFolder-all">
              <span> All Cards</span>
              <span class="folder-count" id="allCardsCount">0</span>
            </div>

            <div id="myFoldersList">
              <div style="text-align: center; padding: 20px; color: #a0aec0; font-size: 13px;">
                Loading folders...
              </div>
            </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
              <div style="font-size: 11px; color: #718096; margin-bottom: 10px;">QUICK STATS</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background: #f7fafc; padding: 10px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: #667eea;" id="myTotalCards">0</div>
                  <div style="font-size: 10px; color: #a0aec0;">Total Cards</div>
                </div>
                <div style="background: #f7fafc; padding: 10px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 20px; font-weight: bold; color: #48bb78;" id="myMasteredCards">0</div>
                  <div style="font-size: 10px; color: #a0aec0;">Mastered</div>
                </div>
              </div>
              <div style="margin-top: 10px; background: #f7fafc; padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #ed8936;" id="myTotalEarnings">0 </div>
                <div style="font-size: 10px; color: #a0aec0;">Total Earnings</div>
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
              <div>
                <h3 style="margin: 0;" id="selectedFolderName">All Cards</h3>
                <span style="font-size: 12px; color: #a0aec0;" id="selectedFolderCount">0 cards</span>
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openAddCardModal()" class="btn" style="padding: 8px 16px; font-size: 13px;"> Add Card</button>
                <button onclick="openBulkImportModal()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;"> Bulk Import</button>
                <button onclick="openFolderSettingsModal()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" id="folderSettingsBtn"> Folder Settings</button>
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
              <input type="text" id="myCardsSearch" placeholder="Search cards..." style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" onkeyup="filterMyCards()">
              <select id="myCardsSort" onchange="filterMyCards()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="korean">Korean A-Z</option>
                <option value="box">Leitner Box</option>
              </select>
            </div>

            <div id="myCardsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
              <div style="text-align: center; padding: 60px 20px; color: #a0aec0; grid-column: 1 / -1;">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <p>No cards yet. Create your first flashcard!</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="myCreatorProfile" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Creator Profile</span>
        </h2>

        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; margin-bottom: 25px; color: white;">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px;">
              
            </div>
            <div>
              <h3 style="margin: 0; font-size: 24px;" id="creatorDisplayName">Loading...</h3>
              <p style="margin: 5px 0 0 0; color: #a0aec0; font-size: 14px;">Flashcard Creator</p>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 28px; font-weight: bold;" id="creatorSetsPublished">0</div>
              <div style="font-size: 11px; color: #a0aec0;">Sets Published</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 28px; font-weight: bold;" id="creatorTotalDownloads">0</div>
              <div style="font-size: 11px; color: #a0aec0;">Total Downloads</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 28px; font-weight: bold; color: #ffd700;" id="creatorTotalEarnings">0 </div>
              <div style="font-size: 11px; color: #a0aec0;">Total Earnings</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 28px; font-weight: bold;" id="creatorAvgRating">-</div>
              <div style="font-size: 11px; color: #a0aec0;">Avg Rating</div>
            </div>
          </div>
        </div>

        <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h4 style="margin-bottom: 20px;"> My Published Sets</h4>
          <div id="myPublishedSetsList">
            <div style="text-align: center; padding: 40px; color: #a0aec0;">
              <div style="font-size: 48px; margin-bottom: 15px;"></div>
              <p>You haven't published any sets yet.</p>
              <p style="font-size: 13px;">Make a folder public to start earning coins!</p>
            </div>
          </div>
        </div>
      </div>

      <div id="marketplacePopular" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Flashcard Marketplace</span>
        </h2>

        <div id="mobileMarketplaceNav" class="mobile-only" style="display: none; gap: 10px; margin-bottom: 20px;">
          <button onclick="mobileNavTo('marketplaceCategories')" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
             Categories
          </button>
          <button onclick="mobileNavTo('myPurchases')" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
             My Purchases
          </button>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
          <input type="text" id="marketplaceSearch" placeholder=" Search sets, creators, or keywords..." style="flex: 1; min-width: 250px; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 30px; font-size: 14px;" onkeyup="searchMarketplace()">
          <select id="marketplaceCategory" onchange="filterMarketplace()" style="padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 30px; font-size: 14px;">
            <option value="all">All Categories</option>
            <option value="food"> Food & Dining</option>
            <option value="travel"> Travel</option>
            <option value="business"> Business</option>
            <option value="kdrama"> K-Drama & Entertainment</option>
            <option value="kpop"> K-Pop</option>
            <option value="daily"> Daily Life</option>
            <option value="academic"> Academic</option>
            <option value="slang"> Slang & Informal</option>
            <option value="other"> Other</option>
          </select>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="marketplace-tab active" onclick="switchMarketplaceTab('popular')"> Most Popular</button>
          <button class="marketplace-tab" onclick="switchMarketplaceTab('newest')"> Newest</button>
        </div>

        <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; color: #744210;"> Your Balance:</span>
          <span style="font-size: 24px; font-weight: bold; color: #744210;" id="marketplaceBalance">0</span>
        </div>

        <div id="marketplaceGrid" style="display: grid; gap: 20px;">
          <div style="text-align: center; padding: 60px; color: #a0aec0;">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <p>Loading marketplace...</p>
          </div>
        </div>
      </div>

      <div id="marketplaceNewest" class="tab-content">
        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Newest Flashcard Sets</span>
        </h2>

        <div id="marketplaceNewestGrid" style="display: grid; gap: 20px;">
          <div style="text-align: center; padding: 60px; color: #a0aec0;">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <p>Loading newest sets...</p>
          </div>
        </div>
      </div>

      <div id="marketplaceCategories" class="tab-content">

        <button id="mobileCategoriesBack" class="mobile-only" onclick="mobileNavTo('marketplacePopular')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Marketplace
        </button>

        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>Browse by Category</span>
        </h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div class="category-card" onclick="browseCategory('food')" style="background: linear-gradient(135deg, #fed7aa 0%, #fbd38d 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #744210;">Food & Dining</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #975a16;" id="catCountFood">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('travel')" style="background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #2c5282;">Travel</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #2b6cb0;" id="catCountTravel">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('business')" style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #22543d;">Business</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #276749;" id="catCountBusiness">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('kdrama')" style="background: linear-gradient(135deg, #fbb6ce 0%, #f687b3 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #702459;">K-Drama</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #97266d;" id="catCountKdrama">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('kpop')" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #553c9a;">K-Pop</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6b46c1;" id="catCountKpop">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('daily')" style="background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #744210;">Daily Life</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #975a16;" id="catCountDaily">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('academic')" style="background: linear-gradient(135deg, #c3dafe 0%, #a3bffa 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #3c366b;">Academic</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #4c51bf;" id="catCountAcademic">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('slang')" style="background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #742a2a;">Slang & Informal</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #9b2c2c;" id="catCountSlang">0 sets</p>
          </div>
          <div class="category-card" onclick="browseCategory('other')" style="background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: transform 0.3s;">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <h4 style="margin: 0; color: #4a5568;">Other</h4>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #718096;" id="catCountOther">0 sets</p>
          </div>
        </div>
      </div>

      <div id="myPurchases" class="tab-content">

        <button id="mobilePurchasesBack" class="mobile-only" onclick="mobileNavTo('marketplacePopular')" style="display: none; margin-bottom: 15px; padding: 10px 20px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; color: #4a5568; font-weight: 600; font-size: 14px; cursor: pointer;">
           Back to Marketplace
        </button>

        <h2 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
          <span style="font-size: 36px;"></span>
          <span>My Purchases</span>
        </h2>

        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
          <p style="margin: 0; color: #856404; font-size: 13px;">
             Purchased sets are automatically added to your "My Flashcards" and integrated with the Leitner system. You'll receive updates if the creator edits the set.
          </p>
        </div>

        <div id="myPurchasesList">
          <div style="text-align: center; padding: 60px; color: #a0aec0; background: white; border-radius: 16px;">
            <div style="font-size: 48px; margin-bottom: 15px;"></div>
            <p>No purchases yet.</p>
            <button onclick="switchTab('marketplacePopular')" class="btn" style="margin-top: 15px;">Browse Marketplace</button>
          </div>
        </div>
      </div>

      </div>
      </div>
    </div>

    <div id="adminDashboard" class="hidden">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Overview</button>
        <button class="tab" onclick="switchTab('universalGameAssets')"> Game Assets</button>
        <button class="tab" onclick="switchTab('walkAwaySettings')"> Walk Away Mode</button>
      </div>

      <div id="overview" class="tab-content active">
        <h2>System Overview</h2>
        <p>Admin controls for managing the system.</p>
      </div>

      <div id="universalGameAssets" class="tab-content">
        <h2> Universal Flashcard Game Assets</h2>
        <p style="color: #718096; margin-bottom: 25px;">
          Configure images and sounds that apply to ALL flashcard games. These are used unless a specific flashcard set has its own assets.
        </p>

        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 16px; padding: 25px; margin-bottom: 30px;">
          <h3 style="color: #92400e; margin: 0 0 15px 0;"> How Game Assets Work</h3>
          <ul style="color: #78350f; margin: 0; padding-left: 20px; line-height: 1.8;">
            <li><strong>Start Image/Sound</strong> - Shows when the game begins</li>
            <li><strong>Progress Image + 4 Sounds</strong> - Shows after each correct answer (1st-4th)</li>
            <li><strong>Perfect Image/Sound</strong> - Shows when all 5 words in a set are correct (100%)</li>
            <li><strong>Almost Image/Sound</strong> - Shows when a set is finished but not perfect</li>
            <li><strong>Timeout Image/Sound</strong> - Shows when the timer runs out</li>
            <li><strong>End GIFs + Sounds</strong> - Shows at game completion based on final score</li>
          </ul>
        </div>

        <div style="display: grid; gap: 25px;">

          <div style="background: white; border: 2px solid #667eea; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #4c51bf;">Game Start</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Image and sound shown when the game begins
                </p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="font-size: 13px; color: #4a5568;">Image (PNG/GIF)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'startImage')" style="width: 100%; margin-top: 5px;">
                <div id="universalStartImagePreview" style="margin-top: 10px;"></div>
              </div>
              <div>
                <label style="font-size: 13px; color: #4a5568;">Sound (MP3)</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'startSound')" style="width: 100%; margin-top: 5px;">
                <div id="universalStartSoundPreview" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #276749;">Progress Rewards (1st-4th Correct)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Same image shown for each correct answer, different sound for each position
                </p>
              </div>
            </div>
            <div style="margin-bottom: 15px;">
              <label style="font-size: 13px; color: #4a5568;">Progress Image (shown for all)</label>
              <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'progressImage')" style="width: 100%; margin-top: 5px;">
              <div id="universalProgressImagePreview" style="margin-top: 10px;"></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div>
                <label style="font-size: 12px; color: #4a5568;">1st Correct</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'progressSound1')" style="width: 100%; font-size: 11px;">
                <div id="universalProgressSound1Preview" style="margin-top: 5px;"></div>
              </div>
              <div>
                <label style="font-size: 12px; color: #4a5568;">2nd Correct</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'progressSound2')" style="width: 100%; font-size: 11px;">
                <div id="universalProgressSound2Preview" style="margin-top: 5px;"></div>
              </div>
              <div>
                <label style="font-size: 12px; color: #4a5568;">3rd Correct</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'progressSound3')" style="width: 100%; font-size: 11px;">
                <div id="universalProgressSound3Preview" style="margin-top: 5px;"></div>
              </div>
              <div>
                <label style="font-size: 12px; color: #4a5568;">4th Correct</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'progressSound4')" style="width: 100%; font-size: 11px;">
                <div id="universalProgressSound4Preview" style="margin-top: 5px;"></div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #f6e05e; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #975a16;">Perfect Score (5/5 in a Set)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Shows when player gets all 5 words correct in a single set
                </p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="font-size: 13px; color: #4a5568;">Image (PNG/GIF)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'perfectImage')" style="width: 100%; margin-top: 5px;">
                <div id="universalPerfectImagePreview" style="margin-top: 10px;"></div>
              </div>
              <div>
                <label style="font-size: 13px; color: #4a5568;">Sound (MP3)</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'perfectSound')" style="width: 100%; margin-top: 5px;">
                <div id="universalPerfectSoundPreview" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #ed8936; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #c05621;">Almost Perfect (Set Complete, Not 100%)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Shows when a set is finished but player missed some words
                </p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="font-size: 13px; color: #4a5568;">Image (PNG/GIF)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'almostImage')" style="width: 100%; margin-top: 5px;">
                <div id="universalAlmostImagePreview" style="margin-top: 10px;"></div>
              </div>
              <div>
                <label style="font-size: 13px; color: #4a5568;">Sound (MP3)</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'almostSound')" style="width: 100%; margin-top: 5px;">
                <div id="universalAlmostSoundPreview" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #f56565; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #c53030;">Timeout (Timer Ran Out)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Shows when the timer runs out on a word
                </p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="font-size: 13px; color: #4a5568;">Image (PNG/GIF)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'timeoutImage')" style="width: 100%; margin-top: 5px;">
                <div id="universalTimeoutImagePreview" style="margin-top: 10px;"></div>
              </div>
              <div>
                <label style="font-size: 13px; color: #4a5568;">Sound (MP3)</label>
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'timeoutSound')" style="width: 100%; margin-top: 5px;">
                <div id="universalTimeoutSoundPreview" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #9f7aea; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #6b46c1;">End Game Results (6 Tiers by Score)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Different GIFs shown at game end based on final percentage
                </p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div style="background: #fed7d7; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #c53030; font-weight: bold;">50% (Tier 1)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif1')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound1')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif1Preview" style="margin-top: 5px;"></div>
              </div>
              <div style="background: #feebc8; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #c05621; font-weight: bold;">65% (Tier 2)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif2')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound2')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif2Preview" style="margin-top: 5px;"></div>
              </div>
              <div style="background: #fefcbf; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #975a16; font-weight: bold;">75% (Tier 3)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif3')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound3')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif3Preview" style="margin-top: 5px;"></div>
              </div>
              <div style="background: #c6f6d5; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #276749; font-weight: bold;">85% (Tier 4)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif4')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound4')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif4Preview" style="margin-top: 5px;"></div>
              </div>
              <div style="background: #bee3f8; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #2b6cb0; font-weight: bold;">99% (Tier 5)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif5')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound5')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif5Preview" style="margin-top: 5px;"></div>
              </div>
              <div style="background: #e9d8fd; padding: 10px; border-radius: 8px;">
                <label style="font-size: 12px; color: #6b46c1; font-weight: bold;">100% (Perfect!)</label>
                <input type="file" accept="image/*" onchange="handleUniversalAssetUpload(this, 'endGif6')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <input type="file" accept="audio/*" onchange="handleUniversalAssetUpload(this, 'endSound6')" style="width: 100%; font-size: 11px; margin-top: 5px;">
                <div id="universalEndGif6Preview" style="margin-top: 5px;"></div>
              </div>
            </div>
          </div>

        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 12px;">
          <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Current Universal Assets</h4>
          <div id="universalAssetsList">
            <p style="color: #718096;">Loading current assets...</p>
          </div>
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="loadUniversalGameAssets()" class="btn btn-secondary">
               Refresh
            </button>
            <button onclick="clearAllUniversalAssets()" class="btn" style="background: #f56565;">
               Clear All Assets
            </button>
          </div>
        </div>
      </div>

      <div id="walkAwaySettings" class="tab-content">
        <h2> Walk Away Mode Settings</h2>
        <p style="color: #718096; margin-bottom: 25px;">
          Configure sounds for Walk Away Mode. This allows students to practice flashcards hands-free with audio cues.
        </p>

        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 2px solid #667eea; border-radius: 16px; padding: 25px; margin-bottom: 30px;">
          <h3 style="color: #3730a3; margin: 0 0 15px 0;"> How Walk Away Mode Works</h3>
          <ul style="color: #4338ca; margin: 0; padding-left: 20px; line-height: 1.8;">
            <li>English word is <strong>spoken aloud</strong> when each card appears</li>
            <li>Student says the Korean translation</li>
            <li><strong>Wrong sound</strong> plays if answer is incorrect (student can try again)</li>
            <li><strong>Time's up sound</strong> plays when timer expires, then correct answer is spoken</li>
            <li><strong>Correct sound</strong> plays when answer is right</li>
          </ul>
        </div>

        <div style="display: grid; gap: 25px;">

          <div style="background: white; border: 2px solid #f56565; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #c53030;">Wrong Answer Sound</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Plays when student says incorrect answer (they can try again)
                </p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <input type="file" id="walkAwayWrongSound" accept="audio/*" onchange="handleWalkAwaySoundUpload('wrong')" style="flex: 1;">
              <div id="walkAwayWrongPreview"></div>
            </div>
            <div id="walkAwayWrongStatus" style="margin-top: 10px; font-size: 13px; color: #718096;"></div>
          </div>

          <div style="background: white; border: 2px solid #ed8936; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #c05621;">Time's Up Sound</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Plays when timer runs out, before showing correct answer
                </p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <input type="file" id="walkAwayTimeUpSound" accept="audio/*" onchange="handleWalkAwaySoundUpload('timeup')" style="flex: 1;">
              <div id="walkAwayTimeUpPreview"></div>
            </div>
            <div id="walkAwayTimeUpStatus" style="margin-top: 10px; font-size: 13px; color: #718096;"></div>
          </div>

          <div style="background: white; border: 2px solid #48bb78; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #276749;">Correct Answer Sound</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Plays when student answers correctly
                </p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <input type="file" id="walkAwayCorrectSound" accept="audio/*" onchange="handleWalkAwaySoundUpload('correct')" style="flex: 1;">
              <div id="walkAwayCorrectPreview"></div>
            </div>
            <div id="walkAwayCorrectStatus" style="margin-top: 10px; font-size: 13px; color: #718096;"></div>
          </div>

          <div style="background: white; border: 2px solid #9f7aea; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <span style="font-size: 40px;"></span>
              <div>
                <h4 style="margin: 0; color: #6b46c1;">Play Again Sound (Flashcard Games)</h4>
                <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                  Plays after all flashcards complete - "Do you want to play again?"
                </p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <input type="file" id="walkAwayPlayAgainSound" accept="audio/*" onchange="handleWalkAwaySoundUpload('playAgain')" style="flex: 1;">
              <div id="walkAwayPlayAgainPreview"></div>
            </div>
            <div id="walkAwayPlayAgainStatus" style="margin-top: 10px; font-size: 13px; color: #718096;"></div>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 12px;">
          <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Current Sound Settings</h4>
          <div id="walkAwaySoundsList">
            <p style="color: #718096;">Loading current settings...</p>
          </div>
          <button onclick="loadWalkAwaySounds()" class="btn btn-secondary" style="margin-top: 15px;">
             Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="testModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTestTitle">Test Title</h2>
      <button class="close-btn" onclick="closeTestModal()">&times;</button>
    </div>

    <div id="testModalContent">

      <div id="testMaterialDisplay" style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;"></div>

      <div class="progress-tracker" id="progressTracker" style="display: none;"></div>

      <div id="recordingInterface"></div>

      <div id="submitSection" style="display: none; text-align: center; margin-top: 30px;">
        <h3 style="color: #48bb78; margin-bottom: 20px;">All recordings completed!</h3>
        <button onclick="submitAllRecordings()" class="btn btn-secondary" style="font-size: 18px; padding: 15px 30px;">Submit Test</button>
      </div>
    </div>
  </div>
</div>

<div id="gradingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Grade Submission</h2>
      <button class="close-btn" onclick="closeGradingModal()">&times;</button>
    </div>
    <div id="gradingContent"></div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>

const NOTIFICATION_CHARACTERS = {
  0: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246', // Sunday - use Fox
  1: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246', // Monday - Fox
  2: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0430_Gameboy_Chibi_Polar_Bear_remix_01k654mybgen38nj0ka69mkhsb.png?v=1766748246', // Tuesday - Bear
  3: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20251019_1559_Chibi_Shark_Charm_remix_01k7z0t53be7cbmdvf32a4m776.png?v=1766748286', // Wednesday - Shark
  4: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/chib1.png?v=1766748245', // Thursday - Chick
  5: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Chibi_Moon_Character_remix_01k6574v2yekcvhkxcr306kj29.png?v=1766748246', // Friday - Moon
  6: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Chibi_Moon_Character_remix_01k6574v2yekcvhkxcr306kj29.png?v=1766748246' // Saturday - use Moon
};

const NOTIFICATION_EMOJI = {
  0: '', 1: '', 2: '', 3: '', 4: '', 5: '', 6: ''
};

if (typeof firebase === 'undefined') {
  alert('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
} else {
}

const firebaseConfig = {
  apiKey: "AIzaSyDzI1_B49onrKJriy3er88O1KOJTLBzbYY",
  authDomain: "korean-ta-evaluator.firebaseapp.com",
  projectId: "korean-ta-evaluator",
  storageBucket: "korean-ta-evaluator.firebasestorage.app",
  messagingSenderId: "386010826708",
  appId: "1:386010826708:web:d06d6fbdadce561b36b841",
  measurementId: "G-FGT8J0D64J"
};

let auth, db, storage;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
} catch (error) {
  alert('Failed to initialize Firebase: ' + error.message);
}

let currentUser = null;
let currentUserRole = null;
let currentTest = null;
let testMaterials = [];
let currentMaterialTopics = [];
let currentMaterialFeedbacks = {};
let currentTestMaterialIndex = 0;
let recordingsData = {};
let mediaRecorder = null;
let audioChunks = [];
let recordingTimer = null;
let timeLeft = 0;
let maxTime = 0;
let editingTestId = null; // Track if we're editing an existing test

let transcriptionRecognition = null;
let currentTranscription = {}; // Stores transcription per material index
let isTranscribing = false;

/**
 * Start Korean speech-to-text transcription during recording
 */
function startTranscription(materialIndex) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  transcriptionRecognition = new SpeechRecognition();
  transcriptionRecognition.lang = 'ko-KR';
  transcriptionRecognition.continuous = true;
  transcriptionRecognition.interimResults = true;
  transcriptionRecognition.maxAlternatives = 1;

  currentTranscription[materialIndex] = {
    finalText: '',
    interimText: ''
  };

  transcriptionRecognition.onresult = (event) => {
    let interimTranscript = '';
    let finalTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }

    if (finalTranscript) {
      currentTranscription[materialIndex].finalText += finalTranscript;
    }
    currentTranscription[materialIndex].interimText = interimTranscript;

    updateLiveTranscriptionDisplay(materialIndex);
  };

  transcriptionRecognition.onerror = (event) => {
    if (event.error === 'no-speech' || event.error === 'audio-capture') {
      if (isTranscribing) {
        setTimeout(() => {
          if (isTranscribing && transcriptionRecognition) {
            try {
              transcriptionRecognition.start();
            } catch (e) {
            }
          }
        }, 500);
      }
    }
  };

  transcriptionRecognition.onend = () => {
    if (isTranscribing) {
      try {
        transcriptionRecognition.start();
      } catch (e) {
      }
    }
  };

  try {
    isTranscribing = true;
    transcriptionRecognition.start();
  } catch (e) {
  }
}

/**
 * Stop transcription and return final text
 */
function stopTranscription(materialIndex) {
  isTranscribing = false;

  if (transcriptionRecognition) {
    try {
      transcriptionRecognition.stop();
    } catch (e) {
    }
    transcriptionRecognition = null;
  }

  const transcription = currentTranscription[materialIndex];
  if (transcription) {
    return (transcription.finalText + transcription.interimText).trim();
  }
  return '';
}

/**
 * Update live transcription display during recording
 */
function updateLiveTranscriptionDisplay(materialIndex) {
  const displayEl = document.getElementById('liveTranscriptionDisplay');
  if (displayEl && currentTranscription[materialIndex]) {
    const text = currentTranscription[materialIndex].finalText +
                 '<span style="color: #a0aec0;">' + currentTranscription[materialIndex].interimText + '</span>';
    displayEl.innerHTML = text || '<em style="color: #a0aec0;">Listening for Korean speech...</em>';
  }
}

let studySessionState = {
  isActive: false,
  startTime: null,
  type: null, // 'flashcard', 'grammar', 'pronunciation', 'all-in-one'
  cardsReviewed: 0,
  correctAnswers: 0
};

function startStudySession(type) {
  if (studySessionState.isActive) {
    endStudySession();
  }

  studySessionState = {
    isActive: true,
    startTime: new Date(),
    type: type,
    cardsReviewed: 0,
    correctAnswers: 0
  };

}

function recordStudyActivity(correct = false) {
  if (studySessionState.isActive) {
    studySessionState.cardsReviewed++;
    if (correct) studySessionState.correctAnswers++;
  }
}

async function endStudySession() {
  if (!studySessionState.isActive || !currentUser) return;

  const endTime = new Date();
  const durationMs = endTime - studySessionState.startTime;
  const durationMinutes = Math.round(durationMs / 60000);

  if (durationMs < 30000) {
    studySessionState.isActive = false;
    return;
  }

  try {
    await db.collection('studySessions').add({
      studentId: currentUser.uid,
      type: studySessionState.type,
      startTime: firebase.firestore.Timestamp.fromDate(studySessionState.startTime),
      endTime: firebase.firestore.Timestamp.fromDate(endTime),
      durationMinutes: durationMinutes,
      durationSeconds: Math.round(durationMs / 1000),
      cardsReviewed: studySessionState.cardsReviewed,
      correctAnswers: studySessionState.correctAnswers,
      accuracy: studySessionState.cardsReviewed > 0 ?
        Math.round((studySessionState.correctAnswers / studySessionState.cardsReviewed) * 100) : 0
    });

  } catch (error) {
  }

  studySessionState.isActive = false;
}

window.addEventListener('beforeunload', () => {
  if (studySessionState.isActive) {
    const endTime = new Date();
    const durationMs = endTime - studySessionState.startTime;

    if (durationMs >= 30000 && currentUser) {
      endStudySession();
    }
  }
});

const VIDEO_QUALITY = {
  high: { width: 1920, height: 1080, frameRate: 30, videoBitsPerSecond: 5000000 },
  medium: { width: 1280, height: 720, frameRate: 30, videoBitsPerSecond: 2500000 },
  low: { width: 640, height: 480, frameRate: 24, videoBitsPerSecond: 1000000 }
};
let currentVideoQuality = 'medium'; // Default to medium for balance of quality and file size
let studentVideoStream = null;

const MAX_ATTEMPTS = 3;

let revealedMaterials = {};
let materialAttempts = {};
let revealedMaterials2 = {};
let materialAttempts2 = {};

let folders = {};

let gradingVideoRecorder = null;
let gradingVideoChunks = [];
let gradingVideoStream = null;
let gradingVideoBlob = null;

let topicChart = null;
let progressChart = null;
let analyticsData = {
  submissions: [],
  topics: {},
  improvements: {}
};

window.addEventListener('DOMContentLoaded', function() {

  loadSwipeModePreference();

  document.addEventListener('visibilitychange', function() {
    if (document.hidden && isFlashcardGameActive) {
    } else if (!document.hidden && isFlashcardGameActive && !isListening) {
      showGameInterruptedScreen();
    }
  });

  document.body.classList.add('login-page');

  const authForm = document.getElementById('authForm');
  if (authForm) {
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const accountType = document.getElementById('accountType').value;


      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);

        const userDoc = await db.collection('users').doc(userCredential.user.uid).get();

        if (!userDoc.exists) {
          await db.collection('users').doc(userCredential.user.uid).set({
            email: email,
            role: accountType,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          if (accountType === 'student') {
            await assignAdminFoldersToNewStudent(userCredential.user.uid);
          }
        }

        const userData = userDoc.exists ? userDoc.data() : { role: accountType };

        if (userData.role === accountType) {
          currentUser = userCredential.user;
          currentUserRole = accountType;
          showDashboard();
        } else {
          alert('Invalid role for this account. Expected: ' + accountType + ', Got: ' + userData.role);
          auth.signOut();
        }
      } catch (error) {
        alert('Login failed: ' + error.message);
      }
    });
  } else {
  }

  if (auth) {
    auth.onAuthStateChanged(async user => {

    if (user) {
      currentUser = user;

      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          currentUserRole = userDoc.data().role;
        } else {
          currentUserRole = 'student';
        }
      } catch (error) {
        currentUserRole = 'student';
      }

      showDashboard();

      loadJunbiConfig();

      if (currentUserRole === 'student') {
        setTimeout(() => {
          checkDailyActivityNotifications();
        }, 1500); // Wait 1.5 seconds for dashboard to fully render
      }

      document.addEventListener('click', function initAudio() {
        initAudioContext();
        document.removeEventListener('click', initAudio);
      }, { once: true });

    } else {
      try {
        await auth.signInAnonymously();
      } catch (error) {
        document.getElementById('authContainer').classList.remove('hidden');
      }
    }
  });
  } // End auth check

  window.addEventListener('load', async () => {

    setTimeout(async () => {
      if (auth && !auth.currentUser) {
        try {
          await auth.signInAnonymously();
        } catch (error) {
        }
      }
    }, 1000);
  });
});

function testLogin() {
  if (!auth) {
    alert('Firebase not initialized');
    return;
  }

  document.getElementById('email').value = 'teacher@test.com';
  document.getElementById('password').value = 'teacher123';
  document.getElementById('accountType').value = 'teacher';

  const form = document.getElementById('authForm');
  if (form) {
    form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
  } else {
  }
}

function transitionToView(targetViewId) {
  const container = document.getElementById('authContainer');
  const views = ['authMainView', 'authGettingStartedView', 'authLoginView'];
  const currentActive = views.find(id => document.getElementById(id).classList.contains('active'));

  if (currentActive === targetViewId) return;

  if (targetViewId === 'authLoginView') {
    container.classList.add('with-form');
  } else {
    container.classList.remove('with-form');
  }

  if (currentActive) {
    const currentView = document.getElementById(currentActive);
    currentView.classList.add('fade-out');
    currentView.classList.remove('active');

    setTimeout(() => {
      currentView.classList.remove('fade-out');
      currentView.style.display = 'none';

      const targetView = document.getElementById(targetViewId);
      targetView.style.display = 'block';
      targetView.offsetHeight;
      targetView.classList.add('active');
    }, 300);
  } else {
    const targetView = document.getElementById(targetViewId);
    targetView.style.display = 'block';
    targetView.offsetHeight;
    targetView.classList.add('active');
  }
}

function showMainView() {
  transitionToView('authMainView');
}

function showGettingStarted() {
  transitionToView('authGettingStartedView');
}

function showLoginForm() {
  transitionToView('authLoginView');
}

function logout() {
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {}
  }
  recognition = null;

  auth.signOut();
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('authContainer').classList.remove('hidden');
  document.body.classList.add('login-page');
  document.getElementById('themeToggleContainer').style.display = 'none';
  showMainView();
  currentUser = null;
  currentUserRole = null;
}

function toggleLightMode(event) {
  const body = document.body;
  const toggle = document.getElementById('themeToggle');
  const profileToggle = document.getElementById('profileThemeToggle');
  const mobileToggle = document.getElementById('mobileThemeToggle');

  let isChecked;
  if (event && event.target) {
    isChecked = event.target.checked;
  } else if (profileToggle) {
    isChecked = profileToggle.checked;
  } else if (toggle) {
    isChecked = toggle.checked;
  } else {
    isChecked = !body.classList.contains('light-mode');
  }

  if (isChecked) {
    body.classList.remove('light-mode');
    localStorage.setItem('korealand-theme', 'dark');
  } else {
    body.classList.add('light-mode');
    localStorage.setItem('korealand-theme', 'light');
  }

  if (toggle) toggle.checked = isChecked;
  if (profileToggle) profileToggle.checked = isChecked;
  if (mobileToggle) mobileToggle.checked = isChecked;
}

function loadThemePreference() {
  const savedTheme = localStorage.getItem('korealand-theme');
  const toggle = document.getElementById('themeToggle');
  const profileToggle = document.getElementById('profileThemeToggle');
  const container = document.getElementById('themeToggleContainer');

  if (container) {
    if (currentUserRole === 'student') {
      container.style.display = 'none';
    } else {
      container.style.display = 'block';
    }
  }

  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    if (toggle) toggle.checked = false;
    if (profileToggle) profileToggle.checked = false;
    var mobileToggle = document.getElementById('mobileThemeToggle');
    if (mobileToggle) mobileToggle.checked = false;
  } else {
    document.body.classList.remove('light-mode');
    if (toggle) toggle.checked = true;
    if (profileToggle) profileToggle.checked = true;
    var mobileToggle = document.getElementById('mobileThemeToggle');
    if (mobileToggle) mobileToggle.checked = true;
  }
}

function showDashboard() {
  document.body.classList.remove('login-page');

  document.getElementById('authContainer').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('userEmail').textContent = currentUser.email;
  document.getElementById('userRole').textContent = currentUserRole.toUpperCase();

  loadThemePreference();

  const roleBadge = document.getElementById('userRole');
  roleBadge.className = 'status-badge';
  if (currentUserRole === 'teacher') {
    roleBadge.style.background = '#667eea';
    roleBadge.style.color = 'white';
  } else if (currentUserRole === 'student') {
    roleBadge.style.background = '#48bb78';
    roleBadge.style.color = 'white';
  } else {
    roleBadge.style.background = '#ef4444';
    roleBadge.style.color = 'white';
  }

  document.getElementById('teacherDashboard').classList.add('hidden');
  document.getElementById('studentDashboard').classList.add('hidden');
  document.getElementById('adminDashboard').classList.add('hidden');

  if (currentUserRole === 'teacher') {
    document.getElementById('dashboardTitle').textContent = 'Teacher Dashboard';
    document.getElementById('teacherDashboard').classList.remove('hidden');
    loadTests();
    loadSubmissions();
    currentWordPairs = []; // Initialize flashcard variables
    loadFlashcardSets();
  } else if (currentUserRole === 'student') {
    document.getElementById('dashboardTitle').textContent = 'Student Dashboard';
    document.getElementById('studentDashboard').classList.remove('hidden');
    loadAvailableTests();
    loadMySubmissions();
    loadMyFeedback();
    loadAnalytics();
    loadAvailableFlashcards();
    loadLeitnerData(); // Load Leitner Box data
    updateMasteryBadge(); // Load Mastery Deck badge
    loadGrammarLeitnerCards(); // Load Grammar Leitner data
    loadPronunciationDrillCards(); // Load Pronunciation Drill data
    renderGrammarActiveDrills(); // Load Grammar Drill as default view
    initFloatingProfile(); // Initialize floating profile button
    checkMyCardsSyncState(); // Check if My Cards has been synced to games

    setTimeout(() => {
      updateAllInOneBadge();
    }, 2000);

    loadStudentDailyActivity();
    initTeamworkActivity();
    initKpopActivity();
    initGrammarBlabber();
  } else if (currentUserRole === 'admin') {
    document.getElementById('dashboardTitle').textContent = 'Admin Dashboard';
    document.getElementById('adminDashboard').classList.remove('hidden');
  }
}

function toggleDropdown(header) {
  const content = header.nextElementSibling;
  const isOpen = content.classList.contains('open');

  if (isOpen) {
    content.classList.remove('open');
    header.classList.remove('active');
  } else {
    content.classList.add('open');
    header.classList.add('active');
  }
}

function switchTab(tabName) {
  const parentDashboard = currentUserRole + 'Dashboard';
  const tabs = document.querySelectorAll(`#${parentDashboard} .tab`);
  const sidebarItems = document.querySelectorAll(`#${parentDashboard} .sidebar-item`);
  const contents = document.querySelectorAll(`#${parentDashboard} .tab-content`);

  tabs.forEach(tab => tab.classList.remove('active'));
  sidebarItems.forEach(item => item.classList.remove('active'));
  contents.forEach(content => content.classList.remove('active'));

  if (event && event.target) {
    event.target.classList.add('active');
  }

  const tabContent = document.getElementById(tabName);
  if (tabContent) {
    tabContent.classList.add('active');
  }

  if (tabName === 'createTest') {
    currentMaterialTopics = [];
    currentMaterialFeedbacks = {};
    renderCurrentTopics();
    document.getElementById('currentTopicFeedbacks').innerHTML = '';
  }

  if (tabName === 'createTest2') {
    currentMaterialTopics2 = [];
    currentMaterialFeedbacks2 = {};
    renderCurrentTopics2();
    document.getElementById('currentTopicFeedbacks2').innerHTML = '';
  }

  if (tabName === 'manageTests') loadTests();
  if (tabName === 'gradeStudents') loadSubmissions();
  if (tabName === 'flashcards' && currentUserRole === 'teacher') {
    loadFlashcardSets();
    loadAdminFolderDashboard();
  }
  if (tabName === 'availableTests') loadAvailableTests();
  if (tabName === 'mySubmissions') loadMySubmissions();
  if (tabName === 'feedback') loadMyFeedback();
  if (tabName === 'analytics') loadAnalytics();
  if (tabName === 'flashcardGames' && currentUserRole === 'student') loadAvailableFlashcards();

  if (tabName === 'masteryDeck' && currentUserRole === 'student') loadMasteryDeck();

  if (tabName === 'leitnerReview' && currentUserRole === 'student') renderLeitnerDailyReview();
  if (tabName === 'leitnerBoxes' && currentUserRole === 'student') renderLeitnerBoxGrid();
  if (tabName === 'leitnerStats' && currentUserRole === 'student') renderLeitnerStats();

  if (tabName === 'grammarDrill' && currentUserRole === 'student') renderGrammarActiveDrills();
  if (tabName === 'grammarMastery' && currentUserRole === 'student') loadGrammarMasteryDeck();
  if (tabName === 'grammarLeitner' && currentUserRole === 'student') renderGrammarLeitnerReview();
  if (tabName === 'grammarCalendar' && currentUserRole === 'student') renderGrammarBoxGrid();
  if (tabName === 'grammarStats' && currentUserRole === 'student') renderGrammarStats();

  if (tabName === 'leaderboard' || tabName === 'studentLeaderboard') loadLeaderboardData();
  if (tabName === 'studentProfile') loadStudentProfile();

  if (tabName === 'dailyActivity' && currentUserRole === 'student') {
    loadStudentDailyActivity();
    initTeamworkActivity(); // Initialize teamwork activity
    initKpopActivity(); // Initialize Kpop/Kdrama activity
    initGrammarBlabber(); // Initialize Grammar Blabber
    markDailyNotificationsViewed(); // Mark notifications as viewed when student views daily activity
  }
  if (tabName === 'manageDailyActivities' && currentUserRole === 'teacher') loadDailyActivities();
  if (tabName === 'gradeDailyActivities' && currentUserRole === 'teacher') loadDailyActivitySelector();
  if (tabName === 'teacherProfile' && currentUserRole === 'teacher') loadTeacherProfile();

  if (tabName === 'manageTests2') loadTests2();
  if (tabName === 'gradeStudents2') loadSubmissions2();
  if (tabName === 'drillTracking' && currentUserRole === 'teacher') loadDrillTracking();
  if (tabName === 'availableTests2') loadAvailableTests2();
  if (tabName === 'mySubmissions2') loadMySubmissions2();
  if (tabName === 'feedback2') loadMyFeedback2();
  if (tabName === 'analytics2') loadAnalytics2();
  if (tabName === 'pronunciationDrills' && currentUserRole === 'student') renderPronunciationDrills();
  if (tabName === 'allInOne' && currentUserRole === 'student') renderAllInOneDashboard();
}

function addTopicToCurrentMaterial() {
  const topicInput = document.getElementById('newTopic');
  const topicName = topicInput.value.trim();

  if (topicName && !currentMaterialTopics.includes(topicName)) {
    currentMaterialTopics.push(topicName);
    renderCurrentTopics();
    addFeedbackSectionForCurrent(topicName);
    topicInput.value = '';
  }
}

function renderCurrentTopics() {
  const topicList = document.getElementById('currentTopicList');
  topicList.innerHTML = currentMaterialTopics.map(topic => `
    <div class="topic-tag">
      ${topic}
      <button onclick="removeCurrentTopic('${topic}')"></button>
    </div>
  `).join('');
}

function removeCurrentTopic(topic) {
  currentMaterialTopics = currentMaterialTopics.filter(t => t !== topic);
  delete currentMaterialFeedbacks[topic];
  renderCurrentTopics();
  const feedbackElement = document.getElementById(`current-feedback-${topic.replace(/\s/g, '-')}`);
  if (feedbackElement) feedbackElement.remove();
}

function addFeedbackSectionForCurrent(topic) {
  const container = document.getElementById('currentTopicFeedbacks');
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
  const topicIndex = currentMaterialTopics.indexOf(topic);

  const feedbackDiv = document.createElement('div');
  feedbackDiv.id = `current-feedback-${topicId}`;
  feedbackDiv.className = 'feedback-editor';
  feedbackDiv.innerHTML = `
    <h4>Automated Feedback for: ${topic}</h4>
    <div class="feedback-type-selector">
      <div class="feedback-type active" onclick="selectCurrentFeedbackType('${topic}', 'text', this)">Text</div>
      <div class="feedback-type" onclick="selectCurrentFeedbackType('${topic}', 'video', this)">Video URL</div>
      <div class="feedback-type" onclick="selectCurrentFeedbackType('${topic}', 'html', this)">HTML</div>
    </div>
    <div id="current-feedback-content-${topicId}">
      <textarea id="current-feedback-text-${topicId}" rows="5" placeholder="Enter feedback text..." style="width: 100%;"></textarea>
    </div>

    <!-- Grammar Drill Sentences by Score Section -->
    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #86efac;">
      <h5 style="margin: 0 0 10px 0; color: #166534; display: flex; align-items: center; gap: 8px;">
         Grammar Drill Sentences by Score
        <span style="font-size: 12px; font-weight: normal; color: #15803d;">Different drills for each score level</span>
      </h5>
      <p style="font-size: 13px; color: #15803d; margin-bottom: 15px;">
        Create unique Q&A drill sentences for each score. Students receive drills matching their grade.
      </p>

      <!-- Score Tabs -->
      <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #86efac; padding-bottom: 10px;">
        ${[1,2,3,4,5,6,7,8,9,10].map(score => {
          const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];
          return `
            <button type="button"
              id="grammar-drill-tab-${topicId}-${score}"
              onclick="showGrammarDrillScoreTab('${topic}', ${topicIndex}, ${score})"
              style="padding: 8px 12px; border: 2px solid #e2e8f0;
                     background: white; border-radius: 8px; cursor: pointer;
                     font-weight: 400; color: #4a5568; transition: all 0.2s;">
              Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${reps})</span>
            </button>
          `;
        }).join('')}
      </div>

      <!-- Drill Content Area -->
      <div id="grammar-drill-content-${topicId}" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
        <div style="text-align: center; color: #15803d; padding: 20px;">
           Click a score tab above to add drill sentences for that score level
        </div>
      </div>

      <!-- Quick Info -->
      <div style="margin-top: 15px; font-size: 12px; color: #166534; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div> <strong>Score 1-2:</strong> Most repetitions (6-7)</div>
        <div> <strong>Score 3-6:</strong> Medium repetitions (4-5)</div>
        <div> <strong>Score 7-9:</strong> Fewer repetitions (2-3)</div>
        <div> <strong>Score 10:</strong> Quick check (1)</div>
      </div>
    </div>
  `;

  container.appendChild(feedbackDiv);
  currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
}

function selectCurrentFeedbackType(topic, type, element) {
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
  const container = element.parentElement;
  container.querySelectorAll('.feedback-type').forEach(el => el.classList.remove('active'));
  element.classList.add('active');

  const contentDiv = document.getElementById(`current-feedback-content-${topicId}`);

  if (type === 'text') {
    contentDiv.innerHTML = `<textarea id="current-feedback-text-${topicId}" rows="5" placeholder="Enter feedback text..." style="width: 100%;"></textarea>`;
  } else if (type === 'video') {
    contentDiv.innerHTML = `<input type="text" id="current-feedback-video-${topicId}" placeholder="Paste video URL: YouTube, Loom (share link), Vimeo, or Google Drive" style="width: 100%;">`;
    const info = document.createElement('div');
    info.style = 'font-size: 12px; color: #718096; margin-top: 5px;';
    info.innerHTML = `
      Supported formats:<br>
       YouTube: https://www.youtube.com/watch?v=...<br>
       Loom: https://www.loom.com/share/...<br>
       Vimeo: https://vimeo.com/...<br>
       Google Drive: Share link with view access
    `;
    contentDiv.appendChild(info);
  } else if (type === 'html') {
    contentDiv.innerHTML = `<textarea id="current-feedback-html-${topicId}" rows="8" placeholder="Enter HTML content..." style="width: 100%;"></textarea>`;
  }

  currentMaterialFeedbacks[topic].type = type;
}

function addTestMaterial() {
  const title = document.getElementById('materialTitle').value.trim();
  const content = document.getElementById('testMaterial').value.trim();
  const minutes = parseInt(document.getElementById('materialMinutes').value) || 0;
  const seconds = parseInt(document.getElementById('materialSeconds').value) || 0;

  if (!title || !content || currentMaterialTopics.length === 0) {
    alert('Please fill in material title, content, and add at least one topic');
    return;
  }

  if (minutes === 0 && seconds === 0) {
    alert('Please set a time limit for this test material');
    return;
  }

  currentMaterialTopics.forEach(topic => {
    const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');

    if (!currentMaterialFeedbacks[topic]) {
      currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
    }

    const type = currentMaterialFeedbacks[topic].type || 'text';
    let feedbackContent = '';

    if (type === 'text') {
      feedbackContent = document.getElementById(`current-feedback-text-${topicId}`)?.value ||
                        document.getElementById(`feedback-${topicId}`)?.value || '';
    } else if (type === 'video') {
      feedbackContent = document.getElementById(`current-feedback-video-${topicId}`)?.value || '';
    } else if (type === 'html') {
      feedbackContent = document.getElementById(`current-feedback-html-${topicId}`)?.value || '';
    }

    currentMaterialFeedbacks[topic].content = feedbackContent;

    if (!currentMaterialFeedbacks[topic].drillSentences) {
      currentMaterialFeedbacks[topic].drillSentences = {};
    }
  });

  const totalSeconds = minutes * 60 + seconds;

  const material = {
    title: title,
    content: content,
    topics: [...currentMaterialTopics],
    feedbacks: JSON.parse(JSON.stringify(currentMaterialFeedbacks)),
    timeLimit: totalSeconds
  };

  testMaterials.push(material);
  updateTestMaterialsList();

  document.getElementById('materialTitle').value = '';
  document.getElementById('testMaterial').value = '';
  document.getElementById('materialMinutes').value = '';
  document.getElementById('materialSeconds').value = '';
  currentMaterialTopics = [];
  currentMaterialFeedbacks = {};
  renderCurrentTopics();
  document.getElementById('currentTopicFeedbacks').innerHTML = '';
}

function updateTestMaterialsList() {
  const list = document.getElementById('testMaterialsList');
  list.innerHTML = '';

  if (testMaterials.length === 0) {
    list.innerHTML = '<p style="color: #718096;">No test materials added yet. Add your first test material below.</p>';
    return;
  }

  testMaterials.forEach((material, index) => {
    const minutes = Math.floor(material.timeLimit / 60);
    const seconds = material.timeLimit % 60;

    const materialCard = document.createElement('div');
    materialCard.className = 'test-card';
    materialCard.style.marginBottom = '15px';

    materialCard.innerHTML = `
      <div class="test-header">
        <div class="test-title">${index + 1}. ${material.title}</div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="editTestMaterial(${index})" style="padding: 6px 12px; font-size: 14px;"> Edit</button>
          <button class="btn btn-danger" onclick="removeTestMaterial(${index})" style="padding: 6px 12px; font-size: 14px;"> Remove</button>
        </div>
      </div>
      <div style="margin: 10px 0;">
        <strong>Time Limit:</strong> <span class="time-limit-badge">${minutes}:${seconds.toString().padStart(2, '0')}</span>
      </div>
      <div style="margin: 10px 0; color: #718096;">
        ${material.content.substring(0, 150)}${material.content.length > 150 ? '...' : ''}
      </div>
      <div class="topic-list">
        ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
      </div>
    `;

    list.appendChild(materialCard);
  });
}

function editTestMaterial(index) {
  const material = testMaterials[index];
  if (!material) return;

  document.getElementById('materialTitle').value = material.title || '';
  document.getElementById('testMaterial').value = material.content || '';

  const minutes = Math.floor(material.timeLimit / 60);
  const seconds = material.timeLimit % 60;
  document.getElementById('materialMinutes').value = minutes || '';
  document.getElementById('materialSeconds').value = seconds || '';

  currentMaterialTopics = material.topics ? [...material.topics] : [];
  renderCurrentTopics();

  currentMaterialFeedbacks = material.feedbacks ? JSON.parse(JSON.stringify(material.feedbacks)) : {};
  renderTopicFeedbacks();

  testMaterials.splice(index, 1);
  updateTestMaterialsList();

  document.getElementById('materialTitle').scrollIntoView({ behavior: 'smooth', block: 'center' });
  document.getElementById('materialTitle').focus();

  alert('Material loaded for editing. Make your changes and click "Add This Material" to save.');
}

function renderTopicFeedbacks() {
  const container = document.getElementById('currentTopicFeedbacks');
  if (!container) return;

  if (currentMaterialTopics.length === 0) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = currentMaterialTopics.map((topic, topicIndex) => {
    const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
    const feedback = currentMaterialFeedbacks[topic] || { type: 'text', content: '', drillSentences: {} };
    const drillSentences = feedback.drillSentences || {};

    return `
      <div class="feedback-card" style="margin-bottom: 15px; padding: 15px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 10px 0; color: #4a5568;">${topic}</h4>
        <textarea
          id="feedback-${topicId}"
          placeholder="Feedback for ${topic}..."
          style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"
          onchange="updateTopicFeedback('${topic}', this.value)"
        >${feedback.content || ''}</textarea>

        <!-- Grammar Drill Sentences by Score -->
        <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #86efac;">
          <h5 style="margin: 0 0 10px 0; color: #166534; display: flex; align-items: center; gap: 8px;">
             Grammar Drill Sentences by Score
            <span style="font-size: 12px; font-weight: normal; color: #15803d;">Different drills for each score level</span>
          </h5>
          <p style="font-size: 13px; color: #15803d; margin-bottom: 15px;">
            Create unique Q&A drill sentences for each score. Students receive drills matching their grade.
          </p>

          <!-- Score Tabs -->
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #86efac; padding-bottom: 10px;">
            ${[1,2,3,4,5,6,7,8,9,10].map(score => {
              const scoreDrills = drillSentences[score] || drillSentences[String(score)] || [];
              const hasDrills = Array.isArray(scoreDrills) ? scoreDrills.filter(s => s && s.question && s.answer).length > 0 : Object.values(scoreDrills).filter(s => s && s.question && s.answer).length > 0;
              const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];
              return `
                <button type="button"
                  id="grammar-drill-tab-${topicId}-${score}"
                  onclick="showGrammarDrillScoreTab('${topic}', ${topicIndex}, ${score})"
                  style="padding: 8px 12px; border: 2px solid ${hasDrills ? '#48bb78' : '#e2e8f0'};
                         background: ${hasDrills ? '#f0fff4' : 'white'}; border-radius: 8px; cursor: pointer;
                         font-weight: ${hasDrills ? '600' : '400'}; color: ${hasDrills ? '#276749' : '#4a5568'};
                         transition: all 0.2s;">
                  Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${reps})</span>
                  ${hasDrills ? '<span style="color: #48bb78;"></span>' : ''}
                </button>
              `;
            }).join('')}
          </div>

          <!-- Drill Content Area -->
          <div id="grammar-drill-content-${topicId}" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
            <div style="text-align: center; color: #15803d; padding: 20px;">
               Click a score tab above to add drill sentences for that score level
            </div>
          </div>

          <!-- Quick Info -->
          <div style="margin-top: 15px; font-size: 12px; color: #166534; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <div> <strong>Score 1-2:</strong> Most repetitions (6-7)</div>
            <div> <strong>Score 3-6:</strong> Medium repetitions (4-5)</div>
            <div> <strong>Score 7-9:</strong> Fewer repetitions (2-3)</div>
            <div> <strong>Score 10:</strong> Quick check (1)</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateTopicFeedback(topic, value) {
  if (!currentMaterialFeedbacks[topic]) {
    currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
  }
  currentMaterialFeedbacks[topic].content = value;
}

/**
 * Show grammar drill input section for a specific score
 */
function showGrammarDrillScoreTab(topic, topicIndex, score) {
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
  const contentDiv = document.getElementById(`grammar-drill-content-${topicId}`);

  if (!currentMaterialFeedbacks[topic]) {
    currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
  }
  if (!currentMaterialFeedbacks[topic].drillSentences) {
    currentMaterialFeedbacks[topic].drillSentences = {};
  }

  const drillSentences = currentMaterialFeedbacks[topic].drillSentences[score] || [];
  const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];

  for (let s = 1; s <= 10; s++) {
    const tabBtn = document.getElementById(`grammar-drill-tab-${topicId}-${s}`);
    if (tabBtn) {
      if (s === score) {
        tabBtn.style.background = '#dcfce7';
        tabBtn.style.borderColor = '#22c55e';
      } else {
        const sDrills = currentMaterialFeedbacks[topic].drillSentences[s] || currentMaterialFeedbacks[topic].drillSentences[String(s)] || [];
        const hasDrills = Array.isArray(sDrills) ? sDrills.filter(d => d && d.question && d.answer).length > 0 : Object.values(sDrills).filter(d => d && d.question && d.answer).length > 0;
        tabBtn.style.background = hasDrills ? '#f0fff4' : 'white';
        tabBtn.style.borderColor = hasDrills ? '#48bb78' : '#e2e8f0';
      }
    }
  }

  contentDiv.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h6 style="margin: 0; color: #166534;">
          Score ${score} Drill Sentences
          <span style="font-weight: normal; color: #15803d;">(Students repeat ${reps} each)</span>
        </h6>
        <span id="drill-count-${topicId}-${score}" style="font-size: 13px; color: ${drillSentences.length >= 10 || Object.keys(drillSentences).length >= 10 ? '#48bb78' : '#f59e0b'};">
          ${(Array.isArray(drillSentences) ? drillSentences : Object.values(drillSentences)).filter(s => s && s.question && s.answer).length}/20 sentences
        </span>
      </div>

      <!-- Tip -->
      <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
        <p style="font-size: 12px; color: #92400e; margin: 0;">
           <strong>Bulk Paste Tip:</strong> Copy multiple lines from Excel/Sheets, click on the first cell in a column, then paste (Ctrl+V). Lines will auto-fill down!
        </p>
      </div>

      <!-- Excel-like Grid Header -->
      <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 8px; padding: 8px; background: #166534; border-radius: 8px 8px 0 0; color: white; font-weight: 600; font-size: 13px;">
        <span style="text-align: center;">#</span>
        <span> Prompt / Question</span>
        <span> Answer</span>
      </div>

      <!-- Excel-like Grid Rows -->
      <div style="border: 2px solid #166534; border-top: none; border-radius: 0 0 8px 8px; overflow: hidden;">
        ${Array.from({length: 20}, (_, i) => {
          const sentence = drillSentences[i] || (drillSentences[String(i)]) || {};
          return `
          <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 0; background: ${i % 2 === 0 ? '#f0fdf4' : 'white'}; border-bottom: 1px solid #bbf7d0;">
            <span style="padding: 10px; text-align: center; font-weight: 600; color: #166534; font-size: 13px; border-right: 1px solid #bbf7d0; display: flex; align-items: center; justify-content: center;">${i+1}</span>
            <input type="text" id="grammar-drill-q-${topicId}-${score}-${i}"
              data-topic="${topic}" data-topic-index="${topicIndex}" data-score="${score}" data-row="${i}" data-field="question"
              placeholder="Prompt ${i+1}"
              style="padding: 10px; border: none; border-right: 1px solid #bbf7d0; background: transparent; font-size: 14px; outline: none;"
              value="${sentence.question || ''}"
              onchange="updateGrammarDrillSentence('${topic}', ${topicIndex}, ${score}, ${i}, 'question', this.value)"
              onpaste="handleGridPaste(event, '${topic}', ${topicIndex}, ${score}, ${i}, 'question')">
            <input type="text" id="grammar-drill-a-${topicId}-${score}-${i}"
              data-topic="${topic}" data-topic-index="${topicIndex}" data-score="${score}" data-row="${i}" data-field="answer"
              placeholder="Answer ${i+1}"
              style="padding: 10px; border: none; background: transparent; font-size: 14px; outline: none;"
              value="${sentence.answer || ''}"
              onchange="updateGrammarDrillSentence('${topic}', ${topicIndex}, ${score}, ${i}, 'answer', this.value)"
              onpaste="handleGridPaste(event, '${topic}', ${topicIndex}, ${score}, ${i}, 'answer')">
          </div>
        `}).join('')}
      </div>
    </div>
  `;
}

/**
 * Update individual grammar drill sentence for a specific score
 */
function updateGrammarDrillSentence(topic, topicIndex, score, sentenceIndex, field, value) {
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');

  if (!currentMaterialFeedbacks[topic]) {
    currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
  }
  if (!currentMaterialFeedbacks[topic].drillSentences) {
    currentMaterialFeedbacks[topic].drillSentences = {};
  }
  if (!currentMaterialFeedbacks[topic].drillSentences[score]) {
    currentMaterialFeedbacks[topic].drillSentences[score] = [];
  }
  if (!currentMaterialFeedbacks[topic].drillSentences[score][sentenceIndex]) {
    currentMaterialFeedbacks[topic].drillSentences[score][sentenceIndex] = { question: '', answer: '' };
  }

  currentMaterialFeedbacks[topic].drillSentences[score][sentenceIndex][field] = value;

  updateGrammarDrillTabIndicator(topic, topicIndex, score);
  updateDrillCount(topic, topicIndex, score);
}

/**
 * Update the drill count display
 */
function updateDrillCount(topic, topicIndex, score) {
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
  const countEl = document.getElementById(`drill-count-${topicId}-${score}`);
  if (!countEl) return;

  const drills = currentMaterialFeedbacks[topic]?.drillSentences?.[score] || [];
  const drillsArray = Array.isArray(drills) ? drills : Object.values(drills);
  const count = drillsArray.filter(s => s && s.question && s.answer).length;

  countEl.textContent = `${count}/20 sentences`;
  countEl.style.color = count >= 10 ? '#48bb78' : '#f59e0b';
}

/**
 * Handle paste event in grid cell - fills down the column with multiple lines
 */
function handleGridPaste(event, topic, topicIndex, score, startRow, field) {
  const pastedText = (event.clipboardData || window.clipboardData).getData('text');

  const lines = pastedText.split(/\r?\n/)
    .map(line => line.trim())
    .filter(line => line.length > 0); // Remove empty lines before processing

  if (lines.length <= 1) {
    return; // Don't prevent default - let single line paste normally
  }

  event.preventDefault();

  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');

  if (!currentMaterialFeedbacks[topic]) {
    currentMaterialFeedbacks[topic] = { type: 'text', content: '', drillSentences: {} };
  }
  if (!currentMaterialFeedbacks[topic].drillSentences) {
    currentMaterialFeedbacks[topic].drillSentences = {};
  }
  if (!currentMaterialFeedbacks[topic].drillSentences[score]) {
    currentMaterialFeedbacks[topic].drillSentences[score] = [];
  }

  let filledCount = 0;
  for (let i = 0; i < lines.length && (startRow + i) < 20; i++) {
    const rowIndex = startRow + i;
    const lineValue = lines[i];

    if (!currentMaterialFeedbacks[topic].drillSentences[score][rowIndex]) {
      currentMaterialFeedbacks[topic].drillSentences[score][rowIndex] = { question: '', answer: '' };
    }

    currentMaterialFeedbacks[topic].drillSentences[score][rowIndex][field] = lineValue;

    const inputId = field === 'question' ? `grammar-drill-q-${topicId}-${score}-${rowIndex}` : `grammar-drill-a-${topicId}-${score}-${rowIndex}`;
    const input = document.getElementById(inputId);
    if (input) {
      input.value = lineValue;
    }

    filledCount++;
  }

  updateGrammarDrillTabIndicator(topic, topicIndex, score);
  updateDrillCount(topic, topicIndex, score);

}

/**
 * Update the grammar drill tab indicator to show if a score has sentences
 */
function updateGrammarDrillTabIndicator(topic, topicIndex, score) {
  const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
  const tabBtn = document.getElementById(`grammar-drill-tab-${topicId}-${score}`);

  if (!tabBtn) return;

  const drills = currentMaterialFeedbacks[topic]?.drillSentences?.[score] || currentMaterialFeedbacks[topic]?.drillSentences?.[String(score)] || [];
  const drillsArray = Array.isArray(drills) ? drills : Object.values(drills);
  const hasDrills = drillsArray.filter(s => s && s.question && s.answer).length > 0;

  if (hasDrills) {
    tabBtn.innerHTML = `Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${({1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1})[score]})</span> <span style="color: #48bb78;"></span>`;
    tabBtn.style.fontWeight = '600';
    tabBtn.style.color = '#276749';
  } else {
    tabBtn.innerHTML = `Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${({1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1})[score]})</span>`;
    tabBtn.style.fontWeight = '400';
    tabBtn.style.color = '#4a5568';
  }
}

function removeTestMaterial(index) {
  if (confirm('Are you sure you want to remove this test material?')) {
    testMaterials.splice(index, 1);
    updateTestMaterialsList();
  }
}

async function startGradingVideoRecording() {
  try {
    const quality = VIDEO_QUALITY[currentVideoQuality] || VIDEO_QUALITY.medium;

    gradingVideoStream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: quality.width },
        height: { ideal: quality.height },
        frameRate: { ideal: quality.frameRate },
        facingMode: 'user'
      },
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });

    const videoPreview = document.getElementById('gradingVideoPreview');
    const videoContainer = document.getElementById('gradingVideoContainer');
    if (videoContainer) videoContainer.style.display = 'block';
    videoPreview.srcObject = gradingVideoStream;
    videoPreview.style.display = 'block';
    videoPreview.play();

    document.getElementById('gradingRecordedVideo').style.display = 'none';

    gradingVideoChunks = [];

    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
      ? 'video/webm;codecs=vp9,opus'
      : 'video/webm;codecs=vp8,opus';

    gradingVideoRecorder = new MediaRecorder(gradingVideoStream, {
      mimeType: mimeType,
      videoBitsPerSecond: quality.videoBitsPerSecond,
      audioBitsPerSecond: 128000
    });

    gradingVideoRecorder.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) {
        gradingVideoChunks.push(event.data);
      }
    };

    gradingVideoRecorder.onstop = () => {
      gradingVideoBlob = new Blob(gradingVideoChunks, { type: 'video/webm' });

      const recordedVideo = document.getElementById('gradingRecordedVideo');
      recordedVideo.src = URL.createObjectURL(gradingVideoBlob);
      recordedVideo.style.display = 'block';

      document.getElementById('gradingVideoPreview').style.display = 'none';

      if (gradingVideoStream) {
        gradingVideoStream.getTracks().forEach(track => track.stop());
      }

      document.getElementById('gradingVideoStatus').textContent = 'Video recorded successfully!';
      document.getElementById('gradingVideoStatus').style.color = '#48bb78';
    };

    gradingVideoRecorder.start(1000);

    document.getElementById('gradingStartVideoBtn').style.display = 'none';
    document.getElementById('gradingStopVideoBtn').style.display = 'inline-block';
    document.getElementById('gradingRetakeVideoBtn').style.display = 'none';
    document.getElementById('gradingRemoveVideoBtn').style.display = 'none';
    document.getElementById('gradingVideoStatus').textContent = 'Recording...';
    document.getElementById('gradingVideoStatus').style.color = '#ef4444';

  } catch (error) {
    alert('Failed to access camera: ' + error.message);
  }
}

function stopGradingVideoRecording() {
  if (gradingVideoRecorder && gradingVideoRecorder.state === 'recording') {
    gradingVideoRecorder.stop();

    document.getElementById('gradingStartVideoBtn').style.display = 'none';
    document.getElementById('gradingStopVideoBtn').style.display = 'none';
    document.getElementById('gradingRetakeVideoBtn').style.display = 'inline-block';
    document.getElementById('gradingRemoveVideoBtn').style.display = 'inline-block';
  }
}

function retakeGradingVideo() {
  gradingVideoBlob = null;

  document.getElementById('gradingRecordedVideo').style.display = 'none';

  document.getElementById('gradingStartVideoBtn').style.display = 'inline-block';
  document.getElementById('gradingRetakeVideoBtn').style.display = 'none';
  document.getElementById('gradingRemoveVideoBtn').style.display = 'none';
  document.getElementById('gradingVideoStatus').textContent = '';
}

function removeGradingVideo() {
  gradingVideoBlob = null;

  document.getElementById('gradingVideoPreview').style.display = 'none';
  document.getElementById('gradingRecordedVideo').style.display = 'none';

  document.getElementById('gradingStartVideoBtn').style.display = 'inline-block';
  document.getElementById('gradingRetakeVideoBtn').style.display = 'none';
  document.getElementById('gradingRemoveVideoBtn').style.display = 'none';
  document.getElementById('gradingVideoStatus').textContent = 'Video removed';
  document.getElementById('gradingVideoStatus').style.color = '#718096';
}

function switchVideoTab(tab) {
  const recordTab = document.getElementById('recordTabContent');
  const uploadTab = document.getElementById('uploadTabContent');
  const recordBtn = document.getElementById('recordTabBtn');
  const uploadBtn = document.getElementById('uploadTabBtn');

  if (!recordTab || !uploadTab) return;

  if (tab === 'record') {
    recordTab.style.display = 'block';
    uploadTab.style.display = 'none';
    recordBtn.style.background = '#667eea';
    recordBtn.style.color = 'white';
    uploadBtn.style.background = '#e2e8f0';
    uploadBtn.style.color = '#4a5568';
  } else {
    recordTab.style.display = 'none';
    uploadTab.style.display = 'block';
    uploadBtn.style.background = '#667eea';
    uploadBtn.style.color = 'white';
    recordBtn.style.background = '#e2e8f0';
    recordBtn.style.color = '#4a5568';
  }
}

async function handleFeedbackVideoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!file.type.startsWith('video/')) {
    alert('Please select a video file');
    return;
  }

  const maxSize = 100 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Video file is too large. Maximum size is 100MB.');
    return;
  }

  const statusEl = document.getElementById('gradingVideoStatus');
  if (statusEl) {
    statusEl.textContent = 'Processing video...';
    statusEl.style.color = '#667eea';
  }

  try {
    gradingVideoBlob = file;

    const previewContainer = document.getElementById('uploadedVideoPreviewContainer');
    const previewVideo = document.getElementById('uploadedVideoPreview');

    if (previewContainer && previewVideo) {
      const videoUrl = URL.createObjectURL(file);
      previewVideo.src = videoUrl;
      previewContainer.style.display = 'block';
    }

    if (statusEl) {
      statusEl.textContent = ' Video ready to upload (' + (file.size / (1024 * 1024)).toFixed(1) + ' MB)';
      statusEl.style.color = '#48bb78';
    }

  } catch (error) {
    if (statusEl) {
      statusEl.textContent = 'Error processing video: ' + error.message;
      statusEl.style.color = '#f56565';
    }
  }
}

function removeUploadedVideo() {
  gradingVideoBlob = null;

  const previewContainer = document.getElementById('uploadedVideoPreviewContainer');
  const previewVideo = document.getElementById('uploadedVideoPreview');
  const fileInput = document.getElementById('feedbackVideoUpload');

  if (previewContainer) previewContainer.style.display = 'none';
  if (previewVideo) previewVideo.src = '';
  if (fileInput) fileInput.value = '';

  const statusEl = document.getElementById('gradingVideoStatus');
  if (statusEl) {
    statusEl.textContent = 'Uploaded video removed';
    statusEl.style.color = '#718096';
  }
}

async function deleteExistingFeedbackVideo(submissionId) {
  if (!confirm('Are you sure you want to delete the existing feedback video? This cannot be undone.')) {
    return;
  }

  try {
    await db.collection('submissions2').doc(submissionId).update({
      videoFeedbackUrl: firebase.firestore.FieldValue.delete()
    });

    if (window.currentGradingData2) {
      window.currentGradingData2.existingVideoFeedbackUrl = null;
    }

    const existingSection = document.getElementById('existingVideoSection');
    if (existingSection) {
      existingSection.style.display = 'none';
    }

    const statusEl = document.getElementById('gradingVideoStatus');
    if (statusEl) {
      statusEl.innerHTML = '<p style="color: #48bb78;"> Existing video deleted successfully</p>';
    }

    alert('Feedback video deleted successfully!');

  } catch (error) {
    alert('Error deleting video: ' + error.message);
  }
}

async function saveCompleteTest() {
  const mainTitle = document.getElementById('mainTestTitle').value;

  if (!mainTitle) {
    alert('Please enter a main test title');
    return;
  }

  if (testMaterials.length === 0) {
    alert('Please add at least one test material');
    return;
  }

  try {
    if (editingTestId) {
      await db.collection('tests').doc(editingTestId).update({
        title: mainTitle,
        materials: testMaterials,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Test updated successfully!');
    } else {
      await db.collection('tests').add({
        title: mainTitle,
        materials: testMaterials,
        teacherId: currentUser.uid,
        teacherEmail: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Test saved successfully!');
    }

    document.getElementById('mainTestTitle').value = '';
    testMaterials = [];
    currentMaterialTopics = [];
    currentMaterialFeedbacks = {};
    editingTestId = null;
    updateTestMaterialsList();
    renderCurrentTopics();
    document.getElementById('currentTopicFeedbacks').innerHTML = '';

    document.getElementById('editingIndicator').style.display = 'none';

    const saveBtn = document.querySelector('#createTest .btn[onclick="saveCompleteTest()"]');
    if (saveBtn) {
      saveBtn.textContent = 'Save Complete Test';
      saveBtn.style.background = '';
    }
  } catch (error) {
    alert('Error saving test: ' + error.message);
  }
}

/**
 * Copy an existing test (creates a duplicate)
 */
async function copyTest(testId) {
  try {
    const testDoc = await db.collection('tests').doc(testId).get();
    if (!testDoc.exists) {
      alert('Test not found');
      return;
    }

    const testData = testDoc.data();

    const newTitle = testData.title + ' (Copy)';

    await db.collection('tests').add({
      title: newTitle,
      materials: testData.materials || [],
      teacherId: currentUser.uid,
      teacherEmail: currentUser.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Test copied successfully!');
    loadTests(); // Refresh the list
  } catch (error) {
    alert('Error copying test: ' + error.message);
  }
}

/**
 * Edit an existing test (loads it into the Create Test form)
 */
async function editTest(testId) {
  try {
    const testDoc = await db.collection('tests').doc(testId).get();
    if (!testDoc.exists) {
      alert('Test not found');
      return;
    }

    const testData = testDoc.data();

    editingTestId = testId;

    document.getElementById('mainTestTitle').value = testData.title || '';

    testMaterials = testData.materials ? JSON.parse(JSON.stringify(testData.materials)) : [];
    currentMaterialTopics = [];
    currentMaterialFeedbacks = {};

    updateTestMaterialsList();
    renderCurrentTopics();
    document.getElementById('currentTopicFeedbacks').innerHTML = '';

    document.getElementById('materialTitle').value = '';
    document.getElementById('testMaterial').value = '';
    document.getElementById('materialMinutes').value = '';
    document.getElementById('materialSeconds').value = '';

    document.getElementById('editingIndicator').style.display = 'block';

    const saveBtn = document.querySelector('#createTest .btn[onclick="saveCompleteTest()"]');
    if (saveBtn) {
      saveBtn.textContent = ' Update Test';
      saveBtn.style.background = '#48bb78';
    }

    switchTab('createTest');

    window.scrollTo(0, 0);

  } catch (error) {
    alert('Error loading test for editing: ' + error.message);
  }
}

/**
 * Cancel editing and reset the form
 */
function cancelEditTest() {
  editingTestId = null;
  document.getElementById('mainTestTitle').value = '';
  testMaterials = [];
  currentMaterialTopics = [];
  currentMaterialFeedbacks = {};
  updateTestMaterialsList();
  renderCurrentTopics();
  document.getElementById('currentTopicFeedbacks').innerHTML = '';

  document.getElementById('editingIndicator').style.display = 'none';

  const saveBtn = document.querySelector('#createTest .btn[onclick="saveCompleteTest()"]');
  if (saveBtn) {
    saveBtn.textContent = 'Save Complete Test';
    saveBtn.style.background = '';
  }
}

async function loadTests() {
  const testsList = document.getElementById('testsList');
  testsList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('tests')
      .where('teacherId', '==', currentUser.uid)
      .get();

    testsList.innerHTML = '';

    if (snapshot.empty) {
      testsList.innerHTML = '<p style="color: #718096; padding: 20px;">No tests created yet. Create your first test above!</p>';
      return;
    }

    const tests = [];
    snapshot.forEach(doc => {
      tests.push({ id: doc.id, ...doc.data() });
    });

    tests.sort((a, b) => {
      const aTime = a.createdAt ? a.createdAt.toDate() : new Date(0);
      const bTime = b.createdAt ? b.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    window.testsData = {};
    tests.forEach(test => {
      window.testsData[test.id] = test;
    });

    if (!document.getElementById('grammarTestFolderOverlay')) {
      const overlay = document.createElement('div');
      overlay.id = 'grammarTestFolderOverlay';
      overlay.className = 'folder-overlay';
      overlay.onclick = closeGrammarTestFolderModal;
      document.body.appendChild(overlay);

      const modal = document.createElement('div');
      modal.id = 'grammarTestFolderModal';
      modal.className = 'test-folder-content';
      document.body.appendChild(modal);
    }

    let foldersHtml = `
      <div style="display: flex; flex-wrap: wrap; gap: 15px; padding: 10px;">
    `;

    tests.forEach(test => {
      const materialsCount = test.materials ? test.materials.length : (test.topics ? test.topics.length : 0);
      const dateStr = test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'Recently';

      foldersHtml += `
        <div class="grammar-test-folder" onclick="openGrammarTestFolderModal('${test.id}')">
          <div class="test-folder-header">
            <span class="folder-icon"></span>
            <div class="folder-name">${test.title}</div>
            <div class="folder-stats">
              <span> ${materialsCount} ${test.materials ? 'materials' : 'topics'}</span>
            </div>
            <div class="folder-date">${dateStr}</div>
          </div>
        </div>
      `;
    });

    foldersHtml += '</div>';
    testsList.innerHTML = foldersHtml;

  } catch (error) {
    testsList.innerHTML = '<p>Error loading tests: ' + error.message + '</p>';
  }
}

/**
 * Open grammar test folder modal to show test details
 */
function openGrammarTestFolderModal(testId) {
  const test = window.testsData[testId];
  if (!test) return;

  const modal = document.getElementById('grammarTestFolderModal');
  const overlay = document.getElementById('grammarTestFolderOverlay');

  let materialsHtml = '';
  if (test.materials && test.materials.length > 0) {
    materialsHtml = test.materials.map((material, idx) => {
      const minutes = Math.floor(material.timeLimit / 60);
      const seconds = material.timeLimit % 60;
      const topicsHtml = material.topics ? material.topics.map(t => `<span class="topic-tag">${t}</span>`).join('') : '';

      return `
        <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #48bb78;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; color: #276749;">${idx + 1}. ${material.title}</div>
            <span style="background: #48bb78; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
               ${minutes}:${seconds.toString().padStart(2, '0')}
            </span>
          </div>
          <div style="color: #718096; font-size: 13px; margin-bottom: 8px;">
            ${material.content.substring(0, 150)}${material.content.length > 150 ? '...' : ''}
          </div>
          <div class="topic-list" style="display: flex; flex-wrap: wrap; gap: 5px;">
            ${topicsHtml}
          </div>
        </div>
      `;
    }).join('');
  } else if (test.topics) {
    materialsHtml = `
      <div style="background: #f0fff4; padding: 15px; border-radius: 10px; border-left: 4px solid #48bb78;">
        <div class="topic-list" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
          ${test.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
        </div>
        <div style="color: #718096; font-size: 13px;">
          ${test.material ? test.material.substring(0, 200) + (test.material.length > 200 ? '...' : '') : ''}
        </div>
      </div>
    `;
  } else {
    materialsHtml = '<p style="color: #718096;">No materials in this test.</p>';
  }

  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #c6f6d5;">
      <div>
        <h3 style="margin: 0; color: #276749;">${test.title}</h3>
        <span style="font-size: 13px; color: #2f855a;">
          Created: ${test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'Recently'}
        </span>
      </div>
      <button onclick="closeGrammarTestFolderModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #2f855a;"></button>
    </div>

    <div style="margin-bottom: 20px;">
      <h4 style="color: #276749; margin-bottom: 12px;"> Test Materials (${test.materials ? test.materials.length : (test.topics ? test.topics.length : 0)})</h4>
      ${materialsHtml}
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid #e2e8f0;">
      <button onclick="editTest('${test.id}'); closeGrammarTestFolderModal();" class="btn btn-warning" style="padding: 10px 20px;">
         Edit Test
      </button>
      <button onclick="copyTest('${test.id}'); closeGrammarTestFolderModal();" class="btn" style="padding: 10px 20px; background: #48bb78;">
         Copy Test
      </button>
      <button onclick="if(confirm('Are you sure you want to delete this test?')) { deleteTest('${test.id}'); closeGrammarTestFolderModal(); }" class="btn btn-danger" style="padding: 10px 20px;">
         Delete Test
      </button>
    </div>
  `;

  modal.classList.add('open');
  overlay.style.display = 'block';
}

/**
 * Close grammar test folder modal
 */
function closeGrammarTestFolderModal() {
  const modal = document.getElementById('grammarTestFolderModal');
  const overlay = document.getElementById('grammarTestFolderOverlay');

  if (modal) modal.classList.remove('open');
  if (overlay) overlay.style.display = 'none';
}

async function loadAvailableTests() {
  const testsList = document.getElementById('studentTestsList');
  testsList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('tests').get();

    testsList.innerHTML = '';

    if (snapshot.empty) {
      testsList.innerHTML = '<p>No tests available.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const test = doc.data();
      const testCard = document.createElement('div');
      testCard.className = 'test-card';

      let testInfo = '';
      if (test.materials && test.materials.length > 0) {
        const totalTime = test.materials.reduce((sum, m) => sum + m.timeLimit, 0);
        const totalMinutes = Math.floor(totalTime / 60);
        const totalSeconds = totalTime % 60;

        testInfo = `
          <div style="margin: 15px 0;">
            <strong>This test contains ${test.materials.length} timed material(s)</strong>
            <div style="margin-top: 10px; color: #718096;">
              Total test time: ${totalMinutes > 0 ? totalMinutes + ' min ' : ''}${totalSeconds} sec
            </div>
            <div style="margin-top: 10px;">
              ${test.materials.map((material, idx) => {
                const minutes = Math.floor(material.timeLimit / 60);
                const seconds = material.timeLimit % 60;
                return `
                  <div style="margin: 5px 0; padding: 10px; background: #f9fafb; border-radius: 6px;">
                    <strong>${idx + 1}. ${material.title}</strong> -
                    <span class="time-limit-badge">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      } else if (test.topics) {
        testInfo = `
          <div class="topic-list">
            ${test.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
          </div>
          <div style="margin-top: 10px; color: #718096;">
            ${test.material ? test.material.substring(0, 200) + (test.material.length > 200 ? '...' : '') : ''}
          </div>
        `;
      }

      testCard.innerHTML = `
        <div class="test-header">
          <div class="test-title">${test.title}</div>
          <div class="test-date">${test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'Recently created'}</div>
        </div>
        ${testInfo}
        <button onclick="startTest('${doc.id}')" class="btn btn-secondary">Take Test</button>
      `;

      testsList.appendChild(testCard);
    });
  } catch (error) {
    testsList.innerHTML = '<p>Error loading tests: ' + error.message + '</p>';
  }
}

async function startTest(testId) {
  try {
    const doc = await db.collection('tests').doc(testId).get();
    if (!doc.exists) {
      alert('Test not found');
      return;
    }

    currentTest = { id: testId, ...doc.data() };
    currentTestMaterialIndex = 0;
    recordingsData = {};

    document.getElementById('testModal').classList.add('active');
    document.getElementById('modalTestTitle').textContent = currentTest.title;

    if (currentTest.materials && currentTest.materials.length > 0) {
      document.getElementById('testMaterialDisplay').style.display = 'none';
      document.getElementById('progressTracker').style.display = 'block';
      updateProgressTracker();
      showTestMaterial(0);
    } else if (currentTest.material) {
      document.getElementById('testMaterialDisplay').style.display = 'block';
      document.getElementById('testMaterialDisplay').innerHTML = `
        <h3>Test Material</h3>
        <p style="white-space: pre-wrap; margin-top: 10px;">${currentTest.material}</p>
      `;
      document.getElementById('progressTracker').style.display = 'none';
      showSingleRecording();
    }
  } catch (error) {
    alert('Error starting test: ' + error.message);
  }
}

function updateProgressTracker() {
  const tracker = document.getElementById('progressTracker');
  tracker.innerHTML = '';

  const stepsContainer = document.createElement('div');
  stepsContainer.className = 'progress-steps';

  currentTest.materials.forEach((material, index) => {
    const step = document.createElement('div');
    step.className = 'progress-step';

    if (recordingsData[index]) {
      step.classList.add('completed');
    } else if (index === currentTestMaterialIndex) {
      step.classList.add('active');
    }

    step.innerHTML = `
      <div class="step-circle">${index + 1}</div>
      <div class="step-label">${material.title}</div>
    `;

    stepsContainer.appendChild(step);
  });

  tracker.appendChild(stepsContainer);
}

function showTestMaterial(index) {
  const material = currentTest.materials[index];
  const interface = document.getElementById('recordingInterface');

  const minutes = Math.floor(material.timeLimit / 60);
  const seconds = material.timeLimit % 60;

  const isRevealed = revealedMaterials[index] === true;
  const hasRecording = recordingsData[index] !== undefined;
  const attempts = materialAttempts[index] || 0;
  const attemptsRemaining = MAX_ATTEMPTS - attempts;

  if (isRevealed) {
    interface.innerHTML = `
      <div class="recording-section">
        <!-- Compact Sticky Timer - Left Side -->
        <div class="sticky-timer" id="stickyTimer">
          <div class="timer-content">
            <div class="timer-label">Time</div>
            <div class="timer-display" id="timerDisplay">${minutes}:${seconds.toString().padStart(2, '0')}</div>
            <div class="timer-progress">
              <div class="timer-progress-bar" id="progressBar" style="width: 100%;"></div>
            </div>
            <div class="attempt-badge">${attempts}/${MAX_ATTEMPTS}</div>
            <button class="stop-btn" onclick="stopRecording(${index})"> STOP</button>
          </div>
        </div>

        <!-- Video Preview -->
        <div class="video-preview-container" style="margin-top: 15px;">
          <video id="studentVideoPreview" class="video-preview" autoplay muted playsinline></video>
          <div class="video-preview-label">REC</div>
          <div class="hd-badge">HD ${currentVideoQuality.toUpperCase()}</div>
        </div>

        <!-- Live Transcription Display -->
        <div style="margin-top: 15px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 15px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 18px;"></span>
            <span style="font-weight: 600; color: #276749;">Live Korean Transcription</span>
            <span style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; animation: pulse 2s infinite;">LISTENING</span>
          </div>
          <div id="liveTranscriptionDisplay" style="background: white; border-radius: 8px; padding: 12px; min-height: 60px; font-size: 16px; line-height: 1.8; color: #2d3748;">
            <em style="color: #a0aec0;">Listening for Korean speech...</em>
          </div>
          <p style="color: #718096; font-size: 11px; margin: 8px 0 0 0;">
             This transcription will be saved with your recording for teacher review
          </p>
        </div>

        <h3 style="margin-top: 15px;">${material.title}</h3>

        <div class="recording-started-badge"> VIDEO RECORDING IN PROGRESS</div>

        <!-- Revealed Content -->
        <div class="test-content-revealed" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #f56565;">
          <p style="white-space: pre-wrap;">${material.content}</p>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
        </div>
      </div>
    `;
  }
  else if (hasRecording) {
    interface.innerHTML = `
      <div class="recording-section">
        <h3>${material.title}</h3>

        <!-- Video Recording Complete Badge -->
        <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 10px 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
          <span style="font-size: 16px;"> Video Recording Saved</span>
        </div>

        <!-- Locked Content - Recording Complete -->
        <div class="test-content-locked" style="position: relative; min-height: 200px;">
          <div class="test-content-blur" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="white-space: pre-wrap;">            </p>
          </div>

          <div class="lock-overlay" style="background: rgba(72, 187, 120, 0.95);">
            <div class="lock-icon"></div>
            <h3>Recording Saved!</h3>
            <p>Your video response has been recorded. You can redo or continue to the next material.</p>
            ${attemptsRemaining > 0 ? `
              <div class="lock-warning" style="background: rgba(255,255,255,0.2); color: #fff;">
                 ${attemptsRemaining} redo${attemptsRemaining > 1 ? 's' : ''} remaining
              </div>
            ` : `
              <div class="lock-warning" style="background: rgba(255,100,100,0.3); color: #fff;">
                 No redos remaining
              </div>
            `}
          </div>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <div style="color: #48bb78; font-weight: 600; margin-bottom: 15px;">
             Recording completed (Attempt ${attempts}/${MAX_ATTEMPTS})
          </div>

          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            ${index > 0 ? `<button onclick="showTestMaterial(${index - 1})" class="btn">Previous</button>` : ''}

            ${attemptsRemaining > 0 ? `
              <button onclick="redoRecording(${index})" class="btn btn-warning"> REDO (${attemptsRemaining} left)</button>
            ` : ''}

            ${index < currentTest.materials.length - 1 ? `
              <button onclick="showTestMaterial(${index + 1})" class="btn btn-secondary">Next Material </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }
  else {
    interface.innerHTML = `
      <div class="recording-section">
        <h3>${material.title}</h3>

        <!-- Video Quality Selector -->
        <div class="video-quality-selector">
          <label> Video Quality:</label>
          <select id="videoQualitySelect" onchange="currentVideoQuality = this.value">
            <option value="high" ${currentVideoQuality === 'high' ? 'selected' : ''}>High (1080p) - Best quality, larger file</option>
            <option value="medium" ${currentVideoQuality === 'medium' ? 'selected' : ''}>Medium (720p) - Good quality, faster upload</option>
            <option value="low" ${currentVideoQuality === 'low' ? 'selected' : ''}>Low (480p) - Fastest upload</option>
          </select>
        </div>
        <p style="font-size: 11px; color: #718096; margin: -10px 0 15px 0; padding-left: 15px;"> Lower quality = faster submission upload</p>

        <!-- Camera Preview Placeholder -->
        <div class="video-off-placeholder">
          <div class="camera-icon"></div>
          <p>Camera will activate when recording starts</p>
        </div>

        <!-- Locked Content Container -->
        <div class="test-content-locked" style="position: relative; min-height: 200px;">
          <div class="test-content-blur" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="white-space: pre-wrap;">            </p>
          </div>

          <div class="lock-overlay">
            <div class="lock-icon"></div>
            <h3>Test Content Locked</h3>
            <p>Press the record button below to reveal the test material and begin your video response.</p>
            <div class="lock-warning"> Time Limit: ${minutes}:${seconds.toString().padStart(2, '0')}  ${MAX_ATTEMPTS} attempts</div>
          </div>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
        </div>

        <div class="recording-controls" style="margin-top: 20px;">
          <p style="color: #667eea; font-size: 14px; margin-bottom: 15px; font-weight: 600;">
             Press Record to Reveal Content & Start Video Recording
          </p>
          <button class="record-btn" id="recordBtn" onclick="toggleRecording(${index})">
            <div class="record-icon"></div>
          </button>
          <button class="stop-btn" id="stopBtn" onclick="stopRecording(${index})" style="display: none;">
            STOP
          </button>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          ${index > 0 ? `<button onclick="showTestMaterial(${index - 1})" class="btn" style="margin-right: 10px;">Previous</button>` : ''}
        </div>
      </div>
    `;
  }

  currentTestMaterialIndex = index;
  updateProgressTracker();

  if (Object.keys(recordingsData).length === currentTest.materials.length) {
    document.getElementById('submitSection').style.display = 'block';
  } else {
    document.getElementById('submitSection').style.display = 'none';
  }
}

function showSingleRecording() {
  const interface = document.getElementById('recordingInterface');

  interface.innerHTML = `
    <div class="recording-section">
      <h3>Record Your Response</h3>
      <div class="topic-list">
        ${currentTest.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
      </div>

      <div class="recording-controls" style="margin-top: 30px;">
        <button class="record-btn" id="recordBtn" onclick="toggleSingleRecording()">
          <div class="record-icon"></div>
        </button>
      </div>

      <div id="recordingStatus" style="text-align: center; margin-top: 20px;"></div>
      <audio id="audioPlayback" controls style="width: 100%; margin-top: 20px; display: none;"></audio>

      <div style="margin-top: 30px; text-align: center;">
        <button onclick="submitSingleRecording()" class="btn btn-secondary" id="submitBtn" style="display: none;">Submit Test</button>
      </div>
    </div>
  `;
}

async function toggleSingleRecording() {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);

        const audioElement = document.getElementById('audioPlayback');
        audioElement.src = audioUrl;
        audioElement.style.display = 'block';

        recordingsData['single'] = {
          blob: audioBlob,
          topics: currentTest.topics
        };

        document.getElementById('submitBtn').style.display = 'inline-block';

        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start();

      document.getElementById('recordBtn').classList.add('recording');
      document.getElementById('recordingStatus').innerHTML = '<span style="color: #ef4444; font-weight: 600;">Recording...</span>';

    } catch (error) {
      alert('Error accessing microphone: ' + error.message);
    }
  } else if (mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('recordingStatus').innerHTML = '<span style="color: #48bb78; font-weight: 600;">Recording completed!</span>';
  }
}

async function submitSingleRecording() {
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  try {
    const timestamp = Date.now();
    const fileName = `${currentTest.id}_${timestamp}.webm`;

    const storageRef = firebase.storage().ref();
    const audioRef = storageRef.child(fileName);
    const snapshot = await audioRef.put(recordingsData['single'].blob);
    const audioUrl = await snapshot.ref.getDownloadURL();

    await db.collection('submissions').add({
      testId: currentTest.id,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      audioUrl: audioUrl,
      status: 'submitted',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Test submitted successfully!');
    closeTestModal();
    loadMySubmissions();

  } catch (error) {
    alert('Error submitting test: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Test';
  }
}

async function toggleRecording(materialIndex) {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    startRecording(materialIndex);
  }
}

async function startRecording(materialIndex) {
  try {
    const quality = VIDEO_QUALITY[currentVideoQuality] || VIDEO_QUALITY.medium;

    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      },
      video: {
        width: { ideal: quality.width },
        height: { ideal: quality.height },
        frameRate: { ideal: quality.frameRate },
        facingMode: 'user'
      }
    });

    studentVideoStream = stream;

    const activeTest = currentTest2 || currentTest;

    if (currentTest2) {
      revealedMaterials2[materialIndex] = true;
      materialAttempts2[materialIndex] = (materialAttempts2[materialIndex] || 0) + 1;
      displayTestMaterial2();
    } else {
      revealedMaterials[materialIndex] = true;
      materialAttempts[materialIndex] = (materialAttempts[materialIndex] || 0) + 1;
      showTestMaterial(materialIndex);
    }

    setTimeout(() => {
      const videoPreview = document.getElementById('studentVideoPreview');
      if (videoPreview) {
        videoPreview.srcObject = stream;
        videoPreview.play().catch(() => {});
      }
    }, 200);

    setTimeout(() => {
      const videoPreview = document.getElementById('studentVideoPreview');
      if (videoPreview && !videoPreview.srcObject) {
        videoPreview.srcObject = stream;
        videoPreview.play().catch(() => {});
      }
    }, 500);

    const material = activeTest.materials[materialIndex];
    maxTime = material.timeLimit;
    timeLeft = maxTime;

    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
      ? 'video/webm;codecs=vp9,opus'
      : 'video/webm;codecs=vp8,opus';

    mediaRecorder = new MediaRecorder(stream, {
      mimeType: mimeType,
      videoBitsPerSecond: quality.videoBitsPerSecond,
      audioBitsPerSecond: 128000
    });

    audioChunks = [];

    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };

    mediaRecorder.onstop = () => {
      const videoBlob = new Blob(audioChunks, { type: 'video/webm' });

      const transcriptionText = stopTranscription(materialIndex);

      if (currentTest2) {
        recordingsData2[materialIndex] = {
          blob: videoBlob,
          transcription: transcriptionText
        };
        revealedMaterials2[materialIndex] = false;
      } else {
        recordingsData[materialIndex] = {
          blob: videoBlob,
          material: material,
          transcription: transcriptionText
        };
        revealedMaterials[materialIndex] = false;
      }

      stream.getTracks().forEach(track => track.stop());
      studentVideoStream = null;

      if (currentTest2) {
        displayTestMaterial2();
      } else {
        showTestMaterial(materialIndex);
      }
    };

    mediaRecorder.start(1000);

    startTranscription(materialIndex);

    startTimer(materialIndex);

  } catch (error) {
    alert('Error accessing camera/microphone: ' + error.message + '\n\nPlease ensure you have granted camera and microphone permissions.');
  }
}

function startTimer(materialIndex) {
  clearInterval(recordingTimer);

  recordingTimer = setInterval(() => {
    timeLeft--;

    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const timerDisplay = document.getElementById('timerDisplay');
    if (timerDisplay) {
      timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    const progress = (timeLeft / maxTime) * 100;
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
      progressBar.style.width = progress + '%';
    }

    const stickyTimer = document.getElementById('stickyTimer');
    if (stickyTimer) {
      stickyTimer.classList.remove('warning', 'danger');
      if (timeLeft <= 10) {
        stickyTimer.classList.add('danger');
      } else if (timeLeft <= 30) {
        stickyTimer.classList.add('warning');
      }
    }

    if (timeLeft <= 0) {
      clearInterval(recordingTimer);
      stopRecording(materialIndex);
    }
  }, 1000);
}

function stopRecording(materialIndex) {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    clearInterval(recordingTimer);
    mediaRecorder.stop();
  }
}

function redoRecording(materialIndex) {
  const attempts = materialAttempts[materialIndex] || 0;
  const attemptsRemaining = MAX_ATTEMPTS - attempts;

  if (attemptsRemaining <= 0) {
    alert('No redo attempts remaining for this material.');
    return;
  }

  delete recordingsData[materialIndex];
  delete currentTranscription[materialIndex];

  showTestMaterial(materialIndex);
}

function reRecord(materialIndex) {
  if (currentTest2) {
    const attempts = materialAttempts2[materialIndex] || 0;
    const attemptsRemaining = MAX_ATTEMPTS - attempts;

    if (attemptsRemaining <= 0) {
      alert('No redo attempts remaining for this material.');
      return;
    }

    delete recordingsData2[materialIndex];
    delete currentTranscription[materialIndex];
    displayTestMaterial2();
  } else {
    redoRecording(materialIndex);
  }
}

async function submitAllRecordings() {
  const submitBtn = event.target;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';

  try {
    const submissions = [];

    for (const [index, data] of Object.entries(recordingsData)) {
      const timestamp = Date.now();
      const fileName = `recordings/${currentTest.id}_${index}_${timestamp}.webm`;

      const storageRef = firebase.storage().ref();
      const videoRef = storageRef.child(fileName);
      const snapshot = await videoRef.put(data.blob);
      const recordingUrl = await snapshot.ref.getDownloadURL();

      submissions.push({
        materialIndex: parseInt(index),
        materialTitle: data.material.title,
        topics: data.material.topics,
        recording: recordingUrl,
        transcription: data.transcription || '',
        attempts: materialAttempts[index] || 1
      });
    }

    await db.collection('submissions').add({
      testId: currentTest.id,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      materialSubmissions: submissions,
      status: 'submitted',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Test submitted successfully!');
    closeTestModal();
    loadMySubmissions();

  } catch (error) {
    alert('Error submitting test: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Test';
  }
}

async function loadSubmissions() {
  const submissionsList = document.getElementById('submissionsList');
  submissionsList.innerHTML = '<div class="loading"></div>';

  try {
    const testsSnapshot = await db.collection('tests')
      .where('teacherId', '==', currentUser.uid)
      .get();

    const testIds = testsSnapshot.docs.map(doc => doc.id);
    const testsMap = {};
    testsSnapshot.docs.forEach(doc => {
      testsMap[doc.id] = doc.data();
    });

    if (testIds.length === 0) {
      submissionsList.innerHTML = '<p>No tests created yet.</p>';
      return;
    }

    const submissionsSnapshot = await db.collection('submissions')
      .where('testId', 'in', testIds)
      .get();

    if (submissionsSnapshot.empty) {
      submissionsList.innerHTML = '<p>No submissions yet.</p>';
      return;
    }

    const studentGroups = {};

    submissionsSnapshot.docs.forEach(doc => {
      const submission = doc.data();
      const studentId = submission.studentId;
      const studentEmail = submission.studentEmail || 'Unknown Student';

      if (!studentGroups[studentId]) {
        studentGroups[studentId] = {
          email: studentEmail,
          submissions: []
        };
      }

      studentGroups[studentId].submissions.push({
        id: doc.id,
        data: submission,
        test: testsMap[submission.testId]
      });
    });

    window.studentFolderData = studentGroups;

    if (!document.getElementById('folderOverlay')) {
      const overlay = document.createElement('div');
      overlay.id = 'folderOverlay';
      overlay.className = 'folder-overlay';
      overlay.onclick = () => closeStudentFolderModal();
      document.body.appendChild(overlay);

      const modal = document.createElement('div');
      modal.id = 'studentFolderModal';
      modal.className = 'student-folder-content';
      document.body.appendChild(modal);
    }

    submissionsList.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 15px; padding-top: 15px;"></div>';
    const foldersContainer = submissionsList.firstChild;

    const sortedStudents = Object.entries(studentGroups).sort((a, b) => {
      const aPending = a[1].submissions.filter(s => s.data.status === 'submitted').length;
      const bPending = b[1].submissions.filter(s => s.data.status === 'submitted').length;

      if (aPending > 0 && bPending === 0) return -1;
      if (aPending === 0 && bPending > 0) return 1;

      const aLatest = Math.max(...a[1].submissions.map(s => s.data.submittedAt?.toDate?.() || 0));
      const bLatest = Math.max(...b[1].submissions.map(s => s.data.submittedAt?.toDate?.() || 0));
      return bLatest - aLatest;
    });

    sortedStudents.forEach(([studentId, group]) => {
      const pendingCount = group.submissions.filter(s => s.data.status === 'submitted').length;
      const gradedCount = group.submissions.filter(s => s.data.status === 'graded').length;
      const needsGrading = pendingCount > 0;

      group.submissions.sort((a, b) => {
        const aTime = a.data.submittedAt?.toDate?.() || new Date(0);
        const bTime = b.data.submittedAt?.toDate?.() || new Date(0);
        return bTime - aTime;
      });

      const displayName = group.email.split('@')[0];

      const studentFolder = document.createElement('div');
      studentFolder.className = `student-folder ${needsGrading ? 'needs-grading' : 'all-graded'}`;
      studentFolder.dataset.studentEmail = group.email.toLowerCase();
      studentFolder.dataset.status = needsGrading ? 'needs-grading' : 'all-graded';
      studentFolder.onclick = () => openStudentFolderModal(studentId);

      studentFolder.innerHTML = `
        <div class="student-folder-header">
          <div class="folder-icon">${needsGrading ? '' : ''}</div>
          <div class="student-name">${displayName}</div>
          <div class="student-stats">
            ${pendingCount > 0 ? `<span class="stat-badge stat-pending">${pendingCount}</span>` : ''}
            <span class="stat-badge stat-graded">${gradedCount}</span>
          </div>
        </div>
      `;

      foldersContainer.appendChild(studentFolder);
    });

  } catch (error) {
    submissionsList.innerHTML = '<p>Error loading submissions: ' + error.message + '</p>';
  }
}

function openStudentFolderModal(studentId) {
  const group = window.studentFolderData[studentId];
  if (!group) return;

  const modal = document.getElementById('studentFolderModal');
  const overlay = document.getElementById('folderOverlay');

  const pendingCount = group.submissions.filter(s => s.data.status === 'submitted').length;
  const gradedCount = group.submissions.filter(s => s.data.status === 'graded').length;

  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
      <div>
        <h3 style="margin: 0; color: #2d3748;"> ${group.email}</h3>
        <div style="margin-top: 8px; display: flex; gap: 10px;">
          ${pendingCount > 0 ? `<span style="background: #fef5e7; color: #d68910; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;"> ${pendingCount} Pending</span>` : ''}
          <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;"> ${gradedCount} Graded</span>
        </div>
      </div>
      <button onclick="closeStudentFolderModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;"></button>
    </div>
    <div class="student-history" style="display: block;">
      ${group.submissions.map(item => {
        const statusColor = item.data.status === 'submitted' ? '#f59e0b' : '#10b981';
        const statusText = item.data.status === 'submitted' ? 'Pending' : 'Graded';
        const statusIcon = item.data.status === 'submitted' ? '' : '';
        const submittedDate = item.data.submittedAt?.toDate?.();

        return `
          <div class="history-item" style="border-left-color: ${item.data.status === 'submitted' ? '#48bb78' : '#667eea'};">
            <div class="history-date">
              ${submittedDate ? submittedDate.toLocaleDateString() : 'Recently'}
              ${submittedDate ? submittedDate.toLocaleTimeString() : ''}
            </div>
            <div class="history-test" style="font-size: 16px; margin: 8px 0;">${item.test?.title || 'Unknown Test'}</div>
            <div style="margin: 10px 0;">
              <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                ${statusIcon} ${statusText}
              </span>
            </div>
            ${item.data.status === 'submitted' ? `
              <button onclick="closeStudentFolderModal(); openGradingModal('${item.id}')" class="btn" style="font-size: 13px; padding: 10px 20px; background: linear-gradient(135deg, #48bb78, #38a169); border: none; color: white; border-radius: 8px; cursor: pointer;">
                 Grade Now
              </button>
            ` : `
              <button onclick="closeStudentFolderModal(); openGradingModal('${item.id}')" class="btn" style="font-size: 13px; padding: 10px 20px; background: #667eea; border: none; color: white; border-radius: 8px; cursor: pointer;">
                 View / Regrade
              </button>
            `}
          </div>
        `;
      }).join('')}
    </div>
  `;

  modal.classList.add('open');
  overlay.classList.add('open');
}

function closeStudentFolderModal() {
  document.getElementById('studentFolderModal')?.classList.remove('open');
  document.getElementById('folderOverlay')?.classList.remove('open');
}

async function openGradingModal(submissionId) {
  try {
    const doc = await db.collection('submissions').doc(submissionId).get();
    const submission = doc.data();

    const testDoc = await db.collection('tests').doc(submission.testId).get();
    const test = testDoc.data();

    const modal = document.getElementById('gradingModal');
    const content = document.getElementById('gradingContent');

    let gradingHtml = `
      <h3>${test.title}</h3>
      <p>Student: ${submission.studentEmail}</p>
      <div style="margin-top: 20px;">
    `;

    if (submission.materialSubmissions) {
      submission.materialSubmissions.forEach(sub => {
        const material = test.materials[sub.materialIndex];

        gradingHtml += `
          <div class="grading-section">
            <h4>${sub.materialTitle}</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
              <div>
                <h5 style="color: #667eea; margin-bottom: 10px;"> Student Recording</h5>
                <video controls preload="metadata" src="${sub.recording}" style="width: 100%; border-radius: 8px; max-height: 350px;"></video>
              </div>
              <div>
                <h5 style="color: #48bb78; margin-bottom: 10px;"> Korean Transcription</h5>
                <div style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; min-height: 200px; max-height: 350px; overflow-y: auto; font-size: 16px; line-height: 1.8;">
                  ${sub.transcription ?
                    `<p style="color: #2d3748; white-space: pre-wrap;">${sub.transcription}</p>` :
                    `<p style="color: #a0aec0; font-style: italic;">No transcription available. This may be an older submission or speech was not detected.</p>`
                  }
                </div>
              </div>
            </div>
            <div>
              ${sub.topics.map(topic => `
                <div style="margin: 15px 0;">
                  <label style="font-weight: 600;">${topic} - Grade:</label>
                  <div class="grade-selector">
                    ${[1,2,3,4,5,6,7,8,9,10].map(grade => `
                      <button class="grade-btn" onclick="selectGrade('${sub.materialIndex}_${topic}', ${grade}, this)">${grade}</button>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
    }
    else if (submission.audioUrl) {
      gradingHtml += `
        <div class="grading-section">
          <video controls preload="metadata" src="${submission.audioUrl}" style="width: 100%; margin: 15px 0; border-radius: 8px; max-height: 400px;"></video>
          <div>
            ${test.topics.map(topic => `
              <div style="margin: 15px 0;">
                <label style="font-weight: 600;">${topic} - Grade:</label>
                <div class="grade-selector">
                  ${[1,2,3,4,5,6,7,8,9,10].map(grade => `
                    <button class="grade-btn" onclick="selectGrade('${topic}', ${grade}, this)">${grade}</button>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    gradingHtml += `
      </div>

      <!-- Teacher Feedback Video Section -->
      <div style="margin-top: 30px; background: #f7fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <h4 style="color: #667eea; margin-bottom: 15px;"> Record Feedback Video (Optional)</h4>
        <p style="color: #718096; margin-bottom: 15px;">Record a personalized video message for this student's feedback</p>

        <!-- Video Preview/Playback -->
        <div class="video-preview-container" style="max-width: 400px; margin: 0 auto 20px auto; display: none;" id="gradingVideoContainer">
          <video id="gradingVideoPreview" class="video-preview" style="width: 100%; border-radius: 8px; transform: scaleX(-1);"></video>
          <div class="video-preview-label">REC</div>
        </div>
        <video id="gradingRecordedVideo" controls style="width: 100%; max-width: 400px; border-radius: 8px; display: none; margin: 0 auto 20px auto;"></video>

        <!-- Recording Status -->
        <div id="gradingVideoStatus" style="text-align: center; margin: 15px 0; font-weight: 600; color: #667eea;"></div>

        <!-- Recording Controls -->
        <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
          <button id="gradingStartVideoBtn" onclick="startGradingVideoRecording()" class="btn btn-secondary">
             Start Recording
          </button>
          <button id="gradingStopVideoBtn" onclick="stopGradingVideoRecording()" class="btn btn-danger" style="display: none;">
             Stop Recording
          </button>
          <button id="gradingRetakeVideoBtn" onclick="retakeGradingVideo()" class="btn btn-warning" style="display: none;">
             Retake Video
          </button>
          <button id="gradingRemoveVideoBtn" onclick="removeGradingVideo()" class="btn btn-danger" style="display: none;">
             Remove Video
          </button>
        </div>
      </div>

      <button onclick="saveGrading('${submissionId}')" class="btn btn-secondary" style="margin-top: 20px; font-size: 16px; padding: 12px 24px;">Save Grading & Feedback</button>
    `;

    content.innerHTML = gradingHtml;
    modal.classList.add('active');

    fixWebmVideoDuration(content);

    window.currentGradingData = {
      submissionId: submissionId,
      grades: {},
      test: test // Store the full test data including materials and feedbacks
    };
  } catch (error) {
    alert('Error loading submission: ' + error.message);
  }
}

/**
 * Fix WebM video duration metadata issue
 * WebM files from MediaRecorder often don't have accurate duration in headers
 * This forces the browser to seek through to find the actual duration
 */
function fixWebmVideoDuration(container) {
  const videos = container.querySelectorAll('video');
  videos.forEach(video => {
    video.addEventListener('loadedmetadata', function() {
      if (video.duration === Infinity || video.duration < 0.1) {
        video.currentTime = Number.MAX_SAFE_INTEGER;

        video.addEventListener('timeupdate', function onTimeUpdate() {
          video.removeEventListener('timeupdate', onTimeUpdate);
          video.currentTime = 0;
        }, { once: true });
      }
    });

    if (video.readyState >= 1 && (video.duration === Infinity || video.duration < 0.1)) {
      video.currentTime = Number.MAX_SAFE_INTEGER;
      video.addEventListener('timeupdate', function() {
        video.currentTime = 0;
      }, { once: true });
    }
  });
}

function selectGrade(key, grade, button) {
  const parent = button.parentElement;
  parent.querySelectorAll('.grade-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  button.classList.add('selected');

  window.currentGradingData.grades[key] = grade;
}

async function saveGrading(submissionId) {
  try {
    const feedbackNeeded = {};
    const test = window.currentGradingData.test;
    let feedbackVideoUrl = null;

    if (gradingVideoBlob) {
      document.getElementById('gradingVideoStatus').textContent = 'Uploading video...';
      document.getElementById('gradingVideoStatus').style.color = '#667eea';

      const timestamp = Date.now();
      const videoFileName = `feedback_videos/${currentUser.uid}/${submissionId}_${timestamp}.webm`;
      const storageRef = firebase.storage().ref();
      const videoRef = storageRef.child(videoFileName);

      const snapshot = await videoRef.put(gradingVideoBlob);
      feedbackVideoUrl = await snapshot.ref.getDownloadURL();

      document.getElementById('gradingVideoStatus').textContent = 'Video uploaded successfully!';
      document.getElementById('gradingVideoStatus').style.color = '#48bb78';
    }

    Object.entries(window.currentGradingData.grades).forEach(([key, grade]) => {
      if (grade < 10) {
        if (key.includes('_')) {
          const [materialIndex, topic] = key.split('_');
          const material = test.materials[parseInt(materialIndex)];
          if (material && material.feedbacks && material.feedbacks[topic]) {
            feedbackNeeded[key] = material.feedbacks[topic];
          }
        }
        else if (test.feedbacks && test.feedbacks[key]) {
          feedbackNeeded[key] = test.feedbacks[key];
        }
      }
    });

    await db.collection('submissions').doc(submissionId).update({
      status: 'graded',
      grades: window.currentGradingData.grades,
      feedbackNeeded: feedbackNeeded,
      feedbackVideoUrl: feedbackVideoUrl, // Add feedback video URL
      gradedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Grading and feedback saved successfully!');

    gradingVideoBlob = null;

    closeGradingModal();
    loadSubmissions();
  } catch (error) {
    alert('Error saving grading: ' + error.message);
  }
}

async function loadMySubmissions() {
  const submissionsList = document.getElementById('studentSubmissionsList');
  submissionsList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('submissions')
      .where('studentId', '==', currentUser.uid)
      .get();

    submissionsList.innerHTML = '';

    if (snapshot.empty) {
      submissionsList.innerHTML = '<div class="empty-state"><h3>No submissions yet</h3><p>Take a test to see your submissions here!</p></div>';
      return;
    }

    const allSubmissions = [];
    snapshot.forEach(doc => {
      allSubmissions.push({ id: doc.id, data: doc.data() });
    });

    allSubmissions.sort((a, b) => {
      const aDate = a.data.submittedAt ? a.data.submittedAt.toDate() : new Date(0);
      const bDate = b.data.submittedAt ? b.data.submittedAt.toDate() : new Date(0);
      return bDate - aDate;
    });

    const submissionsByTest = {};

    for (const submission of allSubmissions) {
      const testDoc = await db.collection('tests').doc(submission.data.testId).get();
      if (testDoc.exists) {
        const testId = submission.data.testId;
        if (!submissionsByTest[testId]) {
          submissionsByTest[testId] = {
            test: testDoc.data(),
            submissions: []
          };
        }
        submissionsByTest[testId].submissions.push(submission);
      }
    }

    submissionsList.innerHTML = '<div id="submissionFolders"></div><div id="submissionDetails" style="display: none;"></div>';
    const foldersDiv = document.getElementById('submissionFolders');

    Object.entries(submissionsByTest).forEach(([testId, testData]) => {
      const latestSubmission = testData.submissions[0].data;
      const submissionDate = latestSubmission.submittedAt ? latestSubmission.submittedAt.toDate() : new Date();

      const gradedCount = testData.submissions.filter(s => s.data.status === 'graded').length;
      const pendingCount = testData.submissions.filter(s => s.data.status === 'submitted').length;

      const folderCard = document.createElement('div');
      folderCard.className = 'test-card';
      folderCard.style.cursor = 'pointer';
      folderCard.innerHTML = `
        <div class="test-header">
          <div>
            <div class="test-title"> ${testData.test.title}</div>
            <div class="test-date">Latest: ${submissionDate.toLocaleDateString()} | Total: ${testData.submissions.length} submission${testData.submissions.length > 1 ? 's' : ''}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            ${gradedCount > 0 ? `<span class="status-badge status-graded">${gradedCount} graded</span>` : ''}
            ${pendingCount > 0 ? `<span class="status-badge status-submitted">${pendingCount} pending</span>` : ''}
            <button class="btn" style="padding: 8px 16px;">View Details </button>
          </div>
        </div>
      `;

      folderCard.onclick = () => showTestSubmissions(testId, testData);
      foldersDiv.appendChild(folderCard);
    });
  } catch (error) {
    submissionsList.innerHTML = '<p>Error loading submissions: ' + error.message + '</p>';
  }
}

function showTestSubmissions(testId, testData) {
  const foldersDiv = document.getElementById('submissionFolders');
  const detailsDiv = document.getElementById('submissionDetails');

  foldersDiv.style.display = 'none';
  detailsDiv.style.display = 'block';

  let detailsHtml = `
    <button class="btn" onclick="backToSubmissionFolders()" style="margin-bottom: 20px;"> Back to All Submissions</button>
    <h2 style="color: #2d3748; margin-bottom: 20px;">${testData.test.title}</h2>
  `;

  testData.submissions.forEach((submission, index) => {
    const submissionData = submission.data;
    const submissionDate = submissionData.submittedAt ? submissionData.submittedAt.toDate() : new Date();

    let recordingsHtml = '';
    if (submissionData.materialSubmissions) {
      recordingsHtml = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px;">Recordings:</h4>';
      submissionData.materialSubmissions.forEach(sub => {
        recordingsHtml += `
          <div style="margin: 10px 0; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <strong>${sub.materialTitle}</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
              <div>
                <video controls preload="metadata" src="${sub.recording}" style="width: 100%; border-radius: 8px; max-height: 250px;"></video>
              </div>
              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; max-height: 250px; overflow-y: auto;">
                <p style="color: #718096; font-size: 12px; margin: 0 0 5px 0;"> Transcription:</p>
                ${sub.transcription ?
                  `<p style="color: #2d3748; font-size: 14px; line-height: 1.6; margin: 0; white-space: pre-wrap;">${sub.transcription}</p>` :
                  `<p style="color: #a0aec0; font-style: italic; font-size: 13px; margin: 0;">No transcription</p>`
                }
              </div>
            </div>
            ${submissionData.grades ?
              sub.topics.map(topic => {
                const gradeKey = `${sub.materialIndex}_${topic}`;
                return submissionData.grades[gradeKey] ?
                  `<div style="margin-top: 8px;"><strong>${topic}:</strong> ${submissionData.grades[gradeKey]}/10</div>`
                  : '';
              }).join('')
              : ''
            }
          </div>
        `;
      });
      recordingsHtml += '</div>';
    } else if (submissionData.audioUrl) {
      recordingsHtml = `
        <div style="margin-top: 15px;">
          <h4>Recording:</h4>
          <video controls preload="metadata" src="${submissionData.audioUrl}" style="width: 100%; margin: 15px 0; border-radius: 8px; max-height: 400px;"></video>
        </div>
      `;
    }

    let gradeInfo = '';
    if (submissionData.status === 'graded' && submissionData.grades) {
      const grades = Object.values(submissionData.grades);
      const avgGrade = grades.reduce((a, b) => a + b, 0) / grades.length;
      gradeInfo = `
        <div style="margin: 15px 0;">
          <h4>Grades:</h4>
          ${Object.entries(submissionData.grades).map(([topic, grade]) => {
            let topicName = topic;
            if (topic.includes('_')) {
              const parts = topic.split('_');
              topicName = parts.slice(1).join('_');
            }
            return `<div style="margin: 5px 0;"><strong>${topicName}:</strong> ${grade}/10</div>`;
          }).join('')}
          <div style="margin-top: 10px; font-size: 18px; font-weight: bold; color: ${avgGrade >= 8 ? '#48bb78' : avgGrade >= 6 ? '#ed8936' : '#f56565'};">
            Average: ${avgGrade.toFixed(1)}/10
          </div>
        </div>
      `;
    }

    detailsHtml += `
      <div class="test-card" style="margin-bottom: 20px;">
        <div class="test-header">
          <div class="test-title">Submission ${index + 1}</div>
          <div class="test-date">${submissionDate.toLocaleString()}</div>
        </div>
        <span class="status-badge status-${submissionData.status}">${submissionData.status.toUpperCase()}</span>
        ${gradeInfo}
        ${recordingsHtml}
      </div>
    `;
  });

  detailsDiv.innerHTML = detailsHtml;

  fixWebmVideoDuration(detailsDiv);
}

function backToSubmissionFolders() {
  document.getElementById('submissionFolders').style.display = 'block';
  document.getElementById('submissionDetails').style.display = 'none';
}


let currentFlashcardSet = null;
let currentWordPairs = [];
let currentSetIndex = 0;
let currentWordIndex = 0;
let flashcardTimer = null;
let flashcardTimerTimeout = null; // Track pending timer start timeout
let timeRemaining = 7;
let recognition = null;
let currentGameWords = [];
let gameResults = [];
let isListening = false;
let isFlashcardGameActive = false; // Track if game is in progress (for continuous recognition)
let flashcardWakeLock = null; // Keep screen awake during game
let missedWords = []; // Words that were incorrect - carry over to next set
let newWordsAddedToLeitner = 0; // Track new words added to calendar during game

let flashcardIsProcessingMatch = false;
let isGamePaused = false;

function initializeSpeechRecognition() {
  if (recognition) return;

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
  } else if ('SpeechRecognition' in window) {
    recognition = new SpeechRecognition();
  } else {
    alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
    return;
  }

  recognition.lang = 'ko-KR';
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    if (flashcardIsProcessingMatch) return;

    const latestResultIndex = event.results.length - 1;
    const latestResult = event.results[latestResultIndex];
    const transcript = latestResult[0].transcript.trim();

    document.getElementById('recognizedText').textContent = transcript;

    if (!latestResult.isFinal) {
      return;
    }


    if (currentWordIndex < currentGameWords.length) {
      const currentWord = currentGameWords[currentWordIndex];

      const normalizedTranscript = normalizeKoreanForVoice(transcript);
      const koreanWord = normalizeKoreanForVoice(currentWord.korean);

      // Check for exact match first (fast) before calculating similarity (slow)
      let isMatch = false;
      if (normalizedTranscript === koreanWord) {
        isMatch = true;
      } else {
        // Only calculate similarity if not exact match
        const similarity = calculateSimilarity(normalizedTranscript, koreanWord);
        if (similarity >= 0.90) {
          isMatch = true;
        }
      }

      if (isMatch) {
        flashcardIsProcessingMatch = true;
        wordCorrect(currentWordIndex);

        setTimeout(() => {
          flashcardIsProcessingMatch = false;
        }, 500);
      }
    }
  };

  recognition.onerror = (event) => {
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      if (isFlashcardGameActive) {
        showGameInterruptedScreen();
      }
    }
  };

  recognition.onend = () => {
    console.log('Recognition ended. isFlashcardGameActive:', isFlashcardGameActive, 'isListening:', isListening);
    
    // Only auto-restart if we're actively listening during a game
    // Don't restart during round transitions (isListening will be false)
    if (isFlashcardGameActive && isListening) {
      setTimeout(() => {
        if (isFlashcardGameActive && isListening) {
          try {
            recognition.start();
            console.log('Recognition restarted (continuous mode)');
          } catch (e) {
            console.error('Failed to restart recognition in onend:', e);
            // Don't show interrupted screen immediately - might be a transition
          }
        }
      }, 100);
    }
  };
}


let uploadedFiles = {};
let currentGameAssets = null;
let correctStreakInSet = 0;
let currentSetCorrectCount = 0;
let totalGameCorrect = 0;
let totalGameWords = 0;

let leitnerCards = [];
let leitnerDueCards = [];
let currentLeitnerQueue = [];
let currentLeitnerIndex = 0;
let leitnerSessionStats = { correct: 0, incorrect: 0 };
let studentLeitnerStats = null;
let isLeitnerCardFlipped = false;

const LEITNER_INTERVALS = {
  1: 1,    // Day 1 - review every 1 day
  2: 2,    // Day 2 - review every 2 days
  3: 3,    // Day 3 - review every 3 days
  4: 4,    // Day 4 - review every 4 days
  5: 5,    // Day 5 - review every 5 days
  6: 7,    // Weekly - review every 7 days
  7: 30,   // Monthly - review every 30 days
  8: null  // Mastery - no more reviews
};

const LEITNER_BOX_NAMES = {
  1: 'Day 1', 2: 'Day 2', 3: 'Day 3', 4: 'Day 4 (Semi-Mastery)',
  5: 'Day 5', 6: 'Weekly', 7: 'Monthly', 8: 'Mastery'
};

const LEITNER_BOX_CLASSES = {
  1: 'day1', 2: 'day2', 3: 'day3', 4: 'day4',
  5: 'day5', 6: 'weekly', 7: 'monthly', 8: 'mastery'
};

const LEITNER_BRAIN_DATA = {
  1: {
    color: '#e53e3e', // Red
    emoji: '',
    dominant: 'Hippocampus',
    regions: ['hippocampus'],
    failureRate: '~25-40%',
    shortExplanation: "This phrase is still in your brain's inbox.",
    fullExplanation: "Memory is new and fragile. It's highly cue-dependent, easy to forget or confuse, and interference risk is high. This is the most volatile stage.",
    researchTip: "For a phrase to reliably survive one night of sleep, you should have 3-5 successful retrievals within the first day, with at least 2 of them separated by time (not back-to-back). Use the mini-intervals: 30 min later, 2 hours later, and before sleep!"
  },
  2: {
    color: '#ed8936', // Orange
    emoji: '',
    dominant: 'Hippocampus + Early Neocortex',
    regions: ['hippocampus', 'neocortex-early'],
    failureRate: '~15-30%',
    shortExplanation: "Your brain is deciding if this is worth keeping.",
    fullExplanation: "The brain has started copying the memory but it's still fragile and needs protection. Still unstable, but improving. Small swaps only  avoid overload."
  },
  3: {
    color: '#ecc94b', // Yellow
    emoji: '',
    dominant: 'Hippocampus  Neocortex (shared)',
    regions: ['hippocampus', 'neocortex'],
    failureRate: '~10-20%',
    shortExplanation: "Your brain is moving this from short-term to long-term storage.",
    fullExplanation: "This is the transition zone (hippocampus  neocortex). Successful recall here is very important! Interference risk drops sharply after this. Safe to add small new vocab and begin situational cues."
  },
  4: {
    color: '#48bb78', // Green
    emoji: '',
    dominant: 'Neocortex (association areas)',
    regions: ['neocortex'],
    failureRate: '~5-15%',
    shortExplanation: "This phrase is starting to belong to you.",
    fullExplanation: "Memory is now neocortex-supported and no longer purely fragile. Recognition is fast and recall is more reliable. Failures at this stage are often access or durability issues, not complete loss. You're halfway to mastery!"
  },
  5: {
    color: '#4299e1', // Blue
    emoji: '',
    dominant: 'Neocortex (language networks)',
    regions: ['neocortex', 'temporal', 'frontal'],
    failureRate: '~10-25%',
    shortExplanation: "Your brain knows this without babysitting.",
    fullExplanation: "Yes, failure rate goes up again because the time gap is larger  but this is a significant milestone! Left temporal cortex handles meaning/vocabulary while frontal language areas handle selection and structure. Errors are now mostly performance, not forgetting."
  },
  6: {
    color: '#805ad5', // Purple
    emoji: '',
    dominant: 'Neocortex + Basal Ganglia',
    regions: ['neocortex', 'basal-ganglia'],
    failureRate: 'Low',
    shortExplanation: "This phrase is part of your working Korean.",
    fullExplanation: "Memory is stable and survives gaps. Basal ganglia start helping with habit formation. It feels 'familiar' in real situations. Strong situational recall training  free production begins here!"
  },
  7: {
    color: '#975a16', // Brown
    emoji: '',
    dominant: 'Neocortex + Basal Ganglia + Cerebellum',
    regions: ['neocortex', 'basal-ganglia', 'cerebellum'],
    failureRate: 'Very Low',
    shortExplanation: "You don't think much  it just comes out.",
    fullExplanation: "Phrase is semi-automatic with low cognitive load and high retrieval speed. Use in storytelling and combine with other structures."
  },
  8: {
    color: '#d69e2e', // Gold
    emoji: '',
    dominant: 'Procedural + Distributed Networks',
    regions: ['basal-ganglia', 'cerebellum', 'neocortex'],
    failureRate: 'Minimal',
    shortExplanation: "This is like riding a bike. You don't recall it  you do it.",
    fullExplanation: "Primarily basal ganglia (automatic retrieval), cerebellum (speech fluency/smoothness), and neocortex (meaning & flexibility). Phrase survives stress, comes out under emotion, and works in real conversation!"
  }
};

const LEITNER_LEECH_THRESHOLD = 5;

function addWordPair() {
  const englishWord = document.getElementById('englishWord').value.trim();
  const koreanWord = document.getElementById('koreanWord').value.trim();

  if (!englishWord || !koreanWord) {
    alert('Please enter both English and Korean words');
    return;
  }

  currentWordPairs.push({ english: englishWord, korean: koreanWord });
  updateWordPairsList();

  document.getElementById('englishWord').value = '';
  document.getElementById('koreanWord').value = '';
  document.getElementById('englishWord').focus();
}

document.addEventListener('DOMContentLoaded', function() {
  const englishInput = document.getElementById('englishWord');
  const koreanInput = document.getElementById('koreanWord');

  if (englishInput) {
    englishInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (this.value.trim()) {
          koreanInput.focus();
        }
      }
    });
  }

  if (koreanInput) {
    koreanInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addWordPair();
      }
    });
  }
});

function updateWordPairsList() {
  const listDiv = document.getElementById('wordPairsList');

  if (currentWordPairs.length === 0) {
    listDiv.innerHTML = '<p style="color: #718096;">No word pairs added yet. Add at least 5 words to create a set.</p>';
    return;
  }

  listDiv.innerHTML = currentWordPairs.map((pair, index) => {
    const hasAI = pair.aiData ? '' : '';
    return `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
      <span><strong>${index + 1}.</strong> ${pair.english}  ${pair.korean} ${hasAI}</span>
      <button class="btn btn-danger" onclick="removeWordPair(${index})" style="padding: 5px 10px; font-size: 14px;">Remove</button>
    </div>
  `}).join('');

  const aiCount = currentWordPairs.filter(p => p.aiData).length;
  let statusText = `<p style="margin-top: 15px; color: #48bb78; font-weight: 600;">Total words: ${currentWordPairs.length}</p>`;
  if (aiCount > 0) {
    statusText += `<p style="color: #667eea; font-size: 13px;"> AI data generated for ${aiCount}/${currentWordPairs.length} phrases</p>`;
  }
  listDiv.innerHTML += statusText;
}

function removeWordPair(index) {
  currentWordPairs.splice(index, 1);
  updateWordPairsList();
}

function importBulkWordPairs() {
  const englishText = document.getElementById('bulkEnglishWords').value.trim();
  const koreanText = document.getElementById('bulkKoreanWords').value.trim();
  const statusEl = document.getElementById('bulkImportStatus');

  if (!englishText || !koreanText) {
    statusEl.innerHTML = '<span style="color: #f56565;"> Please paste words in both columns</span>';
    return;
  }

  const englishWords = englishText.split(/[\n\r]+/).map(w => w.trim()).filter(w => w);
  const koreanWords = koreanText.split(/[\n\r]+/).map(w => w.trim()).filter(w => w);

  if (englishWords.length !== koreanWords.length) {
    statusEl.innerHTML = `<span style="color: #f56565;"> Mismatch: ${englishWords.length} English words vs ${koreanWords.length} Korean words</span>`;
    return;
  }

  if (englishWords.length === 0) {
    statusEl.innerHTML = '<span style="color: #f56565;"> No words found to import</span>';
    return;
  }

  let addedCount = 0;
  for (let i = 0; i < englishWords.length; i++) {
    const exists = currentWordPairs.some(p =>
      p.english.toLowerCase() === englishWords[i].toLowerCase() &&
      p.korean === koreanWords[i]
    );

    if (!exists) {
      currentWordPairs.push({
        english: englishWords[i],
        korean: koreanWords[i]
      });
      addedCount++;
    }
  }

  updateWordPairsList();

  const skipped = englishWords.length - addedCount;
  if (skipped > 0) {
    statusEl.innerHTML = `<span style="color: #48bb78;"> Imported ${addedCount} words</span> <span style="color: #ed8936;">(${skipped} duplicates skipped)</span>`;
  } else {
    statusEl.innerHTML = `<span style="color: #48bb78;"> Successfully imported ${addedCount} word pairs!</span>`;
  }

  document.getElementById('bulkEnglishWords').value = '';
  document.getElementById('bulkKoreanWords').value = '';
}

function clearBulkImport() {
  document.getElementById('bulkEnglishWords').value = '';
  document.getElementById('bulkKoreanWords').value = '';
  document.getElementById('bulkImportStatus').innerHTML = '';
}

function handleFileSelect(input, fieldName) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedFiles[fieldName] = e.target.result;

    const filenameElement = document.getElementById(fieldName + '-name');
    if (filenameElement) {
      filenameElement.textContent = file.name;
    }

    if (file.type.startsWith('image/')) {
      const previewDiv = document.getElementById(fieldName + '-preview');
      if (previewDiv) {
        previewDiv.innerHTML = `
          <div class="uploaded-preview">
            <img src="${e.target.result}" class="preview-thumbnail" alt="Preview">
            <span style="color: #48bb78;"> ${file.name}</span>
          </div>
        `;
      }
    }
  };
  reader.readAsDataURL(file);
}

async function uploadFileToStorage(file, path) {
  if (!file) return null;

  try {
    const storageRef = storage.ref(path);
    const snapshot = await storageRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();
    return downloadURL;
  } catch (error) {
    return null;
  }
}

async function saveFlashcardSet() {
  const title = document.getElementById('flashcardSetTitle').value.trim();
  const timerValue = parseInt(document.getElementById('flashcardTimer').value) || 7;
  const statusEl = document.getElementById('aiGenerationStatus');

  if (!title) {
    alert('Please enter a title for the flashcard set');
    return;
  }

  if (currentWordPairs.length < 5) {
    alert('Please add at least 5 word pairs to create a flashcard set');
    return;
  }

  try {
    const pairsNeedingAI = currentWordPairs.filter(p => !p.aiData || !p.aiData.wordData || p.aiData.wordData.length === 0);

    if (pairsNeedingAI.length > 0) {
      statusEl.style.display = 'block';
      statusEl.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      statusEl.style.color = 'white';
      statusEl.innerHTML = ' Generating AI data for ' + pairsNeedingAI.length + ' phrases before saving... Please wait.';

      for (let i = 0; i < currentWordPairs.length; i++) {
        const pair = currentWordPairs[i];

        if (pair.aiData && pair.aiData.wordData && pair.aiData.wordData.length > 0) {
          continue;
        }

        statusEl.innerHTML = ` Generating AI data (${i + 1}/${currentWordPairs.length}): "${pair.korean}"...`;

        try {
          const prompt = buildWordAnalysisPrompt(pair.korean, pair.english);

          const wordData = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: prompt }
          ], 0.3);

          currentWordPairs[i] = {
            ...pair,
            aiData: {
              wordData: Array.isArray(wordData) ? wordData : []
            }
          };
        } catch (aiError) {
        }
      }

      updateWordPairsList();

      statusEl.innerHTML = ' AI data generated! Now saving...';
    }

    const timestamp = Date.now();
    const setId = `flashcard_${timestamp}_${currentUser.uid}`;

    const assets = {
      progressImage: uploadedFiles.progressImage || null,
      progressSounds: [],
      perfectImage: uploadedFiles.perfectImage || null,
      perfectSound: uploadedFiles.perfectSound || null,
      almostImage: uploadedFiles.almostImage || null,
      almostSound: uploadedFiles.almostSound || null,
      startImage: uploadedFiles.startImage || null,
      startSound: uploadedFiles.startSound || null,
      timeoutImage: uploadedFiles.timeoutImage || null,
      timeoutSound: uploadedFiles.timeoutSound || null,
      endGifs: [],
      endSounds: []
    };

    for (let i = 1; i <= 4; i++) {
      if (uploadedFiles[`progressSound${i}`]) {
        assets.progressSounds[i-1] = uploadedFiles[`progressSound${i}`];
      }
    }

    for (let i = 1; i <= 6; i++) {
      if (uploadedFiles[`endGif${i}`]) {
        assets.endGifs[i-1] = uploadedFiles[`endGif${i}`];
      }
      if (uploadedFiles[`endSound${i}`]) {
        assets.endSounds[i-1] = uploadedFiles[`endSound${i}`];
      }
    }

    // Get current folder ID
    let currentFolderId = null;
    if (currentTeacherFolderPath && currentTeacherFolderPath.length > 0) {
      currentFolderId = currentTeacherFolderPath[currentTeacherFolderPath.length - 1].id;
    }

    const flashcardData = {
      title: title,
      wordPairs: currentWordPairs,
      timerSeconds: timerValue,
      teacherId: currentUser.uid,
      assets: assets,
      hasAIData: currentWordPairs.some(p => p.aiData),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Add folderId if we're inside a folder
    if (currentFolderId) {
      flashcardData.folderId = currentFolderId;
    }

    await db.collection('flashcards').add(flashcardData);

    statusEl.style.display = 'block';
    statusEl.style.background = 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)';
    statusEl.style.color = 'white';
    statusEl.innerHTML = ' Flashcard set saved successfully with AI data!';

    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 3000);

    document.getElementById('flashcardSetTitle').value = '';
    document.getElementById('flashcardTimer').value = '7';
    currentWordPairs = [];
    uploadedFiles = {};
    updateWordPairsList();

    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.value = '';
    });
    document.querySelectorAll('.file-name').forEach(span => {
      span.textContent = 'No file selected';
    });
    document.querySelectorAll('[id$="-preview"]').forEach(div => {
      if (div) div.innerHTML = '';
    });

    loadFlashcardSets(currentFolderId);
  } catch (error) {
    statusEl.style.display = 'block';
    statusEl.style.background = '#f56565';
    statusEl.style.color = 'white';
    statusEl.innerHTML = ' Error: ' + error.message;

    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
}

const AI_FUNCTION_URL = 'https://generateflashcardai-386010826708.us-central1.run.app';

/**
 * Build word analysis prompt
 */
function buildWordAnalysisPrompt(koreanPhrase, englishPhrase) {
  return `Analyze each word in this Korean phrase: "${koreanPhrase}" (English: "${englishPhrase}")

For EACH word, provide a JSON object with:
- word: the Korean word
- definition: English definition
- partOfSpeech: (noun, verb, adjective, adverb, particle, etc.)
- exampleSentence: a simple example sentence using this word (Korean with English translation in parentheses)
- grammarForms (if applicable, include only forms that exist for this word):
  - dictionaryForm: base form (e.g., )
  - presentTense: (e.g., )
  - pastTense: (e.g., )
  - futureTense: (e.g.,  )
  - adjectiveForm: if applicable
  - adverbForm: if applicable
  - modifierForm: (e.g., )

Return ONLY a valid JSON array of word objects, no explanation.`;
}

/**
 * Build situational response prompt for a single word
 */
function buildSituationalPrompt(koreanWord, englishDefinition) {
  return `You are a Korean language expert creating learning materials for students studying Korean conversation.

Given this Korean vocabulary word: "${koreanWord}" (English: "${englishDefinition}")

Create a REALISTIC conversational scenario where a Korean friend might share a problem or situation, and the student needs to respond using natural Korean that incorporates this vocabulary.

IMPORTANT GUIDELINES:
1. The SCENARIO should be a real-life situation (complaining about work, asking for advice, sharing good/bad news, etc.)
2. The RESPONSES must be what a supportive Korean friend would NATURALLY say - empathetic, helpful, conversational
3. The Korean MUST sound natural and colloquial, not textbook-style
4. Difficulty is based on GRAMMAR COMPLEXITY, not sentence length:
   - Novice (1pt): Simple sentences with basic connectors (, , -)
   - Novice (2pt): Slightly more complex with suggestions (-  , - )
   - Beginner (3pt): Uses QUOTING grammar (- , - )
   - Advanced Beginner (4pt): Combines QUOTING + CONNECTORS (- , - )

EXAMPLE of good output:
{
  "situation": {
    "korean": "            .",
    "english": "I have so much work these days, and I stay up late watching YouTube every night, so I'm really tired."
  },
  "responses": [
    {
      "level": "Novice",
      "points": 1,
      "english": "Everyone goes through that, so I hope you don't think you're the only one having a hard time.",
      "keywords": [{"korean": "", "english": "everyone"}, {"korean": " ", "english": "such a period"}, {"korean": "", "english": "only you"}],
      "korean": "   ,     ."
    },
    {
      "level": "Novice",
      "points": 2,
      "english": "You're sleeping too late these days, so it'd be good to watch less YouTube and sleep earlier.",
      "keywords": [{"korean": "", "english": "these days"}, {"korean": " ", "english": "to sleep late"}, {"korean": "", "english": "to reduce"}],
      "korean": "   ,       ."
    },
    {
      "level": "Beginner",
      "points": 3,
      "english": "My teacher said if you keep looking at a screen before bed, you wake up more, so it'd be good to sleep early from today.",
      "keywords": [{"korean": "", "english": "teacher"}, {"korean": " ", "english": "before sleeping"}, {"korean": "", "english": "screen"}, {"korean": "- ", "english": "quoting"}],
      "korean": "        ,     ."
    },
    {
      "level": "Advanced Beginner",
      "points": 4,
      "english": "I was like that too. The doctor said if you don't sleep enough, your health gets worse faster, so it'd be good to turn off YouTube and sleep earlier.",
      "keywords": [{"korean": " ", "english": "I was like that too"}, {"korean": " ", "english": "doctor"}, {"korean": " ", "english": "to lack sleep"}, {"korean": "- ", "english": "quoting + reason"}],
      "korean": " ,         .           ."
    }
  ]
}

Now create a similar scenario and responses for the word "${koreanWord}" (${englishDefinition}).
The scenario should naturally incorporate this vocabulary.
Make sure all Korean sounds natural and conversational, like what a real Korean person would say.

Return ONLY valid JSON in the exact format shown above, no explanation or markdown.`;
}

/**
 * Call AI proxy with custom messages
 */
async function callAIProxy(messages, temperature = 0.7) {
  const response = await fetch(AI_FUNCTION_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, temperature })
  });

  if (!response.ok) {
    throw new Error('AI call failed: ' + response.statusText);
  }

  const result = await response.json();
  if (!result.success) {
    throw new Error(result.error || 'AI call failed');
  }

  return result.data;
}

/**
 * Generate AI data (word definitions, grammar forms) for flashcard set
 * Note: Situational responses are generated on-demand when student adds to vocabulary
 */
async function generateAIData() {
  const title = document.getElementById('flashcardSetTitle').value.trim();
  const statusEl = document.getElementById('aiGenerationStatus');

  if (!title) {
    alert('Please enter a title for the flashcard set first');
    return;
  }

  if (currentWordPairs.length === 0) {
    alert('Please add word pairs before generating AI data');
    return;
  }

  statusEl.style.display = 'block';
  statusEl.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
  statusEl.style.color = 'white';
  statusEl.innerHTML = ' Generating word definitions for ' + currentWordPairs.length + ' phrases... This may take 30-60 seconds.';

  try {
    for (let i = 0; i < currentWordPairs.length; i++) {
      const pair = currentWordPairs[i];
      statusEl.innerHTML = ` Processing phrase ${i + 1}/${currentWordPairs.length}: "${pair.korean}"...`;

      const prompt = buildWordAnalysisPrompt(pair.korean, pair.english);

      const wordData = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.3);

      currentWordPairs[i] = {
        ...pair,
        aiData: {
          wordData: Array.isArray(wordData) ? wordData : []
        }
      };
    }

    updateWordPairsList();

    statusEl.style.background = 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)';
    statusEl.innerHTML = ' Word definitions generated for ' + currentWordPairs.length + ' phrases!';

    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);

  } catch (error) {
    statusEl.style.background = '#f56565';
    statusEl.innerHTML = ' Error: ' + error.message;

    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
}

// Track current folder navigation path
let currentTeacherFolderPath = []; // Array of {id, name} objects representing breadcrumb

async function loadFlashcardSets(parentFolderId = null) {
  const listDiv = document.getElementById('flashcardSetsList');
  if (!listDiv) return; // Exit if element doesn't exist
  
  listDiv.innerHTML = '<div class="loading"></div>';

  // Store current folder ID globally for drag/drop
  window.currentViewingFolderId = parentFolderId;

  try {
    // Load ALL admin flashcard folders (the ones students see)
    const foldersSnapshot = await db.collection('adminFlashcardFolders').get();

    window.adminFoldersCache = {};
    foldersSnapshot.forEach(doc => {
      window.adminFoldersCache[doc.id] = { id: doc.id, ...doc.data() };
    });
    const adminFolders = window.adminFoldersCache;

    // Load ALL flashcard sets
    const snapshot = await db.collection('flashcards').get();

    listDiv.innerHTML = '';

    const flashcards = [];
    snapshot.forEach(doc => {
      flashcards.push({ id: doc.id, ...doc.data() });
    });
    window.allFlashcardsCache = flashcards;

    // Get flashcard IDs that are in any folder
    const flashcardsInFolders = new Set();
    Object.values(adminFolders).forEach(folder => {
      (folder.flashcardIds || []).forEach(id => flashcardsInFolders.add(id));
    });

    // Get subfolders of current parent
    const subfolders = Object.values(adminFolders).filter(f => 
      (parentFolderId === null && !f.parentFolderId) || 
      f.parentFolderId === parentFolderId
    );

    // Get flashcards in current folder (or unfiled if at root)
    let currentFolderFlashcards = [];
    if (parentFolderId === null) {
      // At root - show unfiled flashcards
      currentFolderFlashcards = flashcards.filter(f => !flashcardsInFolders.has(f.id));
    } else {
      // Inside a folder - show flashcards in this folder
      const currentFolder = adminFolders[parentFolderId];
      if (currentFolder && currentFolder.flashcardIds) {
        currentFolderFlashcards = flashcards.filter(f => currentFolder.flashcardIds.includes(f.id));
      }
    }

    // Add Bulk Actions Toolbar
    const bulkToolbar = document.createElement('div');
    bulkToolbar.className = 'bulk-actions-toolbar';
    bulkToolbar.id = 'bulkActionsToolbar';
    bulkToolbar.innerHTML = `
      <span class="selected-count"><span id="selectedItemCount">0</span> item(s) selected</span>
      <button class="bulk-btn-move" onclick="openMoveToFolderModal()"> Move to Folder</button>
      <button class="bulk-btn-delete" onclick="bulkDeleteSelected()"> Delete</button>
      <button class="bulk-btn-cancel" onclick="clearBulkSelection()"> Cancel</button>
    `;
    listDiv.appendChild(bulkToolbar);

    // Render breadcrumb navigation if we're in a subfolder
    if (currentTeacherFolderPath.length > 0) {
      const breadcrumbDiv = document.createElement('div');
      breadcrumbDiv.className = 'folder-breadcrumb';
      breadcrumbDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border-radius: 10px; flex-wrap: wrap;';
      
      let breadcrumbHtml = `<span onclick="navigateToTeacherFolder(null)" style="cursor: pointer; color: #667eea; font-weight: 600;"> Root</span>`;
      
      currentTeacherFolderPath.forEach((folder, index) => {
        breadcrumbHtml += `<span style="color: #a0aec0;"></span>`;
        if (index === currentTeacherFolderPath.length - 1) {
          breadcrumbHtml += `<span style="color: #2d3748; font-weight: 600;"> ${folder.name}</span>`;
        } else {
          breadcrumbHtml += `<span onclick="navigateToTeacherFolder('${folder.id}', ${index})" style="cursor: pointer; color: #667eea; font-weight: 600;"> ${folder.name}</span>`;
        }
      });
      
      breadcrumbDiv.innerHTML = breadcrumbHtml;
      listDiv.appendChild(breadcrumbDiv);
    }

    // Check which folders are master folders (have children)
    const masterFolderIds = new Set(Object.values(adminFolders).filter(f => f.parentFolderId).map(f => f.parentFolderId));

    // Drop zone for moving items to current folder or root
    if (parentFolderId !== null) {
      const dropZone = document.createElement('div');
      dropZone.className = 'drop-zone-indicator';
      dropZone.id = 'currentFolderDropZone';
      dropZone.innerHTML = ' Drop flashcard sets here to add to this folder';
      dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
      dropZone.ondragleave = () => dropZone.classList.remove('active');
      dropZone.ondrop = (e) => handleDropOnFolder(e, parentFolderId);
      listDiv.appendChild(dropZone);
    }

    if (subfolders.length === 0 && currentFolderFlashcards.length === 0) {
      if (parentFolderId === null) {
        listDiv.innerHTML += '<p style="color: #718096;">No flashcard sets created yet. Use the "Admin Folder Dashboard" above to create folders and organize flashcard sets for students.</p>';
      } else {
        listDiv.innerHTML += '<p style="color: #718096; padding: 20px;">This folder is empty. Drag flashcard sets here to add them.</p>';
      }
      return;
    }

    // Select All checkbox
    if (subfolders.length > 0 || currentFolderFlashcards.length > 0) {
      const selectAllDiv = document.createElement('div');
      selectAllDiv.className = 'select-all-container';
      selectAllDiv.innerHTML = `
        <label>
          <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
          Select All
        </label>
        <span style="color: #718096; font-size: 12px; margin-left: auto;">
           Tip: Click checkboxes to select, then use bulk actions. Drag items to move them.
        </span>
      `;
      listDiv.appendChild(selectAllDiv);
    }

    // Render subfolders grid
    if (subfolders.length > 0) {
      const foldersLabel = document.createElement('h4');
      foldersLabel.style.cssText = 'color: #4a5568; margin: 0 0 15px 0; font-size: 14px;';
      foldersLabel.textContent = ' Folders';
      listDiv.appendChild(foldersLabel);

      const foldersGridDiv = document.createElement('div');
      foldersGridDiv.className = 'fc-sets-grid';
      foldersGridDiv.style.marginBottom = '30px';
      
      subfolders.forEach(folder => {
        // Count items in this folder
        const childFolders = Object.values(adminFolders).filter(f => f.parentFolderId === folder.id);
        const folderFlashcardCount = (folder.flashcardIds || []).length;
        const totalItems = childFolders.length + folderFlashcardCount;
        
        // Check if this is a master folder (has subfolders inside)
        const isMasterFolder = masterFolderIds.has(folder.id);
        
        // Get the parent folder name if this folder has a parent
        const parentFolder = folder.parentFolderId ? adminFolders[folder.parentFolderId] : null;
        let parentPathHtml = '';
        if (parentFolder) {
          parentPathHtml = `<div class="folder-parent-path" style="font-size: 9px; color: #ffd700; margin-bottom: 4px; opacity: 0.9;"> ${parentFolder.name}</div>`;
        }
        
        const folderCard = document.createElement('div');
        // Master folders get yellow styling
        folderCard.className = isMasterFolder ? 'fc-folder-card master-folder' : 'fc-folder-card admin-folder';
        folderCard.style.cursor = 'pointer';
        folderCard.dataset.folderId = folder.id;
        folderCard.dataset.type = 'folder';
        
        // Drag and drop handlers for folder (as drop target)
        folderCard.ondragover = (e) => { e.preventDefault(); folderCard.classList.add('drag-over'); };
        folderCard.ondragleave = () => folderCard.classList.remove('drag-over');
        folderCard.ondrop = (e) => handleDropOnFolder(e, folder.id);
        
        folderCard.onclick = (e) => {
          if (e.target.classList.contains('bulk-select-checkbox') || e.target.closest('.set-actions')) return;
          navigateIntoTeacherFolder(folder.id, folder.name);
        };
        
        folderCard.innerHTML = `
          <div class="bulk-select-checkbox" onclick="event.stopPropagation(); toggleItemSelection('${folder.id}', 'folder', this)"></div>
          <div class="set-actions" onclick="event.stopPropagation()">
            <button class="set-action-btn duplicate" onclick="event.stopPropagation(); duplicateAdminFolder('${folder.id}')" title="Duplicate Folder"></button>
            <button class="set-action-btn edit" onclick="event.stopPropagation(); openEditAdminFolderModal('${folder.id}')" title="Edit Folder"></button>
            <button class="set-action-btn delete" onclick="event.stopPropagation(); deleteAdminFolder('${folder.id}')" title="Delete Folder"></button>
          </div>
          ${isMasterFolder ? '<div class="folder-badge" style="background: rgba(120, 53, 15, 0.8); color: #fef3c7;">MASTER</div>' : ''}
          ${parentPathHtml}
          <div class="folder-icon">${folder.icon || ''}</div>
          <div class="folder-name">${folder.name}</div>
          <div class="folder-count">${totalItems} item${totalItems !== 1 ? 's' : ''}${isMasterFolder ? ' (' + childFolders.length + ')' : ''}</div>
        `;
        foldersGridDiv.appendChild(folderCard);
      });
      
      listDiv.appendChild(foldersGridDiv);
    }

    // Render flashcards in current folder
    if (currentFolderFlashcards.length > 0) {
      const setsLabel = document.createElement('h4');
      setsLabel.style.cssText = 'color: #4a5568; margin: 0 0 15px 0; font-size: 14px;';
      setsLabel.textContent = parentFolderId ? ' Flashcard Sets in this Folder' : ' Unfiled Flashcard Sets';
      listDiv.appendChild(setsLabel);
      
      const setsDiv = document.createElement('div');
      setsDiv.innerHTML = renderFlashcardsWithBulk(currentFolderFlashcards, parentFolderId);
      listDiv.appendChild(setsDiv);
    }

  } catch (error) {
    listDiv.innerHTML = '<p>Error loading flashcard sets: ' + error.message + '</p>';
  }
}

function navigateIntoTeacherFolder(folderId, folderName) {
  currentTeacherFolderPath.push({ id: folderId, name: folderName });
  updateCurrentFolderIndicator();
  loadFlashcardSets(folderId);
}

function navigateToTeacherFolder(folderId, pathIndex = -1) {
  if (folderId === null) {
    currentTeacherFolderPath = [];
  } else {
    // Truncate path to the clicked folder
    currentTeacherFolderPath = currentTeacherFolderPath.slice(0, pathIndex + 1);
  }
  updateCurrentFolderIndicator();
  loadFlashcardSets(folderId);
}

function updateCurrentFolderIndicator() {
  const indicator = document.getElementById('currentFolderIndicator');
  const nameSpan = document.getElementById('currentFolderName');
  
  if (!indicator || !nameSpan) return;
  
  if (currentTeacherFolderPath.length > 0) {
    const fullPath = currentTeacherFolderPath.map(f => f.name).join('  ');
    nameSpan.textContent = fullPath;
    indicator.style.display = 'block';
  } else {
    indicator.style.display = 'none';
  }
}

async function deleteTeacherFolder(folderId) {
  if (!confirm('Are you sure you want to delete this folder? All contents will be moved to the parent folder.')) {
    return;
  }

  try {
    const folder = folders[folderId];
    const parentId = folder?.parentFolderId || null;
    
    // Move all flashcards in this folder to parent
    const flashcardsSnap = await db.collection('flashcards')
      .where('folderId', '==', folderId)
      .get();
    
    const batch = db.batch();
    flashcardsSnap.forEach(doc => {
      if (parentId) {
        batch.update(doc.ref, { folderId: parentId });
      } else {
        batch.update(doc.ref, { folderId: firebase.firestore.FieldValue.delete() });
      }
    });
    
    // Move all subfolders to parent
    const subfoldersSnap = await db.collection('folders')
      .where('parentFolderId', '==', folderId)
      .get();
    
    subfoldersSnap.forEach(doc => {
      if (parentId) {
        batch.update(doc.ref, { parentFolderId: parentId });
      } else {
        batch.update(doc.ref, { parentFolderId: firebase.firestore.FieldValue.delete() });
      }
    });
    
    // Delete the folder
    batch.delete(db.collection('folders').doc(folderId));
    
    await batch.commit();
    alert('Folder deleted successfully');
    
    // Reload current view
    const currentFolderId = currentTeacherFolderPath.length > 0 
      ? currentTeacherFolderPath[currentTeacherFolderPath.length - 1].id 
      : null;
    
    // If we deleted the folder we're in, go up one level
    if (currentFolderId === folderId) {
      currentTeacherFolderPath.pop();
      const newFolderId = currentTeacherFolderPath.length > 0 
        ? currentTeacherFolderPath[currentTeacherFolderPath.length - 1].id 
        : null;
      loadFlashcardSets(newFolderId);
    } else {
      loadFlashcardSets(currentFolderId);
    }
  } catch (error) {
    alert('Error deleting folder: ' + error.message);
  }
}

function renderFlashcards(flashcards, folderId) {
  if (!flashcards || flashcards.length === 0) return '<p style="color: #718096; padding: 15px;">No flashcard sets in this folder yet. Drag sets here or create new ones.</p>';

  const cardsHtml = flashcards.map(set => {
    const wordCount = (set.wordPairs && Array.isArray(set.wordPairs)) ? set.wordPairs.length : 0;
    return `
      <div class="fc-set-card-teacher" draggable="true" ondragstart="handleDragStart(event, '${set.id}', 'flashcards')" onclick="editFlashcard('${set.id}')">
        <div class="set-actions" onclick="event.stopPropagation()">
          <button class="set-action-btn duplicate" onclick="event.stopPropagation(); duplicateFlashcardSet('${set.id}')" title="Duplicate"></button>
          <button class="set-action-btn delete" onclick="event.stopPropagation(); deleteFlashcardSet('${set.id}')" title="Delete"></button>
        </div>
        <div class="set-icon"></div>
        <div class="set-title">${set.title || 'Untitled'}</div>
        <div class="set-count">${wordCount} words</div>
      </div>
    `;
  }).join('');

  return `<div class="fc-sets-grid">${cardsHtml}</div>`;
}

// New function with bulk selection checkboxes
function renderFlashcardsWithBulk(flashcards, folderId) {
  if (!flashcards || flashcards.length === 0) return '<p style="color: #718096; padding: 15px;">No flashcard sets in this folder yet. Drag sets here or create new ones.</p>';

  const cardsHtml = flashcards.map(set => {
    const wordCount = (set.wordPairs && Array.isArray(set.wordPairs)) ? set.wordPairs.length : 0;
    return `
      <div class="fc-set-card-teacher" 
           draggable="true" 
           data-set-id="${set.id}"
           data-type="flashcard"
           ondragstart="handleFlashcardDragStart(event, '${set.id}')"
           ondragend="handleDragEnd(event)"
           onclick="handleFlashcardClick(event, '${set.id}')">
        <div class="bulk-select-checkbox" onclick="event.stopPropagation(); toggleItemSelection('${set.id}', 'flashcard', this)"></div>
        <div class="set-actions" onclick="event.stopPropagation()">
          <button class="set-action-btn duplicate" onclick="event.stopPropagation(); duplicateFlashcardSet('${set.id}')" title="Duplicate"></button>
          <button class="set-action-btn delete" onclick="event.stopPropagation(); deleteFlashcardSet('${set.id}')" title="Delete"></button>
        </div>
        <div class="set-icon"></div>
        <div class="set-title">${set.title || 'Untitled'}</div>
        <div class="set-count">${wordCount} words</div>
      </div>
    `;
  }).join('');

  return `<div class="fc-sets-grid">${cardsHtml}</div>`;
}

// ==========================================
// BULK SELECTION FUNCTIONS
// ==========================================

window.selectedItems = { folders: new Set(), flashcards: new Set() };

function toggleItemSelection(itemId, type, checkboxEl) {
  const setKey = type === 'folder' ? 'folders' : 'flashcards';
  const card = checkboxEl.closest('.fc-folder-card, .fc-set-card-teacher');
  
  if (window.selectedItems[setKey].has(itemId)) {
    window.selectedItems[setKey].delete(itemId);
    checkboxEl.classList.remove('selected');
    if (card) card.classList.remove('selected');
  } else {
    window.selectedItems[setKey].add(itemId);
    checkboxEl.classList.add('selected');
    if (card) card.classList.add('selected');
  }
  
  updateBulkToolbar();
}

function toggleSelectAll(checked) {
  const allCheckboxes = document.querySelectorAll('.bulk-select-checkbox');
  
  allCheckboxes.forEach(cb => {
    const card = cb.closest('.fc-folder-card, .fc-set-card-teacher');
    const itemId = card?.dataset?.folderId || card?.dataset?.setId;
    const type = card?.dataset?.type;
    
    if (!itemId || !type) return;
    
    const setKey = type === 'folder' ? 'folders' : 'flashcards';
    
    if (checked) {
      window.selectedItems[setKey].add(itemId);
      cb.classList.add('selected');
      if (card) card.classList.add('selected');
    } else {
      window.selectedItems[setKey].delete(itemId);
      cb.classList.remove('selected');
      if (card) card.classList.remove('selected');
    }
  });
  
  updateBulkToolbar();
}

function updateBulkToolbar() {
  const toolbar = document.getElementById('bulkActionsToolbar');
  const countEl = document.getElementById('selectedItemCount');
  const totalSelected = window.selectedItems.folders.size + window.selectedItems.flashcards.size;
  
  if (countEl) countEl.textContent = totalSelected;
  
  if (toolbar) {
    if (totalSelected > 0) {
      toolbar.classList.add('visible');
    } else {
      toolbar.classList.remove('visible');
    }
  }
}

function clearBulkSelection() {
  window.selectedItems = { folders: new Set(), flashcards: new Set() };
  
  document.querySelectorAll('.bulk-select-checkbox.selected').forEach(cb => {
    cb.classList.remove('selected');
  });
  document.querySelectorAll('.fc-folder-card.selected, .fc-set-card-teacher.selected').forEach(card => {
    card.classList.remove('selected');
  });
  
  const selectAllCb = document.getElementById('selectAllCheckbox');
  if (selectAllCb) selectAllCb.checked = false;
  
  updateBulkToolbar();
}

async function bulkDeleteSelected() {
  const totalSelected = window.selectedItems.folders.size + window.selectedItems.flashcards.size;
  
  if (totalSelected === 0) {
    alert('No items selected');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete ${totalSelected} item(s)?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  try {
    const batch = db.batch();
    
    // Delete selected folders
    for (const folderId of window.selectedItems.folders) {
      batch.delete(db.collection('adminFlashcardFolders').doc(folderId));
    }
    
    // Delete selected flashcards
    for (const flashcardId of window.selectedItems.flashcards) {
      batch.delete(db.collection('flashcards').doc(flashcardId));
    }
    
    await batch.commit();
    
    showToast(` Deleted ${totalSelected} item(s)`);
    clearBulkSelection();
    loadFlashcardSets(window.currentViewingFolderId);
    loadAdminFolderDashboard();
  } catch (error) {
    alert('Error deleting items: ' + error.message);
  }
}

// ==========================================
// MOVE TO FOLDER MODAL
// ==========================================

function openMoveToFolderModal() {
  const totalSelected = window.selectedItems.folders.size + window.selectedItems.flashcards.size;
  
  if (totalSelected === 0) {
    alert('No items selected');
    return;
  }
  
  // Only allow moving flashcards (not folders for now to keep it simple)
  if (window.selectedItems.flashcards.size === 0) {
    alert('Please select flashcard sets to move. Folder moving is done via edit.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'move-to-folder-modal';
  modal.id = 'moveToFolderModal';
  modal.onclick = (e) => { if (e.target === modal) closeMoveToFolderModal(); };
  
  const folders = Object.values(window.adminFoldersCache || {});
  const rootFolders = folders.filter(f => !f.parentFolderId);
  
  let foldersHtml = `
    <div class="folder-option root-option" data-folder-id="" onclick="selectMoveFolder(this, '')">
      <span></span>
      <span>Remove from folders (Unfiled)</span>
    </div>
  `;
  
  rootFolders.forEach(folder => {
    const childFolders = folders.filter(f => f.parentFolderId === folder.id);
    foldersHtml += `
      <div class="folder-option" data-folder-id="${folder.id}" onclick="selectMoveFolder(this, '${folder.id}')">
        <span>${folder.icon || ''}</span>
        <span>${folder.name}</span>
      </div>
    `;
    // Add child folders indented
    childFolders.forEach(child => {
      foldersHtml += `
        <div class="folder-option" data-folder-id="${child.id}" onclick="selectMoveFolder(this, '${child.id}')" style="padding-left: 35px;">
          <span style="color: #a0aec0;"></span>
          <span>${child.icon || ''}</span>
          <span>${child.name}</span>
        </div>
      `;
    });
  });
  
  modal.innerHTML = `
    <div class="move-to-folder-content">
      <h3> Move ${window.selectedItems.flashcards.size} Flashcard Set(s) to...</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        ${foldersHtml}
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="closeMoveToFolderModal()" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer;">Cancel</button>
        <button onclick="executeMoveToFolder()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; font-weight: 600; cursor: pointer;">Move</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  window.selectedMoveTargetFolderId = null;
}

function closeMoveToFolderModal() {
  const modal = document.getElementById('moveToFolderModal');
  if (modal) modal.remove();
  window.selectedMoveTargetFolderId = null;
}

function selectMoveFolder(element, folderId) {
  document.querySelectorAll('#moveToFolderModal .folder-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  element.classList.add('selected');
  window.selectedMoveTargetFolderId = folderId;
}

async function executeMoveToFolder() {
  if (window.selectedMoveTargetFolderId === null && window.selectedMoveTargetFolderId !== '') {
    alert('Please select a destination folder');
    return;
  }
  
  const targetFolderId = window.selectedMoveTargetFolderId;
  const flashcardIds = Array.from(window.selectedItems.flashcards);
  
  try {
    // Remove flashcards from all current folders first
    const allFolders = Object.values(window.adminFoldersCache || {});
    const batch = db.batch();
    
    for (const folder of allFolders) {
      const currentIds = folder.flashcardIds || [];
      const newIds = currentIds.filter(id => !flashcardIds.includes(id));
      if (newIds.length !== currentIds.length) {
        batch.update(db.collection('adminFlashcardFolders').doc(folder.id), {
          flashcardIds: newIds
        });
      }
    }
    
    // Add to target folder if not "unfiled"
    if (targetFolderId) {
      const targetFolder = window.adminFoldersCache[targetFolderId];
      const existingIds = targetFolder?.flashcardIds || [];
      const newIds = [...new Set([...existingIds, ...flashcardIds])];
      batch.update(db.collection('adminFlashcardFolders').doc(targetFolderId), {
        flashcardIds: newIds
      });
    }
    
    await batch.commit();
    
    showToast(` Moved ${flashcardIds.length} flashcard set(s)`);
    closeMoveToFolderModal();
    clearBulkSelection();
    loadFlashcardSets(window.currentViewingFolderId);
    loadAdminFolderDashboard();
  } catch (error) {
    alert('Error moving items: ' + error.message);
  }
}

// ==========================================
// DRAG AND DROP FUNCTIONS
// ==========================================

window.draggedItemId = null;
window.draggedItemType = null;

function handleFlashcardDragStart(event, flashcardId) {
  window.draggedItemId = flashcardId;
  window.draggedItemType = 'flashcard';
  event.target.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', flashcardId);
}

function handleDragEnd(event) {
  event.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  window.draggedItemId = null;
  window.draggedItemType = null;
}

async function handleDropOnFolder(event, targetFolderId) {
  event.preventDefault();
  event.stopPropagation();
  
  const dropTarget = event.currentTarget;
  dropTarget.classList.remove('drag-over');
  
  if (!window.draggedItemId || window.draggedItemType !== 'flashcard') {
    return;
  }
  
  const flashcardId = window.draggedItemId;
  
  try {
    // Remove from current folder if in one
    const allFolders = Object.values(window.adminFoldersCache || {});
    const batch = db.batch();
    
    for (const folder of allFolders) {
      const currentIds = folder.flashcardIds || [];
      if (currentIds.includes(flashcardId)) {
        const newIds = currentIds.filter(id => id !== flashcardId);
        batch.update(db.collection('adminFlashcardFolders').doc(folder.id), {
          flashcardIds: newIds
        });
      }
    }
    
    // Add to target folder
    const targetFolder = window.adminFoldersCache[targetFolderId];
    const existingIds = targetFolder?.flashcardIds || [];
    if (!existingIds.includes(flashcardId)) {
      batch.update(db.collection('adminFlashcardFolders').doc(targetFolderId), {
        flashcardIds: [...existingIds, flashcardId]
      });
    }
    
    await batch.commit();
    
    showToast(' Moved flashcard set to folder');
    loadFlashcardSets(window.currentViewingFolderId);
    loadAdminFolderDashboard();
  } catch (error) {
    alert('Error moving flashcard: ' + error.message);
  }
}

function handleFlashcardClick(event, setId) {
  // Don't trigger if clicking on checkbox or actions
  if (event.target.classList.contains('bulk-select-checkbox') || 
      event.target.closest('.set-actions') ||
      event.target.closest('.bulk-select-checkbox')) {
    return;
  }
  editFlashcard(setId);
}

// ==========================================
// DUPLICATE FOLDER FUNCTION
// ==========================================

async function duplicateAdminFolder(folderId) {
  const folder = window.adminFoldersCache?.[folderId];
  if (!folder) {
    alert('Folder not found');
    return;
  }
  
  const newName = prompt('Enter a name for the duplicated folder:', `${folder.name} (Copy)`);
  if (!newName) return;
  
  const includeSubfolders = folder.parentFolderId ? false : confirm('This folder may have subfolders. Include subfolders in the copy?');
  
  try {
    // Create the duplicated folder
    const newFolderData = {
      name: newName,
      icon: folder.icon || '',
      flashcardIds: [...(folder.flashcardIds || [])],
      studentIds: [...(folder.studentIds || [])],
      autoAssignFuture: folder.autoAssignFuture !== false,
      parentFolderId: folder.parentFolderId || null,
      createdBy: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Remove null parentFolderId
    if (!newFolderData.parentFolderId) {
      delete newFolderData.parentFolderId;
    }
    
    const newFolderRef = await db.collection('adminFlashcardFolders').add(newFolderData);
    
    // If including subfolders, duplicate them too
    if (includeSubfolders) {
      const allFolders = Object.values(window.adminFoldersCache || {});
      const childFolders = allFolders.filter(f => f.parentFolderId === folderId);
      
      for (const child of childFolders) {
        const childCopy = {
          name: child.name,
          icon: child.icon || '',
          flashcardIds: [...(child.flashcardIds || [])],
          studentIds: [...(child.studentIds || [])],
          autoAssignFuture: child.autoAssignFuture !== false,
          parentFolderId: newFolderRef.id, // Point to the new parent
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('adminFlashcardFolders').add(childCopy);
      }
    }
    
    showToast(` Folder duplicated${includeSubfolders ? ' with subfolders' : ''}`);
    loadFlashcardSets(window.currentViewingFolderId);
    loadAdminFolderDashboard();
  } catch (error) {
    alert('Error duplicating folder: ' + error.message);
  }
}

async function deleteFlashcardSet(setId) {
  if (!confirm('Are you sure you want to delete this flashcard set?')) return;

  try {
    await db.collection('flashcards').doc(setId).delete();
    alert('Flashcard set deleted successfully');
    loadFlashcardSets();
  } catch (error) {
    alert('Error deleting flashcard set: ' + error.message);
  }
}

/**
 * Duplicate an existing flashcard set
 */
async function duplicateFlashcardSet(setId) {
  try {
    const doc = await db.collection('flashcards').doc(setId).get();
    if (!doc.exists) {
      alert('Flashcard set not found');
      return;
    }

    const originalSet = doc.data();

    const newTitle = prompt('Enter a name for the duplicated deck:', `${originalSet.title} (Copy)`);
    if (!newTitle) return; // User cancelled

    const copiedWordPairs = originalSet.wordPairs.map(pair => ({
      english: pair.english || '',
      korean: pair.korean || '',
      audioUrl: pair.audioUrl || '',
      imageUrl: pair.imageUrl || ''
    }));

    const copiedAssets = {};
    if (originalSet.assets) {
      ['progressImage', 'perfectImage', 'perfectSound', 'almostImage', 'almostSound',
       'startImage', 'startSound', 'timeoutImage', 'timeoutSound'].forEach(key => {
        if (originalSet.assets[key]) {
          copiedAssets[key] = originalSet.assets[key];
        }
      });

      ['progressSounds', 'endGifs', 'endSounds'].forEach(key => {
        if (originalSet.assets[key] && Array.isArray(originalSet.assets[key])) {
          copiedAssets[key] = [...originalSet.assets[key]];
        }
      });
    }

    const duplicateData = {
      title: newTitle,
      wordPairs: copiedWordPairs,
      timerSeconds: originalSet.timerSeconds,
      teacherId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      folderId: originalSet.folderId || null,
      assets: copiedAssets
    };

    await db.collection('flashcards').add(duplicateData);

    alert(`Successfully duplicated "${originalSet.title}" as "${newTitle}"!`);
    loadFlashcardSets();

  } catch (error) {
    alert('Error duplicating flashcard set: ' + error.message);
  }
}

let editingFlashcardId = null;
let editingWordPairs = [];
let editingTitle = '';
let editingTimer = 7;
let editingAssets = {};

async function editFlashcard(setId) {
  editingFlashcardId = setId;

  try {
    const doc = await db.collection('flashcards').doc(setId).get();
    if (!doc.exists) {
      alert('Flashcard set not found');
      return;
    }

    const flashcardSet = doc.data();
    editingWordPairs = flashcardSet.wordPairs.map(p => ({
      english: p.english || '',
      korean: p.korean || '',
      audioUrl: p.audioUrl || '',
      imageUrl: p.imageUrl || '',
      aiData: p.aiData || null  // Preserve AI data when editing
    }));
    editingTitle = flashcardSet.title;
    editingTimer = flashcardSet.timerSeconds || 7;
    editingAssets = flashcardSet.assets || {};

    const modalHtml = `
      <div id="editFlashcardModal" style="position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto;">
        <div style="background: white; margin: 30px auto; padding: 30px; border-radius: 20px; width: 95%; max-width: 1000px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
            <h2 style="color: #667eea; font-size: 24px;"> Edit Flashcard Set</h2>
            <span onclick="closeEditModal()" style="cursor: pointer; font-size: 28px; color: #aaa;">&times;</span>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group" style="margin: 0;">
              <label>Set Title</label>
              <input type="text" id="editTitle" value="${flashcardSet.title}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
            <div class="form-group" style="margin: 0;">
              <label>Timer (seconds)</label>
              <input type="number" id="editTimer" value="${flashcardSet.timerSeconds || 7}" min="3" max="30" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
          </div>

          <!-- Edit Mode Tabs -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="editModeIndividual" onclick="switchEditMode('individual')" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Word Pairs</button>
            <button id="editModeBatch" onclick="switchEditMode('batch')" style="flex: 1; padding: 12px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Batch Edit</button>
            <button id="editModeAssets" onclick="switchEditMode('assets')" style="flex: 1; padding: 12px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Game Assets</button>
          </div>

          <!-- Individual Edit Mode -->
          <div id="individualEditMode">
            <div class="form-group">
              <label>Word Pairs (${editingWordPairs.length} cards)</label>
              <div id="editWordPairs" style="max-height: 450px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                <!-- Will be populated by refreshEditModal -->
              </div>
              <button onclick="addEditPair()" style="width: 100%; margin-top: 10px; padding: 12px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Add Word Pair</button>
            </div>
          </div>

          <!-- Batch Edit Mode -->
          <div id="batchEditMode" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); padding: 20px; border-radius: 12px; border: 2px dashed #667eea;">
              <p style="color: #4a5568; margin-bottom: 15px; font-size: 14px;">
                 <strong>Batch Edit Mode:</strong> Edit all cards at once. Each line is one card. Changes will replace existing cards.
              </p>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 8px;">English Words (one per line)</label>
                  <textarea id="batchEditEnglish" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="apple
banana
orange
..."></textarea>
                </div>
                <div>
                  <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 8px;">Korean Words (one per line)</label>
                  <textarea id="batchEditKorean" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="


..."></textarea>
                </div>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="applyBatchEdit()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Apply Batch Changes</button>
                <button onclick="loadCurrentToBatch()" style="padding: 12px 20px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;"> Load Current Cards</button>
              </div>

              <div id="batchEditStatus" style="margin-top: 10px; font-size: 14px;"></div>
            </div>
          </div>

          <!-- Game Assets Edit Mode -->
          <div id="assetsEditMode" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0;">
              <p style="color: #4a5568; margin-bottom: 20px; font-size: 14px;">
                 <strong>Game Assets:</strong> Images and sounds used during the flashcard game. Upload new files to replace existing ones.
              </p>

              <div id="assetsPreviewContainer">
                <!-- Will be populated by refreshAssetsPreview -->
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <button onclick="closeEditModal()" style="padding: 12px 24px; background: #718096; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
            <button onclick="saveEdits()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"> Save Changes</button>
          </div>
        </div>
      </div>
    `;

    const div = document.createElement('div');
    div.innerHTML = modalHtml;
    document.body.appendChild(div.firstElementChild);

    refreshEditModal();
    refreshAssetsPreview();

  } catch (error) {
    alert('Error loading flashcard: ' + error.message);
  }
}

function switchEditMode(mode) {
  const individualBtn = document.getElementById('editModeIndividual');
  const batchBtn = document.getElementById('editModeBatch');
  const assetsBtn = document.getElementById('editModeAssets');
  const individualMode = document.getElementById('individualEditMode');
  const batchMode = document.getElementById('batchEditMode');
  const assetsMode = document.getElementById('assetsEditMode');

  [individualBtn, batchBtn, assetsBtn].forEach(btn => {
    if (btn) {
      btn.style.background = '#e2e8f0';
      btn.style.color = '#4a5568';
    }
  });

  if (individualMode) individualMode.style.display = 'none';
  if (batchMode) batchMode.style.display = 'none';
  if (assetsMode) assetsMode.style.display = 'none';

  if (mode === 'individual') {
    individualBtn.style.background = '#667eea';
    individualBtn.style.color = 'white';
    individualMode.style.display = 'block';
  } else if (mode === 'batch') {
    batchBtn.style.background = '#667eea';
    batchBtn.style.color = 'white';
    batchMode.style.display = 'block';
    loadCurrentToBatch();
  } else if (mode === 'assets') {
    assetsBtn.style.background = '#667eea';
    assetsBtn.style.color = 'white';
    assetsMode.style.display = 'block';
    refreshAssetsPreview();
  }
}

function refreshAssetsPreview() {
  const container = document.getElementById('assetsPreviewContainer');
  if (!container) return;

  const assets = editingAssets || {};

  container.innerHTML = `
    <!-- Progress Assets -->
    <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Progressive Correct Answer</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Progress Image:</label>
          ${assets.progressImage ? `
            <img src="${assets.progressImage}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <button onclick="removeEditAsset('progressImage')" style="display: block; margin-top: 5px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No image uploaded</span>'}
          <input type="file" id="editProgressImage" accept="image/*" onchange="handleEditAssetUpload(this, 'progressImage')" style="margin-top: 10px; font-size: 12px;">
        </div>
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Progress Sounds (1-4):</label>
          ${[0,1,2,3].map(i => `
            <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 12px; width: 20px;">${i+1}.</span>
              ${assets.progressSounds && assets.progressSounds[i] ? `
                <audio controls src="${assets.progressSounds[i]}" style="height: 30px; width: 150px;"></audio>
                <button onclick="removeEditAsset('progressSounds', ${i})" style="padding: 2px 8px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;"></button>
              ` : '<span style="color: #a0aec0; font-size: 12px;">No sound</span>'}
              <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'progressSounds', ${i})" style="font-size: 11px; width: 100px;">
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Perfect Score -->
    <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Perfect Score (100%)</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Perfect Image:</label>
          ${assets.perfectImage ? `
            <img src="${assets.perfectImage}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <button onclick="removeEditAsset('perfectImage')" style="display: block; margin-top: 5px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No image uploaded</span>'}
          <input type="file" id="editPerfectImage" accept="image/*" onchange="handleEditAssetUpload(this, 'perfectImage')" style="margin-top: 10px; font-size: 12px;">
        </div>
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Perfect Sound:</label>
          ${assets.perfectSound ? `
            <audio controls src="${assets.perfectSound}" style="height: 30px;"></audio>
            <button onclick="removeEditAsset('perfectSound')" style="margin-left: 10px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No sound uploaded</span>'}
          <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'perfectSound')" style="margin-top: 10px; font-size: 12px;">
        </div>
      </div>
    </div>

    <!-- Almost Perfect -->
    <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Almost Perfect</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Almost Image:</label>
          ${assets.almostImage ? `
            <img src="${assets.almostImage}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <button onclick="removeEditAsset('almostImage')" style="display: block; margin-top: 5px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No image uploaded</span>'}
          <input type="file" accept="image/*" onchange="handleEditAssetUpload(this, 'almostImage')" style="margin-top: 10px; font-size: 12px;">
        </div>
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Almost Sound:</label>
          ${assets.almostSound ? `
            <audio controls src="${assets.almostSound}" style="height: 30px;"></audio>
            <button onclick="removeEditAsset('almostSound')" style="margin-left: 10px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No sound uploaded</span>'}
          <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'almostSound')" style="margin-top: 10px; font-size: 12px;">
        </div>
      </div>
    </div>

    <!-- Start Game -->
    <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Game Start</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Start Image:</label>
          ${assets.startImage ? `
            <img src="${assets.startImage}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <button onclick="removeEditAsset('startImage')" style="display: block; margin-top: 5px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No image uploaded</span>'}
          <input type="file" accept="image/*" onchange="handleEditAssetUpload(this, 'startImage')" style="margin-top: 10px; font-size: 12px;">
        </div>
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Start Sound:</label>
          ${assets.startSound ? `
            <audio controls src="${assets.startSound}" style="height: 30px;"></audio>
            <button onclick="removeEditAsset('startSound')" style="margin-left: 10px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No sound uploaded</span>'}
          <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'startSound')" style="margin-top: 10px; font-size: 12px;">
        </div>
      </div>
    </div>

    <!-- Timeout -->
    <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> Time's Up</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Timeout Image:</label>
          ${assets.timeoutImage ? `
            <img src="${assets.timeoutImage}" style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid #e0e0e0;">
            <button onclick="removeEditAsset('timeoutImage')" style="display: block; margin-top: 5px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No image uploaded</span>'}
          <input type="file" accept="image/*" onchange="handleEditAssetUpload(this, 'timeoutImage')" style="margin-top: 10px; font-size: 12px;">
        </div>
        <div>
          <label style="font-size: 13px; color: #718096; display: block; margin-bottom: 8px;">Timeout Sound:</label>
          ${assets.timeoutSound ? `
            <audio controls src="${assets.timeoutSound}" style="height: 30px;"></audio>
            <button onclick="removeEditAsset('timeoutSound')" style="margin-left: 10px; padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
          ` : '<span style="color: #a0aec0; font-size: 13px;">No sound uploaded</span>'}
          <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'timeoutSound')" style="margin-top: 10px; font-size: 12px;">
        </div>
      </div>
    </div>

    <!-- End Game GIFs -->
    <div style="padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
      <h4 style="margin: 0 0 15px 0; color: #2d3748;"> End Game Results</h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        ${[
          {i: 0, range: '0-50%', color: '#fc8181'},
          {i: 1, range: '51-60%', color: '#f6ad55'},
          {i: 2, range: '61-70%', color: '#faf089'},
          {i: 3, range: '71-80%', color: '#9ae6b4'},
          {i: 4, range: '81-90%', color: '#63b3ed'},
          {i: 5, range: '91-99%', color: '#b794f4'}
        ].map(item => `
          <div style="padding: 10px; background: ${item.color}20; border-radius: 8px; border: 1px solid ${item.color};">
            <div style="font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">${item.range}</div>
            <div style="margin-bottom: 5px;">
              ${assets.endGifs && assets.endGifs[item.i] ? `
                <img src="${assets.endGifs[item.i]}" style="max-width: 80px; max-height: 60px; border-radius: 4px;">
                <button onclick="removeEditAsset('endGifs', ${item.i})" style="display: block; margin-top: 3px; padding: 2px 6px; background: #f56565; color: white; border: none; border-radius: 3px; font-size: 10px; cursor: pointer;">Remove</button>
              ` : '<span style="font-size: 11px; color: #a0aec0;">No GIF</span>'}
            </div>
            <input type="file" accept="image/gif" onchange="handleEditAssetUpload(this, 'endGifs', ${item.i})" style="font-size: 10px; width: 100%;">
            <div style="margin-top: 8px;">
              ${assets.endSounds && assets.endSounds[item.i] ? `
                <audio controls src="${assets.endSounds[item.i]}" style="height: 25px; width: 100%;"></audio>
                <button onclick="removeEditAsset('endSounds', ${item.i})" style="margin-top: 3px; padding: 2px 6px; background: #f56565; color: white; border: none; border-radius: 3px; font-size: 10px; cursor: pointer;">Remove Sound</button>
              ` : '<span style="font-size: 11px; color: #a0aec0;">No sound</span>'}
            </div>
            <input type="file" accept="audio/*" onchange="handleEditAssetUpload(this, 'endSounds', ${item.i})" style="font-size: 10px; width: 100%; margin-top: 5px;">
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function handleEditAssetUpload(input, assetType, index = null) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;

    if (index !== null) {
      if (!editingAssets[assetType]) {
        editingAssets[assetType] = [];
      }
      editingAssets[assetType][index] = base64;
    } else {
      editingAssets[assetType] = base64;
    }

    refreshAssetsPreview();
  };
  reader.readAsDataURL(file);
}

function removeEditAsset(assetType, index = null) {
  if (index !== null) {
    if (editingAssets[assetType]) {
      editingAssets[assetType][index] = null;
    }
  } else {
    editingAssets[assetType] = null;
  }
  refreshAssetsPreview();
}

function loadCurrentToBatch() {
  const englishArea = document.getElementById('batchEditEnglish');
  const koreanArea = document.getElementById('batchEditKorean');

  englishArea.value = editingWordPairs.map(p => p.english).join('\n');
  koreanArea.value = editingWordPairs.map(p => p.korean).join('\n');

  document.getElementById('batchEditStatus').innerHTML = `<span style="color: #48bb78;"> Loaded ${editingWordPairs.length} cards</span>`;
}

function applyBatchEdit() {
  const englishText = document.getElementById('batchEditEnglish').value.trim();
  const koreanText = document.getElementById('batchEditKorean').value.trim();
  const statusEl = document.getElementById('batchEditStatus');

  if (!englishText || !koreanText) {
    statusEl.innerHTML = '<span style="color: #f56565;"> Both columns must have content</span>';
    return;
  }

  const englishWords = englishText.split(/[\n\r]+/).map(w => w.trim()).filter(w => w);
  const koreanWords = koreanText.split(/[\n\r]+/).map(w => w.trim()).filter(w => w);

  if (englishWords.length !== koreanWords.length) {
    statusEl.innerHTML = `<span style="color: #f56565;"> Mismatch: ${englishWords.length} English vs ${koreanWords.length} Korean words</span>`;
    return;
  }

  if (englishWords.length < 5) {
    statusEl.innerHTML = '<span style="color: #f56565;"> Need at least 5 word pairs</span>';
    return;
  }

  editingWordPairs = englishWords.map((eng, i) => ({
    english: eng,
    korean: koreanWords[i],
    audioUrl: '',
    imageUrl: ''
  }));

  statusEl.innerHTML = `<span style="color: #48bb78;"> Applied ${englishWords.length} word pairs! Switch to Individual Edit to review.</span>`;

  refreshEditModal();
}

let currentFolderView = null;
let editingFolderId = null;
let selectedFolderColor = '#667eea';

const folderColors = {
  '#667eea': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  '#48bb78': 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)',
  '#ed8936': 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)',
  '#f56565': 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)',
  '#38b2ac': 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)',
  '#9f7aea': 'linear-gradient(135deg, #9f7aea 0%, #805ad5 100%)',
  '#ed64a6': 'linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%)',
  '#4299e1': 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)'
};

function openCreateFolderModal() {
  editingFolderId = null;
  document.getElementById('folderModalTitle').textContent = ' Create New Folder';
  document.getElementById('folderNameInput').value = '';
  document.getElementById('saveFolderBtn').textContent = 'Create Folder';

  selectedFolderColor = '#667eea';
  document.querySelectorAll('.fc-color-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.color === selectedFolderColor);
  });

  document.getElementById('folderModal').style.display = 'flex';
  document.getElementById('folderNameInput').focus();
}

function openEditFolderModal(folderId, folderName, folderColor) {
  editingFolderId = folderId;
  document.getElementById('folderModalTitle').textContent = ' Edit Folder';
  document.getElementById('folderNameInput').value = folderName;
  document.getElementById('saveFolderBtn').textContent = 'Save Changes';

  selectedFolderColor = folderColor || '#667eea';
  document.querySelectorAll('.fc-color-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.color === selectedFolderColor);
  });

  document.getElementById('folderModal').style.display = 'flex';
  document.getElementById('folderNameInput').focus();
}

function closeFolderModal() {
  document.getElementById('folderModal').style.display = 'none';
  editingFolderId = null;
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.fc-color-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.fc-color-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      selectedFolderColor = opt.dataset.color;
    });
  });
});

async function saveFolder() {
  const nameInput = document.getElementById('folderNameInput');
  const name = nameInput.value.trim();

  if (!name) {
    showToast(' Please enter a folder name');
    nameInput.focus();
    return;
  }

  try {
    const folderData = {
      name: name,
      color: selectedFolderColor,
      createdBy: 'student',
      studentId: currentUser.uid,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (editingFolderId) {
      await db.collection('users').doc(currentUser.uid)
        .collection('flashcardFolders').doc(editingFolderId).update(folderData);
      showToast(' Folder updated!');
    } else {
      folderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      folderData.flashcardIds = [];
      await db.collection('users').doc(currentUser.uid)
        .collection('flashcardFolders').add(folderData);
      showToast(' Folder created!');
    }

    closeFolderModal();
    loadAvailableFlashcards();
  } catch (error) {
    showToast(' Error saving folder');
  }
}

async function deleteFolder(folderId) {
  if (!confirm('Are you sure you want to delete this folder?\n\nThe flashcard sets inside will be moved to Unfiled.')) {
    return;
  }

  try {
    await db.collection('users').doc(currentUser.uid)
      .collection('flashcardFolders').doc(folderId).delete();
    showToast(' Folder deleted');
    loadAvailableFlashcards();
  } catch (error) {
    showToast(' Error deleting folder');
  }
}

async function openFolder(folderId, folderName, isAdminFolder) {
  currentFolderView = { id: folderId, name: folderName, isAdmin: isAdminFolder };

  document.getElementById('flashcardFoldersSection').style.display = 'none';
  document.getElementById('unfiledFlashcardsSection').style.display = 'none';
  document.getElementById('folderContentsView').style.display = 'block';

  document.getElementById('folderViewTitle').textContent = folderName;
  document.getElementById('folderViewIcon').textContent = isAdminFolder ? '' : '';

  const grid = document.getElementById('folderContentsGrid');
  grid.innerHTML = '<div class="loading"></div>';

  try {
    let folderDoc;
    let folderData = {};
    
    if (isAdminFolder) {
      folderDoc = await db.collection('adminFlashcardFolders').doc(folderId).get();
      if (folderDoc.exists) {
        folderData = folderDoc.data();
      }
    } else {
      folderDoc = await db.collection('users').doc(currentUser.uid)
        .collection('flashcardFolders').doc(folderId).get();
      if (!folderDoc.exists) {
        grid.innerHTML = '<p>Folder not found</p>';
        return;
      }
      folderData = folderDoc.data();
    }

    const flashcardIds = folderData.flashcardIds || [];

    grid.innerHTML = '';

    // For admin folders, show all subfolders
    if (isAdminFolder) {
      // Get ALL subfolders of this master folder
      const allSubfoldersSnap = await db.collection('adminFlashcardFolders')
        .where('parentFolderId', '==', folderId)
        .get();
      
      // Show all subfolders to students (no filtering)
      const subfolders = [];
      allSubfoldersSnap.forEach(doc => {
        subfolders.push({ id: doc.id, ...doc.data() });
      });
      
      if (subfolders.length > 0) {
        // Add subfolders label
        const subfoldersLabel = document.createElement('div');
        subfoldersLabel.style.cssText = 'grid-column: 1/-1; color: #4a5568; font-weight: 600; margin-bottom: 10px;';
        subfoldersLabel.textContent = ' Subfolders';
        grid.appendChild(subfoldersLabel);
        
        // Add subfolder cards
        subfolders.forEach(subfolder => {
          const subfolderCard = document.createElement('div');
          subfolderCard.className = 'fc-folder-card admin-folder';
          subfolderCard.style.cssText = 'cursor: pointer;';
          subfolderCard.onclick = () => openFolder(subfolder.id, subfolder.name, true);
          
          const subCount = (subfolder.flashcardIds || []).length;
          subfolderCard.innerHTML = `
            <div class="folder-badge"> Admin</div>
            <div class="folder-icon">${subfolder.icon || ''}</div>
            <div class="folder-name">${subfolder.name}</div>
            <div class="folder-count">${subCount} set${subCount !== 1 ? 's' : ''}</div>
          `;
          grid.appendChild(subfolderCard);
        });
      }
    }

    // Add flashcard sets - all students can see all flashcards in admin folders
    if (flashcardIds.length > 0) {
      // Add flashcards label if there were subfolders
      if (grid.children.length > 0) {
        const flashcardsLabel = document.createElement('div');
        flashcardsLabel.style.cssText = 'grid-column: 1/-1; color: #4a5568; font-weight: 600; margin: 20px 0 10px 0;';
        flashcardsLabel.textContent = ' Flashcard Sets';
        grid.appendChild(flashcardsLabel);
      }
      
      for (const setId of flashcardIds) {
        const setDoc = await db.collection('flashcards').doc(setId).get();
        if (setDoc.exists) {
          const set = { id: setDoc.id, ...setDoc.data() };
          if (set.title && Array.isArray(set.wordPairs) && set.wordPairs.length > 0) {
            grid.appendChild(createFlashcardCard(set, folderId, isAdminFolder));
          }
        }
      }
    }

    if (grid.children.length === 0) {
      grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <p>This folder is empty.</p>
        </div>
      `;
    }

  } catch (error) {
    grid.innerHTML = '<p>Error loading folder contents: ' + error.message + '</p>';
  }
}

function closeFolderView() {
  currentFolderView = null;
  document.getElementById('folderContentsView').style.display = 'none';
  document.getElementById('flashcardFoldersSection').style.display = 'block';
  document.getElementById('unfiledFlashcardsSection').style.display = 'block';
}

function createFlashcardCard(set, inFolderId = null, isAdminFolder = false) {
  const card = document.createElement('div');
  card.className = 'flashcard-game-card';
  card.dataset.title = set.title.toLowerCase();
  card.style.cssText = `
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 120px;
    position: relative;
  `;
  card.onmouseover = () => { card.style.transform = 'translateY(-3px)'; card.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)'; };
  card.onmouseout = () => { card.style.transform = 'translateY(0)'; card.style.boxShadow = 'none'; };

  // Only show move button if NOT in an admin folder (students can't move teacher's flashcards)
  const moveButton = isAdminFolder ? '' : `
      <button onclick="event.stopPropagation(); showFlashcardMoveMenu('${set.id}', this)" style="padding: 8px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 11px; cursor: pointer;" title="Move to folder">
        
      </button>`;

  card.innerHTML = `
    <div>
      <div class="flashcard-card-title" style="font-size: 13px; font-weight: 600; color: white; margin-bottom: 6px; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;"> ${set.title}</div>
      <div style="font-size: 10px; color: rgba(255,255,255,0.8);">${set.wordPairs.length} words</div>
    </div>
    <div style="display: flex; gap: 6px; margin-top: 10px;">
      <button onclick="event.stopPropagation(); startFlashcardGame('${set.id}')" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; font-size: 11px; font-weight: 600; cursor: pointer;">
        Play 
      </button>
      ${moveButton}
    </div>
  `;

  card.onclick = () => startFlashcardGame(set.id);
  return card;
}

async function showFlashcardMoveMenu(flashcardId, buttonEl) {
  document.querySelectorAll('.fc-move-menu').forEach(m => m.remove());

  const folders = [];

  try {
    const adminFoldersSnap = await db.collection('adminFlashcardFolders')
      .where('studentIds', 'array-contains', currentUser.uid)
      .get();
    adminFoldersSnap.forEach(doc => {
      folders.push({ id: doc.id, ...doc.data(), isAdmin: true });
    });
  } catch(e) {}

  try {
    const studentFoldersSnap = await db.collection('users').doc(currentUser.uid)
      .collection('flashcardFolders').get();
    studentFoldersSnap.forEach(doc => {
      folders.push({ id: doc.id, ...doc.data(), isAdmin: false });
    });
  } catch(e) {}

  const menu = document.createElement('div');
  menu.className = 'fc-move-menu';
  menu.style.cssText = `
    position: absolute;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    padding: 8px 0;
    min-width: 180px;
    z-index: 1000;
    max-height: 250px;
    overflow-y: auto;
  `;

  const rect = buttonEl.getBoundingClientRect();
  menu.style.top = (rect.bottom + 5) + 'px';
  menu.style.left = rect.left + 'px';

  if (currentFolderView) {
    menu.innerHTML += `
      <div onclick="moveFlashcardToFolder('${flashcardId}', null)" style="padding: 10px 15px; cursor: pointer; font-size: 13px; color: #e53e3e; display: flex; align-items: center; gap: 8px; transition: background 0.2s;" onmouseover="this.style.background='#fff5f5'" onmouseout="this.style.background='transparent'">
         Remove from folder
      </div>
      <div style="height: 1px; background: #e2e8f0; margin: 5px 0;"></div>
    `;
  }

  if (folders.length === 0) {
    menu.innerHTML += `<div style="padding: 15px; color: #718096; font-size: 13px; text-align: center;">No folders yet</div>`;
  } else {
    folders.forEach(folder => {
      const icon = folder.isAdmin ? '' : '';
      const bgColor = folder.isAdmin ? '#fffbeb' : '#f0f4ff';
      menu.innerHTML += `
        <div onclick="moveFlashcardToFolder('${flashcardId}', '${folder.id}', ${folder.isAdmin})"
             style="padding: 10px 15px; cursor: pointer; font-size: 13px; color: #2d3748; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
             onmouseover="this.style.background='${bgColor}'"
             onmouseout="this.style.background='transparent'">
          ${icon} ${folder.name}
        </div>
      `;
    });
  }

  document.body.appendChild(menu);

  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

async function moveFlashcardToFolder(flashcardId, targetFolderId, isAdminFolder = false) {
  document.querySelectorAll('.fc-move-menu').forEach(m => m.remove());

  try {
    if (currentFolderView) {
      const currentRef = currentFolderView.isAdmin
        ? db.collection('adminFlashcardFolders').doc(currentFolderView.id)
        : db.collection('users').doc(currentUser.uid).collection('flashcardFolders').doc(currentFolderView.id);

      await currentRef.update({
        flashcardIds: firebase.firestore.FieldValue.arrayRemove(flashcardId)
      });
    }

    if (targetFolderId) {
      const targetRef = isAdminFolder
        ? db.collection('adminFlashcardFolders').doc(targetFolderId)
        : db.collection('users').doc(currentUser.uid).collection('flashcardFolders').doc(targetFolderId);

      await targetRef.update({
        flashcardIds: firebase.firestore.FieldValue.arrayUnion(flashcardId)
      });
      showToast(' Moved to folder');
    } else {
      showToast(' Removed from folder');
    }

    if (currentFolderView) {
      openFolder(currentFolderView.id, currentFolderView.name, currentFolderView.isAdmin);
    } else {
      loadAvailableFlashcards();
    }

  } catch (error) {
    showToast(' Error moving flashcard');
  }
}


let editingAdminFolderId = null;
let adminFoldersCache = [];
let allStudentsCache = [];
let selectedFolderIcon = '';

function switchAfdTab(tabName) {
  document.querySelectorAll('.afd-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.afd-tab-content').forEach(c => c.style.display = 'none');

  if (event && event.target) event.target.classList.add('active');
  const tabEl = document.getElementById(`afd${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
  if (tabEl) tabEl.style.display = 'block';

  if (tabName === 'analytics') loadAfdAnalytics();
  if (tabName === 'students') loadStudentAccessList();
  if (tabName === 'folders') filterAdminFolders();
}

async function loadAdminFolderDashboard() {
  try {
    const foldersSnap = await db.collection('adminFlashcardFolders')
      .where('createdBy', '==', currentUser.uid)
      .get();

    adminFoldersCache = [];
    foldersSnap.forEach(doc => {
      adminFoldersCache.push({ id: doc.id, ...doc.data() });
    });

    const studentsSnap = await db.collection('users').where('role', '==', 'student').get();
    allStudentsCache = [];
    studentsSnap.forEach(doc => {
      allStudentsCache.push({ id: doc.id, ...doc.data() });
    });

    updateAfdStats();
    renderAfdFoldersTable();

  } catch (error) {
    const tbody = document.getElementById('afdFoldersTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #e53e3e;">Error loading folders</td></tr>';
  }
}

function updateAfdStats() {
  const totalFolders = adminFoldersCache.length;
  const activeFolders = adminFoldersCache.filter(f => !f.archived && !f.locked).length;
  const totalSets = adminFoldersCache.reduce((sum, f) => sum + (f.flashcardIds?.length || 0), 0);
  const uniqueStudents = new Set();
  adminFoldersCache.forEach(f => (f.studentIds || []).forEach(id => uniqueStudents.add(id)));
  const autoAssignCount = adminFoldersCache.filter(f => f.autoAssignFuture !== false).length;

  const el1 = document.getElementById('afdTotalFolders');
  const el2 = document.getElementById('afdActiveFolders');
  const el3 = document.getElementById('afdTotalSets');
  const el4 = document.getElementById('afdTotalStudents');
  const el5 = document.getElementById('afdAutoAssign');

  if (el1) el1.textContent = totalFolders;
  if (el2) el2.textContent = activeFolders;
  if (el3) el3.textContent = totalSets;
  if (el4) el4.textContent = uniqueStudents.size;
  if (el5) el5.textContent = autoAssignCount;
}

function renderAfdFoldersTable(folders = adminFoldersCache) {
  const tbody = document.getElementById('afdFoldersTableBody');
  if (!tbody) return;

  if (folders.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8">
          <div class="afd-empty">
            <div class="afd-empty-icon"></div>
            <div class="afd-empty-text">No folders created yet</div>
            <button class="afd-btn afd-btn-primary" onclick="openAdminFolderModal()"> Create Your First Folder</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  // Organize folders into hierarchy
  const rootFolders = folders.filter(f => !f.parentFolderId);
  const childFolders = folders.filter(f => f.parentFolderId);
  
  // Check which folders are master folders (have children)
  const masterFolderIds = new Set(childFolders.map(f => f.parentFolderId));

  // Build hierarchical list: root folders first, then their children
  const orderedFolders = [];
  rootFolders.forEach(rootFolder => {
    orderedFolders.push({ ...rootFolder, isMaster: masterFolderIds.has(rootFolder.id), depth: 0 });
    // Add children of this root folder
    const children = childFolders.filter(f => f.parentFolderId === rootFolder.id);
    children.forEach(child => {
      orderedFolders.push({ ...child, depth: 1, parentName: rootFolder.name });
    });
  });

  // Add orphan children (whose parent might have been deleted)
  const addedChildIds = new Set(orderedFolders.filter(f => f.depth === 1).map(f => f.id));
  childFolders.forEach(child => {
    if (!addedChildIds.has(child.id)) {
      orderedFolders.push({ ...child, depth: 1, parentName: '(Unknown)' });
    }
  });

  tbody.innerHTML = orderedFolders.map(folder => {
    const setsCount = folder.flashcardIds?.length || 0;
    const studentsCount = folder.studentIds?.length || 0;
    const icon = folder.icon || '';
    const createdDate = folder.createdAt?.toDate ? folder.createdAt.toDate().toLocaleDateString() : 'N/A';

    let statusBadge = '<span class="afd-badge afd-badge-success">Active</span>';
    if (folder.archived) statusBadge = '<span class="afd-badge afd-badge-archived">Archived</span>';
    else if (folder.locked) statusBadge = '<span class="afd-badge afd-badge-warning">Locked</span>';

    const autoAssignBadge = folder.autoAssignFuture !== false
      ? '<span class="afd-badge afd-badge-info"> On</span>'
      : '<span class="afd-badge afd-badge-archived">Off</span>';

    // Styling for master folders (yellow) and subfolders (indented)
    const isMaster = folder.isMaster;
    const isChild = folder.depth === 1;
    
    let rowStyle = '';
    let folderNameHtml = '';
    
    if (isMaster) {
      // Master folder - yellow background
      rowStyle = 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;';
      folderNameHtml = `
        <div class="afd-folder-name" style="font-weight: 700;">
          <span>${icon}</span>
          <span>${folder.name}</span>
          <span class="afd-badge" style="background: #f59e0b; color: white; margin-left: 8px; font-size: 9px;">MASTER</span>
        </div>
      `;
    } else if (isChild) {
      // Subfolder - indented with parent path
      rowStyle = 'background: #f8fafc;';
      folderNameHtml = `
        <div class="afd-folder-name" style="padding-left: 25px;">
          <span style="color: #a0aec0; margin-right: 5px;"></span>
          <span>${icon}</span>
          <span>${folder.name}</span>
          <span style="font-size: 10px; color: #718096; margin-left: 8px;">in  ${folder.parentName}</span>
        </div>
      `;
    } else {
      // Regular root folder (no children)
      folderNameHtml = `
        <div class="afd-folder-name">
          <span>${icon}</span>
          <span>${folder.name}</span>
        </div>
      `;
    }

    return `
      <tr data-folder-id="${folder.id}" style="${rowStyle}">
        <td style="cursor: grab; color: #a0aec0;"></td>
        <td>${folderNameHtml}</td>
        <td>${setsCount}</td>
        <td>${studentsCount}</td>
        <td>${statusBadge}</td>
        <td>${autoAssignBadge}</td>
        <td>${createdDate}</td>
        <td>
          <div class="afd-actions">
            <button class="afd-action-btn preview" onclick="previewFolder('${folder.id}')" title="Preview as student"></button>
            <button class="afd-action-btn edit" onclick="openEditAdminFolderModal('${folder.id}')" title="Edit"></button>
            <button class="afd-action-btn duplicate" onclick="duplicateFolder('${folder.id}')" title="Duplicate"></button>
            <button class="afd-action-btn sync" onclick="syncFolderToStudents('${folder.id}')" title="Sync to students"></button>
            <button class="afd-action-btn archive" onclick="toggleArchiveFolder('${folder.id}')" title="${folder.archived ? 'Unarchive' : 'Archive'}"></button>
            <button class="afd-action-btn delete" onclick="deleteAdminFolder('${folder.id}')" title="Delete"></button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function filterAdminFolders() {
  const searchEl = document.getElementById('afdSearchInput');
  const statusEl = document.getElementById('afdStatusFilter');
  const autoAssignEl = document.getElementById('afdAutoAssignFilter');

  const search = searchEl?.value?.toLowerCase() || '';
  const status = statusEl?.value || 'all';
  const autoAssign = autoAssignEl?.value || 'all';

  let filtered = adminFoldersCache.filter(f => {
    const matchesSearch = f.name.toLowerCase().includes(search);
    const matchesStatus = status === 'all' ||
      (status === 'active' && !f.archived && !f.locked) ||
      (status === 'archived' && f.archived) ||
      (status === 'locked' && f.locked);
    const matchesAutoAssign = autoAssign === 'all' ||
      (autoAssign === 'enabled' && f.autoAssignFuture !== false) ||
      (autoAssign === 'disabled' && f.autoAssignFuture === false);

    return matchesSearch && matchesStatus && matchesAutoAssign;
  });

  const container = document.getElementById('afdFilteredFoldersList');
  if (!container) return;

  if (filtered.length === 0) {
    container.innerHTML = '<div class="afd-empty"><div class="afd-empty-icon"></div><div class="afd-empty-text">No folders match your filters</div></div>';
  } else {
    // Check which folders are master folders
    const childFolderParentIds = new Set(adminFoldersCache.filter(f => f.parentFolderId).map(f => f.parentFolderId));
    
    container.innerHTML = '<div class="afd-table-container"><table class="afd-table"><thead><tr><th>Folder</th><th>Sets</th><th>Students</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
      filtered.map(f => {
        const isMaster = childFolderParentIds.has(f.id);
        const isChild = !!f.parentFolderId;
        const parentFolder = isChild ? adminFoldersCache.find(p => p.id === f.parentFolderId) : null;
        
        let rowStyle = '';
        let folderNameHtml = '';
        
        if (isMaster) {
          rowStyle = 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;';
          folderNameHtml = `<div class="afd-folder-name" style="font-weight: 700;"><span>${f.icon || ''}</span> ${f.name} <span class="afd-badge" style="background: #f59e0b; color: white; margin-left: 8px; font-size: 9px;">MASTER</span></div>`;
        } else if (isChild) {
          rowStyle = 'background: #f8fafc;';
          folderNameHtml = `<div class="afd-folder-name" style="padding-left: 20px;"><span style="color: #a0aec0;"></span> <span>${f.icon || ''}</span> ${f.name} <span style="font-size: 10px; color: #718096; margin-left: 5px;">in  ${parentFolder?.name || 'Unknown'}</span></div>`;
        } else {
          folderNameHtml = `<div class="afd-folder-name"><span>${f.icon || ''}</span> ${f.name}</div>`;
        }
        
        return `
        <tr style="${rowStyle}">
          <td>${folderNameHtml}</td>
          <td>${f.flashcardIds?.length || 0}</td>
          <td>${f.studentIds?.length || 0}</td>
          <td>${f.archived ? '<span class="afd-badge afd-badge-archived">Archived</span>' : '<span class="afd-badge afd-badge-success">Active</span>'}</td>
          <td><div class="afd-actions">
            <button class="afd-action-btn edit" onclick="openEditAdminFolderModal('${f.id}')"></button>
            <button class="afd-action-btn delete" onclick="deleteAdminFolder('${f.id}')"></button>
          </div></td>
        </tr>
      `}).join('') + '</tbody></table></div>';
  }
}

function previewFolder(folderId) {
  const folder = adminFoldersCache.find(f => f.id === folderId);
  if (!folder) return;

  const modal = document.getElementById('afdPreviewModal');
  const body = document.getElementById('afdPreviewBody');
  if (!modal || !body) return;

  body.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 80px; height: 80px; margin: 0 auto 15px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 36px; border: 3px solid #d97706;">
        ${folder.icon || ''}
      </div>
      <h3 style="color: #92400e; margin: 0;">${folder.name}</h3>
      <span class="afd-badge afd-badge-warning" style="margin-top: 10px;"> Admin Folder</span>
    </div>
    <div style="background: #f9fafb; border-radius: 12px; padding: 15px;">
      <h4 style="margin: 0 0 15px; color: #4a5568; font-size: 14px;"> ${folder.flashcardIds?.length || 0} Flashcard Sets</h4>
      <div id="previewSetsList">Loading...</div>
    </div>
    ${folder.locked ? '<div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 10px; text-align: center;"><span style="font-size: 24px;"></span><p style="margin: 10px 0 0; color: #92400e;">This folder is locked</p></div>' : ''}
  `;

  modal.style.display = 'flex';
  loadPreviewSets(folder.flashcardIds || []);
}

async function loadPreviewSets(setIds) {
  const container = document.getElementById('previewSetsList');
  if (!container) return;

  if (setIds.length === 0) {
    container.innerHTML = '<p style="color: #718096; text-align: center;">No sets in this folder</p>';
    return;
  }

  try {
    const setNames = [];
    for (const id of setIds.slice(0, 10)) {
      const doc = await db.collection('flashcards').doc(id).get();
      if (doc.exists) setNames.push(doc.data().title);
    }

    container.innerHTML = setNames.map(name => `
      <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
         ${name}
      </div>
    `).join('') + (setIds.length > 10 ? `<p style="color: #718096; text-align: center; font-size: 12px;">+${setIds.length - 10} more sets</p>` : '');
  } catch (e) {
    container.innerHTML = '<p style="color: #e53e3e;">Error loading sets</p>';
  }
}

function closePreviewModal() {
  const modal = document.getElementById('afdPreviewModal');
  if (modal) modal.style.display = 'none';
}

async function duplicateFolder(folderId) {
  const folder = adminFoldersCache.find(f => f.id === folderId);
  if (!folder) return;

  const newName = prompt('Enter name for duplicated folder:', folder.name + ' (Copy)');
  if (!newName) return;

  try {
    const newFolder = { ...folder };
    delete newFolder.id;
    newFolder.name = newName;
    newFolder.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    newFolder.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

    await db.collection('adminFlashcardFolders').add(newFolder);
    showToast(' Folder duplicated!');
    loadAdminFolderDashboard();
  } catch (error) {
    showToast(' Error duplicating folder');
  }
}

async function toggleArchiveFolder(folderId) {
  const folder = adminFoldersCache.find(f => f.id === folderId);
  if (!folder) return;

  try {
    await db.collection('adminFlashcardFolders').doc(folderId).update({
      archived: !folder.archived,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast(folder.archived ? ' Folder unarchived!' : ' Folder archived!');
    loadAdminFolderDashboard();
  } catch (error) {
    showToast(' Error updating folder');
  }
}

async function syncFolderToStudents(folderId) {
  const folder = adminFoldersCache.find(f => f.id === folderId);
  if (!folder) return;

  if (!confirm(`Sync "${folder.name}" to all students?`)) return;

  try {
    if (folder.autoAssignFuture !== false) {
      const allStudentIds = allStudentsCache.map(s => s.id);
      await db.collection('adminFlashcardFolders').doc(folderId).update({
        studentIds: allStudentIds,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast(` Synced to ${allStudentIds.length} students!`);
      loadAdminFolderDashboard();
    } else {
      showToast(' Auto-assign is disabled for this folder');
    }
  } catch (error) {
    showToast(' Error syncing folder');
  }
}

async function syncAllStudentFolders() {
  if (!confirm('Sync ALL auto-assign folders to ALL students?')) return;

  try {
    const allStudentIds = allStudentsCache.map(s => s.id);
    const batch = db.batch();
    let count = 0;

    adminFoldersCache.forEach(folder => {
      if (folder.autoAssignFuture !== false) {
        const ref = db.collection('adminFlashcardFolders').doc(folder.id);
        batch.update(ref, { studentIds: allStudentIds });
        count++;
      }
    });

    await batch.commit();
    showToast(` Synced ${count} folders to ${allStudentIds.length} students!`);
    loadAdminFolderDashboard();
  } catch (error) {
    showToast(' Error syncing folders');
  }
}

function loadStudentAccessList() {
  const container = document.getElementById('afdStudentAccessList');
  if (!container) return;

  const searchEl = document.getElementById('afdStudentSearchInput');
  const search = searchEl?.value?.toLowerCase() || '';

  const filtered = allStudentsCache.filter(s => {
    const name = s.displayName || s.email?.split('@')[0] || '';
    return name.toLowerCase().includes(search) || (s.email || '').toLowerCase().includes(search);
  });

  if (filtered.length === 0) {
    container.innerHTML = '<div class="afd-empty"><div class="afd-empty-icon"></div><div class="afd-empty-text">No students found</div></div>';
    return;
  }

  container.innerHTML = `
    <div class="afd-table-container">
      <table class="afd-table">
        <thead>
          <tr>
            <th>Student</th>
            <th>Folders Assigned</th>
            <th>Sets Available</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map(student => {
            const name = student.displayName || student.email?.split('@')[0] || 'Student';
            const foldersAssigned = adminFoldersCache.filter(f => f.studentIds?.includes(student.id)).length;
            const setsAvailable = adminFoldersCache
              .filter(f => f.studentIds?.includes(student.id))
              .reduce((sum, f) => sum + (f.flashcardIds?.length || 0), 0);

            return `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="afd-student-avatar">${name.charAt(0).toUpperCase()}</div>
                    <div>
                      <div style="font-weight: 600;">${name}</div>
                      <div style="font-size: 11px; color: #718096;">${student.email || ''}</div>
                    </div>
                  </div>
                </td>
                <td>${foldersAssigned} / ${adminFoldersCache.length}</td>
                <td>${setsAvailable}</td>
                <td>
                  <button class="afd-btn afd-btn-secondary" onclick="showStudentFolderDetail('${student.id}')" style="padding: 6px 12px; font-size: 11px;">
                    View Details
                  </button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function filterStudentAccess() {
  loadStudentAccessList();
}

function showStudentFolderDetail(studentId) {
  const student = allStudentsCache.find(s => s.id === studentId);
  if (!student) return;

  const name = student.displayName || student.email?.split('@')[0] || 'Student';
  const assignedFolders = adminFoldersCache.filter(f => f.studentIds?.includes(studentId));
  const missingFolders = adminFoldersCache.filter(f => !f.studentIds?.includes(studentId) && f.autoAssignFuture !== false);

  const body = document.getElementById('afdPreviewBody');
  if (!body) return;

  body.innerHTML = `
    <h4 style="margin: 0 0 15px; color: #2d3748;">Folders for ${name}</h4>
    <div style="margin-bottom: 20px;">
      <h5 style="color: #065f46; margin-bottom: 10px;"> Assigned Folders (${assignedFolders.length})</h5>
      ${assignedFolders.length === 0 ? '<p style="color: #718096;">No folders assigned</p>' :
        assignedFolders.map(f => `
          <div style="padding: 10px; background: #f0fdf4; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <span>${f.icon || ''} ${f.name}</span>
            <button onclick="removeStudentFromFolder('${studentId}', '${f.id}')" style="background: #fee2e2; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove</button>
          </div>
        `).join('')
      }
    </div>
    ${missingFolders.length > 0 ? `
      <div>
        <h5 style="color: #dc2626; margin-bottom: 10px;"> Missing Folders (${missingFolders.length})</h5>
        ${missingFolders.map(f => `
          <div style="padding: 10px; background: #fef2f2; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <span>${f.icon || ''} ${f.name}</span>
            <button onclick="addStudentToFolder('${studentId}', '${f.id}')" style="background: #d1fae5; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Add</button>
          </div>
        `).join('')}
      </div>
    ` : ''}
  `;

  document.getElementById('afdPreviewModal').style.display = 'flex';
}

async function removeStudentFromFolder(studentId, folderId) {
  try {
    await db.collection('adminFlashcardFolders').doc(folderId).update({
      studentIds: firebase.firestore.FieldValue.arrayRemove(studentId)
    });
    showToast(' Student removed from folder');
    loadAdminFolderDashboard();
    showStudentFolderDetail(studentId);
  } catch (e) {
    showToast(' Error removing student');
  }
}

async function addStudentToFolder(studentId, folderId) {
  try {
    await db.collection('adminFlashcardFolders').doc(folderId).update({
      studentIds: firebase.firestore.FieldValue.arrayUnion(studentId)
    });
    showToast(' Student added to folder');
    loadAdminFolderDashboard();
    showStudentFolderDetail(studentId);
  } catch (e) {
    showToast(' Error adding student');
  }
}

function loadAfdAnalytics() {
  const mostPlayedCtx = document.getElementById('mostPlayedCanvas')?.getContext('2d');
  const engagementCtx = document.getElementById('engagementCanvas')?.getContext('2d');

  if (mostPlayedCtx && typeof Chart !== 'undefined') {
    new Chart(mostPlayedCtx, {
      type: 'bar',
      data: {
        labels: adminFoldersCache.slice(0, 5).map(f => f.name.substring(0, 15)),
        datasets: [{
          label: 'Flashcard Sets',
          data: adminFoldersCache.slice(0, 5).map(f => f.flashcardIds?.length || 0),
          backgroundColor: '#f59e0b'
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  if (engagementCtx && typeof Chart !== 'undefined') {
    new Chart(engagementCtx, {
      type: 'doughnut',
      data: {
        labels: ['Active', 'Archived', 'Locked'],
        datasets: [{
          data: [
            adminFoldersCache.filter(f => !f.archived && !f.locked).length,
            adminFoldersCache.filter(f => f.archived).length,
            adminFoldersCache.filter(f => f.locked).length
          ],
          backgroundColor: ['#48bb78', '#a0aec0', '#f59e0b']
        }]
      },
      options: { responsive: true }
    });
  }
}

function exportAdminFolders() {
  const exportData = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    folders: adminFoldersCache.map(f => ({
      name: f.name,
      icon: f.icon,
      flashcardIds: f.flashcardIds,
      autoAssignFuture: f.autoAssignFuture,
      locked: f.locked,
      archived: f.archived
    }))
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `admin-folders-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(' Folders exported!');
}

function showImportModal() {
  const modal = document.getElementById('afdImportModal');
  if (modal) {
    modal.style.display = 'flex';
    document.getElementById('importJsonData').value = '';
  }
}

function closeImportModal() {
  const modal = document.getElementById('afdImportModal');
  if (modal) modal.style.display = 'none';
}

async function importAdminFolders() {
  const jsonText = document.getElementById('importJsonData')?.value?.trim();
  if (!jsonText) return;

  try {
    const data = JSON.parse(jsonText);

    if (!data.folders || !Array.isArray(data.folders)) {
      throw new Error('Invalid format');
    }

    let imported = 0;
    for (const folder of data.folders) {
      if (!folder.name) continue;

      await db.collection('adminFlashcardFolders').add({
        name: folder.name,
        icon: folder.icon || '',
        flashcardIds: folder.flashcardIds || [],
        studentIds: [],
        autoAssignFuture: folder.autoAssignFuture !== false,
        locked: folder.locked || false,
        archived: folder.archived || false,
        createdBy: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      imported++;
    }

    closeImportModal();
    showToast(` Imported ${imported} folder(s)!`);
    loadAdminFolderDashboard();

  } catch (error) {
    showToast(' Invalid JSON format');
  }
}

document.addEventListener('click', (e) => {
  if (e.target.classList.contains('folder-icon-option')) {
    document.querySelectorAll('.folder-icon-option').forEach(btn => {
      btn.style.borderColor = '#e2e8f0';
      btn.style.background = 'white';
    });
    e.target.style.borderColor = '#f59e0b';
    e.target.style.background = '#fef3c7';
    selectedFolderIcon = e.target.dataset.icon;
  }
});

document.addEventListener('change', (e) => {
  if (e.target.id === 'enableAccessControl') {
    const options = document.getElementById('accessControlOptions');
    if (options) options.style.display = e.target.checked ? 'block' : 'none';
  }
});

async function openAdminFolderModal() {
  editingAdminFolderId = null;
  document.getElementById('adminFolderModalTitle').textContent = ' Create Admin Folder for Students';
  document.getElementById('adminFolderNameInput').value = '';
  document.getElementById('saveAdminFolderBtn').textContent = 'Create & Push to Students';

  selectedFolderIcon = '';
  document.querySelectorAll('.folder-icon-option').forEach(btn => {
    btn.style.borderColor = btn.dataset.icon === selectedFolderIcon ? '#f59e0b' : '#e2e8f0';
    btn.style.background = btn.dataset.icon === selectedFolderIcon ? '#fef3c7' : 'white';
  });

  // Reset and populate parent folder dropdown
  const parentSelect = document.getElementById('adminFolderParentSelect');
  if (parentSelect) {
    parentSelect.innerHTML = '<option value=""> Root Level (No Parent)</option>';
    // Add existing folders as potential parents (only root-level folders can be parents)
    if (adminFoldersCache && adminFoldersCache.length > 0) {
      const rootFolders = adminFoldersCache.filter(f => !f.parentFolderId);
      rootFolders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = ` ${folder.name}`;
        parentSelect.appendChild(option);
      });
    }
    parentSelect.value = '';
  }

  const autoAssignEl = document.getElementById('autoAssignFutureStudents');
  if (autoAssignEl) autoAssignEl.checked = true;

  const accessControlEl = document.getElementById('enableAccessControl');
  if (accessControlEl) accessControlEl.checked = false;

  const accessOptionsEl = document.getElementById('accessControlOptions');
  if (accessOptionsEl) accessOptionsEl.style.display = 'none';

  const notifyEl = document.getElementById('notifyStudents');
  if (notifyEl) notifyEl.checked = true;

  const lockedEl = document.getElementById('folderLocked');
  if (lockedEl) lockedEl.checked = false;

  const requiredEl = document.getElementById('folderRequired');
  if (requiredEl) requiredEl.checked = false;

  const startEl = document.getElementById('folderStartDate');
  if (startEl) startEl.value = '';

  const endEl = document.getElementById('folderEndDate');
  if (endEl) endEl.value = '';

  await loadStudentCheckboxes();
  await loadFlashcardCheckboxes();

  document.getElementById('adminFolderModal').style.display = 'flex';
  document.getElementById('adminFolderNameInput').focus();
}

async function openEditAdminFolderModal(folderId) {
  editingAdminFolderId = folderId;

  try {
    const folderDoc = await db.collection('adminFlashcardFolders').doc(folderId).get();
    if (!folderDoc.exists) {
      showToast(' Folder not found');
      return;
    }

    const folder = folderDoc.data();

    document.getElementById('adminFolderModalTitle').textContent = ' Edit Admin Folder';
    document.getElementById('adminFolderNameInput').value = folder.name || '';
    document.getElementById('saveAdminFolderBtn').textContent = 'Save Changes';

    // Populate parent folder dropdown (exclude current folder and its children)
    const parentSelect = document.getElementById('adminFolderParentSelect');
    if (parentSelect) {
      parentSelect.innerHTML = '<option value=""> Root Level (No Parent)</option>';
      if (adminFoldersCache && adminFoldersCache.length > 0) {
        // Only show root-level folders as potential parents, excluding current folder
        const rootFolders = adminFoldersCache.filter(f => !f.parentFolderId && f.id !== folderId);
        rootFolders.forEach(f => {
          const option = document.createElement('option');
          option.value = f.id;
          option.textContent = ` ${f.name}`;
          parentSelect.appendChild(option);
        });
      }
      parentSelect.value = folder.parentFolderId || '';
    }

    const autoAssignCb = document.getElementById('autoAssignFutureStudents');
    if (autoAssignCb) {
      autoAssignCb.checked = folder.autoAssignFuture !== false;
    }

    await loadStudentCheckboxes(folder.studentIds || []);

    await loadFlashcardCheckboxes(folder.flashcardIds || []);

    document.getElementById('adminFolderModal').style.display = 'flex';
  } catch (error) {
    showToast(' Error loading folder');
  }
}

function closeAdminFolderModal() {
  document.getElementById('adminFolderModal').style.display = 'none';
  document.getElementById('adminFolderName').value = '';
  editingAdminFolderId = null;
}

async function loadStudentCheckboxes(preChecked = []) {
  const container = document.getElementById('studentCheckboxList');
  container.innerHTML = '<div class="loading"></div>';

  try {
    const studentsSnap = await db.collection('users').where('role', '==', 'student').get();

    if (studentsSnap.empty) {
      container.innerHTML = '<p style="color: #718096;">No students found.</p>';
      return;
    }

    container.innerHTML = '';
    studentsSnap.forEach(doc => {
      const student = doc.data();
      const name = student.displayName || student.email?.split('@')[0] || 'Student';
      const isChecked = preChecked.includes(doc.id);

      const label = document.createElement('label');
      label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;';
      label.onmouseover = () => label.style.background = '#f7fafc';
      label.onmouseout = () => label.style.background = 'transparent';
      label.innerHTML = `
        <input type="checkbox" class="student-checkbox" value="${doc.id}" ${isChecked ? 'checked' : ''}>
        <span>${name}</span>
        <span style="color: #a0aec0; font-size: 11px;">(${student.email || ''})</span>
      `;
      container.appendChild(label);
    });

    updateSelectAllState();

  } catch (error) {
    container.innerHTML = '<p style="color: #e53e3e;">Error loading students</p>';
  }
}

async function loadFlashcardCheckboxes(preChecked = []) {
  const container = document.getElementById('flashcardCheckboxList');
  container.innerHTML = '<div class="loading"></div>';

  try {
    const flashcardsSnap = await db.collection('flashcards').get();

    if (flashcardsSnap.empty) {
      container.innerHTML = '<p style="color: #718096;">No flashcard sets available.</p>';
      return;
    }

    container.innerHTML = '';
    flashcardsSnap.forEach(doc => {
      const set = doc.data();
      if (!set.title || !set.wordPairs) return;

      const isChecked = preChecked.includes(doc.id);

      const label = document.createElement('label');
      label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;';
      label.onmouseover = () => label.style.background = '#f0f4ff';
      label.onmouseout = () => label.style.background = 'transparent';
      label.innerHTML = `
        <input type="checkbox" class="flashcard-checkbox" value="${doc.id}" ${isChecked ? 'checked' : ''}>
        <span> ${set.title}</span>
        <span style="color: #a0aec0; font-size: 11px;">(${set.wordPairs?.length || 0} words)</span>
      `;
      container.appendChild(label);
    });

  } catch (error) {
    container.innerHTML = '<p style="color: #e53e3e;">Error loading flashcards</p>';
  }
}

function toggleAllStudents(checked) {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = checked);
}

// When a parent folder is selected, inherit its students
function onParentFolderSelected(parentFolderId) {
  if (!parentFolderId) {
    // Root level selected - don't change student selection
    return;
  }
  
  // Find the parent folder in cache
  const parentFolder = adminFoldersCache?.find(f => f.id === parentFolderId);
  if (!parentFolder) return;
  
  const parentStudentIds = parentFolder.studentIds || [];
  
  if (parentStudentIds.length === 0) {
    showToast(' Parent folder has no students assigned');
    return;
  }
  
  // Check all students that are in the parent folder
  document.querySelectorAll('.student-checkbox').forEach(cb => {
    if (parentStudentIds.includes(cb.value)) {
      cb.checked = true;
    }
  });
  
  // Also check auto-assign if parent has it
  const autoAssignEl = document.getElementById('autoAssignFutureStudents');
  if (autoAssignEl && parentFolder.autoAssignFuture !== false) {
    autoAssignEl.checked = true;
  }
  
  updateSelectAllState();
  showToast(` Inherited ${parentStudentIds.length} student(s) from "${parentFolder.name}"`);
}

function updateSelectAllState() {
  const allCheckboxes = document.querySelectorAll('.student-checkbox');
  const checkedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
  const selectAllCb = document.getElementById('selectAllStudentsCheckbox');
  if (selectAllCb) {
    selectAllCb.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
    selectAllCb.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
  }
}

document.addEventListener('change', (e) => {
  if (e.target.classList.contains('student-checkbox')) {
    updateSelectAllState();
  }
});

async function saveAdminFolder() {
  const name = document.getElementById('adminFolderNameInput').value.trim();

  if (!name) {
    showToast(' Please enter a folder name');
    return;
  }

  const studentIds = [];
  document.querySelectorAll('.student-checkbox:checked').forEach(cb => {
    studentIds.push(cb.value);
  });

  const autoAssignFuture = document.getElementById('autoAssignFutureStudents')?.checked ?? true;

  if (studentIds.length === 0 && !autoAssignFuture) {
    showToast(' Please select at least one student or enable auto-assign');
    return;
  }

  const flashcardIds = [];
  document.querySelectorAll('.flashcard-checkbox:checked').forEach(cb => {
    flashcardIds.push(cb.value);
  });

  // Get parent folder ID
  const parentFolderId = document.getElementById('adminFolderParentSelect')?.value || null;

  try {
    const folderData = {
      name: name,
      studentIds: studentIds,
      flashcardIds: flashcardIds,
      autoAssignFuture: autoAssignFuture,
      createdBy: currentUser.uid,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Add parentFolderId if selected
    if (parentFolderId) {
      folderData.parentFolderId = parentFolderId;
    } else {
      // Remove parentFolderId if moving to root
      folderData.parentFolderId = firebase.firestore.FieldValue.delete();
    }

    if (editingAdminFolderId) {
      await db.collection('adminFlashcardFolders').doc(editingAdminFolderId).update(folderData);
      showToast(' Admin folder updated!');
    } else {
      folderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      // For new folders, don't use delete() - just don't include the field
      if (!parentFolderId) {
        delete folderData.parentFolderId;
      }
      await db.collection('adminFlashcardFolders').add(folderData);
      const msg = autoAssignFuture
        ? ` Folder created! Pushed to ${studentIds.length} student(s) + future students`
        : ` Folder pushed to ${studentIds.length} student(s)!`;
      showToast(msg);
    }

    closeAdminFolderModal();
    loadAdminFolderDashboard();
    loadFlashcardSets(); // Refresh the Existing Flashcard Sets view

  } catch (error) {
    showToast(' Error saving folder');
  }
}

async function deleteAdminFolder(folderId) {
  if (!confirm('Are you sure you want to delete this admin folder?\n\nThis will remove it from all students\' accounts.')) {
    return;
  }

  try {
    // Also delete any child folders
    const childFoldersSnap = await db.collection('adminFlashcardFolders')
      .where('parentFolderId', '==', folderId)
      .get();
    
    const batch = db.batch();
    childFoldersSnap.forEach(doc => {
      batch.delete(doc.ref);
    });
    batch.delete(db.collection('adminFlashcardFolders').doc(folderId));
    await batch.commit();
    
    showToast(' Admin folder deleted');
    loadAdminFolderDashboard();
    loadFlashcardSets(); // Refresh the Existing Flashcard Sets view
  } catch (error) {
    showToast(' Error deleting folder');
  }
}

async function loadAdminFoldersList() {
  const container = document.getElementById('adminFoldersList');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const foldersSnap = await db.collection('adminFlashcardFolders')
      .where('createdBy', '==', currentUser.uid)
      .orderBy('createdAt', 'desc')
      .get();

    if (foldersSnap.empty) {
      container.innerHTML = '<p style="color: #a16207; font-size: 13px;">No admin folders created yet.</p>';
      return;
    }

    container.innerHTML = '';
    foldersSnap.forEach(doc => {
      const folder = doc.data();
      const tag = document.createElement('div');
      tag.style.cssText = `
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 10px;
        color: #78350f;
        font-weight: 600;
        font-size: 13px;
      `;
      tag.innerHTML = `
        <span> ${folder.name}</span>
        <span style="font-size: 11px; opacity: 0.8;">(${folder.studentIds?.length || 0} students, ${folder.flashcardIds?.length || 0} sets)</span>
        <button onclick="openEditAdminFolderModal('${doc.id}')" style="background: rgba(255,255,255,0.3); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;"></button>
        <button onclick="deleteAdminFolder('${doc.id}')" style="background: rgba(255,255,255,0.3); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;"></button>
      `;
      container.appendChild(tag);
    });

  } catch (error) {
    container.innerHTML = '<p style="color: #e53e3e;">Error loading folders</p>';
  }
}

async function assignAdminFoldersToNewStudent(studentId) {
  try {

    const adminFoldersSnap = await db.collection('adminFlashcardFolders').get();

    if (adminFoldersSnap.empty) {
      return;
    }

    const batch = db.batch();
    let count = 0;

    adminFoldersSnap.forEach(doc => {
      const folderData = doc.data();
      const shouldAutoAssign = folderData.autoAssignFuture !== false;

      if (shouldAutoAssign) {
        const folderRef = db.collection('adminFlashcardFolders').doc(doc.id);
        batch.update(folderRef, {
          studentIds: firebase.firestore.FieldValue.arrayUnion(studentId)
        });
        count++;
      }
    });

    if (count > 0) {
      await batch.commit();
      console.log(`Assigned ${count} admin folder(s) to new student`);
    } else {
    }

  } catch (error) {
  }
}

document.addEventListener('DOMContentLoaded', () => {
});


function removeEditPair(index) {
  if (editingWordPairs.length <= 5) {
    alert('Must have at least 5 word pairs');
    return;
  }
  editingWordPairs.splice(index, 1);
  refreshEditModal();
}

function addEditPair() {
  editingWordPairs.push({korean: '', english: '', audioUrl: '', imageUrl: ''});
  refreshEditModal();

  const container = document.getElementById('editWordPairs');
  container.scrollTop = container.scrollHeight;
}

function refreshEditModal() {
  const container = document.getElementById('editWordPairs');
  if (!container) return;

  container.innerHTML = editingWordPairs.map((pair, i) => `
    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #e0e0e0;">
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
        <span style="width: 35px; font-weight: 600; color: #667eea;">#${i+1}</span>
        <input type="text" value="${pair.english || ''}" onchange="editingWordPairs[${i}].english=this.value" placeholder="English" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
        <input type="text" value="${pair.korean || ''}" onchange="editingWordPairs[${i}].korean=this.value" placeholder="Korean" style="flex: 1; padding: 10px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px; background: #f0f4ff;">
        <button onclick="removeEditPair(${i})" style="background: #f56565; color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-weight: 600;"></button>
      </div>

      <!-- Audio & Image Row -->
      <div style="display: flex; gap: 10px; margin-left: 45px;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 12px; color: #718096;"> Audio URL:</span>
            <input type="text" value="${pair.audioUrl || ''}" onchange="editingWordPairs[${i}].audioUrl=this.value" placeholder="https://..." style="flex: 1; padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
            ${pair.audioUrl ? `<button onclick="playEditAudio('${pair.audioUrl}')" style="background: #4299e1; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;"> Play</button>` : ''}
          </div>
        </div>
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 12px; color: #718096;"> Image URL:</span>
            <input type="text" value="${pair.imageUrl || ''}" onchange="editingWordPairs[${i}].imageUrl=this.value" placeholder="https://..." style="flex: 1; padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
            ${pair.imageUrl ? `<button onclick="previewEditImage('${pair.imageUrl}')" style="background: #9f7aea; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;"> View</button>` : ''}
          </div>
        </div>
      </div>

      <!-- Preview Row (if media exists) -->
      ${pair.audioUrl || pair.imageUrl ? `
        <div style="display: flex; gap: 15px; margin-left: 45px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e0e0e0;">
          ${pair.audioUrl ? `
            <div style="flex: 1;">
              <audio controls src="${pair.audioUrl}" style="width: 100%; height: 35px;"></audio>
            </div>
          ` : '<div style="flex: 1;"></div>'}
          ${pair.imageUrl ? `
            <div style="flex: 1; text-align: center;">
              <img src="${pair.imageUrl}" style="max-height: 60px; max-width: 100%; border-radius: 6px; border: 1px solid #e0e0e0;" onerror="this.style.display='none'">
            </div>
          ` : '<div style="flex: 1;"></div>'}
        </div>
      ` : ''}
    </div>
  `).join('');

  const label = container.previousElementSibling;
  if (label && label.tagName === 'LABEL') {
    label.textContent = `Word Pairs (${editingWordPairs.length} cards)`;
  }
}

function playEditAudio(url) {
  const audio = new Audio(url);
  audio.play().catch(e => alert('Could not play audio: ' + e.message));
}

function previewEditImage(url) {
  window.open(url, '_blank', 'width=600,height=400');
}

async function saveEdits() {
  const title = document.getElementById('editTitle').value.trim();
  const timer = parseInt(document.getElementById('editTimer').value) || 7;

  if (!title) {
    alert('Title required');
    return;
  }

  const validPairs = editingWordPairs.filter(p => p.korean && p.english).map(p => ({
    english: p.english,
    korean: p.korean,
    audioUrl: p.audioUrl || '',
    imageUrl: p.imageUrl || '',
    aiData: p.aiData || null  // Preserve existing AI data
  }));

  if (validPairs.length < 5) {
    alert('Need at least 5 complete word pairs');
    return;
  }

  try {
    const pairsNeedingAI = validPairs.filter(p => !p.aiData || !p.aiData.wordData || p.aiData.wordData.length === 0);

    if (pairsNeedingAI.length > 0) {
      const saveBtn = document.querySelector('#editFlashcardModal button[onclick="saveEdits()"]');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = ' Generating AI data...';

      for (let i = 0; i < validPairs.length; i++) {
        const pair = validPairs[i];

        if (pair.aiData && pair.aiData.wordData && pair.aiData.wordData.length > 0) {
          continue;
        }

        saveBtn.innerHTML = ` AI (${i + 1}/${validPairs.length}): "${pair.korean}"...`;

        try {
          const prompt = buildWordAnalysisPrompt(pair.korean, pair.english);

          const wordData = await callAIProxy([
            { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
            { role: 'user', content: prompt }
          ], 0.3);

          validPairs[i] = {
            ...pair,
            aiData: {
              wordData: Array.isArray(wordData) ? wordData : []
            }
          };
        } catch (aiError) {
        }
      }

      saveBtn.innerHTML = ' Saving...';
    }

    await db.collection('flashcards').doc(editingFlashcardId).update({
      title: title,
      timerSeconds: timer,
      wordPairs: validPairs,
      assets: editingAssets || {},
      hasAIData: validPairs.some(p => p.aiData),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Saved successfully!');
    closeEditModal();
    loadFlashcardSets();
  } catch (error) {
    alert('Error saving: ' + error.message);
    const saveBtn = document.querySelector('#editFlashcardModal button[onclick="saveEdits()"]');
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = ' Save Changes';
    }
  }
}

function closeEditModal() {
  const modal = document.getElementById('editFlashcardModal');
  if (modal) modal.remove();
  editingFlashcardId = null;
  editingWordPairs = [];
  editingAssets = {};
}

let soundEnabled = false;
let audioContext = null;

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
  }
}

function showSoundEnablePrompt() {
  if (soundEnabled || document.getElementById('soundEnablePrompt')) return;

  const prompt = document.createElement('div');
  prompt.id = 'soundEnablePrompt';
  prompt.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #f39c12;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    z-index: 10001;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    cursor: pointer;
    animation: slideDown 0.5s ease;
  `;
  prompt.innerHTML = ' Click here to enable sound effects';
  prompt.onclick = function() {
    initAudioContext();
    const silentAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
    silentAudio.play().then(() => {
      soundEnabled = true;
      prompt.remove();
    }).catch(e => {
      soundEnabled = true;
      prompt.remove();
    });
  };
  document.body.appendChild(prompt);

  setTimeout(() => {
    if (prompt.parentNode) prompt.remove();
  }, 10000);
}

function playSound(soundData) {
  if (!soundData) return;

  console.log('Playing sound (base64 data)');

  try {
    const audio = new Audio(soundData);
    audio.volume = 0.7;

    audio.play().then(() => {
      soundEnabled = true;
    }).catch(error => {
    });
  } catch (error) {
  }
}

function showPopupImage(imageData, soundData, duration = 500, className = '') {
  if (!imageData) {
    return;
  }

  // Remove any existing popup images first
  document.querySelectorAll('.popup-image').forEach(img => img.remove());

  const popupImg = document.createElement('img');
  popupImg.src = imageData;
  popupImg.className = 'popup-image';
  
  // Find the game title element to position below it
  const gameTitle = document.getElementById('gameSetTitle');
  
  let topPosition = 120;
  if (gameTitle) {
    const titleRect = gameTitle.getBoundingClientRect();
    topPosition = titleRect.bottom + 20;
  }
  
  const leftPosition = Math.round(window.innerWidth / 2);
  const isMobile = window.innerWidth <= 768;
  const imgSize = isMobile ? '120px' : '150px';
  
  popupImg.style.setProperty('position', 'fixed', 'important');
  popupImg.style.setProperty('top', topPosition + 'px', 'important');
  popupImg.style.setProperty('left', leftPosition + 'px', 'important');
  popupImg.style.setProperty('transform', 'translateX(-50%)', 'important');
  popupImg.style.setProperty('z-index', '999999', 'important');
  popupImg.style.setProperty('max-width', imgSize, 'important');
  popupImg.style.setProperty('max-height', imgSize, 'important');
  popupImg.style.setProperty('border-radius', '15px', 'important');
  popupImg.style.setProperty('box-shadow', '0 10px 40px rgba(0,0,0,0.3)', 'important');
  popupImg.style.setProperty('pointer-events', 'none', 'important');

  document.body.appendChild(popupImg);

  setTimeout(() => {
    if (popupImg.parentNode) {
      popupImg.remove();
    }
  }, duration);

  if (soundData) {
    playSound(soundData);
  }
}

function showEndGameGif(gifData, soundData) {
  if (!gifData) {
    return;
  }

  console.log('Showing end game GIF (base64)');

  const existingGif = document.querySelector('.end-game-gif');
  if (existingGif) {
    existingGif.remove();
  }

  const gif = document.createElement('img');
  gif.src = gifData;
  gif.className = 'end-game-gif';
  gif.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    max-width: 400px;
    max-height: 400px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  `;
  document.body.appendChild(gif);

  if (soundData) {
    playSound(soundData);
  }
}

async function preloadGameAssets(assets) {
  if (!assets) {
    return;
  }

  console.log('Assets ready (base64 data embedded)');
  return Promise.resolve();
}

function scrollToMyCards() {
  const myCardsDivider = document.querySelector('.mycards-section-divider');
  if (myCardsDivider) {
    myCardsDivider.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    showToast(' My Cards section not found. Create some cards first!');
  }
}

function filterFlashcardGames(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  const foldersGrid = document.getElementById('flashcardFoldersGrid');
  const unfiledSection = document.getElementById('unfiledFlashcardsSection');

  if (!foldersGrid) return;

  const allItems = foldersGrid.children;
  let hasVisibleMyCardsFolder = false;
  let inMyCardsSection = false;

  for (let i = 0; i < allItems.length; i++) {
    const item = allItems[i];

    if (item.classList.contains('mycards-section-divider')) {
      inMyCardsSection = true;
      continue;
    }

    let itemText = '';

    const folderName = item.querySelector('.folder-name');
    if (folderName) {
      itemText = folderName.textContent.toLowerCase();
    }

    const cardTitle = item.querySelector('.flashcard-card-title');
    if (cardTitle) {
      itemText = cardTitle.textContent.toLowerCase();
    }

    if (item.dataset && item.dataset.title) {
      itemText = item.dataset.title;
    }

    if (term === '' || itemText.includes(term)) {
      item.style.display = '';
      if (inMyCardsSection && item.classList.contains('fc-folder-card')) {
        hasVisibleMyCardsFolder = true;
      }
    } else {
      item.style.display = 'none';
    }
  }

  const dividers = foldersGrid.querySelectorAll('.mycards-section-divider');
  dividers.forEach(divider => {
    if (term === '') {
      divider.style.display = '';
    } else {
      divider.style.display = hasVisibleMyCardsFolder ? '' : 'none';
    }
  });

  if (unfiledSection && unfiledSection.style.display !== 'none') {
    const unfiledCards = unfiledSection.querySelectorAll('.flashcard-game-card');
    let hasVisibleUnfiled = false;
    unfiledCards.forEach(card => {
      const title = card.dataset?.title || card.querySelector('.flashcard-card-title')?.textContent?.toLowerCase() || '';
      if (term === '' || title.includes(term)) {
        card.style.display = '';
        hasVisibleUnfiled = true;
      } else {
        card.style.display = 'none';
      }
    });

    const unfiledHeader = unfiledSection.querySelector('h3');
    if (unfiledHeader) {
      unfiledHeader.style.display = (term === '' || hasVisibleUnfiled) ? '' : 'none';
    }
  }
}

async function loadAvailableFlashcards() {
  const foldersGrid = document.getElementById('flashcardFoldersGrid');
  const unfiledContainer = document.getElementById('availableFlashcards');

  currentFolderView = null;
  document.getElementById('folderContentsView').style.display = 'none';
  document.getElementById('flashcardFoldersSection').style.display = 'block';
  document.getElementById('unfiledFlashcardsSection').style.display = 'block';

  foldersGrid.innerHTML = '<div class="loading" style="grid-column: 1/-1;"></div>';
  unfiledContainer.innerHTML = '<div class="loading"></div>';

  try {
    const flashcardsSnap = await db.collection('flashcards').get();
    const allFlashcards = [];
    flashcardsSnap.forEach(doc => {
      const set = doc.data();
      if (set.title && Array.isArray(set.wordPairs) && set.wordPairs.length > 0) {
        allFlashcards.push({ id: doc.id, ...set });
      }
    });

    const flashcardsInFolders = new Set();

    // Load ALL admin folders - all folders are visible to all students
    const allAdminFoldersSnap = await db.collection('adminFlashcardFolders').get();
    const adminFolders = [];
    allAdminFoldersSnap.forEach(doc => {
      const folder = { id: doc.id, ...doc.data() };
      adminFolders.push(folder);
      (folder.flashcardIds || []).forEach(id => flashcardsInFolders.add(id));
    });

    const studentFolders = [];
    try {
      const studentFoldersSnap = await db.collection('users').doc(currentUser.uid)
        .collection('flashcardFolders').orderBy('createdAt', 'desc').get();
      studentFoldersSnap.forEach(doc => {
        const folder = { id: doc.id, ...doc.data(), isAdmin: false };
        studentFolders.push(folder);
        (folder.flashcardIds || []).forEach(id => flashcardsInFolders.add(id));
      });
    } catch(e) {
      console.log('Student folders not available (this is normal if not enabled)');
    }

    const myCardsSyncedFolders = [];
    try {
      const syncedFoldersSnap = await db.collection('studentFolders')
        .where('studentId', '==', currentUser.uid)
        .where('syncedToGames', '==', true)
        .get();
      syncedFoldersSnap.forEach(doc => {
        const folder = { id: doc.id, ...doc.data() };
        myCardsSyncedFolders.push(folder);
      });
    } catch(e) { }

    for (const folder of myCardsSyncedFolders) {
      try {
        const cardsSnap = await db.collection('studentFlashcards')
          .where('studentId', '==', currentUser.uid)
          .where('folderId', '==', folder.id)
          .get();
        folder.cardCount = cardsSnap.docs.filter(doc => {
          const data = doc.data();
          return data.korean && data.english;
        }).length;
      } catch(e) {
        folder.cardCount = 0;
      }
    }

    foldersGrid.innerHTML = '';

    // Identify master folders (folders that have children)
    const childFolderParentIds = new Set(adminFolders.filter(f => f.parentFolderId).map(f => f.parentFolderId));
    
    // Separate root and child admin folders
    const rootAdminFolders = adminFolders.filter(f => !f.parentFolderId);
    const childAdminFolders = adminFolders.filter(f => f.parentFolderId);

    // Render root admin folders first (master folders in yellow)
    rootAdminFolders.forEach(folder => {
      const folderCard = document.createElement('div');
      const isMaster = childFolderParentIds.has(folder.id);
      
      // Master folders get yellow styling
      if (isMaster) {
        folderCard.className = 'fc-folder-card master-folder';
      } else {
        folderCard.className = 'fc-folder-card admin-folder';
      }
      
      folderCard.onclick = () => openFolder(folder.id, folder.name, true);

      const count = (folder.flashcardIds || []).length;
      const childCount = childAdminFolders.filter(c => c.parentFolderId === folder.id).length;
      
      const badgeText = isMaster ? ' MASTER' : ' Admin';
      
      folderCard.innerHTML = `
        <div class="folder-badge">${badgeText}</div>
        <div class="folder-icon">${folder.icon || ''}</div>
        <div class="folder-name">${folder.name}</div>
        <div class="folder-count">${count} set${count !== 1 ? 's' : ''}${isMaster ? '  ' + childCount : ''}</div>
      `;

      foldersGrid.appendChild(folderCard);
      
      // Render child folders of this master folder right after it
      if (isMaster) {
        const children = childAdminFolders.filter(c => c.parentFolderId === folder.id);
        children.forEach(childFolder => {
          const childCard = document.createElement('div');
          childCard.className = 'fc-folder-card admin-folder';
          childCard.onclick = () => openFolder(childFolder.id, childFolder.name, true);
          
          const childSetCount = (childFolder.flashcardIds || []).length;
          childCard.innerHTML = `
            <div class="folder-badge"> Admin</div>
            <div class="folder-parent-path" style="font-size: 9px; color: rgba(255,255,255,0.8); margin-bottom: 4px;"> in ${folder.name}</div>
            <div class="folder-icon">${childFolder.icon || ''}</div>
            <div class="folder-name">${childFolder.name}</div>
            <div class="folder-count">${childSetCount} set${childSetCount !== 1 ? 's' : ''}</div>
          `;
          foldersGrid.appendChild(childCard);
        });
      }
    });

    const unfiledFlashcards = allFlashcards.filter(fc => !flashcardsInFolders.has(fc.id));

    if (unfiledFlashcards.length > 0) {
      unfiledFlashcards.forEach(set => {
        foldersGrid.appendChild(createFlashcardCard(set));
      });
    }

    studentFolders.forEach(folder => {
      const folderCard = document.createElement('div');
      folderCard.className = 'fc-folder-card student-folder';

      const color = folder.color || '#667eea';
      const gradient = folderColors[color] || folderColors['#667eea'];
      folderCard.style.background = gradient;
      folderCard.style.borderColor = color;

      folderCard.onclick = () => openFolder(folder.id, folder.name, false);

      const count = (folder.flashcardIds || []).length;
      const safeName = folder.name.replace(/'/g, "\\'");
      const safeColor = folder.color || '#667eea';
      folderCard.innerHTML = `
        <div class="folder-icon"></div>
        <div class="folder-name">${folder.name}</div>
        <div class="folder-count">${count} set${count !== 1 ? 's' : ''}</div>
        <div class="folder-actions">
          <button onclick="event.stopPropagation(); openEditFolderModal('${folder.id}', '${safeName}', '${safeColor}')" title="Edit"></button>
          <button class="delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" title="Delete"></button>
        </div>
      `;

      foldersGrid.appendChild(folderCard);
    });

    const createBtn = document.createElement('div');
    createBtn.className = 'fc-create-folder-btn';
    createBtn.onclick = openCreateFolderModal;
    createBtn.innerHTML = `
      <div class="plus-icon">+</div>
      <span>Create Folder</span>
    `;
    foldersGrid.appendChild(createBtn);

    if (myCardsSyncedFolders.length > 0) {
      const divider = document.createElement('div');
      divider.className = 'mycards-section-divider';
      divider.innerHTML = `
        <div class="divider-icon"></div>
        <div class="divider-text">My Cards</div>
        <div class="divider-badge">Created by you</div>
      `;
      foldersGrid.appendChild(divider);

      myCardsSyncedFolders.forEach(folder => {
        const folderCard = document.createElement('div');
        const hasEnoughCards = folder.cardCount >= 5;
        folderCard.className = `fc-folder-card mycards-folder ${!hasEnoughCards ? 'disabled-folder' : ''}`;

        if (hasEnoughCards) {
          folderCard.onclick = () => startMyCardsFlashcardGame(folder.id);
        } else {
          folderCard.onclick = () => {
            alert(`Unable to start game. This folder has only ${folder.cardCount} valid cards.\n\nMinimum required: 5 cards with both Korean and English.`);
          };
        }

        const tooltipText = hasEnoughCards
          ? `${folder.cardCount} cards ready to play!`
          : `Need ${5 - folder.cardCount} more cards. Minimum 5 required, we recommend 20+.`;

        folderCard.innerHTML = `
          <div class="folder-badge"> My Cards</div>
          <div class="folder-icon"></div>
          <div class="folder-name">${folder.name}</div>
          <div class="folder-count" style="display: flex; align-items: center; gap: 4px;">
            ${folder.cardCount} card${folder.cardCount !== 1 ? 's' : ''}
            <span class="folder-info-tooltip">
              <span class="tooltip-content">${tooltipText}</span>
            </span>
          </div>
          ${!hasEnoughCards ? '<div style="font-size: 10px; color: #92400e; margin-top: 5px;"> Need 5+ cards</div>' : ''}
        `;

        foldersGrid.appendChild(folderCard);
      });
    }

    unfiledContainer.innerHTML = '';
    if (unfiledFlashcards.length === 0 && allFlashcards.length === 0) {
      unfiledContainer.innerHTML = '<p style="text-align: center; color: #718096; grid-column: 1/-1;">No flashcard games available yet.</p>';
    } else if (unfiledFlashcards.length === 0) {
      unfiledContainer.innerHTML = '<p style="text-align: center; color: #718096; grid-column: 1/-1;">All teacher flashcards are organized in folders! </p>';
    }

    document.getElementById('unfiledFlashcardsSection').style.display = 'none';

  } catch (error) {
    foldersGrid.innerHTML = '<p style="grid-column: 1/-1;">Error loading folders</p>';
    unfiledContainer.innerHTML = '<p>Error loading flashcard games: ' + error.message + '</p>';
  }
}

async function startFlashcardGame(setId) {
  try {

    const doc = await db.collection('flashcards').doc(setId).get();
    if (!doc.exists) {
      alert('Flashcard set not found');
      return;
    }

    currentFlashcardSet = { id: setId, ...doc.data() };

    currentFlashcardSet.wordPairs = shuffleArray([...currentFlashcardSet.wordPairs]);

    currentSetIndex = 0;
    gameResults = [];
    missedWords = []; // Reset missed words for new game
    newWordsAddedToLeitner = 0; // Reset counter for new words added to calendar

    const setAssets = currentFlashcardSet.assets || null;
    currentGameAssets = getEffectiveGameAssets(setAssets);
    correctStreakInSet = 0;
    currentSetCorrectCount = 0;
    totalGameCorrect = 0;
    totalGameWords = 0;

    console.log('Effective game assets (with universal fallback):', currentGameAssets);

    if (currentGameAssets && (currentGameAssets.startImage || currentGameAssets.progressImage)) {
      const loadingMsg = document.createElement('div');
      loadingMsg.id = 'assetLoadingMsg';
      loadingMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 10000;
        text-align: center;
      `;
      loadingMsg.innerHTML = `
        <div class="loading"></div>
        <p style="margin-top: 20px; color: #667eea; font-weight: 600;">Loading game assets...</p>
      `;
      document.body.appendChild(loadingMsg);

      await preloadGameAssets(currentGameAssets);

      if (loadingMsg.parentNode) {
        loadingMsg.remove();
      }
    }

    initializeSpeechRecognition();

    showJunbiPage();

  } catch (error) {
    alert('Error starting game: ' + error.message);
  }
}

let isPaperFolded = false;
let junbiConfig = null;

async function loadJunbiConfig() {
  try {
    const docSnap = await db.collection('adminSettings').doc('junbiConfig').get();
    if (docSnap.exists) {
      junbiConfig = docSnap.data();
    }
  } catch (error) {
  }
}

function showJunbiPage() {
  document.getElementById('availableFlashcards').style.display = 'none';

  document.getElementById('junbiDeckName').textContent = currentFlashcardSet.title;

  const wordListBody = document.getElementById('junbiWordList');
  wordListBody.innerHTML = currentFlashcardSet.wordPairs.map((word, index) => {
    // Always use the original Korean text for display
    // AI data is only used for hover definitions, not for display text
    let koreanCell = word.korean;

    let englishCell = word.english;

    return `
    <tr>
      <td style="color: #718096; font-weight: 500;">${index + 1}</td>
      <td class="english-col">${englishCell}</td>
      <td class="korean-col" id="koreanWord-${index}">${koreanCell}</td>
    </tr>
  `}).join('');

  isPaperFolded = false;
  document.getElementById('junbiPaper').classList.remove('folded');
  document.getElementById('foldBtnIcon').textContent = '';
  document.getElementById('foldBtnText').textContent = 'Fold Paper';

  const junbiOverlay = document.getElementById('junbiPage');
  const characterImg = document.getElementById('junbiCharacterOverlay');

  if (junbiConfig && junbiConfig.backgroundUrl) {
    junbiOverlay.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('${junbiConfig.backgroundUrl}')`;
  } else {
    junbiOverlay.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23f5f0e8" width="100" height="100"/><rect fill="%23e8e0d0" x="0" y="85" width="100" height="15"/><rect fill="%238B4513" x="5" y="5" width="3" height="80"/><rect fill="%238B4513" x="92" y="5" width="3" height="80"/><rect fill="%23c41e3a" x="30" y="10" width="40" height="60" rx="2"/><text x="50" y="45" font-size="8" fill="white" text-anchor="middle" font-weight="bold"></text></svg>')`;
  }

  const isMobile = window.innerWidth <= 768;
  
  if (junbiConfig && junbiConfig.characterUrl && !isMobile) {
    characterImg.src = junbiConfig.characterUrl;
    characterImg.style.display = 'block';

    const position = junbiConfig.characterPosition || 'right';
    const vertical = junbiConfig.characterVertical || 'bottom';
    const size = junbiConfig.characterSize || 'medium';

    characterImg.style.left = 'auto';
    characterImg.style.right = 'auto';
    characterImg.style.top = 'auto';
    characterImg.style.bottom = 'auto';
    characterImg.style.transform = 'none';

    if (position === 'left') {
      characterImg.style.left = '20px';
    } else if (position === 'center') {
      characterImg.style.left = '50%';
      characterImg.style.transform = 'translateX(-50%)';
    } else {
      characterImg.style.right = '20px';
    }

    if (vertical === 'top') {
      characterImg.style.top = '20px';
    } else if (vertical === 'middle') {
      characterImg.style.top = '50%';
      if (position === 'center') {
        characterImg.style.transform = 'translate(-50%, -50%)';
      } else {
        characterImg.style.transform = 'translateY(-50%)';
      }
    } else {
      characterImg.style.bottom = '20px';
    }

    const sizes = { small: '100px', medium: '150px', large: '200px', xlarge: '250px' };
    characterImg.style.maxHeight = sizes[size];
    characterImg.style.maxWidth = size === 'xlarge' ? '200px' : size === 'large' ? '160px' : size === 'medium' ? '120px' : '80px';
  } else {
    characterImg.style.display = 'none';
  }

  updateFlashcardModeDisplay();

  document.getElementById('junbiPage').style.display = 'flex';
}

function togglePaperFold() {
  isPaperFolded = !isPaperFolded;

  const paper = document.getElementById('junbiPaper');
  const koreanCells = document.querySelectorAll('.korean-col');
  const foldIcon = document.getElementById('foldBtnIcon');
  const foldText = document.getElementById('foldBtnText');

  if (isPaperFolded) {
    paper.classList.add('folded');
    koreanCells.forEach(cell => cell.classList.add('hidden-text'));
    foldIcon.textContent = '';
    foldText.textContent = 'Unfold Paper';
  } else {
    paper.classList.remove('folded');
    koreanCells.forEach(cell => cell.classList.remove('hidden-text'));
    foldIcon.textContent = '';
    foldText.textContent = 'Fold Paper';
  }
}

function startGameFromJunbi() {
  document.getElementById('junbiPage').style.display = 'none';

  const gameInterface = document.getElementById('flashcardGameInterface');
  const gameCharacter = document.getElementById('gameCharacterOverlay');

  const junbiPage = document.getElementById('junbiPage');
  if (junbiPage.style.backgroundImage) {
    gameInterface.style.backgroundImage = junbiPage.style.backgroundImage;
  } else {
    gameInterface.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23f5f0e8" width="100" height="100"/><rect fill="%23e8e0d0" x="0" y="85" width="100" height="15"/><rect fill="%238B4513" x="5" y="5" width="3" height="80"/><rect fill="%238B4513" x="92" y="5" width="3" height="80"/><rect fill="%23c41e3a" x="30" y="10" width="40" height="60" rx="2"/><text x="50" y="45" font-size="8" fill="white" text-anchor="middle" font-weight="bold"></text></svg>')`;
  }
  gameInterface.style.backgroundSize = 'cover';
  gameInterface.style.backgroundPosition = 'center';

  const junbiCharacter = document.getElementById('junbiCharacterOverlay');
  const isMobile = window.innerWidth <= 768;
  
  if (junbiCharacter && junbiCharacter.src && junbiCharacter.style.display !== 'none' && !isMobile) {
    gameCharacter.src = junbiCharacter.src;
    gameCharacter.style.display = junbiCharacter.style.display;
    gameCharacter.style.left = junbiCharacter.style.left;
    gameCharacter.style.right = junbiCharacter.style.right;
    gameCharacter.style.top = junbiCharacter.style.top;
    gameCharacter.style.bottom = junbiCharacter.style.bottom;
    gameCharacter.style.transform = junbiCharacter.style.transform;
    gameCharacter.style.width = junbiCharacter.style.width;
    gameCharacter.style.maxHeight = junbiCharacter.style.maxHeight;
  } else {
    gameCharacter.style.display = 'none';
  }

  gameInterface.style.display = 'flex';
  document.getElementById('gameSetTitle').textContent = currentFlashcardSet.title;

  isFlashcardGameActive = true;

  setupFlashcardGameControls();

  requestWakeLock();

  if (!soundEnabled) {
    showSoundEnablePrompt();
  }

  if (currentGameAssets && currentGameAssets.startImage) {
    setTimeout(() => {
      showPopupImage(
        currentGameAssets.startImage,
        currentGameAssets.startSound,
        500,
        'game-start'
      );
    }, 100);
  }

  loadFlashcardRound();
  setTimeout(() => {
    startFlashcardRound();
  }, 800);
}

/**
 * Request wake lock to keep screen awake during game
 */
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      flashcardWakeLock = await navigator.wakeLock.request('screen');

      flashcardWakeLock.addEventListener('release', () => {
      });
    } catch (e) {
    }
  }
}

/**
 * Release wake lock when game ends
 */
async function releaseWakeLock() {
  if (flashcardWakeLock) {
    try {
      await flashcardWakeLock.release();
      flashcardWakeLock = null;
    } catch (e) {
    }
  }
}

/**
 * Show interrupted screen when game is paused due to app switch/call/etc
 */
function showGameInterruptedScreen() {
  if (!isFlashcardGameActive) return;

  clearInterval(flashcardTimer);
  isListening = false;

  let overlay = document.getElementById('gameInterruptedOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'gameInterruptedOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10001;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    `;
    overlay.innerHTML = `
      <div style="font-size: 60px;"></div>
      <div style="color: white; font-size: 24px; font-weight: 600;">Game Paused</div>
      <div style="color: #a0aec0; font-size: 14px;">Tap to resume</div>
      <button onclick="resumeFlashcardGameFromInterrupt()" style="padding: 15px 40px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 20px;">
         Resume Game
      </button>
    `;
    document.body.appendChild(overlay);
  } else {
    overlay.style.display = 'flex';
  }
}

/**
 * Resume game after interruption
 */
function resumeFlashcardGameFromInterrupt() {
  const overlay = document.getElementById('gameInterruptedOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }

  if (isFlashcardGameActive) {
    isListening = true;
    isGamePaused = false;
    document.getElementById('listeningIndicator').style.display = 'block';
    startWordTimer();
  }
}

/**
 * Global Korean text normalization for voice recognition
 * Converts number words to digits and normalizes vowels
 */
function normalizeKoreanForVoice(str) {
  let result = str
    .replace(/\s+/g, '')
    .replace(/[.,!?~'"'""]/g, '')
    
    // === PAST TENSE SOUND-ALIKE PAIRS ===
    .replace(//g, '')  //  = 
    .replace(//g, '')  //  =  (careful - context dependent)
    .replace(//g, '')  //  =  (careful - context dependent)
    .replace(//g, '')  //  = 
    .replace(//g, '')  //  =  (careful)
    .replace(//g, '').replace(//g, '')  //  =  = 
    .replace(//g, '')  //  =  (careful)
    .replace(//g, '')  //  = 
    .replace(//g, '')  //  = 
    .replace(//g, '')  //  = 
    
    //  variations (sounds-like)
    .replace(//g, '').replace(//g, '')
    
    //  conjugations =  sounds-like
    .replace(//g, '')
    
    // === PRONUNCIATION-BASED EQUIVALENCES (, , etc.) ===
    
    // / sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like ( weakening)
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like ( weakening)
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  sounds-like
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  (to sit) -  cluster
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  (not) -  cluster  
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  (many) -  cluster
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    
    //  (to read) -  cluster
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    //  (to be young) -  cluster
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    // / (to have)
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '')
    
    //  (to wear shoes)
    .replace(//g, '').replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '').replace(//g, '')
    
    // Other consonant cluster words
    .replace(//g, '')  // 
    .replace(//g, '')  // 
    .replace(//g, '')  // 
    .replace(//g, '')  // 
    .replace(//g, '')  // 
    .replace(//g, '').replace(//g, '')  // 
    .replace(//g, '').replace(//g, '')  // 
    .replace(//g, '')  // 
    .replace(//g, '').replace(//g, '')  // 
    .replace(//g, '').replace(//g, '')  // 
    
    // === VERB CONTRACTION EQUIVALENCES ===
    //  contractions:   /
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(/(?![])/g, '').replace(/(?![])/g, '')
    
    //  contractions:   
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(//g, '').replace(//g, '')
    .replace(/(?![])/g, '')
    
    //  contractions:   
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    
    //  contractions:   
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(/(?![])/g, '')
    
    //  irregular adjectives:   
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    
    // === NUMBER CONVERSIONS ===
    // Convert Korean number words to digits (Sino-Korean)
    .replace(//g, '0')
    .replace(//g, '1')
    .replace(//g, '2')
    .replace(//g, '3')
    .replace(//g, '4')
    .replace(//g, '5')
    .replace(//g, '6')
    .replace(//g, '7')
    .replace(//g, '8')
    .replace(//g, '9')
    .replace(//g, '10')
    .replace(//g, '100')
    .replace(//g, '1000')
    // Convert Native Korean numbers to digits (full forms)
    .replace(//g, '1')
    .replace(//g, '2')
    .replace(//g, '3')
    .replace(//g, '4')
    .replace(//g, '5')
    .replace(//g, '6')
    .replace(//g, '7')
    .replace(//g, '8')
    .replace(//g, '9')
    .replace(//g, '10')
    .replace(//g, '20')
    // Convert bound/counter forms (, , , ,  before counters)
    .replace(/(?=[])/g, '1')
    .replace(/(?=[])/g, '2')
    .replace(/(?=[])/g, '3')
    .replace(/(?=[])/g, '4')
    .replace(/(?=[])/g, '20')
    
    // === VOWEL EQUIVALENCES ===
    // Treat / as equivalent (/, /, etc.)
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '')
    .replace(//g, '');
    
  return result;
}

function calculateSimilarity(str1, str2) {
  if (str1 === str2) return 1;
  if (str1.length === 0 || str2.length === 0) return 0;

  if (str1 === str2) return 1;

  if (str1 === str2 || str1.includes(str2) && str2.length >= str1.length * 0.8) return 0.95;
  if (str2.includes(str1) && str1.length >= str2.length * 0.8) return 0.95;

  const matrix = [];
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2[i-1] === str1[j-1]) {
        matrix[i][j] = matrix[i-1][j-1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i-1][j-1] + 1, // substitution
          matrix[i][j-1] + 1,   // insertion
          matrix[i-1][j] + 1    // deletion
        );
      }
    }
  }

  const distance = matrix[str2.length][str1.length];
  const maxLength = Math.max(str1.length, str2.length);
  return 1 - (distance / maxLength);
}

function loadFlashcardRound() {
  correctStreakInSet = 0;
  currentSetCorrectCount = 0;

  let wordsForThisRound = [...missedWords];

  const newWordsNeeded = Math.max(0, 5 - wordsForThisRound.length);

  const startIdx = currentSetIndex * 5;
  const endIdx = Math.min(startIdx + newWordsNeeded, currentFlashcardSet.wordPairs.length);

  for (let i = startIdx; i < endIdx; i++) {
    const newWord = currentFlashcardSet.wordPairs[i];
    const alreadyIncluded = wordsForThisRound.some(w => w.english === newWord.english && w.korean === newWord.korean);
    if (!alreadyIncluded) {
      wordsForThisRound.push(newWord);
    }
  }

  let nextIdx = endIdx;
  while (wordsForThisRound.length < 5 && nextIdx < currentFlashcardSet.wordPairs.length) {
    const nextWord = currentFlashcardSet.wordPairs[nextIdx];
    const alreadyIncluded = wordsForThisRound.some(w => w.english === nextWord.english && w.korean === nextWord.korean);
    if (!alreadyIncluded) {
      wordsForThisRound.push(nextWord);
    }
    nextIdx++;
  }

  wordsForThisRound = shuffleArray(wordsForThisRound);

  currentGameWords = wordsForThisRound;

  const totalSets = Math.ceil(currentFlashcardSet.wordPairs.length / 5);
  let setLabel = `Set ${currentSetIndex + 1} of ${totalSets}`;
  if (missedWords.length > 0) {
    setLabel += ` (${missedWords.length} review word${missedWords.length > 1 ? 's' : ''})`;
  }
  document.getElementById('currentSetNumber').textContent = setLabel;
  document.getElementById('gameProgressBar').style.width = `${((currentSetIndex + 1) / totalSets) * 100}%`;

  const wordsListDiv = document.getElementById('wordsList');
  wordsListDiv.innerHTML = currentGameWords.map((word, index) => {
    const isReviewWord = missedWords.some(w => w.english === word.english && w.korean === word.korean);
    return `
      <div class="word-item" id="word-${index}" data-index="${index}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: ${isReviewWord ? '#fff5f5' : 'white'}; border-radius: 8px; border: 2px solid ${isReviewWord ? '#fc8181' : '#e2e8f0'}; position: relative;">
        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span class="word-number" style="font-weight: bold; color: ${isReviewWord ? '#f56565' : '#667eea'}; font-size: 14px;">${index + 1}.${isReviewWord ? '' : ''}</span>
          <span class="word-text" style="font-size: 16px; font-weight: 600; color: #000000;">${word.english}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="word-status" id="status-${index}" style="font-size: 18px;"></div>
        </div>
      </div>
    `;
  }).join('');

  // Reset scroll to top so word #1 is always visible
  wordsListDiv.scrollTop = 0;

  currentWordIndex = 0;
  document.getElementById('gameResults').style.display = 'none';
  document.getElementById('recognizedText').textContent = '';
  document.getElementById('wordTimer').textContent = currentFlashcardSet.timerSeconds || 15;

  const streakIndicator = document.getElementById('streakIndicator');
  if (streakIndicator) {
    streakIndicator.classList.add('hidden');
  }

  highlightCurrentWord();
}

function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function highlightCurrentWord() {
  document.querySelectorAll('.word-item').forEach(item => {
    item.style.background = 'white';
    item.style.transform = 'scale(1)';
  });

  if (currentWordIndex < currentGameWords.length) {
    const currentItem = document.getElementById(`word-${currentWordIndex}`);
    if (currentItem) {
      currentItem.style.background = 'linear-gradient(135deg, #667eea10 0%, #764ba210 100%)';
      currentItem.style.transform = 'scale(1.02)';
    }
  }
}

// Skip the current word completely (no coins, no redo)
function skipFlashcardWordCompletely() {
  if (currentWordIndex >= currentGameWords.length) return;
  
  clearInterval(flashcardTimer);
  
  // Stop recognition temporarily
  if (recognition && isListening) {
    try {
      recognition.stop();
    } catch (e) {}
  }
  
  const index = currentWordIndex;
  const skippedWord = currentGameWords[index];
  
  // REMOVE from missedWords so it won't repeat (if it was there from a previous round)
  missedWords = missedWords.filter(w => !(w.english === skippedWord.english && w.korean === skippedWord.korean));
  
  // Mark visually as skipped
  const wordItem = document.getElementById(`word-${index}`);
  const statusEl = document.getElementById(`status-${index}`);
  
  if (wordItem) {
    wordItem.style.background = '#fee2e2';
    wordItem.style.transform = 'scale(1)';
    wordItem.style.borderColor = '#f87171';
  }
  if (statusEl) {
    statusEl.textContent = '';
  }
  
  // Show the Korean answer
  const wordText = wordItem.querySelector('.word-text');
  if (wordText) {
    wordText.innerHTML = `<span style="color: #718096;">${currentGameWords[index].english}</span>  <span style="color: #f56565;">${currentGameWords[index].korean}</span>`;
  }
  
  // Speak the Korean
  speakKorean(currentGameWords[index].korean);
  
  // Track as skipped
  totalGameWords++;
  gameResults.push({ word: currentGameWords[index], correct: false, skipped: true });
  
  // Add skipped word to Leitner calendar
  if (currentFlashcardSet && currentFlashcardSet.id) {
    addCardToLeitnerBoxWithDupeCheck(currentGameWords[index], currentFlashcardSet.id).then(wasAdded => {
      if (wasAdded) {
        newWordsAddedToLeitner++;
      }
    });
  }
  
  // Move to next word (don't add to missedWords - fully skipped)
  currentWordIndex++;
  if (currentWordIndex < currentGameWords.length) {
    highlightCurrentWord();
    setTimeout(() => {
      // Restart recognition for next word
      if (recognition && !swipeMode.enabled) {
        try {
          recognition.start();
          isListening = true;
        } catch (e) {}
      }
      startWordTimer();
    }, 1500);
  } else {
    // All words in this set done, show results
    isListening = false;
    setTimeout(() => showRoundResults(), 500);
  }
}

/**
 * Check if speech disclaimer needs to be shown
 * Returns true if user has acknowledged within last 24 hours
 */
function hasSpeechDisclaimerBeenAcknowledged() {
  // If game is already active, skip disclaimer for subsequent rounds
  if (isFlashcardGameActive && window.flashcardSessionDisclaimerShown) {
    return true;
  }
  
  const dismissedUntil = localStorage.getItem('speechDisclaimerDismissedUntil');
  if (dismissedUntil) {
    const dismissedTime = parseInt(dismissedUntil);
    if (Date.now() < dismissedTime) {
      return true;
    }
  }
  return false;
}

/**
 * Show the speech disclaimer popup
 * @param {Function} onProceed - Callback when user acknowledges
 */
function showSpeechDisclaimer(onProceed) {
  // If already acknowledged, proceed directly
  if (hasSpeechDisclaimerBeenAcknowledged()) {
    onProceed();
    return;
  }
  
  const modal = document.createElement('div');
  modal.id = 'speechDisclaimerModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    padding: 20px;
  `;
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 25px; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; color: #1a202c; font-size: 20px;">Voice Recognition Notice</h3>
      </div>
      
      <div style="background: #f7fafc; border-radius: 12px; padding: 16px; margin-bottom: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
        <p style="margin: 0 0 12px 0;">This game runs on speech-to-text transcription. Please note:</p>
        <ul style="margin: 0; padding-left: 20px;">
          <li style="margin-bottom: 8px;">Speaking too slowly or unclear pronunciation may not be marked correct</li>
          <li style="margin-bottom: 8px;">Background noise can interfere with recognition</li>
          <li> <strong>Use headphones with a dedicated external microphone</strong> for the best experience</li>
        </ul>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="acknowledgeSpeechDisclaimer(true)" 
          style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: white; cursor: pointer;">
           I Understand, Let's Go!
        </button>
        <button onclick="acknowledgeSpeechDisclaimer(false)" 
          style="width: 100%; padding: 12px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 500; color: #718096; cursor: pointer;">
          Don't show this for 24 hours
        </button>
      </div>
    </div>
  `;
  
  // Store the callback for later
  window.speechDisclaimerCallback = onProceed;
  
  document.body.appendChild(modal);
}

/**
 * Handle disclaimer acknowledgment
 * @param {boolean} justOnce - If false, dismiss for 24 hours
 */
function acknowledgeSpeechDisclaimer(justOnce) {
  const modal = document.getElementById('speechDisclaimerModal');
  if (modal) modal.remove();
  
  // Mark that disclaimer was shown this session (for subsequent rounds)
  window.flashcardSessionDisclaimerShown = true;
  
  if (!justOnce) {
    // Dismiss for 24 hours
    const dismissUntil = Date.now() + (24 * 60 * 60 * 1000);
    localStorage.setItem('speechDisclaimerDismissedUntil', dismissUntil.toString());
  }
  
  // Call the stored callback
  if (window.speechDisclaimerCallback) {
    window.speechDisclaimerCallback();
    window.speechDisclaimerCallback = null;
  }
}

// Wrapper that shows disclaimer before starting
function startFlashcardRound() {
  if (swipeMode.enabled) {
    // Swipe mode doesn't need voice disclaimer
    _startFlashcardRoundInternal();
    return;
  }
  
  showSpeechDisclaimer(() => {
    _startFlashcardRoundInternal();
  });
}

function _startFlashcardRoundInternal() {
  if (currentWordIndex >= currentGameWords.length) {
    showRoundResults();
    return;
  }

  if (swipeMode.enabled) {
    return;
  }

  if (recognition) {
    // Ensure any previous recognition is fully stopped
    try {
      recognition.abort(); // Use abort instead of stop for cleaner shutdown
    } catch (e) {}
    isListening = false;
    
    // Wait for recognition to fully stop before restarting
    setTimeout(() => {
      if (!isFlashcardGameActive) return; // Check if game was exited during delay
      
      const startRecognition = () => {
        try {
          recognition.start();
          isListening = true;
          document.getElementById('listeningIndicator').style.display = 'block';
          document.getElementById('startGameBtn').textContent = ' Pause';
          document.getElementById('startGameBtn').onclick = pauseFlashcardRound;
          startWordTimer();
          console.log('Recognition started successfully');
        } catch (e) {
          console.error('Failed to start recognition:', e);
          // Try again after a longer delay
          setTimeout(() => {
            if (!isFlashcardGameActive) return;
            try {
              recognition.start();
              isListening = true;
              document.getElementById('listeningIndicator').style.display = 'block';
              document.getElementById('startGameBtn').textContent = ' Pause';
              document.getElementById('startGameBtn').onclick = pauseFlashcardRound;
              startWordTimer();
              console.log('Recognition started on retry');
            } catch (e2) {
              console.error('Recognition failed to start after retry:', e2);
              // Final fallback - let user manually start
              document.getElementById('startGameBtn').textContent = ' Start Speaking';
              document.getElementById('startGameBtn').onclick = resumeFlashcardRound;
              // Still start the timer so game can continue
              startWordTimer();
            }
          }, 500);
        }
      };
      
      startRecognition();
    }, 300); // Increased delay for cleaner restart
  }
}

function pauseFlashcardRound() {
  clearInterval(flashcardTimer);
  clearTimeout(flashcardTimerTimeout);
  
  // Stop speech synthesis if speaking
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
  }
  
  // Stop speech recognition
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {}
  }
  isListening = false;
  
  document.getElementById('listeningIndicator').style.display = 'none';
  document.getElementById('startGameBtn').textContent = ' Resume';
  document.getElementById('startGameBtn').onclick = resumeFlashcardRound;
}

function resumeFlashcardRound() {
  if (isFlashcardGameActive) {
    // Restart speech recognition
    if (recognition) {
      try {
        recognition.start();
      } catch (e) {}
    }
    isListening = true;
    
    document.getElementById('listeningIndicator').style.display = 'block';
    document.getElementById('startGameBtn').textContent = ' Pause';
    document.getElementById('startGameBtn').onclick = pauseFlashcardRound;
    startWordTimer();
  }
}

function startWordTimer() {
  // Use 15 seconds as default if not set
  const timerDuration = currentFlashcardSet.timerSeconds || 15;
  
  clearInterval(flashcardTimer);
  clearTimeout(flashcardTimerTimeout);
  
  // Always speak the English word in voice mode (not swipe mode)
  if (!swipeMode.enabled && currentWordIndex < currentGameWords.length) {
    // Speak first, then start timer after a delay
    speakEnglish(currentGameWords[currentWordIndex].english);
    
    // Wait 1.5 seconds after speaking starts before beginning countdown
    // This gives time for the TTS to finish
    flashcardTimerTimeout = setTimeout(() => {
      // Check if game was paused during the delay
      if (!isListening || !isFlashcardGameActive) return;
      
      timeRemaining = timerDuration;
      document.getElementById('wordTimer').textContent = timeRemaining;
      
      flashcardTimer = setInterval(() => {
        timeRemaining--;
        document.getElementById('wordTimer').textContent = timeRemaining;

        if (timeRemaining <= 0) {
          playWalkAwaySound('timeup');
          wordIncorrect(currentWordIndex);
        }
      }, 1000);
    }, 1500); // 1.5 second delay to allow TTS to finish
  } else {
    // Swipe mode - no TTS, start timer immediately
    timeRemaining = timerDuration;
    document.getElementById('wordTimer').textContent = timeRemaining;
    
    flashcardTimer = setInterval(() => {
      timeRemaining--;
      document.getElementById('wordTimer').textContent = timeRemaining;

      if (timeRemaining <= 0) {
        playWalkAwaySound('timeup');
        wordIncorrect(currentWordIndex);
      }
    }, 1000);
  }
}

function wordCorrect(index) {
  clearInterval(flashcardTimer);


  playWalkAwaySound('correct');

  awardCoinsWithPopup(5);

  correctStreakInSet++;
  currentSetCorrectCount++;
  totalGameCorrect++;
  totalGameWords++;

  const correctWord = currentGameWords[index];
  missedWords = missedWords.filter(w => !(w.english === correctWord.english && w.korean === correctWord.korean));

  addToMasteryDeck(correctWord, currentFlashcardSet.id, currentFlashcardSet.title);

  document.getElementById(`status-${index}`).innerHTML = '';
  const wordItem = document.getElementById(`word-${index}`);
  wordItem.classList.add('correct-animation');
  const wordText = wordItem.querySelector('.word-text');
  wordText.innerHTML = `<span style="text-decoration: line-through; color: #718096;">${currentGameWords[index].english}</span>  <span style="color: #48bb78; font-weight: bold;">${currentGameWords[index].korean}</span>`;

  speakKorean(currentGameWords[index].korean);

  const streakIndicator = document.getElementById('streakIndicator');
  const streakNumber = document.getElementById('streakNumber');
  if (streakIndicator) {
    streakIndicator.classList.remove('hidden');
    streakNumber.textContent = correctStreakInSet;
  }

  if (currentGameAssets) {

    if (currentSetCorrectCount <= 4 && currentGameAssets.progressImage) {
      showPopupImage(
        currentGameAssets.progressImage,
        currentGameAssets.progressSounds[currentSetCorrectCount - 1] || null,
        500
      );
    }
  } else {
  }

  gameResults.push({ word: currentGameWords[index], correct: true });

  currentWordIndex++;
  if (currentWordIndex < currentGameWords.length) {
    highlightCurrentWord();
    document.getElementById('recognizedText').textContent = '';
    setTimeout(() => startWordTimer(), 1500);
  } else {
    showRoundResults();
  }
}

function wordIncorrect(index) {
  clearInterval(flashcardTimer);

  totalGameWords++;

  correctStreakInSet = 0;
  const streakIndicator = document.getElementById('streakIndicator');
  if (streakIndicator) {
    streakIndicator.classList.add('hidden');
  }

  document.getElementById(`status-${index}`).innerHTML = '';
  const wordItem = document.getElementById(`word-${index}`);
  wordItem.classList.add('incorrect-animation');
  const wordText = wordItem.querySelector('.word-text');
  wordText.innerHTML = `<span style="text-decoration: line-through; color: #718096;">${currentGameWords[index].english}</span>  <span style="color: #f56565;">${currentGameWords[index].korean}</span>`;

  speakKorean(currentGameWords[index].korean);

  if (currentGameAssets && currentGameAssets.timeoutImage) {
    showPopupImage(
      currentGameAssets.timeoutImage,
      currentGameAssets.timeoutSound,
      500
    );
  }

  gameResults.push({ word: currentGameWords[index], correct: false });

  const missedWord = currentGameWords[index];
  const alreadyMissed = missedWords.some(w => w.english === missedWord.english && w.korean === missedWord.korean);
  if (!alreadyMissed) {
    missedWords.push(missedWord);
  }

  if (currentFlashcardSet && currentFlashcardSet.id) {
    addCardToLeitnerBoxWithDupeCheck(currentGameWords[index], currentFlashcardSet.id).then(wasAdded => {
      if (wasAdded) {
        newWordsAddedToLeitner++;
      }
    });
  }

  currentWordIndex++;
  if (currentWordIndex < currentGameWords.length) {
    highlightCurrentWord();
    document.getElementById('recognizedText').textContent = '';
    setTimeout(() => startWordTimer(), 1500);
  } else {


    showRoundResults();
  }
}

function setupFlashcardGameControls() {
  const voiceControls = document.getElementById('voiceControls');
  const swipeControls = document.getElementById('swipeControls');
  const voiceStatus = document.getElementById('voiceStatus');
  const wordTimer = document.getElementById('wordTimer')?.parentElement;

  if (swipeMode.enabled) {
    if (voiceControls) voiceControls.style.display = 'none';
    if (swipeControls) swipeControls.style.display = 'block';
    if (voiceStatus) voiceStatus.style.display = 'none';
    if (wordTimer) wordTimer.style.display = 'none';
  } else {
    if (voiceControls) voiceControls.style.display = 'flex';
    if (swipeControls) swipeControls.style.display = 'none';
    if (voiceStatus) voiceStatus.style.display = 'block';
    if (wordTimer) wordTimer.style.display = 'block';
  }
}

function revealSwipeAnswer() {
  if (currentWordIndex >= currentGameWords.length) {
    showRoundResults();
    return;
  }

  const currentWord = currentGameWords[currentWordIndex];
  const swipeAnswerSection = document.getElementById('swipeAnswerSection');
  const swipeTapPrompt = document.getElementById('swipeTapPrompt');
  const swipeKoreanAnswer = document.getElementById('swipeKoreanAnswer');

  if (swipeKoreanAnswer) swipeKoreanAnswer.textContent = currentWord.korean;
  if (swipeAnswerSection) swipeAnswerSection.style.display = 'block';
  if (swipeTapPrompt) swipeTapPrompt.style.display = 'none';
}

function swipeFlashcardAnswer(isCorrect) {
  const swipeAnswerSection = document.getElementById('swipeAnswerSection');
  const swipeTapPrompt = document.getElementById('swipeTapPrompt');

  if (isCorrect) {
    wordCorrect(currentWordIndex);
  } else {
    wordIncorrect(currentWordIndex);
  }

  if (swipeAnswerSection) swipeAnswerSection.style.display = 'none';
  if (swipeTapPrompt) swipeTapPrompt.style.display = 'block';
}

function skipWord() {
  if (currentWordIndex < currentGameWords.length && isListening) {
    playWalkAwaySound('wrong');
    wordIncorrect(currentWordIndex);
  }
}

function showRoundResults() {
  clearInterval(flashcardTimer);
  clearInterval(autoAdvanceTimer); // Clear any existing auto-advance timer
  
  // Stop recognition properly before transitioning
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {}
  }
  isListening = false;
  
  document.getElementById('listeningIndicator').style.display = 'none';

  const correct = gameResults.filter(r => r.correct).length;
  const total = gameResults.length;
  const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;

  const totalSets = Math.ceil(currentFlashcardSet.wordPairs.length / 5);
  const allOriginalWordsDone = currentSetIndex >= totalSets - 1;
  const isGameComplete = allOriginalWordsDone && missedWords.length === 0;

  if (isGameComplete) {
    document.getElementById('gameResults').style.display = 'block';
    const finalPercentage = totalGameWords > 0 ? Math.round((totalGameCorrect / totalGameWords) * 100) : 0;

    let endGifHtml = '';
    if (currentGameAssets && currentGameAssets.endGifs) {
      let gifIndex;
      if (finalPercentage <= 50) gifIndex = 0;
      else if (finalPercentage <= 65) gifIndex = 1;
      else if (finalPercentage <= 75) gifIndex = 2;
      else if (finalPercentage <= 85) gifIndex = 3;
      else if (finalPercentage <= 99) gifIndex = 4;
      else gifIndex = 5;

      const gifData = currentGameAssets.endGifs[gifIndex];
      if (gifData) {
        endGifHtml = `<img src="${gifData}" style="max-width: 150px; max-height: 150px; border-radius: 12px; margin: 15px auto; display: block;">`;
      }

      if (currentGameAssets.endSounds && currentGameAssets.endSounds[gifIndex]) {
        playSound(currentGameAssets.endSounds[gifIndex]);
      }
    }

    document.getElementById('resultsDetails').innerHTML = `
      <h3 style="text-align: center; color: #2d3748; margin-bottom: 10px; font-size: 16px;"> All Words Mastered!</h3>
      <div style="text-align: center; font-size: 14px; margin-bottom: 10px;">
        <span style="color: #48bb78;">Correct: ${totalGameCorrect}</span> |
        <span style="color: #f56565;">Incorrect: ${totalGameWords - totalGameCorrect}</span>
      </div>
      <div style="text-align: center; font-size: 36px; font-weight: bold; color: ${finalPercentage >= 80 ? '#48bb78' : finalPercentage >= 60 ? '#ed8936' : '#f56565'};">
        ${finalPercentage}%
      </div>
      ${endGifHtml}
      ${newWordsAddedToLeitner > 0 ? `
        <div onclick="exitFlashcardGame(); switchTab('leitnerBoxes');" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 320px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 28px;"></div>
            <div style="text-align: left;">
              <div style="font-weight: 700; color: #92400e; font-size: 14px;">You have ${newWordsAddedToLeitner} new word${newWordsAddedToLeitner > 1 ? 's' : ''} added to your calendar!</div>
              <div style="color: #b45309; font-size: 12px; margin-top: 3px;">Tap here to review these words </div>
            </div>
          </div>
        </div>
      ` : ''}
      ${walkAwayMode.enabled ? `
        <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 10px; border-radius: 10px; margin: 10px auto; max-width: 300px;">
          <p style="color: #6b46c1; font-size: 12px; margin: 0;">
             <strong>Listening...</strong> Say "Yes" to play again
          </p>
        </div>
      ` : ''}
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn btn-secondary" onclick="exitFlashcardGame()" style="padding: 10px 20px; font-size: 13px;">Back</button>
        <button class="btn" onclick="restartGame()" style="padding: 10px 20px; margin-left: 8px; font-size: 13px;">Play Again</button>
      </div>
    `;

    document.getElementById('autoAdvanceContainer').style.display = 'none';

    if (walkAwayMode.enabled) {
      setTimeout(() => {
        startFlashcardPlayAgainContinuation(
          () => { restartGame(); },
          () => {
            const statusEl = document.getElementById('handsFreeContinueStatus');
            if (statusEl) {
              statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                Game complete! Click a button to continue.
              </p>`;
            }
          }
        );
      }, 2000); // Wait for end GIF/sound to play
    }
  } else {
    document.getElementById('gameResults').style.display = 'none';

    setTimeout(() => {
      nextFlashcardSet();
    }, 1500); // 1.5 second delay for any sounds to finish
  }

  document.getElementById('startGameBtn').textContent = ' Start Speaking';
  document.getElementById('startGameBtn').onclick = startFlashcardRound;
}

/**
 * Hands-free continuation for standalone flashcard game
 */
function startFlashcardHandsFreeContinuation() {
  const countdownEl = document.getElementById('autoAdvanceCountdown');
  if (countdownEl) {
    countdownEl.innerHTML = `
      <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px;">
        <p style="color: #6b46c1; font-size: 14px; margin: 0;">
           <strong>Playing prompt...</strong>
        </p>
      </div>
    `;
  }

  setTimeout(() => {
    startHandsFreeContinuation(
      () => {
        nextFlashcardSet();
      },
      () => {
        if (countdownEl) {
          countdownEl.innerHTML = `<p style="color: #718096; font-size: 14px;">Click "Next Set" to continue or exit the game.</p>`;
        }
      }
    );
  }, 500);
}

/**
 * Hands-free "Play Again?" continuation for flashcard game completion
 * Uses playAgain audio instead of continue audio
 */
function startFlashcardPlayAgainContinuation(onYes, onNo) {
  if (!walkAwayMode.enabled) {
    return;
  }


  const statusEl = document.getElementById('handsFreeContinueStatus');
  if (statusEl) {
    statusEl.innerHTML = `<p style="color: #6b46c1; font-size: 14px; margin: 0;">
       <strong>Playing prompt...</strong>
    </p>`;
  }

  if (walkAwayMode.audioElements.playAgain) {
    const audio = walkAwayMode.audioElements.playAgain;
    audio.currentTime = 0;

    audio.onended = () => {
      updateContinuationStatusToListening();
      startContinuationListening(onYes, onNo);
    };

    audio.play().then(() => {
    }).catch(e => {
      speakPlayAgainPrompt(onYes, onNo);
    });

    setTimeout(() => {
      if (!walkAwayMode.continuation.isListening) {
        updateContinuationStatusToListening();
        startContinuationListening(onYes, onNo);
      }
    }, 5000);
  } else {
    speakPlayAgainPrompt(onYes, onNo);
  }
}

/**
 * Speak the play again prompt using TTS
 */
function speakPlayAgainPrompt(onYes, onNo) {
  speakText('Do you want to play again?', () => {
    updateContinuationStatusToListening();
    startContinuationListening(onYes, onNo);
  });
}

let autoAdvanceTimer = null;
let autoAdvanceSeconds = 3;

function startAutoAdvanceCountdown() {
  autoAdvanceSeconds = 3;
  updateAutoAdvanceDisplay();

  autoAdvanceTimer = setInterval(() => {
    autoAdvanceSeconds--;
    updateAutoAdvanceDisplay();

    if (autoAdvanceSeconds <= 0) {
      clearInterval(autoAdvanceTimer);
      nextFlashcardSet();
    }
  }, 1000);
}

function updateAutoAdvanceDisplay() {
  const countdownEl = document.getElementById('autoAdvanceCountdown');
  if (countdownEl) {
    countdownEl.innerHTML = ` Next set starting in <strong>${autoAdvanceSeconds}</strong> second${autoAdvanceSeconds !== 1 ? 's' : ''}...`;
  }
}

function skipToNextSet() {
  clearInterval(autoAdvanceTimer);
  nextFlashcardSet();
}

function restartGame() {
  clearInterval(autoAdvanceTimer);

  const existingGif = document.querySelector('.end-game-gif');
  if (existingGif) {
    existingGif.remove();
  }

  currentSetIndex = 0;
  gameResults = [];
  missedWords = []; // Reset missed words for fresh start
  correctStreakInSet = 0;
  currentSetCorrectCount = 0;
  totalGameCorrect = 0;
  totalGameWords = 0;

  if (currentGameAssets && currentGameAssets.startImage) {
    showPopupImage(
      currentGameAssets.startImage,
      currentGameAssets.startSound,
      500,
      'game-start'
    );
  }

  loadFlashcardRound();
  setTimeout(() => {
    startFlashcardRound();
  }, 600);
}

function nextFlashcardSet() {
  currentSetIndex++;
  gameResults = [];

  const allOriginalWordsDone = currentSetIndex * 5 >= currentFlashcardSet.wordPairs.length;

  if (allOriginalWordsDone && missedWords.length === 0) {
    showFinalResults();
  } else if (allOriginalWordsDone && missedWords.length > 0) {
    currentSetIndex--; // Stay at same set since we're just reviewing
    loadFlashcardRound();
    setTimeout(() => {
      startFlashcardRound();
    }, 500);
  } else {
    loadFlashcardRound();
    setTimeout(() => {
      startFlashcardRound();
    }, 500);
  }
}

function showFinalResults() {
  const finalPercentage = Math.round((totalGameCorrect / totalGameWords) * 100);

  let endGifHtml = '';
  if (currentGameAssets && currentGameAssets.endGifs) {
    let gifIndex;
    if (finalPercentage <= 50) gifIndex = 0;
    else if (finalPercentage <= 65) gifIndex = 1;
    else if (finalPercentage <= 75) gifIndex = 2;
    else if (finalPercentage <= 85) gifIndex = 3;
    else if (finalPercentage <= 99) gifIndex = 4;
    else gifIndex = 5;

    const gifData = currentGameAssets.endGifs[gifIndex];
    if (gifData) {
      endGifHtml = `<img src="${gifData}" style="max-width: 150px; max-height: 150px; border-radius: 12px; margin: 15px auto; display: block;">`;
    }

    if (currentGameAssets.endSounds && currentGameAssets.endSounds[gifIndex]) {
      playSound(currentGameAssets.endSounds[gifIndex]);
    }
  }

  document.getElementById('gameResults').style.display = 'block';
  document.getElementById('resultsDetails').innerHTML = `
    <h3 style="text-align: center; color: #2d3748; margin-bottom: 10px; font-size: 16px;"> All Words Mastered!</h3>
    <div style="text-align: center; font-size: 14px; margin-bottom: 10px;">
      <span style="color: #48bb78;">Correct: ${totalGameCorrect}</span> |
      <span style="color: #f56565;">Incorrect: ${totalGameWords - totalGameCorrect}</span>
    </div>
    <div style="text-align: center; font-size: 36px; font-weight: bold; color: ${finalPercentage >= 80 ? '#48bb78' : finalPercentage >= 60 ? '#ed8936' : '#f56565'};">
      ${finalPercentage}%
    </div>
    ${endGifHtml}
    <div style="text-align: center; margin-top: 15px;">
      <button class="btn btn-secondary" onclick="exitFlashcardGame()" style="padding: 10px 20px; font-size: 13px;">Back</button>
      <button class="btn" onclick="restartGame()" style="padding: 10px 20px; margin-left: 8px; font-size: 13px;">Play Again</button>
    </div>
  `;

  document.getElementById('autoAdvanceContainer').style.display = 'none';
}

function exitFlashcardGame() {
  try {
    isFlashcardGameActive = false;
    isListening = false;
    
    // Reset session disclaimer flag
    window.flashcardSessionDisclaimerShown = false;

    releaseWakeLock();

    const interruptedOverlay = document.getElementById('gameInterruptedOverlay');
    if (interruptedOverlay) {
      interruptedOverlay.remove();
    }

    clearInterval(autoAdvanceTimer);

    const existingGif = document.querySelector('.end-game-gif');
    if (existingGif) {
      existingGif.remove();
    }

    const streakIndicator = document.getElementById('streakIndicator');
    if (streakIndicator) {
      streakIndicator.classList.add('hidden');
    }

    if (recognition) {
      try {
        recognition.stop();
      } catch (e) {
      }
    }
    clearInterval(flashcardTimer);

    document.getElementById('junbiPage').style.display = 'none';

    document.getElementById('availableFlashcards').style.display = 'block';
    document.getElementById('flashcardGameInterface').style.display = 'none';

    currentFlashcardSet = null;
    currentGameAssets = null;
    currentGameWords = [];
    gameResults = [];
    missedWords = []; // Reset missed words
    correctStreakInSet = 0;
    currentSetCorrectCount = 0;
    totalGameCorrect = 0;
    totalGameWords = 0;

    if (currentUserRole === 'student') {
      loadAvailableFlashcards();
      updateMasteryBadge();
    }
  } catch (error) {
  }
}


let masteryDeckWords = [];
let currentMasteryWords = [];
let masteryWordIndex = 0;
let masteryTimer = null;
let masteryRecognition = null;
let isMasteryListening = false;
let masteryCorrectCount = 0;
let masteryTotalCount = 0;

/**
 * Add a word to the student's mastery deck
 */
async function addToMasteryDeck(word, flashcardSetId, flashcardSetTitle) {
  if (!currentUser) return;

  try {
    const existingQuery = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .where('english', '==', word.english)
      .where('korean', '==', word.korean)
      .get();

    if (!existingQuery.empty) {
      const docId = existingQuery.docs[0].id;
      await db.collection('masteryDeck').doc(docId).update({
        lastPracticed: firebase.firestore.FieldValue.serverTimestamp(),
        practiceCount: firebase.firestore.FieldValue.increment(1)
      });
    } else {
      await db.collection('masteryDeck').add({
        studentId: currentUser.uid,
        english: word.english,
        korean: word.korean,
        audioUrl: word.audioUrl || null,
        imageUrl: word.imageUrl || null,
        flashcardSetId: flashcardSetId,
        flashcardSetTitle: flashcardSetTitle,
        aiData: word.aiData || null, // Include AI data for part of speech
        partOfSpeech: word.partOfSpeech || null,
        isExpression: word.isExpression || isMultiWordExpression(word),
        addedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastPracticed: firebase.firestore.FieldValue.serverTimestamp(),
        practiceCount: 1
      });
    }

    updateMasteryBadge();
  } catch (error) {
  }
}

/**
 * Remove a word from mastery deck and add to Leitner Day 1
 */
async function removeFromMasteryDeck(word, docId) {
  if (!currentUser) return;

  try {
    await db.collection('masteryDeck').doc(docId).delete();

    await addCardToLeitnerBox(word, word.flashcardSetId || 'mastery');

    updateMasteryBadge();
    updateLeitnerDueBadge();
  } catch (error) {
  }
}

/**
 * Update the mastery deck badge count
 */
async function updateMasteryBadge() {
  if (!currentUser) return;

  try {
    const snapshot = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .get();

    const count = snapshot.size;
    const badge = document.getElementById('masteryDeckBadge2');

    if (badge) {
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
  } catch (error) {
  }
}

/**
 * Backfill aiData for mastery deck words that don't have it
 * Looks up the original flashcard set and copies aiData
 */
async function backfillMasteryDeckAiData(words) {
  const wordsNeedingBackfill = words.filter(word =>
    !word.aiData && word.flashcardSetId && !word.flashcardSetId.startsWith('mycards_')
  );

  if (wordsNeedingBackfill.length === 0) {
    return;
  }


  const wordsBySetId = {};
  wordsNeedingBackfill.forEach(word => {
    if (!wordsBySetId[word.flashcardSetId]) {
      wordsBySetId[word.flashcardSetId] = [];
    }
    wordsBySetId[word.flashcardSetId].push(word);
  });

  console.log('Backfill: Grouped into', Object.keys(wordsBySetId).length, 'flashcard sets');

  let backfilledCount = 0;
  for (const setId of Object.keys(wordsBySetId)) {
    try {
      const setDoc = await db.collection('flashcards').doc(setId).get();

      if (!setDoc.exists) {
        continue;
      }

      const setData = setDoc.data();
      const wordPairs = setData.wordPairs || [];

      const pairsWithAiData = wordPairs.filter(wp => wp.aiData);

      for (const masteryWord of wordsBySetId[setId]) {
        const matchingPair = wordPairs.find(wp =>
          wp.korean === masteryWord.korean ||
          wp.korean?.toLowerCase() === masteryWord.korean?.toLowerCase()
        );

        if (matchingPair) {

          if (matchingPair.aiData) {
            masteryWord.aiData = matchingPair.aiData;
            backfilledCount++;

            try {
              await db.collection('masteryDeck').doc(masteryWord.id).update({
                aiData: matchingPair.aiData
              });
            } catch (e) {
            }
          }
        } else {
        }
      }
    } catch (error) {
    }
  }

}

/**
 * Load and render the mastery deck
 */
async function loadMasteryDeck() {
  if (!currentUser) return;

  const container = document.getElementById('masteryDeckContainer');
  container.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .get();

    masteryDeckWords = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    masteryDeckWords.sort((a, b) => {
      const aTime = a.addedAt?.toMillis?.() || 0;
      const bTime = b.addedAt?.toMillis?.() || 0;
      return bTime - aTime;
    });

    if (masteryDeckWords.length === 0) {
      container.innerHTML = `
        <div class="mastery-empty-state">
          <div class="icon"></div>
          <h4>No Mastered Words Yet!</h4>
          <p>Play Flashcard Games and answer correctly to add words to your Mastery Deck.</p>
          <button class="btn" onclick="switchTab('flashcardGames')" style="margin-top: 15px;">
             Play Flashcard Games
          </button>
        </div>
      `;
      return;
    }

    await backfillMasteryDeckAiData(masteryDeckWords);

    const posFolders = {
      nouns: { name: 'Nouns', icon: '', words: [], className: 'nouns' },
      actionVerbs: { name: 'Action Verbs', icon: '', words: [], className: 'action-verbs' },
      descriptiveVerbs: { name: 'Descriptive Verbs', icon: '', words: [], className: 'descriptive-verbs' },
      adjectives: { name: 'Adjectives', icon: '', words: [], className: 'adjectives' },
      adverbs: { name: 'Adverbs', icon: '', words: [], className: 'adverbs' },
      conjunctions: { name: 'Conjunctions', icon: '', words: [], className: 'conjunctions' },
      expressions: { name: 'Expressions', icon: '', words: [], className: 'expressions' },
      grammarPoints: { name: 'Grammar Points', icon: '', words: [], className: 'grammar-points' },
      other: { name: 'Other', icon: '', words: [], className: 'other' }
    };

    masteryDeckWords.forEach(word => {
      const pos = getWordPartOfSpeech(word);
      const isExpression = isMultiWordExpression(word);

      const isGrammarPoint = word.isGrammarPoint ||
        (pos && pos.toLowerCase().includes('grammar')) ||
        (word.korean && (word.korean.includes('~') || (word.korean.startsWith('-') && word.korean.length < 10)));

      if (isGrammarPoint) {
        posFolders.grammarPoints.words.push(word);
      } else if (isExpression) {
        posFolders.expressions.words.push(word);
      } else if (pos) {
        const posLower = pos.toLowerCase();
        if (posLower.includes('noun') || posLower === '') {
          posFolders.nouns.words.push(word);
        } else if (posLower.includes('action') && posLower.includes('verb')) {
          posFolders.actionVerbs.words.push(word);
        } else if (posLower.includes('descriptive') && posLower.includes('verb')) {
          posFolders.descriptiveVerbs.words.push(word);
        } else if (posLower.includes('verb') || posLower === '') {
          posFolders.actionVerbs.words.push(word);
        } else if (posLower.includes('adjective') || posLower === '') {
          posFolders.descriptiveVerbs.words.push(word);
        } else if (posLower.includes('adverb') || posLower === '') {
          posFolders.adverbs.words.push(word);
        } else if (posLower.includes('conjunction') || posLower.includes('particle') || posLower === '' || posLower === '') {
          posFolders.conjunctions.words.push(word);
        } else {
          posFolders.other.words.push(word);
        }
      } else {
        posFolders.other.words.push(word);
      }
    });

    window.masteryPosFolders = posFolders;

    let html = `
      <div class="mastery-deck-card">
        <div class="mastery-deck-header">
          <div class="mastery-deck-title">
            <span></span>
            <span>Mastery Deck</span>
          </div>
          <div class="mastery-count-badge">${masteryDeckWords.length} words</div>
        </div>

        <div class="mastery-word-preview">
          ${masteryDeckWords.slice(0, 10).map(w => `
            <span class="mastery-word-tag">${w.english}</span>
          `).join('')}
          ${masteryDeckWords.length > 10 ? `<span class="mastery-word-tag">+${masteryDeckWords.length - 10} more</span>` : ''}
        </div>

        <button class="mastery-practice-btn" onclick="startMasteryPractice()">
           Practice All (${masteryDeckWords.length} words)
        </button>
      </div>

      <h3 style="margin: 25px 0 15px 0; color: #2d3748; display: flex; align-items: center; gap: 10px;">
        <span></span> Browse by Part of Speech
      </h3>

      <div class="mastery-pos-grid" id="masteryPosGrid">
    `;

    Object.entries(posFolders).forEach(([key, folder]) => {
      const isEmpty = folder.words.length === 0;
      html += `
        <div class="mastery-pos-folder ${folder.className} ${isEmpty ? 'empty-folder' : ''}"
             onclick="${isEmpty ? '' : `showMasteryPosDetail('${key}')`}"
             style="${isEmpty ? 'opacity: 0.5; cursor: default;' : ''}">
          <div class="pos-icon">${folder.icon}</div>
          <div class="pos-name">${folder.name}</div>
          <div class="pos-count"><strong>${folder.words.length}</strong> words</div>
        </div>
      `;
    });

    html += `</div>`;

    html += `
      <div id="masteryPosDetailView" style="display: none;">
        <div class="mastery-pos-detail">
          <div class="mastery-pos-detail-header">
            <button class="back-btn" onclick="hideMasteryPosDetail()"></button>
            <span id="masteryPosDetailIcon" style="font-size: 24px;"></span>
            <span id="masteryPosDetailTitle" style="font-size: 18px; font-weight: 600;">Nouns</span>
            <span id="masteryPosDetailCount" style="color: #718096; margin-left: auto;">0 words</span>
          </div>
          <div class="mastery-pos-words-grid" id="masteryPosWordsGrid"></div>
          <button class="mastery-practice-btn" style="margin-top: 20px;" id="masteryPosPracticeBtn" onclick="startMasteryPosPractice()">
             Practice These Words
          </button>
        </div>
      </div>
    `;

    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `
      <div class="mastery-empty-state">
        <div class="icon"></div>
        <h4>Error Loading Mastery Deck</h4>
        <p>${error.message}</p>
      </div>
    `;
  }
}

/**
 * Get part of speech from word's AI data or infer from Korean text
 */
function getWordPartOfSpeech(word) {
  if (word.aiData && word.aiData.wordData && Array.isArray(word.aiData.wordData)) {
    const firstWord = word.aiData.wordData[0];
    if (firstWord && firstWord.partOfSpeech) {
      return firstWord.partOfSpeech;
    }
  }

  if (word.partOfSpeech) {
    return word.partOfSpeech;
  }

  const korean = (word.korean || '').trim();
  const english = (word.english || '').toLowerCase();

  if (korean.includes('~') || (korean.startsWith('-') && korean.length < 10) ||
      korean.includes('()') || korean.includes('/') || korean.includes('/')) {
    return 'grammar point';
  }

  const commonAdverbs = ['', '', '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '', '', ''];
  if (commonAdverbs.includes(korean)) {
    return 'adverb';
  }

  const commonConjunctions = ['', '', '', '', '', '', '',
    '', '', '', '', '', '', '', ''];
  if (commonConjunctions.includes(korean)) {
    return 'conjunction';
  }

  if (korean.endsWith('')) {
    const descriptiveRoots = ['', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', ''];

    for (const root of descriptiveRoots) {
      if (korean.includes(root)) {
        return 'descriptive verb';
      }
    }
    return 'action verb';
  }

  if (korean.endsWith('') || korean.endsWith('') || korean.endsWith('') ||
      korean.endsWith('') || korean.endsWith('') || korean.endsWith('') ||
      korean.endsWith('') || korean.endsWith('') || korean.endsWith('')) {
    return 'verb';
  }

  if (korean.endsWith('') || korean.endsWith('') || korean.endsWith('') && korean.length > 1) {
    if (!korean.endsWith('') && !korean.endsWith('')) {
      return 'adverb';
    }
  }

  if (english.startsWith('to ') || english.includes('(verb)')) {
    return 'verb';
  }
  if (english.includes('(noun)') || english.includes('(n.)')) {
    return 'noun';
  }
  if (english.includes('(adj)') || english.includes('(adjective)')) {
    return 'adjective';
  }
  if (english.includes('(adv)') || english.includes('(adverb)')) {
    return 'adverb';
  }

  if (!korean.includes(' ') && korean.length <= 6) {
    return 'noun';
  }

  return null;
}

/**
 * Check if word is a multi-word expression/phrase
 */
function isMultiWordExpression(word) {
  const korean = word.korean || '';
  const english = word.english || '';

  if (word.isExpression || word.isPhrase) return true;

  const koreanSpaces = (korean.match(/\s/g) || []).length;
  if (koreanSpaces >= 1) return true;

  return false;
}

/**
 * Show mastery POS detail view
 */
function showMasteryPosDetail(posKey) {
  const folder = window.masteryPosFolders[posKey];
  if (!folder) return;

  window.currentMasteryPosKey = posKey;

  document.getElementById('masteryPosGrid').style.display = 'none';
  const detailView = document.getElementById('masteryPosDetailView');
  if (detailView) detailView.style.display = 'block';

  document.getElementById('masteryPosDetailIcon').textContent = folder.icon;
  document.getElementById('masteryPosDetailTitle').textContent = folder.name;
  document.getElementById('masteryPosDetailCount').textContent = `${folder.words.length} words`;

  const wordsGrid = document.getElementById('masteryPosWordsGrid');
  wordsGrid.innerHTML = folder.words.map(word => `
    <div class="mastery-pos-word-card">
      <div class="word-korean">${word.korean}</div>
      <div class="word-english">${word.english}</div>
    </div>
  `).join('');

  const practiceBtn = document.getElementById('masteryPosPracticeBtn');
  if (practiceBtn) {
    practiceBtn.innerHTML = ` Practice ${folder.name} (${folder.words.length} words)`;
  }
}

/**
 * Hide mastery POS detail view
 */
function hideMasteryPosDetail() {
  document.getElementById('masteryPosGrid').style.display = 'grid';
  const detailView = document.getElementById('masteryPosDetailView');
  if (detailView) detailView.style.display = 'none';
}

/**
 * Start practice session for specific POS folder
 */
function startMasteryPosPractice() {
  const posKey = window.currentMasteryPosKey;
  const folder = window.masteryPosFolders[posKey];

  if (!folder || folder.words.length === 0) {
    alert('No words to practice!');
    return;
  }

  document.getElementById('masteryDeckContainer').style.display = 'none';
  document.getElementById('masteryPracticeInterface').style.display = 'block';

  currentMasteryWords = shuffleArray([...folder.words]).slice(0, 10);
  masteryWordIndex = 0;
  masteryCorrectCount = 0;
  masteryTotalCount = 0;

  initializeMasterySpeechRecognition();
  loadMasteryRound();
}

/**
 * Start mastery deck practice session
 */
function startMasteryPractice() {
  showSpeechDisclaimer(() => {
    _startMasteryPracticeInternal();
  });
}

function _startMasteryPracticeInternal() {
  if (masteryDeckWords.length === 0) {
    alert('No words in your mastery deck!');
    return;
  }

  document.getElementById('masteryDeckContainer').style.display = 'none';
  document.getElementById('masteryPracticeInterface').style.display = 'block';

  currentMasteryWords = shuffleArray([...masteryDeckWords]).slice(0, 10);
  masteryWordIndex = 0;
  masteryCorrectCount = 0;
  masteryTotalCount = 0;

  initializeMasterySpeechRecognition();

  loadMasteryRound();

  setTimeout(() => {
    startMasteryRound();
  }, 500);
}

function initializeMasterySpeechRecognition() {
  if (masteryRecognition) return;

  if ('webkitSpeechRecognition' in window) {
    masteryRecognition = new webkitSpeechRecognition();
  } else if ('SpeechRecognition' in window) {
    masteryRecognition = new SpeechRecognition();
  } else {
    alert('Speech recognition not supported');
    return;
  }

  masteryRecognition.lang = 'ko-KR';
  masteryRecognition.continuous = true;
  masteryRecognition.interimResults = true;

  let masteryIsProcessingMatch = false;

  masteryRecognition.onresult = (event) => {
    if (masteryIsProcessingMatch) return;

    const latestResultIndex = event.results.length - 1;
    const latestResult = event.results[latestResultIndex];
    const transcript = latestResult[0].transcript.trim();

    document.getElementById('masteryRecognizedText').textContent = transcript;

    if (!latestResult.isFinal) {
      return;
    }


    if (masteryWordIndex < currentMasteryWords.length) {
      const currentWord = currentMasteryWords[masteryWordIndex];

      const normalizedTranscript = normalizeKoreanForVoice(transcript);
      const koreanWord = normalizeKoreanForVoice(currentWord.korean);


      const similarity = calculateSimilarity(normalizedTranscript, koreanWord);

      if (similarity >= 0.90) {
        masteryIsProcessingMatch = true;
        masteryWordCorrect(masteryWordIndex);

        setTimeout(() => {
          masteryIsProcessingMatch = false;
        }, 500);
      }
    }
  };

  masteryRecognition.onerror = (event) => {
  };

  masteryRecognition.onend = () => {
    if (isMasteryListening && masteryWordIndex < currentMasteryWords.length) {
      setTimeout(() => {
        if (isMasteryListening) {
          try {
            masteryRecognition.start();
          } catch (e) {
          }
        }
      }, 300);
    }
  };
}

function loadMasteryRound() {
  const totalWords = currentMasteryWords.length;
  document.getElementById('masterySetNumber').textContent = `Word ${masteryWordIndex + 1} of ${totalWords}`;
  document.getElementById('masteryProgressBar').style.width = `${((masteryWordIndex + 1) / totalWords) * 100}%`;

  const startIdx = Math.floor(masteryWordIndex / 5) * 5;
  const endIdx = Math.min(startIdx + 5, currentMasteryWords.length);
  const wordsToShow = currentMasteryWords.slice(startIdx, endIdx);

  const wordsListDiv = document.getElementById('masteryWordsList');
  wordsListDiv.innerHTML = wordsToShow.map((word, idx) => {
    const actualIndex = startIdx + idx;
    const isCurrentWord = actualIndex === masteryWordIndex;
    const isCompleted = actualIndex < masteryWordIndex;

    return `
      <div class="word-item" id="mastery-word-${actualIndex}" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: ${isCurrentWord ? 'linear-gradient(135deg, #fef3c710 0%, #fcd34d20 100%)' : isCompleted ? '#f0fdf4' : 'white'}; border-radius: 10px; border: 2px solid ${isCurrentWord ? '#fcd34d' : isCompleted ? '#86efac' : '#e2e8f0'}; margin-bottom: 10px; transform: ${isCurrentWord ? 'scale(1.02)' : 'scale(1)'}; transition: all 0.3s;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-weight: bold; color: #f59e0b;">${actualIndex + 1}.</span>
          <span style="font-size: 24px; font-weight: 600;">${word.english}</span>
        </div>
        <div id="mastery-status-${actualIndex}" style="font-size: 24px;">${isCompleted ? '' : ''}</div>
      </div>
    `;
  }).join('');

  // Reset scroll to top so word #1 is always visible
  wordsListDiv.scrollTop = 0;

  document.getElementById('masteryResults').style.display = 'none';
  document.getElementById('masteryRecognizedText').textContent = '-';
  document.getElementById('masteryWordTimer').textContent = '7';
}

function startMasteryRound() {
  if (masteryWordIndex >= currentMasteryWords.length) {
    showMasteryResults();
    return;
  }

  if (masteryRecognition) {
    masteryRecognition.start();
    isMasteryListening = true;
    document.getElementById('masteryListeningIndicator').style.display = 'block';
    document.getElementById('masteryStartBtn').textContent = ' Pause';
    document.getElementById('masteryStartBtn').onclick = pauseMasteryRound;
    startMasteryTimer();
  }
}

function pauseMasteryRound() {
  if (masteryRecognition && isMasteryListening) {
    masteryRecognition.stop();
    isMasteryListening = false;
    clearInterval(masteryTimer);
    document.getElementById('masteryListeningIndicator').style.display = 'none';
    document.getElementById('masteryStartBtn').textContent = ' Resume';
    document.getElementById('masteryStartBtn').onclick = startMasteryRound;
  }
}

function startMasteryTimer() {
  let timeLeft = 7;
  document.getElementById('masteryWordTimer').textContent = timeLeft;

  masteryTimer = setInterval(() => {
    timeLeft--;
    document.getElementById('masteryWordTimer').textContent = timeLeft;

    if (timeLeft <= 0) {
      clearInterval(masteryTimer);
      masteryWordIncorrect(masteryWordIndex);
    }
  }, 1000);
}

function masteryWordCorrect(index) {
  clearInterval(masteryTimer);
  masteryCorrectCount++;
  masteryTotalCount++;

  document.getElementById(`mastery-status-${index}`).innerHTML = '';
  const wordItem = document.getElementById(`mastery-word-${index}`);
  if (wordItem) {
    wordItem.style.background = '#f0fdf4';
    wordItem.style.borderColor = '#86efac';
  }

  speakKorean(currentMasteryWords[index].korean);


  masteryWordIndex++;

  if (masteryWordIndex < currentMasteryWords.length) {
    if (masteryWordIndex % 5 === 0) {
      loadMasteryRound();
    } else {
      highlightCurrentMasteryWord();
    }
    document.getElementById('masteryRecognizedText').textContent = '-';
    startMasteryTimer();
  } else {
    if (masteryRecognition && isMasteryListening) {
      masteryRecognition.stop();
      isMasteryListening = false;
    }
    showMasteryResults();
  }
}

function masteryWordIncorrect(index) {
  clearInterval(masteryTimer);
  masteryTotalCount++;

  const word = currentMasteryWords[index];

  document.getElementById(`mastery-status-${index}`).innerHTML = '';
  const wordItem = document.getElementById(`mastery-word-${index}`);
  if (wordItem) {
    wordItem.style.background = '#fef2f2';
    wordItem.style.borderColor = '#fca5a5';
    wordItem.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <span style="font-weight: bold; color: #f59e0b;">${index + 1}.</span>
        <span style="font-size: 24px;"><span style="text-decoration: line-through; color: #718096;">${word.english}</span>  <span style="color: #f56565; font-weight: bold;">${word.korean}</span></span>
      </div>
      <div id="mastery-status-${index}" style="font-size: 24px;"></div>
    `;
  }

  speakKorean(word.korean);

  removeFromMasteryDeck(word, word.id);

  masteryWordIndex++;

  if (masteryWordIndex < currentMasteryWords.length) {
    if (masteryWordIndex % 5 === 0) {
      loadMasteryRound();
    } else {
      highlightCurrentMasteryWord();
    }
    document.getElementById('masteryRecognizedText').textContent = '-';
    startMasteryTimer();
  } else {
    if (masteryRecognition && isMasteryListening) {
      masteryRecognition.stop();
      isMasteryListening = false;
    }
    showMasteryResults();
  }
}

function highlightCurrentMasteryWord() {
  document.getElementById('masterySetNumber').textContent = `Word ${masteryWordIndex + 1} of ${currentMasteryWords.length}`;
  document.getElementById('masteryProgressBar').style.width = `${((masteryWordIndex + 1) / currentMasteryWords.length) * 100}%`;

  const startIdx = Math.floor(masteryWordIndex / 5) * 5;
  const endIdx = Math.min(startIdx + 5, currentMasteryWords.length);

  for (let i = startIdx; i < endIdx; i++) {
    const wordItem = document.getElementById(`mastery-word-${i}`);
    if (!wordItem) continue;

    if (i === masteryWordIndex) {
      wordItem.style.background = 'linear-gradient(135deg, #fef3c710 0%, #fcd34d20 100%)';
      wordItem.style.borderColor = '#fcd34d';
      wordItem.style.transform = 'scale(1.02)';
    } else if (i < masteryWordIndex) {
    } else {
      wordItem.style.background = 'white';
      wordItem.style.borderColor = '#e2e8f0';
      wordItem.style.transform = 'scale(1)';
    }
  }
}

function showMasteryResults() {
  document.getElementById('masteryListeningIndicator').style.display = 'none';
  document.getElementById('masteryResults').style.display = 'block';

  const percentage = masteryTotalCount > 0 ? Math.round((masteryCorrectCount / masteryTotalCount) * 100) : 0;
  const incorrectCount = masteryTotalCount - masteryCorrectCount;

  document.getElementById('masteryResultsDetails').innerHTML = `
    <div style="text-align: center; font-size: 24px; margin-bottom: 20px;">
      <span style="color: #48bb78;">Correct: ${masteryCorrectCount}</span> |
      <span style="color: #f56565;">Incorrect: ${incorrectCount}</span>
    </div>
    <div style="text-align: center; font-size: 48px; font-weight: bold; color: ${percentage >= 80 ? '#48bb78' : percentage >= 60 ? '#ed8936' : '#f56565'};">
      ${percentage}%
    </div>
    ${incorrectCount > 0 ? `
      <p style="text-align: center; color: #f56565; margin-top: 15px;">
         ${incorrectCount} word${incorrectCount > 1 ? 's' : ''} moved to Leitner Day 1 for review
      </p>
    ` : `
      <p style="text-align: center; color: #48bb78; margin-top: 15px;">
         Perfect! All words still mastered!
      </p>
    `}
    <div style="text-align: center; margin-top: 25px;">
      <button class="btn btn-secondary" onclick="exitMasteryPractice()" style="padding: 12px 30px;">Back to Mastery Deck</button>
      ${masteryDeckWords.length > masteryTotalCount ? `
        <button class="btn" onclick="startMasteryPractice()" style="padding: 12px 30px; margin-left: 10px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Practice More</button>
      ` : ''}
    </div>
  `;

  document.getElementById('masteryStartBtn').textContent = ' Start Speaking';
  document.getElementById('masteryStartBtn').onclick = startMasteryRound;
}

function exitMasteryPractice() {
  clearInterval(masteryTimer);

  if (masteryRecognition && isMasteryListening) {
    masteryRecognition.stop();
    isMasteryListening = false;
  }

  document.getElementById('masteryPracticeInterface').style.display = 'none';
  document.getElementById('masteryDeckContainer').style.display = 'block';

  loadMasteryDeck();
}


/**
 * Load all Leitner data for the current student
 */
async function loadLeitnerData() {
  if (!currentUser) return;

  try {
    const snapshot = await db.collection('leitnerProgress')
      .where('studentId', '==', currentUser.uid)
      .get();

    leitnerCards = [];
    snapshot.forEach(doc => {
      leitnerCards.push({ id: doc.id, ...doc.data() });
    });

    calculateLeitnerDueCards();

    await loadLeitnerStats();

    updateLeitnerDueBadge();

  } catch (error) {
  }
}

/**
 * Load student's aggregate Leitner stats
 */
async function loadLeitnerStats() {
  try {
    const doc = await db.collection('leitnerStats').doc(currentUser.uid).get();

    if (doc.exists) {
      studentLeitnerStats = doc.data();
      const now = new Date();
      const lastWeekReset = studentLeitnerStats.lastWeeklyReset ? new Date(studentLeitnerStats.lastWeeklyReset) : null;
      if (!lastWeekReset || isNewWeek(lastWeekReset, now)) {
        studentLeitnerStats.weeklyLapses = 0;
        studentLeitnerStats.lastWeeklyReset = getWeekStart(now).toISOString();
        await db.collection('leitnerStats').doc(currentUser.uid).update({
          weeklyLapses: 0,
          lastWeeklyReset: studentLeitnerStats.lastWeeklyReset
        });
      }
    } else {
      const now = new Date();
      studentLeitnerStats = {
        studentId: currentUser.uid,
        totalCardsLearning: 0,
        totalMastered: 0,
        totalReviews: 0,
        totalCorrect: 0,
        totalLapses: 0,
        weeklyLapses: 0,
        lastWeeklyReset: getWeekStart(now).toISOString(),
        currentStreak: 0,
        longestStreak: 0,
        lastStudyDate: null,
        studyLog: {}
      };
      await db.collection('leitnerStats').doc(currentUser.uid).set(studentLeitnerStats);
    }
  } catch (error) {
  }
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  d.setHours(0, 0, 0, 0);
  return d;
}

function isNewWeek(oldDate, newDate) {
  const oldWeekStart = getWeekStart(oldDate);
  const newWeekStart = getWeekStart(newDate);
  return newWeekStart > oldWeekStart;
}

/**
 * Calculate which cards are due for review today
 */
function calculateLeitnerDueCards() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  leitnerDueCards = leitnerCards.filter(card => {
    if (card.box >= 8) return false;

    const nextReview = card.nextReviewDate?.toDate ?
      card.nextReviewDate.toDate() : new Date(card.nextReviewDate);

    return nextReview <= today;
  });

  leitnerDueCards.sort((a, b) => {
    const aDate = a.nextReviewDate?.toDate ? a.nextReviewDate.toDate() : new Date(a.nextReviewDate);
    const bDate = b.nextReviewDate?.toDate ? b.nextReviewDate.toDate() : new Date(b.nextReviewDate);

    if (aDate.getTime() !== bDate.getTime()) return aDate - bDate;
    return a.box - b.box;
  });
}

/**
 * Update the due badge on the Leitner tab
 */
function updateLeitnerDueBadge() {
  const badge = document.getElementById('leitnerDueBadge2');
  if (badge) {
    if (leitnerDueCards.length > 0) {
      badge.textContent = leitnerDueCards.length;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  }
}

/**
 * Add a card to the Leitner Box (called when student gets a card wrong)
 */
async function addCardToLeitnerBox(cardData, setId) {
  if (!currentUser) return;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const nextReviewDate = new Date(today);

  const cardId = `${currentUser.uid}_${setId}_${cardData.english.replace(/\s+/g, '_').toLowerCase()}`;

  const existingCard = leitnerCards.find(c => c.id === cardId);

  try {
    if (existingCard) {
      existingCard.box = 1;
      existingCard.nextReviewDate = nextReviewDate;
      existingCard.lapseCount = (existingCard.lapseCount || 0) + 1;

      if (cardData.aiData) {
        existingCard.aiData = cardData.aiData;
      }

      await db.collection('leitnerProgress').doc(cardId).update({
        box: 1,
        nextReviewDate: nextReviewDate,
        lapseCount: existingCard.lapseCount,
        aiData: cardData.aiData || null
      });

      if (studentLeitnerStats) {
        studentLeitnerStats.totalLapses++;
        studentLeitnerStats.weeklyLapses = (studentLeitnerStats.weeklyLapses || 0) + 1;
        await db.collection('leitnerStats').doc(currentUser.uid).update({
          totalLapses: studentLeitnerStats.totalLapses,
          weeklyLapses: studentLeitnerStats.weeklyLapses
        });
      }

      console.log(`Leitner: Card "${cardData.english}" reset to Day 1 (lapse #${existingCard.lapseCount})`);

    } else {
      const newCard = {
        studentId: currentUser.uid,
        setId: setId,
        box: 1,
        nextReviewDate: nextReviewDate,
        firstSeenDate: today,
        lastReviewDate: null,
        masteredDate: null,
        lapseCount: 0,
        correctStreak: 0,
        totalReviews: 0,
        correctReviews: 0,
        english: cardData.english,
        korean: cardData.korean,
        aiData: cardData.aiData || null
      };

      await db.collection('leitnerProgress').doc(cardId).set(newCard);
      leitnerCards.push({ id: cardId, ...newCard });

      if (studentLeitnerStats) {
        studentLeitnerStats.totalCardsLearning++;
        await db.collection('leitnerStats').doc(currentUser.uid).update({
          totalCardsLearning: studentLeitnerStats.totalCardsLearning
        });
      }

    }

    calculateLeitnerDueCards();
    updateLeitnerDueBadge();

  } catch (error) {
  }
}

/**
 * Handle a Leitner review result (correct or incorrect)
 */
async function handleLeitnerReview(cardId, isCorrect) {
  const card = leitnerCards.find(c => c.id === cardId);
  if (!card) {
    return;
  }

  const today = new Date();
  const now = new Date(); // Keep full timestamp for interval tracking
  today.setHours(0, 0, 0, 0);

  const previousBox = card.box;

  if (card.box === 1 && isCorrect) {
    card.day1Intervals = card.day1Intervals || {};
    const currentHour = now.getHours();

    if (!card.day1Intervals.first) {
      card.day1Intervals.first = now;
    } else {
      const firstPractice = card.day1Intervals.first?.toDate ? card.day1Intervals.first.toDate() : new Date(card.day1Intervals.first);
      const minutesSinceFirst = (now - firstPractice) / (1000 * 60);

      if (!card.day1Intervals.thirtyMin && minutesSinceFirst >= 25 && minutesSinceFirst <= 90) {
        card.day1Intervals.thirtyMin = now;
      }
      else if (!card.day1Intervals.twoHours && minutesSinceFirst >= 90) {
        card.day1Intervals.twoHours = now;
      }

      if (!card.day1Intervals.beforeSleep && currentHour >= 20 && currentHour <= 23) {
        card.day1Intervals.beforeSleep = now;
      }
    }
  }

  card.lastReviewDate = today;
  card.totalReviews = (card.totalReviews || 0) + 1;

  if (isCorrect) {
    card.correctReviews = (card.correctReviews || 0) + 1;
    card.correctStreak = (card.correctStreak || 0) + 1;

    awardCoinsWithPopup(7);

    if (card.box === 1) {
      card.box = 2;
      const nextDate = new Date(today);
      nextDate.setDate(nextDate.getDate() + LEITNER_INTERVALS[2]);
      card.nextReviewDate = nextDate;

      card.movedFromDay1Date = today.toISOString().split('T')[0];

      leitnerSessionStats.correct++;

      if (studentLeitnerStats) {
        studentLeitnerStats.totalCorrect++;
      }

    } else if (card.box === 7) {
      card.box = 8;
      card.masteredDate = today;
      card.nextReviewDate = null;

      if (studentLeitnerStats) {
        studentLeitnerStats.totalMastered++;
        studentLeitnerStats.totalCardsLearning--;
      }

      leitnerSessionStats.correct++;
      if (studentLeitnerStats) {
        studentLeitnerStats.totalCorrect++;
      }
    } else {
      card.box++;
      const nextDate = new Date(today);
      nextDate.setDate(nextDate.getDate() + LEITNER_INTERVALS[card.box]);
      card.nextReviewDate = nextDate;

      leitnerSessionStats.correct++;
      if (studentLeitnerStats) {
        studentLeitnerStats.totalCorrect++;
      }
    }

  } else {
    card.correctStreak = 0;

    const todayStr = today.toISOString().split('T')[0];
    if (card.box === 1 || (card.box === 2 && card.movedFromDay1Date === todayStr)) {
      if (card.box === 2) {
        card.box = 1;
        card.movedFromDay1Date = null;
      }
      leitnerSessionStats.incorrect++;
    } else {
      card.lapseCount = (card.lapseCount || 0) + 1;
      if (studentLeitnerStats) {
        studentLeitnerStats.totalLapses++;
      }

      const newBox = Math.max(1, card.box - 1);
      card.box = newBox;
      card.movedFromDay1Date = null;

      const LEITNER_INTERVALS_LOCAL = { 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 7, 7: 30 };
      const interval = LEITNER_INTERVALS_LOCAL[newBox] || 1;
      const nextDate = new Date(today);
      nextDate.setDate(nextDate.getDate() + interval);
      card.nextReviewDate = nextDate;

      leitnerSessionStats.incorrect++;
    }
  }

  if (studentLeitnerStats) {
    studentLeitnerStats.totalReviews++;

    const todayStr = today.toISOString().split('T')[0];
    const yesterdayDate = new Date(today);
    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
    const yesterdayStr = yesterdayDate.toISOString().split('T')[0];

    if (studentLeitnerStats.lastStudyDate !== todayStr) {
      if (studentLeitnerStats.lastStudyDate === yesterdayStr) {
        studentLeitnerStats.currentStreak++;
      } else {
        studentLeitnerStats.currentStreak = 1;
      }

      if (studentLeitnerStats.currentStreak > studentLeitnerStats.longestStreak) {
        studentLeitnerStats.longestStreak = studentLeitnerStats.currentStreak;
      }

      studentLeitnerStats.lastStudyDate = todayStr;
    }

    studentLeitnerStats.studyLog = studentLeitnerStats.studyLog || {};
    studentLeitnerStats.studyLog[todayStr] = (studentLeitnerStats.studyLog[todayStr] || 0) + 1;
  }

  try {
    await db.collection('leitnerProgress').doc(cardId).update({
      box: card.box,
      nextReviewDate: card.nextReviewDate,
      lastReviewDate: card.lastReviewDate,
      masteredDate: card.masteredDate || null,
      totalReviews: card.totalReviews,
      correctReviews: card.correctReviews,
      correctStreak: card.correctStreak,
      lapseCount: card.lapseCount || 0,
      movedFromDay1Date: card.movedFromDay1Date || null,
      day1Intervals: card.day1Intervals || null
    });

    if (studentLeitnerStats) {
      await db.collection('leitnerStats').doc(currentUser.uid).update(studentLeitnerStats);
    }

  } catch (error) {
  }
}

let currentLeitnerCalendarYear = new Date().getFullYear();
let currentLeitnerCalendarMonth = new Date().getMonth();
let leitnerDrillHistory = {};

/**
 * Switch Leitner View - redirects to separate tabs
 * (Legacy function for backwards compatibility)
 */
function switchLeitnerView(view) {
  if (view === 'drills') {
    switchTab('leitnerReview');
  } else if (view === 'calendar') {
    switchTab('srsCalendar');
  } else if (view === 'stats') {
    switchTab('srsStats');
  } else if (view === 'games') {
    switchTab('flashcardGames');
  }
}

/**
 * Render Leitner Active Drills (Day 1 drills with 5x practice goal)
 */
async function renderLeitnerActiveDrills() {
  const container = document.getElementById('leitnerDrillsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    calculateLeitnerDueCards();

    if (leitnerCards.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Cards in Your Leitner Box Yet!</h3>
          <p style="color: #718096; margin-bottom: 20px;">
            Play Flashcard Games and cards you get wrong will automatically appear here for spaced repetition practice.
          </p>
          <button onclick="switchTab('flashcardGames')" class="btn" style="padding: 12px 24px;">
             Go to Flashcard Games
          </button>
        </div>
      `;
      return;
    }

    const todayStr = new Date().toISOString().split('T')[0];
    const day1Cards = leitnerCards.filter(c => c.box === 1);
    const movedTodayCards = leitnerCards.filter(c => c.box === 2 && c.movedFromDay1Date === todayStr);
    const allDay1Practicable = [...day1Cards, ...movedTodayCards];
    const otherDueCards = leitnerDueCards.filter(c => c.box > 1 && c.movedFromDay1Date !== todayStr);

    const totalCards = leitnerCards.length;
    const masteredCards = leitnerCards.filter(c => c.box >= 8).length;
    const dueCount = leitnerDueCards.length;

    const dailySessionCount = (studentLeitnerStats && studentLeitnerStats.lastSessionDate === todayStr)
      ? (studentLeitnerStats.dailySessionCount || 0)
      : 0;
    const sessionsComplete = dailySessionCount >= 5;

    container.innerHTML = `
      <!-- Walk Away Mode Toggle -->
      <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
        <button onclick="toggleWalkAwayMode()" style="background: linear-gradient(135deg, ${walkAwayMode.enabled ? '#48bb78 0%, #38b2ac' : '#a0aec0 0%, #718096'} 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
           Walk Away Mode: ${walkAwayMode.enabled ? 'ON' : 'OFF'}
        </button>
      </div>

      <!-- Stats Summary -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${totalCards}</div>
          <div style="font-size: 12px; opacity: 0.9;">Total Cards</div>
        </div>
        <div style="background: ${dueCount > 0 ? 'linear-gradient(135deg, #f56565 0%, #c53030 100%)' : 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)'}; padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${dueCount}</div>
          <div style="font-size: 12px; opacity: 0.9;">Due Today</div>
        </div>
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${day1Cards.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">Day 1 Cards</div>
        </div>
        <div style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${masteredCards}</div>
          <div style="font-size: 12px; opacity: 0.9;">Mastered</div>
        </div>
      </div>

      ${day1Cards.length > 0 ? `
        <!-- Day 1 Drills Section (5 sessions per day goal - SET-BASED) -->
        <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #f56565;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #c53030; margin: 0;"> Day 1 Word Set (${day1Cards.length} words)</h3>
            <span style="background: ${sessionsComplete ? '#48bb78' : '#f56565'}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 13px;">
              ${dailySessionCount}/5 Sessions Today
            </span>
          </div>

          <!-- Daily Session Progress Bar -->
          <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #742a2a; margin-bottom: 5px;">
              <span>Daily Goal Progress</span>
              <span>${sessionsComplete ? ' Complete!' : `${5 - dailySessionCount} more to go`}</span>
            </div>
            <div style="background: #fed7d7; height: 12px; border-radius: 6px; overflow: hidden;">
              <div style="background: ${sessionsComplete ? '#48bb78' : 'linear-gradient(135deg, #f56565 0%, #c53030 100%)'}; height: 100%; width: ${Math.min(100, (dailySessionCount / 5) * 100)}%; transition: width 0.3s;"></div>
            </div>
          </div>

          <p style="color: #742a2a; margin-bottom: 15px; font-size: 14px;">
            Practice this entire word set 5 times today for optimal retention. Each session covers all ${day1Cards.length} words.
          </p>

          <!-- Word Preview List (scrollable) -->
          <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #fed7d7;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${day1Cards.map(card => `
                <span style="background: #fff5f5; padding: 8px 14px; border-radius: 20px; font-size: 14px; border: 1px solid #f56565; white-space: nowrap;">
                  <strong style="color: #c53030;">${card.korean}</strong>
                  <span style="color: #718096; margin-left: 6px;">${card.english}</span>
                </span>
              `).join('')}
            </div>
          </div>

          <button onclick="startDay1DrillSession()" class="btn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border: none; font-size: 16px;">
            ${sessionsComplete ? ' Practice Again (Bonus Session)' : ` Start Session ${dailySessionCount + 1} of 5`}
          </button>
        </div>
      ` : ''}

      ${otherDueCards.length > 0 ? `
        <!-- Other Due Cards Section -->
        <div style="background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #4299e1;">
          <h3 style="color: #2b6cb0; margin: 0 0 15px 0;"> Other Cards Due Today (${otherDueCards.length})</h3>
          <p style="color: #2c5282; margin-bottom: 15px; font-size: 14px;">
            These cards from later boxes are due for review today.
          </p>
          <button onclick="startLeitnerReviewSession()" class="btn" style="padding: 12px 24px; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); border: none;">
             Start Review Session
          </button>
        </div>
      ` : ''}

      ${leitnerCards.filter(c => c.box >= 8).length > 0 ? `
        <!-- Mastered Cards Preview -->
        <div style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); padding: 20px; border-radius: 12px; border: 2px solid #48bb78;">
          <h3 style="color: #276749; margin: 0 0 10px 0;"> Mastered Cards (${masteredCards})</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${leitnerCards.filter(c => c.box >= 8).slice(0, 10).map(card => `
              <span style="background: white; padding: 6px 12px; border-radius: 15px; font-size: 13px; border: 1px solid #48bb78;">${card.korean}</span>
            `).join('')}
            ${masteredCards > 10 ? `<span style="color: #276749; padding: 6px;">+${masteredCards - 10} more</span>` : ''}
          </div>
        </div>
      ` : ''}
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading drills: ${error.message}</p>`;
  }
}

/**
 * Complete a Leitner Day 1 drill session (set-based practice)
 * Called when a full session through Day 1 cards is completed
 */
async function completeLeitnerDay1Session() {
  const todayStr = new Date().toISOString().split('T')[0];

  try {
    const currentCount = studentLeitnerStats.dailySessionCount || 0;
    const lastSessionDate = studentLeitnerStats.lastSessionDate;

    let newCount;
    if (lastSessionDate !== todayStr) {
      newCount = 1;
    } else {
      newCount = currentCount + 1;
    }

    studentLeitnerStats.dailySessionCount = newCount;
    studentLeitnerStats.lastSessionDate = todayStr;

    studentLeitnerStats.sessionHistory = studentLeitnerStats.sessionHistory || {};
    studentLeitnerStats.sessionHistory[todayStr] = newCount;

    await db.collection('leitnerStats').doc(currentUser.uid).update({
      dailySessionCount: newCount,
      lastSessionDate: todayStr,
      sessionHistory: studentLeitnerStats.sessionHistory
    });

    if (newCount >= 5) {
      alert(` Amazing! You've completed 5 Day 1 sessions today! Great retention work!`);
    } else {
      alert(` Session ${newCount}/5 complete for today! Keep it up!`);
    }

    renderLeitnerActiveDrills();

  } catch (error) {
    alert('Error saving progress. Please try again.');
  }
}

/**
 * Start Day 1 Drill Session (sequential practice of all Day 1 cards)
 */
function startDay1DrillSession() {
  const day1Cards = leitnerCards.filter(c => c.box === 1);
  if (day1Cards.length === 0) {
    alert('No Day 1 cards to practice!');
    return;
  }

  window.currentLeitnerSession = {
    cards: [...day1Cards],
    currentIndex: 0,
    isDay1Session: true
  };

  showLeitnerReviewCard();
}

/**
 * Start Leitner Review Session (for cards in other boxes that are due)
 */
function startLeitnerReviewSession() {
  if (swipeMode.enabled) {
    _startLeitnerReviewSessionInternal();
    return;
  }
  
  showSpeechDisclaimer(() => {
    _startLeitnerReviewSessionInternal();
  });
}

function _startLeitnerReviewSessionInternal() {
  const todayStr = new Date().toISOString().split('T')[0];
  const dueCards = leitnerDueCards.filter(c => c.box > 1 && c.movedFromDay1Date !== todayStr);

  if (dueCards.length === 0) {
    alert('No cards due for review!');
    return;
  }

  window.currentLeitnerSession = {
    cards: [...dueCards],
    currentIndex: 0,
    isDay1Session: false
  };

  showLeitnerReviewCard();
}

/**
 * Render Leitner Calendar View (30-day calendar with clickable drills)
 */
async function renderLeitnerCalendarView() {
  const container = document.getElementById('leitnerCalendarContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    await loadLeitnerDrillHistory();

    const year = currentLeitnerCalendarYear;
    const month = currentLeitnerCalendarMonth;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const totalDays = lastDay.getDate();

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    let daysHtml = '';

    for (let i = 0; i < startDayOfWeek; i++) {
      daysHtml += '<div style="padding: 10px; background: #f7fafc; border-radius: 8px;"></div>';
    }

    const today = new Date();

    for (let day = 1; day <= totalDays; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
      const isPast = new Date(year, month, day) < new Date(today.getFullYear(), today.getMonth(), today.getDate());

      const dayHistory = leitnerDrillHistory[dateStr] || { practiced: 0, completed: false };
      const hasPractice = dayHistory.practiced > 0;
      const isComplete = dayHistory.completed;

      let bgColor = 'white';
      let borderColor = '#e2e8f0';
      if (isComplete) {
        bgColor = '#c6f6d5';
        borderColor = '#48bb78';
      } else if (hasPractice) {
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      }

      daysHtml += `
        <div onclick="${isToday || isPast ? `showLeitnerDayDetail('${dateStr}')` : ''}"
             style="padding: 10px; background: ${bgColor}; border-radius: 8px; text-align: center;
                    border: 2px solid ${isToday ? '#667eea' : borderColor};
                    cursor: ${isToday || hasPractice ? 'pointer' : 'default'};
                    ${isToday ? 'box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);' : ''}
                    opacity: ${!isToday && !isPast ? '0.5' : '1'};">
          <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: #2d3748;">${day}</div>
          ${hasPractice ? `
            <div style="margin-top: 4px;">
              ${isComplete ? '<span style="font-size: 10px;"></span>' : `<span style="font-size: 9px; color: #f59e0b;">${dayHistory.practiced}x</span>`}
            </div>
          ` : ''}
        </div>
      `;
    }

    const streak = calculateLeitnerStreak();

    container.innerHTML = `
      <!-- Calendar Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button onclick="changeLeitnerCalendarMonth(-1)" class="btn" style="padding: 8px 16px;">
           Prev
        </button>
        <h3 style="margin: 0; color: #2d3748;">${monthNames[month]} ${year}</h3>
        <button onclick="changeLeitnerCalendarMonth(1)" class="btn" style="padding: 8px 16px;">
          Next 
        </button>
      </div>

      <!-- Stats Summary -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;"> ${streak}</div>
          <div style="font-size: 12px; opacity: 0.9;">Day Streak</div>
        </div>
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${Object.values(leitnerDrillHistory).filter(d => d.completed).length}</div>
          <div style="font-size: 12px; opacity: 0.9;">Days Complete</div>
        </div>
      </div>

      <!-- Legend -->
      <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 16px; height: 16px; background: #c6f6d5; border: 2px solid #48bb78; border-radius: 4px;"></div>
          <span style="font-size: 13px; color: #718096;">Complete (5 sessions)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 16px; height: 16px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 4px;"></div>
          <span style="font-size: 13px; color: #718096;">In Progress</span>
        </div>
      </div>

      <!-- Calendar Grid -->
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px;">
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Sun</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Mon</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Tue</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Wed</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Thu</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Fri</div>
        <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px;">Sat</div>
        ${daysHtml}
      </div>

      <!-- Day Detail Area -->
      <div id="leitnerDayDetail"></div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading calendar: ${error.message}</p>`;
  }
}

/**
 * Load Leitner drill history from session-based tracking
 */
async function loadLeitnerDrillHistory() {
  try {
    leitnerDrillHistory = {};

    if (studentLeitnerStats && studentLeitnerStats.sessionHistory) {
      for (const dateStr in studentLeitnerStats.sessionHistory) {
        const sessionCount = studentLeitnerStats.sessionHistory[dateStr];
        leitnerDrillHistory[dateStr] = {
          practiced: sessionCount,
          completed: sessionCount >= 5,
          sessions: sessionCount
        };
      }
    }

    if (studentLeitnerStats && studentLeitnerStats.studyLog) {
      for (const dateStr in studentLeitnerStats.studyLog) {
        if (!leitnerDrillHistory[dateStr]) {
          const reviewCount = studentLeitnerStats.studyLog[dateStr];
          leitnerDrillHistory[dateStr] = {
            practiced: reviewCount,
            completed: reviewCount >= 5,
            sessions: reviewCount
          };
        }
      }
    }

  } catch (error) {
    leitnerDrillHistory = {};
  }
}

/**
 * Calculate Leitner streak
 */
function calculateLeitnerStreak() {
  let streak = 0;
  const today = new Date();

  for (let i = 0; i < 365; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(today.getDate() - i);
    const dateStr = checkDate.toISOString().split('T')[0];

    if (leitnerDrillHistory[dateStr] && leitnerDrillHistory[dateStr].completed) {
      streak++;
    } else if (i > 0) {
      break;
    }
  }

  return streak;
}

/**
 * Change Leitner calendar month
 */
function changeLeitnerCalendarMonth(delta) {
  currentLeitnerCalendarMonth += delta;

  if (currentLeitnerCalendarMonth > 11) {
    currentLeitnerCalendarMonth = 0;
    currentLeitnerCalendarYear++;
  } else if (currentLeitnerCalendarMonth < 0) {
    currentLeitnerCalendarMonth = 11;
    currentLeitnerCalendarYear--;
  }

  renderLeitnerCalendarView();
}

/**
 * Show Leitner day detail
 */
function showLeitnerDayDetail(dateStr) {
  const detailContainer = document.getElementById('leitnerDayDetail');
  if (!detailContainer) return;

  const dayHistory = leitnerDrillHistory[dateStr];
  const [year, month, day] = dateStr.split('-').map(Number);
  const dateDisplay = new Date(year, month - 1, day).toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  const isToday = dateStr === new Date().toISOString().split('T')[0];

  if (!dayHistory && !isToday) {
    detailContainer.innerHTML = `
      <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px;">
        <p style="color: #718096;">No practice recorded for ${dateDisplay}</p>
      </div>
    `;
    return;
  }

  if (isToday) {
    const todayStr = new Date().toISOString().split('T')[0];
    const dailySessionCount = (studentLeitnerStats && studentLeitnerStats.lastSessionDate === todayStr)
      ? (studentLeitnerStats.dailySessionCount || 0)
      : 0;
    const day1Cards = leitnerCards.filter(c => c.box === 1);
    const sessionsComplete = dailySessionCount >= 5;

    detailContainer.innerHTML = `
      <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #667eea; margin-top: 20px;">
        <h4 style="color: #2d3748; margin: 0 0 15px 0;"> Today - ${dateDisplay}</h4>

        <!-- Session Progress -->
        <div style="background: ${sessionsComplete ? '#c6f6d5' : '#fff5f5'}; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 600; color: ${sessionsComplete ? '#276749' : '#c53030'};">
              ${sessionsComplete ? ' Daily Goal Complete!' : ' Daily Session Progress'}
            </span>
            <span style="background: ${sessionsComplete ? '#48bb78' : '#f56565'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px;">
              ${dailySessionCount}/5 Sessions
            </span>
          </div>
          <div style="background: ${sessionsComplete ? '#9ae6b4' : '#fed7d7'}; height: 10px; border-radius: 5px; overflow: hidden;">
            <div style="background: ${sessionsComplete ? '#48bb78' : '#f56565'}; height: 100%; width: ${Math.min(100, (dailySessionCount / 5) * 100)}%;"></div>
          </div>
        </div>

        <p style="color: #718096; margin-bottom: 15px; font-size: 14px;">
          ${day1Cards.length > 0
            ? `You have ${day1Cards.length} words in your Day 1 set. Complete 5 sessions to meet your daily goal.`
            : 'No Day 1 cards to practice today! Play flashcard games to add words.'}
        </p>

        ${day1Cards.length > 0 ? `
          <button onclick="startDay1DrillSession()" class="btn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border: none;">
             ${sessionsComplete ? 'Practice Bonus Session' : `Start Session ${dailySessionCount + 1}`}
          </button>
        ` : ''}
      </div>
    `;
  } else {
    const sessions = dayHistory.sessions || dayHistory.practiced;
    detailContainer.innerHTML = `
      <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; margin-top: 20px;">
        <h4 style="color: #2d3748; margin: 0 0 15px 0;"> ${dateDisplay}</h4>
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: ${dayHistory.completed ? '#48bb78' : '#ed8936'};">
              ${sessions}
            </div>
            <div style="font-size: 12px; color: #718096;">Sessions</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px;">
              ${dayHistory.completed ? '' : ''}
            </div>
            <div style="font-size: 12px; color: #718096;">${dayHistory.completed ? 'Goal Met' : 'Incomplete'}</div>
          </div>
        </div>
      </div>
    `;
  }
}

/**
 * Render Leitner Stats View
 */
async function renderLeitnerStatsView() {
  const container = document.getElementById('leitnerStatsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const totalCards = leitnerCards.length;
    const masteredCards = leitnerCards.filter(c => c.box >= 8).length;
    const day1Cards = leitnerCards.filter(c => c.box === 1).length;
    const inProgressCards = leitnerCards.filter(c => c.box > 1 && c.box < 8).length;
    const dueCount = leitnerDueCards.length;

    const boxDistribution = {};
    for (let i = 1; i <= 8; i++) {
      boxDistribution[i] = leitnerCards.filter(c => c.box === i).length;
    }

    let totalCorrect = 0;
    let totalAttempts = 0;
    leitnerCards.forEach(card => {
      totalCorrect += card.correctCount || 0;
      totalAttempts += (card.correctCount || 0) + (card.wrongCount || 0);
    });
    const successRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;

    container.innerHTML = `
      <!-- Core Progress -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Core Progress</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${totalCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">Total Cards</div>
        </div>
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${masteredCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">Mastered (Box 8)</div>
        </div>
        <div style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${day1Cards}</div>
          <div style="font-size: 13px; opacity: 0.9;">Day 1 Cards</div>
        </div>
        <div style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${successRate}%</div>
          <div style="font-size: 13px; opacity: 0.9;">Success Rate</div>
        </div>
      </div>

      <!-- Box Distribution -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Box Distribution</h3>
      <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          ${Object.entries(boxDistribution).map(([box, count]) => `
            <div style="flex: 1; min-width: 70px; text-align: center; padding: 15px 10px; background: ${box === '1' ? '#fff5f5' : box >= 8 ? '#f0fff4' : '#f7fafc'}; border-radius: 8px; border: 2px solid ${box === '1' ? '#f56565' : box >= 8 ? '#48bb78' : '#e2e8f0'};">
              <div style="font-size: 24px; font-weight: bold; color: ${box === '1' ? '#f56565' : box >= 8 ? '#48bb78' : '#667eea'};">${count}</div>
              <div style="font-size: 11px; color: #718096;">Day ${box}</div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Cards Needing Work -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Cards Needing Work</h3>
      <div style="display: grid; gap: 10px;">
        ${leitnerCards.filter(c => c.box === 1).slice(0, 5).map(card => `
          <div style="background: #fff5f5; padding: 12px 15px; border-radius: 8px; border-left: 4px solid #f56565; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-weight: 600; color: #2d3748;">${card.korean}</span>
              <span style="color: #718096; margin-left: 10px;">${card.english}</span>
            </div>
            <span style="color: #f56565; font-size: 13px;">Day 1</span>
          </div>
        `).join('') || '<p style="color: #48bb78; text-align: center; padding: 20px;"> No cards stuck in Day 1!</p>'}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading stats: ${error.message}</p>`;
  }
}

/**
 * Render Leitner Games View (Flashcard Games)
 */
async function renderLeitnerGamesView() {
  const container = document.getElementById('leitnerGamesContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('flashcards').get();

    if (snapshot.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Flashcard Games Available</h3>
          <p style="color: #718096;">Your teacher hasn't created any flashcard sets yet. Check back later!</p>
        </div>
      `;
      return;
    }

    const flashcardSets = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    flashcardSets.sort((a, b) => {
      const aTime = a.createdAt ? a.createdAt.toDate() : new Date(0);
      const bTime = b.createdAt ? b.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    container.innerHTML = `
      <div style="margin-bottom: 20px;">
        <h3 style="color: #2d3748; margin-bottom: 10px;"> Available Flashcard Games</h3>
        <p style="color: #718096; font-size: 14px;">
          Play flashcard games to learn vocabulary. Wrong answers go to your Leitner Review for spaced repetition practice!
        </p>
      </div>

      <div style="display: grid; gap: 15px;">
        ${flashcardSets.map(set => `
          <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
              <div>
                <h4 style="color: #2d3748; margin: 0 0 5px 0; font-size: 18px;">${set.title}</h4>
                <p style="color: #718096; font-size: 13px; margin: 0;">
                  ${set.wordPairs ? set.wordPairs.length : 0} words  Created by ${set.teacherEmail || 'Teacher'}
                </p>
              </div>
              <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px;">
                 Game
              </span>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="startFlashcardGameFromLeitner('${set.id}')" class="btn" style="flex: 1; min-width: 120px; padding: 12px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                 Play Game
              </button>
              <button onclick="previewFlashcardSet('${set.id}')" class="btn" style="padding: 12px 20px; font-size: 14px; background: #e2e8f0; color: #4a5568;">
                 Preview
              </button>
            </div>
          </div>
        `).join('')}
      </div>

      <!-- Mastery Deck Section -->
      <div style="margin-top: 30px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; border: 2px solid #f59e0b;">
        <h3 style="color: #92400e; margin: 0 0 10px 0;"> Your Mastery Deck</h3>
        <p style="color: #b45309; font-size: 14px; margin-bottom: 15px;">
          Words you've mastered from flashcard games! Keep practicing to maintain your skills.
        </p>
        <button onclick="loadMasteryDeckInLeitner()" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 12px 24px;">
           View Mastery Deck
        </button>
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading games: ${error.message}</p>`;
  }
}

/**
 * Start flashcard game from Leitner view
 */
function startFlashcardGameFromLeitner(setId) {
  startFlashcardGame(setId);
}

/**
 * Preview flashcard set
 */
async function previewFlashcardSet(setId) {
  try {
    const doc = await db.collection('flashcards').doc(setId).get();
    if (!doc.exists) {
      alert('Flashcard set not found');
      return;
    }

    const set = doc.data();
    const words = set.wordPairs || [];

    const previewHtml = `
      <div id="flashcardPreviewModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                              background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                                              align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 80vh;
                    overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;
                      border-radius: 16px 16px 0 0; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0;">${set.title}</h3>
              <button onclick="document.getElementById('flashcardPreviewModal').remove()"
                      style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px;
                             border-radius: 50%; cursor: pointer; font-size: 16px;"></button>
            </div>
          </div>
          <div style="padding: 20px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f7fafc;">
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">English</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Korean</th>
                </tr>
              </thead>
              <tbody>
                ${words.map(word => `
                  <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${word.english}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${word.korean}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div style="padding: 15px 20px; border-top: 1px solid #e2e8f0; text-align: right;">
            <button onclick="document.getElementById('flashcardPreviewModal').remove(); startFlashcardGameFromLeitner('${setId}')"
                    class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; margin-right: 10px;">
               Play Game
            </button>
            <button onclick="document.getElementById('flashcardPreviewModal').remove()" class="btn" style="background: #e2e8f0; color: #4a5568;">
              Close
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', previewHtml);

  } catch (error) {
    alert('Error loading preview: ' + error.message);
  }
}

/**
 * Load mastery deck in Leitner view
 */
async function loadMasteryDeckInLeitner() {
  const container = document.getElementById('leitnerGamesContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .get();

    const masteryWords = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    if (masteryWords.length === 0) {
      container.innerHTML = `
        <button onclick="renderLeitnerGamesView()" class="btn" style="margin-bottom: 20px;"> Back to Games</button>
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Mastered Words Yet</h3>
          <p style="color: #718096;">Play flashcard games and get answers correct to add words to your mastery deck!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <button onclick="renderLeitnerGamesView()" class="btn" style="margin-bottom: 20px;"> Back to Games</button>

      <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 10px;"></div>
        <h3 style="color: #744210; margin: 0 0 5px 0;">Your Mastery Deck</h3>
        <p style="color: #975a16; margin: 0;">${masteryWords.length} word${masteryWords.length > 1 ? 's' : ''} mastered!</p>
      </div>

      <div style="display: grid; gap: 10px;">
        ${masteryWords.map(word => `
          <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #fbd38d; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-weight: 600; color: #2d3748;">${word.korean}</span>
              <span style="color: #718096; margin-left: 15px;">${word.english}</span>
            </div>
            <span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;"> Mastered</span>
          </div>
        `).join('')}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading mastery deck: ${error.message}</p>`;
  }
}

/**
 * Render the Leitner Daily Review page
 */
function renderLeitnerDailyReview() {
  const container = document.getElementById('leitnerReviewContainer');
  if (!container) return;

  calculateLeitnerDueCards();

  if (leitnerCards.length === 0) {
    container.innerHTML = `
      <div class="leitner-empty-state">
        <div class="icon"></div>
        <h3>No cards in your Leitner Box yet!</h3>
        <p>Play Flashcard Games and cards you get wrong will automatically appear here for spaced repetition practice.</p>
        <button class="btn btn-secondary" onclick="switchTab('flashcardGames')" style="margin-top: 20px;">
           Go to Flashcard Games
        </button>
      </div>
    `;
    return;
  }

  const todayStr = new Date().toISOString().split('T')[0];
  const day1Cards = leitnerCards.filter(c => c.box === 1);
  const movedTodayCards = leitnerCards.filter(c => c.box === 2 && c.movedFromDay1Date === todayStr);
  const allDay1Practicable = [...day1Cards, ...movedTodayCards];
  const otherDueCards = leitnerDueCards.filter(c => c.box > 1 && c.movedFromDay1Date !== todayStr);

  container.innerHTML = `
    <!-- Walk Away Mode Toggle -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
      <button id="walkAwayModeBtn" onclick="toggleWalkAwayMode()" style="background: linear-gradient(135deg, ${walkAwayMode.enabled ? '#48bb78 0%, #38b2ac' : '#a0aec0 0%, #718096'} 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
         Walk Away Mode: ${walkAwayMode.enabled ? 'ON' : 'OFF'}
      </button>
    </div>

    ${walkAwayMode.enabled ? `
      <div style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <p style="color: #276749; margin: 0; font-size: 14px;">
          <strong> Walk Away Mode Active!</strong> English words will be spoken aloud. Listen and say the Korean translation.
        </p>
      </div>
    ` : ''}

    <!-- Day 1 Practice Section - UNLIMITED TODAY -->
    <div style="background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border: 2px solid #667eea; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
      <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
        <div style="font-size: 50px;"></div>
        <div style="flex: 1; min-width: 250px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <h3 style="color: #667eea; margin: 0;">Day 1 - Unlimited Practice</h3>
            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
               Today Only
            </span>
          </div>

          <p style="color: #4a5568; margin-bottom: 15px;">
            <span style="color: #f59e0b; font-weight: 600;"> ${day1Cards.length} to learn</span>
            ${movedTodayCards.length > 0 ? `<span style="color: #48bb78; margin-left: 15px;"> ${movedTodayCards.length} mastered today</span>` : ''}
          </p>

          <!-- Unlimited Practice Explanation -->
          <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
            <p style="color: #3730a3; font-size: 14px; margin: 0 0 8px 0;">
              <strong> Unlimited Practice - Today Only!</strong>
            </p>
            <p style="color: #4338ca; font-size: 13px; margin: 0;">
              Practice these cards as many times as you want <strong>today</strong>! When you get them right,
              they move to Day 2 but you can keep practicing them until midnight.
            </p>
          </div>

          ${allDay1Practicable.length > 0 ? `
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
              <button class="btn btn-secondary" onclick="startDay1Practice()" style="padding: 12px 25px;">
                 Practice All Cards (${allDay1Practicable.length})
              </button>
            </div>

            <!-- FOMO Warning -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 15px; margin-top: 15px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;"></span>
                <strong style="color: #92400e;">Tomorrow's Challenge!</strong>
              </div>
              <p style="color: #78350f; font-size: 13px; margin: 0;">
                <strong> Starting tomorrow</strong>, cards in Day 2 only get <strong>ONE chance</strong> per review!
                Get them wrong and they come back to Day 1. Make sure you really know them before the day ends!
              </p>
            </div>

            ${movedTodayCards.length > 0 ? `
              <div style="background: #f0fff4; border-left: 4px solid #48bb78; padding: 12px 15px; border-radius: 0 8px 8px 0; margin-top: 15px;">
                <p style="color: #276749; font-size: 14px; margin: 0;">
                  <strong> ${movedTodayCards.length} card${movedTodayCards.length !== 1 ? 's' : ''} mastered!</strong>
                  Great job! You can still practice ${movedTodayCards.length !== 1 ? 'them' : 'it'} more today to reinforce your memory.
                </p>
              </div>
            ` : ''}
          ` : `
            <p style="color: #48bb78; font-weight: 600;"> No new cards to memorize!</p>
          `}
        </div>
      </div>
    </div>

    <!-- Scheduled Reviews Section - Only when due -->
    <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 25px;">
      <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
        <div style="font-size: 50px;">${otherDueCards.length > 0 ? '' : ''}</div>
        <div style="flex: 1; min-width: 250px;">
          <h3 style="color: #2d3748; margin-bottom: 10px;">Scheduled Reviews</h3>
          ${otherDueCards.length > 0 ? `
            <p style="color: #f56565; font-weight: 600; margin-bottom: 10px;">
              ${otherDueCards.length} card${otherDueCards.length !== 1 ? 's' : ''} due for review!
            </p>
            <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
              These cards from Day 2+ are scheduled for today. Get them right to advance, or they'll go back to Day 1.
            </p>
            <button class="btn" onclick="startScheduledReview()" style="background: #f56565; padding: 12px 25px;">
              Review Due Cards (${otherDueCards.length})
            </button>
          ` : `
            <p style="color: #48bb78; font-weight: 600; margin-bottom: 10px;"> All caught up!</p>
            <p style="color: #718096; font-size: 14px;">
              No scheduled reviews right now. Cards from Day 2+ will appear here when they're due.
            </p>
          `}
        </div>
      </div>
    </div>

    <!-- Box Overview - View Only (no practice for Day 2+) -->
    <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
      <h3 style="color: #2d3748; margin-bottom: 10px;"> Your Progress</h3>
      <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">
        Cards advance through boxes as you review them correctly. Wrong answers reset to Day 1.
      </p>
      <div class="leitner-box-grid">
        ${[1,2,3,4,5,6,7,8].map(boxNum => {
          const boxCards = leitnerCards.filter(c => c.box === boxNum);
          const count = boxCards.length;
          const dueCount = leitnerDueCards.filter(c => c.box === boxNum).length;
          const isDay1 = boxNum === 1;
          const isMastery = boxNum === 8;

          let dueDateText = '';
          if (!isDay1 && !isMastery && count > 0 && dueCount === 0) {
            const notDueCards = boxCards.filter(c => {
              const isDue = leitnerDueCards.some(dc => dc.id === c.id);
              return !isDue && c.nextReviewDate;
            });
            if (notDueCards.length > 0) {
              const dates = notDueCards.map(c => {
                return c.nextReviewDate?.toDate ? c.nextReviewDate.toDate() : new Date(c.nextReviewDate);
              }).sort((a, b) => a - b);
              const nextDate = dates[0];
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              const tomorrow = new Date(today);
              tomorrow.setDate(tomorrow.getDate() + 1);

              let dateStr;
              if (nextDate.toDateString() === today.toDateString()) {
                dateStr = 'Today';
              } else if (nextDate.toDateString() === tomorrow.toDateString()) {
                dateStr = 'Tomorrow';
              } else {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                dateStr = monthNames[nextDate.getMonth()] + ' ' + nextDate.getDate();
              }
              dueDateText = '<div style="font-size: 11px; color: #a0aec0; margin-top: 5px;"> Due: ' + dateStr + '</div>';
            }
          }

          return `
            <div class="leitner-box-card ${LEITNER_BOX_CLASSES[boxNum]}"
                 onclick="startBoxPractice(${boxNum})"
                 style="cursor: pointer;">
              ${dueCount > 0 && !isMastery ? `<div class="leitner-due-indicator ${boxNum === 7 ? 'shake' : ''}">!</div>` : ''}
              <div class="box-label">${LEITNER_BOX_NAMES[boxNum]}</div>
              <div class="box-count">${count}</div>
              ${isDay1 && count > 0 ? `<div style="font-size: 11px; color: #667eea; margin-top: 5px;">Practice anytime</div>` : ''}
              ${!isDay1 && !isMastery && dueCount > 0 ? `<div class="box-due">${dueCount} due</div>` : ''}
              ${dueDateText}
              ${isMastery ? `<div style="font-size: 11px; color: #9f7aea; margin-top: 5px;">Completed!</div>` : ''}
            </div>
          `;
        }).join('')}
      </div>
    </div>

    <div id="leitnerReviewInterface" style="display: none; margin-top: 30px;">
      <!-- Review interface shown here -->
    </div>
  `;
}

/**
 * Start practicing Day 1 cards - wrapper with disclaimer
 */
function startDay1Practice() {
  // Default to 'first' interval if not already set by practiceDay1Interval
  if (!window.currentDay1Interval) {
    window.currentDay1Interval = 'first';
  }
  
  if (swipeMode.enabled) {
    // Swipe mode doesn't need voice disclaimer
    _startDay1PracticeInternal();
    return;
  }
  
  showSpeechDisclaimer(() => {
    _startDay1PracticeInternal();
  });
}

/**
 * Internal: Start practicing Day 1 cards (unlimited practice for today)
 * Includes cards in box 1 AND cards moved from Day 1 today
 */
function _startDay1PracticeInternal() {
  const todayStr = new Date().toISOString().split('T')[0];
  const day1Cards = leitnerCards.filter(c => c.box === 1);
  const movedTodayCards = leitnerCards.filter(c => c.box === 2 && c.movedFromDay1Date === todayStr);
  const allPracticableCards = [...day1Cards, ...movedTodayCards];

  if (allPracticableCards.length === 0) {
    alert('No Day 1 cards to practice!');
    return;
  }

  switchTab('leitnerReview');

  const needPracticeCount = day1Cards.length;
  const masteredCount = movedTodayCards.length;

  currentLeitnerQueue = [...allPracticableCards].sort(() => Math.random() - 0.5);
  currentLeitnerIndex = 0;
  leitnerSessionStats = { correct: 0, incorrect: 0 };
  isPracticingDay1 = true;

  const container = document.getElementById('leitnerReviewContainer');
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600;">
         Day 1 - Unlimited Practice (${allPracticableCards.length} cards)
      </span>
      <p style="color: #718096; font-size: 14px; margin-top: 10px;">
         Practice as many times as you want <strong>today</strong>!
      </p>
      <p style="color: #4a5568; font-size: 13px; margin-top: 5px;">
        <span style="color: #f59e0b; font-weight: 600;"> ${needPracticeCount} to learn</span>
        ${masteredCount > 0 ? `<span style="margin-left: 10px; color: #48bb78; font-weight: 600;"> ${masteredCount} mastered today</span>` : ''}
      </p>
    </div>

    <!-- Ready Screen - Show before starting mic -->
    <div id="leitnerReadyScreen" style="max-width: 500px; margin: 0 auto; text-align: center; padding: 40px 20px;">
      <div style="font-size: 80px; margin-bottom: 20px;">${swipeMode.enabled ? '' : ''}</div>
      <h3 style="color: #2d3748; margin-bottom: 15px;">Ready to Practice?</h3>
      <p style="color: #718096; margin-bottom: 10px;">
        ${swipeMode.enabled ? 'Tap cards to reveal answers, then mark correct or incorrect.' : 'You\'ll have <strong>10 seconds</strong> per card to say the Korean word.'}
      </p>

      <!-- Mode Selection -->
      <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
        <!-- Voice Mode Button -->
        <button onclick="swipeMode.enabled = false; walkAwayMode.enabled = false; startDay1Practice();" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${!swipeMode.enabled && !walkAwayMode.enabled ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f7fafc'}; 
                color: ${!swipeMode.enabled && !walkAwayMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${!swipeMode.enabled && !walkAwayMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Voice
        </button>
        <!-- Walk Away Mode Button -->
        <button onclick="swipeMode.enabled = false; walkAwayMode.enabled = true; startDay1Practice();" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${walkAwayMode.enabled ? 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)' : '#f7fafc'}; 
                color: ${walkAwayMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${walkAwayMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Walk Away
        </button>
        <!-- Swipe Mode Button -->
        <button onclick="swipeMode.enabled = true; walkAwayMode.enabled = false; startDay1Practice();" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${swipeMode.enabled ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : '#f7fafc'}; 
                color: ${swipeMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${swipeMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Swipe
        </button>
      </div>

      ${swipeMode.enabled ? `
      <div style="background: #fef3c7; border-radius: 10px; padding: 12px; margin-bottom: 15px; text-align: center;">
        <p style="color: #92400e; font-size: 13px; margin: 0;">
          <strong> Swipe Mode:</strong> Only 1 coin per correct answer (no voice required)
        </p>
      </div>
      ` : ''}

      <div style="background: #e0e7ff; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
        <p style="color: #3730a3; font-size: 13px; margin: 0;">
          <strong> Unlimited Today:</strong> Cards move to Day 2 when correct,
          but you can keep practicing them until midnight!
        </p>
      </div>

      <div style="background: #fef3c7; border-radius: 10px; padding: 12px; margin-bottom: 20px; text-align: left;">
        <p style="color: #92400e; font-size: 12px; margin: 0;">
          <strong> Tomorrow:</strong> Day 2 cards only get ONE chance per review!
        </p>
      </div>

      <button class="btn btn-secondary" onclick="beginLeitnerSession()" style="padding: 15px 40px; font-size: 18px;">
         Start Practice
      </button>
      <button class="btn" onclick="exitLeitnerReview()" style="margin-left: 10px; padding: 15px 30px; background: transparent; color: #718096; border: 2px solid #e2e8f0;">
        Cancel
      </button>
    </div>

    <div id="leitnerReviewInterface" style="display: none;"></div>
  `;
}

/**
 * Start reviewing scheduled due cards (Day 2+)
 * Excludes cards moved from Day 1 today (those are still in unlimited practice mode)
 */
function startScheduledReview() {
  const todayStr = new Date().toISOString().split('T')[0];
  const otherDueCards = leitnerDueCards.filter(c => c.box > 1 && c.movedFromDay1Date !== todayStr);

  if (otherDueCards.length === 0) {
    alert('No scheduled cards due for review!');
    return;
  }

  switchTab('leitnerReview');

  currentLeitnerQueue = [...otherDueCards];
  currentLeitnerIndex = 0;
  leitnerSessionStats = { correct: 0, incorrect: 0 };
  isPracticingDay1 = false;

  const container = document.getElementById('leitnerReviewContainer');
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <span style="background: #f56565; color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600;">
         Scheduled Review (${otherDueCards.length} cards)
      </span>
      <p style="color: #718096; font-size: 14px; margin-top: 10px;">
        Get them right to advance! Wrong answers go back to Day 1.
      </p>
    </div>

    <!-- Ready Screen - Show before starting mic -->
    <div id="leitnerReadyScreen" style="max-width: 500px; margin: 0 auto; text-align: center; padding: 40px 20px;">
      <div style="font-size: 80px; margin-bottom: 20px;"></div>
      <h3 style="color: #2d3748; margin-bottom: 15px;">Ready to Review?</h3>
      <p style="color: #718096; margin-bottom: 10px;">
        You'll have <strong>10 seconds</strong> per card to say the Korean word.
      </p>

      <!-- Walk Away Mode Toggle -->
      <div style="margin: 20px 0; padding: 15px; background: ${walkAwayMode.enabled ? 'linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%)' : '#f7fafc'}; border: 2px solid ${walkAwayMode.enabled ? '#48bb78' : '#e2e8f0'}; border-radius: 12px;">
        <button id="walkAwayModeBtn" onclick="toggleWalkAwayMode(); startScheduledReview();" style="background: linear-gradient(135deg, ${walkAwayMode.enabled ? '#48bb78 0%, #38b2ac' : '#667eea 0%, #764ba2'} 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 16px;">
           Walk Away Mode: ${walkAwayMode.enabled ? 'ON' : 'OFF'}
        </button>
        <p style="color: ${walkAwayMode.enabled ? '#276749' : '#718096'}; font-size: 13px; margin: 10px 0 0 0;">
          ${walkAwayMode.enabled ? ' English words will be spoken aloud. Listen and respond!' : 'Enable to hear words spoken aloud (hands-free practice)'}
        </p>
      </div>

      <button class="btn" onclick="beginLeitnerSession()" style="padding: 15px 40px; font-size: 18px; background: #f56565;">
         Start Review
      </button>
      <button class="btn" onclick="exitLeitnerReview()" style="margin-left: 10px; padding: 15px 30px; background: transparent; color: #718096; border: 2px solid #e2e8f0;">
        Cancel
      </button>
    </div>

    <div id="leitnerReviewInterface" style="display: none;"></div>
  `;
}

let isPracticingDay1 = false;

/**
 * Begin the Leitner session - starts mic and shows first card
 * Called after user clicks "Start Practice" on the ready screen
 */
function beginLeitnerSession() {
  startStudySession('flashcard');

  const readyScreen = document.getElementById('leitnerReadyScreen');
  if (readyScreen) readyScreen.style.display = 'none';

  document.getElementById('leitnerReviewInterface').style.display = 'block';

  showNextLeitnerCard();
}

/**
 * Show the next card in the Leitner review queue
 */
function showNextLeitnerCard() {
  const interface = document.getElementById('leitnerReviewInterface');

  stopLeitnerTimer();

  leitnerSecondChanceUsed = false;

  if (currentLeitnerIndex >= currentLeitnerQueue.length) {
    stopLeitnerRecognition();
    showLeitnerSessionComplete();
    return;
  }

  const card = currentLeitnerQueue[currentLeitnerIndex];
  isLeitnerCardFlipped = false;
  leitnerRecognizedText = '';

  leitnerTargetKorean = card.korean;
  leitnerIsProcessingMatch = false;

  interface.innerHTML = `
    <div style="max-width: 550px; margin: 0 auto; padding: 20px;">
      ${walkAwayMode.enabled ? `
        <div style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); border-radius: 8px; padding: 8px 15px; margin-bottom: 15px; text-align: center;">
          <span style="color: #276749; font-size: 13px; font-weight: 600;"> Walk Away Mode Active</span>
        </div>
      ` : ''}
      ${swipeMode.enabled ? `
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; padding: 8px 15px; margin-bottom: 15px; text-align: center;">
          <span style="color: #92400e; font-size: 13px; font-weight: 600;"> Swipe Mode Active (1 coin per correct)</span>
        </div>
      ` : ''}

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="color: #718096; font-size: 16px;">${currentLeitnerIndex + 1} / ${currentLeitnerQueue.length}</span>
        <span style="background: #f7fafc; padding: 6px 14px; border-radius: 20px; font-size: 14px; color: #4a5568;">
           ${LEITNER_BOX_NAMES[card.box]}
          ${card.lapseCount > 0 ? `<span style="color: #f56565; margin-left: 8px;"> ${card.lapseCount} lapses</span>` : ''}
        </span>
      </div>

      <!-- Timer Bar (hidden in swipe mode) -->
      <div style="margin-bottom: 20px; ${swipeMode.enabled ? 'display: none;' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <span style="font-size: 13px; color: #718096;"> Time remaining</span>
          <span id="leitnerTimerText" style="font-size: 16px; font-weight: bold; color: #667eea;">10</span>
        </div>
        <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
          <div id="leitnerTimerBar" style="height: 100%; width: 100%; background: linear-gradient(90deg, #48bb78 0%, #38b2ac 50%, #667eea 100%); transition: width 0.1s linear;"></div>
        </div>
      </div>

      <!-- Flashcard -->
      <div class="leitner-flashcard" id="leitnerCard" ${swipeMode.enabled ? 'onclick="flipLeitnerCardManual()"' : ''} style="position: relative;">
        ${card.box === 1 && window.currentDay1Interval === 'first' ? `
        <button onclick="event.stopPropagation(); openLeitnerEditModal('${card.id}')" 
          style="position: absolute; top: 10px; right: 10px; width: 44px; height: 44px; background: #f97316; border: none; border-radius: 10px; color: white; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);"
          title="Edit card before first practice"></button>
        ` : ''}
        <div class="leitner-flashcard-inner">
          <div class="leitner-flashcard-face leitner-flashcard-front">
            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">${swipeMode.enabled ? ' Tap to reveal answer:' : ' Say this in Korean:'}</div>
            <div style="font-size: ${card.english.length > 80 ? '20px' : card.english.length > 50 ? '24px' : card.english.length > 30 ? '28px' : '38px'}; font-weight: bold; line-height: 1.3; text-align: center; word-wrap: break-word; max-width: 100%;">${card.english}</div>
            ${!swipeMode.enabled ? `
            <div id="leitnerListeningIndicator" style="margin-top: 30px;">
              <div class="listening-pulse" style="width: 60px; height: 60px; background: #48bb78; border-radius: 50%; margin: 0 auto; animation: leitnerPulse 1.5s infinite;"></div>
              <div style="font-size: 14px; color: #48bb78; margin-top: 10px;"> Listening...</div>
            </div>
            ` : `
            <div style="margin-top: 30px; color: #718096; font-size: 14px;">
              Tap card to see answer, then mark correct or incorrect
            </div>
            `}
          </div>
          <div class="leitner-flashcard-face leitner-flashcard-back">
            <div style="font-size: 14px; color: #718096; margin-bottom: 15px;">Correct answer:</div>
            <div style="font-size: ${card.korean.length > 40 ? '24px' : card.korean.length > 20 ? '32px' : '42px'}; font-weight: bold; color: #667eea; line-height: 1.3; text-align: center; word-wrap: break-word; max-width: 100%;">${card.korean}</div>
            <div id="leitnerYourAnswer" style="margin-top: 20px; font-size: 14px; color: #718096;"></div>
          </div>
        </div>
      </div>

      <!-- Recognition Status (hidden in swipe mode) -->
      <div id="leitnerRecognitionStatus" style="text-align: center; margin: 20px 0; min-height: 60px; ${swipeMode.enabled ? 'display: none;' : ''}">
        <p style="color: #718096; font-size: 14px;">Speak the Korean word...</p>
        <p id="leitnerRecognizedText" style="font-size: 20px; color: #2d3748; font-weight: 600; margin-top: 10px;"></p>
      </div>

      <!-- Swipe Mode Buttons (shown in swipe mode after flip) -->
      <div id="leitnerSwipeButtons" style="display: none; text-align: center; margin: 20px 0;">
        <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">Did you know the answer?</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button onclick="submitLeitnerAnswer(true)" style="flex: 1; max-width: 150px; padding: 15px 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Correct
          </button>
          <button onclick="submitLeitnerAnswer(false)" style="flex: 1; max-width: 150px; padding: 15px 20px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Wrong
          </button>
        </div>
      </div>

      <!-- Answer Buttons (shown after flip - only for wrong answers in voice mode) -->
      <div id="leitnerAnswerBtns" style="display: none; text-align: center;">
        <div class="leitner-answer-btns">
          <button class="incorrect-btn" onclick="submitLeitnerAnswer(false)"> Try Again (Move to next card)</button>
        </div>
      </div>

      <!-- Manual Controls -->
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        ${!swipeMode.enabled ? `
        <button class="btn" onclick="skipLeitnerCard()" style="background: #fed7d7; color: #c53030; padding: 10px 20px;">
          Skip (Wrong)
        </button>
        ` : ''}
        <button class="btn" onclick="exitLeitnerReview()" style="background: transparent; color: #a0aec0; border: 2px solid #e2e8f0; padding: 10px 20px;">
          Exit
        </button>
      </div>
    </div>
  `;

  if (!swipeMode.enabled) {
    startLeitnerTimer();

    if (!leitnerIsListening) {
      startLeitnerRecognition(card.korean);
    }

    if (walkAwayMode.enabled) {
      setTimeout(() => {
        speakEnglish(card.english);
      }, 300);
    }
  }
}

function flipLeitnerCardManual() {
  if (!swipeMode.enabled) return;
  const card = document.getElementById('leitnerCard');
  if (card && !card.classList.contains('flipped')) {
    card.classList.add('flipped');
    document.getElementById('leitnerSwipeButtons').style.display = 'block';
  }
}

// Open edit modal for Day 1 Leitner card
function openLeitnerEditModal(cardId) {
  // Pause timer and recognition while editing
  stopLeitnerTimer();
  stopLeitnerRecognition();
  
  const card = leitnerCards.find(c => c.id === cardId);
  if (!card) return;
  
  const modal = document.createElement('div');
  modal.id = 'leitnerEditModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    padding: 20px;
  `;
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 25px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; color: #1a202c; font-size: 18px;"> Edit Card</h3>
        <button onclick="closeLeitnerEditModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #a0aec0;"></button>
      </div>
      
      <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 10px; padding: 12px; margin-bottom: 20px;">
        <div style="font-weight: 600; color: #c2410c; font-size: 13px; margin-bottom: 8px;">Edit before you begin</div>
        <ul style="margin: 0; padding-left: 18px; color: #9a3412; font-size: 12px; line-height: 1.6;">
          <li>Numbers are recognized as digits (1, 2, 3) not words</li>
          <li>Shorten long sentences for easier practice</li>
          <li>Fix spelling or spacing errors</li>
        </ul>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #fed7aa; color: #c2410c; font-size: 11px;">
           After your first practice, this card becomes locked.
        </div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px;">English</label>
        <input type="text" id="leitnerEditEnglish" value="${card.english.replace(/"/g, '&quot;')}" 
          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px;">Korean</label>
        <input type="text" id="leitnerEditKorean" value="${card.korean.replace(/"/g, '&quot;')}" 
          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button onclick="closeLeitnerEditModal()" 
          style="flex: 1; padding: 12px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #4a5568; cursor: pointer;">
          Cancel
        </button>
        <button onclick="saveLeitnerCardEdit('${cardId}')" 
          style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none; border-radius: 8px; font-size: 14px; font-weight: 600; color: white; cursor: pointer;">
          Save Changes
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focus on Korean field
  setTimeout(() => {
    document.getElementById('leitnerEditKorean').focus();
  }, 100);
}

// Close the edit modal
function closeLeitnerEditModal() {
  const modal = document.getElementById('leitnerEditModal');
  if (modal) modal.remove();
  
  // Resume the card review
  const card = currentLeitnerQueue[currentLeitnerIndex];
  if (card && !swipeMode.enabled) {
    startLeitnerTimer();
    startLeitnerRecognition(card.korean);
  }
}

// Save the edited card
async function saveLeitnerCardEdit(cardId) {
  const english = document.getElementById('leitnerEditEnglish').value.trim();
  const korean = document.getElementById('leitnerEditKorean').value.trim();
  
  if (!english || !korean) {
    showToast(' Both fields are required');
    return;
  }
  
  try {
    // Update in Firestore - collection is leitnerProgress
    await db.collection('leitnerProgress').doc(cardId).update({
      english: english,
      korean: korean,
      editedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Update local cache
    const cardIndex = leitnerCards.findIndex(c => c.id === cardId);
    if (cardIndex !== -1) {
      leitnerCards[cardIndex].english = english;
      leitnerCards[cardIndex].korean = korean;
    }
    
    // Update current queue
    const queueIndex = currentLeitnerQueue.findIndex(c => c.id === cardId);
    if (queueIndex !== -1) {
      currentLeitnerQueue[queueIndex].english = english;
      currentLeitnerQueue[queueIndex].korean = korean;
    }
    
    showToast(' Card updated!');
    
    // Close modal without restarting recognition (we'll do that after re-render)
    const modal = document.getElementById('leitnerEditModal');
    if (modal) modal.remove();
    
    // Update the target Korean for voice recognition
    leitnerTargetKorean = korean;
    
    // Re-render the current card with new values
    showNextLeitnerCard();
    
  } catch (error) {
    console.error('Error updating card:', error);
    showToast(' Failed to update card');
  }
}

let leitnerRecognition = null;
let leitnerIsListening = false;
let leitnerTimer = null;
let leitnerTimeRemaining = 10;
let leitnerRecognizedText = '';
let leitnerSecondChanceUsed = false; // Track if second chance was used for current card

/**
 * Start the 10-second timer for Leitner review
 */
function startLeitnerTimer() {
  leitnerTimeRemaining = 10;
  updateLeitnerTimerDisplay();

  leitnerTimer = setInterval(() => {
    leitnerTimeRemaining -= 0.1;
    updateLeitnerTimerDisplay();

    if (leitnerTimeRemaining <= 0) {
      stopLeitnerTimer();
      leitnerTimeUp();
    }
  }, 100);
}

/**
 * Update the timer display
 */
function updateLeitnerTimerDisplay() {
  const timerText = document.getElementById('leitnerTimerText');
  const timerBar = document.getElementById('leitnerTimerBar');

  if (timerText) {
    timerText.textContent = Math.ceil(leitnerTimeRemaining);

    if (leitnerTimeRemaining <= 3) {
      timerText.style.color = '#f56565';
    } else if (leitnerTimeRemaining <= 5) {
      timerText.style.color = '#ed8936';
    }
  }

  if (timerBar) {
    const percentage = (leitnerTimeRemaining / 10) * 100;
    timerBar.style.width = percentage + '%';

    if (leitnerTimeRemaining <= 3) {
      timerBar.style.background = '#f56565';
    } else if (leitnerTimeRemaining <= 5) {
      timerBar.style.background = '#ed8936';
    }
  }
}

/**
 * Stop the Leitner timer
 */
function stopLeitnerTimer() {
  if (leitnerTimer) {
    clearInterval(leitnerTimer);
    leitnerTimer = null;
  }
}

/**
 * Handle time up (incorrect answer)
 */
function leitnerTimeUp() {
  const card = currentLeitnerQueue[currentLeitnerIndex];
  if (!card) {
    showNextLeitnerCard();
    return;
  }

  if (card.box >= 3 && !leitnerSecondChanceUsed) {
    leitnerSecondChanceUsed = true;

    stopLeitnerTimer();

    const statusEl = document.getElementById('leitnerRecognitionStatus');
    if (statusEl) {
      statusEl.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.15) 0%, rgba(118,75,162,0.15) 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 32px; margin-bottom: 10px;"></div>
          <p style="color: #5a67d8; font-size: 16px; font-weight: 600; margin: 0 0 10px 0;">Second Chance!</p>
          <p style="color: #667eea; font-size: 14px; margin: 0 0 15px 0;">Think real hard and really sit on it.</p>
          <p style="color: #718096; font-size: 13px; font-style: italic; margin: 0;">This "brain fart" moment is key to retaining information long-term.</p>
          <p style="color: #48bb78; font-size: 14px; font-weight: 600; margin-top: 15px;">Take your time  no timer!</p>
        </div>
      `;
    }

    const timerText = document.getElementById('leitnerTimerText');
    if (timerText) {
      timerText.textContent = '';
      timerText.style.color = '#48bb78';
    }

    const timerBar = document.getElementById('leitnerTimerBar');
    if (timerBar) {
      timerBar.style.width = '100%';
      timerBar.style.background = '#48bb78';
    }

    return;
  }

  playWalkAwaySound('timeup');

  isLeitnerCardFlipped = true;
  const cardEl = document.getElementById('leitnerCard');
  if (cardEl) {
    cardEl.classList.add('flipped');
  }

  const yourAnswerEl = document.getElementById('leitnerYourAnswer');
  if (yourAnswerEl) {
    yourAnswerEl.innerHTML = `<span style="color: #f56565;"> Time's up!</span>`;
  }

  const statusEl = document.getElementById('leitnerRecognitionStatus');
  if (statusEl) {
    statusEl.innerHTML = `
      <p style="color: #f56565; font-size: 16px; font-weight: 600;"> Time's up!</p>
      <p style="color: #718096; font-size: 14px; margin-top: 5px;">The correct answer was: <strong style="color: #667eea;">${card.korean}</strong></p>
      <p id="autoAdvanceMsg" style="color: #48bb78; font-size: 13px; margin-top: 15px;">Moving to next card in <strong>2</strong>...</p>
    `;
  }

  speakKorean(card.korean);

  setTimeout(() => {
    const msg = document.getElementById('autoAdvanceMsg');
    if (msg) msg.innerHTML = 'Moving to next card in <strong>1</strong>...';
  }, 1000);

  setTimeout(() => {
    submitLeitnerAnswer(false);
  }, 2000);
}

/**
 * Start voice recognition for Leitner review
 */
let leitnerTargetKorean = '';
let leitnerIsProcessingMatch = false;

function startLeitnerRecognition(targetKorean) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  leitnerTargetKorean = targetKorean;
  leitnerIsProcessingMatch = false;

  if (!leitnerRecognition) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    leitnerRecognition = new SpeechRecognition();
    leitnerRecognition.lang = 'ko-KR';
    leitnerRecognition.continuous = true;
    leitnerRecognition.interimResults = true;

    leitnerRecognition.onresult = (event) => {
      if (leitnerIsProcessingMatch) return;

      const latestResultIndex = event.results.length - 1;
      const latestResult = event.results[latestResultIndex];
      const transcript = latestResult[0].transcript.trim();

      leitnerRecognizedText = transcript;

      const recognizedEl = document.getElementById('leitnerRecognizedText');
      if (recognizedEl) {
        recognizedEl.textContent = leitnerRecognizedText;
      }

      if (!latestResult.isFinal) {
        return;
      }


      const targetClean = normalizeKoreanForVoice(leitnerTargetKorean);
      const transcriptClean = normalizeKoreanForVoice(transcript);


      const similarity = calculateSimilarity(transcriptClean, targetClean);

      if (similarity >= 0.90) {
        leitnerIsProcessingMatch = true;
        stopLeitnerTimer();
        leitnerVoiceCorrect();
      } else if (transcriptClean.length > 0) {
        playWalkAwaySound('wrong');

        const statusEl = document.getElementById('leitnerRecognitionStatus');
        if (statusEl && walkAwayMode.enabled) {
          statusEl.innerHTML = `
            <p style="color: #f56565; font-size: 14px;"> Try again!</p>
            <p id="leitnerRecognizedText" style="font-size: 20px; color: #2d3748; font-weight: 600; margin-top: 10px;">${transcript}</p>
          `;
        }
      }
    };

    leitnerRecognition.onerror = (event) => {
    };

    leitnerRecognition.onend = () => {
      if (leitnerIsListening && leitnerTimeRemaining > 0 && !leitnerIsProcessingMatch) {
        setTimeout(() => {
          if (leitnerIsListening && leitnerTimeRemaining > 0) {
            try {
              leitnerRecognition.start();
            } catch (e) {
            }
          }
        }, 300);
      }
    };
  }

  try {
    leitnerRecognition.start();
    leitnerIsListening = true;
  } catch (e) {
  }
}

/**
 * Stop Leitner voice recognition
 */
function stopLeitnerRecognition() {
  leitnerIsListening = false;
  leitnerIsProcessingMatch = false;
  if (leitnerRecognition) {
    try {
      leitnerRecognition.stop();
    } catch (e) {}
  }
}

/**
 * Handle correct voice answer
 */
function leitnerVoiceCorrect() {
  const card = currentLeitnerQueue[currentLeitnerIndex];
  if (!card) {
    showNextLeitnerCard();
    return;
  }

  stopLeitnerTimer();

  playWalkAwaySound('correct');

  isLeitnerCardFlipped = true;
  const cardEl = document.getElementById('leitnerCard');
  if (cardEl) cardEl.classList.add('flipped');

  const yourAnswerEl = document.getElementById('leitnerYourAnswer');
  if (yourAnswerEl) {
    yourAnswerEl.innerHTML = `<span style="color: #48bb78;"> You said: ${leitnerRecognizedText}</span>`;
  }

  const wasSecondChance = leitnerSecondChanceUsed;

  const statusEl = document.getElementById('leitnerRecognitionStatus');
  if (statusEl) {
    if (wasSecondChance) {
      statusEl.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(72,187,120,0.15) 0%, rgba(56,178,172,0.15) 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 32px; margin-bottom: 10px;"></div>
          <p style="color: #48bb78; font-size: 18px; font-weight: 700; margin: 0 0 10px 0;">Amazing Work!</p>
          <p style="color: #38a169; font-size: 14px; margin: 0;">You worked hard to retrieve that information.</p>
          <p style="color: #718096; font-size: 12px; margin-top: 10px; font-style: italic;">This struggle strengthens your memory!</p>
        </div>
      `;
    } else {
      statusEl.innerHTML = `
        <p style="color: #48bb78; font-size: 20px; font-weight: 600;"> Correct!</p>
        <p id="autoAdvanceMsg" style="color: #48bb78; font-size: 13px; margin-top: 10px;">Moving to next card...</p>
      `;
    }
  }

  speakKorean(card.korean);

  setTimeout(() => {
    submitLeitnerAnswer(true);
  }, wasSecondChance ? 2500 : 1500);
}

/**
 * Skip current Leitner card (mark as wrong)
 */
function skipLeitnerCard() {
  stopLeitnerTimer();
  submitLeitnerAnswer(false);
}

/**
 * Flip the Leitner flashcard to reveal the answer (manual flip = wrong answer)
 */
function flipLeitnerCard() {
  if (isLeitnerCardFlipped) return;

  stopLeitnerTimer();

  const card = currentLeitnerQueue[currentLeitnerIndex];
  if (!card) {
    showNextLeitnerCard();
    return;
  }

  isLeitnerCardFlipped = true;
  const cardEl = document.getElementById('leitnerCard');
  if (cardEl) cardEl.classList.add('flipped');

  const statusEl = document.getElementById('leitnerRecognitionStatus');
  if (statusEl) {
    statusEl.innerHTML = `
      <p style="color: #f56565; font-size: 16px; font-weight: 600;"> Incorrect</p>
      <p style="color: #718096; font-size: 14px; margin-top: 5px;">The correct answer was: <strong style="color: #667eea;">${card.korean}</strong></p>
      <p id="autoAdvanceMsg" style="color: #48bb78; font-size: 13px; margin-top: 15px;">Moving to next card in <strong>2</strong>...</p>
    `;
  }

  speakKorean(card.korean);

  setTimeout(() => {
    const msg = document.getElementById('autoAdvanceMsg');
    if (msg) msg.innerHTML = 'Moving to next card in <strong>1</strong>...';
  }, 1000);

  setTimeout(() => {
    submitLeitnerAnswer(false);
  }, 2000);
}

/**
 * Submit answer and move to next card
 */
async function submitLeitnerAnswer(isCorrect) {
  const card = currentLeitnerQueue[currentLeitnerIndex];

  if (!card) {
    currentLeitnerIndex++;
    showNextLeitnerCard();
    return;
  }

  document.querySelectorAll('.leitner-answer-btns button').forEach(btn => btn.disabled = true);

  await handleLeitnerReview(card.id, isCorrect);

  currentLeitnerIndex++;

  setTimeout(showNextLeitnerCard, 300);
}

/**
 * Show session complete screen
 */
function showLeitnerSessionComplete() {
  endStudySession();

  stopLeitnerRecognition();

  const interface = document.getElementById('leitnerReviewInterface');
  const total = leitnerSessionStats.correct + leitnerSessionStats.incorrect;
  const accuracy = total > 0 ? Math.round(leitnerSessionStats.correct / total * 100) : 0;

  awardCoins(20, 'Flashcard Drill');
  recordPracticeActivity('flashcard');
  
  if (typeof trackDailyProgress === 'function') {
    trackDailyProgress('activity', 1);
  }

  if (accuracy === 100 && total > 0) {
    awardCoins(20, 'Perfect Flashcard Session');
  }

  if (allInOneState.isActive && allInOneState.currentPhase === 'flashcard') {
    interface.innerHTML = `
      <div class="leitner-session-complete">
        <div class="trophy">${accuracy >= 80 ? '' : accuracy >= 60 ? '' : ''}</div>
        <h2 style="color: #2d3748; margin-bottom: 10px;">Flashcard Session Complete!</h2>
        <p style="color: #718096;">Great work on your review!</p>

        <div class="stats">
          <div class="stat-item">
            <div class="value" style="color: #48bb78;">${leitnerSessionStats.correct}</div>
            <div class="label">Correct</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #f56565;">${leitnerSessionStats.incorrect}</div>
            <div class="label">Incorrect</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #667eea;">${accuracy}%</div>
            <div class="label">Accuracy</div>
          </div>
        </div>

        ${walkAwayMode.enabled ? `
          <div id="handsFreeContinueStatus" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; border-radius: 12px;">
            <p style="color: #6b46c1; font-size: 14px; margin: 0;">
               <strong>Listening...</strong> Say "Yes" to continue to next phase
            </p>
          </div>
        ` : ''}

        <div style="margin-top: 25px;">
          <button class="btn" onclick="completeAllInOnePhase('flashcard')" style="padding: 15px 40px; background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); font-size: 16px;">
             Continue to Next Phase
          </button>
        </div>
      </div>
    `;

    if (walkAwayMode.enabled) {
      setTimeout(() => {
        startHandsFreeContinuation(
          () => { completeAllInOnePhase('flashcard'); }, // onYes
          () => {
            const statusEl = document.getElementById('handsFreeContinueStatus');
            if (statusEl) {
              statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                No response detected. Click the button to continue.
              </p>`;
            }
          } // onNo
        );
      }, 1000);
    }

    loadLeitnerData();
    return;
  }

  const todayStr = new Date().toISOString().split('T')[0];
  const day1Cards = leitnerCards.filter(c => c.box === 1);
  const movedTodayCards = leitnerCards.filter(c => c.box === 2 && c.movedFromDay1Date === todayStr);
  const allDay1Practicable = [...day1Cards, ...movedTodayCards];
  const otherDueCards = leitnerDueCards.filter(c => c.box > 1 && c.movedFromDay1Date !== todayStr);

  const hasMoreToReview = allDay1Practicable.length > 0 || otherDueCards.length > 0;

  if (walkAwayMode.enabled && hasMoreToReview) {
    interface.innerHTML = `
      <div class="leitner-session-complete">
        <div class="trophy">${accuracy >= 80 ? '' : accuracy >= 60 ? '' : ''}</div>
        <h2 style="color: #2d3748; margin-bottom: 10px;">Session Complete!</h2>
        <p style="color: #718096;">Great work! Moving to next batch...</p>

        <div class="stats">
          <div class="stat-item">
            <div class="value" style="color: #48bb78;">${leitnerSessionStats.correct}</div>
            <div class="label">Correct</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #f56565;">${leitnerSessionStats.incorrect}</div>
            <div class="label">Incorrect</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #667eea;">${accuracy}%</div>
            <div class="label">Accuracy</div>
          </div>
        </div>

        <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
          <p style="color: #6b46c1; font-size: 14px; margin: 0;">
             <strong>Auto-continuing...</strong> Starting next batch in 3 seconds
          </p>
        </div>
      </div>
    `;

    loadLeitnerData().then(() => {
      setTimeout(() => {
        if (allDay1Practicable.length > 0) {
          startDay1Practice();
        } else if (otherDueCards.length > 0) {
          startScheduledReview();
        }
      }, 3000); // 3 second delay before starting next batch
    });

    return;
  }

  if (walkAwayMode.enabled && !hasMoreToReview) {
    interface.innerHTML = `
      <div class="leitner-session-complete">
        <div class="trophy"></div>
        <h2 style="color: #2d3748; margin-bottom: 10px;">All Reviews Complete!</h2>
        <p style="color: #48bb78; font-weight: 600;">You've finished all your Leitner reviews for today!</p>

        <div class="stats">
          <div class="stat-item">
            <div class="value" style="color: #48bb78;">${leitnerSessionStats.correct}</div>
            <div class="label">Correct</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #f56565;">${leitnerSessionStats.incorrect}</div>
            <div class="label">Incorrect</div>
          </div>
          <div class="stat-item">
            <div class="value" style="color: #667eea;">${accuracy}%</div>
            <div class="label">Accuracy</div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <button class="btn btn-secondary" onclick="exitLeitnerReview()" style="padding: 12px 30px;">
             Done
          </button>
        </div>
      </div>
    `;

    loadLeitnerData();
    return;
  }

  const continuationMessage = 'Repeat Day 1 practice';
  const continuationAction = () => startDay1Practice();
  const continuationButtonText = ' Practice Day 1 Again';
  const hasContinuation = true; // Always offer to practice again

  interface.innerHTML = `
    <div class="leitner-session-complete">
      <div class="trophy">${accuracy >= 80 ? '' : accuracy >= 60 ? '' : ''}</div>
      <h2 style="color: #2d3748; margin-bottom: 10px;">Session Complete!</h2>
      <p style="color: #718096;">Great work on your review!</p>

      <div class="stats">
        <div class="stat-item">
          <div class="value" style="color: #48bb78;">${leitnerSessionStats.correct}</div>
          <div class="label">Correct</div>
        </div>
        <div class="stat-item">
          <div class="value" style="color: #f56565;">${leitnerSessionStats.incorrect}</div>
          <div class="label">Incorrect</div>
        </div>
        <div class="stat-item">
          <div class="value" style="color: #667eea;">${accuracy}%</div>
          <div class="label">Accuracy</div>
        </div>
      </div>

      <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 15px; border-radius: 12px; margin: 20px 0; max-width: 400px; margin-left: auto; margin-right: auto;">
        <p style="color: #92400e; font-size: 14px; margin: 0;">
          <strong> Keep going!</strong> Practice Day 1 again to reinforce your learning.
        </p>
      </div>

      <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button id="continuationBtn" class="btn" style="padding: 12px 30px; background: #48bb78;">
           Practice Day 1 Again
        </button>
        <button class="btn btn-secondary" onclick="exitLeitnerReview()" style="padding: 12px 30px;">
          Done
        </button>
      </div>
    </div>
  `;

  const continuationBtn = document.getElementById('continuationBtn');
  if (continuationBtn) {
    continuationBtn.onclick = continuationAction;
  }

  loadLeitnerData();
}

/**
 * Practice the same set of cards again (only for Day 1)
 */
function practiceAgain() {
  startDay1Practice();
}

/**
 * Exit Leitner review and return to main view
 */
function exitLeitnerReview() {
  stopLeitnerTimer();
  stopLeitnerRecognition();
  
  // Switch back to the calendar page with the brains
  switchTab('leitnerBoxes');
}

/**
 * Render the Leitner Box grid
 */
function renderLeitnerBoxGrid() {
  const container = document.getElementById('leitnerBoxGrid');
  if (!container) return;

  document.getElementById('leitnerBoxDetail').style.display = 'none';
  container.style.display = 'grid';

  const boxCounts = {};
  const dueCounts = {};
  const nextDueDate = {}; // Track next due date for each box

  for (let i = 1; i <= 8; i++) {
    const boxCards = leitnerCards.filter(c => c.box === i);
    boxCounts[i] = boxCards.length;
    dueCounts[i] = leitnerDueCards.filter(c => c.box === i).length;

    const notDueCards = boxCards.filter(c => {
      const isDue = leitnerDueCards.some(dc => dc.id === c.id);
      return !isDue && c.nextReviewDate;
    });

    if (notDueCards.length > 0) {
      const dates = notDueCards.map(c => {
        const date = c.nextReviewDate?.toDate ? c.nextReviewDate.toDate() : new Date(c.nextReviewDate);
        return date;
      }).sort((a, b) => a - b);
      nextDueDate[i] = dates[0];
    }
  }

  renderDay1Intervals(boxCounts[1] || 0);

  if (leitnerCards.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1 / -1;">
        <div class="leitner-empty-state">
          <div class="icon"></div>
          <h3>Your Leitner Box is empty</h3>
          <p>Play Flashcard Games and cards you get wrong will appear here organized by review interval.</p>
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = Object.entries(LEITNER_BOX_NAMES).map(([box, name]) => {
    const boxNum = parseInt(box);
    const count = boxCounts[boxNum] || 0;
    const due = dueCounts[boxNum] || 0;
    const cssClass = LEITNER_BOX_CLASSES[boxNum];
    const isDay1 = boxNum === 1;
    const isMastery = boxNum === 8;
    const brainData = LEITNER_BRAIN_DATA[boxNum];

    let dueIndicator = '';
    if (due > 0 && boxNum < 8) {
      const shakeClass = boxNum === 7 ? 'shake' : '';
      dueIndicator = `<div class="leitner-due-indicator ${shakeClass}">!</div>`;
    }

    const brainIcon = `
      <button class="brain-icon-btn"
              onclick="event.stopPropagation(); showBrainPopup(${boxNum})"
              style="color: ${brainData.color}; border-color: ${brainData.color};"
              title="Learn about this stage">
        ${brainData.emoji}
      </button>
    `;

    let practiceButton = '';
    if (count > 0 && !isMastery) {
      practiceButton = `
        <button onclick="event.stopPropagation(); startBoxPractice(${boxNum})"
                class="btn btn-secondary"
                style="margin-top: 10px; padding: 6px 12px; font-size: 12px;">
          Practice (${count})
        </button>
      `;
    }

    let statusText = '';
    if (isDay1 && count > 0) {
      statusText = `<div style="font-size: 11px; color: #667eea; margin-top: 5px;">Practice anytime!</div>`;
    } else if (isMastery) {
      statusText = `<div style="font-size: 11px; color: #9f7aea; margin-top: 5px;">Completed!</div>`;
    } else if (due > 0) {
    } else if (count > 0 && nextDueDate[boxNum]) {
      const dueDate = nextDueDate[boxNum];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      let dateStr;
      if (dueDate.toDateString() === today.toDateString()) {
        dateStr = 'Today';
      } else if (dueDate.toDateString() === tomorrow.toDateString()) {
        dateStr = 'Tomorrow';
      } else {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        dateStr = `${monthNames[dueDate.getMonth()]} ${dueDate.getDate()}`;
      }
      statusText = `<div style="font-size: 11px; color: #a0aec0; margin-top: 5px;"> Due: ${dateStr}</div>`;
    }

    return `
      <div class="leitner-box-card ${cssClass}" onclick="startBoxPractice(${boxNum})">
        ${brainIcon}
        ${dueIndicator}
        <div class="box-label">${name}</div>
        <div class="box-count">${count}</div>
        ${due > 0 && !isMastery ? `<div class="box-due">${due} due</div>` : ''}
        ${statusText}
        ${practiceButton}
      </div>
    `;
  }).join('');
}

/**
 * Render Day 1 mini-intervals (30 min, 2 hours, before sleep)
 */
function renderDay1Intervals(day1CardCount) {
  const section = document.getElementById('day1IntervalsSection');
  const grid = document.getElementById('day1IntervalsGrid');

  if (!section || !grid) return;

  if (day1CardCount === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';

  const day1Cards = leitnerCards.filter(c => c.box === 1);
  const now = new Date();
  const currentHour = now.getHours();

  let earliestFirstPractice = null;
  day1Cards.forEach(card => {
    if (card.day1Intervals?.first) {
      const firstTime = card.day1Intervals.first?.toDate ? card.day1Intervals.first.toDate() : new Date(card.day1Intervals.first);
      if (!earliestFirstPractice || firstTime < earliestFirstPractice) {
        earliestFirstPractice = firstTime;
      }
    }
  });

  const minutesSinceFirst = earliestFirstPractice ? (now - earliestFirstPractice) / (1000 * 60) : 0;

  const intervals = [
    { id: 'first', label: 'First Practice', icon: '1', desc: 'Initial recall' },
    { id: 'thirtyMin', label: '30 Min Later', icon: '', desc: '30 minutes after' },
    { id: 'twoHours', label: '2 Hours Later', icon: '', desc: '2 hours after' },
    { id: 'beforeSleep', label: 'Before Sleep', icon: '', desc: '8PM - Midnight' }
  ];

  grid.innerHTML = intervals.map(interval => {
    const completedCount = day1Cards.filter(c => {
      const intervals = c.day1Intervals || {};
      return intervals[interval.id] != null;
    }).length;

    const percentage = day1CardCount > 0 ? Math.round((completedCount / day1CardCount) * 100) : 0;
    const isComplete = percentage === 100;
    const hasProgress = completedCount > 0;

    let isReady = false;
    if (!isComplete && earliestFirstPractice) {
      if (interval.id === 'first') {
        isReady = completedCount < day1CardCount;
      } else if (interval.id === 'thirtyMin') {
        isReady = minutesSinceFirst >= 25;
      } else if (interval.id === 'twoHours') {
        isReady = minutesSinceFirst >= 90;
      } else if (interval.id === 'beforeSleep') {
        isReady = currentHour >= 20 && currentHour <= 23;
      }
    } else if (interval.id === 'first' && !earliestFirstPractice) {
      isReady = true;
    } else if (interval.id === 'beforeSleep' && !isComplete) {
      isReady = currentHour >= 20 && currentHour <= 23;
    }

    let bgColor, borderColor, statusIcon, statusText;

    if (isComplete) {
      bgColor = 'rgba(72,187,120,0.2)';
      borderColor = '#48bb78';
      statusIcon = '';
      statusText = `${completedCount}/${day1CardCount} (${percentage}%)`;
    } else if (isReady) {
      bgColor = 'rgba(245,101,101,0.2)';
      borderColor = '#f56565';
      statusIcon = '';
      statusText = 'Ready!';
    } else if (hasProgress) {
      bgColor = 'rgba(237,137,54,0.2)';
      borderColor = '#ed8936';
      statusIcon = '';
      statusText = `${completedCount}/${day1CardCount} (${percentage}%)`;
    } else {
      bgColor = 'rgba(255,255,255,0.8)';
      borderColor = '#e2e8f0';
      statusIcon = '';
      statusText = 'Waiting...';
    }

    const shakeAnimation = isReady ? 'animation: day1Shake 0.5s ease-in-out infinite;' : '';

    return `
      <div onclick="practiceDay1Interval('${interval.id}')"
           style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; ${shakeAnimation}"
           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
        ${isReady ? '<div style="position: absolute; top: -8px; right: -8px; background: #f56565; color: white; font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">Ready!</div>' : ''}
        <div style="font-size: 24px; margin-bottom: 8px;">${interval.icon}</div>
        <div style="font-size: 13px; font-weight: 600; color: ${isReady ? '#c53030' : '#2d3748'}; margin-bottom: 4px;">${interval.label}</div>
        <div style="font-size: 11px; color: #718096; margin-bottom: 8px;">${interval.desc}</div>
        <div style="font-size: 12px; color: ${isComplete ? '#48bb78' : isReady ? '#c53030' : hasProgress ? '#ed8936' : '#a0aec0'}; font-weight: ${isReady ? 'bold' : 'normal'};">
          ${statusIcon} ${statusText}
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Practice Day 1 cards for a specific interval
 */
function practiceDay1Interval(intervalId) {
  const day1Cards = leitnerCards.filter(c => c.box === 1);

  if (day1Cards.length === 0) {
    alert('No Day 1 cards to practice!');
    return;
  }

  window.currentDay1Interval = intervalId;

  startDay1Practice();
}

/**
 * Show brain system popup for a Leitner box
 */
function showBrainPopup(boxNum) {
  const data = LEITNER_BRAIN_DATA[boxNum];
  const boxName = LEITNER_BOX_NAMES[boxNum];

  const brainSvg = `
    <svg viewBox="0 0 100 80" style="width: 150px; height: 100px;">
      <!-- Brain outline -->
      <ellipse cx="50" cy="40" rx="45" ry="35" fill="#f7fafc" stroke="#cbd5e0" stroke-width="2"/>

      <!-- Hippocampus (center-bottom) -->
      <ellipse cx="50" cy="55" rx="12" ry="8"
        fill="${data.regions.includes('hippocampus') ? data.color : '#e2e8f0'}"
        opacity="${data.regions.includes('hippocampus') ? '0.8' : '0.3'}"/>

      <!-- Neocortex (top) -->
      <path d="M 20 30 Q 50 5 80 30"
        stroke="${data.regions.includes('neocortex') || data.regions.includes('neocortex-early') ? data.color : '#e2e8f0'}"
        stroke-width="8" fill="none" stroke-linecap="round"
        opacity="${data.regions.includes('neocortex') || data.regions.includes('neocortex-early') ? '0.8' : '0.3'}"/>

      <!-- Frontal (front-left) -->
      <ellipse cx="25" cy="35" rx="10" ry="12"
        fill="${data.regions.includes('frontal') ? data.color : '#e2e8f0'}"
        opacity="${data.regions.includes('frontal') ? '0.8' : '0.3'}"/>

      <!-- Temporal (side) -->
      <ellipse cx="75" cy="45" rx="10" ry="8"
        fill="${data.regions.includes('temporal') ? data.color : '#e2e8f0'}"
        opacity="${data.regions.includes('temporal') ? '0.8' : '0.3'}"/>

      <!-- Basal Ganglia (center) -->
      <circle cx="50" cy="40" r="8"
        fill="${data.regions.includes('basal-ganglia') ? data.color : '#e2e8f0'}"
        opacity="${data.regions.includes('basal-ganglia') ? '0.8' : '0.3'}"/>

      <!-- Cerebellum (back-bottom) -->
      <ellipse cx="50" cy="68" rx="15" ry="8"
        fill="${data.regions.includes('cerebellum') ? data.color : '#e2e8f0'}"
        opacity="${data.regions.includes('cerebellum') ? '0.8' : '0.3'}"/>
    </svg>
  `;

  const failureRateBadge = data.failureRate ? `
    <div style="background: rgba(245,101,101,0.1); border: 1px solid #f56565; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 16px;"></span>
        <div>
          <div style="font-size: 11px; color: #718096;">Typical Failure Rate (Research)</div>
          <div style="font-size: 16px; font-weight: bold; color: #f56565;">${data.failureRate}</div>
        </div>
      </div>
    </div>
  ` : '';

  const researchTip = data.researchTip ? `
    <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border: 1px solid #667eea; border-radius: 8px; padding: 12px; margin-top: 15px;">
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <span style="font-size: 16px;"></span>
        <div style="font-size: 12px; color: #5a67d8; line-height: 1.5;">
          ${data.researchTip}
        </div>
      </div>
    </div>
  ` : '';

  const popupHtml = `
    <div class="brain-popup-overlay" onclick="if(event.target === this) closeBrainPopup()">
      <div class="brain-popup">
        <button class="brain-popup-close" onclick="closeBrainPopup()"></button>

        <div class="brain-popup-header">
          <div class="brain-popup-icon" style="background: ${data.color}20; color: ${data.color};">
            ${data.emoji}
          </div>
          <div>
            <div class="brain-popup-title">${boxName}</div>
            <div class="brain-popup-subtitle">Brain System Map</div>
          </div>
        </div>

        <div class="brain-diagram">
          ${brainSvg}
        </div>

        ${failureRateBadge}

        <div class="brain-popup-dominant">
          <div class="brain-popup-dominant-label">Dominant System</div>
          <div class="brain-popup-dominant-text" style="color: ${data.color};">${data.dominant}</div>
        </div>

        <div class="brain-popup-short" style="border-color: ${data.color};">
          "${data.shortExplanation}"
        </div>

        <div class="brain-popup-full">
          ${data.fullExplanation}
        </div>

        ${researchTip}
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', popupHtml);
}

/**
 * Close brain popup
 */
function closeBrainPopup() {
  const popup = document.querySelector('.brain-popup-overlay');
  if (popup) popup.remove();
}

/**
 * Show cards in a specific Leitner box
 */
function showLeitnerBoxDetail(boxNum) {
  const container = document.getElementById('leitnerBoxGrid');
  const detailView = document.getElementById('leitnerBoxDetail');
  const titleEl = document.getElementById('leitnerBoxDetailTitle');
  const listEl = document.getElementById('leitnerBoxDetailList');
  const day1Section = document.getElementById('day1IntervalsSection');


  container.style.display = 'none';
  if (day1Section) day1Section.style.display = 'none';

  detailView.style.display = 'block';
  titleEl.textContent = `${LEITNER_BOX_NAMES[boxNum]} Cards`;

  const tabContent = document.getElementById('leitnerBoxes');
  if (tabContent) {
    tabContent.scrollTop = 0;
  }
  window.scrollTo(0, 0);


  const boxCards = leitnerCards.filter(c => c.box === boxNum);
  const dueCards = leitnerDueCards.filter(c => c.box === boxNum);
  const isDay1 = boxNum === 1;
  const isMastery = boxNum === 8;

  if (boxCards.length === 0) {
    listEl.innerHTML = `
      <div class="leitner-empty-state">
        <div class="icon"></div>
        <h3>No cards in this box</h3>
      </div>
    `;
    return;
  }

  let headerSection = '';

  const boxIntervals = {
    1: 'Practice anytime',
    2: '1 day',
    3: '2 days',
    4: '4 days',
    5: '1 week',
    6: '2 weeks',
    7: '1 month',
    8: 'Mastered!'
  };

  if (isDay1) {
    const todayStr = new Date().toISOString().split('T')[0];
    const movedTodayCards = leitnerCards.filter(c => c.box === 2 && c.movedFromDay1Date === todayStr);
    const totalPracticable = boxCards.length + movedTodayCards.length;

    headerSection = `
      <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border: 2px solid #667eea; border-radius: 12px;">
        <div style="text-align: center;">
          <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
            <h3 style="color: #667eea; margin: 0;"> Day 1 - Unlimited Practice</h3>
            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
               Today Only
            </span>
          </div>
          <p style="color: #4a5568; margin-bottom: 10px;">
            <span style="color: #f59e0b; font-weight: 600;"> ${boxCards.length} to learn</span>
            ${movedTodayCards.length > 0 ? `<span style="margin-left: 15px; color: #48bb78; font-weight: 600;"> ${movedTodayCards.length} mastered today</span>` : ''}
          </p>
          <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px 15px; border-radius: 0 8px 8px 0; margin-bottom: 15px; text-align: left;">
            <p style="color: #92400e; font-size: 14px; margin: 0;">
              <strong> Tomorrow's Challenge:</strong> Once cards move to Day 2, you only get <strong>ONE chance</strong> per review!
              Make sure you really know them before the day ends.
            </p>
          </div>
          <button class="btn btn-secondary" onclick="startDay1Practice()" style="padding: 12px 30px; font-size: 16px;">
             Start Practice Session (${totalPracticable})
          </button>
        </div>
      </div>
    `;
  } else if (isMastery) {
    headerSection = `
      <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #9f7aea10 0%, #667eea10 100%); border: 2px solid #9f7aea; border-radius: 12px; text-align: center;">
        <h3 style="color: #6b46c1; margin-bottom: 10px;"> Mastery Achieved!</h3>
        <p style="color: #6b46c1; font-size: 16px; margin-bottom: 10px;">
          You've mastered these <strong>${boxCards.length}</strong> card${boxCards.length !== 1 ? 's' : ''}!
        </p>
        <p style="color: #718096; font-size: 14px; margin: 0;">
          These words are now permanently in your long-term memory. Great job! 
        </p>
      </div>
    `;
  } else if (dueCards.length > 0) {
    headerSection = `
      <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fed7d710 0%, #f5656510 100%); border: 2px solid #f56565; border-radius: 12px;">
        <div style="text-align: center;">
          <h3 style="color: #c53030; margin-bottom: 10px;"> ${LEITNER_BOX_NAMES[boxNum]} Review</h3>
          <p style="color: #c53030; font-weight: 600; margin-bottom: 10px;">
            ${dueCards.length} card${dueCards.length !== 1 ? 's' : ''} due for review!
          </p>
          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; border-radius: 0 8px 8px 0; margin-bottom: 15px; text-align: left;">
            <p style="color: #92400e; font-size: 14px; margin: 0;">
              <strong> Tip:</strong> ${LEITNER_BOX_NAMES[boxNum]} cards have a ${boxIntervals[boxNum]} interval.
              Get them right to advance to the next level, or they'll go back to Day 1 for more practice.
            </p>
          </div>
          <button class="btn" onclick="startScheduledReview()" style="background: #f56565; padding: 12px 30px; font-size: 16px;">
             Review Due Cards
          </button>
        </div>
      </div>
    `;
  } else {
    const notDueCards = boxCards.filter(c => {
      const isDue = leitnerDueCards.some(dc => dc.id === c.id);
      return !isDue && c.nextReviewDate;
    });

    let nextDueDateStr = 'soon';
    if (notDueCards.length > 0) {
      const dates = notDueCards.map(c => {
        return c.nextReviewDate?.toDate ? c.nextReviewDate.toDate() : new Date(c.nextReviewDate);
      }).sort((a, b) => a - b);
      const nextDate = dates[0];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      if (nextDate.toDateString() === today.toDateString()) {
        nextDueDateStr = 'Today';
      } else if (nextDate.toDateString() === tomorrow.toDateString()) {
        nextDueDateStr = 'Tomorrow';
      } else {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        nextDueDateStr = `${monthNames[nextDate.getMonth()]} ${nextDate.getDate()}`;
      }
    }

    headerSection = `
      <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border: 2px solid #e2e8f0; border-radius: 12px;">
        <div style="text-align: center;">
          <h3 style="color: #4a5568; margin-bottom: 10px;"> ${LEITNER_BOX_NAMES[boxNum]}</h3>
          <p style="color: #718096; margin-bottom: 10px;">
            <strong>${boxCards.length}</strong> card${boxCards.length !== 1 ? 's' : ''} at this level
          </p>
          <div style="background: #e6fffa; border-left: 4px solid #38b2ac; padding: 12px 15px; border-radius: 0 8px 8px 0; margin-bottom: 15px; text-align: left;">
            <p style="color: #234e52; font-size: 14px; margin: 0;">
              <strong> About ${LEITNER_BOX_NAMES[boxNum]}:</strong> Cards here are reviewed every <strong>${boxIntervals[boxNum]}</strong>.
              This spaced repetition helps move words into your long-term memory.
            </p>
          </div>
          <p style="color: #718096; margin: 0;">
             Next review: <strong>${nextDueDateStr}</strong>
          </p>
        </div>
      </div>
    `;
  }

  listEl.innerHTML = headerSection + `
    <div style="background: #f7fafc; border-radius: 12px; padding: 20px;">
      <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
        <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 1px solid #e2e8f0;">
          <div style="font-size: 24px; font-weight: bold; color: #48bb78;">${boxCards.filter(c => (c.correctReviews || 0) > 0).length}</div>
          <div style="font-size: 12px; color: #718096;">Reviewed</div>
        </div>
        <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 1px solid #e2e8f0;">
          <div style="font-size: 24px; font-weight: bold; color: #667eea;">${Math.round(boxCards.reduce((sum, c) => sum + ((c.correctReviews || 0) / Math.max(1, c.totalReviews || 1)), 0) / Math.max(1, boxCards.length) * 100)}%</div>
          <div style="font-size: 12px; color: #718096;">Avg Accuracy</div>
        </div>
        <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 1px solid #e2e8f0;">
          <div style="font-size: 24px; font-weight: bold; color: #f56565;">${boxCards.filter(c => (c.lapseCount || 0) > 0).length}</div>
          <div style="font-size: 12px; color: #718096;">With Lapses</div>
        </div>
      </div>

      <h4 style="color: #4a5568; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        <span> Words to Learn</span>
        <span style="font-size: 12px; color: #718096; font-weight: normal;">(Korean answers hidden for active recall)</span>
      </h4>
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        ${boxCards.map(card => `
          <div style="background: white; padding: 10px 16px; border-radius: 20px; border: 1px solid #e2e8f0; font-size: 14px; color: #2d3748;">
            ${card.english}
            ${(card.lapseCount || 0) > 0 ? '<span style="color: #f56565; margin-left: 5px;"></span>' : ''}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/**
 * Start practicing cards from a specific box
 * Note: Only Day 1 allows unlimited practice. Others only when due.
 */
function startBoxPractice(boxNum) {

  if (boxNum === 8) {
    // Box 8 cards are mastered - just return silently
    return;
  }

  if (boxNum === 1) {
    startDay1Practice();
    return;
  }

  const dueInBox = leitnerDueCards.filter(c => c.box === boxNum);

  if (dueInBox.length > 0) {
    startBoxSpecificReview(boxNum, dueInBox);
  } else {
    alert(`${LEITNER_BOX_NAMES[boxNum]} cards aren't due for review yet. Practice Day 1 cards or wait for scheduled reviews!`);
  }
}

/**
 * Start review for a specific box's due cards - wrapper with disclaimer
 */
function startBoxSpecificReview(boxNum, dueCards) {
  if (swipeMode.enabled) {
    _startBoxSpecificReviewInternal(boxNum, dueCards);
    return;
  }
  
  showSpeechDisclaimer(() => {
    _startBoxSpecificReviewInternal(boxNum, dueCards);
  });
}

/**
 * Internal: Start review for a specific box's due cards
 */
function _startBoxSpecificReviewInternal(boxNum, dueCards) {
  switchTab('leitnerReview');

  currentLeitnerQueue = [...dueCards].sort(() => Math.random() - 0.5);
  currentLeitnerIndex = 0;
  leitnerSessionStats = { correct: 0, incorrect: 0 };
  isPracticingDay1 = false;

  const container = document.getElementById('leitnerReviewContainer');
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <span style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600;">
         ${LEITNER_BOX_NAMES[boxNum]} Review (${dueCards.length} cards)
      </span>
      <p style="color: #718096; font-size: 14px; margin-top: 10px;">
         One chance per card - get them right to advance!
      </p>
    </div>

    <!-- Ready Screen -->
    <div id="leitnerReadyScreen" style="max-width: 500px; margin: 0 auto; text-align: center; padding: 40px 20px;">
      <div style="font-size: 80px; margin-bottom: 20px;">${swipeMode.enabled ? '' : ''}</div>
      <h3 style="color: #2d3748; margin-bottom: 15px;">Ready to Review?</h3>
      <p style="color: #718096; margin-bottom: 10px;">
        ${swipeMode.enabled ? 'Tap cards to reveal answers, then mark correct or incorrect.' : 'You\'ll have <strong>10 seconds</strong> per card to say the Korean word.'}
      </p>

      <!-- Mode Selection -->
      <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
        <!-- Voice Mode Button -->
        <button onclick="swipeMode.enabled = false; walkAwayMode.enabled = false; startBoxSpecificReview(${boxNum}, currentLeitnerQueue);" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${!swipeMode.enabled && !walkAwayMode.enabled ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f7fafc'}; 
                color: ${!swipeMode.enabled && !walkAwayMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${!swipeMode.enabled && !walkAwayMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Voice
        </button>
        <!-- Walk Away Mode Button -->
        <button onclick="swipeMode.enabled = false; walkAwayMode.enabled = true; startBoxSpecificReview(${boxNum}, currentLeitnerQueue);" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${walkAwayMode.enabled ? 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)' : '#f7fafc'}; 
                color: ${walkAwayMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${walkAwayMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Walk Away
        </button>
        <!-- Swipe Mode Button -->
        <button onclick="swipeMode.enabled = true; walkAwayMode.enabled = false; startBoxSpecificReview(${boxNum}, currentLeitnerQueue);" 
                style="flex: 1; max-width: 150px; padding: 15px; background: ${swipeMode.enabled ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : '#f7fafc'}; 
                color: ${swipeMode.enabled ? 'white' : '#4a5568'}; border: 2px solid ${swipeMode.enabled ? 'transparent' : '#e2e8f0'}; 
                border-radius: 12px; font-weight: 600; cursor: pointer;">
           Swipe
        </button>
      </div>

      ${swipeMode.enabled ? `
      <div style="background: #fef3c7; border-radius: 10px; padding: 12px; margin-bottom: 15px; text-align: center;">
        <p style="color: #92400e; font-size: 13px; margin: 0;">
          <strong> Swipe Mode:</strong> Only 1 coin per correct answer (no voice required)
        </p>
      </div>
      ` : ''}

      <div style="background: #fed7d7; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
        <p style="color: #c53030; font-size: 13px; margin: 0;">
          <strong> Important:</strong> Wrong answers go back to Day 1! Make sure you really know them.
        </p>
      </div>

      <button class="btn btn-secondary" onclick="beginLeitnerSession()" style="padding: 15px 40px; font-size: 18px;">
         Start Review
      </button>
      <button class="btn" onclick="exitLeitnerReview()" style="margin-left: 10px; padding: 15px 30px; background: transparent; color: #718096; border: 2px solid #e2e8f0;">
        Cancel
      </button>
    </div>

    <div id="leitnerReviewInterface" style="display: none;"></div>
  `;

  window.scrollTo(0, 0);
}

/**
 * Close the Leitner box detail view
 */
function closeLeitnerBoxDetail() {
  renderLeitnerBoxGrid();
}

/**
 * Render the Leitner Stats page
 */
async function renderLeitnerStats() {
  if (!studentLeitnerStats) {
    loadLeitnerStats().then(() => renderLeitnerStats());
    return;
  }

  const boxCounts = {};
  for (let i = 1; i <= 8; i++) {
    boxCounts[i] = leitnerCards.filter(c => c.box === i).length;
  }

  const totalLearning = leitnerCards.filter(c => c.box < 8).length;
  const leitnerMastered = boxCounts[8] || 0;

  let masteryDeckCount = 0;
  try {
    const masterySnapshot = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .get();
    masteryDeckCount = masterySnapshot.size;
  } catch (e) {
  }

  const totalMastered = leitnerMastered + masteryDeckCount;
  const totalCardsInSystem = leitnerCards.length + masteryDeckCount;
  const masteryRate = totalCardsInSystem > 0 ? (totalMastered / totalCardsInSystem * 100).toFixed(1) : 0;

  const accuracy = studentLeitnerStats.totalReviews > 0 ?
    (studentLeitnerStats.totalCorrect / studentLeitnerStats.totalReviews * 100).toFixed(1) : 0;
  const resetRate = studentLeitnerStats.totalReviews > 0 ?
    (studentLeitnerStats.totalLapses / studentLeitnerStats.totalReviews * 100).toFixed(1) : 0;

  const masteredCards = leitnerCards.filter(c => c.box === 8 && c.masteredDate && c.firstSeenDate);
  let avgTimeToMastery = 'N/A';
  if (masteredCards.length > 0) {
    const times = masteredCards.map(c => {
      const first = c.firstSeenDate?.toDate ? c.firstSeenDate.toDate() : new Date(c.firstSeenDate);
      const mastered = c.masteredDate?.toDate ? c.masteredDate.toDate() : new Date(c.masteredDate);
      return Math.floor((mastered - first) / (1000 * 60 * 60 * 24));
    });
    avgTimeToMastery = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1);
  }

  const leechCards = leitnerCards
    .filter(c => c.lapseCount >= LEITNER_LEECH_THRESHOLD)
    .sort((a, b) => b.lapseCount - a.lapseCount)
    .slice(0, 5);

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStr = today.toISOString().split('T')[0];
  const studyLog = studentLeitnerStats.studyLog || {};

  const last7Days = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    last7Days.push({ date: dateStr, count: studyLog[dateStr] || 0 });
  }
  const daysStudiedThisWeek = last7Days.filter(d => d.count > 0).length;

  const weekForecast = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(today);
    date.setDate(date.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    const count = leitnerCards.filter(c => {
      if (c.box >= 8) return false;
      const nextReview = c.nextReviewDate?.toDate ? c.nextReviewDate.toDate() : new Date(c.nextReviewDate);
      return nextReview.toISOString().split('T')[0] === dateStr;
    }).length;
    weekForecast.push({ date, count, dayName: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()] });
  }
  const maxForecast = Math.max(...weekForecast.map(f => f.count), 1);

  document.getElementById('leitnerCoreProgress').innerHTML = `
    <div class="leitner-stat-card">
      <h4> Mastery Deck</h4>
      <div class="stat-value" style="color: #f59e0b;">${masteryDeckCount}</div>
      <div class="stat-label">words mastered in games</div>
    </div>
    <div class="leitner-stat-card">
      <h4> Leitner Graduated</h4>
      <div class="stat-value" style="color: #9f7aea;">${leitnerMastered}</div>
      <div class="stat-label">through SRS review</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Mastery Rate</h4>
      <div class="stat-value" style="color: #667eea;">${masteryRate}%</div>
      <div class="stat-label">of all cards seen</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Total Learning</h4>
      <div class="stat-value">${totalLearning}</div>
      <div class="stat-label">cards in Leitner rotation</div>
    </div>
  `;

  document.getElementById('leitnerRecallQuality').innerHTML = `
    <div class="leitner-stat-card">
      <h4>Overall Accuracy</h4>
      <div class="stat-value" style="color: #48bb78;">${accuracy}%</div>
      <div class="stat-label">${studentLeitnerStats.totalCorrect} / ${studentLeitnerStats.totalReviews} correct</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Avg Time to Mastery</h4>
      <div class="stat-value">${avgTimeToMastery}</div>
      <div class="stat-label">days</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Strong Words</h4>
      <div class="stat-value" style="color: #4299e1;">${(boxCounts[6] || 0) + (boxCounts[7] || 0)}</div>
      <div class="stat-label">in Weekly + Monthly</div>
    </div>
  `;

  document.getElementById('leitnerStruggleAnalysis').innerHTML = `
    <div class="leitner-stat-card">
      <h4>Weekly Resets</h4>
      <div class="stat-value" style="color: #f56565;">${studentLeitnerStats.weeklyLapses || 0}</div>
      <div class="stat-label">cards sent back to Day 1 this week</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Reset Rate</h4>
      <div class="stat-value" style="color: #ed8936;">${resetRate}%</div>
      <div class="stat-label">of all reviews</div>
    </div>
    <div class="leitner-stat-card" style="grid-column: span 2;">
      <h4>Leech Cards (${LEITNER_LEECH_THRESHOLD}+ lapses)</h4>
      ${leechCards.length > 0 ? `
        <div style="margin-top: 10px;">
          ${leechCards.map(c => `
            <div class="leitner-leech-item">
              <span class="word">${c.english}  ${c.korean}</span>
              <span class="lapses">${c.lapseCount} lapses</span>
            </div>
          `).join('')}
        </div>
      ` : `
        <div class="stat-value" style="color: #48bb78; font-size: 24px;">None! </div>
        <div class="stat-label">No struggling cards</div>
      `}
    </div>
  `;

  const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  const todayDayIndex = today.getDay();

  document.getElementById('leitnerConsistency').innerHTML = `
    <div class="leitner-stat-card">
      <h4>Current Streak</h4>
      <div class="stat-value" style="color: #ed8936;"> ${studentLeitnerStats.currentStreak}</div>
      <div class="stat-label">days in a row (best: ${studentLeitnerStats.longestStreak})</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Weekly Consistency</h4>
      <div class="stat-value">${Math.round(daysStudiedThisWeek / 7 * 100)}%</div>
      <div class="leitner-consistency-week">
        ${last7Days.map((d, i) => {
          const dayDate = new Date(d.date);
          const dayIndex = dayDate.getDay();
          const isToday = d.date === todayStr;
          const className = d.count > 0 ? 'studied' : 'missed';
          return `<div class="leitner-consistency-day ${className} ${isToday ? 'today' : ''}">${dayLabels[dayIndex]}</div>`;
        }).join('')}
      </div>
    </div>
    <div class="leitner-stat-card">
      <h4>Reviews Today</h4>
      <div class="stat-value">${studyLog[todayStr] || 0}</div>
      <div class="stat-label">cards reviewed</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Overdue Cards</h4>
      <div class="stat-value" style="color: ${leitnerDueCards.length > 0 ? '#f56565' : '#48bb78'};">
        ${leitnerDueCards.length}
      </div>
      <div class="stat-label">need review</div>
    </div>
  `;

  document.getElementById('leitnerForecast').innerHTML = `
    <div class="leitner-stat-card">
      <h4>Today's Due</h4>
      <div class="stat-value">${leitnerDueCards.length}</div>
      <div class="stat-label">cards to review</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Tomorrow's Due</h4>
      <div class="stat-value">${weekForecast[1]?.count || 0}</div>
      <div class="stat-label">cards scheduled</div>
    </div>
    <div class="leitner-stat-card" style="grid-column: span 2;">
      <h4>7-Day Forecast</h4>
      <div class="leitner-forecast-bars">
        ${weekForecast.map((f, i) => {
          const height = (f.count / maxForecast * 80) + 10;
          return `
            <div class="leitner-forecast-bar" style="height: ${height}%;">
              <div class="bar-value">${f.count}</div>
              <div class="bar-label">${i === 0 ? 'Today' : f.dayName}</div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

async function loadMyFeedback() {
  const feedbackList = document.getElementById('studentFeedbackList');
  feedbackList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('submissions')
      .where('studentId', '==', currentUser.uid)
      .where('status', '==', 'graded')
      .get();

    feedbackList.innerHTML = '';

    const feedbackByTest = {};

    const feedbackSubmissions = [];
    for (const doc of snapshot.docs) {
      const submission = doc.data();
      if (submission.feedbackNeeded && Object.keys(submission.feedbackNeeded).length > 0) {
        feedbackSubmissions.push({ id: doc.id, data: submission });
      }
    }

    feedbackSubmissions.sort((a, b) => {
      const aDate = a.data.gradedAt ? a.data.gradedAt.toDate() : new Date(0);
      const bDate = b.data.gradedAt ? b.data.gradedAt.toDate() : new Date(0);
      return bDate - aDate;
    });

    for (const submission of feedbackSubmissions) {
      const testDoc = await db.collection('tests').doc(submission.data.testId).get();
      if (testDoc.exists) {
        const testId = submission.data.testId;
        if (!feedbackByTest[testId]) {
          feedbackByTest[testId] = {
            test: testDoc.data(),
            submissions: []
          };
        }
        feedbackByTest[testId].submissions.push(submission);
      }
    }

    if (Object.keys(feedbackByTest).length === 0) {
      feedbackList.innerHTML = '<p>No feedback available yet. Complete tests and score below 10 to receive feedback.</p>';
      return;
    }

    feedbackList.innerHTML = '<div id="feedbackFolders"></div><div id="feedbackContent" style="display: none;"></div>';
    const foldersDiv = document.getElementById('feedbackFolders');

    Object.entries(feedbackByTest).forEach(([testId, testData]) => {
      const latestSubmission = testData.submissions[0].data;
      const feedbackDate = latestSubmission.gradedAt ? latestSubmission.gradedAt.toDate() : new Date();

      const folderCard = document.createElement('div');
      folderCard.className = 'test-card';
      folderCard.style.cursor = 'pointer';
      folderCard.innerHTML = `
        <div class="test-header">
          <div>
            <div class="test-title"> ${testData.test.title}</div>
            <div class="test-date">Feedback Date: ${feedbackDate.toLocaleDateString()}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span class="status-badge status-graded">${testData.submissions.length} feedback${testData.submissions.length > 1 ? 's' : ''}</span>
            <button class="btn" style="padding: 8px 16px;">View Feedback </button>
          </div>
        </div>
      `;

      folderCard.onclick = () => showTestFeedback(testId, testData);
      foldersDiv.appendChild(folderCard);
    });
  } catch (error) {
    feedbackList.innerHTML = '<p>Error loading feedback: ' + error.message + '</p>';
  }
}

function showTestFeedback(testId, testData) {
  const foldersDiv = document.getElementById('feedbackFolders');
  const contentDiv = document.getElementById('feedbackContent');

  foldersDiv.style.display = 'none';
  contentDiv.style.display = 'block';

  let contentHtml = `
    <button class="btn" onclick="backToFeedbackFolders()" style="margin-bottom: 20px;"> Back to All Feedback</button>
    <h2 style="color: #2d3748; margin-bottom: 20px;">${testData.test.title}</h2>
  `;

  testData.submissions.forEach((submission, index) => {
    const submissionData = submission.data;
    const feedbackDate = submissionData.gradedAt ? submissionData.gradedAt.toDate() : new Date();

    let feedbackHtml = `
      <div class="feedback-display">
        <div class="feedback-title">Submission ${index + 1} - ${feedbackDate.toLocaleString()}</div>
    `;

    if (submissionData.feedbackVideoUrl) {
      feedbackHtml += `
        <div style="margin: 20px 0; padding: 20px; background: #f7fafc; border-radius: 12px; border: 2px solid #667eea;">
          <h4 style="color: #667eea; margin-bottom: 15px;"> Personal Video Feedback from Your Teacher</h4>
          <video controls style="width: 100%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <source src="${submissionData.feedbackVideoUrl}" type="video/webm">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
    }

    const sortedFeedback = Object.entries(submissionData.feedbackNeeded)
      .sort((a, b) => {
        const gradeA = submissionData.grades[a[0]] || 10;
        const gradeB = submissionData.grades[b[0]] || 10;
        return gradeA - gradeB;
      });

    sortedFeedback.forEach(([key, feedback]) => {
      let topicName = key;
      let grade = submissionData.grades[key];

      if (key.includes('_')) {
        const parts = key.split('_');
        topicName = parts.slice(1).join('_');
      }

      let feedbackContent = '';
      if (feedback && feedback.content) {
        if (feedback.type === 'text') {
          feedbackContent = `<p>${feedback.content}</p>`;
        } else if (feedback.type === 'video') {
          let videoUrl = feedback.content;
          let embedUrl = '';
          let isEmbeddable = false;

          if (videoUrl.includes('youtube.com/watch')) {
            embedUrl = videoUrl.replace('watch?v=', 'embed/');
            isEmbeddable = true;
          } else if (videoUrl.includes('youtu.be/')) {
            const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
            isEmbeddable = true;
          } else if (videoUrl.includes('loom.com/share/')) {
            const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
            embedUrl = `https://www.loom.com/embed/${videoId}`;
            isEmbeddable = true;
          } else if (videoUrl.includes('vimeo.com/')) {
            const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
            embedUrl = `https://player.vimeo.com/video/${videoId}`;
            isEmbeddable = true;
          } else if (videoUrl.includes('drive.google.com')) {
            if (videoUrl.includes('/file/d/')) {
              const videoId = videoUrl.split('/file/d/')[1].split('/')[0];
              embedUrl = `https://drive.google.com/file/d/${videoId}/preview`;
              isEmbeddable = true;
            }
          }

          if (isEmbeddable) {
            const uniqueId = `feedback-video-${key.replace(/[^a-zA-Z0-9]/g, '')}`;
            feedbackContent = `
              <button id="btn-${uniqueId}" onclick="loadVideo('${uniqueId}', '${embedUrl.replace(/'/g, "\\'")}')" style="color: #667eea; background: #eef2ff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; margin-top: 8px;">
                <span style="margin-right: 5px;"></span>
                <span style="font-weight: 600;">Watch Video</span>
                <span style="margin-left: 5px;"></span>
              </button>
              <div id="${uniqueId}" style="display: none; margin-top: 10px;">
                <!-- Video will be loaded here when button is clicked -->
              </div>
            `;
          } else {
            feedbackContent = `
              <div style="margin-top: 8px;">
                <a href="${videoUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; padding: 8px 12px; background: #eef2ff; border-radius: 6px;">
                  <span style="margin-right: 5px;"></span>
                  <span style="font-weight: 600;">Watch Video</span>
                  <span style="margin-left: 5px;"></span>
                </a>
              </div>
            `;
          }
        } else if (feedback.type === 'html') {
          feedbackContent = feedback.content;
        }
      }

      feedbackHtml += `
        <div style="margin-top: 20px;">
          <h4 style="color: #2d3748; margin-bottom: 10px;">
            Topic: ${topicName}
            ${grade ? `(Grade: ${grade}/10)` : ''}
          </h4>
          ${feedbackContent}
        </div>
      `;
    });

    feedbackHtml += '</div>';
    contentHtml += feedbackHtml;

    processGrammarFeedbackForLeitner(submission, testData.test);
  });

  contentDiv.innerHTML = contentHtml;
}

/**
 * Process graded feedback and add topics to Grammar Leitner
 */
async function processGrammarFeedbackForLeitner(submission, test) {
  if (!currentUser || !submission.data.grades) return;

  const grades = submission.data.grades;
  const feedbackNeeded = submission.data.feedbackNeeded || {};

  for (const [key, grade] of Object.entries(grades)) {
    if (grade === 10) {
      let topicName = key;
      let materialTitle = '';

      if (key.includes('_')) {
        const parts = key.split('_');
        const materialIndex = parseInt(parts[0]);
        topicName = parts.slice(1).join('_');
        materialTitle = test.materials?.[materialIndex]?.title || '';
      }

      await addToGrammarMastery({
        topic: topicName,
        testTitle: test.title,
        materialTitle: materialTitle,
        submissionId: submission.id
      });
      continue;
    }

    const feedback = feedbackNeeded[key];
    let feedbackText = '';

    if (feedback && feedback.content) {
      if (feedback.type === 'text') {
        feedbackText = feedback.content;
      } else if (feedback.type === 'video') {
        feedbackText = `Watch video feedback: ${feedback.content}`;
      } else if (feedback.type === 'html') {
        feedbackText = feedback.content.replace(/<[^>]*>/g, '');
      }
    }

    let topicName = key;
    let materialTitle = '';

    if (key.includes('_')) {
      const parts = key.split('_');
      const materialIndex = parseInt(parts[0]);
      topicName = parts.slice(1).join('_');
      materialTitle = test.materials?.[materialIndex]?.title || '';
    }

    const scoreDrills = feedback?.drillSentences?.[grade] || feedback?.drillSentences || [];
    const drillsArray = Array.isArray(scoreDrills) ? scoreDrills : [];

    await addToGrammarLeitner({
      topic: topicName,
      feedback: feedbackText,
      grade: grade,
      testTitle: test.title,
      materialTitle: materialTitle,
      submissionId: submission.id,
      drillSentences: drillsArray.filter(s => s && s.question && s.answer)
    });
  }

  await loadGrammarLeitnerCards();
}

function backToFeedbackFolders() {
  document.getElementById('feedbackFolders').style.display = 'block';
  document.getElementById('feedbackContent').style.display = 'none';
}

async function loadAnalytics() {
  try {
    const snapshot = await db.collection('submissions')
      .where('studentId', '==', currentUser.uid)
      .where('status', '==', 'graded')
      .get();

    if (snapshot.empty) {
      showNoAnalyticsData();
      return;
    }

    const submissions = [];
    const topicScores = {};

    for (const doc of snapshot.docs) {
      const submission = doc.data();
      const submissionDate = submission.gradedAt ? submission.gradedAt.toDate() : new Date();

      submissions.push({
        id: doc.id,
        date: submissionDate,
        grades: submission.grades || {}
      });

      Object.entries(submission.grades || {}).forEach(([key, grade]) => {
        let topicName = key;
        if (key.includes('_')) {
          const parts = key.split('_');
          topicName = parts.slice(1).join('_');
        }

        if (!topicScores[topicName]) {
          topicScores[topicName] = [];
        }

        topicScores[topicName].push({
          grade: grade,
          date: submissionDate
        });
      });
    }

    submissions.sort((a, b) => a.date - b.date);

    Object.keys(topicScores).forEach(topic => {
      topicScores[topic].sort((a, b) => a.date - b.date);
    });

    calculateOverallImprovement(submissions, topicScores);
    calculateMonthlyImprovement(topicScores);
    calculateAllTimeImprovement(topicScores);

    generateTopicDetails(topicScores);

    createTopicChart(topicScores);
    createProgressChart(submissions, topicScores);

  } catch (error) {
    showNoAnalyticsData();
  }
}

function calculateOverallImprovement(submissions, topicScores) {
  const overallElement = document.getElementById('overallImprovement');
  const detailsElement = document.getElementById('overallDetails');

  if (submissions.length < 2) {
    overallElement.textContent = 'N/A';
    detailsElement.textContent = 'Need at least 2 graded submissions';
    return;
  }

  const firstSubmission = submissions[0];
  const firstGrades = Object.values(firstSubmission.grades);

  const lastSubmission = submissions[submissions.length - 1];
  const lastGrades = Object.values(lastSubmission.grades);

  if (firstGrades.length === 0 || lastGrades.length === 0) {
    overallElement.textContent = 'N/A';
    detailsElement.textContent = 'Invalid grade data';
    return;
  }

  const firstAvg = firstGrades.reduce((a, b) => a + b, 0) / firstGrades.length;
  const lastAvg = lastGrades.reduce((a, b) => a + b, 0) / lastGrades.length;

  if (firstAvg === 0) {
    overallElement.textContent = lastAvg > 0 ? ' Improved' : 'N/A';
    detailsElement.textContent = lastAvg > 0 ? 'Started from zero and improved!' : 'No improvement data';
    overallElement.className = lastAvg > 0 ? 'summary-value positive' : 'summary-value';
    return;
  }

  const improvement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);

  overallElement.textContent = improvement > 0 ? `+${improvement}%` : `${improvement}%`;
  overallElement.className = improvement >= 0 ? 'summary-value positive' : 'summary-value negative';

  detailsElement.innerHTML = `
    First test average: ${firstAvg.toFixed(1)}/10<br>
    Latest test average: ${lastAvg.toFixed(1)}/10<br>
    Across ${submissions.length} graded tests
  `;
}

function calculateMonthlyImprovement(topicScores) {
  const monthElement = document.getElementById('monthlyImprovement');
  const detailsElement = document.getElementById('monthlyDetails');

  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

  let monthlyImprovements = [];
  let hasMonthData = false;

  Object.entries(topicScores).forEach(([topic, scores]) => {
    const monthScores = scores.filter(s => s.date >= oneMonthAgo);
    if (monthScores.length >= 2) {
      hasMonthData = true;
      const firstScore = monthScores[0].grade;
      const lastScore = monthScores[monthScores.length - 1].grade;
      const improvement = ((lastScore - firstScore) / firstScore * 100);
      monthlyImprovements.push({
        topic: topic,
        improvement: improvement,
        from: firstScore,
        to: lastScore
      });
    }
  });

  if (!hasMonthData) {
    monthElement.textContent = 'N/A';
    detailsElement.textContent = 'Not enough data in the past month';
    return;
  }

  const avgImprovement = monthlyImprovements.reduce((a, b) => a + b.improvement, 0) / monthlyImprovements.length;

  monthElement.textContent = avgImprovement > 0 ? `+${avgImprovement.toFixed(1)}%` : `${avgImprovement.toFixed(1)}%`;
  monthElement.className = avgImprovement >= 0 ? 'summary-value positive' : 'summary-value negative';

  monthlyImprovements.sort((a, b) => b.improvement - a.improvement);
  const topImprovements = monthlyImprovements.slice(0, 3);

  detailsElement.innerHTML = topImprovements.map(item =>
    `${item.topic}: ${item.improvement > 0 ? '+' : ''}${item.improvement.toFixed(1)}% (${item.from}${item.to})`
  ).join('<br>');
}

function calculateAllTimeImprovement(topicScores) {
  const allTimeElement = document.getElementById('allTimeImprovement');
  const detailsElement = document.getElementById('allTimeDetails');

  let allTimeImprovements = [];

  Object.entries(topicScores).forEach(([topic, scores]) => {
    if (scores.length >= 2) {
      const firstScore = scores[0].grade;
      const lastScore = scores[scores.length - 1].grade;
      const improvement = ((lastScore - firstScore) / firstScore * 100);
      allTimeImprovements.push({
        topic: topic,
        improvement: improvement,
        from: firstScore,
        to: lastScore,
        tests: scores.length
      });
    }
  });

  if (allTimeImprovements.length === 0) {
    allTimeElement.textContent = 'N/A';
    detailsElement.textContent = 'Not enough historical data';
    return;
  }

  const avgImprovement = allTimeImprovements.reduce((a, b) => a + b.improvement, 0) / allTimeImprovements.length;

  allTimeElement.textContent = avgImprovement > 0 ? `+${avgImprovement.toFixed(1)}%` : `${avgImprovement.toFixed(1)}%`;
  allTimeElement.className = avgImprovement >= 0 ? 'summary-value positive' : 'summary-value negative';

  allTimeImprovements.sort((a, b) => b.improvement - a.improvement);

  detailsElement.innerHTML = allTimeImprovements.slice(0, 3).map(item =>
    `${item.topic}: ${item.improvement > 0 ? '+' : ''}${item.improvement.toFixed(1)}% over ${item.tests} tests`
  ).join('<br>');
}

function generateTopicDetails(topicScores) {
  const container = document.getElementById('topicDetailsList');
  container.innerHTML = '';

  window.topicsData = [];

  Object.entries(topicScores).forEach(([topic, scores]) => {
    if (scores.length === 0) return;

    const highest = Math.max(...scores.map(s => s.grade));
    const lowest = Math.min(...scores.map(s => s.grade));
    const latest = scores[scores.length - 1].grade;
    const average = scores.reduce((a, b) => a + b.grade, 0) / scores.length;

    window.topicsData.push({
      topic: topic,
      latest: latest,
      highest: highest,
      lowest: lowest,
      average: average,
      isUrgent: lowest <= 5 || latest <= 6
    });
  });

  window.topicsData.sort((a, b) => b.latest - a.latest);

  displayTopics(window.topicsData);
}

function displayTopics(topics) {
  const container = document.getElementById('topicDetailsList');
  container.innerHTML = '';

  topics.forEach(topicData => {
    const topicDiv = document.createElement('div');
    topicDiv.className = topicData.isUrgent ? 'topic-item urgent' : 'topic-item';

    topicDiv.innerHTML = `
      <div class="topic-name">${topicData.topic}</div>
      <div class="topic-stats">
        <div class="topic-stat">
          <span class="stat-label">Latest Score</span>
          <span class="stat-value" style="color: ${topicData.latest >= 8 ? '#48bb78' : topicData.latest >= 6 ? '#ed8936' : '#f56565'};">${topicData.latest}/10</span>
        </div>
        <div class="topic-stat">
          <span class="stat-label">Highest Score</span>
          <span class="stat-value high">${topicData.highest}/10</span>
        </div>
        <div class="topic-stat">
          <span class="stat-label">Lowest Score</span>
          <span class="stat-value low">${topicData.lowest}/10</span>
        </div>
        <div class="topic-stat">
          <span class="stat-label">Average</span>
          <span class="stat-value">${topicData.average.toFixed(1)}/10</span>
        </div>
      </div>
    `;

    container.appendChild(topicDiv);
  });
}

function filterTopics(filterType, event) {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  if (event && event.target) {
    event.target.classList.add('active');
  }

  if (!window.topicsData) return;

  let filtered = [...window.topicsData];

  switch(filterType) {
    case 'needs-work':
      filtered.sort((a, b) => a.latest - b.latest);
      break;
    case 'recent':
      filtered.sort((a, b) => b.latest - a.latest);
      break;
    case 'exceptional':
      filtered.sort((a, b) => b.latest - a.latest);
      filtered = filtered.filter(t => t.latest >= 8);
      break;
    default: // 'all'
      filtered.sort((a, b) => b.latest - a.latest);
      break;
  }

  displayTopics(filtered);
}

function createTopicChart(topicScores) {
  const ctx = document.getElementById('topicChart');
  if (!ctx) return;

  if (topicChart) {
    topicChart.destroy();
  }

  const topics = Object.keys(topicScores);
  const latestScores = topics.map(topic => {
    const scores = topicScores[topic];
    return scores.length > 0 ? scores[scores.length - 1].grade : 0;
  });
  const averageScores = topics.map(topic => {
    const scores = topicScores[topic];
    return scores.length > 0 ?
      scores.reduce((a, b) => a + b.grade, 0) / scores.length : 0;
  });

  topicChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: topics,
      datasets: [{
        label: 'Latest Score',
        data: latestScores,
        backgroundColor: 'rgba(102, 126, 234, 0.8)',
        borderColor: 'rgba(102, 126, 234, 1)',
        borderWidth: 2
      }, {
        label: 'Average Score',
        data: averageScores,
        backgroundColor: 'rgba(118, 75, 162, 0.8)',
        borderColor: 'rgba(118, 75, 162, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

function createProgressChart(submissions, topicScores) {
  const ctx = document.getElementById('progressChart');
  if (!ctx) return;

  if (progressChart) {
    progressChart.destroy();
  }

  const dates = submissions.map(s => s.date.toLocaleDateString());
  const averages = submissions.map(s => {
    const grades = Object.values(s.grades);
    return grades.length > 0 ? grades.reduce((a, b) => a + b, 0) / grades.length : 0;
  });

  progressChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Average Score',
        data: averages,
        borderColor: 'rgba(102, 126, 234, 1)',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

function showNoAnalyticsData() {
  const container = document.querySelector('.analytics-container');
  container.innerHTML = `
    <div class="no-data-message">
      <h3> No Analytics Data Available Yet</h3>
      <p>Complete and get graded on some tests to see your performance analytics!</p>
    </div>
  `;
}

async function deleteTest(testId) {
  if (!confirm('Are you sure you want to delete this test?')) {
    return;
  }

  try {
    await db.collection('tests').doc(testId).delete();
    alert('Test deleted successfully');
    loadTests();
  } catch (error) {
    alert('Error deleting test: ' + error.message);
  }
}

function closeTestModal() {
  document.getElementById('testModal').classList.remove('active');
  currentTest = null;
  currentTest2 = null;
  currentTestMaterialIndex = 0;
  currentTestMaterialIndex2 = 0;
  recordingsData = {};
  recordingsData2 = {};

  revealedMaterials = {};
  materialAttempts = {};
  revealedMaterials2 = {};
  materialAttempts2 = {};

  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
  }
  clearInterval(recordingTimer);

  if (studentVideoStream) {
    studentVideoStream.getTracks().forEach(track => track.stop());
    studentVideoStream = null;
  }

  const videoPreview = document.getElementById('studentVideoPreview');
  if (videoPreview) {
    if (videoPreview.srcObject) {
      const tracks = videoPreview.srcObject.getTracks();
      tracks.forEach(track => track.stop());
      videoPreview.srcObject = null;
    }
  }
}

function closeGradingModal() {
  document.getElementById('gradingModal').classList.remove('active');
  window.currentGradingData = null;

  gradingVideoBlob = null;
  const videoPreview = document.getElementById('gradingVideoPreview');
  const recordedVideo = document.getElementById('gradingRecordedVideo');

  if (videoPreview) {
    videoPreview.style.display = 'none';
    if (videoPreview.srcObject) {
      const tracks = videoPreview.srcObject.getTracks();
      tracks.forEach(track => track.stop());
      videoPreview.srcObject = null;
    }
  }

  if (recordedVideo) {
    recordedVideo.style.display = 'none';
    recordedVideo.src = '';
  }

  if (gradingVideoRecorder && gradingVideoRecorder.state === 'recording') {
    gradingVideoRecorder.stop();
  }

  if (gradingVideoStream) {
    gradingVideoStream.getTracks().forEach(track => track.stop());
    gradingVideoStream = null;
  }
}

let testMaterials2 = [];
let currentTestMaterials2 = []; // For editing tests
let currentMaterialTopics2 = [];
let currentMaterialFeedbacks2 = {};
let editingMaterial2 = null; // Track material being edited: { index: number, original: object }

const KOREAN_CHARACTERS = {
  '': 'https://www.loom.com/share/bde1c41374f24cc5ba516cf659df0d36',
  '': 'https://www.loom.com/share/33c75894ed6d4a0b98310daaa7788d51',
  '': 'https://www.loom.com/share/7ac4ca22c51f48b18fc8a8b81f12a817',
  '': 'https://www.loom.com/share/e439b6cbab804143aaf45e9bd3d7cddb',
  '': 'https://www.loom.com/share/bf74c4a6acb14115930559065bf25588',
  '': 'https://www.loom.com/share/62c7666380e940cfac0e2b1b684a94b6',
  '': 'https://www.loom.com/share/26d88f842c6c4278a50e2537edcc882f',
  '': '',
  '': 'https://www.loom.com/share/6655678667ee4687a1502fb1718f9e1e',
  '': 'https://www.loom.com/share/bf22033d2f72468f95fef634c68d6650',
  '': '',
  '': '',
  '': '',
  '': '',
  '': '',
  '': 'https://www.loom.com/share/276e388e36c64baa98cda921cc04d144',
  '': 'https://www.loom.com/share/d4788f8fcd8d41bcaff58916217449af',
  '': 'https://www.loom.com/share/6b5a389e842a4fa8ad0d396a77215b20',
  '': 'https://www.loom.com/share/fe36ef55e4674c9d9efd0f450ff0a8d5',
  '': 'https://www.loom.com/share/d5fc79b3c094401ab76ccf5b379776a5',
  '': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
  '': '',
  '': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
  '': 'https://www.loom.com/share/d5fc79b3c094401ab76ccf5b379776a5',
  '': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
  '': '',
  '': 'https://www.loom.com/share/579d0ab338bc42f3af75285f560f394d',
  '': 'https://www.loom.com/share/30ad74da3807499ba2ccd02053edd046',
  '': 'https://www.loom.com/share/506c1f2dcc7440c383127c1fbc69b48a',
  '': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
  '': 'https://www.loom.com/share/506c1f2dcc7440c383127c1fbc69b48a',
  '': '',
  '': 'https://www.loom.com/share/30ad74da3807499ba2ccd02053edd046',
  '': 'https://www.loom.com/share/b9dfa8e9c76c4537a603aa6e2a909342',
  '': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
  '': 'https://www.loom.com/share/df65d668742741a7900b45bc091cac7c',
  '': '',
  '': 'https://www.loom.com/share/7a09ee7a1d9147b08d48c867e434897c',
  '': 'https://www.loom.com/share/f3cf5a1872b64befb8959f9146648745',
  '': 'https://www.loom.com/share/23bf0e1e1be142f89d92cc827032c0a5'
};

function loadKoreanCharacters() {
  if (currentMaterialTopics2.length > 0) {
    if (!confirm('This will replace existing topics. Continue?')) {
      return;
    }
  }

  currentMaterialTopics2 = [];
  currentMaterialFeedbacks2 = {};

  Object.entries(KOREAN_CHARACTERS).forEach(([character, videoUrl]) => {
    currentMaterialTopics2.push(character);
    currentMaterialFeedbacks2[character] = {
      type: 'video',
      content: videoUrl,
      pronunciationDrills: {}
    };
  });

  renderCurrentTopics2();
  renderCurrentTopicFeedbacks2();

  alert(` Loaded ${currentMaterialTopics2.length} Korean characters and vowels with pre-configured feedback videos!`);
}

function addTopicToCurrentMaterial2() {
  const topicInput = document.getElementById('newTopic2');
  const topic = topicInput.value.trim();

  if (!topic) {
    alert('Please enter a topic name');
    return;
  }

  if (currentMaterialTopics2.includes(topic)) {
    alert('This topic has already been added');
    return;
  }

  currentMaterialTopics2.push(topic);
  currentMaterialFeedbacks2[topic] = { type: 'text', content: '', pronunciationDrills: {} };

  topicInput.value = '';
  renderCurrentTopics2();
  renderCurrentTopicFeedbacks2();
}

function renderCurrentTopics2() {
  const list = document.getElementById('currentTopicList2');
  list.innerHTML = '';

  if (currentMaterialTopics2.length === 0) {
    return;
  }

  currentMaterialTopics2.forEach((topic, index) => {
    const topicTag = document.createElement('span');
    topicTag.className = 'topic-tag';
    topicTag.innerHTML = `${topic} <button onclick="removeCurrentTopic2ByIndex(${index})"></button>`;
    list.appendChild(topicTag);
  });
}

function removeCurrentTopic2ByIndex(index) {
  const topic = currentMaterialTopics2[index];
  currentMaterialTopics2.splice(index, 1);
  delete currentMaterialFeedbacks2[topic];
  renderCurrentTopics2();
  renderCurrentTopicFeedbacks2();
}

function renderCurrentTopicFeedbacks2() {
  const container = document.getElementById('currentTopicFeedbacks2');
  container.innerHTML = '';

  if (currentMaterialTopics2.length === 0) {
    return;
  }

  container.innerHTML = '<h4 style="margin: 20px 0 15px 0; color: #667eea;">Feedback Content for Each Topic</h4>';

  currentMaterialTopics2.forEach((topic, index) => {
    const topicId = `topic-${index}`;
    const currentType = currentMaterialFeedbacks2[topic].type || 'text';
    const pronunciationDrills = currentMaterialFeedbacks2[topic].pronunciationDrills || {};

    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'form-group';
    feedbackDiv.style.background = 'white';
    feedbackDiv.style.padding = '15px';
    feedbackDiv.style.borderRadius = '8px';
    feedbackDiv.style.marginBottom = '15px';

    let contentInput = '';
    if (currentType === 'text') {
      contentInput = `<textarea id="current-feedback-text-${topicId}" rows="5" placeholder="Enter feedback text..." style="width: 100%;">${currentMaterialFeedbacks2[topic].content || ''}</textarea>`;
    } else if (currentType === 'video') {
      contentInput = `
        <input type="text" id="current-feedback-video-${topicId}" placeholder="Paste video URL: YouTube, Loom (share link), Vimeo, or Google Drive" style="width: 100%;" value="${currentMaterialFeedbacks2[topic].content || ''}">
        <div style="font-size: 12px; color: #718096; margin-top: 5px;">
          Examples: https://www.loom.com/share/abc123  https://www.youtube.com/watch?v=xyz
        </div>
      `;
    } else if (currentType === 'html') {
      contentInput = `<textarea id="current-feedback-html-${topicId}" rows="8" placeholder="Enter HTML content..." style="width: 100%;">${currentMaterialFeedbacks2[topic].content || ''}</textarea>`;
    }

    const drillScoreTabs = `
      <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
        <h5 style="margin: 0 0 10px 0; color: #92400e; display: flex; align-items: center; gap: 8px;">
           Pronunciation Drill Words by Score
          <span style="font-size: 12px; font-weight: normal; color: #a16207;">Different drills for each score level</span>
        </h5>
        <p style="font-size: 13px; color: #a16207; margin-bottom: 15px;">
          Create a unique 20-word drill list for each score. Students receive the drill matching their grade.
        </p>

        <!-- Score Tabs -->
        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #fbbf24; padding-bottom: 10px;">
          ${[1,2,3,4,5,6,7,8,9,10].map(score => {
            const drillWords = pronunciationDrills[score] || [];
            const hasWords = drillWords.length > 0;
            const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];
            return `
              <button type="button"
                id="drill-tab-${topicId}-${score}"
                onclick="showDrillScoreTab('${topic}', ${index}, ${score})"
                style="padding: 8px 12px; border: 2px solid ${hasWords ? '#48bb78' : '#e2e8f0'};
                       background: ${hasWords ? '#f0fff4' : 'white'}; border-radius: 8px; cursor: pointer;
                       font-weight: ${hasWords ? '600' : '400'}; color: ${hasWords ? '#276749' : '#4a5568'};
                       transition: all 0.2s;">
                Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${reps})</span>
                ${hasWords ? '<span style="color: #48bb78;"></span>' : ''}
              </button>
            `;
          }).join('')}
        </div>

        <!-- Drill Content Area -->
        <div id="drill-content-${topicId}" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #fcd34d;">
          <div style="text-align: center; color: #a16207; padding: 20px;">
             Click a score tab above to add drill words for that score level
          </div>
        </div>

        <!-- Quick Info -->
        <div style="margin-top: 15px; font-size: 12px; color: #92400e; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <div> <strong>Score 1-2:</strong> Most repetitions (6-7)</div>
          <div> <strong>Score 3-6:</strong> Medium repetitions (4-5)</div>
          <div> <strong>Score 7-9:</strong> Fewer repetitions (2-3)</div>
          <div> <strong>Score 10:</strong> Quick check (1)</div>
        </div>
      </div>
    `;

    feedbackDiv.innerHTML = `
      <label style="font-weight: bold; color: #2d3748; margin-bottom: 10px; display: block;"> ${topic}</label>
      <div style="margin-bottom: 10px;">
        <label style="margin-right: 15px;">
          <input type="radio" name="feedback-type-${topicId}" value="text" ${currentType === 'text' ? 'checked' : ''} onchange="updateFeedbackType2ByIndex(${index}, 'text')">
          Text
        </label>
        <label style="margin-right: 15px;">
          <input type="radio" name="feedback-type-${topicId}" value="video" ${currentType === 'video' ? 'checked' : ''} onchange="updateFeedbackType2ByIndex(${index}, 'video')">
          Video URL
        </label>
        <label>
          <input type="radio" name="feedback-type-${topicId}" value="html" ${currentType === 'html' ? 'checked' : ''} onchange="updateFeedbackType2ByIndex(${index}, 'html')">
          HTML Content
        </label>
      </div>
      <div id="feedback-content-${topicId}">
        ${contentInput}
      </div>
      ${drillScoreTabs}
    `;

    container.appendChild(feedbackDiv);
  });
}

/**
 * Show drill input section for a specific score
 */
function showDrillScoreTab(topic, topicIndex, score) {
  const topicId = `topic-${topicIndex}`;
  const contentDiv = document.getElementById(`drill-content-${topicId}`);

  if (!currentMaterialFeedbacks2[topic].pronunciationDrills) {
    currentMaterialFeedbacks2[topic].pronunciationDrills = {};
  }

  const drillWords = currentMaterialFeedbacks2[topic].pronunciationDrills[score] || [];
  const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];

  for (let s = 1; s <= 10; s++) {
    const tabBtn = document.getElementById(`drill-tab-${topicId}-${s}`);
    if (tabBtn) {
      if (s === score) {
        tabBtn.style.background = '#fef3c7';
        tabBtn.style.borderColor = '#f59e0b';
      } else {
        const hasWords = (currentMaterialFeedbacks2[topic].pronunciationDrills[s] || []).length > 0;
        tabBtn.style.background = hasWords ? '#f0fff4' : 'white';
        tabBtn.style.borderColor = hasWords ? '#48bb78' : '#e2e8f0';
      }
    }
  }

  contentDiv.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h6 style="margin: 0; color: #92400e;">
          Score ${score} Drill Words
          <span style="font-weight: normal; color: #a16207;">(Students repeat ${reps} = ${reps * 20} productions)</span>
        </h6>
        <span style="font-size: 13px; color: ${drillWords.length === 20 ? '#48bb78' : '#f59e0b'};">
          ${drillWords.filter(w => w).length}/20 words
        </span>
      </div>

      <!-- Bulk paste option -->
      <div style="margin-bottom: 15px; padding: 10px; background: #fffbeb; border-radius: 8px;">
        <label style="font-size: 13px; color: #78350f; font-weight: 600;">Quick Paste (one word per line):</label>
        <textarea id="bulk-drill-words-${topicId}-${score}" rows="2"
          placeholder="Paste up to 20 words, one per line..."
          style="width: 100%; padding: 8px; border: 1px solid #fbbf24; border-radius: 6px; margin-top: 5px; font-size: 14px;"
          onchange="parseBulkDrillWordsForScore('${topic}', ${topicIndex}, ${score}, this.value)"></textarea>
      </div>

      <!-- Individual word inputs -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
        ${Array.from({length: 20}, (_, i) => `
          <input type="text" id="drill-word-${topicId}-${score}-${i}"
            placeholder="${i+1}."
            style="padding: 8px; border: 1px solid #fcd34d; border-radius: 6px; background: white; font-size: 14px;"
            value="${drillWords[i] || ''}"
            onchange="updateDrillWordForScore('${topic}', ${score}, ${i}, this.value)">
        `).join('')}
      </div>
    </div>
  `;
}

/**
 * Parse bulk pasted drill words for a specific score
 */
function parseBulkDrillWordsForScore(topic, topicIndex, score, value) {
  const words = value.split('\n').map(w => w.trim()).filter(w => w.length > 0).slice(0, 20);
  const topicId = `topic-${topicIndex}`;

  words.forEach((word, i) => {
    const input = document.getElementById(`drill-word-${topicId}-${score}-${i}`);
    if (input) {
      input.value = word;
    }
  });

  for (let i = words.length; i < 20; i++) {
    const input = document.getElementById(`drill-word-${topicId}-${score}-${i}`);
    if (input) {
      input.value = '';
    }
  }

  if (!currentMaterialFeedbacks2[topic]) {
    currentMaterialFeedbacks2[topic] = { type: 'text', content: '', pronunciationDrills: {} };
  }
  if (!currentMaterialFeedbacks2[topic].pronunciationDrills) {
    currentMaterialFeedbacks2[topic].pronunciationDrills = {};
  }
  currentMaterialFeedbacks2[topic].pronunciationDrills[score] = words;

  updateDrillTabIndicator(topic, topicIndex, score);
}

/**
 * Update individual drill word for a specific score
 */
function updateDrillWordForScore(topic, score, wordIndex, value) {
  if (!currentMaterialFeedbacks2[topic]) {
    currentMaterialFeedbacks2[topic] = { type: 'text', content: '', pronunciationDrills: {} };
  }
  if (!currentMaterialFeedbacks2[topic].pronunciationDrills) {
    currentMaterialFeedbacks2[topic].pronunciationDrills = {};
  }
  if (!currentMaterialFeedbacks2[topic].pronunciationDrills[score]) {
    currentMaterialFeedbacks2[topic].pronunciationDrills[score] = [];
  }
  currentMaterialFeedbacks2[topic].pronunciationDrills[score][wordIndex] = value;

  const topicIndex = currentMaterialTopics2.indexOf(topic);
  if (topicIndex >= 0) {
    updateDrillTabIndicator(topic, topicIndex, score);
  }
}

/**
 * Update the tab indicator to show if a score has words
 */
function updateDrillTabIndicator(topic, topicIndex, score) {
  const topicId = `topic-${topicIndex}`;
  const tabBtn = document.getElementById(`drill-tab-${topicId}-${score}`);
  if (!tabBtn) return;

  const drillWords = (currentMaterialFeedbacks2[topic].pronunciationDrills[score] || []).filter(w => w);
  const hasWords = drillWords.length > 0;
  const reps = {1:7, 2:6, 3:5, 4:5, 5:4, 6:4, 7:3, 8:3, 9:2, 10:1}[score];

  tabBtn.style.borderColor = hasWords ? '#48bb78' : '#e2e8f0';
  tabBtn.style.background = '#fef3c7'; // Keep active state
  tabBtn.style.fontWeight = hasWords ? '600' : '400';
  tabBtn.style.color = hasWords ? '#276749' : '#4a5568';
  tabBtn.innerHTML = `Score ${score} <span style="font-size: 11px; opacity: 0.7;">(${reps})</span> ${hasWords ? '<span style="color: #48bb78;"></span>' : ''}`;
}

function updateFeedbackType2ByIndex(index, type) {
  const topic = currentMaterialTopics2[index];
  const topicId = `topic-${index}`;
  const contentDiv = document.getElementById(`feedback-content-${topicId}`);

  if (type === 'text') {
    contentDiv.innerHTML = `<textarea id="current-feedback-text-${topicId}" rows="5" placeholder="Enter feedback text..." style="width: 100%;"></textarea>`;
  } else if (type === 'video') {
    contentDiv.innerHTML = `
      <input type="text" id="current-feedback-video-${topicId}" placeholder="Paste video URL: YouTube, Loom (share link), Vimeo, or Google Drive" style="width: 100%;">
      <div style="font-size: 12px; color: #718096; margin-top: 5px;">
        Examples: https://www.loom.com/share/abc123  https://www.youtube.com/watch?v=xyz
      </div>
    `;
  } else if (type === 'html') {
    contentDiv.innerHTML = `<textarea id="current-feedback-html-${topicId}" rows="8" placeholder="Enter HTML content..." style="width: 100%;"></textarea>`;
  }

  currentMaterialFeedbacks2[topic].type = type;
}

function addTestMaterial2() {
  const title = document.getElementById('materialTitle2').value.trim();
  const content = document.getElementById('testMaterial2').value.trim();
  const minutes = parseInt(document.getElementById('materialMinutes2').value) || 0;
  const seconds = parseInt(document.getElementById('materialSeconds2').value) || 0;

  if (!title || !content || currentMaterialTopics2.length === 0) {
    alert('Please fill in material title, content, and add at least one topic');
    return;
  }

  if (minutes === 0 && seconds === 0) {
    alert('Please set a time limit for this test material');
    return;
  }

  currentMaterialTopics2.forEach((topic, index) => {
    const topicId = `topic-${index}`;
    const type = currentMaterialFeedbacks2[topic]?.type || 'text';
    let contentVal = '';

    if (type === 'text') {
      contentVal = document.getElementById(`current-feedback-text-${topicId}`)?.value || '';
    } else if (type === 'video') {
      contentVal = document.getElementById(`current-feedback-video-${topicId}`)?.value || '';
    } else if (type === 'html') {
      contentVal = document.getElementById(`current-feedback-html-${topicId}`)?.value || '';
    }

    if (!currentMaterialFeedbacks2[topic]) {
      currentMaterialFeedbacks2[topic] = { type: 'text', content: '' };
    }
    currentMaterialFeedbacks2[topic].content = contentVal;

    if (!currentMaterialFeedbacks2[topic].pronunciationDrills) {
      currentMaterialFeedbacks2[topic].pronunciationDrills = {};
    }
  });

  const totalSeconds = minutes * 60 + seconds;

  const material = {
    title: title,
    content: content,
    topics: [...currentMaterialTopics2],
    feedbacks: JSON.parse(JSON.stringify(currentMaterialFeedbacks2)),
    timeLimit: totalSeconds
  };

  const materialsArray = currentEditingTest ? currentTestMaterials2 : testMaterials2;

  if (editingMaterial2 && editingMaterial2.isEditing) {
    materialsArray[editingMaterial2.index] = material;
    editingMaterial2 = null; // Clear editing state
  } else {
    materialsArray.push(material);
  }

  updateTestMaterialsList2();

  const addBtn = document.querySelector('#createTest2 button[onclick="addTestMaterial2()"]');
  if (addBtn) {
    addBtn.innerHTML = 'Add This Test Material';
    addBtn.style.background = '';
  }

  document.getElementById('materialTitle2').value = '';
  document.getElementById('testMaterial2').value = '';
  document.getElementById('materialMinutes2').value = '';
  document.getElementById('materialSeconds2').value = '';
  currentMaterialTopics2 = [];
  currentMaterialFeedbacks2 = {};
  renderCurrentTopics2();
  document.getElementById('currentTopicFeedbacks2').innerHTML = '';
}

function updateTestMaterialsList2() {
  const list = document.getElementById('testMaterialsList2');
  list.innerHTML = '';

  const materialsToShow = currentEditingTest ? currentTestMaterials2 : testMaterials2;

  if (materialsToShow.length === 0) {
    list.innerHTML = '<p style="color: #718096;">No test materials added yet. Add your first test material below.</p>';
    return;
  }

  materialsToShow.forEach((material, index) => {
    const minutes = Math.floor(material.timeLimit / 60);
    const seconds = material.timeLimit % 60;
    const isBeingEdited = editingMaterial2 && editingMaterial2.isEditing && editingMaterial2.index === index;

    const materialCard = document.createElement('div');
    materialCard.className = 'test-card';
    materialCard.style.marginBottom = '15px';
    if (isBeingEdited) {
      materialCard.style.border = '3px solid #ed8936';
      materialCard.style.background = '#fffaf0';
    }

    materialCard.innerHTML = `
      <div class="test-header">
        <div class="test-title">
          ${index + 1}. ${material.title}
          ${isBeingEdited ? '<span style="background: #ed8936; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;"> EDITING</span>' : ''}
        </div>
        <div style="display: flex; gap: 8px;">
          ${isBeingEdited ? `
            <button class="btn" onclick="cancelEditMaterial2()" style="padding: 6px 12px; font-size: 14px; background: #718096;"> Cancel Edit</button>
          ` : `
            <button class="btn btn-secondary" onclick="editTestMaterial2(${index})" style="padding: 6px 12px; font-size: 14px;"> Edit</button>
            <button class="btn btn-danger" onclick="removeTestMaterial2(${index})" style="padding: 6px 12px; font-size: 14px;"> Remove</button>
          `}
        </div>
      </div>
      <div style="margin: 10px 0;">
        <strong>Time Limit:</strong> <span class="time-limit-badge">${minutes}:${seconds.toString().padStart(2, '0')}</span>
      </div>
      <div style="margin: 10px 0; color: #718096;">
        ${material.content.substring(0, 150)}${material.content.length > 150 ? '...' : ''}
      </div>
      <div class="topic-list">
        ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
      </div>
    `;

    list.appendChild(materialCard);
  });
}

/**
 * Cancel editing a material and restore the form
 */
function cancelEditMaterial2() {
  if (!editingMaterial2) return;

  document.getElementById('materialTitle2').value = '';
  document.getElementById('testMaterial2').value = '';
  document.getElementById('materialMinutes2').value = '';
  document.getElementById('materialSeconds2').value = '';
  currentMaterialTopics2 = [];
  currentMaterialFeedbacks2 = {};
  renderCurrentTopics2();
  document.getElementById('currentTopicFeedbacks2').innerHTML = '';

  const addBtn = document.querySelector('#createTest2 button[onclick="addTestMaterial2()"]');
  if (addBtn) {
    addBtn.innerHTML = 'Add This Test Material';
    addBtn.style.background = '';
  }

  editingMaterial2 = null;

  updateTestMaterialsList2();
}

function editTestMaterial2(index) {
  const materialsArray = currentEditingTest ? currentTestMaterials2 : testMaterials2;
  const material = materialsArray[index];
  if (!material) return;

  editingMaterial2 = {
    index: index,
    original: JSON.parse(JSON.stringify(material)), // Deep copy
    isEditing: true
  };

  document.getElementById('materialTitle2').value = material.title || '';
  document.getElementById('testMaterial2').value = material.content || '';

  const minutes = Math.floor(material.timeLimit / 60);
  const seconds = material.timeLimit % 60;
  document.getElementById('materialMinutes2').value = minutes || '';
  document.getElementById('materialSeconds2').value = seconds || '';

  currentMaterialTopics2 = material.topics ? [...material.topics] : [];
  renderCurrentTopics2();

  currentMaterialFeedbacks2 = material.feedbacks ? JSON.parse(JSON.stringify(material.feedbacks)) : {};
  renderTopicFeedbacks2();

  updateTestMaterialsList2();

  const addBtn = document.querySelector('#createTest2 button[onclick="addTestMaterial2()"]');
  if (addBtn) {
    addBtn.innerHTML = ' Update This Material';
    addBtn.style.background = '#ed8936';
  }

  document.getElementById('materialTitle2').scrollIntoView({ behavior: 'smooth', block: 'center' });
  document.getElementById('materialTitle2').focus();
}

function renderTopicFeedbacks2() {
  const container = document.getElementById('currentTopicFeedbacks2');
  if (!container) return;

  if (currentMaterialTopics2.length === 0) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = currentMaterialTopics2.map(topic => {
    const topicId = topic.replace(/[^a-zA-Z0-9-]/g, '_');
    const feedback = currentMaterialFeedbacks2[topic] || { type: 'text', content: '' };
    return `
      <div class="feedback-card" style="margin-bottom: 15px; padding: 15px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 10px 0; color: #4a5568;">${topic}</h4>
        <textarea
          id="feedback2-${topicId}"
          placeholder="Feedback for ${topic}..."
          style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"
          onchange="updateTopicFeedback2('${topic}', this.value)"
        >${feedback.content || ''}</textarea>
      </div>
    `;
  }).join('');
}

function updateTopicFeedback2(topic, value) {
  if (!currentMaterialFeedbacks2[topic]) {
    currentMaterialFeedbacks2[topic] = { type: 'text', content: '', pronunciationDrills: {} };
  }
  currentMaterialFeedbacks2[topic].content = value;
}

function removeTestMaterial2(index) {
  if (confirm('Are you sure you want to remove this test material?')) {
    const materialsArray = currentEditingTest ? currentTestMaterials2 : testMaterials2;
    materialsArray.splice(index, 1);
    updateTestMaterialsList2();
  }
}

async function deleteTest2(testId) {
  if (!confirm('Are you sure you want to delete this test2?')) {
    return;
  }

  try {
    await db.collection('tests2').doc(testId).delete();
    alert('Test2 deleted successfully');
    loadTests2();
  } catch (error) {
    alert('Error deleting test2: ' + error.message);
  }
}


async function createFolder(type) {
  const inputId = type === 'tests2' ? 'newFolderNameTests2' : 'newFolderNameFlashcards';
  const folderName = document.getElementById(inputId).value.trim();

  if (!folderName) {
    alert('Please enter a folder name');
    return;
  }

  try {
    // Get current parent folder ID for flashcards
    let parentFolderId = null;
    if (type === 'flashcards' && currentTeacherFolderPath && currentTeacherFolderPath.length > 0) {
      parentFolderId = currentTeacherFolderPath[currentTeacherFolderPath.length - 1].id;
    }

    const folderData = {
      name: folderName,
      type: type,
      createdBy: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Add parentFolderId if we're inside a folder
    if (parentFolderId) {
      folderData.parentFolderId = parentFolderId;
    }

    await db.collection('folders').add(folderData);

    alert('Folder created successfully!');
    document.getElementById(inputId).value = '';

    if (type === 'tests2') {
      loadTests2();
    } else if (type === 'flashcards') {
      loadFlashcardSets(parentFolderId);
    }
  } catch (error) {
    alert('Error creating folder: ' + error.message);
  }
}

async function deleteFolder(folderId, type) {
  if (!confirm('Are you sure you want to delete this folder? Items will be moved to the root level.')) {
    return;
  }

  try {
    const collection = type === 'tests2' ? 'tests2' : 'flashcards';
    const snapshot = await db.collection(collection)
      .where('folderId', '==', folderId)
      .get();

    const batch = db.batch();
    snapshot.forEach(doc => {
      batch.update(doc.ref, { folderId: firebase.firestore.FieldValue.delete() });
    });

    batch.delete(db.collection('folders').doc(folderId));

    await batch.commit();
    alert('Folder deleted successfully');

    if (type === 'tests2') {
      loadTests2();
    } else if (type === 'flashcards') {
      loadFlashcardSets();
    }
  } catch (error) {
    alert('Error deleting folder: ' + error.message);
  }
}

async function moveToFolder(itemId, folderId, type) {
  try {
    const collection = type === 'tests2' ? 'tests2' : 'flashcards';
    const updateData = folderId ? { folderId: folderId } : { folderId: firebase.firestore.FieldValue.delete() };

    await db.collection(collection).doc(itemId).update(updateData);

    if (type === 'tests2') {
      loadTests2();
    } else if (type === 'flashcards') {
      loadFlashcardSets();
    }
  } catch (error) {
    alert('Error moving item: ' + error.message);
  }
}

function toggleFolder(folderId) {
  const contents = document.getElementById('folder-contents-' + folderId);
  if (contents) {
    contents.classList.toggle('open');
  }
}


async function copyTest2(testId) {
  try {
    const testDoc = await db.collection('tests2').doc(testId).get();
    const testData = testDoc.data();

    const newTitle = prompt('Enter title for the copied test:', testData.title + ' (Copy)');
    if (!newTitle) return;

    const newTest = {
      ...testData,
      title: newTitle,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      teacherId: currentUser.uid
    };

    await db.collection('tests2').add(newTest);
    alert('Test copied successfully!');
    loadTests2();
  } catch (error) {
    alert('Error copying test: ' + error.message);
  }
}

let currentEditingTest = null;

async function editTest2(testId) {
  try {
    const testDoc = await db.collection('tests2').doc(testId).get();
    const testData = testDoc.data();

    currentEditingTest = { id: testId, data: testData };

    editingMaterial2 = null;
    currentMaterialTopics2 = [];
    currentMaterialFeedbacks2 = {};

    document.getElementById('materialTitle2').value = '';
    document.getElementById('testMaterial2').value = '';
    document.getElementById('materialMinutes2').value = '';
    document.getElementById('materialSeconds2').value = '';

    const addBtn = document.querySelector('#createTest2 button[onclick="addTestMaterial2()"]');
    if (addBtn) {
      addBtn.innerHTML = 'Add This Test Material';
      addBtn.style.background = '';
    }

    switchTab('createTest2');

    document.getElementById('mainTestTitle2').value = testData.title;

    currentTestMaterials2 = testData.materials || [];
    updateTestMaterialsList2();
    renderCurrentTopics2();
    document.getElementById('currentTopicFeedbacks2').innerHTML = '';

    consonantAssimilationDrills = testData.consonantAssimilationDrills || {};

    if (Object.keys(consonantAssimilationDrills).length > 0) {
      const caContainer = document.getElementById('consonantAssimilationDrillsContainer');
      if (caContainer) {
        caContainer.style.display = 'block';
        document.getElementById('caToggleBtn').textContent = ' Collapse Section';
        renderConsonantAssimilationRules();
      }
    }

    const saveButton = document.querySelector('#createTest2 .btn[onclick="saveCompleteTest2()"]');
    if (saveButton) {
      saveButton.innerHTML = ' Update Test';
      saveButton.style.background = '#ed8936';
    }

    alert('Editing test: ' + testData.title + '. Make your changes and click "Update Test".');
  } catch (error) {
    alert('Error loading test for editing: ' + error.message);
  }
}

async function saveCompleteTest2() {
  const mainTitle = document.getElementById('mainTestTitle2').value.trim();

  if (!mainTitle) {
    alert('Please enter a main test title');
    return;
  }

  if (editingMaterial2 && editingMaterial2.isEditing) {
    const title = document.getElementById('materialTitle2').value.trim();
    const content = document.getElementById('testMaterial2').value.trim();
    const minutes = parseInt(document.getElementById('materialMinutes2').value) || 0;
    const seconds = parseInt(document.getElementById('materialSeconds2').value) || 0;

    if (title && content && currentMaterialTopics2.length > 0 && (minutes > 0 || seconds > 0)) {
      currentMaterialTopics2.forEach((topic, index) => {
        const topicId = `topic-${index}`;
        const type = currentMaterialFeedbacks2[topic]?.type || 'text';
        let contentVal = '';

        if (type === 'text') {
          contentVal = document.getElementById(`current-feedback-text-${topicId}`)?.value || '';
        } else if (type === 'video') {
          contentVal = document.getElementById(`current-feedback-video-${topicId}`)?.value || '';
        } else if (type === 'html') {
          contentVal = document.getElementById(`current-feedback-html-${topicId}`)?.value || '';
        }

        if (!currentMaterialFeedbacks2[topic]) {
          currentMaterialFeedbacks2[topic] = { type: 'text', content: '' };
        }
        currentMaterialFeedbacks2[topic].content = contentVal;

        if (!currentMaterialFeedbacks2[topic].pronunciationDrills) {
          currentMaterialFeedbacks2[topic].pronunciationDrills = {};
        }
      });

      const totalSeconds = minutes * 60 + seconds;
      const material = {
        title: title,
        content: content,
        topics: [...currentMaterialTopics2],
        feedbacks: JSON.parse(JSON.stringify(currentMaterialFeedbacks2)),
        timeLimit: totalSeconds
      };

      const materialsArray = currentEditingTest ? currentTestMaterials2 : testMaterials2;
      materialsArray[editingMaterial2.index] = material;

    }

    editingMaterial2 = null;
  }

  const materialsToSave = currentEditingTest ? currentTestMaterials2 : testMaterials2;

  if (materialsToSave.length === 0) {
    alert('Please add at least one test material');
    return;
  }

  try {
    const testData = {
      title: mainTitle,
      materials: materialsToSave,
      teacherId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      consonantAssimilationDrills: consonantAssimilationDrills // Save CA drills by rule/score
    };

    if (currentEditingTest) {
      delete testData.createdAt; // Keep original creation date
      testData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

      await db.collection('tests2').doc(currentEditingTest.id).update(testData);
      alert('Test updated successfully!');

      currentEditingTest = null;
      const saveButton = document.querySelector('#createTest2 .btn[onclick="saveCompleteTest2()"]');
      if (saveButton) {
        saveButton.innerHTML = 'Save Complete Test';
        saveButton.style.background = '';
      }
    } else {
      await db.collection('tests2').add(testData);
      alert('Test created successfully!');
    }

    document.getElementById('mainTestTitle2').value = '';
    document.getElementById('materialTitle2').value = '';
    document.getElementById('testMaterial2').value = '';
    document.getElementById('materialMinutes2').value = '';
    document.getElementById('materialSeconds2').value = '';

    testMaterials2 = [];
    currentTestMaterials2 = [];
    currentMaterialTopics2 = [];
    currentMaterialFeedbacks2 = {};
    editingMaterial2 = null; // Reset editing state
    consonantAssimilationDrills = {}; // Reset CA drills

    const addBtn = document.querySelector('#createTest2 button[onclick="addTestMaterial2()"]');
    if (addBtn) {
      addBtn.innerHTML = 'Add This Test Material';
      addBtn.style.background = '';
    }

    const caContainer = document.getElementById('consonantAssimilationDrillsContainer');
    if (caContainer) {
      caContainer.style.display = 'none';
      document.getElementById('caToggleBtn').textContent = ' Expand Section';
    }

    updateTestMaterialsList2();
    renderCurrentTopics2();
    document.getElementById('currentTopicFeedbacks2').innerHTML = '';

    switchTab('manageTests2');
  } catch (error) {
    alert('Error saving test: ' + error.message);
  }
}

async function loadTests2() {
  const testsList = document.getElementById('testsList2');
  testsList.innerHTML = '<div class="loading"></div>';

  try {
    const testsSnapshot = await db.collection('tests2')
      .where('teacherId', '==', currentUser.uid)
      .get();

    testsList.innerHTML = '';

    if (testsSnapshot.empty) {
      testsList.innerHTML = '<p style="color: #718096; padding: 20px;">No tests created yet. Create your first test above!</p>';
      return;
    }

    const tests = [];
    testsSnapshot.forEach(doc => {
      tests.push({ id: doc.id, ...doc.data() });
    });

    tests.sort((a, b) => {
      const aTime = a.createdAt ? a.createdAt.toDate() : new Date(0);
      const bTime = b.createdAt ? b.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    window.testsData2 = {};
    tests.forEach(test => {
      window.testsData2[test.id] = test;
    });

    if (!document.getElementById('testFolderOverlay')) {
      const overlay = document.createElement('div');
      overlay.id = 'testFolderOverlay';
      overlay.className = 'folder-overlay';
      overlay.onclick = closeTestFolderModal;
      document.body.appendChild(overlay);

      const modal = document.createElement('div');
      modal.id = 'testFolderModal';
      modal.className = 'test-folder-content';
      document.body.appendChild(modal);
    }

    let foldersHtml = `
      <div style="display: flex; flex-wrap: wrap; gap: 15px; padding: 10px;">
    `;

    tests.forEach(test => {
      const materialsCount = test.materials ? test.materials.length : 0;
      const dateStr = test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'Recently';

      foldersHtml += `
        <div class="test-folder" onclick="openTestFolderModal('${test.id}')">
          <div class="test-folder-header">
            <span class="folder-icon"></span>
            <div class="folder-name">${test.title}</div>
            <div class="folder-stats">
              <span> ${materialsCount} materials</span>
            </div>
            <div class="folder-date">${dateStr}</div>
          </div>
        </div>
      `;
    });

    foldersHtml += '</div>';
    testsList.innerHTML = foldersHtml;

  } catch (error) {
    testsList.innerHTML = '<p>Error loading tests: ' + error.message + '</p>';
  }
}

/**
 * Open test folder modal to show test details
 */
function openTestFolderModal(testId) {
  const test = window.testsData2[testId];
  if (!test) return;

  const modal = document.getElementById('testFolderModal');
  const overlay = document.getElementById('testFolderOverlay');

  let materialsHtml = '';
  if (test.materials && test.materials.length > 0) {
    materialsHtml = test.materials.map((material, idx) => {
      const minutes = Math.floor(material.timeLimit / 60);
      const seconds = material.timeLimit % 60;
      const topicsHtml = material.topics ? material.topics.map(t => `<span class="topic-tag">${t}</span>`).join('') : '';

      return `
        <div style="background: #faf5ff; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #9f7aea;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; color: #553c9a;">${idx + 1}. ${material.title}</div>
            <span style="background: #9f7aea; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
               ${minutes}:${seconds.toString().padStart(2, '0')}
            </span>
          </div>
          <div style="color: #718096; font-size: 13px; margin-bottom: 8px;">
            ${material.content.substring(0, 150)}${material.content.length > 150 ? '...' : ''}
          </div>
          <div class="topic-list" style="display: flex; flex-wrap: wrap; gap: 5px;">
            ${topicsHtml}
          </div>
        </div>
      `;
    }).join('');
  } else {
    materialsHtml = '<p style="color: #718096;">No materials in this test.</p>';
  }

  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9d8fd;">
      <div>
        <h3 style="margin: 0; color: #553c9a;">${test.title}</h3>
        <span style="font-size: 13px; color: #805ad5;">
          Created: ${test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'Recently'}
        </span>
      </div>
      <button onclick="closeTestFolderModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #805ad5;"></button>
    </div>

    <div style="margin-bottom: 20px;">
      <h4 style="color: #6b46c1; margin-bottom: 12px;"> Test Materials (${test.materials ? test.materials.length : 0})</h4>
      ${materialsHtml}
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid #e2e8f0;">
      <button onclick="editTest2('${test.id}'); closeTestFolderModal();" class="btn btn-warning" style="padding: 10px 20px;">
         Edit Test
      </button>
      <button onclick="copyTest2('${test.id}'); closeTestFolderModal();" class="btn btn-secondary" style="padding: 10px 20px;">
         Copy Test
      </button>
      <button onclick="if(confirm('Are you sure you want to delete this test?')) { deleteTest2('${test.id}'); closeTestFolderModal(); }" class="btn btn-danger" style="padding: 10px 20px;">
         Delete Test
      </button>
    </div>
  `;

  modal.classList.add('open');
  overlay.style.display = 'block';
}

/**
 * Close test folder modal
 */
function closeTestFolderModal() {
  const modal = document.getElementById('testFolderModal');
  const overlay = document.getElementById('testFolderOverlay');

  if (modal) modal.classList.remove('open');
  if (overlay) overlay.style.display = 'none';
}

let draggedItemId = null;
let draggedItemType = null;

function handleDragStart(event, itemId, type) {
  draggedItemId = itemId;
  draggedItemType = type;
  event.target.classList.add('dragging');
}

document.addEventListener('dragend', (e) => {
  if (e.target.classList.contains('draggable-item')) {
    e.target.classList.remove('dragging');
  }
});


async function loadAvailableTests2() {
  const testsList = document.getElementById('studentTestsList2');
  testsList.innerHTML = '<div class="loading"></div>';

  try {
    const testsSnapshot = await db.collection('tests2').get();

    testsList.innerHTML = '';

    if (testsSnapshot.empty) {
      testsList.innerHTML = '<p>No tests2 available yet.</p>';
      return;
    }

    const tests = [];
    for (const testDoc of testsSnapshot.docs) {
      const test = testDoc.data();
      const testId = testDoc.id;

      const submissionSnapshot = await db.collection('submissions2')
        .where('studentId', '==', currentUser.uid)
        .where('testId', '==', testId)
        .get();

      if (submissionSnapshot.empty) {
        tests.push({ id: testId, data: test });
      }
    }

    if (tests.length === 0) {
      testsList.innerHTML = '<p>No tests2 available yet.</p>';
      return;
    }

    tests.sort((a, b) => {
      const aTime = a.data.createdAt ? a.data.createdAt.toDate() : new Date(0);
      const bTime = b.data.createdAt ? b.data.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    tests.forEach(item => {
      const test = item.data;
      const testId = item.id;

      const testCard = document.createElement('div');
      testCard.className = 'test-card';

      let materialsHtml = '';
      if (test.materials && test.materials.length > 0) {
        materialsHtml = `
          <div style="margin-top: 15px;">
            <strong>Test Materials (${test.materials.length}):</strong>
            ${test.materials.map((material, idx) => {
              const minutes = Math.floor(material.timeLimit / 60);
              const seconds = material.timeLimit % 60;
              return `
                <div class="test-drill" style="margin-top: 10px;">
                  <div class="test-drill-header">
                    <div class="test-drill-title">${idx + 1}. ${material.title}</div>
                    <div class="time-limit-badge">${minutes}:${seconds.toString().padStart(2, '0')}</div>
                  </div>
                  <div class="topic-list">
                    ${material.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      testCard.innerHTML = `
        <div class="test-header">
          <div class="test-title">${test.title}</div>
          <div class="test-date">Posted by ${test.teacherEmail}</div>
        </div>
        ${materialsHtml}
        <button onclick="openTestModal2('${testId}')" class="btn">Take Test</button>
      `;

      testsList.appendChild(testCard);
    });
  } catch (error) {
    testsList.innerHTML = '<p>Error loading tests2: ' + error.message + '</p>';
  }
}

async function loadAvailableTests2InPronDrills() {
  const container = document.getElementById('pronunciationAvailableTestsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const testsSnapshot = await db.collection('tests2').get();

    if (testsSnapshot.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Tests Available</h3>
          <p style="color: #718096;">Check back later for new pronunciation tests.</p>
        </div>
      `;
      return;
    }

    const availableTests = [];
    const completedTests = [];

    for (const testDoc of testsSnapshot.docs) {
      const test = testDoc.data();
      const testId = testDoc.id;

      const submissionSnapshot = await db.collection('submissions2')
        .where('studentId', '==', currentUser.uid)
        .where('testId', '==', testId)
        .get();

      if (submissionSnapshot.empty) {
        availableTests.push({ id: testId, data: test });
      } else {
        completedTests.push({ id: testId, data: test, submission: submissionSnapshot.docs[0].data() });
      }
    }

    availableTests.sort((a, b) => {
      const aTime = a.data.createdAt ? a.data.createdAt.toDate() : new Date(0);
      const bTime = b.data.createdAt ? b.data.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    let html = '';

    if (availableTests.length > 0) {
      html += `
        <div style="margin-bottom: 30px;">
          <h3 style="color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"></span> Available Tests (${availableTests.length})
          </h3>
          <div style="display: grid; gap: 15px;">
      `;

      availableTests.forEach(item => {
        const test = item.data;
        const testId = item.id;

        let totalTopics = 0;
        if (test.materials) {
          test.materials.forEach(m => totalTopics += (m.topics || []).length);
        }

        html += `
          <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
              <div>
                <h4 style="color: #2d3748; margin: 0 0 5px 0; font-size: 18px;">${test.title}</h4>
                <p style="color: #718096; font-size: 13px; margin: 0;">Posted by ${test.teacherEmail}</p>
              </div>
              <span style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                NEW
              </span>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
              <div style="background: #f7fafc; padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <span style="color: #718096;"> Materials:</span>
                <strong style="color: #2d3748; margin-left: 5px;">${test.materials ? test.materials.length : 0}</strong>
              </div>
              <div style="background: #f7fafc; padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <span style="color: #718096;"> Topics:</span>
                <strong style="color: #2d3748; margin-left: 5px;">${totalTopics}</strong>
              </div>
            </div>

            <button onclick="openTestModal2('${testId}')" class="btn" style="width: 100%; padding: 12px; font-size: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
               Take Test
            </button>
          </div>
        `;
      });

      html += '</div></div>';
    } else {
      html += `
        <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); border-radius: 12px; border: 2px solid #48bb78; margin-bottom: 30px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #276749; margin-bottom: 10px;">All Tests Completed!</h3>
          <p style="color: #2f855a;">Great job! You've completed all available pronunciation tests.</p>
        </div>
      `;
    }

    if (completedTests.length > 0) {
      html += `
        <div>
          <button onclick="toggleCompletedTestsSection()" style="width: 100%; background: #f7fafc; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #718096; font-weight: 600;">
               Completed Tests (${completedTests.length})
            </span>
            <span id="completedTestsToggleIcon" style="color: #718096;"></span>
          </button>
          <div id="completedTestsSection" style="display: none; margin-top: 15px;">
            <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
              View your completed tests in the  Calendar tab to see feedback and grades.
            </p>
            <div style="display: grid; gap: 10px;">
              ${completedTests.map(item => `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <p style="color: #4a5568; margin: 0; font-weight: 500;">${item.data.title}</p>
                    <p style="color: #a0aec0; font-size: 12px; margin: 5px 0 0 0;">
                      Status: ${item.submission.status === 'graded' ? ' Graded' : ' Pending'}
                    </p>
                  </div>
                  <button onclick="switchPronDrillView('calendar')" class="btn" style="padding: 8px 16px; font-size: 13px;">
                    View in Calendar
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading tests: ${error.message}</p>`;
  }
}

function toggleCompletedTestsSection() {
  const section = document.getElementById('completedTestsSection');
  const icon = document.getElementById('completedTestsToggleIcon');

  if (section && icon) {
    if (section.style.display === 'none') {
      section.style.display = 'block';
      icon.textContent = '';
    } else {
      section.style.display = 'none';
      icon.textContent = '';
    }
  }
}

let currentTest2 = null;
let currentTestMaterialIndex2 = 0;
let recordingsData2 = {};

async function openTestModal2(testId) {
  try {
    const doc = await db.collection('tests2').doc(testId).get();

    if (!doc.exists) {
      alert('Test2 not found');
      return;
    }

    currentTest2 = { id: doc.id, ...doc.data() };
    currentTest = null; // Clear currentTest to ensure we use currentTest2
    currentTestMaterialIndex2 = 0;
    recordingsData2 = {};

    document.getElementById('testModal').classList.add('active');
    document.getElementById('modalTestTitle').textContent = currentTest2.title;

    document.getElementById('testMaterialDisplay').style.display = 'none';
    document.getElementById('progressTracker').style.display = 'block';
    updateProgressTracker2();
    displayTestMaterial2();
  } catch (error) {
    alert('Error loading test2: ' + error.message);
  }
}

function displayTestMaterial2() {
  if (!currentTest2 || !currentTest2.materials || currentTest2.materials.length === 0) {
    alert('No test materials available');
    return;
  }

  const material = currentTest2.materials[currentTestMaterialIndex2];
  const interface = document.getElementById('recordingInterface');
  const index = currentTestMaterialIndex2;

  const minutes = Math.floor(material.timeLimit / 60);
  const seconds = material.timeLimit % 60;

  const isRevealed = revealedMaterials2[index] === true;
  const hasRecording = recordingsData2[index] !== undefined;
  const attempts = materialAttempts2[index] || 0;
  const attemptsRemaining = MAX_ATTEMPTS - attempts;

  if (isRevealed) {
    interface.innerHTML = `
      <div class="recording-section">
        <!-- Compact Sticky Timer - Left Side (Purple for Pronunciation) -->
        <div class="sticky-timer" id="stickyTimer" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);">
          <div class="timer-content">
            <div class="timer-label">Time</div>
            <div class="timer-display" id="timerDisplay">${minutes}:${seconds.toString().padStart(2, '0')}</div>
            <div class="timer-progress">
              <div class="timer-progress-bar" id="progressBar" style="width: 100%;"></div>
            </div>
            <div class="attempt-badge">${attempts}/${MAX_ATTEMPTS}</div>
            <button class="stop-btn" onclick="stopRecording(${index})"> STOP</button>
          </div>
        </div>

        <!-- Video Preview -->
        <div class="video-preview-container" style="margin-top: 15px;">
          <video id="studentVideoPreview" class="video-preview" autoplay muted playsinline></video>
          <div class="video-preview-label">REC</div>
          <div class="hd-badge">HD ${currentVideoQuality.toUpperCase()}</div>
        </div>

        <!-- Live Transcription Display -->
        <div style="margin-top: 15px; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border: 2px solid #9f7aea; border-radius: 12px; padding: 15px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 18px;"></span>
            <span style="font-weight: 600; color: #553c9a;">Live Korean Transcription</span>
            <span style="background: #9f7aea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; animation: pulse 2s infinite;">LISTENING</span>
          </div>
          <div id="liveTranscriptionDisplay" style="background: white; border-radius: 8px; padding: 12px; min-height: 60px; font-size: 16px; line-height: 1.8; color: #2d3748;">
            <em style="color: #a0aec0;">Listening for Korean speech...</em>
          </div>
          <p style="color: #718096; font-size: 11px; margin: 8px 0 0 0;">
             This transcription will be saved with your recording for teacher review
          </p>
        </div>

        <h3 style="margin-top: 15px;">${material.title}</h3>

        <div class="recording-started-badge"> VIDEO RECORDING IN PROGRESS</div>

        <!-- Revealed Content -->
        <div class="test-content-revealed" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9f7aea;">
          <p style="white-space: pre-wrap;">${material.content}</p>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag" style="background: #9f7aea; color: white;">${topic}</span>`).join('')}
        </div>
      </div>
    `;
  }
  else if (hasRecording) {
    interface.innerHTML = `
      <div class="recording-section">
        <h3>${material.title}</h3>

        <!-- Video Recording Complete Badge -->
        <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 10px 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
          <span style="font-size: 16px;"> Video Recording Saved</span>
        </div>

        <!-- Locked Content - Recording Complete -->
        <div class="test-content-locked" style="position: relative; min-height: 200px;">
          <div class="test-content-blur" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="white-space: pre-wrap;">            </p>
          </div>

          <div class="lock-overlay" style="background: rgba(72, 187, 120, 0.95);">
            <div class="lock-icon"></div>
            <h3>Recording Saved!</h3>
            <p>Your video pronunciation has been recorded. You can redo or continue to the next material.</p>
            ${attemptsRemaining > 0 ? `
              <div class="lock-warning" style="background: rgba(255,255,255,0.2); color: #fff;">
                 ${attemptsRemaining} redo${attemptsRemaining > 1 ? 's' : ''} remaining
              </div>
            ` : `
              <div class="lock-warning" style="background: rgba(255,100,100,0.3); color: #fff;">
                 No redos remaining
              </div>
            `}
          </div>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag" style="background: #9f7aea; color: white;">${topic}</span>`).join('')}
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <div style="color: #48bb78; font-weight: 600; margin-bottom: 15px;">
             Recording completed (Attempt ${attempts}/${MAX_ATTEMPTS})
          </div>

          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            ${index > 0 ? `<button onclick="previousMaterial2()" class="btn">Previous</button>` : ''}

            ${attemptsRemaining > 0 ? `
              <button onclick="reRecord(${index})" class="btn btn-warning"> REDO (${attemptsRemaining} left)</button>
            ` : ''}

            ${index < currentTest2.materials.length - 1 ? `
              <button onclick="nextMaterial2()" class="btn btn-secondary">Next Material </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }
  else {
    interface.innerHTML = `
      <div class="recording-section">
        <h3>${material.title}</h3>

        <!-- Video Quality Selector -->
        <div class="video-quality-selector">
          <label> Video Quality:</label>
          <select id="videoQualitySelect" onchange="currentVideoQuality = this.value">
            <option value="high" ${currentVideoQuality === 'high' ? 'selected' : ''}>High (1080p) - Best quality, larger file</option>
            <option value="medium" ${currentVideoQuality === 'medium' ? 'selected' : ''}>Medium (720p) - Good quality, faster upload</option>
            <option value="low" ${currentVideoQuality === 'low' ? 'selected' : ''}>Low (480p) - Fastest upload</option>
          </select>
        </div>
        <p style="font-size: 11px; color: #718096; margin: -10px 0 15px 0; padding-left: 15px;"> Lower quality = faster submission upload</p>

        <!-- Camera Preview Placeholder -->
        <div class="video-off-placeholder">
          <div class="camera-icon"></div>
          <p>Camera will activate when recording starts</p>
        </div>

        <!-- Locked Content Container -->
        <div class="test-content-locked" style="position: relative; min-height: 200px;">
          <div class="test-content-blur" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="white-space: pre-wrap;">            </p>
          </div>

          <div class="lock-overlay" style="background: rgba(159, 122, 234, 0.95);">
            <div class="lock-icon"></div>
            <h3>Test Content Locked</h3>
            <p>Press the record button below to reveal the test material and begin your video response.</p>
            <div class="lock-warning"> Time Limit: ${minutes}:${seconds.toString().padStart(2, '0')}  ${MAX_ATTEMPTS} attempts</div>
          </div>
        </div>

        <div class="topic-list">
          ${material.topics.map(topic => `<span class="topic-tag" style="background: #9f7aea; color: white;">${topic}</span>`).join('')}
        </div>

        <div class="recording-controls" style="margin-top: 20px;">
          <p style="color: #9f7aea; font-size: 14px; margin-bottom: 15px; font-weight: 600;">
             Press Record to Reveal Content & Start Video Recording
          </p>
          <button class="record-btn" id="recordBtn" onclick="toggleRecording(${index})">
            <div class="record-icon"></div>
          </button>
          <button class="stop-btn" id="stopBtn" onclick="stopRecording(${index})" style="display: none;">
            STOP
          </button>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          ${index > 0 ? `<button onclick="previousMaterial2()" class="btn" style="margin-right: 10px;">Previous</button>` : ''}
        </div>
      </div>
    `;
  }

  updateProgressTracker2();

  if (Object.keys(recordingsData2).length === currentTest2.materials.length) {
    document.getElementById('submitSection').innerHTML = `
      <h3 style="color: #48bb78; margin-bottom: 20px;">All recordings completed!</h3>
      <button onclick="submitTestRecording2()" class="btn btn-secondary" style="font-size: 18px; padding: 15px 30px;">Submit Test2</button>
    `;
    document.getElementById('submitSection').style.display = 'block';
  } else {
    document.getElementById('submitSection').style.display = 'none';
  }
}

function updateProgressTracker2() {
  const tracker = document.getElementById('progressTracker');
  tracker.style.display = 'block';
  tracker.innerHTML = '';

  const stepsContainer = document.createElement('div');
  stepsContainer.className = 'progress-steps';

  currentTest2.materials.forEach((material, index) => {
    const step = document.createElement('div');
    step.className = 'progress-step';

    if (recordingsData2[index]) {
      step.classList.add('completed');
    } else if (index === currentTestMaterialIndex2) {
      step.classList.add('active');
    }

    step.innerHTML = `
      <div class="step-circle">${index + 1}</div>
      <div class="step-label">${material.title}</div>
    `;

    stepsContainer.appendChild(step);
  });

  tracker.appendChild(stepsContainer);
}

function previousMaterial2() {
  if (currentTestMaterialIndex2 > 0) {
    currentTestMaterialIndex2--;
    displayTestMaterial2();
  }
}

function nextMaterial2() {
  if (currentTestMaterialIndex2 < currentTest2.materials.length - 1) {
    currentTestMaterialIndex2++;
    displayTestMaterial2();
  }
}

function updateRecordingStatus2() {
  const statusDiv = document.getElementById('recordingStatusMessage');
  const completedCount = Object.keys(recordingsData2).length;
  const totalCount = currentTest2.materials.length;

  if (completedCount === totalCount) {
    statusDiv.innerHTML = `<p style="color: #48bb78; font-weight: bold;"> All materials completed! You can now submit the test.</p>`;
  } else {
    statusDiv.innerHTML = `<p style="color: #ed8936;">Completed: ${completedCount} of ${totalCount} materials</p>`;
  }
}

async function submitTestRecording2() {
  if (!currentTest2) return;

  if (Object.keys(recordingsData2).length !== currentTest2.materials.length) {
    alert('Please complete all test materials before submitting');
    return;
  }

  try {
    const uploadPromises = [];
    const recordingUrls = {};
    const transcriptions = {};

    for (const [index, data] of Object.entries(recordingsData2)) {
      const blob = data.blob || data; // Support both new format (object) and old format (blob)
      const fileName = `test2_${currentTest2.id}_material${index}_${currentUser.uid}_${Date.now()}.webm`;
      const storageRef = storage.ref().child(`recordings2/${fileName}`);

      if (data.transcription) {
        transcriptions[index] = data.transcription;
      }

      uploadPromises.push(
        storageRef.put(blob).then(snapshot =>
          snapshot.ref.getDownloadURL().then(url => {
            recordingUrls[index] = url;
          })
        )
      );
    }

    await Promise.all(uploadPromises);

    await db.collection('submissions2').add({
      testId: currentTest2.id,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      recordings: recordingUrls,
      transcriptions: transcriptions,
      submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'pending'
    });

    alert('Test2 submitted successfully!');
    closeTestModal();
    loadAvailableTests2();
  } catch (error) {
    alert('Error submitting test2: ' + error.message);
  }
}

async function loadSubmissions2() {
  const submissionsList = document.getElementById('submissionsList2');
  submissionsList.innerHTML = '<div class="loading"></div>';

  try {
    const submissionsSnapshot = await db.collection('submissions2').get();

    if (submissionsSnapshot.empty) {
      submissionsList.innerHTML = '<p>No submissions yet.</p>';
      return;
    }

    const allSubmissions = [];
    for (const subDoc of submissionsSnapshot.docs) {
      const submission = subDoc.data();

      const testDoc = await db.collection('tests2').doc(submission.testId).get();
      if (!testDoc.exists) continue;

      allSubmissions.push({
        id: subDoc.id,
        data: submission,
        test: testDoc.data()
      });
    }

    const studentGroups = {};
    allSubmissions.forEach(item => {
      const studentId = item.data.studentId;
      const studentEmail = item.data.studentEmail || 'Unknown Student';

      if (!studentGroups[studentId]) {
        studentGroups[studentId] = {
          email: studentEmail,
          submissions: []
        };
      }
      studentGroups[studentId].submissions.push(item);
    });

    window.studentFolderData2 = studentGroups;

    if (!document.getElementById('folderOverlay2')) {
      const overlay = document.createElement('div');
      overlay.id = 'folderOverlay2';
      overlay.className = 'folder-overlay';
      overlay.onclick = () => closeStudentFolderModal2();
      document.body.appendChild(overlay);

      const modal = document.createElement('div');
      modal.id = 'studentFolderModal2';
      modal.className = 'student-folder-content';
      document.body.appendChild(modal);
    }

    submissionsList.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 15px; padding-top: 15px;"></div>';
    const foldersContainer = submissionsList.firstChild;

    const sortedStudents = Object.entries(studentGroups).sort((a, b) => {
      const aPending = a[1].submissions.filter(s => s.data.status === 'pending').length;
      const bPending = b[1].submissions.filter(s => s.data.status === 'pending').length;

      if (aPending > 0 && bPending === 0) return -1;
      if (aPending === 0 && bPending > 0) return 1;

      const aLatest = Math.max(...a[1].submissions.map(s => s.data.submittedAt?.toDate?.() || 0));
      const bLatest = Math.max(...b[1].submissions.map(s => s.data.submittedAt?.toDate?.() || 0));
      return bLatest - aLatest;
    });

    sortedStudents.forEach(([studentId, group]) => {
      const pendingCount = group.submissions.filter(s => s.data.status === 'pending').length;
      const gradedCount = group.submissions.filter(s => s.data.status === 'graded').length;
      const needsGrading = pendingCount > 0;

      group.submissions.sort((a, b) => {
        const aTime = a.data.submittedAt ? a.data.submittedAt.toDate() : new Date(0);
        const bTime = b.data.submittedAt ? b.data.submittedAt.toDate() : new Date(0);
        return bTime - aTime;
      });

      const displayName = group.email.split('@')[0];

      const studentFolder = document.createElement('div');
      studentFolder.className = `student-folder ${needsGrading ? 'needs-grading' : 'all-graded'}`;
      studentFolder.dataset.studentEmail = group.email.toLowerCase();
      studentFolder.dataset.status = needsGrading ? 'needs-grading' : 'all-graded';
      studentFolder.onclick = () => openStudentFolderModal2(studentId);

      studentFolder.innerHTML = `
        <div class="student-folder-header">
          <div class="folder-icon">${needsGrading ? '' : ''}</div>
          <div class="student-name">${displayName}</div>
          <div class="student-stats">
            ${pendingCount > 0 ? `<span class="stat-badge stat-pending">${pendingCount}</span>` : ''}
            <span class="stat-badge stat-graded">${gradedCount}</span>
          </div>
        </div>
      `;

      foldersContainer.appendChild(studentFolder);
    });

  } catch (error) {
    submissionsList.innerHTML = '<p>Error loading submissions2: ' + error.message + '</p>';
  }
}

function openStudentFolderModal2(studentId) {
  const group = window.studentFolderData2[studentId];
  if (!group) return;

  const modal = document.getElementById('studentFolderModal2');
  const overlay = document.getElementById('folderOverlay2');

  const pendingCount = group.submissions.filter(s => s.data.status === 'pending').length;
  const gradedCount = group.submissions.filter(s => s.data.status === 'graded').length;

  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
      <div>
        <h3 style="margin: 0; color: #2d3748;"> ${group.email}</h3>
        <div style="margin-top: 8px; display: flex; gap: 10px;">
          ${pendingCount > 0 ? `<span style="background: #fef5e7; color: #d68910; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;"> ${pendingCount} Pending</span>` : ''}
          <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;"> ${gradedCount} Graded</span>
        </div>
      </div>
      <button onclick="closeStudentFolderModal2()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;"></button>
    </div>
    <div class="student-history" style="display: block;">
      ${group.submissions.map(item => {
        const statusColor = item.data.status === 'pending' ? '#f59e0b' : '#10b981';
        const statusText = item.data.status === 'pending' ? 'Pending' : 'Graded';
        const statusIcon = item.data.status === 'pending' ? '' : '';
        const submittedDate = item.data.submittedAt?.toDate?.();

        return `
          <div class="history-item" style="border-left-color: ${item.data.status === 'pending' ? '#48bb78' : '#667eea'};">
            <div class="history-date">
              ${submittedDate ? submittedDate.toLocaleDateString() : 'Recently'}
              ${submittedDate ? submittedDate.toLocaleTimeString() : ''}
            </div>
            <div class="history-test" style="font-size: 16px; margin: 8px 0;">${item.test?.title || 'Unknown Test'}</div>
            <div style="margin: 10px 0;">
              <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                ${statusIcon} ${statusText}
              </span>
              ${item.data.status === 'graded' && item.data.overallScore ? `
                <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 8px;">
                   ${item.data.overallScore}%
                </span>
              ` : ''}
            </div>
            ${item.data.status === 'pending' ? `
              <button onclick="closeStudentFolderModal2(); openGradingModal2('${item.id}')" class="btn" style="font-size: 13px; padding: 10px 20px; background: linear-gradient(135deg, #48bb78, #38a169); border: none; color: white; border-radius: 8px; cursor: pointer;">
                 Grade Now
              </button>
            ` : `
              <button onclick="closeStudentFolderModal2(); viewGradedSubmission2('${item.id}')" class="btn" style="font-size: 13px; padding: 10px 20px; background: #667eea; border: none; color: white; border-radius: 8px; cursor: pointer; margin-right: 8px;">
                 View Details
              </button>
              <button onclick="closeStudentFolderModal2(); openGradingModal2('${item.id}')" class="btn" style="font-size: 13px; padding: 10px 20px; background: #a0aec0; border: none; color: white; border-radius: 8px; cursor: pointer;">
                 Regrade
              </button>
            `}
          </div>
        `;
      }).join('')}
    </div>
  `;

  modal.classList.add('open');
  overlay.classList.add('open');
}

function closeStudentFolderModal2() {
  document.getElementById('studentFolderModal2')?.classList.remove('open');
  document.getElementById('folderOverlay2')?.classList.remove('open');
}

function toggleStudentFolder(studentId) {
  const history = document.getElementById('student-history-' + studentId);
  if (history) {
    history.classList.toggle('open');
  }
}

async function viewGradedSubmission2(submissionId) {
  try {
    const doc = await db.collection('submissions2').doc(submissionId).get();

    if (!doc.exists) {
      alert('Submission not found');
      return;
    }

    const submission = doc.data();

    const testDoc = await db.collection('tests2').doc(submission.testId).get();
    if (!testDoc.exists) {
      alert('Test not found');
      return;
    }

    const test = testDoc.data();

    let detailsHtml = `
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; margin: 20px auto;">
        <h2 style="color: #667eea; margin-bottom: 20px;">${test.title}</h2>
        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p><strong>Student:</strong> ${submission.studentEmail}</p>
          <p><strong>Submitted:</strong> ${submission.submittedAt ? submission.submittedAt.toDate().toLocaleString() : 'Recently'}</p>
          <p><strong>Overall Score:</strong> <span style="color: #48bb78; font-size: 24px; font-weight: 700;">${submission.overallScore || 0}%</span></p>
        </div>

        <h3 style="margin: 20px 0;">Topic Grades:</h3>
        ${test.materials.map((material, idx) => `
          <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="color: #2d3748; margin-bottom: 10px;">${material.title}</h4>
            ${material.topics.map(topic => {
              const gradeKey = idx + '_' + topic;
              const grade = submission.grades ? submission.grades[gradeKey] : null;
              const feedback = submission.feedback ? submission.feedback[gradeKey] : '';

              return `
                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                  <strong>${topic}:</strong>
                  <span style="color: #667eea; font-size: 18px; font-weight: 700;">${grade || 'N/A'}/10</span>
                  ${feedback ? `<p style="color: #718096; margin-top: 5px; font-style: italic;">"${feedback}"</p>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `).join('')}

        ${submission.teacherComments ? `
          <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <h4 style="color: #c53030;">Teacher Comments:</h4>
            <p style="color: #2d3748; margin-top: 10px;">${submission.teacherComments}</p>
          </div>
        ` : ''}

        <button onclick="this.parentElement.remove()" class="btn" style="margin-top: 20px;">Close</button>
      </div>
    `;

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto; padding: 20px;';
    overlay.innerHTML = detailsHtml;
    overlay.onclick = (e) => {
      if (e.target === overlay) overlay.remove();
    };
    document.body.appendChild(overlay);

  } catch (error) {
    alert('Error loading submission details: ' + error.message);
  }
}

async function openGradingModal2(submissionId) {
  try {
    const doc = await db.collection('submissions2').doc(submissionId).get();

    if (!doc.exists) {
      alert('Submission2 not found');
      return;
    }

    const submission = doc.data();

    const testDoc = await db.collection('tests2').doc(submission.testId).get();
    if (!testDoc.exists) {
      alert('Test2 not found');
      return;
    }

    const test = testDoc.data();

    const allTopics = [];
    test.materials.forEach((material, idx) => {
      material.topics.forEach(topic => {
        allTopics.push({
          topic: topic,
          materialIndex: idx,
          materialTitle: material.title,
          recording: submission.recordings && submission.recordings[idx] ? submission.recordings[idx] : null,
          transcription: submission.transcriptions && submission.transcriptions[idx] ? submission.transcriptions[idx] : null,
          gradeKey: `${idx}_${topic}`
        });
      });
    });

    const consonants = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
    const vowels = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

    allTopics.sort((a, b) => {
      const aIsConsonant = consonants.includes(a.topic);
      const bIsConsonant = consonants.includes(b.topic);
      const aIsVowel = vowels.includes(a.topic);
      const bIsVowel = vowels.includes(b.topic);

      if (aIsConsonant && bIsVowel) return -1;
      if (aIsVowel && bIsConsonant) return 1;

      if (aIsConsonant && bIsConsonant) {
        return consonants.indexOf(a.topic) - consonants.indexOf(b.topic);
      }
      if (aIsVowel && bIsVowel) {
        return vowels.indexOf(a.topic) - vowels.indexOf(b.topic);
      }

      return a.topic.localeCompare(b.topic);
    });

    const itemsPerPage = 10;
    const totalPages = Math.ceil(allTopics.length / itemsPerPage);

    window.currentGradingData2 = {
      submissionId: submissionId,
      submission: submission,
      grades: {},
      test: test,
      allTopics: allTopics,
      currentPage: 1,
      totalPages: totalPages,
      itemsPerPage: itemsPerPage,
      level2Unlocked: submission.level2Unlocked || false,
      existingVideoFeedbackUrl: submission.videoFeedbackUrl || null // Store existing video URL
    };

    allTopics.forEach(item => {
      if (submission.grades && submission.grades[item.gradeKey] !== undefined) {
        window.currentGradingData2.grades[item.gradeKey] = submission.grades[item.gradeKey];
      } else {
        window.currentGradingData2.grades[item.gradeKey] = null;
      }
    });

    displayGradingPage2(1);

  } catch (error) {
    alert('Error loading grading modal2: ' + error.message);
  }
}

function displayGradingPage2(pageNum) {
  const data = window.currentGradingData2;
  if (!data) return;

  data.currentPage = pageNum;

  const modal = document.getElementById('gradingModal');
  const content = document.getElementById('gradingContent');

  const startIdx = (pageNum - 1) * data.itemsPerPage;
  const endIdx = Math.min(startIdx + data.itemsPerPage, data.allTopics.length);
  const pageTopics = data.allTopics.slice(startIdx, endIdx);

  const consonants = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
  const hasConsonants = pageTopics.some(item => consonants.includes(item.topic));
  const hasVowels = pageTopics.some(item => !consonants.includes(item.topic));

  let categoryLabel = '';
  if (hasConsonants && !hasVowels) categoryLabel = ' - Consonants ()';
  else if (hasVowels && !hasConsonants) categoryLabel = ' - Vowels ()';
  else if (hasConsonants && hasVowels) categoryLabel = ' - Mixed';

  let pagePreview = '';
  for (let i = 1; i <= data.totalPages; i++) {
    const pStartIdx = (i - 1) * data.itemsPerPage;
    const pEndIdx = Math.min(pStartIdx + data.itemsPerPage, data.allTopics.length);
    const firstTopic = data.allTopics[pStartIdx].topic;
    const lastTopic = data.allTopics[Math.min(pEndIdx - 1, data.allTopics.length - 1)].topic;

    pagePreview += `
      <button onclick="displayGradingPage2(${i})"
              class="btn"
              style="padding: 4px 8px; margin: 2px; font-size: 12px;
                     ${i === pageNum ? 'background: #667eea; color: white;' : 'background: #f7fafc;'}">
        ${i}: ${firstTopic}-${lastTopic}
      </button>
    `;
  }

  const gradedCount = Object.values(data.grades).filter(g => g !== null && g !== undefined).length;
  const totalCount = data.allTopics.length;

  let gradingHtml = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>${data.test.title} <span style="font-size: 14px; color: #667eea; font-weight: normal;">Level 1: Consonant Aspirations</span></h3>
    </div>

    <!-- Navigation Buttons - TOP -->
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f0f5ff; border-radius: 12px;">
      <button onclick="displayGradingPage2(${pageNum - 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === 1 ? 'disabled' : ''}>
         Previous Page
      </button>
      <span style="padding: 10px 20px; font-weight: 600; color: #667eea; display: flex; align-items: center;">
        Page ${pageNum} / ${data.totalPages}${categoryLabel}
      </span>
      <button onclick="displayGradingPage2(${pageNum + 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === data.totalPages ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === data.totalPages ? 'disabled' : ''}>
        Next Page 
      </button>
    </div>

    <!-- Quick Actions Bar -->
    <div style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
      <div style="color: white;">
        <strong> Quick Actions</strong>
        <span style="opacity: 0.9; margin-left: 10px;">Graded: ${gradedCount}/${totalCount}</span>
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="rateAllTopicsOnPage(10)" class="btn" style="background: white; color: #276749; padding: 8px 16px; font-weight: 600;">
           Rate Page as 10
        </button>
        <button onclick="rateAllTopics(10)" class="btn" style="background: #f0fff4; color: #276749; padding: 8px 16px; font-weight: 600; border: 2px solid white;">
           Rate ALL as 10
        </button>
      </div>
    </div>

    <!-- Quick Page Navigation -->
    <div style="background: #f7fafc; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
      <div style="font-size: 12px; color: #4a5568; margin-bottom: 5px;">Quick Navigation (Click to jump):</div>
      <div style="display: flex; flex-wrap: wrap;">
        ${pagePreview}
      </div>
    </div>

    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
      <p><strong>Student:</strong> ${data.submission.studentEmail}</p>
      <p><strong>Submitted:</strong> ${data.submission.submittedAt ? data.submission.submittedAt.toDate().toLocaleString() : 'Recently'}</p>
      <p><strong>Progress:</strong> Showing topics ${startIdx + 1}-${endIdx} of ${data.allTopics.length}</p>
      <p style="font-size: 12px; color: #718096; margin-top: 10px;"> Tip: Use arrow keys ( ) to navigate pages quickly</p>
    </div>

    <div style="margin-top: 20px;">
  `;

  const materialGroups = {};
  pageTopics.forEach(item => {
    if (!materialGroups[item.materialIndex]) {
      materialGroups[item.materialIndex] = {
        title: item.materialTitle,
        recording: item.recording,
        transcription: item.transcription,
        topics: []
      };
    }
    materialGroups[item.materialIndex].topics.push(item);
  });

  Object.entries(materialGroups).forEach(([materialIdx, material]) => {
    gradingHtml += `
      <div class="grading-section" style="margin-bottom: 25px;">
        <h4 style="color: #2d3748; margin-bottom: 10px;">${material.title}</h4>
        ${material.recording ? `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
              <h5 style="color: #9f7aea; margin-bottom: 10px;"> Student Recording</h5>
              <video controls preload="metadata" src="${material.recording}" style="width: 100%; border-radius: 8px; max-height: 300px;"></video>
            </div>
            <div>
              <h5 style="color: #48bb78; margin-bottom: 10px;"> Korean Transcription</h5>
              <div style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; min-height: 150px; max-height: 300px; overflow-y: auto; font-size: 16px; line-height: 1.8;">
                ${material.transcription ?
                  `<p style="color: #2d3748; white-space: pre-wrap; margin: 0;">${material.transcription}</p>` :
                  `<p style="color: #a0aec0; font-style: italic; margin: 0;">No transcription available. This may be an older submission or speech was not detected.</p>`
                }
              </div>
            </div>
          </div>
        ` : '<p style="color: #f56565;">No recording available</p>'}
        <div>
    `;

    material.topics.forEach((item, idx) => {
      const existingGrade = data.grades[item.gradeKey];
      const isUngraded = existingGrade === null || existingGrade === undefined;
      const topicNumber = startIdx + materialGroups[materialIdx].topics.indexOf(item) + 1;

      gradingHtml += `
        <div style="margin: 15px 0; padding: 15px; background: ${isUngraded ? '#fff5f5' : '#fff'}; border-radius: 8px; border: 2px solid ${isUngraded ? '#feb2b2' : '#e2e8f0'};">
          <label style="font-weight: 600; font-size: 20px; color: #2d3748;">
            <span style="color: #718096; font-size: 14px;">#${topicNumber}</span> ${item.topic} - Grade:
            ${isUngraded ? '<span class="ungraded-indicator">(Not yet graded)</span>' : ''}
          </label>
          <div class="grade-selector ${isUngraded ? 'ungraded' : ''}" style="margin-top: 10px;">
            ${[1,2,3,4,5,6,7,8,9,10].map(grade => `
              <button class="grade-btn ${existingGrade == grade ? 'selected' : ''}"
                      onclick="selectGrade2('${item.gradeKey}', ${grade}, this)"
                      style="width: 45px; height: 45px; font-size: 16px;">
                ${grade}
              </button>
            `).join('')}
          </div>
        </div>
      `;
    });

    gradingHtml += `
        </div>
      </div>
    `;
  });

  gradingHtml += `
    </div>

    <!-- Navigation buttons at bottom too -->
    <div style="display: flex; justify-content: center; gap: 15px; margin: 20px 0; padding: 20px 0; border-top: 1px solid #e2e8f0;">
      <button onclick="displayGradingPage2(${pageNum - 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === 1 ? 'disabled' : ''}>
         Previous Page
      </button>
      <span style="padding: 10px 20px; font-weight: 600; color: #667eea;">
        ${pageNum} / ${data.totalPages}
      </span>
      <button onclick="displayGradingPage2(${pageNum + 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === data.totalPages ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === data.totalPages ? 'disabled' : ''}>
        Next Page 
      </button>
    </div>
  `;

  if (pageNum === data.totalPages) {
    const allGradedTopics = [];
    data.allTopics.forEach(item => {
      const grade = data.grades[item.gradeKey];
      if (grade !== null && grade !== undefined) {
        allGradedTopics.push({
          topic: item.topic,
          grade: grade,
          gradeKey: item.gradeKey
        });
      }
    });

    const lowestGrades = allGradedTopics
      .sort((a, b) => a.grade - b.grade)
      .slice(0, 10);

    if (lowestGrades.length > 0) {
      gradingHtml += `
        <!-- Lowest Grades Summary for Teacher Reference -->
        <div id="lowestGradesSummary" style="margin-top: 30px; background: #fff5f5; padding: 20px; border-radius: 12px; border: 2px solid #feb2b2;">
          <h4 style="color: #c53030; margin-bottom: 15px;">
             Student's ${lowestGrades.length} Lowest Scores - Reference for Video Feedback
          </h4>
          <p style="color: #742a2a; font-size: 14px; margin-bottom: 15px;">
            These topics need the most attention. Consider mentioning them in your video feedback:
          </p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            ${lowestGrades.map((item, index) => `
              <div style="background: white; padding: 10px; border-radius: 8px; border-left: 4px solid ${item.grade < 5 ? '#f56565' : item.grade < 7 ? '#ed8936' : '#f6ad55'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 20px; font-weight: bold; color: #2d3748;">
                    ${item.topic}
                  </span>
                  <span style="font-size: 18px; font-weight: bold; color: ${item.grade < 5 ? '#f56565' : item.grade < 7 ? '#ed8936' : '#f6ad55'};">
                    ${item.grade}/10
                  </span>
                </div>
                ${item.grade < 5 ? '<div style="font-size: 11px; color: #c53030; margin-top: 4px;">Needs work!</div>' : ''}
              </div>
            `).join('')}
          </div>
          <div style="margin-top: 15px; padding: 10px; background: #fed7d7; border-radius: 6px;">
            <p style="color: #742a2a; font-size: 13px; margin: 0;">
              <strong> Video Tips:</strong> Focus on pronunciation techniques for these characters.
              Demonstrate correct mouth position and provide encouragement for improvement.
            </p>
          </div>
        </div>
      `;
    } else {
      gradingHtml += `
        <!-- No Grades Yet Notice -->
        <div id="lowestGradesSummary" style="margin-top: 30px; background: #fef5e7; padding: 20px; border-radius: 12px; border: 2px solid #f9c851;">
          <h4 style="color: #7c4a03; margin-bottom: 10px;">
             No Grades Entered Yet
          </h4>
          <p style="color: #7c4a03; font-size: 14px;">
            Please grade the topics on the previous pages before recording your video feedback.
          </p>
        </div>
      `;
    }

    gradingHtml += `
      <!-- Teacher Feedback Video Section -->
      <div style="margin-top: 30px; background: #f7fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <h4 style="color: #667eea; margin-bottom: 15px;"> Add Feedback Video (Optional)</h4>
        <p style="color: #718096; margin-bottom: 15px;">Record a video or upload a pre-recorded feedback for this student</p>

        ${data.existingVideoFeedbackUrl ? `
        <!-- Existing Video Section -->
        <div id="existingVideoSection" style="background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #48bb78;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="font-size: 24px;"></span>
            <div>
              <h5 style="color: #276749; margin: 0;">Video Already Uploaded</h5>
              <p style="color: #2f855a; font-size: 13px; margin: 0;">A feedback video is already attached to this submission</p>
            </div>
          </div>
          <video controls style="width: 100%; max-width: 500px; border-radius: 8px; border: 2px solid #48bb78; display: block; margin: 0 auto;">
            <source src="${data.existingVideoFeedbackUrl}" type="video/webm">
            <source src="${data.existingVideoFeedbackUrl}" type="video/mp4">
          </video>
          <div style="text-align: center; margin-top: 15px;">
            <button onclick="deleteExistingFeedbackVideo('${data.submissionId}')" class="btn btn-danger" style="background: #f56565;">
               Delete Existing Video
            </button>
            <p style="color: #718096; font-size: 12px; margin-top: 10px;">Or record/upload a new video below to replace it</p>
          </div>
        </div>
        ` : ''}

        <!-- Tab Selection -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
          <button id="recordTabBtn" onclick="switchVideoTab('record')" class="btn" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px 8px 0 0;">
             Record Video
          </button>
          <button id="uploadTabBtn" onclick="switchVideoTab('upload')" class="btn" style="flex: 1; padding: 12px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px 8px 0 0;">
             Upload Video
          </button>
        </div>

        <!-- Record Tab Content -->
        <div id="recordTabContent">
          <!-- Video Preview/Playback -->
          <div class="video-preview-container" style="max-width: 400px; margin: 0 auto 20px auto; display: none;" id="gradingVideoContainer">
            <video id="gradingVideoPreview" class="video-preview" style="width: 100%; border-radius: 8px; transform: scaleX(-1);"></video>
            <div class="video-preview-label">REC</div>
          </div>
          <video id="gradingRecordedVideo" controls style="width: 100%; max-width: 400px; border-radius: 8px; display: none; margin: 0 auto 20px auto;"></video>

          <!-- Recording Controls -->
          <div style="text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button id="gradingStartVideoBtn" onclick="startGradingVideoRecording()" class="btn btn-secondary">
               Start Recording
            </button>
            <button id="gradingStopVideoBtn" onclick="stopGradingVideoRecording()" class="btn btn-danger" style="display: none;">
               Stop Recording
            </button>
            <button id="gradingRetakeVideoBtn" onclick="retakeGradingVideo()" class="btn btn-warning" style="display: none;">
               Retake Video
            </button>
            <button id="gradingRemoveVideoBtn" onclick="removeGradingVideo()" class="btn btn-danger" style="display: none;">
               Remove Video
            </button>
          </div>
        </div>

        <!-- Upload Tab Content -->
        <div id="uploadTabContent" style="display: none;">
          <div style="background: white; border: 3px dashed #cbd5e0; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;"
               onclick="document.getElementById('feedbackVideoUpload').click()"
               onmouseover="this.style.borderColor='#667eea'; this.style.background='#f0f5ff';"
               onmouseout="this.style.borderColor='#cbd5e0'; this.style.background='white';">
            <div style="font-size: 48px; margin-bottom: 10px;"></div>
            <p style="color: #4a5568; font-weight: 600; margin-bottom: 5px;">Click to upload a video file</p>
            <p style="color: #718096; font-size: 13px;">Supports MP4, WebM, MOV (max 100MB)</p>
          </div>
          <input type="file" id="feedbackVideoUpload" accept="video/*" style="display: none;" onchange="handleFeedbackVideoUpload(event)">

          <!-- Uploaded Video Preview -->
          <div id="uploadedVideoPreviewContainer" style="display: none; margin-top: 20px;">
            <video id="uploadedVideoPreview" controls style="width: 100%; max-width: 400px; border-radius: 8px; margin: 0 auto; display: block;"></video>
            <div style="text-align: center; margin-top: 15px;">
              <button onclick="removeUploadedVideo()" class="btn btn-danger">
                 Remove Uploaded Video
              </button>
            </div>
          </div>
        </div>

        <!-- Recording/Upload Status -->
        <div id="gradingVideoStatus" style="text-align: center; margin: 15px 0; font-weight: 600; color: #667eea;"></div>
      </div>

      <!-- Level 2: Consonant Assimilation Button -->
      <div style="margin-top: 30px; background: linear-gradient(135deg, #9f7aea20 0%, #667eea20 100%); padding: 20px; border-radius: 12px; border: 2px solid #9f7aea;">
        <h4 style="color: #6b46c1; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
           Level 2: Consonant Assimilation
          <span style="background: #9f7aea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">Advanced</span>
        </h4>
        <p style="color: #553c9a; margin-bottom: 15px; font-size: 14px;">
          After completing Level 1 grading, unlock Level 2 to grade the student on 22 consonant assimilation rules.
        </p>

        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <p style="color: #4a5568; font-size: 14px; margin-bottom: 10px;">
            <strong>What is Consonant Assimilation?</strong>
          </p>
          <p style="color: #718096; font-size: 13px; margin-bottom: 10px;">
            When consonants meet at syllable boundaries, they change sounds. Examples:
          </p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
            <div style="background: #f7fafc; padding: 6px 10px; border-radius: 6px; font-size: 12px;">
              <strong></strong>  [] <span style="color: #9f7aea;">(++)</span>
            </div>
            <div style="background: #f7fafc; padding: 6px 10px; border-radius: 6px; font-size: 12px;">
              <strong></strong>  [] <span style="color: #9f7aea;">(++)</span>
            </div>
            <div style="background: #f7fafc; padding: 6px 10px; border-radius: 6px; font-size: 12px;">
              <strong></strong>  [] <span style="color: #9f7aea;">(+)</span>
            </div>
            <div style="background: #f7fafc; padding: 6px 10px; border-radius: 6px; font-size: 12px;">
              <strong></strong>  [] <span style="color: #9f7aea;">(+)</span>
            </div>
          </div>
        </div>

        <div style="text-align: center;">
          <button onclick="openLevel2Grading('${data.submissionId}')" class="btn btn-secondary" style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); padding: 15px 40px; font-size: 16px; border: none;">
             Unlock & Grade Level 2 (22 Rules)
          </button>
          <p style="color: #805ad5; font-size: 12px; margin-top: 10px;">
            Grading scale: 1-5 (1 = needs most practice, 5 = mastered)
          </p>
        </div>
      </div>

      <!-- Bottom Action Buttons -->
      <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
        <button onclick="saveGrading2('${data.submissionId}')" class="btn btn-secondary" style="flex: 1; min-width: 200px; font-size: 16px; padding: 12px 24px;">
           Save Level 1 Grading & Feedback
        </button>
        <button onclick="closeGradingModal()" class="btn" style="min-width: 120px; font-size: 16px; padding: 12px 24px; background: #e2e8f0; color: #4a5568;">
           Close
        </button>
      </div>
    `;
  }

  content.innerHTML = gradingHtml;
  modal.classList.add('active');

  fixWebmVideoDuration(content);

  if (!window.gradingKeyboardListenerAdded) {
    window.gradingKeyboardListenerAdded = true;
    document.addEventListener('keydown', function(e) {
      if (window.currentGradingData2 && modal.classList.contains('active')) {
        if (e.key === 'ArrowLeft' && data.currentPage > 1) {
          displayGradingPage2(data.currentPage - 1);
        } else if (e.key === 'ArrowRight' && data.currentPage < data.totalPages) {
          displayGradingPage2(data.currentPage + 1);
        }
      }
    });
  }
}

function selectGrade2(key, grade, button) {
  const parent = button.parentElement;
  parent.querySelectorAll('.grade-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  button.classList.add('selected');

  window.currentGradingData2.grades[key] = grade;

  if (window.currentGradingData2 &&
      window.currentGradingData2.currentPage === window.currentGradingData2.totalPages) {
    updateLowestGradesSummary();
  }
}

function updateLowestGradesSummary() {
  const summaryElement = document.getElementById('lowestGradesSummary');
  if (!summaryElement) return;

  const data = window.currentGradingData2;
  const allGradedTopics = [];

  data.allTopics.forEach(item => {
    const grade = data.grades[item.gradeKey];
    if (grade !== null && grade !== undefined) {
      allGradedTopics.push({
        topic: item.topic,
        grade: grade,
        gradeKey: item.gradeKey
      });
    }
  });

  const lowestGrades = allGradedTopics
    .sort((a, b) => a.grade - b.grade)
    .slice(0, 10);

  if (lowestGrades.length > 0) {
    summaryElement.innerHTML = `
      <h4 style="color: #c53030; margin-bottom: 15px;">
         Student's ${lowestGrades.length} Lowest Scores - Reference for Video Feedback
      </h4>
      <p style="color: #742a2a; font-size: 14px; margin-bottom: 15px;">
        These topics need the most attention. Consider mentioning them in your video feedback:
      </p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
        ${lowestGrades.map((item, index) => `
          <div style="background: white; padding: 10px; border-radius: 8px; border-left: 4px solid ${item.grade < 5 ? '#f56565' : item.grade < 7 ? '#ed8936' : '#f6ad55'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 20px; font-weight: bold; color: #2d3748;">
                ${item.topic}
              </span>
              <span style="font-size: 18px; font-weight: bold; color: ${item.grade < 5 ? '#f56565' : item.grade < 7 ? '#ed8936' : '#f6ad55'};">
                ${item.grade}/10
              </span>
            </div>
            ${item.grade < 5 ? '<div style="font-size: 11px; color: #c53030; margin-top: 4px;">Needs work!</div>' : ''}
          </div>
        `).join('')}
      </div>
      <div style="margin-top: 15px; padding: 10px; background: #fed7d7; border-radius: 6px;">
        <p style="color: #742a2a; font-size: 13px; margin: 0;">
          <strong> Video Tips:</strong> Focus on pronunciation techniques for these characters.
          Demonstrate correct mouth position and provide encouragement for improvement.
        </p>
      </div>
    `;
  }
}

/**
 * Update the graded count display in quick actions bar
 */
function updateGradedCount() {
  const data = window.currentGradingData2;
  if (!data) return;

  const gradedCount = Object.values(data.grades).filter(g => g !== null && g !== undefined).length;
  const totalCount = data.allTopics.length;

  const countSpans = document.querySelectorAll('span');
  countSpans.forEach(span => {
    if (span.textContent.includes('Graded:')) {
      span.textContent = `Graded: ${gradedCount}/${totalCount}`;
    }
  });
}

/**
 * Rate all topics on the current page with a specific grade
 */
function rateAllTopicsOnPage(grade) {
  const data = window.currentGradingData2;
  if (!data) return;

  const startIdx = (data.currentPage - 1) * data.itemsPerPage;
  const endIdx = Math.min(startIdx + data.itemsPerPage, data.allTopics.length);
  const pageTopics = data.allTopics.slice(startIdx, endIdx);

  pageTopics.forEach(item => {
    data.grades[item.gradeKey] = grade;
  });

  displayGradingPage2(data.currentPage);
}

/**
 * Rate ALL topics in the entire test with a specific grade
 */
function rateAllTopics(grade) {
  const data = window.currentGradingData2;
  if (!data) return;

  if (!confirm(`Are you sure you want to rate ALL ${data.allTopics.length} topics as ${grade}/10?\n\nThis will overwrite any existing grades.`)) {
    return;
  }

  data.allTopics.forEach(item => {
    data.grades[item.gradeKey] = grade;
  });

  displayGradingPage2(data.currentPage);
}

/**
 * Toggle Level 2 (Consonant Assimilation) unlock for student
 */
function toggleLevel2Unlock(checked) {
  const data = window.currentGradingData2;
  if (!data) return;

  data.level2Unlocked = checked;

  const checkbox = document.getElementById('unlockLevel2Checkbox');
  if (checkbox) {
    const label = checkbox.parentElement;
    if (checked) {
      label.style.background = '#9f7aea';
      label.style.color = 'white';
    } else {
      label.style.background = 'white';
      label.style.color = '#6b46c1';
    }
  }
}


const CONSONANT_ASSIMILATION_RULES = [
  { id: 1, rule: '(//) + (/)  []', example: '  []', description: 'Velar nasalization' },
  { id: 2, rule: '(//) +   [ + ]', example: '  []', description: 'Velar + liquid' },
  { id: 3, rule: ' +   [ + ]', example: '  []', description: 'Nasal lateralization' },
  { id: 4, rule: ' +   [ + ]', example: '  []', description: 'Lateral assimilation' },
  { id: 5, rule: '(/) + (/)  []', example: '  []', description: 'Bilabial nasalization' },
  { id: 6, rule: ' +   [ + ]', example: '  []', description: 'Nasal + liquid' },
  { id: 7, rule: ' + (/)  [/]', example: '  []', description: 'Palatalization ()' },
  { id: 8, rule: ' + (/)  [/]', example: '  []', description: 'Palatalization ()' },
  { id: 9, rule: '(/) +   [/]', example: '  []', description: 'Sibilant palatalization' },
  { id: 10, rule: ' +   [ + ]', example: '  []', description: 'Bilabial + liquid' },
  { id: 11, rule: '(/) + (/)  []', example: '  []', description: 'Dental nasalization' },
  { id: 12, rule: ' +   []', example: '  []', description: 'Fricative + stop' },
  { id: 13, rule: '(/) + (/)  []', example: '  []', description: 'Affricate nasalization' },
  { id: 14, rule: ' +   []', example: '  []', description: 'Fricative aspiration' },
  { id: 15, rule: ' +   [ + ]', example: '  []', description: 'Nasal place assimilation' },
  { id: 16, rule: ' +   []', example: '  []', description: 'Nasal velarization' },
  { id: 17, rule: ' +   [ + ]', example: '  []', description: 'Velar nasal + liquid' },
  { id: 18, rule: ' + (//)  [//]', example: '  []', description: 'H-aspiration (preceding)' },
  { id: 19, rule: '(///) +   [///]', example: '  []', description: 'H-aspiration (following)' },
  { id: 20, rule: '(/) + (/)  []', example: '  []', description: 'Sibilant nasalization' },
  { id: 21, rule: ' +   []', example: '  []', description: 'H + sibilant tensification' },
  { id: 22, rule: ' +   []', example: '  []', description: 'H-deletion before nasal' }
];

const LEVEL2_DRILL_REPS = {
  1: 5,  // 5 times per day
  2: 4,  // 4 times per day
  3: 3,  // 3 times per day
  4: 0   // Mastered - no drills needed
};

const LEVEL2_INSTRUCTIONAL_VIDEOS = {
  1: 'https://www.loom.com/share/78fd3b3fdc6e45dcb9d53c83d441020b',   // (//) + (/)  []
  2: 'https://www.loom.com/share/d0192c0048c04f9db341dfe5d23235e0',   // (//) +   [ + ]
  3: 'https://www.loom.com/share/801f7c8f585448c1800e337ec19061f3',   //  +   [ + ]
  4: 'https://www.loom.com/share/08c4f88db30c4a018eb3dda3951d1edb',   //  +   [ + ]
  5: 'https://www.loom.com/share/4bcc5d4db5a6406abc4711eb5c4ca651',   // (/) + (/)  []
  6: 'https://www.loom.com/share/e004140c37e84b119b13e55cbfd497ea',   //  +   [ + ]
  7: 'https://www.loom.com/share/f9abb105ff154342a7fe73a902bb3301',   //  + (/)  [/]
  8: 'https://www.loom.com/share/eb60c3ad13f94fbd93931d2c8f6ec653',   //  + (/)  [/]
  9: null,  // (/) +   [/] - No video yet
  10: 'https://www.loom.com/share/f6309e48771b4ef0b632fa35e8d9d042',  //  +   [ + ]
  11: 'https://www.loom.com/share/77590305ce8c4fd196ef1ee32dc7e9df',  // (/) + (/)  []
  12: null,  //  +   [] - No video yet
  13: 'https://www.loom.com/share/9b20f0f5c10a4d21b8fc8b562ec60178',  // (/) + (/)  []
  14: 'https://www.loom.com/share/1551f42e0459474a8b8c77b503d2ea7d',  //  +   []
  15: 'https://www.loom.com/share/4e7b3cf2fa5b4c46b427eb4dc255b6f1',  //  +   [ + ]
  16: 'https://www.loom.com/share/46befee9185941b2a52df0fa171035e0',  //  +   []
  17: 'https://www.loom.com/share/9d1b806d2d05476aa1bae2ed0327ee8a',  //  +   [ + ]
  18: 'https://www.loom.com/share/a173524233ea466191a3056d83e083f2',  //  + (//)  [//]
  19: 'https://www.loom.com/share/32c8c2afaa77491fa57029e4aa0e21f4',  // (///) +   [///]
  20: 'https://www.loom.com/share/edfe42664649473da48ef414ea763f5f',  // (/) + (/)  []
  21: 'https://www.loom.com/share/2c462c308e844f16ad85b830dd3989e8',  //  +   []
  22: 'https://www.loom.com/share/904dd7a4c56b4594878dc507ec2f3deb'   //  +   []
};

let consonantAssimilationDrills = {};

/**
 * Toggle consonant assimilation section visibility
 */
function toggleConsonantAssimilationSection() {
  const container = document.getElementById('consonantAssimilationDrillsContainer');
  const btn = document.getElementById('caToggleBtn');

  if (container.style.display === 'none') {
    container.style.display = 'block';
    btn.textContent = ' Collapse Section';
    renderConsonantAssimilationRules();
  } else {
    container.style.display = 'none';
    btn.textContent = ' Expand Section';
  }
}

/**
 * Render all 22 consonant assimilation rules with video previews and drill input
 */
function renderConsonantAssimilationRules() {
  const container = document.getElementById('caRulesList');
  if (!container) return;

  let html = `
    <div style="margin-bottom: 15px; padding: 12px; background: #ede9fe; border-radius: 8px; font-size: 13px; color: #5b21b6;">
       <strong>Drill Words by Score:</strong> For each rule, add practice words that students will drill based on their score level.
      Lower scores = more repetitions.
    </div>
  `;

  CONSONANT_ASSIMILATION_RULES.forEach(rule => {
    const videoUrl = LEVEL2_INSTRUCTIONAL_VIDEOS[rule.id];
    const hasDrills = consonantAssimilationDrills[rule.id] &&
      Object.values(consonantAssimilationDrills[rule.id]).some(arr => arr && arr.length > 0);

    html += `
      <div class="ca-rule-card" style="background: white; border: 2px solid ${hasDrills ? '#a855f7' : '#e9d5ff'}; border-radius: 12px; margin-bottom: 15px; overflow: hidden;">
        <!-- Rule Header -->
        <div style="padding: 15px; background: ${hasDrills ? 'linear-gradient(135deg, #f3e8ff, #ede9fe)' : '#faf5ff'}; border-bottom: 1px solid #e9d5ff; cursor: pointer;"
             onclick="toggleCARuleDrills(${rule.id})">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <span style="background: #7c3aed; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                  Rule ${rule.id}
                </span>
                <span style="font-weight: 600; color: #5b21b6; font-size: 15px;">${rule.rule}</span>
                ${hasDrills ? '<span style="color: #a855f7; font-size: 14px;"> Has Drills</span>' : ''}
              </div>
              <div style="font-size: 13px; color: #7c3aed;">
                <span style="margin-right: 15px;">Example: <strong>${rule.example}</strong></span>
                <span style="opacity: 0.8;">${rule.description}</span>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              ${videoUrl ? `
                <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation();"
                   style="background: #7c3aed; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; text-decoration: none;">
                   Watch Video
                </a>
              ` : '<span style="color: #a1a1aa; font-size: 12px;">No video yet</span>'}
              <span id="caRuleToggle-${rule.id}" style="color: #7c3aed; font-size: 18px;"></span>
            </div>
          </div>
        </div>

        <!-- Drill Input Section (collapsed by default) -->
        <div id="caRuleDrills-${rule.id}" style="display: none; padding: 15px; background: #faf5ff;">
          <!-- Score Tabs (1-4 only, score 5 = mastered = no drills) -->
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e9d5ff; padding-bottom: 10px;">
            ${[1,2,3,4].map(score => {
              const reps = {1:5, 2:4, 3:3, 4:2}[score];
              return `
                <button type="button"
                  id="ca-score-tab-${rule.id}-${score}"
                  onclick="showCAScoreDrills(${rule.id}, ${score})"
                  style="padding: 8px 14px; border: 2px solid #e9d5ff; background: white; border-radius: 6px; cursor: pointer;
                         font-size: 13px; color: #6b21a8; transition: all 0.2s;">
                  Score ${score} <span style="opacity: 0.7; font-size: 11px;">(${reps}/day)</span>
                </button>
              `;
            }).join('')}
            <span style="padding: 8px 14px; font-size: 13px; color: #48bb78; display: flex; align-items: center;">
              Score 5 = Mastered 
            </span>
          </div>

          <!-- Drill Content Area -->
          <div id="ca-drill-content-${rule.id}" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9d5ff;">
            <div style="text-align: center; color: #7c3aed; padding: 20px;">
               Click a score tab to add drill words for that score level
            </div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

/**
 * Toggle individual rule's drill section
 */
function toggleCARuleDrills(ruleId) {
  const section = document.getElementById(`caRuleDrills-${ruleId}`);
  const toggle = document.getElementById(`caRuleToggle-${ruleId}`);

  if (section.style.display === 'none') {
    section.style.display = 'block';
    toggle.textContent = '';
  } else {
    section.style.display = 'none';
    toggle.textContent = '';
  }
}

/**
 * Show drill word inputs for a specific score level
 */
function showCAScoreDrills(ruleId, score) {
  const contentDiv = document.getElementById(`ca-drill-content-${ruleId}`);
  if (!contentDiv) return;

  for (let s = 1; s <= 4; s++) {
    const tab = document.getElementById(`ca-score-tab-${ruleId}-${s}`);
    if (tab) {
      if (s === score) {
        tab.style.background = '#7c3aed';
        tab.style.color = 'white';
        tab.style.borderColor = '#7c3aed';
      } else {
        const hasDrills = consonantAssimilationDrills[ruleId]?.[s]?.filter(w => w).length > 0;
        tab.style.background = hasDrills ? '#f3e8ff' : 'white';
        tab.style.color = '#6b21a8';
        tab.style.borderColor = hasDrills ? '#a855f7' : '#e9d5ff';
      }
    }
  }

  const drillWords = consonantAssimilationDrills[ruleId]?.[score] || [];
  const reps = {1:5, 2:4, 3:3, 4:2}[score];

  contentDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h6 style="margin: 0; color: #5b21b6;">
        Score ${score} Drill Words
        <span style="font-weight: normal; color: #7c3aed;">(Students repeat ${reps} per day)</span>
      </h6>
      <span style="font-size: 13px; color: ${drillWords.filter(w => w).length >= 5 ? '#a855f7' : '#f59e0b'};">
        ${drillWords.filter(w => w).length}/20 words
      </span>
    </div>

    <!-- Bulk paste area -->
    <div style="margin-bottom: 15px; padding: 10px; background: #f3e8ff; border-radius: 8px;">
      <label style="font-size: 12px; color: #6b21a8; font-weight: 600;">Quick Paste (one word per line):</label>
      <textarea id="ca-bulk-${ruleId}-${score}" rows="2"
        placeholder="Paste up to 20 words, one per line..."
        style="width: 100%; padding: 8px; border: 1px solid #d8b4fe; border-radius: 6px; margin-top: 5px; font-size: 14px;"
        onchange="parseCABulkDrills(${ruleId}, ${score}, this.value)"></textarea>
    </div>

    <!-- Individual word inputs in 4-column grid -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
      ${Array.from({length: 20}, (_, i) => `
        <input type="text" id="ca-word-${ruleId}-${score}-${i}"
          placeholder="${i+1}."
          style="padding: 8px; border: 1px solid #d8b4fe; border-radius: 6px; background: white; font-size: 14px;"
          value="${drillWords[i] || ''}"
          onchange="updateCADrillWord(${ruleId}, ${score}, ${i}, this.value)">
      `).join('')}
    </div>
  `;
}

/**
 * Parse bulk pasted drill words for consonant assimilation
 */
function parseCABulkDrills(ruleId, score, value) {
  const words = value.split('\n').map(w => w.trim()).filter(w => w.length > 0).slice(0, 20);

  if (!consonantAssimilationDrills[ruleId]) {
    consonantAssimilationDrills[ruleId] = {};
  }
  if (!consonantAssimilationDrills[ruleId][score]) {
    consonantAssimilationDrills[ruleId][score] = [];
  }

  words.forEach((word, i) => {
    const input = document.getElementById(`ca-word-${ruleId}-${score}-${i}`);
    if (input) {
      input.value = word;
    }
    consonantAssimilationDrills[ruleId][score][i] = word;
  });

  updateCATabIndicator(ruleId, score);
}

/**
 * Update individual drill word
 */
function updateCADrillWord(ruleId, score, index, value) {
  if (!consonantAssimilationDrills[ruleId]) {
    consonantAssimilationDrills[ruleId] = {};
  }
  if (!consonantAssimilationDrills[ruleId][score]) {
    consonantAssimilationDrills[ruleId][score] = [];
  }

  consonantAssimilationDrills[ruleId][score][index] = value;

  updateCATabIndicator(ruleId, score);
}

/**
 * Update tab indicator to show if a score has drill words
 */
function updateCATabIndicator(ruleId, score) {
  const tab = document.getElementById(`ca-score-tab-${ruleId}-${score}`);
  if (!tab) return;

  const drillWords = consonantAssimilationDrills[ruleId]?.[score] || [];
  const hasDrills = drillWords.filter(w => w).length > 0;

  const countSpan = document.querySelector(`#ca-drill-content-${ruleId} span[style*="font-size: 13px"]`);
  if (countSpan) {
    const count = drillWords.filter(w => w).length;
    countSpan.textContent = `${count}/20 words`;
    countSpan.style.color = count >= 5 ? '#a855f7' : '#f59e0b';
  }

  if (!tab.style.background.includes('124, 58, 237')) { // #7c3aed in rgb
    tab.style.background = hasDrills ? '#f3e8ff' : 'white';
    tab.style.borderColor = hasDrills ? '#a855f7' : '#e9d5ff';
  }
}

let level2GradingData = null;

/**
 * Open Level 2 grading modal
 */
async function openLevel2Grading(submissionId) {
  const data = window.currentGradingData2;
  if (!data) {
    alert('Please complete Level 1 grading first.');
    return;
  }

  const gradedCount = Object.values(data.grades).filter(g => g !== null && g !== undefined).length;
  if (gradedCount === 0) {
    alert('Please grade at least some Level 1 topics before unlocking Level 2.');
    return;
  }

  try {
    const submissionDoc = await db.collection('submissions2').doc(submissionId).get();
    const existingLevel2 = submissionDoc.exists ? submissionDoc.data().level2Grades || {} : {};
    const existingLevel2Drills = submissionDoc.exists ? submissionDoc.data().level2Drills || {} : {};

    level2GradingData = {
      submissionId: submissionId,
      studentId: data.submission.studentId,
      studentEmail: data.submission.studentEmail,
      testTitle: data.test.title,
      grades: existingLevel2,
      drills: existingLevel2Drills,
      currentPage: 1,
      itemsPerPage: 5,
      totalPages: Math.ceil(CONSONANT_ASSIMILATION_RULES.length / 5)
    };

    displayLevel2GradingPage(1);
  } catch (error) {
    alert('Error loading Level 2 data: ' + error.message);
  }
}

/**
 * Display Level 2 grading page
 */
function displayLevel2GradingPage(pageNum) {
  if (!level2GradingData) return;

  level2GradingData.currentPage = pageNum;

  const modal = document.getElementById('gradingModal');
  const content = document.getElementById('gradingContent');

  const startIdx = (pageNum - 1) * level2GradingData.itemsPerPage;
  const endIdx = Math.min(startIdx + level2GradingData.itemsPerPage, CONSONANT_ASSIMILATION_RULES.length);
  const pageRules = CONSONANT_ASSIMILATION_RULES.slice(startIdx, endIdx);

  const gradedCount = Object.values(level2GradingData.grades).filter(g => g !== null && g !== undefined).length;

  let html = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div>
        <h3 style="margin: 0;">${level2GradingData.testTitle}</h3>
        <span style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; display: inline-block; margin-top: 8px;">
           Level 2: Consonant Assimilation
        </span>
      </div>
      <button onclick="backToLevel1Grading()" class="btn" style="background: #f7fafc; color: #4a5568; padding: 8px 16px;">
         Back to Level 1
      </button>
    </div>

    <!-- Navigation Buttons - TOP -->
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #9f7aea20 0%, #667eea20 100%); border-radius: 12px;">
      <button onclick="displayLevel2GradingPage(${pageNum - 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === 1 ? 'disabled' : ''}>
         Previous
      </button>
      <span style="padding: 10px 20px; font-weight: 600; color: #6b46c1; display: flex; align-items: center;">
        Page ${pageNum} / ${level2GradingData.totalPages}
      </span>
      <button onclick="displayLevel2GradingPage(${pageNum + 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === level2GradingData.totalPages ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === level2GradingData.totalPages ? 'disabled' : ''}>
        Next 
      </button>
    </div>

    <!-- Quick Actions -->
    <div style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
      <div style="color: white;">
        <strong> Level 2 Grading</strong>
        <span style="opacity: 0.9; margin-left: 10px;">Graded: ${gradedCount}/22 rules</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="rateAllLevel2OnPage(4)" class="btn" style="background: white; color: #6b46c1; padding: 8px 16px; font-weight: 600;">
           Rate Page as 4 (Mastered)
        </button>
        <button onclick="rateAllLevel2(4)" class="btn" style="background: #faf5ff; color: #6b46c1; padding: 8px 16px; font-weight: 600; border: 2px solid white;">
           Rate ALL as 4
        </button>
      </div>
    </div>

    <!-- Student Info -->
    <div style="background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
      <p><strong>Student:</strong> ${level2GradingData.studentEmail}</p>
      <p><strong>Grading Scale:</strong> 1 (needs most practice)  4 (mastered)</p>
      <p style="font-size: 12px; color: #805ad5; margin-top: 10px;">
         Score 1-3: Student receives drill practice. Score 4: Mastered (no drills needed)
      </p>
    </div>

    <!-- Rules to Grade -->
    <div style="margin-top: 20px;">
  `;

  pageRules.forEach((rule, idx) => {
    const globalIdx = startIdx + idx;
    const existingGrade = level2GradingData.grades[rule.id];
    const isUngraded = existingGrade === null || existingGrade === undefined;

    html += `
      <div style="margin: 20px 0; padding: 20px; background: ${isUngraded ? '#faf5ff' : 'white'}; border-radius: 12px; border: 2px solid ${isUngraded ? '#d6bcfa' : '#e2e8f0'};">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <div>
            <div style="font-size: 18px; font-weight: bold; color: #2d3748; margin-bottom: 5px;">
              <span style="color: #9f7aea;">#${rule.id}</span> ${rule.rule}
            </div>
            <div style="font-size: 14px; color: #718096;">
              <strong>Example:</strong> ${rule.example}  <em>${rule.description}</em>
            </div>
          </div>
          ${isUngraded ? '<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 10px; font-size: 12px;">Not graded</span>' : ''}
        </div>

        <!-- Grade Selector (1-4) -->
        <div style="margin-bottom: 15px;">
          <label style="font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block;">Grade (1-4):</label>
          <div class="grade-selector" style="display: flex; gap: 8px;">
            ${[1,2,3,4].map(grade => `
              <button class="grade-btn ${existingGrade == grade ? 'selected' : ''}"
                      onclick="selectLevel2Grade(${rule.id}, ${grade}, this)"
                      style="width: 60px; height: 50px; font-size: 18px; border-radius: 10px; border: 2px solid ${grade === 4 ? '#48bb78' : '#9f7aea'}; background: ${existingGrade == grade ? (grade === 4 ? '#48bb78' : '#9f7aea') : 'white'}; color: ${existingGrade == grade ? 'white' : '#2d3748'}; cursor: pointer; transition: all 0.2s;">
                ${grade}${grade === 4 ? ' ' : ''}
              </button>
            `).join('')}
          </div>
          <div style="font-size: 12px; color: #718096; margin-top: 5px;">
            ${existingGrade ? `Repetitions: ${LEVEL2_DRILL_REPS[existingGrade] || 0} per day for 7 days` : 'Select a grade'}
            ${existingGrade === 4 ? ' (Mastered!)' : ''}
          </div>
        </div>
      </div>
    `;
  });

  html += `
    </div>

    <!-- Bottom Navigation -->
    <div style="display: flex; justify-content: center; gap: 15px; margin: 20px 0; padding: 20px 0; border-top: 1px solid #e2e8f0;">
      <button onclick="displayLevel2GradingPage(${pageNum - 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === 1 ? 'disabled' : ''}>
         Previous Page
      </button>
      <span style="padding: 10px 20px; font-weight: 600; color: #6b46c1;">
        ${pageNum} / ${level2GradingData.totalPages}
      </span>
      <button onclick="displayLevel2GradingPage(${pageNum + 1})"
              class="btn"
              style="padding: 10px 20px; ${pageNum === level2GradingData.totalPages ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
              ${pageNum === level2GradingData.totalPages ? 'disabled' : ''}>
        Next Page 
      </button>
    </div>
  `;

  if (pageNum === level2GradingData.totalPages) {
    const lowestLevel2Grades = [];
    CONSONANT_ASSIMILATION_RULES.forEach(rule => {
      const grade = level2GradingData.grades[rule.id];
      if (grade !== null && grade !== undefined && grade < 4) {
        lowestLevel2Grades.push({
          id: rule.id,
          rule: rule.rule,
          example: rule.example,
          grade: grade
        });
      }
    });
    lowestLevel2Grades.sort((a, b) => a.grade - b.grade);
    const topLowest = lowestLevel2Grades.slice(0, 8);

    if (topLowest.length > 0) {
      html += `
        <!-- Lowest Level 2 Grades Summary -->
        <div style="margin-top: 30px; background: #faf5ff; padding: 20px; border-radius: 12px; border: 2px solid #d6bcfa;">
          <h4 style="color: #6b46c1; margin-bottom: 15px;">
             Student's ${topLowest.length} Lowest Scores - Reference for Video Feedback
          </h4>
          <p style="color: #553c9a; font-size: 14px; margin-bottom: 15px;">
            These rules need the most attention. Consider mentioning them in your video feedback:
          </p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            ${topLowest.map(item => `
              <div style="background: white; padding: 10px; border-radius: 8px; border-left: 4px solid ${item.grade <= 2 ? '#f56565' : '#ed8936'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <span style="font-size: 14px; font-weight: bold; color: #2d3748;">
                    #${item.id}
                  </span>
                  <span style="font-size: 16px; font-weight: bold; color: ${item.grade <= 2 ? '#f56565' : '#ed8936'};">
                    ${item.grade}/5
                  </span>
                </div>
                <div style="font-size: 12px; color: #6b46c1;">${item.rule}</div>
                <div style="font-size: 11px; color: #718096; margin-top: 3px;">Ex: ${item.example}</div>
              </div>
            `).join('')}
          </div>
          <div style="margin-top: 15px; padding: 10px; background: #e9d8fd; border-radius: 6px;">
            <p style="color: #553c9a; font-size: 13px; margin: 0;">
              <strong> Video Tips:</strong> Demonstrate the sound changes clearly.
              Show how the consonants transform when they meet at syllable boundaries.
            </p>
          </div>
        </div>
      `;
    }

    const rulesWithVideos = lowestLevel2Grades.filter(item => LEVEL2_INSTRUCTIONAL_VIDEOS[item.id]);
    if (rulesWithVideos.length > 0) {
      html += `
        <!-- Pre-loaded Instructional Videos -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; border: 2px solid #38b2ac;">
          <h4 style="color: #276749; margin-bottom: 10px;">
             Pre-loaded Instructional Videos (${rulesWithVideos.length})
          </h4>
          <p style="color: #285e61; font-size: 14px; margin-bottom: 15px;">
            These instructional videos will be <strong>automatically sent</strong> to the student for rules scoring under 5:
          </p>
          <div style="display: grid; gap: 12px;">
            ${rulesWithVideos.map(item => {
              const videoUrl = LEVEL2_INSTRUCTIONAL_VIDEOS[item.id];
              const embedUrl = videoUrl.replace('/share/', '/embed/');
              return `
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${item.grade <= 2 ? '#f56565' : '#ed8936'}; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <span style="font-weight: bold; color: #2d3748; font-size: 15px;">Rule #${item.id}</span>
                      <span style="color: ${item.grade <= 2 ? '#f56565' : '#ed8936'}; font-weight: bold; margin-left: 10px;">${item.grade}/5</span>
                    </div>
                    <span style="background: #48bb78; color: white; font-size: 11px; padding: 3px 8px; border-radius: 10px;"> Video Ready</span>
                  </div>
                  <div style="font-size: 13px; color: #6b46c1; margin-bottom: 8px;">${item.rule}</div>
                  <div style="font-size: 12px; color: #718096; margin-bottom: 10px;">Ex: ${item.example}</div>
                  <details style="cursor: pointer;">
                    <summary style="color: #3182ce; font-size: 13px; font-weight: 600;"> Preview Video</summary>
                    <div style="margin-top: 10px; border-radius: 8px; overflow: hidden;">
                      <iframe src="${embedUrl}" width="100%" height="200" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
                    </div>
                  </details>
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 15px; padding: 12px; background: #c6f6d5; border-radius: 8px;">
            <p style="color: #276749; font-size: 13px; margin: 0;">
              <strong> Auto-Send:</strong> These videos will be attached to the student's feedback when you save.
              No need to record your own videos for these rules unless you want to add personalized feedback.
            </p>
          </div>
        </div>
      `;
    }

    const rulesWithoutVideos = lowestLevel2Grades.filter(item => !LEVEL2_INSTRUCTIONAL_VIDEOS[item.id]);
    if (rulesWithoutVideos.length > 0) {
      html += `
        <!-- Rules Without Pre-loaded Videos -->
        <div style="margin-top: 20px; background: #fffaf0; padding: 15px; border-radius: 10px; border: 2px solid #ed8936;">
          <h4 style="color: #c05621; margin-bottom: 10px;">
             Rules Without Pre-loaded Videos (${rulesWithoutVideos.length})
          </h4>
          <p style="color: #9c4221; font-size: 13px; margin-bottom: 10px;">
            Consider recording personalized feedback for these rules:
          </p>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${rulesWithoutVideos.map(item => `
              <span style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; border: 1px solid #ed8936;">
                <strong>#${item.id}</strong> ${item.rule} <span style="color: #ed8936;">(${item.grade}/4)</span>
              </span>
            `).join('')}
          </div>
        </div>
      `;
    }

    html += `
      <!-- Level 2 Video Feedback Section -->
      <div style="margin-top: 30px; background: linear-gradient(135deg, #faf5ff 0%, #f0e6ff 100%); padding: 20px; border-radius: 12px; border: 2px solid #9f7aea;">
        <h4 style="color: #6b46c1; margin-bottom: 15px;"> Record Level 2 Video Feedback</h4>
        <p style="color: #805ad5; margin-bottom: 15px;">Record a personalized video explaining consonant assimilation rules for this student</p>

        <!-- Video Preview/Playback -->
        <div class="video-preview-container" style="max-width: 400px; margin: 0 auto 20px auto; display: none;" id="level2VideoContainer">
          <video id="level2VideoPreview" class="video-preview" style="width: 100%; border-radius: 8px; transform: scaleX(-1);"></video>
          <div class="video-preview-label">REC</div>
        </div>
        <video id="level2RecordedVideo" controls style="width: 100%; max-width: 400px; border-radius: 8px; display: none; margin: 0 auto 20px auto;"></video>

        <!-- Recording Status -->
        <div id="level2VideoStatus" style="text-align: center; margin: 15px 0; font-weight: 600; color: #6b46c1;"></div>

        <!-- Recording Controls -->
        <div style="text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button id="level2StartVideoBtn" onclick="startLevel2VideoRecording()" class="btn" style="background: #9f7aea; color: white;">
             Start Recording
          </button>
          <button id="level2StopVideoBtn" onclick="stopLevel2VideoRecording()" class="btn btn-danger" style="display: none;">
             Stop Recording
          </button>
          <button id="level2RetakeVideoBtn" onclick="retakeLevel2Video()" class="btn btn-warning" style="display: none;">
             Retake Video
          </button>
          <button id="level2RemoveVideoBtn" onclick="removeLevel2Video()" class="btn btn-danger" style="display: none;">
             Remove Video
          </button>
        </div>
      </div>

      <button onclick="saveLevel2Grading()" class="btn btn-secondary" style="margin-top: 20px; font-size: 16px; padding: 12px 24px; width: 100%; background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%);">
        Save Level 2 Grading
      </button>
    `;
  }

  content.innerHTML = html;
  modal.classList.add('active');
}

/**
 * Render drill word inputs for a Level 2 rule
 */
/**
 * Select a grade for a Level 2 rule
 */
function selectLevel2Grade(ruleId, grade, button) {
  level2GradingData.grades[ruleId] = grade;

  const parent = button.parentElement;
  parent.querySelectorAll('.grade-btn').forEach(btn => {
    btn.style.background = 'white';
    btn.style.color = '#2d3748';
  });
  button.style.background = grade === 4 ? '#48bb78' : '#9f7aea';
  button.style.color = 'white';

  const container = parent.parentElement;
  const repText = container.querySelector('div[style*="font-size: 12px"]');
  if (repText) {
    repText.innerHTML = `Repetitions: ${LEVEL2_DRILL_REPS[grade]} per day for 7 days${grade === 4 ? ' (Mastered!)' : ''}`;
  }
}

/**
 * Rate all Level 2 rules on current page
 */
function rateAllLevel2OnPage(grade) {
  const startIdx = (level2GradingData.currentPage - 1) * level2GradingData.itemsPerPage;
  const endIdx = Math.min(startIdx + level2GradingData.itemsPerPage, CONSONANT_ASSIMILATION_RULES.length);
  const pageRules = CONSONANT_ASSIMILATION_RULES.slice(startIdx, endIdx);

  pageRules.forEach(rule => {
    level2GradingData.grades[rule.id] = grade;
  });

  displayLevel2GradingPage(level2GradingData.currentPage);
}

/**
 * Rate all Level 2 rules
 */
function rateAllLevel2(grade) {
  if (!confirm(`Rate all 22 rules as ${grade}${grade === 4 ? ' (Mastered)' : ''}?`)) return;

  CONSONANT_ASSIMILATION_RULES.forEach(rule => {
    level2GradingData.grades[rule.id] = grade;
  });

  displayLevel2GradingPage(level2GradingData.currentPage);
}

/**
 * Go back to Level 1 grading
 */
function backToLevel1Grading() {
  const data = window.currentGradingData2;
  if (data) {
    displayGradingPage2(data.totalPages);
  }
}

/**
 * Save Level 2 grading
 */

let level2MediaRecorder = null;
let level2RecordedChunks = [];
let level2RecordedBlob = null;
let level2VideoStream = null;

/**
 * Start Level 2 video recording
 */
async function startLevel2VideoRecording() {
  try {
    const quality = VIDEO_QUALITY[currentVideoQuality] || VIDEO_QUALITY.medium;

    const preview = document.getElementById('level2VideoPreview');
    const container = document.getElementById('level2VideoContainer');
    const startBtn = document.getElementById('level2StartVideoBtn');
    const stopBtn = document.getElementById('level2StopVideoBtn');
    const statusDiv = document.getElementById('level2VideoStatus');

    level2VideoStream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: quality.width },
        height: { ideal: quality.height },
        frameRate: { ideal: quality.frameRate },
        facingMode: 'user'
      },
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });

    if (container) container.style.display = 'block';
    preview.srcObject = level2VideoStream;
    preview.style.display = 'block';
    preview.muted = true;
    preview.play();

    level2RecordedChunks = [];

    const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')
      ? 'video/webm;codecs=vp9,opus'
      : 'video/webm;codecs=vp8,opus';

    level2MediaRecorder = new MediaRecorder(level2VideoStream, {
      mimeType: mimeType,
      videoBitsPerSecond: quality.videoBitsPerSecond,
      audioBitsPerSecond: 128000
    });

    level2MediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        level2RecordedChunks.push(event.data);
      }
    };

    level2MediaRecorder.onstop = () => {
      level2RecordedBlob = new Blob(level2RecordedChunks, { type: 'video/webm' });
      showLevel2RecordedVideo();
    };

    level2MediaRecorder.start(1000);

    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    statusDiv.textContent = ' Recording...';
    statusDiv.style.color = '#f56565';

  } catch (error) {
    alert('Error accessing camera: ' + error.message);
  }
}

/**
 * Stop Level 2 video recording
 */
function stopLevel2VideoRecording() {
  if (level2MediaRecorder && level2MediaRecorder.state === 'recording') {
    level2MediaRecorder.stop();

    if (level2VideoStream) {
      level2VideoStream.getTracks().forEach(track => track.stop());
    }

    const container = document.getElementById('level2VideoContainer');
    const preview = document.getElementById('level2VideoPreview');
    if (container) container.style.display = 'none';
    preview.style.display = 'none';
    preview.srcObject = null;

    const statusDiv = document.getElementById('level2VideoStatus');
    statusDiv.textContent = ' Recording saved';
    statusDiv.style.color = '#48bb78';

    document.getElementById('level2StopVideoBtn').style.display = 'none';
  }
}

/**
 * Show recorded Level 2 video
 */
function showLevel2RecordedVideo() {
  const recordedVideo = document.getElementById('level2RecordedVideo');
  const retakeBtn = document.getElementById('level2RetakeVideoBtn');
  const removeBtn = document.getElementById('level2RemoveVideoBtn');

  if (level2RecordedBlob) {
    recordedVideo.src = URL.createObjectURL(level2RecordedBlob);
    recordedVideo.style.display = 'block';
    retakeBtn.style.display = 'inline-block';
    removeBtn.style.display = 'inline-block';
  }
}

/**
 * Retake Level 2 video
 */
function retakeLevel2Video() {
  level2RecordedBlob = null;
  level2RecordedChunks = [];

  const recordedVideo = document.getElementById('level2RecordedVideo');
  recordedVideo.style.display = 'none';
  recordedVideo.src = '';

  document.getElementById('level2RetakeVideoBtn').style.display = 'none';
  document.getElementById('level2RemoveVideoBtn').style.display = 'none';
  document.getElementById('level2StartVideoBtn').style.display = 'inline-block';

  const statusDiv = document.getElementById('level2VideoStatus');
  statusDiv.textContent = '';

  startLevel2VideoRecording();
}

/**
 * Remove Level 2 video
 */
function removeLevel2Video() {
  level2RecordedBlob = null;
  level2RecordedChunks = [];

  const recordedVideo = document.getElementById('level2RecordedVideo');
  recordedVideo.style.display = 'none';
  recordedVideo.src = '';

  document.getElementById('level2RetakeVideoBtn').style.display = 'none';
  document.getElementById('level2RemoveVideoBtn').style.display = 'none';
  document.getElementById('level2StartVideoBtn').style.display = 'inline-block';

  const statusDiv = document.getElementById('level2VideoStatus');
  statusDiv.textContent = 'Video removed';
  statusDiv.style.color = '#718096';
}

/**
 * Upload Level 2 video to Firebase Storage
 */
async function uploadLevel2Video(studentId, submissionId) {
  if (!level2RecordedBlob) return null;

  try {
    const filename = `level2-feedback-${submissionId}-${Date.now()}.webm`;
    const storageRef = firebase.storage().ref(`feedback-videos/${studentId}/${filename}`);

    const snapshot = await storageRef.put(level2RecordedBlob);
    const downloadUrl = await snapshot.ref.getDownloadURL();

    return downloadUrl;
  } catch (error) {
    return null;
  }
}

async function saveLevel2Grading() {
  if (!level2GradingData) return;

  try {
    let level2VideoUrl = null;
    if (level2RecordedBlob) {
      const statusDiv = document.getElementById('level2VideoStatus');
      if (statusDiv) {
        statusDiv.textContent = ' Uploading video...';
        statusDiv.style.color = '#667eea';
      }

      level2VideoUrl = await uploadLevel2Video(
        level2GradingData.studentId,
        level2GradingData.submissionId
      );
    }

    const instructionalVideos = {};
    Object.entries(level2GradingData.grades).forEach(([ruleId, grade]) => {
      const id = parseInt(ruleId);
      if (grade !== null && grade !== undefined && grade < 4) {
        const videoUrl = LEVEL2_INSTRUCTIONAL_VIDEOS[id];
        if (videoUrl) {
          const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id === id);
          instructionalVideos[id] = {
            videoUrl: videoUrl,
            rule: rule ? rule.rule : '',
            example: rule ? rule.example : '',
            description: rule ? rule.description : '',
            grade: grade
          };
        }
      }
    });

    const updateData = {
      level2Unlocked: true,
      level2Grades: level2GradingData.grades,
      level2Drills: level2GradingData.drills,
      level2GradedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (level2VideoUrl) {
      updateData.level2VideoFeedbackUrl = level2VideoUrl;
    }

    if (Object.keys(instructionalVideos).length > 0) {
      updateData.level2InstructionalVideos = instructionalVideos;
    }

    await db.collection('submissions2').doc(level2GradingData.submissionId).update(updateData);

    await db.collection('users').doc(level2GradingData.studentId).update({
      level2Unlocked: true,
      level2UnlockedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await sendLevel2DrillsToStudent(
      level2GradingData.studentId,
      level2GradingData.grades,
      level2GradingData.drills,
      level2GradingData.submissionId,
      level2GradingData.testTitle
    );

    const videoCount = Object.keys(instructionalVideos).length;
    let alertMsg = 'Level 2 grading saved successfully!';
    if (level2VideoUrl) alertMsg += ' Video feedback uploaded.';
    if (videoCount > 0) alertMsg += ` ${videoCount} instructional video(s) attached.`;
    alert(alertMsg);

    level2RecordedBlob = null;
    level2RecordedChunks = [];

    backToLevel1Grading();

  } catch (error) {
    alert('Error saving: ' + error.message);
  }
}

/**
 * Send Level 2 drills to student
 */
async function sendLevel2DrillsToStudent(studentId, grades, drills, submissionId, testTitle) {
  for (const [ruleIdStr, grade] of Object.entries(grades)) {
    const ruleId = parseInt(ruleIdStr);
    if (grade === 4) continue; // Mastered, no drills

    const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id === ruleId);
    if (!rule) continue;

    const drillWords = drills[ruleId] && drills[ruleId][grade] ? drills[ruleId][grade] : [];
    if (drillWords.length === 0) continue;

    const requiredReps = LEVEL2_DRILL_REPS[grade];

    try {
      const existing = await db.collection('pronunciationLeitner')
        .where('studentId', '==', studentId)
        .where('topic', '==', `L2-${ruleId}`)
        .where('submissionId', '==', submissionId)
        .get();

      if (!existing.empty) {
        await db.collection('pronunciationLeitner').doc(existing.docs[0].id).update({
          grade: grade,
          requiredRepetitions: requiredReps,
          completedRepetitionsToday: 0,
          drillWords: drillWords,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection('pronunciationLeitner').add({
          studentId: studentId,
          topic: `L2-${ruleId}`,
          topicLabel: rule.rule,
          topicDescription: rule.description,
          level: 2,
          grade: grade,
          requiredRepetitions: requiredReps,
          completedRepetitionsToday: 0,
          drillWords: drillWords,
          testTitle: testTitle,
          submissionId: submissionId,
          currentDay: 1,
          totalDays: 7,
          completedToday: false,
          lastCompletedDate: null,
          isComplete: false,
          correctCount: 0,
          totalReviews: 0,
          startedAt: firebase.firestore.FieldValue.serverTimestamp(),
          addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    } catch (error) {
    }
  }
}

async function saveGrading2(submissionId) {
  try {
    const test = window.currentGradingData2.test;
    const expectedTopics = test.materials.reduce((count, material) =>
      count + material.topics.length, 0);

    const gradedTopics = Object.entries(window.currentGradingData2.grades)
      .filter(([key, grade]) => grade !== null && grade !== undefined);

    if (gradedTopics.length < expectedTopics) {
      const ungradedCount = expectedTopics - gradedTopics.length;
      if (!confirm(`Warning: Only ${gradedTopics.length}/${expectedTopics} topics have been graded.\n\n${ungradedCount} topic(s) will be marked as ungraded (0).\n\nDo you want to continue?`)) {
        return;
      }

      Object.entries(window.currentGradingData2.grades).forEach(([key, grade]) => {
        if (grade === null || grade === undefined) {
          window.currentGradingData2.grades[key] = 0;
        }
      });
    }

    const feedbackNeeded = {};
    let feedbackVideoUrl = null;

    if (gradingVideoBlob) {
      const statusEl = document.getElementById('gradingVideoStatus');
      statusEl.innerHTML = `
        <div style="text-align: center;">
          <p style="margin-bottom: 10px; color: #667eea;"> Uploading video...</p>
          <div style="background: #e2e8f0; border-radius: 10px; height: 20px; width: 100%; max-width: 300px; margin: 0 auto; overflow: hidden;">
            <div id="uploadProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s; border-radius: 10px;"></div>
          </div>
          <p id="uploadProgressText" style="margin-top: 8px; font-size: 14px; color: #718096;">0%</p>
        </div>
      `;

      const timestamp = Date.now();
      const fileExt = gradingVideoBlob.type === 'video/mp4' ? 'mp4' :
                      gradingVideoBlob.type === 'video/quicktime' ? 'mov' : 'webm';
      const videoFileName = `feedback-videos2/${currentUser.uid}/${submissionId}_${timestamp}.${fileExt}`;
      const storageRef = firebase.storage().ref();
      const videoRef = storageRef.child(videoFileName);

      const uploadTask = videoRef.put(gradingVideoBlob);

      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = Math.round(progress) + '%';
          },
          (error) => {
            statusEl.innerHTML = `<p style="color: #f56565;"> Upload failed: ${error.message}</p>`;
            reject(error);
          },
          async () => {
            feedbackVideoUrl = await uploadTask.snapshot.ref.getDownloadURL();
            statusEl.innerHTML = `<p style="color: #48bb78;"> Video uploaded successfully!</p>`;
            resolve();
          }
        );
      });
    }

    Object.entries(window.currentGradingData2.grades).forEach(([key, grade]) => {
      if (grade < 10) {
        const [materialIndex, topic] = key.split('_');
        const material = test.materials[parseInt(materialIndex)];
        if (material && material.feedbacks && material.feedbacks[topic]) {
          feedbackNeeded[key] = material.feedbacks[topic];
        }
      }
    });

    const gradeValues = Object.values(window.currentGradingData2.grades)
      .filter(g => g !== null && g !== undefined);
    const overallScore = gradeValues.length > 0
      ? Math.round((gradeValues.reduce((sum, g) => sum + g, 0) / gradeValues.length) * 10)
      : 0;

    const level2Unlocked = window.currentGradingData2.level2Unlocked || false;

    const updateData = {
      status: 'graded',
      grades: window.currentGradingData2.grades,
      feedbackNeeded: feedbackNeeded,
      overallScore: overallScore,
      level2Unlocked: level2Unlocked,
      gradedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (feedbackVideoUrl) {
      updateData.videoFeedbackUrl = feedbackVideoUrl;
    }

    await db.collection('submissions2').doc(submissionId).update(updateData);

    if (level2Unlocked) {
      const studentId = window.currentGradingData2.submission.studentId;
      await db.collection('users').doc(studentId).update({
        level2Unlocked: true,
        level2UnlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
        level2UnlockedBy: currentUser.uid
      });
    }

    const studentId = window.currentGradingData2.submission.studentId;
    await sendPronunciationDrillsToStudent(studentId, test, window.currentGradingData2.grades, submissionId);

    alert('Grading and feedback saved successfully!');

    gradingVideoBlob = null;

    closeGradingModal();
    loadSubmissions2();
  } catch (error) {
    alert('Error saving grading: ' + error.message);
  }
}

/**
 * Send pronunciation drills to student based on their grades
 */
async function sendPronunciationDrillsToStudent(studentId, test, grades, submissionId) {
  const PRON_DRILL_REPETITIONS = {
    1: 7,  // 7 times
    2: 6,  // 6 times
    3: 5,  // 5 times
    4: 5,  // 5 times
    5: 4,  // 4 times
    6: 4,  // 4 times
    7: 3,  // 3 times
    8: 3,  // 3 times
    9: 2   // 2 times
  };

  let adminLevel1Config = null;
  try {
    const adminDoc = await db.collection('adminSettings').doc('level1Config').get();
    if (adminDoc.exists) {
      adminLevel1Config = adminDoc.data();
    }
  } catch (error) {
  }

  for (const [gradeKey, grade] of Object.entries(grades)) {
    if (grade === null || grade === undefined) continue;

    if (grade === 10) {
      continue;
    }

    const [materialIndex, topic] = gradeKey.split('_');
    const material = test.materials[parseInt(materialIndex)];

    if (!material || !material.feedbacks || !material.feedbacks[topic]) continue;

    const feedback = material.feedbacks[topic];

    let pronunciationDrills = [];
    let drillSource = 'test data';

    if (adminLevel1Config) {
      if (adminLevel1Config.consonants && adminLevel1Config.consonants[topic]) {
        const consonantConfig = adminLevel1Config.consonants[topic];
        if (consonantConfig.drills && consonantConfig.drills[grade]) {
          pronunciationDrills = consonantConfig.drills[grade];
          drillSource = 'admin config (consonant)';
        }
      } else if (adminLevel1Config.vowels && adminLevel1Config.vowels[topic]) {
        const vowelConfig = adminLevel1Config.vowels[topic];
        if (vowelConfig.drills && vowelConfig.drills[grade]) {
          pronunciationDrills = vowelConfig.drills[grade];
          drillSource = 'admin config (vowel)';
        }
      }
    }

    if (pronunciationDrills.length === 0) {
      const pronunciationDrillsObj = feedback.pronunciationDrills || {};
      pronunciationDrills = pronunciationDrillsObj[grade] || [];
      drillSource = 'test data';
    }

    if (pronunciationDrills.length === 0) continue;

    const requiredReps = PRON_DRILL_REPETITIONS[grade] || 1;

    let videoUrl = feedback.content || '';
    if (adminLevel1Config) {
      if (adminLevel1Config.consonants && adminLevel1Config.consonants[topic] && adminLevel1Config.consonants[topic].video) {
        videoUrl = adminLevel1Config.consonants[topic].video;
      } else if (adminLevel1Config.vowels && adminLevel1Config.vowels[topic] && adminLevel1Config.vowels[topic].video) {
        videoUrl = adminLevel1Config.vowels[topic].video;
      }
    }

    try {
      const existingQuery = await db.collection('pronunciationLeitner')
        .where('studentId', '==', studentId)
        .where('topic', '==', topic)
        .where('submissionId', '==', submissionId)
        .get();

      if (!existingQuery.empty) {
        const docId = existingQuery.docs[0].id;
        await db.collection('pronunciationLeitner').doc(docId).update({
          grade: grade,
          requiredRepetitions: requiredReps,
          completedRepetitionsToday: 0,
          drillWords: pronunciationDrills,
          feedbackContent: videoUrl,
          feedbackType: feedback.type || 'text',
          currentDay: 1,
          totalDays: 7,
          completedToday: false,
          isComplete: false,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection('pronunciationLeitner').add({
          studentId: studentId,
          topic: topic,
          grade: grade,
          requiredRepetitions: requiredReps,
          completedRepetitionsToday: 0,
          drillWords: pronunciationDrills,
          feedbackContent: videoUrl,
          feedbackType: feedback.type || 'text',
          testTitle: test.title,
          materialTitle: material.title,
          submissionId: submissionId,
          currentDay: 1,
          totalDays: 7,
          completedToday: false,
          lastCompletedDate: null,
          isComplete: false,
          correctCount: 0,
          totalReviews: 0,
          startedAt: firebase.firestore.FieldValue.serverTimestamp(),
          addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      console.log(`Sent "${topic}" drill to student (Grade: ${grade}, Reps: ${requiredReps}, Words: ${pronunciationDrills.length}, Source: ${drillSource})`);

    } catch (error) {
    }
  }
}

async function loadMySubmissions2() {
  const submissionsList = document.getElementById('studentSubmissionsList2');
  submissionsList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('submissions2')
      .where('studentId', '==', currentUser.uid)
      .get();

    submissionsList.innerHTML = '';

    if (snapshot.empty) {
      submissionsList.innerHTML = '<p>No submissions2 yet.</p>';
      return;
    }

    const submissions = [];
    for (const doc of snapshot.docs) {
      const submission = doc.data();

      const testDoc = await db.collection('tests2').doc(submission.testId).get();
      if (!testDoc.exists) continue;

      submissions.push({
        data: submission,
        test: testDoc.data()
      });
    }

    submissions.sort((a, b) => {
      const aTime = a.data.submittedAt ? a.data.submittedAt.toDate() : new Date(0);
      const bTime = b.data.submittedAt ? b.data.submittedAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    submissions.forEach(item => {
      const submission = item.data;
      const test = item.test;

      const submissionCard = document.createElement('div');
      submissionCard.className = 'test-card';

      let statusHtml = '';
      if (submission.status === 'pending') {
        statusHtml = '<span class="status-badge" style="background: #ed8936;">Pending Review</span>';
      } else if (submission.status === 'graded') {
        statusHtml = '<span class="status-badge" style="background: #48bb78;">Graded</span>';
      }

      let gradesHtml = '';
      if (submission.grades) {
        const avgGrade = Object.values(submission.grades).reduce((a, b) => a + b, 0) / Object.values(submission.grades).length;
        gradesHtml = `
          <div style="margin: 10px 0;">
            <strong>Average Grade:</strong> <span style="font-size: 20px; font-weight: bold; color: ${avgGrade >= 7 ? '#48bb78' : avgGrade >= 5 ? '#ed8936' : '#f56565'};">${avgGrade.toFixed(1)}/10</span>
          </div>
        `;
      }

      submissionCard.innerHTML = `
        <div class="test-header">
          <div class="test-title">${test.title}</div>
          ${statusHtml}
        </div>
        <div style="margin: 10px 0; color: #718096;">
          Submitted: ${submission.submittedAt ? submission.submittedAt.toDate().toLocaleString() : 'Recently'}
        </div>
        ${gradesHtml}
      `;

      submissionsList.appendChild(submissionCard);
    });
  } catch (error) {
    submissionsList.innerHTML = '<p>Error loading submissions2: ' + error.message + '</p>';
  }
}

async function loadMyFeedback2() {
  const feedbackList = document.getElementById('studentFeedbackList2');
  feedbackList.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('submissions2')
      .where('studentId', '==', currentUser.uid)
      .where('status', '==', 'graded')
      .get();

    feedbackList.innerHTML = '';

    if (snapshot.empty) {
      feedbackList.innerHTML = '<p>No feedback2 available yet.</p>';
      return;
    }

    const allSubmissions = [];
    for (const doc of snapshot.docs) {
      const submission = doc.data();

      const testDoc = await db.collection('tests2').doc(submission.testId).get();
      if (!testDoc.exists) continue;

      allSubmissions.push({
        data: submission,
        test: testDoc.data(),
        testId: submission.testId
      });
    }

    const testGroups = {};
    allSubmissions.forEach(item => {
      const testId = item.testId;
      const testTitle = item.test.title;

      if (!testGroups[testId]) {
        testGroups[testId] = {
          title: testTitle,
          feedback: []
        };
      }
      testGroups[testId].feedback.push(item);
    });

    Object.values(testGroups).forEach(group => {
      group.feedback.sort((a, b) => {
        const aTime = a.data.gradedAt ? a.data.gradedAt.toDate() : new Date(0);
        const bTime = b.data.gradedAt ? b.data.gradedAt.toDate() : new Date(0);
        return bTime - aTime;
      });
    });

    Object.entries(testGroups).forEach(([testId, group]) => {
      const feedbackFolder = document.createElement('div');
      feedbackFolder.className = 'feedback-folder';

      const scores = group.feedback.map(f => f.data.overallScore || 0);
      const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

      feedbackFolder.innerHTML = `
        <div class="feedback-folder-header" onclick="toggleFeedbackFolder('${testId}')">
          <div class="feedback-test-name">
            <span style="font-size: 20px; margin-right: 10px;"></span>
            <span>${group.title}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px;">
            <span style="background: #e8f5e9; color: #2e7d32; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              ${group.feedback.length} ${group.feedback.length === 1 ? 'submission' : 'submissions'}
            </span>
            <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              Avg: ${avgScore.toFixed(1)}%
            </span>
            <span style="color: #667eea; font-size: 18px;"></span>
          </div>
        </div>
        <div id="feedback-items-${testId}" class="feedback-items">
          ${group.feedback.map((item, index) => {
            const submission = item.data;
            const test = item.test;

            let feedbackHtml = '';
            if (submission.grades) {
              feedbackHtml = '<div style="margin-top: 15px;"><h4 style="color: #2d3748; font-size: 16px; margin-bottom: 10px;"> Grades by Topic (Lowest First - Focus on These!):</h4><p style="color: #718096; font-size: 13px; margin-bottom: 10px; font-style: italic;"> Topics are sorted from lowest to highest score to help you focus on areas needing the most improvement.</p>';

              const sortedGrades = Object.entries(submission.grades).sort((a, b) => a[1] - b[1]);

              sortedGrades.forEach(([key, grade]) => {
                let topicName = key;
                const match = key.match(/^(\d+)_(.+)$/);
                if (match) {
                  topicName = match[2]; // Extract just the topic name
                }

                const feedback = submission.feedbackNeeded && submission.feedbackNeeded[key] ? submission.feedbackNeeded[key] : null;

                let feedbackDisplay = '';
                if (feedback && feedback.content) {
                  if (feedback.type === 'text') {
                    feedbackDisplay = `<p style="color: #718096; font-size: 14px; margin-top: 8px;">${feedback.content}</p>`;
                  } else if (feedback.type === 'video') {
                    let videoUrl = feedback.content;
                    let embedUrl = '';
                    let isEmbeddable = false;

                    if (videoUrl.includes('youtube.com/watch')) {
                      embedUrl = videoUrl.replace('watch?v=', 'embed/');
                      isEmbeddable = true;
                    } else if (videoUrl.includes('youtu.be/')) {
                      const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                      embedUrl = `https://www.youtube.com/embed/${videoId}`;
                      isEmbeddable = true;
                    } else if (videoUrl.includes('loom.com/share/')) {
                      const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
                      embedUrl = `https://www.loom.com/embed/${videoId}`;
                      isEmbeddable = true;
                    } else if (videoUrl.includes('vimeo.com/')) {
                      const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
                      embedUrl = `https://player.vimeo.com/video/${videoId}`;
                      isEmbeddable = true;
                    } else if (videoUrl.includes('drive.google.com')) {
                      if (videoUrl.includes('/file/d/')) {
                        const videoId = videoUrl.split('/file/d/')[1].split('/')[0];
                        embedUrl = `https://drive.google.com/file/d/${videoId}/preview`;
                        isEmbeddable = true;
                      }
                    }

                    if (isEmbeddable) {
                      const uniqueId = `video-${testId}-${index}-${key.replace(/[^a-zA-Z0-9]/g, '')}`;
                      feedbackDisplay = `
                        <div style="margin-top: 8px;">
                          <button id="btn-${uniqueId}" onclick="loadVideo('${uniqueId}', '${embedUrl.replace(/'/g, "\\'")}')" style="color: #667eea; background: #eef2ff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; transition: all 0.3s;">
                            <span style="margin-right: 5px;"></span>
                            <span style="font-weight: 600;">Watch Video</span>
                            <span style="margin-left: 5px;"></span>
                          </button>
                          <div id="${uniqueId}" style="display: none; margin-top: 10px;">
                            <!-- Video will be loaded here when button is clicked -->
                          </div>
                        </div>
                      `;
                    } else {
                      feedbackDisplay = `
                        <div style="margin-top: 8px;">
                          <a href="${videoUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; padding: 8px 12px; background: #eef2ff; border-radius: 6px; transition: all 0.3s;">
                            <span style="margin-right: 5px;"></span>
                            <span style="font-weight: 600;">Watch Video</span>
                            <span style="margin-left: 5px;"></span>
                          </a>
                        </div>
                      `;
                    }
                  } else if (feedback.type === 'html') {
                    feedbackDisplay = `<div style="margin-top: 8px;">${feedback.content}</div>`;
                  }
                } else if (feedback && typeof feedback === 'string') {
                  feedbackDisplay = `<p style="color: #718096; font-size: 14px; margin-top: 8px;">${feedback}</p>`;
                }

                feedbackHtml += `
                  <div style="margin: 10px 0; padding: 12px; background: ${grade < 5 ? '#fff5f5' : 'white'}; border-radius: 6px; border-left: 6px solid ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; ${grade < 5 ? 'box-shadow: 0 2px 8px rgba(245, 101, 101, 0.2);' : ''}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                      <strong style="color: #2d3748; font-size: 16px;">
                        ${grade < 5 ? ' ' : ''}${topicName}
                        ${grade < 5 ? '<span style="color: #f56565; font-size: 12px; margin-left: 8px;">(Priority!)</span>' : ''}
                      </strong>
                      <span style="font-size: 18px; font-weight: 700; color: ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; ${grade < 5 ? 'background: #fee; padding: 4px 8px; border-radius: 4px;' : ''}">
                        ${grade}/10
                      </span>
                    </div>
                    ${feedbackDisplay}
                    ${grade < 10 && !feedbackDisplay ? '<p style="color: #cbd5e0; font-size: 13px; font-style: italic;">Practice materials available upon perfect score</p>' : ''}
                  </div>
                `;
              });

              feedbackHtml += '</div>';
            }

            let videoHtml = '';
            if (submission.videoFeedbackUrl) {
              videoHtml = `
                <div style="margin-top: 15px;">
                  <h4 style="color: #2d3748; font-size: 16px; margin-bottom: 10px;"> Level 1 Video Feedback:</h4>
                  <video controls style="width: 100%; max-width: 600px; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <source src="${submission.videoFeedbackUrl}" type="video/webm">
                  </video>
                </div>
              `;
            }

            let level2VideoHtml = '';
            if (submission.level2VideoFeedbackUrl) {
              level2VideoHtml = `
                <div style="margin-top: 15px;">
                  <h4 style="color: #6b46c1; font-size: 16px; margin-bottom: 10px;"> Level 2 Video Feedback (Consonant Assimilation):</h4>
                  <video controls style="width: 100%; max-width: 600px; border-radius: 8px; border: 2px solid #9f7aea;">
                    <source src="${submission.level2VideoFeedbackUrl}" type="video/webm">
                  </video>
                </div>
              `;
            }

            let level2GradesHtml = '';
            if (submission.level2Grades && Object.keys(submission.level2Grades).length > 0) {
              const sortedLevel2 = Object.entries(submission.level2Grades)
                .map(([ruleId, grade]) => ({ ruleId: parseInt(ruleId), grade }))
                .sort((a, b) => a.grade - b.grade);

              level2GradesHtml = `
                <div style="margin-top: 15px; background: linear-gradient(135deg, #faf5ff 0%, #f0e6ff 100%); padding: 15px; border-radius: 10px; border: 1px solid #d6bcfa;">
                  <h4 style="color: #6b46c1; font-size: 16px; margin-bottom: 10px;"> Level 2: Consonant Assimilation Scores</h4>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${sortedLevel2.slice(0, 12).map(item => {
                      const rule = typeof CONSONANT_ASSIMILATION_RULES !== 'undefined' ?
                        CONSONANT_ASSIMILATION_RULES.find(r => r.id === item.ruleId) : null;
                      const ruleLabel = rule ? rule.rule : 'Rule #' + item.ruleId;
                      return `
                        <div style="background: white; padding: 6px 10px; border-radius: 6px; border: 1px solid ${item.grade === 4 ? '#48bb78' : item.grade >= 3 ? '#ed8936' : '#f56565'};">
                          <span style="font-size: 12px; color: #718096;">#${item.ruleId}</span>
                          <span style="font-size: 14px; font-weight: 600; color: ${item.grade === 4 ? '#48bb78' : item.grade >= 3 ? '#ed8936' : '#f56565'}; margin-left: 4px;">
                            ${item.grade}/4
                          </span>
                        </div>
                      `;
                    }).join('')}
                    ${sortedLevel2.length > 12 ? `<span style="color: #805ad5; font-size: 13px; padding: 6px;">+${sortedLevel2.length - 12} more</span>` : ''}
                  </div>
                </div>
              `;
            }

            let level2InstructionalVideosHtml = '';
            if (submission.level2InstructionalVideos && Object.keys(submission.level2InstructionalVideos).length > 0) {
              const videos = Object.entries(submission.level2InstructionalVideos)
                .map(([ruleId, data]) => ({ ruleId: parseInt(ruleId), ...data }))
                .sort((a, b) => a.grade - b.grade);

              level2InstructionalVideosHtml = `
                <div style="margin-top: 20px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; border: 2px solid #38b2ac;">
                  <h4 style="color: #276749; font-size: 18px; margin-bottom: 15px;">
                     Instructional Videos for Your Improvement Areas (${videos.length})
                  </h4>
                  <p style="color: #285e61; font-size: 14px; margin-bottom: 15px;">
                    Watch these videos to understand the consonant assimilation rules you need to practice:
                  </p>
                  <div style="display: grid; gap: 15px;">
                    ${videos.map(item => {
                      const embedUrl = item.videoUrl.replace('/share/', '/embed/');
                      const uniqueVideoId = 'instrVid-' + submission.id + '-' + item.ruleId;
                      return `
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${item.grade <= 2 ? '#f56565' : '#ed8936'}; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                              <span style="font-weight: bold; color: #2d3748; font-size: 16px;">Rule #${item.ruleId}</span>
                              <span style="color: ${item.grade <= 2 ? '#f56565' : '#ed8936'}; font-weight: bold; margin-left: 10px; font-size: 15px;">${item.grade}/5</span>
                            </div>
                            <span style="background: ${item.grade <= 2 ? '#fed7d7' : '#feebc8'}; color: ${item.grade <= 2 ? '#c53030' : '#c05621'}; font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                              ${item.grade <= 2 ? ' Needs Work' : ' Improving'}
                            </span>
                          </div>
                          <div style="font-size: 15px; color: #6b46c1; margin-bottom: 5px; font-weight: 600;">${item.rule}</div>
                          <div style="font-size: 13px; color: #718096; margin-bottom: 12px;">Example: ${item.example}</div>
                          <button onclick="document.getElementById('${uniqueVideoId}').style.display = document.getElementById('${uniqueVideoId}').style.display === 'none' ? 'block' : 'none'; this.innerHTML = document.getElementById('${uniqueVideoId}').style.display === 'none' ? ' Watch Video' : ' Hide Video';"
                                  style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                             Watch Video
                          </button>
                          <div id="${uniqueVideoId}" style="display: none; margin-top: 12px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <iframe src="${embedUrl}" width="100%" height="280" frameborder="0" allowfullscreen style="border-radius: 10px;"></iframe>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  <div style="margin-top: 15px; padding: 12px; background: #c6f6d5; border-radius: 8px;">
                    <p style="color: #276749; font-size: 13px; margin: 0;">
                      <strong> Study Tip:</strong> Watch each video multiple times and practice saying the examples out loud.
                      Pay attention to how the consonants change at syllable boundaries!
                    </p>
                  </div>
                </div>
              `;
            }

            return `
              <div class="test-card" style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <div>
                    <div style="font-size: 14px; color: #718096; margin-bottom: 5px;">
                      Submission #${group.feedback.length - index}  ${submission.gradedAt ? submission.gradedAt.toDate().toLocaleDateString() : 'Recently'} ${submission.gradedAt ? submission.gradedAt.toDate().toLocaleTimeString() : ''}
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #667eea;">
                      ${submission.overallScore || 0}%
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 13px; color: #718096; margin-bottom: 5px;">Overall Score</div>
                    <div style="background: ${submission.overallScore >= 70 ? '#48bb78' : submission.overallScore >= 50 ? '#ed8936' : '#f56565'}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; display: inline-block;">
                      ${submission.overallScore >= 70 ? ' Great!' : submission.overallScore >= 50 ? ' Good Progress' : ' Keep Practicing'}
                    </div>
                  </div>
                </div>
                ${feedbackHtml}
                ${videoHtml}
                ${level2GradesHtml}
                ${level2InstructionalVideosHtml}
                ${level2VideoHtml}
                ${submission.teacherComments ? `
                  <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="color: #c53030; font-size: 16px; margin-bottom: 8px;"> Teacher Comments:</h4>
                    <p style="color: #2d3748; line-height: 1.6;">${submission.teacherComments}</p>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;

      feedbackList.appendChild(feedbackFolder);
    });

  } catch (error) {
    feedbackList.innerHTML = '<p>Error loading feedback2: ' + error.message + '</p>';
  }
}

function toggleFeedbackFolder(testId) {
  const items = document.getElementById('feedback-items-' + testId);
  if (items) {
    items.classList.toggle('open');
  }
}

function loadVideo(containerId, embedUrl) {
  const button = document.getElementById('btn-' + containerId);
  if (button) {
    button.style.display = 'none';
  }

  const container = document.getElementById(containerId);
  if (container) {
    container.style.display = 'block';
    container.innerHTML = `
      <div class="video-container">
        <iframe src="${embedUrl}" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
      </div>
      <button onclick="hideVideo('${containerId}')" style="margin-top: 10px; color: #718096; background: #f7fafc; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">
        Hide Video
      </button>
    `;
  }
}

function hideVideo(containerId) {
  const container = document.getElementById(containerId);
  if (container) {
    container.style.display = 'none';
    container.innerHTML = '';
  }

  const button = document.getElementById('btn-' + containerId);
  if (button) {
    button.style.display = 'inline-flex';
  }
}


/**
 * Load drill tracking data for all students (Teacher view)
 */
async function loadDrillTracking() {
  const container = document.getElementById('drillTrackingContainer');
  if (!container) return;

  container.innerHTML = `
    <div style="text-align: center; padding: 40px; color: #718096;">
      <div style="font-size: 50px; margin-bottom: 15px;"></div>
      <p>Loading drill tracking data...</p>
    </div>
  `;

  try {
    const drillsSnapshot = await db.collection('pronunciationLeitner').get();
    const allDrills = drillsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    const studentIds = [...new Set(allDrills.map(d => d.studentId))];

    const studentMap = {};
    for (const studentId of studentIds) {
      try {
        const userDoc = await db.collection('users').doc(studentId).get();
        if (userDoc.exists) {
          studentMap[studentId] = userDoc.data();
        }
      } catch (e) {
      }
    }

    const studentDrills = {};
    allDrills.forEach(drill => {
      if (!studentDrills[drill.studentId]) {
        studentDrills[drill.studentId] = [];
      }
      studentDrills[drill.studentId].push(drill);
    });

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const studentStats = Object.entries(studentDrills).map(([studentId, drills]) => {
      const student = studentMap[studentId] || { email: 'Unknown Student' };

      const activeDrills = drills.filter(d => !d.isComplete);
      const completedDrills = drills.filter(d => d.isComplete);

      const level1Active = activeDrills.filter(d => !d.level || d.level === 1);
      const level2Active = activeDrills.filter(d => d.level === 2);

      const doneToday = activeDrills.filter(d => d.completedToday).length;
      const dueToday = activeDrills.filter(d => !d.completedToday).length;

      let streak = 0;
      let checkDate = new Date(today);

      for (let i = 0; i < 30; i++) {
        const dayDrills = drills.filter(d => {
          if (!d.lastCompletedDate) return false;
          const completed = d.lastCompletedDate.toDate ? d.lastCompletedDate.toDate() : new Date(d.lastCompletedDate);
          const completedDay = new Date(completed);
          completedDay.setHours(0, 0, 0, 0);
          return completedDay.getTime() === checkDate.getTime();
        });

        if (dayDrills.length > 0) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else if (i > 0) {
          break;
        } else {
          checkDate.setDate(checkDate.getDate() - 1);
        }
      }

      return {
        studentId,
        email: student.email,
        name: student.displayName || student.email?.split('@')[0] || 'Unknown',
        activeDrills: activeDrills.length,
        completedDrills: completedDrills.length,
        level1Drills: level1Active.length,
        level2Drills: level2Active.length,
        level2Completed: completedDrills.filter(d => d.level === 2).length,
        doneToday,
        dueToday,
        streak,
        drills: activeDrills,
        level2Unlocked: student.level2Unlocked || false
      };
    });

    studentStats.sort((a, b) => b.dueToday - a.dueToday);

    renderDrillTrackingDashboard(studentStats, today);

  } catch (error) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #c53030;">
        <div style="font-size: 50px; margin-bottom: 15px;"></div>
        <p>Error loading drill tracking data</p>
        <p style="font-size: 14px;">${error.message}</p>
      </div>
    `;
  }
}

/**
 * Render the drill tracking dashboard
 */
function renderDrillTrackingDashboard(studentStats, today) {
  const container = document.getElementById('drillTrackingContainer');

  const totalStudents = studentStats.length;
  const studentsOnTrack = studentStats.filter(s => s.dueToday === 0 && s.activeDrills > 0).length;
  const studentsBehind = studentStats.filter(s => s.dueToday > 0).length;
  const totalActiveDrills = studentStats.reduce((sum, s) => sum + s.activeDrills, 0);
  const totalCompletedDrills = studentStats.reduce((sum, s) => sum + s.completedDrills, 0);

  const studentsWithLevel2 = studentStats.filter(s => s.level2Drills > 0 || s.level2Completed > 0).length;
  const totalLevel2Active = studentStats.reduce((sum, s) => sum + (s.level2Drills || 0), 0);

  container.innerHTML = `
    <!-- Overall Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 25px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${totalStudents}</div>
        <div style="font-size: 12px; opacity: 0.9;">Students</div>
      </div>
      <div style="background: ${studentsOnTrack > 0 ? 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)' : '#e2e8f0'}; color: ${studentsOnTrack > 0 ? 'white' : '#718096'}; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${studentsOnTrack}</div>
        <div style="font-size: 12px; opacity: 0.9;">On Track</div>
      </div>
      <div style="background: ${studentsBehind > 0 ? 'linear-gradient(135deg, #f56565 0%, #ed8936 100%)' : '#e2e8f0'}; color: ${studentsBehind > 0 ? 'white' : '#718096'}; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${studentsBehind}</div>
        <div style="font-size: 12px; opacity: 0.9;">Need Practice</div>
      </div>
      <div style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${studentsWithLevel2}</div>
        <div style="font-size: 12px; opacity: 0.9;">Level 2 Unlocked</div>
      </div>
      <div style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${totalCompletedDrills}</div>
        <div style="font-size: 12px; opacity: 0.9;">Finished (7/7)</div>
      </div>
    </div>

    <!-- Date Display -->
    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <strong> Today:</strong> ${today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
      </div>
      <button onclick="loadDrillTracking()" class="btn btn-secondary" style="padding: 8px 16px;">
         Refresh
      </button>
    </div>

    <!-- Student List -->
    <h3 style="margin-bottom: 15px; color: #2d3748;"> Student Progress</h3>

    ${studentStats.length === 0 ? `
      <div style="text-align: center; padding: 40px; color: #718096; background: #f7fafc; border-radius: 12px;">
        <div style="font-size: 50px; margin-bottom: 15px;"></div>
        <p>No students have pronunciation drills yet.</p>
        <p style="font-size: 14px;">Drills are assigned when you grade pronunciation evaluations.</p>
      </div>
    ` : `
      <div style="display: grid; gap: 15px;">
        ${studentStats.map(student => {
          const isOnTrack = student.dueToday === 0 && student.activeDrills > 0;
          const hasActiveDrills = student.activeDrills > 0;
          const level1Drills = student.drills.filter(d => !d.level || d.level === 1);
          const level2DrillsList = student.drills.filter(d => d.level === 2);

          return `
            <div style="background: white; border: 2px solid ${student.dueToday > 0 ? '#f56565' : isOnTrack ? '#48bb78' : '#e2e8f0'}; border-radius: 12px; padding: 20px; ${student.dueToday > 0 ? 'box-shadow: 0 4px 15px rgba(245, 101, 101, 0.2);' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1; min-width: 200px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px; font-weight: bold; color: #2d3748;">${student.name}</span>
                    ${student.level2Unlocked ? '<span style="background: #9f7aea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Level 2</span>' : ''}
                    ${student.streak >= 3 ? `<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 11px;"> ${student.streak} day streak</span>` : ''}
                  </div>
                  <div style="color: #718096; font-size: 14px;">${student.email}</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                  <div>
                    <div style="font-size: 22px; font-weight: bold; color: #667eea;">${student.activeDrills}</div>
                    <div style="font-size: 11px; color: #718096;">Active</div>
                  </div>
                  <div>
                    <div style="font-size: 22px; font-weight: bold; color: ${student.doneToday > 0 ? '#48bb78' : '#a0aec0'};">${student.doneToday}</div>
                    <div style="font-size: 11px; color: #718096;">Done</div>
                  </div>
                  <div>
                    <div style="font-size: 22px; font-weight: bold; color: ${student.dueToday > 0 ? '#f56565' : '#48bb78'};">${student.dueToday}</div>
                    <div style="font-size: 11px; color: #718096;">Due</div>
                  </div>
                  <div>
                    <div style="font-size: 22px; font-weight: bold; color: #9f7aea;">${student.completedDrills}</div>
                    <div style="font-size: 11px; color: #718096;">Done 7/7</div>
                  </div>
                </div>
              </div>

              ${hasActiveDrills ? `
                <!-- Level 1 Drills -->
                ${level1Drills.length > 0 ? `
                  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <div style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 8px;">Level 1: Consonant Aspirations</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                      ${level1Drills.map(drill => {
                        const isDone = drill.completedToday;
                        const currentDay = drill.currentDay || 1;
                        const totalDays = drill.totalDays || 7;
                        return `
                          <div style="background: ${isDone ? '#f0fff4' : '#fff5f5'}; padding: 6px 10px; border-radius: 6px; border: 1px solid ${isDone ? '#48bb78' : '#f56565'}; font-size: 12px;">
                            <strong>${drill.topic}</strong>
                            <span style="color: ${isDone ? '#276749' : '#c53030'}; margin-left: 6px;">
                              D${currentDay}/${totalDays} ${isDone ? '' : ''}
                            </span>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}

                <!-- Level 2 Drills -->
                ${level2DrillsList.length > 0 ? `
                  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9d8fd;">
                    <div style="font-size: 13px; color: #9f7aea; font-weight: 600; margin-bottom: 8px;">Level 2: Consonant Assimilation</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                      ${level2DrillsList.map(drill => {
                        const isDone = drill.completedToday;
                        const currentDay = drill.currentDay || 1;
                        const totalDays = drill.totalDays || 7;
                        return `
                          <div style="background: ${isDone ? '#faf5ff' : '#fff5f5'}; padding: 6px 10px; border-radius: 6px; border: 1px solid ${isDone ? '#9f7aea' : '#f56565'}; font-size: 12px;">
                            <strong>${drill.topicLabel || drill.topic}</strong>
                            <span style="color: ${isDone ? '#6b46c1' : '#c53030'}; margin-left: 6px;">
                              D${currentDay}/${totalDays} ${isDone ? '' : ''}
                            </span>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}
              ` : `
                <div style="margin-top: 15px; padding: 15px; background: #f0fff4; border-radius: 8px; text-align: center; color: #276749;">
                   All drills completed! Great job!
                </div>
              `}
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;
}


let pronunciationDrillCards = [];
let pronDrillDueCards = [];
let pronDrillCompletedCards = [];
let pronDrillState = {
  cardId: null,
  currentWordIndex: 0,
  currentRepetition: 1,
  totalRepetitions: 1,
  words: [],
  correctInRep: 0,
  totalCorrect: 0,
  totalAttempts: 0
};
let pronRecognition = null;
let pronIsListening = false;
let pronTargetWord = '';
let pronRecognizedText = '';
let pronTimer = null;
let pronTimeRemaining = 10;

const PRON_DRILL_REPS = {
  1: 7, 2: 6, 3: 5, 4: 5, 5: 4, 6: 4, 7: 3, 8: 3, 9: 2, 10: 1
};

/**
 * Load pronunciation drill cards from Firestore
 */
async function loadPronunciationDrillCards() {
  if (!currentUser) return;

  try {
    const snapshot = await db.collection('pronunciationLeitner')
      .where('studentId', '==', currentUser.uid)
      .get();

    pronunciationDrillCards = snapshot.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .filter(card => !card.isDailyActivity); // Exclude daily activity drills

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (const card of pronunciationDrillCards) {
      if (card.isComplete) continue;

      const lastCompleted = card.lastCompletedDate?.toDate ? card.lastCompletedDate.toDate() : null;
      if (lastCompleted) {
        const lastCompletedDay = new Date(lastCompleted);
        lastCompletedDay.setHours(0, 0, 0, 0);

        if (lastCompletedDay.getTime() < today.getTime() && card.completedToday) {
          await db.collection('pronunciationLeitner').doc(card.id).update({
            completedToday: false,
            completedRepetitionsToday: 0
          });
          card.completedToday = false;
          card.completedRepetitionsToday = 0;
        }
      }
    }

    const allActiveDue = pronunciationDrillCards.filter(card => {
      return !card.isComplete && !card.completedToday;
    });

    allActiveDue.sort((a, b) => a.grade - b.grade);
    pronDrillDueCards = allActiveDue.slice(0, 5);

    pronDrillCompletedCards = pronunciationDrillCards.filter(card => card.isComplete);

    updatePronDrillBadge();

  } catch (error) {
  }
}

/**
 * Update pronunciation drill badge
 */
function updatePronDrillBadge() {
  const badge = document.getElementById('pronDrillsBadge');
  if (badge) {
    if (pronDrillDueCards.length > 0) {
      badge.textContent = pronDrillDueCards.length;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }
}

/**
 * Render pronunciation drills main view
 */
async function renderPronunciationDrills() {
  await loadPronunciationDrillCards();

  await loadPronunciationSubmissions();

  const container = document.getElementById('pronunciationDrillsContainer');
  if (!container) return;

  const recentFeedback = pronSubmissions
    .filter(s => s.status === 'graded' && (s.videoFeedbackUrl || s.level2VideoFeedbackUrl))
    .sort((a, b) => (b.gradedAt || b.submittedAt) - (a.gradedAt || a.submittedAt))[0];

  if (pronunciationDrillCards.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #718096;">
        <div style="font-size: 80px; margin-bottom: 20px;"></div>
        <h3 style="color: #4a5568; margin-bottom: 10px;">No Pronunciation Drills Yet</h3>
        <p>Once your teacher grades your pronunciation evaluations, your drill assignments will appear here.</p>
        <p style="margin-top: 15px; font-size: 14px;">Each topic requires 7 days of practice to complete.</p>
      </div>
    `;
    return;
  }

  const level1Drills = pronunciationDrillCards.filter(c => !c.level || c.level === 1);
  const level2Drills = pronunciationDrillCards.filter(c => c.level === 2);

  const level1Active = level1Drills.filter(c => !c.isComplete);
  const level1Completed = level1Drills.filter(c => c.isComplete);
  const level2Active = level2Drills.filter(c => !c.isComplete);
  const level2Completed = level2Drills.filter(c => c.isComplete);

  const allActiveDrills = [...level1Active, ...level2Active];
  allActiveDrills.sort((a, b) => a.grade - b.grade);

  const priorityDrills = allActiveDrills.slice(0, 5);
  const extraDrills = allActiveDrills.slice(5);

  const priorityDue = priorityDrills.filter(c => !c.completedToday).length;
  const extraDue = extraDrills.filter(c => !c.completedToday).length;
  const totalDue = priorityDue; // Only priority drills count towards "due"
  const doneToday = priorityDrills.filter(c => c.completedToday).length;
  const allCompleted = level1Completed.length + level2Completed.length;

  let teacherFeedbackHtml = '';
  if (recentFeedback) {
    const feedbackDate = recentFeedback.gradedAt || recentFeedback.submittedAt;
    const feedbackDateStr = feedbackDate ? feedbackDate.toLocaleDateString() : 'Recently';

    teacherFeedbackHtml = `
      <!-- Most Recent Teacher Feedback -->
      <div style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #48bb78;
                  border-radius: 16px; padding: 20px; margin-bottom: 25px; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -10px; right: -10px; font-size: 60px; opacity: 0.1;"></div>

        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <div>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <span style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white;
                           padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                NEW FEEDBACK
              </span>
              <span style="color: #718096; font-size: 13px;"> ${feedbackDateStr}</span>
            </div>
            <h3 style="color: #276749; margin: 0 0 5px 0; font-size: 18px;"> Latest Teacher Feedback</h3>
            <p style="color: #2f855a; margin: 0; font-size: 14px;">
              ${recentFeedback.testTitle} - Watch your personalized feedback!
            </p>
          </div>
          <button onclick="showSubmissionDetail('${recentFeedback.id}')" class="btn"
                  style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); padding: 12px 25px; white-space: nowrap;">
             Watch Feedback
          </button>
        </div>

        <div id="latestFeedbackVideoContainer" style="display: none; margin-top: 15px;">
          ${recentFeedback.videoFeedbackUrl ? `
            <video id="latestFeedbackVideo" controls style="width: 100%; max-width: 100%; border-radius: 12px; border: 3px solid #48bb78;">
              <source src="${recentFeedback.videoFeedbackUrl}" type="video/webm">
            </video>
          ` : recentFeedback.level2VideoFeedbackUrl ? `
            <video id="latestFeedbackVideo" controls style="width: 100%; max-width: 100%; border-radius: 12px; border: 3px solid #9f7aea;">
              <source src="${recentFeedback.level2VideoFeedbackUrl}" type="video/webm">
            </video>
          ` : ''}
        </div>

        <button onclick="toggleLatestFeedbackVideo()" id="toggleFeedbackBtn"
                style="background: transparent; border: 2px dashed #48bb78; color: #276749;
                       padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px;
                       font-weight: 500; width: 100%;">
           Show Video Preview
        </button>
      </div>
    `;
  }

  container.innerHTML = `
    ${teacherFeedbackHtml}

    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 25px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${priorityDrills.length}</div>
        <div style="font-size: 12px; opacity: 0.9;">Priority Drills</div>
      </div>
      <div style="background: ${priorityDue > 0 ? 'linear-gradient(135deg, #f56565 0%, #ed8936 100%)' : 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)'}; color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${priorityDue}</div>
        <div style="font-size: 12px; opacity: 0.9;">Due Today</div>
      </div>
      <div style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${doneToday}</div>
        <div style="font-size: 12px; opacity: 0.9;">Done Today</div>
      </div>
      <div style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${allCompleted}</div>
        <div style="font-size: 12px; opacity: 0.9;">Finished (7/7)</div>
      </div>
    </div>

    ${priorityDue > 0 ? `
      <!-- Due Drills Alert -->
      <div style="background: #fff5f5; border: 2px solid #f56565; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div>
            <h3 style="color: #c53030; margin: 0 0 5px 0;"> ${priorityDue} Priority Drill${priorityDue !== 1 ? 's' : ''} Need Practice Today!</h3>
            <p style="color: #742a2a; margin: 0; font-size: 14px;">Focus on your 5 lowest-scoring topics to improve fastest.</p>
          </div>
          <button class="btn" onclick="startPronDrillSession()" style="background: #f56565; padding: 12px 30px; white-space: nowrap;">
             Start Drill Session
          </button>
        </div>
      </div>
    ` : priorityDrills.length > 0 ? `
      <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: center;">
        <h3 style="color: #276749; margin: 0;"> All Priority Drills Done for Today!</h3>
        <p style="color: #2f855a; margin: 10px 0 0 0;">Great job! Come back tomorrow to continue.</p>
      </div>
    ` : ''}

    <!-- Priority Drills Section (Top 5 Lowest Scores) -->
    ${priorityDrills.length > 0 ? `
      <div style="margin-bottom: 30px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <h3 style="margin: 0; color: #c53030;"> Priority Drills</h3>
          <span style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
            Top 5 Lowest Scores
          </span>
        </div>
        <p style="color: #718096; margin-bottom: 15px; font-size: 14px;">
           Focus on these drills first! These are your 5 lowest-scoring topics that need the most practice.
        </p>
        <div style="display: grid; gap: 15px;">
          ${priorityDrills.map((card, index) => renderDrillCard(card, card.level === 2, index + 1)).join('')}
        </div>
      </div>
    ` : ''}

    <!-- Extra Drills Section (Collapsible) -->
    ${extraDrills.length > 0 ? `
      <div style="margin-bottom: 30px;">
        <div onclick="toggleExtraDrills()" style="background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%); border: 2px solid #cbd5e0; border-radius: 12px; padding: 18px 20px; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background='linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%)'">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;"></span>
            <div>
              <h4 style="margin: 0; color: #4a5568;">Extra Practice Drills</h4>
              <p style="margin: 3px 0 0 0; font-size: 13px; color: #718096;">${extraDrills.length} additional drill${extraDrills.length !== 1 ? 's' : ''} available  ${extraDue} due today</p>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="background: #a0aec0; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Optional</span>
            <span id="extraDrillsArrow" style="font-size: 20px; color: #718096; transition: transform 0.3s ease;"></span>
          </div>
        </div>
        <div id="extraDrillsContainer" style="display: none; margin-top: 15px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
          <p style="color: #718096; margin-bottom: 15px; font-size: 14px;">
             These are additional drills you can work on if you want extra practice. They are not required but will help you improve further!
          </p>
          <div style="display: grid; gap: 15px;">
            ${extraDrills.map((card, index) => renderDrillCard(card, card.level === 2, null, true)).join('')}
          </div>
        </div>
      </div>
    ` : ''}

    <!-- Completed Drills Section -->
    ${(level1Completed.length > 0 || level2Completed.length > 0) ? `
      <div style="margin-bottom: 30px;">
        <div onclick="toggleCompletedDrills()" style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #68d391; border-radius: 12px; padding: 18px 20px; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background='linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%)'">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;"></span>
            <div>
              <h4 style="margin: 0; color: #276749;">Completed Drills</h4>
              <p style="margin: 3px 0 0 0; font-size: 13px; color: #2f855a;">${allCompleted} drill${allCompleted !== 1 ? 's' : ''} finished (7/7 days)</p>
            </div>
          </div>
          <span id="completedDrillsArrow" style="font-size: 20px; color: #48bb78; transition: transform 0.3s ease;"></span>
        </div>
        <div id="completedDrillsContainer" style="display: none; margin-top: 15px;">
          ${level1Completed.length > 0 ? `
            <div style="margin-bottom: 15px;">
              <h5 style="color: #2d3748; margin-bottom: 10px;"> Level 1: Consonant Aspirations</h5>
              <div style="display: grid; gap: 10px;">
                ${level1Completed.map(card => `
                  <div style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 1px solid #48bb78; border-radius: 10px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #276749;">${card.topic}</span>
                    <span style="color: #2f855a; font-size: 14px;"> 7/7 days complete!</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          ${level2Completed.length > 0 ? `
            <div>
              <h5 style="color: #6b46c1; margin-bottom: 10px;"> Level 2: Consonant Assimilation</h5>
              <div style="display: grid; gap: 10px;">
                ${level2Completed.map(card => `
                  <div style="background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%); border: 1px solid #9f7aea; border-radius: 10px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #6b46c1;">${card.topicLabel || card.topic}</span>
                    <span style="color: #805ad5; font-size: 14px;"> 7/7 days complete!</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    ` : ''}
  `;
}

/**
 * Toggle Extra Drills visibility
 */
function toggleExtraDrills() {
  const container = document.getElementById('extraDrillsContainer');
  const arrow = document.getElementById('extraDrillsArrow');
  if (!container) return;

  if (container.style.display === 'none') {
    container.style.display = 'block';
    if (arrow) arrow.style.transform = 'rotate(180deg)';
  } else {
    container.style.display = 'none';
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  }
}

/**
 * Toggle Completed Drills visibility
 */
function toggleCompletedDrills() {
  const container = document.getElementById('completedDrillsContainer');
  const arrow = document.getElementById('completedDrillsArrow');
  if (!container) return;

  if (container.style.display === 'none') {
    container.style.display = 'block';
    if (arrow) arrow.style.transform = 'rotate(180deg)';
  } else {
    container.style.display = 'none';
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  }
}

/**
 * Render a single drill card
 */
function renderDrillCard(card, isLevel2 = false, priorityRank = null, isExtra = false) {
  const isDue = !card.completedToday;
  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;
  const requiredReps = card.requiredRepetitions || 1;
  const accentColor = isLevel2 ? '#9f7aea' : '#667eea';
  const bgGradient = isLevel2 ? 'linear-gradient(135deg, #9f7aea 0%, #667eea 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

  const borderColor = isExtra ? '#cbd5e0' : (isDue ? '#f56565' : '#48bb78');
  const cardOpacity = isExtra ? 'opacity: 0.85;' : '';

  return `
    <div style="background: white; border: 2px solid ${borderColor}; border-radius: 12px; padding: 20px; ${isDue && !isExtra ? 'box-shadow: 0 4px 15px rgba(245, 101, 101, 0.2);' : ''} ${cardOpacity}">
      <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
            ${priorityRank ? `<span style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">#${priorityRank}</span>` : ''}
            <span style="font-size: 24px; font-weight: bold; color: ${accentColor};">${card.topicLabel || card.topic}</span>
            <span style="background: ${card.grade < 3 ? '#fed7d7' : card.grade < 4 ? '#feebc8' : '#c6f6d5'};
                   color: ${card.grade < 3 ? '#c53030' : card.grade < 4 ? '#c05621' : '#276749'};
                   padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              Score: ${card.grade}/${isLevel2 ? '5' : '10'}
            </span>
            ${isDue ? '<span style="background: #f56565; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px;">Due Today</span>' : '<span style="background: #48bb78; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px;"> Done Today</span>'}
          </div>
          ${card.topicDescription ? `<div style="color: #718096; font-size: 13px; margin-bottom: 5px;"><em>${card.topicDescription}</em></div>` : ''}
          <div style="color: #718096; font-size: 14px;">
            <span> ${card.testTitle || 'Unknown Test'}</span>
          </div>

          <!-- 7-Day Progress -->
          <div style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 13px; color: #4a5568; margin-bottom: 8px;">
              <span style="font-weight: 600;"> Day ${currentDay} of ${totalDays}</span>
              <span>${requiredReps} repetitions per day</span>
            </div>
            <div style="display: flex; gap: 4px;">
              ${Array.from({length: totalDays}, (_, i) => {
                const dayNum = i + 1;
                const isCompleted = dayNum < currentDay;
                const isCurrent = dayNum === currentDay;
                const isCompletedToday = isCurrent && card.completedToday;
                return `
                  <div style="flex: 1; height: 12px; border-radius: 6px;
                    background: ${isCompleted || isCompletedToday ? '#48bb78' : isCurrent ? '#fbbf24' : '#e2e8f0'};
                    ${isCurrent ? 'box-shadow: 0 0 0 2px #f59e0b;' : ''}">
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>

        <div>
          ${isDue ? `
            <button class="btn btn-secondary" onclick="startSinglePronDrill('${card.id}')" style="padding: 10px 20px; background: ${bgGradient}; border: none;">
               Practice Day ${currentDay}
            </button>
          ` : `
            <button class="btn" onclick="startSinglePronDrill('${card.id}')" style="padding: 10px 20px; background: #48bb78;">
               Practice Again
            </button>
          `}
        </div>
      </div>

      <!-- Preview of drill words -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
        <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">Drill Words (${(card.drillWords || []).length} words):</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${(card.drillWords || []).slice(0, 8).map(word => `
            <span style="background: #f7fafc; padding: 4px 10px; border-radius: 6px; font-size: 14px;">${word}</span>
          `).join('')}
          ${(card.drillWords || []).length > 8 ? `<span style="color: #a0aec0; font-size: 14px;">+${card.drillWords.length - 8} more</span>` : ''}
        </div>
      </div>
    </div>
  `;
}


/**
 * State for the all-in-one session
 */
let allInOneState = {
  isActive: false,
  currentPhase: null, // 'pronunciation', 'grammar', 'flashcard'
  phaseOrder: ['pronunciation', 'grammar', 'flashcard'],
  currentPhaseIndex: 0,
  completedPhases: [],
  stats: {
    pronunciation: { total: 0, completed: 0 },
    grammar: { total: 0, completed: 0 },
    flashcard: { total: 0, completed: 0 }
  }
};

/**
 * Render the All in One dashboard
 */
async function renderAllInOneDashboard() {
  const container = document.getElementById('allInOneContainer');
  if (!container) return;

  if (!currentUser) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <p style="color: #718096;">Please wait while we load your data...</p>
      </div>
    `;
    setTimeout(() => renderAllInOneDashboard(), 1000);
    return;
  }

  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div><p>Loading your daily tasks...</p></div>';

  try {
    await Promise.all([
      loadPronunciationDrillCards().catch(() => {}),
      loadGrammarLeitnerCards().catch(() => {}),
      loadLeitnerData().catch(() => {})
    ]);

    const pronDue = (pronDrillDueCards || []).length;
    const grammarDue = (grammarDueCards || []).length;
    const flashcardDue = (leitnerDueCards || []).length;
    const totalDue = pronDue + grammarDue + flashcardDue;

    updateAllInOneBadge();

    if (totalDue === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 100px; margin-bottom: 20px;"></div>
          <h2 style="color: #276749; margin-bottom: 15px;">All Done for Today!</h2>
          <p style="color: #2f855a; font-size: 18px; margin-bottom: 30px;">
            Excellent work! You've completed all your daily practice tasks.
          </p>
          <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 16px; padding: 25px; max-width: 400px; margin: 0 auto;">
            <p style="color: #276749; margin: 0;">
              Come back tomorrow for your next practice session!
            </p>
          </div>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <!-- Summary Cards -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <!-- Pronunciation Card -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
          <div style="font-size: 40px; margin-bottom: 10px;"></div>
          <div style="font-size: 36px; font-weight: bold;">${pronDue}</div>
          <div style="font-size: 14px; opacity: 0.9;">Pronunciation Drills</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Priority drills due</div>
        </div>

        <!-- Grammar Card -->
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);">
          <div style="font-size: 40px; margin-bottom: 10px;"></div>
          <div style="font-size: 36px; font-weight: bold;">${grammarDue}</div>
          <div style="font-size: 14px; opacity: 0.9;">Grammar Drills</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Review cards due</div>
        </div>

        <!-- Flashcard Card -->
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);">
          <div style="font-size: 40px; margin-bottom: 10px;"></div>
          <div style="font-size: 36px; font-weight: bold;">${flashcardDue}</div>
          <div style="font-size: 14px; opacity: 0.9;">Flashcard Reviews</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Leitner cards due</div>
        </div>
      </div>

      <!-- Total and Start Button -->
      <div style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); border-radius: 20px; padding: 35px; text-align: center; box-shadow: 0 8px 30px rgba(237, 137, 54, 0.4);">
        <div style="color: white; margin-bottom: 20px;">
          <div style="font-size: 60px; font-weight: bold;">${totalDue}</div>
          <div style="font-size: 18px; opacity: 0.9;">Total Items to Complete</div>
        </div>

        <button onclick="startAllInOneSession()" style="background: white; color: #c53030; border: none; padding: 20px 50px; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            ! Start Session
        </button>

        <p style="color: rgba(255,255,255,0.8); margin-top: 20px; font-size: 14px;">
          Complete all drills in one focused session
        </p>
      </div>

      <!-- Session Order Info -->
      <div style="margin-top: 30px; background: #f7fafc; border-radius: 16px; padding: 25px;">
        <h3 style="margin: 0 0 15px 0; color: #2d3748;"> Session Order</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: ${pronDue > 0 ? '#e9d8fd' : '#e2e8f0'}; border-radius: 10px; ${pronDue === 0 ? 'opacity: 0.5;' : ''}">
            <span style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
            <span style="font-size: 20px;"></span>
            <span style="flex: 1; font-weight: 600; color: #553c9a;">Pronunciation Drills</span>
            <span style="color: #805ad5;">${pronDue > 0 ? `${pronDue} due` : ' Done'}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: ${grammarDue > 0 ? '#c6f6d5' : '#e2e8f0'}; border-radius: 10px; ${grammarDue === 0 ? 'opacity: 0.5;' : ''}">
            <span style="background: #48bb78; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
            <span style="font-size: 20px;"></span>
            <span style="flex: 1; font-weight: 600; color: #276749;">Grammar Drills</span>
            <span style="color: #2f855a;">${grammarDue > 0 ? `${grammarDue} due` : ' Done'}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: ${flashcardDue > 0 ? '#feebc8' : '#e2e8f0'}; border-radius: 10px; ${flashcardDue === 0 ? 'opacity: 0.5;' : ''}">
            <span style="background: #ed8936; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</span>
            <span style="font-size: 20px;"></span>
            <span style="flex: 1; font-weight: 600; color: #c05621;">Flashcard Reviews</span>
            <span style="color: #dd6b20;">${flashcardDue > 0 ? `${flashcardDue} due` : ' Done'}</span>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 60px; margin-bottom: 15px;"></div>
        <p style="color: #c53030; margin-bottom: 15px;">Error loading your tasks</p>
        <button onclick="renderAllInOneDashboard()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
           Try Again
        </button>
      </div>
    `;
  }
}

/**
 * Update the all-in-one badge
 */
function updateAllInOneBadge() {
  const badge = document.getElementById('allInOneBadge');
  if (!badge) return;

  const pronDue = (typeof pronDrillDueCards !== 'undefined') ? pronDrillDueCards.length : 0;
  const grammarDue = (typeof grammarDueCards !== 'undefined') ? grammarDueCards.length : 0;
  const flashcardDue = (typeof leitnerDueCards !== 'undefined') ? leitnerDueCards.length : 0;
  const totalDue = pronDue + grammarDue + flashcardDue;

  if (totalDue > 0) {
    badge.textContent = totalDue;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

/**
 * Start the all-in-one session
 */
async function startAllInOneSession() {
  showSpeechDisclaimer(() => {
    _startAllInOneSessionInternal();
  });
}

async function _startAllInOneSessionInternal() {
  allInOneState = {
    isActive: true,
    currentPhase: null,
    phaseOrder: ['pronunciation', 'grammar', 'flashcard'],
    currentPhaseIndex: 0,
    completedPhases: [],
    stats: {
      pronunciation: { total: pronDrillDueCards.length, completed: 0 },
      grammar: { total: grammarDueCards.length, completed: 0 },
      flashcard: { total: leitnerDueCards.length, completed: 0 }
    }
  };

  while (allInOneState.currentPhaseIndex < allInOneState.phaseOrder.length) {
    const phase = allInOneState.phaseOrder[allInOneState.currentPhaseIndex];
    if (allInOneState.stats[phase].total > 0) {
      allInOneState.currentPhase = phase;
      break;
    }
    allInOneState.currentPhaseIndex++;
  }

  if (!allInOneState.currentPhase) {
    alert('No items due today!');
    return;
  }

  startAllInOnePhase(allInOneState.currentPhase);
}

/**
 * Start a specific phase of the all-in-one session
 */
function startAllInOnePhase(phase) {
  const container = document.getElementById('allInOneContainer');

  container.innerHTML = `
    <div style="text-align: center; padding: 60px 20px;">
      <div style="font-size: 80px; margin-bottom: 20px;">
        ${phase === 'pronunciation' ? '' : phase === 'grammar' ? '' : ''}
      </div>
      <h2 style="color: #2d3748; margin-bottom: 10px;">
        ${phase === 'pronunciation' ? 'Pronunciation Drills' : phase === 'grammar' ? 'Grammar Drills' : 'Flashcard Review'}
      </h2>
      <p style="color: #718096; margin-bottom: 30px;">
        ${allInOneState.stats[phase].total} items to complete
      </p>

      <!-- Progress indicator -->
      <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 30px;">
        ${allInOneState.phaseOrder.map((p, i) => {
          const isCompleted = allInOneState.completedPhases.includes(p);
          const isCurrent = p === phase;
          const hasItems = allInOneState.stats[p].total > 0;
          return `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; ${!hasItems ? 'opacity: 0.3;' : ''}">
              <div style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;
                background: ${isCompleted ? '#48bb78' : isCurrent ? '#f56565' : '#e2e8f0'}; color: ${isCompleted || isCurrent ? 'white' : '#718096'};">
                ${isCompleted ? '' : p === 'pronunciation' ? '' : p === 'grammar' ? '' : ''}
              </div>
              <span style="font-size: 11px; color: ${isCurrent ? '#c53030' : '#718096'};">
                ${p === 'pronunciation' ? 'Pron.' : p === 'grammar' ? 'Grammar' : 'Flashcard'}
              </span>
            </div>
          `;
        }).join('')}
      </div>

      <button onclick="executeAllInOnePhase('${phase}')" class="btn" style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); padding: 15px 40px; font-size: 18px;">
         Start ${phase === 'pronunciation' ? 'Pronunciation' : phase === 'grammar' ? 'Grammar' : 'Flashcard'} Phase
      </button>
    </div>
  `;
}

/**
 * Execute the current phase
 */
function executeAllInOnePhase(phase) {
  if (phase === 'pronunciation') {
    allInOneState.currentPhase = 'pronunciation';
    startPronDrillSessionForAllInOne();
  } else if (phase === 'grammar') {
    allInOneState.currentPhase = 'grammar';
    startGrammarReviewForAllInOne();
  } else if (phase === 'flashcard') {
    allInOneState.currentPhase = 'flashcard';
    startFlashcardReviewForAllInOne();
  }
}

/**
 * Start pronunciation drill for all-in-one session
 * Renders directly in allInOneContainer instead of switching tabs
 */
function startPronDrillSessionForAllInOne() {
  if (pronDrillDueCards.length === 0) {
    completeAllInOnePhase('pronunciation');
    return;
  }

  window.allInOnePronCallback = true;

  const card = pronunciationDrillCards.find(c => c.id === pronDrillDueCards[0].id);
  if (!card || !card.drillWords || card.drillWords.length === 0) {
    completeAllInOnePhase('pronunciation');
    return;
  }

  startPronDrillInAllInOne(card);
}

/**
 * Run pronunciation drill inside allInOneContainer
 */
function startPronDrillInAllInOne(card) {
  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;
  const savedReps = card.completedRepetitionsToday || 0;
  const startingRep = savedReps + 1;

  allInOnePronState = {
    cardId: card.id,
    card: card,
    currentWordIndex: 0,
    currentRepetition: startingRep,
    totalRepetitions: card.requiredRepetitions || 1,
    words: shuffleArray([...card.drillWords]),
    correctInRep: 0,
    totalCorrect: 0,
    totalAttempts: 0,
    recognition: null,
    isListening: false
  };

  const container = document.getElementById('allInOneContainer');
  container.innerHTML = `
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 20px;">
        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 20px;">
           ${card.topic}
        </span>
        <div style="margin-top: 15px;">
          <span style="background: #fef3c7; color: #92400e; padding: 8px 16px; border-radius: 12px; font-weight: 600;">
             Day ${currentDay} of ${totalDays}
          </span>
        </div>
        <p style="color: #718096; margin-top: 10px;">
          ${allInOnePronState.totalRepetitions} through all words today
        </p>
      </div>

      <div id="allInOnePronInterface" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center; margin-bottom: 20px;">
          <span style="color: #718096; font-size: 14px;">
            Rep <span id="aioCurrentRep">${startingRep}</span> of ${allInOnePronState.totalRepetitions} |
            Word <span id="aioCurrentWord">1</span> of ${card.drillWords.length}
          </span>
        </div>

        <div id="aioWordDisplay" style="text-align: center; padding: 30px; background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%); border-radius: 12px; margin-bottom: 20px;">
          <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">Say this word:</div>
          <div id="aioTargetWord" style="font-size: 36px; font-weight: bold; color: #2d3748;">${allInOnePronState.words[0]}</div>
        </div>

        <div id="aioListeningStatus" style="text-align: center; margin-bottom: 20px;">
          <div id="aioListeningIndicator" style="display: none;">
            <div style="width: 60px; height: 60px; background: #48bb78; border-radius: 50%; margin: 0 auto 10px; animation: pulse 1.5s infinite;"></div>
            <span style="color: #48bb78; font-weight: 600;"> Listening...</span>
          </div>
          <div id="aioRecognizedText" style="font-size: 20px; color: #667eea; font-weight: 600; min-height: 30px;"></div>
        </div>

        <div id="aioFeedback" style="display: none; text-align: center; padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>

        <div style="display: flex; gap: 10px; justify-content: center;">
          <button id="aioStartBtn" onclick="startAllInOnePronListening()" style="padding: 12px 30px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Start Speaking
          </button>
          <button onclick="skipAllInOnePronWord()" style="padding: 12px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
            Skip
          </button>
        </div>
      </div>
    </div>
  `;
}

let allInOnePronState = null;

function startAllInOnePronListening() {
  if (!allInOnePronState) return;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Speech recognition not supported in this browser');
    return;
  }

  allInOnePronState.recognition = new SpeechRecognition();
  allInOnePronState.recognition.lang = 'ko-KR';
  allInOnePronState.recognition.continuous = false;
  allInOnePronState.recognition.interimResults = true;

  allInOnePronState.recognition.onresult = (event) => {
    let transcript = '';
    for (let i = 0; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    document.getElementById('aioRecognizedText').textContent = transcript;

    if (event.results[0].isFinal) {
      checkAllInOnePronAnswer(transcript);
    }
  };

  allInOnePronState.recognition.onerror = (e) => {
    if (e.error !== 'no-speech') {
      document.getElementById('aioListeningIndicator').style.display = 'none';
    }
  };

  allInOnePronState.recognition.onend = () => {
    allInOnePronState.isListening = false;
    document.getElementById('aioListeningIndicator').style.display = 'none';
    document.getElementById('aioStartBtn').textContent = ' Start Speaking';
  };

  allInOnePronState.recognition.start();
  allInOnePronState.isListening = true;
  document.getElementById('aioListeningIndicator').style.display = 'block';
  document.getElementById('aioStartBtn').textContent = ' Stop';
  document.getElementById('aioRecognizedText').textContent = '';
}

function checkAllInOnePronAnswer(transcript) {
  const target = allInOnePronState.words[allInOnePronState.currentWordIndex];
  const normalized = normalizeKoreanForVoice(transcript);
  const targetNorm = normalizeKoreanForVoice(target);

  const similarity = calculateSimilarity(normalized, targetNorm);
  const isCorrect = similarity >= 0.90;

  allInOnePronState.totalAttempts++;

  const feedback = document.getElementById('aioFeedback');
  feedback.style.display = 'block';

  if (isCorrect) {
    allInOnePronState.correctInRep++;
    allInOnePronState.totalCorrect++;
    feedback.style.background = 'linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%)';
    feedback.innerHTML = `<span style="color: #276749; font-weight: 600;"> Correct!</span>`;
    awardCoinsWithPopup(swipeMode.enabled ? 1 : 3);
  } else {
    feedback.style.background = 'linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%)';
    feedback.innerHTML = `<span style="color: #c53030; font-weight: 600;"> Try again - Target: ${target}</span>`;
  }

  setTimeout(() => {
    feedback.style.display = 'none';
    if (isCorrect) {
      advanceAllInOnePronWord();
    }
  }, 1500);
}

function skipAllInOnePronWord() {
  if (allInOnePronState.recognition) {
    try { allInOnePronState.recognition.stop(); } catch(e) {}
  }
  advanceAllInOnePronWord();
}

function advanceAllInOnePronWord() {
  allInOnePronState.currentWordIndex++;

  if (allInOnePronState.currentWordIndex >= allInOnePronState.words.length) {
    allInOnePronState.currentWordIndex = 0;
    allInOnePronState.currentRepetition++;
    allInOnePronState.words = shuffleArray([...allInOnePronState.card.drillWords]);

    if (allInOnePronState.currentRepetition > allInOnePronState.totalRepetitions) {
      completeAllInOnePronDrill();
      return;
    }

    document.getElementById('aioCurrentRep').textContent = allInOnePronState.currentRepetition;
  }

  document.getElementById('aioCurrentWord').textContent = allInOnePronState.currentWordIndex + 1;
  document.getElementById('aioTargetWord').textContent = allInOnePronState.words[allInOnePronState.currentWordIndex];
  document.getElementById('aioRecognizedText').textContent = '';
}

async function completeAllInOnePronDrill() {
  const card = allInOnePronState.card;

  card.completedRepetitionsToday = allInOnePronState.totalRepetitions;
  card.completedToday = true;
  card.lastPracticeDate = new Date().toISOString().split('T')[0];

  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;
  const completedDay = currentDay < totalDays;

  if (completedDay) {
    card.currentDay = currentDay + 1;
  }

  if (card.currentDay > totalDays) {
    card.isComplete = true;
  }

  try {
    await db.collection('pronunciationLeitner').doc(card.id).update({
      completedToday: true,
      completedRepetitionsToday: allInOnePronState.totalRepetitions,
      lastPracticeDate: card.lastPracticeDate,
      currentDay: card.currentDay,
      isComplete: card.isComplete || false
    });
  } catch(e) {}

  awardCoins(20, 'Pronunciation Drill');

  const idx = pronDrillDueCards.findIndex(c => c.id === card.id);
  if (idx > -1) pronDrillDueCards.splice(idx, 1);

  if (pronDrillDueCards.length > 0) {
    const nextCard = pronunciationDrillCards.find(c => c.id === pronDrillDueCards[0].id);
    if (nextCard) {
      const container = document.getElementById('allInOneContainer');
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 60px; margin-bottom: 20px;"></div>
          <h3 style="color: #276749; margin-bottom: 10px;">Drill Complete!</h3>
          <p style="color: #718096; margin-bottom: 20px;">${pronDrillDueCards.length} more pronunciation drill${pronDrillDueCards.length !== 1 ? 's' : ''} to go</p>
          <button onclick="startPronDrillInAllInOne(pronunciationDrillCards.find(c => c.id === '${nextCard.id}'))" style="padding: 15px 30px; background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
            Continue to Next Drill
          </button>
        </div>
      `;
      return;
    }
  }

  completeAllInOnePhase('pronunciation');
}

/**
 * Start grammar review for all-in-one session
 */
function startGrammarReviewForAllInOne() {
  if (grammarDueCards.length === 0) {
    completeAllInOnePhase('grammar');
    return;
  }

  window.allInOneGrammarCallback = true;

  const card = grammarDueCards[0];
  startGrammarDrillInAllInOne(card);
}

/**
 * Run grammar drill inside allInOneContainer
 */
function startGrammarDrillInAllInOne(card) {
  allInOneGrammarState = {
    card: card,
    currentSentenceIndex: 0,
    sentences: shuffleArray([...(card.sentences || [])]),
    correctCount: 0,
    totalAttempts: 0,
    recognition: null
  };

  if (allInOneGrammarState.sentences.length === 0) {
    completeAllInOnePhase('grammar');
    return;
  }

  renderAllInOneGrammarCard();
}

let allInOneGrammarState = null;

function renderAllInOneGrammarCard() {
  const state = allInOneGrammarState;
  const sentence = state.sentences[state.currentSentenceIndex];

  const container = document.getElementById('allInOneContainer');
  container.innerHTML = `
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 20px;">
        <span style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 20px;">
           ${state.card.topic}
        </span>
        <p style="color: #718096; margin-top: 10px;">
          Sentence ${state.currentSentenceIndex + 1} of ${state.sentences.length}
        </p>
      </div>

      <div style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border-radius: 12px; margin-bottom: 20px;">
          <div style="font-size: 14px; color: #718096; margin-bottom: 10px;">Say this sentence:</div>
          <div style="font-size: 24px; font-weight: bold; color: #2d3748;">${sentence}</div>
        </div>

        <div id="aioGrammarListening" style="text-align: center; margin-bottom: 20px;">
          <div id="aioGrammarIndicator" style="display: none;">
            <div style="width: 60px; height: 60px; background: #48bb78; border-radius: 50%; margin: 0 auto 10px; animation: pulse 1.5s infinite;"></div>
            <span style="color: #48bb78; font-weight: 600;"> Listening...</span>
          </div>
          <div id="aioGrammarRecognized" style="font-size: 18px; color: #667eea; font-weight: 600; min-height: 30px;"></div>
        </div>

        <div id="aioGrammarFeedback" style="display: none; text-align: center; padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>

        <div style="display: flex; gap: 10px; justify-content: center;">
          <button id="aioGrammarStartBtn" onclick="startAllInOneGrammarListening()" style="padding: 12px 30px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Start Speaking
          </button>
          <button onclick="skipAllInOneGrammarSentence()" style="padding: 12px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
            Skip
          </button>
        </div>
      </div>
    </div>
  `;
}

function startAllInOneGrammarListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return;

  allInOneGrammarState.recognition = new SpeechRecognition();
  allInOneGrammarState.recognition.lang = 'ko-KR';
  allInOneGrammarState.recognition.continuous = false;
  allInOneGrammarState.recognition.interimResults = true;

  allInOneGrammarState.recognition.onresult = (event) => {
    let transcript = '';
    for (let i = 0; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    document.getElementById('aioGrammarRecognized').textContent = transcript;

    if (event.results[0].isFinal) {
      checkAllInOneGrammarAnswer(transcript);
    }
  };

  allInOneGrammarState.recognition.onend = () => {
    document.getElementById('aioGrammarIndicator').style.display = 'none';
    document.getElementById('aioGrammarStartBtn').textContent = ' Start Speaking';
  };

  allInOneGrammarState.recognition.start();
  document.getElementById('aioGrammarIndicator').style.display = 'block';
  document.getElementById('aioGrammarStartBtn').textContent = ' Stop';
}

function checkAllInOneGrammarAnswer(transcript) {
  const target = allInOneGrammarState.sentences[allInOneGrammarState.currentSentenceIndex];
  const normalized = transcript.replace(/\s+/g, '').toLowerCase();
  const targetNorm = target.replace(/\s+/g, '').toLowerCase();

  const similarity = 1 - (levenshteinDistance(normalized, targetNorm) / Math.max(normalized.length, targetNorm.length));
  const isCorrect = similarity >= 0.7;

  allInOneGrammarState.totalAttempts++;

  const feedback = document.getElementById('aioGrammarFeedback');
  feedback.style.display = 'block';

  if (isCorrect) {
    allInOneGrammarState.correctCount++;
    feedback.style.background = 'linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%)';
    feedback.innerHTML = `<span style="color: #276749; font-weight: 600;"> Correct!</span>`;
    awardCoinsWithPopup(swipeMode.enabled ? 1 : 3);
  } else {
    feedback.style.background = 'linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%)';
    feedback.innerHTML = `<span style="color: #c53030; font-weight: 600;"> Try again</span>`;
  }

  setTimeout(() => {
    feedback.style.display = 'none';
    if (isCorrect) {
      advanceAllInOneGrammarSentence();
    }
  }, 1500);
}

function skipAllInOneGrammarSentence() {
  if (allInOneGrammarState.recognition) {
    try { allInOneGrammarState.recognition.stop(); } catch(e) {}
  }
  advanceAllInOneGrammarSentence();
}

function advanceAllInOneGrammarSentence() {
  allInOneGrammarState.currentSentenceIndex++;

  if (allInOneGrammarState.currentSentenceIndex >= allInOneGrammarState.sentences.length) {
    completeAllInOneGrammarDrill();
    return;
  }

  renderAllInOneGrammarCard();
}

async function completeAllInOneGrammarDrill() {
  const card = allInOneGrammarState.card;

  card.completedToday = true;
  card.lastReviewDate = new Date().toISOString().split('T')[0];

  try {
    await db.collection('grammarLeitner').doc(card.id).update({
      completedToday: true,
      lastReviewDate: card.lastReviewDate
    });
  } catch(e) {}

  awardCoins(20, 'Grammar Drill');

  const idx = grammarDueCards.findIndex(c => c.id === card.id);
  if (idx > -1) grammarDueCards.splice(idx, 1);

  if (grammarDueCards.length > 0) {
    const nextCard = grammarDueCards[0];
    const container = document.getElementById('allInOneContainer');
    container.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 60px; margin-bottom: 20px;"></div>
        <h3 style="color: #276749; margin-bottom: 10px;">Grammar Drill Complete!</h3>
        <p style="color: #718096; margin-bottom: 20px;">${grammarDueCards.length} more grammar drill${grammarDueCards.length !== 1 ? 's' : ''} to go</p>
        <button onclick="startGrammarDrillInAllInOne(grammarDueCards[0])" style="padding: 15px 30px; background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
          Continue to Next Drill
        </button>
      </div>
    `;
    return;
  }

  completeAllInOnePhase('grammar');
}

/**
 * Start flashcard review for all-in-one session
 */
function startFlashcardReviewForAllInOne() {
  if (leitnerDueCards.length === 0) {
    completeAllInOnePhase('flashcard');
    return;
  }

  window.allInOneFlashcardCallback = true;

  allInOneFlashcardState = {
    queue: shuffleArray([...leitnerDueCards]),
    currentIndex: 0,
    correct: 0,
    incorrect: 0,
    recognition: null
  };

  renderAllInOneFlashcard();
}

let allInOneFlashcardState = null;

function renderAllInOneFlashcard() {
  const state = allInOneFlashcardState;

  if (state.currentIndex >= state.queue.length) {
    completeAllInOneFlashcardSession();
    return;
  }

  const card = state.queue[state.currentIndex];

  const container = document.getElementById('allInOneContainer');
  container.innerHTML = `
    <div style="max-width: 550px; margin: 0 auto; padding: 20px;">
      <div style="text-align: center; margin-bottom: 15px;">
        <span style="color: #718096; font-size: 16px;">${state.currentIndex + 1} / ${state.queue.length}</span>
        <span style="margin-left: 15px; background: #f7fafc; padding: 6px 14px; border-radius: 20px; font-size: 14px; color: #4a5568;">
           ${LEITNER_BOX_NAMES[card.box] || 'Day ' + card.box}
        </span>
      </div>

      <div id="aioFlashcard" style="background: white; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.12); cursor: pointer; min-height: 200px; display: flex; flex-direction: column; justify-content: center;" onclick="flipAllInOneFlashcard()">
        <div id="aioFlashcardFront">
          <div style="font-size: 14px; color: #718096; margin-bottom: 15px;"> Say this in Korean:</div>
          <div style="font-size: 32px; font-weight: bold; color: #2d3748;">${card.english}</div>
        </div>
        <div id="aioFlashcardBack" style="display: none;">
          <div style="font-size: 14px; color: #718096; margin-bottom: 15px;">Answer:</div>
          <div style="font-size: 36px; font-weight: bold; color: #667eea;">${card.korean}</div>
        </div>
      </div>

      <div id="aioFlashcardListening" style="text-align: center; margin: 20px 0;">
        <div id="aioFlashcardIndicator" style="display: none;">
          <div style="width: 50px; height: 50px; background: #48bb78; border-radius: 50%; margin: 0 auto 10px; animation: pulse 1.5s infinite;"></div>
          <span style="color: #48bb78; font-size: 14px;"> Listening...</span>
        </div>
        <div id="aioFlashcardRecognized" style="font-size: 18px; color: #2d3748; font-weight: 600; min-height: 25px;"></div>
      </div>

      <div id="aioFlashcardButtons" style="display: none; text-align: center; margin-top: 20px;">
        <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">Did you get it right?</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button onclick="submitAllInOneFlashcard(true)" style="flex: 1; max-width: 140px; padding: 15px 20px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Correct
          </button>
          <button onclick="submitAllInOneFlashcard(false)" style="flex: 1; max-width: 140px; padding: 15px 20px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
             Wrong
          </button>
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button id="aioFlashcardStartBtn" onclick="startAllInOneFlashcardListening()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;">
           Start
        </button>
        <button onclick="flipAllInOneFlashcard()" style="padding: 12px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
           Reveal
        </button>
      </div>
    </div>
  `;
}

function flipAllInOneFlashcard() {
  document.getElementById('aioFlashcardFront').style.display = 'none';
  document.getElementById('aioFlashcardBack').style.display = 'block';
  document.getElementById('aioFlashcardButtons').style.display = 'block';

  if (allInOneFlashcardState.recognition) {
    try { allInOneFlashcardState.recognition.stop(); } catch(e) {}
  }
  document.getElementById('aioFlashcardIndicator').style.display = 'none';
}

function startAllInOneFlashcardListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return;

  allInOneFlashcardState.recognition = new SpeechRecognition();
  allInOneFlashcardState.recognition.lang = 'ko-KR';
  allInOneFlashcardState.recognition.continuous = false;
  allInOneFlashcardState.recognition.interimResults = true;

  const card = allInOneFlashcardState.queue[allInOneFlashcardState.currentIndex];

  allInOneFlashcardState.recognition.onresult = (event) => {
    let transcript = '';
    for (let i = 0; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    document.getElementById('aioFlashcardRecognized').textContent = transcript;

    if (event.results[0].isFinal) {
      const normalized = normalizeKoreanForVoice(transcript);
      const targetNorm = normalizeKoreanForVoice(card.korean);
      const similarity = calculateSimilarity(normalized, targetNorm);

      if (similarity >= 0.90) {
        awardCoinsWithPopup(swipeMode.enabled ? 1 : 5);
        submitAllInOneFlashcard(true);
      } else {
        flipAllInOneFlashcard();
      }
    }
  };

  allInOneFlashcardState.recognition.onend = () => {
    document.getElementById('aioFlashcardIndicator').style.display = 'none';
    document.getElementById('aioFlashcardStartBtn').textContent = ' Start';
  };

  allInOneFlashcardState.recognition.start();
  document.getElementById('aioFlashcardIndicator').style.display = 'block';
  document.getElementById('aioFlashcardStartBtn').textContent = ' Stop';
}

async function submitAllInOneFlashcard(isCorrect) {
  const state = allInOneFlashcardState;
  const card = state.queue[state.currentIndex];

  if (isCorrect) {
    state.correct++;
    if (!swipeMode.enabled) awardCoinsWithPopup(5);
    else awardCoinsWithPopup(1);
  } else {
    state.incorrect++;
  }

  await handleLeitnerReview(card.id, isCorrect);

  state.currentIndex++;
  renderAllInOneFlashcard();
}

async function completeAllInOneFlashcardSession() {
  const state = allInOneFlashcardState;

  awardCoins(20, 'Flashcard Drill');
  if (state.correct > 0 && state.incorrect === 0) {
    awardCoins(20, 'Perfect Flashcard Session');
  }

  const container = document.getElementById('allInOneContainer');
  container.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="font-size: 60px; margin-bottom: 20px;"></div>
      <h3 style="color: #276749; margin-bottom: 10px;">Flashcard Review Complete!</h3>
      <div style="margin-bottom: 20px;">
        <span style="color: #48bb78; font-weight: 600;">${state.correct} Correct</span> |
        <span style="color: #f56565; font-weight: 600;">${state.incorrect} Incorrect</span>
      </div>
      <button onclick="completeAllInOnePhase('flashcard')" style="padding: 15px 30px; background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
        Continue
      </button>
    </div>
  `;
}

/**
 * Complete a phase and move to the next
 */
function completeAllInOnePhase(phase) {
  if (!allInOneState.isActive) return;

  allInOneState.completedPhases.push(phase);
  
  if (typeof trackDailyProgress === 'function') {
    trackDailyProgress('activity', 1);
  }

  allInOneState.currentPhaseIndex++;
  let nextPhase = null;

  while (allInOneState.currentPhaseIndex < allInOneState.phaseOrder.length) {
    const candidate = allInOneState.phaseOrder[allInOneState.currentPhaseIndex];
    if (allInOneState.stats[candidate].total > 0) {
      nextPhase = candidate;
      break;
    }
    allInOneState.completedPhases.push(candidate);
    allInOneState.currentPhaseIndex++;
  }

  switchTab('allInOne');

  if (nextPhase) {
    allInOneState.currentPhase = nextPhase;
    startAllInOnePhase(nextPhase);
  } else {
    showAllInOneCompletion();
  }
}

/**
 * Check if we should return to all-in-one after completing a drill
 */
function checkAllInOneReturn() {
  if (!allInOneState.isActive) return false;

  const phase = allInOneState.currentPhase;

  let phaseDone = false;
  if (phase === 'pronunciation' && pronDrillDueCards.length === 0) {
    phaseDone = true;
  } else if (phase === 'grammar' && grammarDueCards.length === 0) {
    phaseDone = true;
  } else if (phase === 'flashcard' && leitnerDueCards.length === 0) {
    phaseDone = true;
  }

  if (phaseDone) {
    completeAllInOnePhase(phase);
    return true;
  }

  return false;
}

/**
 * Show completion screen for all-in-one session
 */
function showAllInOneCompletion() {
  const container = document.getElementById('allInOneContainer');

  const totalItems = allInOneState.stats.pronunciation.total +
                     allInOneState.stats.grammar.total +
                     allInOneState.stats.flashcard.total;

  container.innerHTML = `
    <div style="text-align: center; padding: 60px 20px;">
      <div style="font-size: 120px; margin-bottom: 20px;"></div>
      <h1 style="color: #276749; margin-bottom: 15px; font-size: 36px;"> !</h1>
      <h2 style="color: #2f855a; margin-bottom: 30px;">Session Complete!</h2>

      <div style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #48bb78; border-radius: 20px; padding: 30px; max-width: 500px; margin: 0 auto 30px auto;">
        <div style="font-size: 50px; font-weight: bold; color: #276749; margin-bottom: 10px;">${totalItems}</div>
        <div style="color: #2f855a; font-size: 18px;">Items Completed!</div>

        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 25px;">
          ${allInOneState.stats.pronunciation.total > 0 ? `
            <div style="text-align: center;">
              <div style="font-size: 30px;"></div>
              <div style="font-weight: bold; color: #553c9a;">${allInOneState.stats.pronunciation.total}</div>
              <div style="font-size: 12px; color: #805ad5;">Pronunciation</div>
            </div>
          ` : ''}
          ${allInOneState.stats.grammar.total > 0 ? `
            <div style="text-align: center;">
              <div style="font-size: 30px;"></div>
              <div style="font-weight: bold; color: #276749;">${allInOneState.stats.grammar.total}</div>
              <div style="font-size: 12px; color: #2f855a;">Grammar</div>
            </div>
          ` : ''}
          ${allInOneState.stats.flashcard.total > 0 ? `
            <div style="text-align: center;">
              <div style="font-size: 30px;"></div>
              <div style="font-weight: bold; color: #c05621;">${allInOneState.stats.flashcard.total}</div>
              <div style="font-size: 12px; color: #dd6b20;">Flashcards</div>
            </div>
          ` : ''}
        </div>
      </div>

      <p style="color: #718096; font-size: 16px; margin-bottom: 25px;">
        Excellent work! You've completed all your daily practice in one session.
      </p>

      <button onclick="allInOneState.isActive = false; renderAllInOneDashboard();" class="btn" style="background: #48bb78; padding: 12px 30px;">
         Back to Dashboard
      </button>
    </div>
  `;

  allInOneState.isActive = false;

  updateAllInOneBadge();
}

/**
 * Cancel all-in-one session and return to dashboard
 */
function cancelAllInOneSession() {
  allInOneState.isActive = false;
  window.allInOnePronCallback = false;
  window.allInOneGrammarCallback = false;
  window.allInOneFlashcardCallback = false;
  switchTab('allInOne');
  renderAllInOneDashboard();
}

/**
 * Start next grammar drill in all-in-one mode
 */
function startNextGrammarDrillForAllInOne() {
  if (grammarDueCards.length === 0) {
    completeAllInOnePhase('grammar');
    return;
  }

  const nextCard = grammarDueCards[0];
  startGrammarDrill(nextCard.id);
}

/**
 * Start next flashcard in all-in-one mode
 */
function startNextFlashcardForAllInOne() {
  if (leitnerDueCards.length === 0) {
    completeAllInOnePhase('flashcard');
    return;
  }

  renderLeitnerDailyReview();
}


let currentPronCalendarMonth = new Date().getMonth();
let currentPronCalendarYear = new Date().getFullYear();
let pronDrillHistory = [];
let pronSubmissions = []; // Store student's pronunciation submissions for calendar

/**
 * Switch between pronunciation drill views
 */
function switchPronDrillView(view) {
  const drillsBtn = document.getElementById('pronDrillsViewBtn');
  const calendarBtn = document.getElementById('pronCalendarViewBtn');
  const statsBtn = document.getElementById('pronStatsViewBtn');
  const availableTestsBtn = document.getElementById('pronAvailableTestsViewBtn');
  const drillsContainer = document.getElementById('pronunciationDrillsContainer');
  const calendarContainer = document.getElementById('pronunciationCalendarContainer');
  const statsContainer = document.getElementById('pronunciationStatsContainer');
  const availableTestsContainer = document.getElementById('pronunciationAvailableTestsContainer');

  [drillsBtn, calendarBtn, statsBtn, availableTestsBtn].forEach(btn => {
    if (btn) {
      btn.style.background = '#e2e8f0';
      btn.style.color = '#4a5568';
    }
  });

  if (drillsContainer) drillsContainer.style.display = 'none';
  if (calendarContainer) calendarContainer.style.display = 'none';
  if (statsContainer) statsContainer.style.display = 'none';
  if (availableTestsContainer) availableTestsContainer.style.display = 'none';

  if (view === 'drills') {
    drillsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    drillsBtn.style.color = 'white';
    drillsContainer.style.display = 'block';
  } else if (view === 'calendar') {
    calendarBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    calendarBtn.style.color = 'white';
    calendarContainer.style.display = 'block';
    renderPronunciationCalendar();
  } else if (view === 'stats') {
    statsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    statsBtn.style.color = 'white';
    statsContainer.style.display = 'block';
    renderPronunciationStats();
  } else if (view === 'availableTests') {
    availableTestsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    availableTestsBtn.style.color = 'white';
    availableTestsContainer.style.display = 'block';
    loadAvailableTests2InPronDrills();
  }
}

/**
 * Switch Grammar Drill View (Active Drills, Calendar, Stats, Available Tests, Grammar Mastery)
 */
function switchGrammarDrillView(view) {
  const drillsBtn = document.getElementById('grammarDrillsViewBtn');
  const calendarBtn = document.getElementById('grammarCalendarViewBtn');
  const statsBtn = document.getElementById('grammarStatsViewBtn');
  const availableTestsBtn = document.getElementById('grammarAvailableTestsViewBtn');
  const masteryBtn = document.getElementById('grammarMasteryViewBtn');

  const drillsContainer = document.getElementById('grammarDrillsContainer');
  const calendarContainer = document.getElementById('grammarCalendarContainer');
  const statsContainer = document.getElementById('grammarStatsContainer');
  const availableTestsContainer = document.getElementById('grammarAvailableTestsContainer');
  const masteryContainer = document.getElementById('grammarMasteryContainer2');

  [drillsBtn, calendarBtn, statsBtn, availableTestsBtn, masteryBtn].forEach(btn => {
    if (btn) {
      btn.style.background = '#e2e8f0';
      btn.style.color = '#4a5568';
    }
  });

  if (drillsContainer) drillsContainer.style.display = 'none';
  if (calendarContainer) calendarContainer.style.display = 'none';
  if (statsContainer) statsContainer.style.display = 'none';
  if (availableTestsContainer) availableTestsContainer.style.display = 'none';
  if (masteryContainer) masteryContainer.style.display = 'none';

  if (view === 'drills') {
    drillsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    drillsBtn.style.color = 'white';
    drillsContainer.style.display = 'block';
    renderGrammarActiveDrills();
  } else if (view === 'calendar') {
    calendarBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    calendarBtn.style.color = 'white';
    calendarContainer.style.display = 'block';
    renderGrammarCalendarView();
  } else if (view === 'stats') {
    statsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    statsBtn.style.color = 'white';
    statsContainer.style.display = 'block';
    renderGrammarStatsView();
  } else if (view === 'availableTests') {
    availableTestsBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    availableTestsBtn.style.color = 'white';
    availableTestsContainer.style.display = 'block';
    loadGrammarAvailableTests();
  } else if (view === 'mastery') {
    masteryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    masteryBtn.style.color = 'white';
    masteryContainer.style.display = 'block';
    renderGrammarMasteryView();
  }
}

let currentGrammarCalendarYear = new Date().getFullYear();
let currentGrammarCalendarMonth = new Date().getMonth();
let grammarSubmissionsHistory = [];

/**
 * Render Grammar Active Drills (with teacher feedback video)
 */
async function renderGrammarActiveDrills() {
  const container = document.getElementById('grammarDrillsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    await loadGrammarLeitnerCards();

    let latestFeedback = null;
    try {
      const feedbackSnapshot = await db.collection('submissions')
        .where('studentId', '==', currentUser.uid)
        .where('status', '==', 'graded')
        .orderBy('gradedAt', 'desc')
        .limit(1)
        .get();

      if (!feedbackSnapshot.empty) {
        latestFeedback = feedbackSnapshot.docs[0].data();
      }
    } catch (e) {
    }

    let feedbackVideoHtml = '';
    if (latestFeedback && latestFeedback.videoFeedbackUrl) {
      feedbackVideoHtml = `
        <div style="background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #48bb78;">
          <h3 style="color: #276749; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
             Latest Teacher Feedback
          </h3>
          <video controls style="width: 100%; max-width: 500px; border-radius: 8px; border: 2px solid #48bb78;">
            <source src="${latestFeedback.videoFeedbackUrl}" type="video/webm">
            <source src="${latestFeedback.videoFeedbackUrl}" type="video/mp4">
          </video>
          <p style="color: #2f855a; font-size: 13px; margin-top: 10px;">
            From: ${latestFeedback.testTitle || 'Grammar Test'} 
            Graded: ${latestFeedback.gradedAt ? (latestFeedback.gradedAt.toDate ? latestFeedback.gradedAt.toDate().toLocaleDateString() : new Date(latestFeedback.gradedAt).toLocaleDateString()) : 'Recently'}
          </p>
        </div>
      `;
    }

    if (grammarLeitnerCards.length === 0) {
      container.innerHTML = `
        ${feedbackVideoHtml}
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Grammar Drills Yet</h3>
          <p style="color: #718096; margin-bottom: 20px;">
            Complete grammar tests to receive feedback and drills from your teacher.
          </p>
          <button onclick="switchGrammarDrillView('availableTests')" class="btn" style="padding: 12px 24px;">
             View Available Tests
          </button>
        </div>
      `;
      return;
    }

    const totalCards = grammarLeitnerCards.length;
    const dueCards = grammarDueCards.length;
    const masteredCards = grammarLeitnerCards.filter(c => c.box >= 8);

    const cardsNeedingDrills = grammarLeitnerCards.filter(card => {
      if (card.box >= 8) return false;
      const todayStr = new Date().toDateString();
      const lastDrillDate = card.lastDrillDate ? (card.lastDrillDate.toDate ? card.lastDrillDate.toDate().toDateString() : new Date(card.lastDrillDate).toDateString()) : null;
      return lastDrillDate !== todayStr;
    });

    container.innerHTML = `
      ${feedbackVideoHtml}

      <!-- Stats Summary -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${totalCards}</div>
          <div style="font-size: 12px; opacity: 0.9;">Total Topics</div>
        </div>
        <div style="background: ${dueCards > 0 ? 'linear-gradient(135deg, #f56565 0%, #c53030 100%)' : 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)'}; padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${dueCards}</div>
          <div style="font-size: 12px; opacity: 0.9;">Due Today</div>
        </div>
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${cardsNeedingDrills.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">Need Drilling</div>
        </div>
        <div style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 28px; font-weight: bold;">${masteredCards.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">Mastered</div>
        </div>
      </div>

      ${dueCards > 0 ? `
        <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #f56565;">
          <h4 style="color: #c53030; margin: 0 0 10px 0;"> ${dueCards} Topic${dueCards > 1 ? 's' : ''} Due for Review!</h4>
          <p style="color: #742a2a; margin: 0 0 15px 0;">Complete your spaced repetition review to maintain progress.</p>
          <button onclick="startGrammarLeitnerReview()" class="btn" style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border: none; padding: 12px 24px;">
             Start Review Session
          </button>
        </div>
      ` : ''}

      <!-- Active Drill Cards -->
      <h3 style="color: #2d3748; margin-bottom: 15px;"> Your Grammar Topics</h3>
      <div style="display: grid; gap: 12px;">
        ${grammarLeitnerCards.filter(c => c.box < 8).slice(0, 10).map(card => {
          const todayStr = new Date().toDateString();
          const lastDrillDate = card.lastDrillDate ? (card.lastDrillDate.toDate ? card.lastDrillDate.toDate().toDateString() : new Date(card.lastDrillDate).toDateString()) : null;
          const drilledToday = lastDrillDate === todayStr;

          return `
            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid ${drilledToday ? '#48bb78' : '#e2e8f0'}; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-weight: 600; color: #2d3748;">${card.topic}</span>
                <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                  Box ${card.box}  Grade: ${card.grade}/10  Drills: ${card.drillCount || 0}
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                ${drilledToday ? `
                  <span style="background: #c6f6d5; color: #276749; padding: 4px 10px; border-radius: 15px; font-size: 12px;"> Done Today</span>
                ` : `
                  <button onclick="startGrammarDrill('${card.id}')" class="btn" style="padding: 8px 16px; font-size: 13px;">
                    Practice
                  </button>
                `}
              </div>
            </div>
          `;
        }).join('')}
        ${grammarLeitnerCards.filter(c => c.box < 8).length > 10 ? `
          <p style="color: #718096; text-align: center; font-size: 14px;">
            + ${grammarLeitnerCards.filter(c => c.box < 8).length - 10} more topics
          </p>
        ` : ''}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading drills: ${error.message}</p>`;
  }
}

/**
 * Start practicing a single grammar card
 */
async function startGrammarDrill(cardId) {
  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) {
    alert('Card not found');
    return;
  }

  const modalHtml = `
    <div id="grammarDrillModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                        background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                                        align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;
                    border-radius: 16px 16px 0 0; color: white; text-align: center;">
          <h3 style="margin: 0;"> Grammar Practice</h3>
          <p style="margin: 10px 0 0 0; opacity: 0.9;">${card.topic}</p>
        </div>
        <div style="padding: 30px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <p style="color: #4a5568; margin-bottom: 20px;">
            Practice this grammar topic. When you're confident you understand it, mark it as practiced.
          </p>

          <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
            <p style="color: #718096; font-size: 13px; margin: 0;">
              <strong>Topic:</strong> ${card.topic}<br>
              <strong>Current Box:</strong> Day ${card.box}<br>
              <strong>Original Grade:</strong> ${card.grade}/10<br>
              <strong>Times Drilled:</strong> ${card.drillCount || 0}
            </p>
          </div>

          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="completeGrammarDrillCard('${cardId}', true)" class="btn"
                    style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border: none; padding: 12px 24px;">
               I Know This
            </button>
            <button onclick="completeGrammarDrillCard('${cardId}', false)" class="btn"
                    style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border: none; padding: 12px 24px;">
               Need More Practice
            </button>
          </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #e2e8f0; text-align: center;">
          <button onclick="document.getElementById('grammarDrillModal').remove()" class="btn"
                  style="background: #e2e8f0; color: #4a5568;">
            Cancel
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Complete a grammar drill card (correct or incorrect)
 */
async function completeGrammarDrillCard(cardId, correct) {
  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) return;

  try {
    const todayStr = new Date().toISOString().split('T')[0];

    if (correct) {
      const newBox = Math.min(card.box + 1, 8);
      await db.collection('grammarLeitner').doc(cardId).update({
        box: newBox,
        drillCount: (card.drillCount || 0) + 1,
        lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
        lastDrillDateStr: todayStr,
        correctCount: (card.correctCount || 0) + 1
      });

      card.box = newBox;
      card.drillCount = (card.drillCount || 0) + 1;
      card.lastDrillDateStr = todayStr;

      if (newBox >= 8) {
        alert(` Congratulations! "${card.topic}" has been mastered!`);
      } else {
        alert(` Great! "${card.topic}" moved to Day ${newBox}`);
      }
    } else {
      await db.collection('grammarLeitner').doc(cardId).update({
        box: 1,
        drillCount: (card.drillCount || 0) + 1,
        lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
        lastDrillDateStr: todayStr,
        wrongCount: (card.wrongCount || 0) + 1
      });

      card.box = 1;
      card.drillCount = (card.drillCount || 0) + 1;
      card.lastDrillDateStr = todayStr;

      alert(` "${card.topic}" needs more practice. Back to Day 1.`);
    }

    document.getElementById('grammarDrillModal').remove();
    renderGrammarActiveDrills();

  } catch (error) {
    alert('Error saving progress: ' + error.message);
  }
}

/**
 * Start a grammar Leitner review session (for due cards)
 */
function startGrammarLeitnerReview() {
  const dueCards = grammarDueCards.filter(c => c.box > 1);

  if (dueCards.length === 0) {
    alert('No grammar cards due for review!');
    return;
  }

  window.currentGrammarReviewSession = {
    cards: [...dueCards],
    currentIndex: 0,
    correct: 0,
    incorrect: 0
  };

  showGrammarReviewCard();
}

/**
 * Show current grammar review card
 */
function showGrammarReviewCard() {
  const session = window.currentGrammarReviewSession;
  if (!session || session.currentIndex >= session.cards.length) {
    showGrammarReviewComplete();
    return;
  }

  const card = session.cards[session.currentIndex];
  const progress = `${session.currentIndex + 1}/${session.cards.length}`;

  const modalHtml = `
    <div id="grammarReviewModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                         background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                                         align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;
                    border-radius: 16px 16px 0 0; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;"> Grammar Review</h3>
            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 15px; font-size: 14px;">
              ${progress}
            </span>
          </div>
        </div>
        <div style="padding: 30px; text-align: center;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h2 style="color: #2d3748; margin: 0; font-size: 24px;">${card.topic}</h2>
            <p style="color: #718096; margin: 10px 0 0 0;">Day ${card.box}  Grade ${card.grade}/10</p>
          </div>

          <p style="color: #4a5568; margin-bottom: 20px;">
            Do you know this grammar topic?
          </p>

          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="answerGrammarReview(true)" class="btn"
                    style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border: none; padding: 15px 30px; font-size: 16px;">
               I Know It
            </button>
            <button onclick="answerGrammarReview(false)" class="btn"
                    style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border: none; padding: 15px 30px; font-size: 16px;">
               Need Practice
            </button>
          </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #e2e8f0; text-align: center;">
          <button onclick="cancelGrammarReview()" class="btn" style="background: #e2e8f0; color: #4a5568;">
            End Session
          </button>
        </div>
      </div>
    </div>
  `;

  const existingModal = document.getElementById('grammarReviewModal');
  if (existingModal) existingModal.remove();

  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Answer a grammar review card
 */
async function answerGrammarReview(correct) {
  const session = window.currentGrammarReviewSession;
  if (!session) return;

  const card = session.cards[session.currentIndex];
  const todayStr = new Date().toISOString().split('T')[0];

  try {
    if (correct) {
      session.correct++;
      const newBox = Math.min(card.box + 1, 8);
      await db.collection('grammarLeitner').doc(card.id).update({
        box: newBox,
        drillCount: (card.drillCount || 0) + 1,
        lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
        lastDrillDateStr: todayStr,
        correctCount: (card.correctCount || 0) + 1
      });
      card.box = newBox;
    } else {
      session.incorrect++;
      await db.collection('grammarLeitner').doc(card.id).update({
        box: 1,
        drillCount: (card.drillCount || 0) + 1,
        lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
        lastDrillDateStr: todayStr,
        wrongCount: (card.wrongCount || 0) + 1
      });
      card.box = 1;
    }

    session.currentIndex++;
    showGrammarReviewCard();

  } catch (error) {
    alert('Error saving: ' + error.message);
  }
}

/**
 * Show grammar review completion
 */
function showGrammarReviewComplete() {
  const session = window.currentGrammarReviewSession;

  awardCoins(20, 'Grammar Drill');
  recordPracticeActivity('grammar');

  if (session && session.incorrect === 0 && session.correct > 0) {
    awardCoins(20, 'Perfect Grammar Score');
  }

  const modalHtml = `
    <div id="grammarReviewModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                         background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                                         align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 30px;
                    border-radius: 16px 16px 0 0; color: white;">
          <div style="font-size: 64px; margin-bottom: 10px;"></div>
          <h2 style="margin: 0;">Review Complete!</h2>
        </div>
        <div style="padding: 30px;">
          <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 32px; font-weight: bold; color: #48bb78;">${session ? session.correct : 0}</div>
              <div style="color: #718096; font-size: 14px;">Correct</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 32px; font-weight: bold; color: #f56565;">${session ? session.incorrect : 0}</div>
              <div style="color: #718096; font-size: 14px;">Need Practice</div>
            </div>
          </div>
          <button onclick="closeGrammarReview()" class="btn"
                  style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px;">
            Done
          </button>
        </div>
      </div>
    </div>
  `;

  const existingModal = document.getElementById('grammarReviewModal');
  if (existingModal) existingModal.remove();

  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Cancel grammar review session
 */
function cancelGrammarReview() {
  window.currentGrammarReviewSession = null;
  const modal = document.getElementById('grammarReviewModal');
  if (modal) modal.remove();
  renderGrammarActiveDrills();
}

/**
 * Close grammar review and refresh
 */
function closeGrammarReview() {
  window.currentGrammarReviewSession = null;
  const modal = document.getElementById('grammarReviewModal');
  if (modal) modal.remove();
  loadGrammarLeitnerCards().then(() => {
    renderGrammarActiveDrills();
  });
}

/**
 * Render Grammar Calendar View (with submissions and feedback like pronunciation calendar)
 */
async function renderGrammarCalendarView() {
  const container = document.getElementById('grammarCalendarContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    await loadGrammarSubmissionsHistory();

    const year = currentGrammarCalendarYear;
    const month = currentGrammarCalendarMonth;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const totalDays = lastDay.getDate();

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    let daysHtml = '';

    for (let i = 0; i < startDayOfWeek; i++) {
      daysHtml += '<div style="padding: 10px; background: #f7fafc; border-radius: 8px;"></div>';
    }

    const today = new Date();

    for (let day = 1; day <= totalDays; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
      const isFuture = new Date(year, month, day) > today;

      const daySubmissions = grammarSubmissionsHistory.filter(sub => {
        const subDate = sub.submittedAt ? (sub.submittedAt.toDate ? sub.submittedAt.toDate() : new Date(sub.submittedAt)) : null;
        if (!subDate) return false;
        return subDate.getFullYear() === year && subDate.getMonth() === month && subDate.getDate() === day;
      });

      const hasSubmission = daySubmissions.length > 0;

      let bgStyle = 'background: #f7fafc;';
      let borderStyle = 'border: 2px solid #e2e8f0;';

      if (isFuture) {
        bgStyle = 'background: #f7fafc; opacity: 0.5;';
      }

      if (isToday) {
        borderStyle = 'border: 3px solid #667eea; box-shadow: 0 0 0 2px #667eea40;';
      }

      let submissionBadges = '';
      if (daySubmissions.length > 0) {
        daySubmissions.forEach(sub => {
          const isGraded = sub.status === 'graded';
          const bgColor = isGraded ? '#48bb78' : '#fbbf24';
          const label = isGraded ? ' Graded' : ' Pending';
          submissionBadges += `
            <div onclick="event.stopPropagation(); showGrammarSubmissionDetail('${sub.id}')"
                 style="background: ${bgColor}; color: #000; font-size: 8px; padding: 2px 4px;
                        border-radius: 4px; margin-top: 2px; cursor: pointer; border: 1px solid #000;
                        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;"
                 title="${sub.testTitle || 'Grammar Test'} - ${label}">
              ${label}
            </div>
          `;
        });
      }

      daysHtml += `
        <div onclick="${hasSubmission ? `showGrammarDaySubmissions('${dateStr}')` : ''}"
             style="padding: 6px 4px; text-align: center; border-radius: 8px;
                    cursor: ${hasSubmission ? 'pointer' : 'default'};
                    min-height: ${hasSubmission ? '65px' : '45px'};
                    display: flex; flex-direction: column; justify-content: flex-start;
                    ${bgStyle} ${borderStyle} transition: transform 0.2s;"
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
          <div style="font-weight: ${isToday ? '700' : '500'}; font-size: 14px; color: #2d3748;">${day}</div>
          ${submissionBadges}
        </div>
      `;
    }

    const monthSubmissions = grammarSubmissionsHistory.filter(sub => {
      const subDate = sub.submittedAt ? (sub.submittedAt.toDate ? sub.submittedAt.toDate() : new Date(sub.submittedAt)) : null;
      if (!subDate) return false;
      return subDate.getFullYear() === year && subDate.getMonth() === month;
    });
    const gradedCount = monthSubmissions.filter(s => s.status === 'graded').length;
    const pendingCount = monthSubmissions.filter(s => s.status === 'submitted' || s.status === 'pending').length;


    let allSubmissionsHtml = '';
    if (grammarSubmissionsHistory.length > 0) {
      allSubmissionsHtml = `
        <div style="margin-top: 20px; background: #f7fafc; padding: 15px; border-radius: 12px; border: 2px solid #e2e8f0;">
          <h4 style="color: #4a5568; margin: 0 0 15px 0;"> All Your Submissions (${grammarSubmissionsHistory.length})</h4>
          <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
            ${grammarSubmissionsHistory.map(sub => {
              const subDate = sub.submittedAt ? (sub.submittedAt.toDate ? sub.submittedAt.toDate() : new Date(sub.submittedAt)) : null;
              const dateStr = subDate ? subDate.toLocaleDateString() : 'Unknown date';
              return `
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid ${sub.status === 'graded' ? '#48bb78' : '#f59e0b'}; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600; color: #2d3748;">${sub.testTitle || 'Grammar Test'}</span>
                    <div style="font-size: 12px; color: #718096;">${dateStr}</div>
                  </div>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-size: 12px; color: ${sub.status === 'graded' ? '#276749' : '#92400e'};">
                      ${sub.status === 'graded' ? ' Graded' : ' Pending'}
                    </span>
                    ${sub.status === 'graded' ? `
                      <button onclick="showGrammarSubmissionDetail('${sub.id}')" class="btn" style="padding: 6px 12px; font-size: 12px;">
                        View
                      </button>
                    ` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    container.innerHTML = `
      <!-- Calendar Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button onclick="changeGrammarCalendarMonth(-1)" class="btn" style="padding: 8px 16px;">
           Prev
        </button>
        <h3 style="margin: 0; color: #2d3748;">${monthNames[month]} ${year}</h3>
        <button onclick="changeGrammarCalendarMonth(1)" class="btn" style="padding: 8px 16px;">
          Next 
        </button>
      </div>

      <!-- Stats Summary -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 24px; font-weight: bold;">${monthSubmissions.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">Total Submissions</div>
        </div>
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 24px; font-weight: bold;">${gradedCount}</div>
          <div style="font-size: 12px; opacity: 0.9;">Graded</div>
        </div>
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 24px; font-weight: bold;">${pendingCount}</div>
          <div style="font-size: 12px; opacity: 0.9;">Pending</div>
        </div>
      </div>

      <!-- Submission Legend (matching pronunciation calendar style) -->
      <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; padding: 12px; background: #f7fafc; border-radius: 10px;">
        <span style="font-size: 12px; color: #4a5568; font-weight: 600;">Submissions:</span>
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="background: #fbbf24; color: #000; font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid #000;"> Pending</div>
          <span style="font-size: 12px; color: #4a5568;">Not graded yet</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <div style="background: #48bb78; color: #000; font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid #000;"> Graded</div>
          <span style="font-size: 12px; color: #4a5568;">Click to view feedback!</span>
        </div>
      </div>

      <!-- Calendar Grid -->
      <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <!-- Day Headers -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px;">
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Sun</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Mon</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Tue</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Wed</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Thu</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Fri</div>
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">Sat</div>
        </div>

        <!-- Calendar Days -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
          ${daysHtml}
        </div>
      </div>

      <!-- Submission Detail Area -->
      <div id="grammarDaySubmissionsDetail"></div>

      ${allSubmissionsHtml}
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading calendar: ${error.message}</p>`;
  }
}

/**
 * Load grammar submissions history
 */
async function loadGrammarSubmissionsHistory() {
  try {

    const snapshot = await db.collection('submissions')
      .where('studentId', '==', currentUser.uid)
      .get();


    grammarSubmissionsHistory = [];

    for (const doc of snapshot.docs) {
      const data = doc.data();

      let testTitle = data.testTitle || 'Grammar Test';
      if (!data.testTitle && data.testId) {
        try {
          const testDoc = await db.collection('tests').doc(data.testId).get();
          if (testDoc.exists) {
            testTitle = testDoc.data().title || 'Grammar Test';
          }
        } catch (e) {
        }
      }

      grammarSubmissionsHistory.push({
        id: doc.id,
        ...data,
        testTitle: testTitle
      });
    }

    grammarSubmissionsHistory.sort((a, b) => {
      const aTime = a.submittedAt ? (a.submittedAt.toDate ? a.submittedAt.toDate() : new Date(a.submittedAt)) : new Date(0);
      const bTime = b.submittedAt ? (b.submittedAt.toDate ? b.submittedAt.toDate() : new Date(b.submittedAt)) : new Date(0);
      return bTime - aTime;
    });


  } catch (error) {
    grammarSubmissionsHistory = [];
  }
}

/**
 * Change grammar calendar month
 */
function changeGrammarCalendarMonth(delta) {
  currentGrammarCalendarMonth += delta;

  if (currentGrammarCalendarMonth > 11) {
    currentGrammarCalendarMonth = 0;
    currentGrammarCalendarYear++;
  } else if (currentGrammarCalendarMonth < 0) {
    currentGrammarCalendarMonth = 11;
    currentGrammarCalendarYear--;
  }

  renderGrammarCalendarView();
}

/**
 * Show grammar submissions for a specific day
 */
function showGrammarDaySubmissions(dateStr) {
  const detailContainer = document.getElementById('grammarDaySubmissionsDetail');
  if (!detailContainer) return;

  const [year, month, day] = dateStr.split('-').map(Number);

  const daySubmissions = grammarSubmissionsHistory.filter(sub => {
    const subDate = sub.submittedAt ? (sub.submittedAt.toDate ? sub.submittedAt.toDate() : new Date(sub.submittedAt)) : null;
    if (!subDate) return false;
    return subDate.getFullYear() === year && subDate.getMonth() === month - 1 && subDate.getDate() === day;
  });

  if (daySubmissions.length === 0) {
    detailContainer.innerHTML = '';
    return;
  }

  const dateDisplay = new Date(year, month - 1, day).toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  detailContainer.innerHTML = `
    <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; margin-top: 20px;">
      <h4 style="color: #2d3748; margin: 0 0 5px 0;"> ${dateDisplay}</h4>
      <p style="color: #718096; font-size: 13px; margin: 0 0 15px 0;">Submissions: ${daySubmissions.length}</p>
      <div style="display: grid; gap: 12px;">
        ${daySubmissions.map(sub => `
          <div style="background: ${sub.status === 'graded' ? '#f0fff4' : '#fffbeb'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${sub.status === 'graded' ? '#48bb78' : '#f59e0b'};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <h5 style="margin: 0; color: #2d3748;">${sub.testTitle || 'Grammar Test'}</h5>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: ${sub.status === 'graded' ? '#276749' : '#92400e'};">
                  ${sub.status === 'graded' ? ' Graded - Click to view feedback!' : ' Pending - Not graded yet'}
                </p>
              </div>
              ${sub.overallScore !== undefined ? `
                <div style="background: ${sub.overallScore >= 70 ? '#48bb78' : sub.overallScore >= 50 ? '#ed8936' : '#f56565'}; color: white; padding: 8px 12px; border-radius: 8px; font-weight: bold;">
                  ${sub.overallScore}%
                </div>
              ` : ''}
            </div>
            ${sub.status === 'graded' ? `
              <button onclick="showGrammarSubmissionDetail('${sub.id}')" class="btn" style="padding: 10px 20px; font-size: 14px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border: none;">
                 View Feedback
              </button>
            ` : `
              <p style="color: #92400e; font-size: 12px; font-style: italic; margin: 0;">
                Your teacher will grade this submission soon.
              </p>
            `}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/**
 * Show grammar submission detail modal
 */
async function showGrammarSubmissionDetail(submissionId) {
  const submission = grammarSubmissionsHistory.find(s => s.id === submissionId);
  if (!submission) return;

  let feedbackHtml = '';

  if (submission.overallScore !== undefined) {
    const scoreColor = submission.overallScore >= 70 ? '#48bb78' : submission.overallScore >= 50 ? '#ed8936' : '#f56565';
    feedbackHtml += `
      <div style="text-align: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, ${scoreColor}20 0%, ${scoreColor}10 100%); border-radius: 12px; border: 2px solid ${scoreColor};">
        <div style="font-size: 48px; font-weight: bold; color: ${scoreColor};">${submission.overallScore}%</div>
        <div style="color: #4a5568; font-size: 14px;">Overall Score</div>
      </div>
    `;
  }

  if (submission.feedbackVideoUrl || submission.videoFeedbackUrl) {
    const videoUrl = submission.feedbackVideoUrl || submission.videoFeedbackUrl;
    feedbackHtml += `
      <div style="margin-bottom: 25px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; border: 2px solid #48bb78;">
        <h4 style="color: #276749; margin: 0 0 15px 0;"> Teacher Video Feedback</h4>
        <video controls style="width: 100%; max-width: 500px; border-radius: 8px; border: 2px solid #48bb78;">
          <source src="${videoUrl}" type="video/webm">
          <source src="${videoUrl}" type="video/mp4">
        </video>
      </div>
    `;
  }

  if (submission.grades) {
    const sortedGrades = Object.entries(submission.grades).sort((a, b) => a[1] - b[1]);
    feedbackHtml += `
      <div style="margin-bottom: 25px;">
        <h4 style="color: #2d3748; margin: 0 0 15px 0;"> Grades by Topic</h4>
        <div style="display: grid; gap: 10px;">
          ${sortedGrades.map(([topic, grade]) => {
            let displayTopic = topic;
            if (topic.includes('_')) {
              displayTopic = topic.split('_').slice(1).join('_');
            }

            return `
              <div style="background: ${grade < 5 ? '#fff5f5' : grade < 7 ? '#fffbeb' : '#f0fff4'}; padding: 12px 15px; border-radius: 8px; border-left: 4px solid ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #2d3748; font-weight: 500;">${displayTopic}</span>
                <span style="font-weight: bold; padding: 4px 12px; border-radius: 15px; background: ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; color: white; font-size: 14px;">${grade}/10</span>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  if (submission.feedbackNeeded && Object.keys(submission.feedbackNeeded).length > 0) {
    feedbackHtml += `
      <div style="margin-bottom: 25px;">
        <h4 style="color: #2d3748; margin: 0 0 15px 0;"> Areas to Review</h4>
        <div style="display: grid; gap: 12px;">
          ${Object.entries(submission.feedbackNeeded).map(([key, feedback]) => {
            let displayKey = key;
            if (key.includes('_')) {
              displayKey = key.split('_').slice(1).join('_');
            }

            if (feedback.type === 'video' && feedback.content) {
              let embedUrl = feedback.content;
              if (embedUrl.includes('youtube.com/watch')) {
                embedUrl = embedUrl.replace('watch?v=', 'embed/');
              } else if (embedUrl.includes('loom.com/share')) {
                embedUrl = embedUrl.replace('/share/', '/embed/');
              }

              return `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <h5 style="color: #4a5568; margin: 0 0 10px 0;">${displayKey}</h5>
                  <button onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.textContent = this.nextElementSibling.style.display === 'none' ? ' Watch Video ' : ' Hide Video '"
                          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px;">
                     Watch Video 
                  </button>
                  <div style="display: none; margin-top: 10px;">
                    <iframe src="${embedUrl}" width="100%" height="300" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
                  </div>
                </div>
              `;
            } else if (feedback.type === 'text' && feedback.content) {
              return `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <h5 style="color: #4a5568; margin: 0 0 8px 0;">${displayKey}</h5>
                  <p style="color: #2d3748; margin: 0; line-height: 1.6;">${feedback.content}</p>
                </div>
              `;
            }
            return '';
          }).join('')}
        </div>
      </div>
    `;
  }

  if (submission.teacherComments) {
    feedbackHtml += `
      <div style="background: #ebf8ff; border-left: 4px solid #4299e1; padding: 15px; border-radius: 8px;">
        <h4 style="color: #2b6cb0; margin: 0 0 10px 0;"> Teacher Comments</h4>
        <p style="color: #2d3748; line-height: 1.6; margin: 0;">${submission.teacherComments}</p>
      </div>
    `;
  }

  const submittedDate = submission.submittedAt ? (submission.submittedAt.toDate ? submission.submittedAt.toDate() : new Date(submission.submittedAt)) : null;
  const gradedDate = submission.gradedAt ? (submission.gradedAt.toDate ? submission.gradedAt.toDate() : new Date(submission.gradedAt)) : null;

  const modalHtml = `
    <div id="grammarSubmissionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                            background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                                            align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh;
                  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;
                    border-radius: 16px 16px 0 0; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin: 0;">${submission.testTitle || 'Grammar Test'}</h3>
              <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">
                ${submittedDate ? 'Submitted: ' + submittedDate.toLocaleDateString() : ''}
                ${gradedDate ? '  Graded: ' + gradedDate.toLocaleDateString() : ''}
              </p>
            </div>
            <button onclick="document.getElementById('grammarSubmissionModal').remove()"
                    style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px;
                           border-radius: 50%; cursor: pointer; font-size: 16px;"></button>
          </div>
        </div>
        <div style="padding: 25px;">
          ${feedbackHtml || '<p style="color: #718096; text-align: center;">No feedback available yet.</p>'}
        </div>
        <div style="padding: 15px 25px; border-top: 1px solid #e2e8f0; text-align: right;">
          <button onclick="document.getElementById('grammarSubmissionModal').remove()" class="btn" style="padding: 10px 24px;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Render Grammar Stats View
 */
async function renderGrammarStatsView() {
  const container = document.getElementById('grammarStatsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    await loadGrammarLeitnerCards();

    const totalCards = grammarLeitnerCards.length;
    const masteredCards = grammarLeitnerCards.filter(c => c.box >= 8).length;
    const inProgressCards = grammarLeitnerCards.filter(c => c.box > 1 && c.box < 8).length;
    const newCards = grammarLeitnerCards.filter(c => c.box === 1).length;

    const boxDistribution = {};
    for (let i = 1; i <= 8; i++) {
      boxDistribution[i] = grammarLeitnerCards.filter(c => c.box === i).length;
    }

    container.innerHTML = `
      <!-- Core Progress -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Core Progress</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${totalCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">Total Topics</div>
        </div>
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${masteredCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">Mastered</div>
        </div>
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${inProgressCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">In Progress</div>
        </div>
        <div style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
          <div style="font-size: 32px; font-weight: bold;">${newCards}</div>
          <div style="font-size: 13px; opacity: 0.9;">New</div>
        </div>
      </div>

      <!-- Box Distribution -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Box Distribution</h3>
      <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; margin-bottom: 30px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          ${Object.entries(boxDistribution).map(([box, count]) => `
            <div style="flex: 1; min-width: 80px; text-align: center; padding: 15px; background: ${box >= 8 ? '#f0fff4' : '#f7fafc'}; border-radius: 8px; border: 2px solid ${box >= 8 ? '#48bb78' : '#e2e8f0'};">
              <div style="font-size: 24px; font-weight: bold; color: ${box >= 8 ? '#48bb78' : '#667eea'};">${count}</div>
              <div style="font-size: 12px; color: #718096;">Box ${box}</div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Topics Needing Work -->
      <h3 style="color: #4a5568; margin-bottom: 15px;"> Topics Needing Work</h3>
      <div style="display: grid; gap: 10px;">
        ${grammarLeitnerCards.filter(c => c.box <= 2).slice(0, 5).map(card => `
          <div style="background: #fff5f5; padding: 12px 15px; border-radius: 8px; border-left: 4px solid #f56565; display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #2d3748;">${card.topic}</span>
            <span style="color: #f56565; font-size: 13px;">Box ${card.box}  Grade ${card.grade}/10</span>
          </div>
        `).join('') || '<p style="color: #48bb78; text-align: center; padding: 20px;"> No topics need immediate attention!</p>'}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading stats: ${error.message}</p>`;
  }
}

/**
 * Load Grammar Available Tests
 */
async function loadGrammarAvailableTests() {
  const container = document.getElementById('grammarAvailableTestsContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const testsSnapshot = await db.collection('tests').get();

    if (testsSnapshot.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Tests Available</h3>
          <p style="color: #718096;">Check back later for new grammar tests.</p>
        </div>
      `;
      return;
    }

    const availableTests = [];
    const completedTests = [];

    for (const testDoc of testsSnapshot.docs) {
      const test = testDoc.data();
      const testId = testDoc.id;

      const submissionSnapshot = await db.collection('submissions')
        .where('studentId', '==', currentUser.uid)
        .where('testId', '==', testId)
        .get();

      if (submissionSnapshot.empty) {
        availableTests.push({ id: testId, data: test });
      } else {
        completedTests.push({ id: testId, data: test, submission: submissionSnapshot.docs[0].data() });
      }
    }

    availableTests.sort((a, b) => {
      const aTime = a.data.createdAt ? a.data.createdAt.toDate() : new Date(0);
      const bTime = b.data.createdAt ? b.data.createdAt.toDate() : new Date(0);
      return bTime - aTime;
    });

    let html = '';

    if (availableTests.length > 0) {
      html += `
        <div style="margin-bottom: 30px;">
          <h3 style="color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"></span> Available Tests (${availableTests.length})
          </h3>
          <div style="display: grid; gap: 15px;">
            ${availableTests.map(item => `
              <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <div>
                    <h4 style="color: #2d3748; margin: 0 0 5px 0; font-size: 18px;">${item.data.title}</h4>
                    <p style="color: #718096; font-size: 13px; margin: 0;">Posted by ${item.data.teacherEmail}</p>
                  </div>
                  <span style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                    NEW
                  </span>
                </div>
                <button onclick="startTest('${item.id}')" class="btn" style="width: 100%; padding: 12px; font-size: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                   Take Test
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    } else {
      html += `
        <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); border-radius: 12px; border: 2px solid #48bb78; margin-bottom: 30px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #276749; margin-bottom: 10px;">All Tests Completed!</h3>
          <p style="color: #2f855a;">Great job! You've completed all available grammar tests.</p>
        </div>
      `;
    }

    if (completedTests.length > 0) {
      html += `
        <div>
          <button onclick="toggleGrammarCompletedTests()" style="width: 100%; background: #f7fafc; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #718096; font-weight: 600;"> Completed Tests (${completedTests.length})</span>
            <span id="grammarCompletedToggleIcon" style="color: #718096;"></span>
          </button>
          <div id="grammarCompletedTestsSection" style="display: none; margin-top: 15px;">
            <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
              View your completed tests in the  Calendar tab to see feedback and grades.
            </p>
            <div style="display: grid; gap: 10px;">
              ${completedTests.map(item => `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <p style="color: #4a5568; margin: 0; font-weight: 500;">${item.data.title}</p>
                    <p style="color: #a0aec0; font-size: 12px; margin: 5px 0 0 0;">
                      Status: ${item.submission.status === 'graded' ? ' Graded' : ' Pending'}
                    </p>
                  </div>
                  <button onclick="switchGrammarDrillView('calendar')" class="btn" style="padding: 8px 16px; font-size: 13px;">
                    View in Calendar
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading tests: ${error.message}</p>`;
  }
}

/**
 * Toggle grammar completed tests section
 */
function toggleGrammarCompletedTests() {
  const section = document.getElementById('grammarCompletedTestsSection');
  const icon = document.getElementById('grammarCompletedToggleIcon');

  if (section && icon) {
    if (section.style.display === 'none') {
      section.style.display = 'block';
      icon.textContent = '';
    } else {
      section.style.display = 'none';
      icon.textContent = '';
    }
  }
}

/**
 * Render Grammar Mastery View
 */
async function renderGrammarMasteryView() {
  const container = document.getElementById('grammarMasteryContainer2');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('grammarMastery')
      .where('studentId', '==', currentUser.uid)
      .get();

    const masteryCards = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    if (masteryCards.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f7fafc; border-radius: 12px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h3 style="color: #4a5568; margin-bottom: 10px;">No Mastered Topics Yet</h3>
          <p style="color: #718096; margin-bottom: 20px;">
            Score 10/10 on grammar topics to add them to your mastery deck!
          </p>
          <button onclick="switchGrammarDrillView('drills')" class="btn" style="padding: 12px 24px;">
             Go to Active Drills
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 10px;"></div>
        <h3 style="color: #744210; margin: 0 0 5px 0;">Grammar Mastery Deck</h3>
        <p style="color: #975a16; margin: 0;">${masteryCards.length} topic${masteryCards.length > 1 ? 's' : ''} mastered!</p>
      </div>

      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px;">
        ${masteryCards.slice(0, 20).map(card => `
          <span style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #92400e; border: 2px solid #f59e0b;">
             ${card.topic}
          </span>
        `).join('')}
        ${masteryCards.length > 20 ? `<span style="color: #718096; padding: 8px;">+${masteryCards.length - 20} more</span>` : ''}
      </div>

      <h4 style="color: #2d3748; margin-bottom: 15px;">All Mastered Topics</h4>
      <div style="display: grid; gap: 10px;">
        ${masteryCards.map(card => `
          <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #fbd38d; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-weight: 600; color: #2d3748;"> ${card.topic}</span>
              <p style="color: #718096; font-size: 12px; margin: 4px 0 0 0;">
                Mastered on ${card.masteredAt ? (card.masteredAt.toDate ? card.masteredAt.toDate().toLocaleDateString() : new Date(card.masteredAt).toLocaleDateString()) : 'Recently'}
              </p>
            </div>
            <span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;">10/10</span>
          </div>
        `).join('')}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #f56565;">Error loading mastery deck: ${error.message}</p>`;
  }
}
async function renderPronunciationCalendar() {
  const container = document.getElementById('pronunciationCalendarContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  await loadPronunciationDrillHistory();

  const today = new Date();
  const year = currentPronCalendarYear;
  const month = currentPronCalendarMonth;

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDayOfWeek = firstDay.getDay();
  const totalDays = lastDay.getDate();

  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];

  const streak = calculatePronDrillStreak();

  const monthStats = calculateMonthlyPronStats(year, month);

  container.innerHTML = `
    <!-- Calendar Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <button onclick="changePronCalendarMonth(-1)" class="btn" style="padding: 8px 16px;">
         Prev
      </button>
      <h3 style="margin: 0; color: #2d3748;">${monthNames[month]} ${year}</h3>
      <button onclick="changePronCalendarMonth(1)" class="btn" style="padding: 8px 16px;">
        Next 
      </button>
    </div>

    <!-- Stats Summary -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 25px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${monthStats.practiceDays}</div>
        <div style="font-size: 12px; opacity: 0.9;">Days Practiced</div>
      </div>
      <div style="background: ${streak >= 3 ? 'linear-gradient(135deg, #f56565 0%, #ed8936 100%)' : 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)'}; color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${streak} </div>
        <div style="font-size: 12px; opacity: 0.9;">Current Streak</div>
      </div>
      <div style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${monthStats.completedDrills}</div>
        <div style="font-size: 12px; opacity: 0.9;">Drills Completed</div>
      </div>
      <div style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
        <div style="font-size: 28px; font-weight: bold;">${monthStats.totalProductions}</div>
        <div style="font-size: 12px; opacity: 0.9;">Word Productions</div>
      </div>
    </div>

    <!-- Calendar Grid -->
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <!-- Day Headers -->
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px;">
        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
          <div style="text-align: center; font-weight: 600; color: #718096; font-size: 12px; padding: 8px;">${day}</div>
        `).join('')}
      </div>

      <!-- Calendar Days -->
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
        ${renderPronCalendarDays(year, month, startDayOfWeek, totalDays, today)}
      </div>
    </div>

    <!-- Legend -->
    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); border-radius: 4px;"></div>
        <span style="font-size: 12px; color: #4a5568;">Completed All</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <div style="width: 18px; height: 18px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 4px;"></div>
        <span style="font-size: 12px; color: #4a5568;">Partial Practice</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <div style="width: 18px; height: 18px; background: #fff5f5; border: 2px solid #f56565; border-radius: 4px;"></div>
        <span style="font-size: 12px; color: #4a5568;">Missed</span>
      </div>
    </div>

    <!-- Submission Legend -->
    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 12px; flex-wrap: wrap; padding: 12px; background: #f7fafc; border-radius: 10px;">
      <span style="font-size: 12px; color: #4a5568; font-weight: 600;">Submissions:</span>
      <div style="display: flex; align-items: center; gap: 6px;">
        <div style="background: #fbbf24; color: #000; font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid #000;"> Pending</div>
        <span style="font-size: 12px; color: #4a5568;">Not graded yet</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <div style="background: #48bb78; color: #000; font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid #000;"> Graded</div>
        <span style="font-size: 12px; color: #4a5568;">Click to view feedback!</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div style="margin-top: 30px;">
      <h3 style="color: #2d3748; margin-bottom: 15px;"> Recent Activity</h3>
      ${renderRecentPronActivity()}
    </div>

    <!-- Completed 7-Day Cycles -->
    <div style="margin-top: 30px;">
      <h3 style="color: #2d3748; margin-bottom: 15px;"> Completed 7-Day Cycles</h3>
      ${renderCompletedPronCycles()}
    </div>
  `;
}

/**
 * Load pronunciation drill history
 */
async function loadPronunciationDrillHistory() {
  try {
    await loadPronunciationDrillCards();

    pronDrillHistory = [];

    pronunciationDrillCards.forEach(card => {
      if (card.lastCompletedDate) {
        const date = card.lastCompletedDate.toDate ? card.lastCompletedDate.toDate() : new Date(card.lastCompletedDate);
        pronDrillHistory.push({
          cardId: card.id,
          topic: card.topicLabel || card.topic,
          level: card.level || 1,
          date: date,
          day: card.currentDay,
          isComplete: card.isComplete
        });
      }

      if (card.startedAt) {
        const startDate = card.startedAt.toDate ? card.startedAt.toDate() : new Date(card.startedAt);
        pronDrillHistory.push({
          cardId: card.id,
          topic: card.topicLabel || card.topic,
          level: card.level || 1,
          date: startDate,
          day: 1,
          type: 'started'
        });
      }
    });

    pronDrillHistory.sort((a, b) => b.date - a.date);

    await loadPronunciationSubmissions();

  } catch (error) {
  }
}

/**
 * Load pronunciation submissions for calendar display
 */
async function loadPronunciationSubmissions() {
  try {
    if (!currentUser) return;

    const snapshot = await db.collection('submissions2')
      .where('studentId', '==', currentUser.uid)
      .get();

    pronSubmissions = [];

    for (const doc of snapshot.docs) {
      const data = doc.data();

      let testTitle = 'Pronunciation Test';
      try {
        const testDoc = await db.collection('tests2').doc(data.testId).get();
        if (testDoc.exists) {
          testTitle = testDoc.data().title;
        }
      } catch (e) {
      }

      pronSubmissions.push({
        id: doc.id,
        testId: data.testId,
        testTitle: testTitle,
        submittedAt: data.submittedAt ? (data.submittedAt.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt)) : new Date(),
        status: data.status || 'pending',
        grades: data.grades || null,
        videoUrl: data.videoUrl || null,
        videoFeedbackUrl: data.videoFeedbackUrl || null,
        level2VideoFeedbackUrl: data.level2VideoFeedbackUrl || null,
        gradedAt: data.gradedAt ? (data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt)) : null,
        feedbackNeeded: data.feedbackNeeded || null
      });
    }

    pronSubmissions.sort((a, b) => b.submittedAt - a.submittedAt);

  } catch (error) {
  }
}

/**
 * Render calendar days
 */
function renderPronCalendarDays(year, month, startDayOfWeek, totalDays, today) {
  let html = '';

  for (let i = 0; i < startDayOfWeek; i++) {
    html += `<div style="padding: 10px;"></div>`;
  }

  for (let day = 1; day <= totalDays; day++) {
    const currentDate = new Date(year, month, day);
    currentDate.setHours(0, 0, 0, 0);

    const isToday = currentDate.toDateString() === today.toDateString();
    const isFuture = currentDate > today;

    const dayActivity = getDayPronActivity(currentDate);

    const daySubmissions = getSubmissionsForDay(currentDate);

    let bgStyle = 'background: #f7fafc;';
    let borderStyle = '';
    let indicator = '';
    let submissionIndicator = '';

    if (isFuture) {
      bgStyle = 'background: #f7fafc; opacity: 0.5;';
    } else if (dayActivity.completedAll && dayActivity.hadDrills) {
      bgStyle = 'background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white;';
      indicator = '';
    } else if (dayActivity.practiced) {
      bgStyle = 'background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;';
      indicator = dayActivity.count > 0 ? dayActivity.count : '';
    } else if (dayActivity.hadDrillsDue && !isFuture) {
      bgStyle = 'background: #fff5f5;';
      borderStyle = 'border: 2px solid #f56565;';
      indicator = '';
    }

    if (isToday) {
      borderStyle = 'border: 3px solid #667eea; box-shadow: 0 0 0 2px #667eea40;';
    }

    if (daySubmissions.length > 0) {
      daySubmissions.forEach(sub => {
        const isGraded = sub.status === 'graded';
        const bgColor = isGraded ? '#48bb78' : '#fbbf24';
        const textColor = '#000';
        const label = isGraded ? ' Graded' : ' Pending';
        submissionIndicator += `
          <div onclick="event.stopPropagation(); showSubmissionDetail('${sub.id}')"
               style="background: ${bgColor}; color: ${textColor}; font-size: 8px; padding: 2px 4px;
                      border-radius: 4px; margin-top: 2px; cursor: pointer; border: 1px solid #000;
                      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;"
               title="${sub.testTitle} - ${label}">
            ${label}
          </div>
        `;
      });
    }

    html += `
      <div onclick="showPronDayDetail(${year}, ${month}, ${day})"
           style="padding: 6px 4px; text-align: center; border-radius: 8px; cursor: pointer;
                  min-height: ${daySubmissions.length > 0 ? '65px' : '45px'}; display: flex; flex-direction: column; justify-content: flex-start;
                  ${bgStyle} ${borderStyle} transition: transform 0.2s;"
           onmouseover="this.style.transform='scale(1.05)'"
           onmouseout="this.style.transform='scale(1)'">
        <div style="font-weight: ${isToday ? '700' : '500'}; font-size: 14px;">${day}</div>
        ${indicator ? `<div style="font-size: 10px; margin-top: 2px;">${indicator}</div>` : ''}
        ${submissionIndicator}
      </div>
    `;
  }

  return html;
}

/**
 * Get pronunciation activity for a specific day
 */
function getDayPronActivity(date) {
  const dayStart = new Date(date);
  dayStart.setHours(0, 0, 0, 0);
  const dayEnd = new Date(date);
  dayEnd.setHours(23, 59, 59, 999);

  const dayActivities = pronDrillHistory.filter(h => {
    const actDate = new Date(h.date);
    return actDate >= dayStart && actDate <= dayEnd && h.type !== 'started';
  });

  const drillsDueOnDay = pronunciationDrillCards.filter(card => {
    const startDate = card.startedAt ? (card.startedAt.toDate ? card.startedAt.toDate() : new Date(card.startedAt)) : null;
    const completeDate = card.completedAt ? (card.completedAt.toDate ? card.completedAt.toDate() : new Date(card.completedAt)) : null;

    if (!startDate) return false;

    const cardStart = new Date(startDate);
    cardStart.setHours(0, 0, 0, 0);

    const wasStarted = cardStart <= dayStart;
    const wasCompletedBefore = completeDate && new Date(completeDate).setHours(0,0,0,0) < dayStart.getTime();

    return wasStarted && !wasCompletedBefore;
  });

  const hadDrills = drillsDueOnDay.length > 0;

  const drillsPracticedOnDay = new Set(dayActivities.map(a => a.cardId));
  const uniqueDrillsPracticed = drillsPracticedOnDay.size;

  const completedDrillsOnDay = new Set();

  dayActivities.forEach(activity => {
    if (activity.type === 'completed' || activity.type === 'day_complete' || activity.type === 'practiced' || activity.type === 'repetition') {
      completedDrillsOnDay.add(activity.cardId);
    }
  });

  drillsDueOnDay.forEach(card => {
    const lastCompleted = card.lastCompletedDate ?
      (card.lastCompletedDate.toDate ? card.lastCompletedDate.toDate() : new Date(card.lastCompletedDate)) : null;

    if (lastCompleted) {
      const completedDayStart = new Date(lastCompleted);
      completedDayStart.setHours(0, 0, 0, 0);
      if (completedDayStart.getTime() === dayStart.getTime()) {
        completedDrillsOnDay.add(card.id);
      }
    }
  });

  const allDrillsCompleted = hadDrills && drillsDueOnDay.every(card => completedDrillsOnDay.has(card.id));

  return {
    practiced: dayActivities.length > 0,
    count: uniqueDrillsPracticed,
    completedAll: allDrillsCompleted,
    hadDrills: hadDrills,
    hadDrillsDue: hadDrills,
    drillsDue: drillsDueOnDay.length,
    drillsCompleted: completedDrillsOnDay.size,
    activities: dayActivities
  };
}

/**
 * Get submissions for a specific day
 */
function getSubmissionsForDay(date) {
  if (!pronSubmissions || pronSubmissions.length === 0) {
    return [];
  }

  const dayStart = new Date(date);
  dayStart.setHours(0, 0, 0, 0);
  const dayEnd = new Date(date);
  dayEnd.setHours(23, 59, 59, 999);

  return pronSubmissions.filter(sub => {
    if (!sub.submittedAt) return false;
    const subDate = new Date(sub.submittedAt);
    return subDate >= dayStart && subDate <= dayEnd;
  });
}

/**
 * Show submission detail modal with teacher feedback and student video
 */
async function showSubmissionDetail(submissionId) {

  const loadingModal = document.createElement('div');
  loadingModal.id = 'submissionLoadingModal';
  loadingModal.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                align-items: center; justify-content: center;">
      <div style="background: white; padding: 40px; border-radius: 16px; text-align: center;">
        <div class="loading"></div>
        <p style="margin-top: 15px; color: #4a5568;">Loading submission...</p>
      </div>
    </div>
  `;
  document.body.appendChild(loadingModal);

  let submission = pronSubmissions.find(s => s.id === submissionId);

  if (!submission) {
    try {
      const doc = await db.collection('submissions2').doc(submissionId).get();
      if (!doc.exists) {
        loadingModal.remove();
        alert('Submission not found');
        return;
      }
      const data = doc.data();

      let testTitle = 'Pronunciation Test';
      try {
        const testDoc = await db.collection('tests2').doc(data.testId).get();
        if (testDoc.exists) {
          testTitle = testDoc.data().title;
        }
      } catch (e) {
      }

      submission = {
        id: submissionId,
        testId: data.testId,
        testTitle: testTitle,
        submittedAt: data.submittedAt ? (data.submittedAt.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt)) : new Date(),
        status: data.status || 'pending',
        grades: data.grades || null,
        videoUrl: data.videoUrl || null,
        videoFeedbackUrl: data.videoFeedbackUrl || null,
        level2VideoFeedbackUrl: data.level2VideoFeedbackUrl || null,
        gradedAt: data.gradedAt ? (data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt)) : null,
        feedbackNeeded: data.feedbackNeeded || null
      };
    } catch (error) {
      loadingModal.remove();
      alert('Error loading submission: ' + error.message);
      return;
    }
  }

  let fullSubmission = submission;
  try {
    const doc = await db.collection('submissions2').doc(submissionId).get();
    if (doc.exists) {
      const data = doc.data();
      fullSubmission = {
        ...submission,
        ...data,
        submittedAt: data.submittedAt ? (data.submittedAt.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt)) : submission.submittedAt,
        gradedAt: data.gradedAt ? (data.gradedAt.toDate ? data.gradedAt.toDate() : new Date(data.gradedAt)) : submission.gradedAt
      };
    }
  } catch (error) {
  }

  let testData = null;
  try {
    if (fullSubmission.testId) {
      const testDoc = await db.collection('tests2').doc(fullSubmission.testId).get();
      if (testDoc.exists) {
        testData = testDoc.data();
      }
    }
  } catch (error) {
  }

  const loadingModalElement = document.getElementById('submissionLoadingModal');
  if (loadingModalElement) loadingModalElement.remove();

  const isGraded = fullSubmission.status === 'graded';
  const statusText = isGraded ? 'Graded ' : 'Pending Review ';
  const statusColor = isGraded ? '#48bb78' : '#fbbf24';

  let testMaterialsHtml = '';
  if (testData && testData.materials && testData.materials.length > 0) {
    testMaterialsHtml = `
      <div style="margin-bottom: 25px;">
        <h4 style="color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
           Test Materials
          <span style="background: #e9d8fd; color: #6b46c1; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
            ${testData.materials.length} item${testData.materials.length > 1 ? 's' : ''}
          </span>
        </h4>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px;">
          ${testData.materials.map((material, idx) => `
            <div style="padding: 15px; ${idx > 0 ? 'border-top: 1px solid #e2e8f0;' : ''} background: ${idx % 2 === 0 ? '#faf5ff' : 'white'};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #553c9a;">Material ${idx + 1}: ${material.title || 'Untitled'}</span>
                <span style="background: #9f7aea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                  ${Math.floor((material.timeLimit || 60) / 60)}:${((material.timeLimit || 60) % 60).toString().padStart(2, '0')}
                </span>
              </div>
              <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e9d8fd; margin-bottom: 10px;">
                <p style="white-space: pre-wrap; margin: 0; color: #2d3748; font-size: 15px; line-height: 1.6;">${material.content || 'No content'}</p>
              </div>
              ${material.topics && material.topics.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                  ${material.topics.map(topic => `
                    <span style="background: #e9d8fd; color: #6b46c1; padding: 3px 10px; border-radius: 12px; font-size: 11px;">${topic}</span>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  let studentVideoHtml = '';
  if (fullSubmission.recordings && Object.keys(fullSubmission.recordings).length > 0) {
    const recordingEntries = Object.entries(fullSubmission.recordings);
    studentVideoHtml = `
      <div style="margin-top: 10px;">
        ${recordingEntries.map(([key, recording], idx) => {
          const materialTitle = testData && testData.materials && testData.materials[idx] ? testData.materials[idx].title : 'Recording ' + (parseInt(key) + 1);
          const videoUrl = typeof recording === 'string' ? recording : recording.url || recording.videoUrl;
          return videoUrl ? `
            <div style="margin-bottom: 15px; background: #f7fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
              <p style="font-weight: 600; color: #4a5568; margin-bottom: 10px;"> ${materialTitle}</p>
              <video controls style="width: 100%; max-width: 100%; border-radius: 8px; border: 2px solid #667eea;">
                <source src="${videoUrl}" type="video/webm">
              </video>
            </div>
          ` : '';
        }).join('')}
      </div>
    `;
  } else if (fullSubmission.videoUrl) {
    studentVideoHtml = `
      <div style="margin-top: 10px; background: #f7fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
        <video controls style="width: 100%; max-width: 100%; border-radius: 8px; border: 2px solid #667eea;">
          <source src="${fullSubmission.videoUrl}" type="video/webm">
        </video>
      </div>
    `;
  }

  let gradesHtml = '';
  if (fullSubmission.grades && isGraded) {
    const sortedGrades = Object.entries(fullSubmission.grades).sort((a, b) => a[1] - b[1]);

    let gradeItemsHtml = '';
    sortedGrades.forEach(([key, grade]) => {
      let topicName = key;
      const match = key.match(/^(\d+)_(.+)$/);
      if (match) topicName = match[2];

      const feedback = fullSubmission.feedbackNeeded && fullSubmission.feedbackNeeded[key] ? fullSubmission.feedbackNeeded[key] : null;

      let feedbackDisplay = '';
      if (feedback && feedback.content) {
        if (feedback.type === 'text') {
          feedbackDisplay = `<p style="color: #718096; font-size: 14px; margin-top: 8px;">${feedback.content}</p>`;
        } else if (feedback.type === 'video') {
          let videoUrl = feedback.content;
          let embedUrl = '';
          let isEmbeddable = false;

          if (videoUrl.includes('youtube.com/watch')) {
            embedUrl = videoUrl.replace('watch?v=', 'embed/');
            isEmbeddable = true;
          } else if (videoUrl.includes('youtu.be/')) {
            const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
            embedUrl = 'https://www.youtube.com/embed/' + videoId;
            isEmbeddable = true;
          } else if (videoUrl.includes('loom.com/share/')) {
            const videoId = videoUrl.split('loom.com/share/')[1].split('?')[0];
            embedUrl = 'https://www.loom.com/embed/' + videoId;
            isEmbeddable = true;
          } else if (videoUrl.includes('vimeo.com/')) {
            const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
            embedUrl = 'https://player.vimeo.com/video/' + videoId;
            isEmbeddable = true;
          } else if (videoUrl.includes('drive.google.com') && videoUrl.includes('/file/d/')) {
            const videoId = videoUrl.split('/file/d/')[1].split('/')[0];
            embedUrl = 'https://drive.google.com/file/d/' + videoId + '/preview';
            isEmbeddable = true;
          }

          if (isEmbeddable) {
            const uniqueId = 'video-modal-' + submissionId.substring(0,8) + '-' + key.replace(/[^a-zA-Z0-9]/g, '');
            feedbackDisplay = `
              <div style="margin-top: 8px;">
                <button id="btn-${uniqueId}" onclick="loadVideo('${uniqueId}', '${embedUrl.replace(/'/g, "\\'")}')" style="color: #667eea; background: #eef2ff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; transition: all 0.3s;">
                  <span style="margin-right: 5px;"></span>
                  <span style="font-weight: 600;">Watch Video</span>
                  <span style="margin-left: 5px;"></span>
                </button>
                <div id="${uniqueId}" style="display: none; margin-top: 10px;">
                  <!-- Video will be loaded here when button is clicked -->
                </div>
              </div>
            `;
          } else {
            feedbackDisplay = `
              <div style="margin-top: 8px;">
                <a href="${videoUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; padding: 8px 12px; background: #eef2ff; border-radius: 6px; transition: all 0.3s;">
                  <span style="margin-right: 5px;"></span>
                  <span style="font-weight: 600;">Watch Video</span>
                  <span style="margin-left: 5px;"></span>
                </a>
              </div>
            `;
          }
        } else if (feedback.type === 'html') {
          feedbackDisplay = '<div style="margin-top: 8px;">' + feedback.content + '</div>';
        }
      } else if (feedback && typeof feedback === 'string') {
        feedbackDisplay = '<p style="color: #718096; font-size: 14px; margin-top: 8px;">' + feedback + '</p>';
      }

      gradeItemsHtml += `
        <div style="margin: 10px 0; padding: 12px; background: ${grade < 5 ? '#fff5f5' : 'white'}; border-radius: 6px; border-left: 6px solid ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; ${grade < 5 ? 'box-shadow: 0 2px 8px rgba(245, 101, 101, 0.2);' : ''}">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
            <strong style="color: #2d3748; font-size: 16px;">
              ${grade < 5 ? ' ' : ''}${topicName}
              ${grade < 5 ? '<span style="color: #f56565; font-size: 12px; margin-left: 8px;">(Priority!)</span>' : ''}
            </strong>
            <span style="font-size: 18px; font-weight: 700; color: ${grade >= 7 ? '#48bb78' : grade >= 5 ? '#ed8936' : '#f56565'}; ${grade < 5 ? 'background: #fee; padding: 4px 8px; border-radius: 4px;' : ''}">
              ${grade}/10
            </span>
          </div>
          ${feedbackDisplay}
          ${grade < 10 && !feedbackDisplay ? '<p style="color: #cbd5e0; font-size: 13px; font-style: italic;">Practice materials available upon perfect score</p>' : ''}
        </div>
      `;
    });

    gradesHtml = `
      <div style="margin-top: 15px;">
        <h4 style="color: #2d3748; font-size: 16px; margin-bottom: 10px;"> Grades by Topic (Lowest First - Focus on These!):</h4>
        <p style="color: #718096; font-size: 13px; margin-bottom: 10px; font-style: italic;"> Topics are sorted from lowest to highest score to help you focus on areas needing the most improvement.</p>
        ${gradeItemsHtml}
      </div>
    `;
  }

  let videoHtml = '';

  console.log('fullSubmission keys:', Object.keys(fullSubmission));

  if (fullSubmission.videoFeedbackUrl) {
    videoHtml = `
      <div style="margin-top: 15px;">
        <h4 style="color: #2d3748; font-size: 16px; margin-bottom: 10px;"> Level 1 Video Feedback:</h4>
        <video controls style="width: 100%; max-width: 600px; border-radius: 8px; border: 2px solid #48bb78;">
          <source src="${fullSubmission.videoFeedbackUrl}" type="video/webm">
        </video>
      </div>
    `;
  }

  let level2VideoHtml = '';
  if (fullSubmission.level2VideoFeedbackUrl) {
    level2VideoHtml = `
      <div style="margin-top: 15px;">
        <h4 style="color: #6b46c1; font-size: 16px; margin-bottom: 10px;"> Level 2 Video Feedback (Consonant Assimilation):</h4>
        <video controls style="width: 100%; max-width: 600px; border-radius: 8px; border: 2px solid #9f7aea;">
          <source src="${fullSubmission.level2VideoFeedbackUrl}" type="video/webm">
        </video>
      </div>
    `;
  }

  let level2GradesHtml = '';
  if (fullSubmission.level2Grades && Object.keys(fullSubmission.level2Grades).length > 0 && isGraded) {
    const sortedLevel2 = Object.entries(fullSubmission.level2Grades)
      .map(([ruleId, grade]) => ({ ruleId: parseInt(ruleId), grade }))
      .sort((a, b) => a.grade - b.grade);

    level2GradesHtml = `
      <div style="margin-top: 15px; background: linear-gradient(135deg, #faf5ff 0%, #f0e6ff 100%); padding: 15px; border-radius: 10px; border: 1px solid #d6bcfa;">
        <h4 style="color: #6b46c1; font-size: 16px; margin-bottom: 10px;"> Level 2: Consonant Assimilation Scores</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${sortedLevel2.map(item => {
            const rule = typeof CONSONANT_ASSIMILATION_RULES !== 'undefined' ?
              CONSONANT_ASSIMILATION_RULES.find(r => r.id === item.ruleId) : null;
            const ruleLabel = rule ? rule.rule : 'Rule #' + item.ruleId;
            return `
              <div style="background: white; padding: 6px 10px; border-radius: 6px; border: 1px solid ${item.grade === 4 ? '#48bb78' : item.grade >= 3 ? '#ed8936' : '#f56565'};">
                <span style="font-size: 12px; color: #718096;">#${item.ruleId}</span>
                <span style="font-size: 14px; font-weight: 600; color: ${item.grade === 4 ? '#48bb78' : item.grade >= 3 ? '#ed8936' : '#f56565'}; margin-left: 4px;">
                  ${item.grade}/4
                </span>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  let level2InstructionalVideosHtml = '';

  console.log('Level 2 Instructional Videos data:', {
    hasData: !!fullSubmission.level2InstructionalVideos,
    keys: fullSubmission.level2InstructionalVideos ? Object.keys(fullSubmission.level2InstructionalVideos) : [],
    rawData: fullSubmission.level2InstructionalVideos
  });

  if (fullSubmission.level2InstructionalVideos && Object.keys(fullSubmission.level2InstructionalVideos).length > 0 && isGraded) {
    const videos = Object.entries(fullSubmission.level2InstructionalVideos)
      .map(([ruleId, data]) => ({ ruleId: parseInt(ruleId), ...data }))
      .sort((a, b) => a.grade - b.grade);


    level2InstructionalVideosHtml = `
      <div style="margin-top: 20px; background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); padding: 20px; border-radius: 12px; border: 2px solid #38b2ac;">
        <h4 style="color: #276749; font-size: 18px; margin-bottom: 15px;">
           Instructional Videos for Your Improvement Areas (${videos.length})
        </h4>
        <p style="color: #285e61; font-size: 14px; margin-bottom: 15px;">
          Watch these videos to understand the consonant assimilation rules you need to practice:
        </p>
        <div style="display: grid; gap: 15px;">
          ${videos.map(item => {
            const embedUrl = item.videoUrl ? item.videoUrl.replace('/share/', '/embed/') : '';
            const uniqueVideoId = 'instrVid-modal-' + submissionId.substring(0,8) + '-' + item.ruleId;
            return `
              <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${item.grade <= 2 ? '#f56565' : '#ed8936'}; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div>
                    <span style="font-weight: bold; color: #2d3748; font-size: 16px;">Rule #${item.ruleId}</span>
                    <span style="color: ${item.grade <= 2 ? '#f56565' : '#ed8936'}; font-weight: bold; margin-left: 10px; font-size: 15px;">${item.grade}/4</span>
                  </div>
                  <span style="background: ${item.grade <= 2 ? '#fed7d7' : '#feebc8'}; color: ${item.grade <= 2 ? '#c53030' : '#c05621'}; font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                    ${item.grade <= 2 ? ' Needs Work' : ' Improving'}
                  </span>
                </div>
                <div style="font-size: 15px; color: #6b46c1; margin-bottom: 5px; font-weight: 600;">${item.rule || ''}</div>
                <div style="font-size: 13px; color: #718096; margin-bottom: 12px;">Example: ${item.example || ''}</div>
                ${embedUrl ? `
                  <button onclick="document.getElementById('${uniqueVideoId}').style.display = document.getElementById('${uniqueVideoId}').style.display === 'none' ? 'block' : 'none'; this.innerHTML = document.getElementById('${uniqueVideoId}').style.display === 'none' ? ' Watch Video' : ' Hide Video';"
                          style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                     Watch Video
                  </button>
                  <div id="${uniqueVideoId}" style="display: none; margin-top: 12px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                    <iframe src="${embedUrl}" width="100%" height="280" frameborder="0" allowfullscreen style="border-radius: 10px;"></iframe>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
        <div style="margin-top: 15px; padding: 12px; background: #c6f6d5; border-radius: 8px;">
          <p style="color: #276749; font-size: 13px; margin: 0;">
            <strong> Study Tip:</strong> Watch each video multiple times and practice saying the examples out loud.
            Pay attention to how the consonants change at syllable boundaries!
          </p>
        </div>
      </div>
    `;
  }

  let textFeedbackHtml = '';
  const teacherTextFeedback = fullSubmission.teacherComments ||
                              fullSubmission.textFeedback ||
                              fullSubmission.comments ||
                              fullSubmission.feedback;


  if (teacherTextFeedback) {
    textFeedbackHtml = `
      <div style="background: #fff5f5; border-left: 4px solid #f56565; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <h4 style="color: #c53030; font-size: 16px; margin-bottom: 8px;"> Teacher Comments:</h4>
        <p style="color: #2d3748; line-height: 1.6;">${teacherTextFeedback}</p>
      </div>
    `;
  }

  const modalHtml = `
    <div id="submissionDetailModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                           background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                                           align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh;
                  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px;
                    border-radius: 16px 16px 0 0; color: white; position: sticky; top: 0; z-index: 1;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3 style="margin: 0 0 10px 0; font-size: 22px;">${fullSubmission.testTitle || testData?.title || 'Pronunciation Test'}</h3>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <span style="background: ${statusColor}; color: #000; padding: 4px 12px; border-radius: 20px;
                             font-size: 13px; font-weight: 600; border: 1px solid #000;">
                  ${statusText}
                </span>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                   Submitted: ${fullSubmission.submittedAt instanceof Date ? fullSubmission.submittedAt.toLocaleDateString() : 'Recently'}
                </span>
                ${isGraded && fullSubmission.gradedAt ? `
                  <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                     Graded: ${fullSubmission.gradedAt instanceof Date ? fullSubmission.gradedAt.toLocaleDateString() : 'Recently'}
                  </span>
                ` : ''}
              </div>
            </div>
            <button onclick="closeSubmissionDetailModal()"
                    style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px;
                           border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center;
                           justify-content: center; flex-shrink: 0;"></button>
          </div>
        </div>

        <!-- Content -->
        <div style="padding: 25px;">
          ${!isGraded ? `
            <div style="background: #fffbeb; border: 2px solid #fbbf24; border-radius: 12px; padding: 25px; text-align: center; margin-bottom: 25px;">
              <div style="font-size: 48px; margin-bottom: 10px;"></div>
              <h4 style="color: #92400e; margin: 0 0 10px 0;">Waiting for Teacher's Feedback</h4>
              <p style="color: #b45309; margin: 0;">Your submission is being reviewed. Check back soon!</p>
            </div>
          ` : `
            <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 25px;">
              <div style="font-size: 36px; margin-bottom: 5px;"></div>
              <h4 style="color: #276749; margin: 0;">Your Test Has Been Graded!</h4>
              <p style="color: #2f855a; margin: 5px 0 0 0; font-size: 14px;">Review the feedback below to improve your pronunciation.</p>
            </div>
          `}

          <!-- Student Submission Section (TOP) -->
          ${studentVideoHtml ? `
            <div style="margin-bottom: 25px;">
              <h3 style="color: #2d3748; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                 Your Submission
              </h3>
              ${studentVideoHtml}
            </div>
          ` : ''}

          <!-- Teacher Feedback Section (Right below student submission) -->
          ${isGraded ? `
            <div style="margin-bottom: 25px;">
              <h3 style="color: #276749; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #48bb78;">
                 Teacher's Feedback - Level 1
              </h3>
              ${videoHtml || ''}
              ${textFeedbackHtml || ''}
              ${!videoHtml && !textFeedbackHtml ? `
                <p style="color: #718096; text-align: center; padding: 20px;">No Level 1 video or text feedback recorded.</p>
              ` : ''}
            </div>
          ` : ''}

          <!-- Level 1 Grades Section -->
          ${gradesHtml}

          <!-- Level 2 Section -->
          ${isGraded && (fullSubmission.level2Unlocked || fullSubmission.level2Grades || fullSubmission.level2VideoFeedbackUrl || fullSubmission.level2InstructionalVideos) ? `
            <div style="margin-top: 30px; padding-top: 25px; border-top: 3px solid #9f7aea;">
              <h3 style="color: #6b46c1; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                 Level 2 - Consonant Assimilation
                <span style="background: #9f7aea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;">Advanced</span>
              </h3>
              ${level2VideoHtml || ''}
              ${level2GradesHtml || ''}
              ${level2InstructionalVideosHtml || ''}
              ${!level2VideoHtml && !level2GradesHtml && !level2InstructionalVideosHtml ? `
                <p style="color: #718096; text-align: center; padding: 20px;">Level 2 feedback pending...</p>
              ` : ''}
            </div>
          ` : ''}

          <!-- Test Materials Section -->
          ${testMaterialsHtml}
        </div>

        <!-- Footer -->
        <div style="padding: 20px 25px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f7fafc; border-radius: 0 0 16px 16px;">
          <span style="color: #718096; font-size: 13px;">Submission ID: ${submissionId.substring(0, 8)}...</span>
          <button onclick="closeSubmissionDetailModal()" class="btn" style="padding: 10px 30px;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;

  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHtml;
  document.body.appendChild(modalContainer.firstElementChild);
}

/**
 * Close submission detail modal
 */
function closeSubmissionDetailModal() {
  const modal = document.getElementById('submissionDetailModal');
  if (modal) {
    modal.remove();
  }
}

/**
 * Toggle video visibility in submission detail modal (lazy load)
 */
function toggleSubmissionVideo(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const isVisible = container.style.display !== 'none';

  if (isVisible) {
    container.style.display = 'none';
    const video = container.querySelector('video');
    if (video) {
      video.pause();
    }
  } else {
    container.style.display = 'block';

    setTimeout(() => {
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }
}

/**
 * Toggle the latest feedback video preview in Active Drills
 */
function toggleLatestFeedbackVideo() {
  const container = document.getElementById('latestFeedbackVideoContainer');
  const btn = document.getElementById('toggleFeedbackBtn');

  if (!container || !btn) return;

  if (container.style.display === 'none') {
    container.style.display = 'block';
    btn.textContent = ' Hide Video Preview';
    btn.style.borderColor = '#38b2ac';
  } else {
    container.style.display = 'none';
    btn.textContent = ' Show Video Preview';
    btn.style.borderColor = '#48bb78';
  }
}

/**
 * Calculate pronunciation drill streak
 */
function calculatePronDrillStreak() {
  let streak = 0;
  let checkDate = new Date();
  checkDate.setHours(0, 0, 0, 0);

  for (let i = 0; i < 365; i++) {
    const activity = getDayPronActivity(checkDate);

    if (activity.practiced) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else if (i === 0) {
      checkDate.setDate(checkDate.getDate() - 1);
    } else {
      break;
    }
  }

  return streak;
}

/**
 * Calculate monthly pronunciation stats
 */
function calculateMonthlyPronStats(year, month) {
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);

  let practiceDays = 0;
  let completedDrills = 0;
  let totalProductions = 0;

  for (let day = 1; day <= lastDay.getDate(); day++) {
    const date = new Date(year, month, day);
    const activity = getDayPronActivity(date);
    if (activity.practiced) {
      practiceDays++;
      completedDrills += activity.count;
    }
  }

  totalProductions = completedDrills * 20 * 4; // Average 4 reps

  return { practiceDays, completedDrills, totalProductions };
}

/**
 * Change calendar month
 */
function changePronCalendarMonth(delta) {
  currentPronCalendarMonth += delta;

  if (currentPronCalendarMonth > 11) {
    currentPronCalendarMonth = 0;
    currentPronCalendarYear++;
  } else if (currentPronCalendarMonth < 0) {
    currentPronCalendarMonth = 11;
    currentPronCalendarYear--;
  }

  renderPronunciationCalendar();
}

/**
 * Show detail for a specific day
 */
function showPronDayDetail(year, month, day) {
  const date = new Date(year, month, day);
  const activity = getDayPronActivity(date);

  if (activity.activities.length === 0) {
    return; // No activity to show
  }

  const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

  let detailHtml = `
    <h4 style="margin-bottom: 15px;">${dateStr}</h4>
    <div style="display: grid; gap: 10px;">
  `;

  activity.activities.forEach(act => {
    const levelColor = act.level === 2 ? '#9f7aea' : '#667eea';
    detailHtml += `
      <div style="background: #f7fafc; padding: 12px; border-radius: 8px; border-left: 4px solid ${levelColor};">
        <div style="font-weight: 600; color: #2d3748;">${act.topic}</div>
        <div style="font-size: 13px; color: #718096;">
          ${act.level === 2 ? ' Level 2' : ' Level 1'}  Day ${act.day}/7 ${act.isComplete ? '' : ''}
        </div>
      </div>
    `;
  });

  detailHtml += '</div>';

  alert(`${dateStr}\n\n${activity.activities.length} drill(s) practiced:\n${activity.activities.map(a => ` ${a.topic} (Day ${a.day}/7)`).join('\n')}`);
}

/**
 * Render recent pronunciation activity
 */
function renderRecentPronActivity() {
  const recentActivity = pronDrillHistory.filter(h => h.type !== 'started').slice(0, 10);

  if (recentActivity.length === 0) {
    return `
      <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center; color: #718096;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <p>No recent activity. Start practicing your drills!</p>
      </div>
    `;
  }

  return `
    <div style="display: grid; gap: 10px;">
      ${recentActivity.map(act => {
        const levelColor = act.level === 2 ? '#9f7aea' : '#667eea';
        const levelBg = act.level === 2 ? '#faf5ff' : '#f0f5ff';
        const dateStr = act.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timeStr = act.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        return `
          <div style="background: ${levelBg}; padding: 12px 15px; border-radius: 8px; border-left: 4px solid ${levelColor}; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #2d3748;">${act.topic}</div>
              <div style="font-size: 12px; color: #718096;">
                ${act.level === 2 ? ' Level 2' : ' Level 1'}  Day ${act.day}/7 ${act.isComplete ? ' Complete!' : ''}
              </div>
            </div>
            <div style="text-align: right; font-size: 12px; color: #a0aec0;">
              ${dateStr}<br>${timeStr}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Render completed 7-day cycles
 */
function renderCompletedPronCycles() {
  const completedCards = pronunciationDrillCards.filter(c => c.isComplete);

  if (completedCards.length === 0) {
    return `
      <div style="background: #f0fff4; padding: 20px; border-radius: 12px; text-align: center; color: #276749;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <p>Complete 7 days of practice to earn your first badge!</p>
      </div>
    `;
  }

  return `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      ${completedCards.map(card => {
        const levelColor = card.level === 2 ? '#9f7aea' : '#48bb78';
        const completedDate = card.completedAt ?
          (card.completedAt.toDate ? card.completedAt.toDate() : new Date(card.completedAt)) : null;
        const dateStr = completedDate ? completedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Recently';

        return `
          <div style="background: linear-gradient(135deg, ${levelColor}20 0%, ${levelColor}10 100%);
                      padding: 15px; border-radius: 12px; border: 2px solid ${levelColor}; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 8px;"></div>
            <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">${card.topicLabel || card.topic}</div>
            <div style="font-size: 12px; color: ${levelColor};">${card.level === 2 ? ' Level 2' : ' Level 1'}</div>
            <div style="font-size: 11px; color: #718096; margin-top: 8px;">Completed ${dateStr}</div>
            <div style="font-size: 11px; color: #a0aec0;">7/7 days  Score: ${card.grade}/${card.level === 2 ? '5' : '10'}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Render pronunciation stats view
 */
async function renderPronunciationStats() {
  const container = document.getElementById('pronunciationStatsContainer');
  if (!container) return;

  await loadPronunciationDrillCards();
  await loadPronunciationDrillHistory();

  const totalCards = pronunciationDrillCards.length;
  const activeCards = pronunciationDrillCards.filter(c => !c.isComplete).length;
  const completedCards = pronunciationDrillCards.filter(c => c.isComplete).length;
  const level1Cards = pronunciationDrillCards.filter(c => !c.level || c.level === 1).length;
  const level2Cards = pronunciationDrillCards.filter(c => c.level === 2).length;

  const totalSessions = pronDrillHistory.filter(h => h.type !== 'started').length;

  const completedWithTime = pronunciationDrillCards.filter(c => c.isComplete && c.startedAt && c.completedAt);
  let avgDaysToComplete = 7;
  if (completedWithTime.length > 0) {
    const totalDays = completedWithTime.reduce((sum, card) => {
      const start = card.startedAt.toDate ? card.startedAt.toDate() : new Date(card.startedAt);
      const end = card.completedAt.toDate ? card.completedAt.toDate() : new Date(card.completedAt);
      return sum + Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    }, 0);
    avgDaysToComplete = Math.round(totalDays / completedWithTime.length);
  }

  const streak = calculatePronDrillStreak();

  const bestStreak = Math.max(streak, completedCards);

  container.innerHTML = `
    <!-- Overview Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;">${totalCards}</div>
        <div style="font-size: 13px; opacity: 0.9;">Total Drills</div>
      </div>
      <div style="background: linear-gradient(135deg, #f56565 0%, #ed8936 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;">${activeCards}</div>
        <div style="font-size: 13px; opacity: 0.9;">In Progress</div>
      </div>
      <div style="background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;">${completedCards}</div>
        <div style="font-size: 13px; opacity: 0.9;">Completed (7/7)</div>
      </div>
      <div style="background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;">${totalSessions}</div>
        <div style="font-size: 13px; opacity: 0.9;">Practice Sessions</div>
      </div>
    </div>

    <!-- Level Breakdown -->
    <h3 style="color: #2d3748; margin-bottom: 15px;"> Level Breakdown</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div style="background: #f0f5ff; padding: 20px; border-radius: 12px; border: 2px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="font-weight: 600; color: #667eea;"> Level 1</span>
          <span style="font-size: 24px; font-weight: bold; color: #667eea;">${level1Cards}</span>
        </div>
        <div style="font-size: 13px; color: #718096;">Consonant Aspirations</div>
        <div style="margin-top: 10px; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: #667eea; height: 100%; width: ${totalCards > 0 ? (level1Cards/totalCards*100) : 0}%;"></div>
        </div>
      </div>
      <div style="background: #faf5ff; padding: 20px; border-radius: 12px; border: 2px solid #9f7aea;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="font-weight: 600; color: #9f7aea;"> Level 2</span>
          <span style="font-size: 24px; font-weight: bold; color: #9f7aea;">${level2Cards}</span>
        </div>
        <div style="font-size: 13px; color: #718096;">Consonant Assimilation</div>
        <div style="margin-top: 10px; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
          <div style="background: #9f7aea; height: 100%; width: ${totalCards > 0 ? (level2Cards/totalCards*100) : 0}%;"></div>
        </div>
      </div>
    </div>

    <!-- Streak & Performance -->
    <h3 style="color: #2d3748; margin-bottom: 15px;"> Streaks & Performance</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div style="font-size: 28px; font-weight: bold; color: #f56565;">${streak}</div>
        <div style="font-size: 13px; color: #718096;">Current Streak</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div style="font-size: 28px; font-weight: bold; color: #fbbf24;">${bestStreak}</div>
        <div style="font-size: 13px; color: #718096;">Best Streak</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div style="font-size: 28px; font-weight: bold; color: #667eea;">${avgDaysToComplete}</div>
        <div style="font-size: 13px; color: #718096;">Avg Days to Complete</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div style="font-size: 28px; font-weight: bold; color: #48bb78;">${totalCards > 0 ? Math.round(completedCards/totalCards*100) : 0}%</div>
        <div style="font-size: 13px; color: #718096;">Completion Rate</div>
      </div>
    </div>

    <!-- Progress by Score -->
    <h3 style="color: #2d3748; margin-bottom: 15px;"> Drills by Original Score</h3>
    ${renderDrillsByScore()}
  `;
}

/**
 * Render drills grouped by original score
 */
function renderDrillsByScore() {
  const byScore = {};
  pronunciationDrillCards.forEach(card => {
    const score = card.grade;
    if (!byScore[score]) {
      byScore[score] = { total: 0, completed: 0 };
    }
    byScore[score].total++;
    if (card.isComplete) byScore[score].completed++;
  });

  const scores = Object.keys(byScore).sort((a, b) => a - b);

  if (scores.length === 0) {
    return `
      <div style="background: #f7fafc; padding: 20px; border-radius: 12px; text-align: center; color: #718096;">
        <p>No drill data yet.</p>
      </div>
    `;
  }

  return `
    <div style="display: grid; gap: 10px;">
      ${scores.map(score => {
        const data = byScore[score];
        const pct = Math.round(data.completed / data.total * 100);
        const color = score <= 3 ? '#f56565' : score <= 5 ? '#ed8936' : score <= 7 ? '#fbbf24' : '#48bb78';

        return `
          <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${color}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 600; color: #2d3748;">Score ${score}/10</span>
              <span style="font-size: 14px; color: #718096;">${data.completed}/${data.total} completed</span>
            </div>
            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: ${color}; height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Start a pronunciation drill session with all due cards
 */
function startPronDrillSession() {
  if (pronDrillDueCards.length === 0) {
    alert('All priority drills done for today! Great job!');
    return;
  }

  startSinglePronDrill(pronDrillDueCards[0].id);
}

/**
 * Start a single pronunciation drill
 */
function startSinglePronDrill(cardId) {
  const card = pronunciationDrillCards.find(c => c.id === cardId);
  if (!card || !card.drillWords || card.drillWords.length === 0) {
    alert('This drill has no words defined.');
    return;
  }

  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;

  const savedReps = card.completedRepetitionsToday || 0;
  const startingRep = savedReps + 1; // Continue from next rep

  pronDrillState = {
    cardId: cardId,
    currentWordIndex: 0,
    currentRepetition: startingRep,
    totalRepetitions: card.requiredRepetitions || 1,
    words: shuffleArray([...card.drillWords]),
    correctInRep: 0,
    totalCorrect: 0,
    totalAttempts: 0
  };

  const resumingMessage = savedReps > 0 ? `
    <div style="background: #f0fff4; border: 2px solid #48bb78; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px;">
      <span style="color: #276749;"> Resuming from rep ${startingRep}/${pronDrillState.totalRepetitions}</span>
    </div>
  ` : '';

  const container = document.getElementById('pronunciationDrillsContainer');
  container.innerHTML = `
    <div style="max-width: 600px; margin: 0 auto;">
      <!-- Header -->
      <div style="text-align: center; margin-bottom: 20px;">
        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 24px;">
           ${card.topic}
        </span>
        <div style="margin-top: 15px;">
          <span style="background: #fef3c7; color: #92400e; padding: 8px 16px; border-radius: 12px; font-weight: 600;">
             Day ${currentDay} of ${totalDays}
          </span>
        </div>
        ${resumingMessage}
        <p style="color: #718096; margin-top: 10px;">
          ${pronDrillState.totalRepetitions} through all words today
        </p>

        <!-- 7-Day Progress Mini -->
        <div style="display: flex; gap: 6px; justify-content: center; margin-top: 15px;">
          ${Array.from({length: totalDays}, (_, i) => {
            const dayNum = i + 1;
            const isCompleted = dayNum < currentDay;
            const isCurrent = dayNum === currentDay;
            return `
              <div style="width: 30px; height: 30px; border-radius: 50%;
                background: ${isCompleted ? '#48bb78' : isCurrent ? '#fbbf24' : '#e2e8f0'};
                display: flex; align-items: center; justify-content: center;
                font-size: 12px; font-weight: 600; color: ${isCompleted || isCurrent ? 'white' : '#a0aec0'};
                ${isCurrent ? 'box-shadow: 0 0 0 3px #f59e0b;' : ''}">
                ${isCompleted ? '' : dayNum}
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Ready Screen -->
      <div id="pronDrillReadyScreen" style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 80px; margin-bottom: 20px;"></div>
        <h3 style="color: #2d3748; margin-bottom: 15px;">Ready for Day ${currentDay}?</h3>
        <p style="color: #718096; margin-bottom: 10px;">
          You'll say <strong>${card.drillWords.length} words</strong>  <strong>${pronDrillState.totalRepetitions} times</strong> = ${card.drillWords.length * pronDrillState.totalRepetitions} total productions
        </p>
        <p style="color: #718096; margin-bottom: 25px; font-size: 14px;">
          Your microphone will be used throughout the session.
        </p>
        <button class="btn btn-secondary" onclick="beginPronDrillSession()" style="padding: 15px 40px; font-size: 18px;">
           Start Day ${currentDay} Drill
        </button>
        <button class="btn" onclick="renderPronunciationDrills()" style="margin-left: 10px; padding: 15px 30px; background: transparent; color: #718096; border: 2px solid #e2e8f0;">
          Cancel
        </button>
      </div>

      <!-- Drill Interface (hidden initially) -->
      <div id="pronDrillInterface" style="display: none;"></div>
    </div>
  `;
}

/**
 * Begin the pronunciation drill after user confirms
 */
function beginPronDrillSession() {
  startStudySession('pronunciation');

  document.getElementById('pronDrillReadyScreen').style.display = 'none';
  document.getElementById('pronDrillInterface').style.display = 'block';
  showNextPronDrillWord();
}

/**
 * Show the next word in the pronunciation drill
 */
function showNextPronDrillWord() {
  const card = pronunciationDrillCards.find(c => c.id === pronDrillState.cardId);
  const drillInterface = document.getElementById('pronDrillInterface');
  const currentDay = card?.currentDay || 1;
  const totalDays = card?.totalDays || 7;

  stopPronTimer();

  if (pronDrillState.currentWordIndex >= pronDrillState.words.length) {
    showPronRepetitionComplete();
    return;
  }

  const word = pronDrillState.words[pronDrillState.currentWordIndex];
  pronTargetWord = word;
  pronRecognizedText = '';

  drillInterface.innerHTML = `
    <div style="padding: 20px;">
      <!-- Progress -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="color: #718096;">Word ${pronDrillState.currentWordIndex + 1} / ${pronDrillState.words.length}</span>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span style="background: #fef3c7; padding: 4px 10px; border-radius: 12px; font-size: 13px; color: #92400e;">
            Day ${currentDay}/${totalDays}
          </span>
          <span style="background: #f7fafc; padding: 4px 10px; border-radius: 12px; font-size: 13px; color: #4a5568;">
            Rep ${pronDrillState.currentRepetition}/${pronDrillState.totalRepetitions}
          </span>
        </div>
      </div>

      <!-- Timer Bar -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <span style="font-size: 13px; color: #718096;"> Time remaining</span>
          <span id="pronTimerText" style="font-size: 16px; font-weight: bold; color: #667eea;">10</span>
        </div>
        <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
          <div id="pronTimerBar" style="height: 100%; width: 100%; background: linear-gradient(90deg, #48bb78 0%, #38b2ac 50%, #667eea 100%); transition: width 0.1s linear;"></div>
        </div>
      </div>

      <!-- Word Display -->
      <div style="background: white; border: 3px solid #667eea; border-radius: 16px; padding: 40px; text-align: center; margin-bottom: 20px;">
        <div style="font-size: 14px; color: #718096; margin-bottom: 15px;"> Say this word:</div>
        <div style="font-size: 56px; font-weight: bold; color: #2d3748;">${word}</div>
        <div id="pronListeningIndicator" style="margin-top: 30px;">
          <div style="width: 60px; height: 60px; background: #48bb78; border-radius: 50%; margin: 0 auto; animation: leitnerPulse 1.5s infinite;"></div>
          <div style="font-size: 14px; color: #48bb78; margin-top: 10px;"> Listening...</div>
        </div>
      </div>

      <!-- Recognition Status -->
      <div id="pronRecognitionStatus" style="text-align: center; margin: 20px 0; min-height: 60px;">
        <p style="color: #718096; font-size: 14px;">Speak the Korean word...</p>
        <p id="pronRecognizedText" style="font-size: 20px; color: #2d3748; font-weight: 600; margin-top: 10px;"></p>
      </div>

      <!-- Manual Controls -->
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button class="btn" onclick="skipPronDrillWord()" style="background: #fed7d7; color: #c53030; padding: 10px 20px;">
          Skip
        </button>
        <button class="btn" onclick="exitPronDrill()" style="background: transparent; color: #a0aec0; border: 2px solid #e2e8f0; padding: 10px 20px;">
          Exit
        </button>
      </div>
    </div>
  `;

  startPronTimer();
  if (!pronIsListening) {
    startPronRecognition(word);
  }
}

/**
 * Start pronunciation timer
 */
function startPronTimer() {
  pronTimeRemaining = 10;
  updatePronTimerDisplay();

  pronTimer = setInterval(() => {
    pronTimeRemaining -= 0.1;
    updatePronTimerDisplay();

    if (pronTimeRemaining <= 0) {
      stopPronTimer();
      pronDrillState.totalAttempts++;
      pronDrillState.currentWordIndex++;
      showNextPronDrillWord();
    }
  }, 100);
}

/**
 * Stop pronunciation timer
 */
function stopPronTimer() {
  if (pronTimer) {
    clearInterval(pronTimer);
    pronTimer = null;
  }
}

/**
 * Update timer display
 */
function updatePronTimerDisplay() {
  const timerText = document.getElementById('pronTimerText');
  const timerBar = document.getElementById('pronTimerBar');

  if (timerText) {
    timerText.textContent = Math.ceil(pronTimeRemaining);
    if (pronTimeRemaining <= 3) {
      timerText.style.color = '#f56565';
    } else if (pronTimeRemaining <= 5) {
      timerText.style.color = '#ed8936';
    } else {
      timerText.style.color = '#667eea';
    }
  }

  if (timerBar) {
    const percentage = (pronTimeRemaining / 10) * 100;
    timerBar.style.width = percentage + '%';
    if (pronTimeRemaining <= 3) {
      timerBar.style.background = '#f56565';
    } else if (pronTimeRemaining <= 5) {
      timerBar.style.background = '#ed8936';
    }
  }
}

/**
 * Start pronunciation voice recognition
 */
function startPronRecognition(targetWord) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!pronRecognition) {
    pronRecognition = new SpeechRecognition();
    pronRecognition.continuous = true;
    pronRecognition.interimResults = true;
    pronRecognition.lang = 'ko-KR';

    pronRecognition.onresult = (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }

      pronRecognizedText = transcript;
      const statusEl = document.getElementById('pronRecognizedText');
      if (statusEl) {
        statusEl.textContent = transcript;
      }

      const transcriptClean = normalizeKoreanForVoice(transcript);
      const targetClean = normalizeKoreanForVoice(pronTargetWord);

      const similarity = calculateSimilarity(transcriptClean, targetClean);
      if (similarity >= 0.90) {
        stopPronTimer();
        pronDrillState.correctInRep++;
        pronDrillState.totalCorrect++;
        pronDrillState.totalAttempts++;

        const statusDiv = document.getElementById('pronRecognitionStatus');
        if (statusDiv) {
          statusDiv.innerHTML = `<p style="color: #48bb78; font-size: 20px; font-weight: 600;"> Correct!</p>`;
        }

        speakKorean(pronTargetWord);

        setTimeout(() => {
          pronDrillState.currentWordIndex++;
          showNextPronDrillWord();
        }, 1000);
      }
    };

    pronRecognition.onerror = (event) => {
    };

    pronRecognition.onend = () => {
      if (pronIsListening && pronTimeRemaining > 0) {
        setTimeout(() => {
          if (pronIsListening && pronTimeRemaining > 0) {
            try {
              pronRecognition.start();
            } catch (e) {
            }
          }
        }, 300);
      }
    };
  }

  pronTargetWord = targetWord;

  try {
    pronRecognition.start();
    pronIsListening = true;
  } catch (e) {
  }
}

/**
 * Stop pronunciation recognition
 */
function stopPronRecognition() {
  pronIsListening = false;
  if (pronRecognition) {
    try {
      pronRecognition.stop();
    } catch (e) {}
  }
}

/**
 * Skip current pronunciation drill word
 */
function skipPronDrillWord() {
  stopPronTimer();
  pronDrillState.totalAttempts++;
  pronDrillState.currentWordIndex++;
  showNextPronDrillWord();
}

/**
 * Exit pronunciation drill (saves partial progress)
 */
function exitPronDrill() {
  stopPronTimer();
  stopPronRecognition();
  finishPronDrillAndSave(false);
}

/**
 * Show repetition complete screen
 */
function showPronRepetitionComplete() {
  stopPronRecognition();

  endStudySession();

  const card = pronunciationDrillCards.find(c => c.id === pronDrillState.cardId);
  const accuracy = pronDrillState.totalAttempts > 0
    ? Math.round((pronDrillState.correctInRep / pronDrillState.words.length) * 100)
    : 0;

  awardCoins(20, 'Pronunciation Drill');
  recordPracticeActivity('pronunciation');

  if (accuracy === 100) {
    awardCoins(20, 'Perfect Pronunciation');
  }

  const drillInterface = document.getElementById('pronDrillInterface');
  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;

  const moreRepsNeeded = pronDrillState.currentRepetition < pronDrillState.totalRepetitions;

  const isFinalDay = currentDay >= totalDays;

  drillInterface.innerHTML = `
    <div style="text-align: center; padding: 40px 20px;">
      <div style="font-size: 80px; margin-bottom: 20px;">${accuracy >= 80 ? '' : accuracy >= 60 ? '' : ''}</div>
      <h2 style="color: #2d3748; margin-bottom: 10px;">
        ${moreRepsNeeded ? `Repetition ${pronDrillState.currentRepetition} Complete!` : `Day ${currentDay} Complete!`}
      </h2>

      <div style="display: flex; justify-content: center; gap: 30px; margin: 30px 0;">
        <div style="text-align: center;">
          <div style="font-size: 36px; font-weight: bold; color: #48bb78;">${pronDrillState.correctInRep}</div>
          <div style="color: #718096;">Correct</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 36px; font-weight: bold; color: #f56565;">${pronDrillState.words.length - pronDrillState.correctInRep}</div>
          <div style="color: #718096;">Missed</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 36px; font-weight: bold; color: #667eea;">${accuracy}%</div>
          <div style="color: #718096;">Accuracy</div>
        </div>
      </div>

      ${moreRepsNeeded ? `
        ${walkAwayMode.enabled ? `
          <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
            <p style="color: #6b46c1; font-size: 14px; margin: 0;">
               <strong>Listening...</strong> Say "Yes" to continue to repetition ${pronDrillState.currentRepetition + 1}
            </p>
          </div>
        ` : `
          <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
            <p style="color: #92400e; font-size: 14px; margin: 0;">
              <strong>Keep going!</strong> ${pronDrillState.totalRepetitions - pronDrillState.currentRepetition} more repetition${pronDrillState.totalRepetitions - pronDrillState.currentRepetition !== 1 ? 's' : ''} to complete Day ${currentDay}.
            </p>
          </div>
        `}
        <button class="btn btn-secondary" onclick="continueNextPronRepetition()" style="padding: 15px 40px; font-size: 18px;">
           Continue (Rep ${pronDrillState.currentRepetition + 1}/${pronDrillState.totalRepetitions})
        </button>
      ` : isFinalDay ? `
        <div style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #48bb78; padding: 20px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
          <div style="font-size: 50px; margin-bottom: 10px;"></div>
          <p style="color: #276749; font-size: 16px; margin: 0; font-weight: 600;">
            Congratulations! You've completed all 7 days for "${card.topic}"!
          </p>
          <p style="color: #2f855a; font-size: 14px; margin-top: 10px;">
            This drill is now finished. Great job on your pronunciation practice!
          </p>
        </div>
      ` : `
        <div style="background: #f0fff4; border: 1px solid #48bb78; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
          <p style="color: #276749; font-size: 14px; margin: 0;">
            <strong> Day ${currentDay} done!</strong> Come back tomorrow for Day ${currentDay + 1}.
            <br><span style="font-size: 13px; color: #2f855a;">${totalDays - currentDay} days remaining to complete this drill.</span>
          </p>
        </div>

        <!-- Progress visualization -->
        <div style="display: flex; gap: 8px; justify-content: center; margin: 20px 0;">
          ${Array.from({length: totalDays}, (_, i) => {
            const dayNum = i + 1;
            const isCompleted = dayNum <= currentDay;
            return `
              <div style="width: 35px; height: 35px; border-radius: 50%;
                background: ${isCompleted ? '#48bb78' : '#e2e8f0'};
                display: flex; align-items: center; justify-content: center;
                font-size: 14px; font-weight: 600; color: ${isCompleted ? 'white' : '#a0aec0'};">
                ${isCompleted ? '' : dayNum}
              </div>
            `;
          }).join('')}
        </div>
      `}

      <div style="margin-top: 20px;">
        <button class="btn" onclick="finishPronDrillAndSave(${!moreRepsNeeded})" style="padding: 12px 30px; background: ${moreRepsNeeded ? 'transparent' : '#48bb78'}; ${moreRepsNeeded ? 'color: #718096; border: 2px solid #e2e8f0;' : ''}">
          ${moreRepsNeeded ? 'Save & Exit' : ' Finish'}
        </button>
      </div>
    </div>
  `;

  if (walkAwayMode.enabled && moreRepsNeeded) {
    setTimeout(() => {
      startHandsFreeContinuation(
        () => { continueNextPronRepetition(); }, // onYes - continue to next rep
        () => {
          const statusEl = document.getElementById('handsFreeContinueStatus');
          if (statusEl) {
            statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
              No response detected. Click a button to continue.
            </p>`;
          }
        } // onNo
      );
    }, 1000);
  }
}

/**
 * Continue to next repetition
 */
function continueNextPronRepetition() {
  pronDrillState.currentRepetition++;
  pronDrillState.currentWordIndex = 0;
  pronDrillState.correctInRep = 0;
  pronDrillState.words = shuffleArray([...pronDrillState.words]); // Reshuffle

  showNextPronDrillWord();
}

/**
 * Finish pronunciation drill and save progress
 * @param {boolean} completedDay - Whether the full day was completed (all reps done)
 */
async function finishPronDrillAndSave(completedDay = false) {
  const card = pronunciationDrillCards.find(c => c.id === pronDrillState.cardId);
  if (!card) {
    renderPronunciationDrills();
    return;
  }

  const currentDay = card.currentDay || 1;
  const totalDays = card.totalDays || 7;

  try {
    const updateData = {
      totalReviews: (card.totalReviews || 0) + pronDrillState.totalAttempts,
      correctCount: (card.correctCount || 0) + pronDrillState.totalCorrect,
      completedRepetitionsToday: pronDrillState.currentRepetition
    };

    if (completedDay) {
      updateData.completedToday = true;
      updateData.lastCompletedDate = firebase.firestore.FieldValue.serverTimestamp();

      if (currentDay < totalDays) {
        updateData.currentDay = currentDay + 1;
      } else {
        updateData.isComplete = true;
        updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
      }
    }

    await db.collection('pronunciationLeitner').doc(pronDrillState.cardId).update(updateData);

    console.log('Pronunciation drill progress saved', completedDay ? `(Day ${currentDay} complete)` : '(partial)');
  } catch (error) {
  }

  stopPronRecognition();

  await loadPronunciationDrillCards();

  if (allInOneState.isActive && allInOneState.currentPhase === 'pronunciation') {
    if (pronDrillDueCards.length === 0) {
      const drillInterface = document.getElementById('pronDrillInterface');
      if (drillInterface) {
        drillInterface.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; margin-bottom: 20px;"></div>
            <h2 style="color: #10b981;">Pronunciation Phase Complete!</h2>
            <p style="color: #718096;">All pronunciation drills done!</p>

            ${walkAwayMode.enabled ? `
              <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
                <p style="color: #6b46c1; font-size: 14px; margin: 0;">
                   <strong>Listening...</strong> Say "Yes" to continue to next phase
                </p>
              </div>
            ` : ''}

            <button onclick="completeAllInOnePhase('pronunciation')" class="btn" style="margin-top: 20px; padding: 15px 40px;">Continue to Next Phase</button>
          </div>
        `;

        if (walkAwayMode.enabled) {
          setTimeout(() => {
            startHandsFreeContinuation(
              () => { completeAllInOnePhase('pronunciation'); },
              () => {
                const statusEl = document.getElementById('handsFreeContinueStatus');
                if (statusEl) {
                  statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                    No response detected. Click the button to continue.
                  </p>`;
                }
              }
            );
          }, 1000);
        }
      } else {
        completeAllInOnePhase('pronunciation');
      }
      return;
    } else {
      const drillInterface = document.getElementById('pronDrillInterface');
      if (drillInterface) {
        const nextCard = pronDrillDueCards[0];
        drillInterface.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; margin-bottom: 20px;"></div>
            <h2 style="color: #10b981;">Drill Complete!</h2>
            <p style="color: #718096;">${pronDrillDueCards.length} more pronunciation drill${pronDrillDueCards.length !== 1 ? 's' : ''} to go</p>
            <p style="color: #4299e1; font-size: 14px; margin-top: 10px;">Next: ${nextCard.topic || 'Pronunciation Drill'}</p>

            ${walkAwayMode.enabled ? `
              <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
                <p style="color: #6b46c1; font-size: 14px; margin: 0;">
                   <strong>Listening...</strong> Say "Yes" to continue to next drill
                </p>
              </div>
            ` : ''}

            <button onclick="startSinglePronDrill('${nextCard.id}')" class="btn" style="margin-top: 20px; padding: 15px 40px;">Continue to Next Drill</button>
          </div>
        `;

        if (walkAwayMode.enabled) {
          setTimeout(() => {
            startHandsFreeContinuation(
              () => { startSinglePronDrill(pronDrillDueCards[0].id); },
              () => {
                const statusEl = document.getElementById('handsFreeContinueStatus');
                if (statusEl) {
                  statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                    No response detected. Click the button to continue.
                  </p>`;
                }
              }
            );
          }, 1000);
        }
      } else {
        startSinglePronDrill(pronDrillDueCards[0].id);
      }
      return;
    }
  }

  const morePronDrillsDue = pronDrillDueCards.length > 0;

  if (morePronDrillsDue && walkAwayMode.enabled) {
    const drillInterface = document.getElementById('pronDrillInterface');
    if (drillInterface) {
      const nextCard = pronDrillDueCards[0];
      drillInterface.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 80px; margin-bottom: 20px;"></div>
          <h2 style="color: #10b981;">Drill Complete!</h2>
          <p style="color: #718096;">${pronDrillDueCards.length} more pronunciation drill${pronDrillDueCards.length !== 1 ? 's' : ''} due today</p>
          <p style="color: #4299e1; font-size: 14px; margin-top: 10px;">Next: ${nextCard.topic || 'Pronunciation Drill'}</p>

          <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
            <p style="color: #6b46c1; font-size: 14px; margin: 0;">
               <strong>Listening...</strong> Say "Yes" to continue to next drill
            </p>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button id="pronContinueBtn" class="btn" style="padding: 12px 30px; background: #48bb78;">
               Next Drill (${pronDrillDueCards.length})
            </button>
            <button onclick="renderPronunciationDrills()" class="btn btn-secondary" style="padding: 12px 30px;">
              Done
            </button>
          </div>
        </div>
      `;

      const continueBtn = document.getElementById('pronContinueBtn');
      if (continueBtn) {
        continueBtn.onclick = () => startSinglePronDrill(pronDrillDueCards[0].id);
      }

      setTimeout(() => {
        startHandsFreeContinuation(
          () => { startSinglePronDrill(pronDrillDueCards[0].id); },
          () => {
            const statusEl = document.getElementById('handsFreeContinueStatus');
            if (statusEl) {
              statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                No response detected. Click a button to continue.
              </p>`;
            }
          }
        );
      }, 1000);

      return;
    }
  }

  renderPronunciationDrills();
}


let isLoadingAnalytics2Students = false;

async function loadAnalytics2() {
  try {
    const selectorDiv = document.getElementById('analytics2StudentSelector');
    const studentSelect = document.getElementById('analytics2StudentSelect');

    if (currentUserRole === 'teacher' || currentUserRole === 'admin') {
      selectorDiv.style.display = 'block';

      if (studentSelect.options.length === 1 && !isLoadingAnalytics2Students) {
        await populateAnalytics2StudentSelector();
      }

      const selectedStudentId = studentSelect.value;
      if (!selectedStudentId) {
        showNoAnalyticsData2('Please select a student to view analytics.');
        return;
      }

      await loadStudentAnalytics2(selectedStudentId);
    } else {
      selectorDiv.style.display = 'none';
      await loadStudentAnalytics2(currentUser.uid);
    }

  } catch (error) {
    showNoAnalyticsData2();
  }
}

async function populateAnalytics2StudentSelector() {
  if (isLoadingAnalytics2Students) {
    return;
  }

  isLoadingAnalytics2Students = true;

  try {
    const studentSelect = document.getElementById('analytics2StudentSelect');

    const snapshot = await db.collection('submissions2')
      .where('status', '==', 'graded')
      .get();

    if (snapshot.empty) {
      return;
    }

    const students = new Map();
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.studentId && data.studentEmail) {
        students.set(data.studentId, data.studentEmail);
      }
    });

    studentSelect.innerHTML = '<option value="">-- Choose a student --</option>';

    students.forEach((email, id) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = email;
      studentSelect.appendChild(option);
    });

  } catch (error) {
  } finally {
    isLoadingAnalytics2Students = false;
  }
}

async function loadStudentAnalytics2(studentId) {
  try {
    const snapshot = await db.collection('submissions2')
      .where('studentId', '==', studentId)
      .where('status', '==', 'graded')
      .get();


    if (snapshot.empty) {
      showNoAnalyticsData2('No graded submissions found for this student.');
      return;
    }

    const submissions = [];
    const topicScores = {};
    const testIds = new Set();

    for (const doc of snapshot.docs) {
      const submission = doc.data();
      let submissionDate = null;
      if (submission.gradedAt) {
        submissionDate = submission.gradedAt.toDate();
      } else if (submission.submittedAt) {
        submissionDate = submission.submittedAt.toDate();
      }

      if (!submissionDate) {
        continue;
      }

      if (submission.testId) {
        testIds.add(submission.testId);
      }

      console.log('Processing submission:', {
        id: doc.id,
        date: submissionDate,
        grades: submission.grades
      });

      submissions.push({
        id: doc.id,
        date: submissionDate,
        grades: submission.grades || {},
        testId: submission.testId
      });

      Object.entries(submission.grades || {}).forEach(([key, grade]) => {
        let topicName = key;
        let materialIndex = null;

        const match = key.match(/^(\d+)_(.+)$/);
        if (match) {
          materialIndex = match[1];
          topicName = match[2];
        }

        if (!topicScores[topicName]) {
          topicScores[topicName] = [];
        }

        topicScores[topicName].push({
          grade: grade,
          date: submissionDate,
          materialIndex: materialIndex,
          testId: submission.testId
        });
      });
    }

    for (const testId of testIds) {
      try {
        const testDoc = await db.collection('tests2').doc(testId).get();
        if (testDoc.exists) {
          const test = testDoc.data();

          test.materials.forEach((material, idx) => {
            material.topics.forEach(topic => {
              if (!topicScores[topic]) {
                topicScores[topic] = [];
              }

              const hasGrade = submissions.some(sub =>
                sub.testId === testId &&
                sub.grades &&
                sub.grades[`${idx}_${topic}`] !== undefined
              );

              if (!hasGrade) {
                const testSubmission = submissions.find(sub => sub.testId === testId);
                if (testSubmission) {
                  topicScores[topic].push({
                    grade: 0, // Mark as 0 for ungraded
                    date: testSubmission.date,
                    materialIndex: idx,
                    testId: testId,
                    ungraded: true // Flag to indicate this was not actually graded
                  });
                }
              }
            });
          });
        }
      } catch (error) {
      }
    }

    submissions.sort((a, b) => a.date - b.date);

    Object.keys(topicScores).forEach(topic => {
      topicScores[topic].sort((a, b) => a.date - b.date);
    });


    calculateOverallImprovement2(submissions, topicScores);
    calculateMonthlyImprovement2(topicScores);
    calculateAllTimeImprovement2(topicScores);
    generateTopicDetails2(topicScores);
    createTopicChart2(topicScores);
    createProgressChart2(submissions, topicScores);

  } catch (error) {
    showNoAnalyticsData2();
  }
}

function calculateOverallImprovement2(submissions, topicScores) {
  const overallElement = document.getElementById('overallImprovement2');
  const detailsElement = document.getElementById('overallDetails2');

  if (submissions.length < 2) {
    overallElement.textContent = 'N/A';
    detailsElement.textContent = 'Need at least 2 graded submissions';
    return;
  }

  const firstSubmission = submissions[0];
  const firstGrades = Object.values(firstSubmission.grades || {});

  const lastSubmission = submissions[submissions.length - 1];
  const lastGrades = Object.values(lastSubmission.grades || {});

  if (firstGrades.length === 0 || lastGrades.length === 0) {
    overallElement.textContent = 'N/A';
    detailsElement.textContent = 'Invalid grade data';
    return;
  }

  const firstAvg = firstGrades.reduce((a, b) => a + b, 0) / firstGrades.length;
  const lastAvg = lastGrades.reduce((a, b) => a + b, 0) / lastGrades.length;

  if (firstAvg === 0) {
    overallElement.textContent = lastAvg > 0 ? ' Improved' : 'N/A';
    detailsElement.textContent = lastAvg > 0 ? 'Started from zero and improved!' : 'No improvement data';
    overallElement.className = lastAvg > 0 ? 'summary-value positive' : 'summary-value';
    return;
  }

  const improvement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);

  overallElement.textContent = improvement > 0 ? `+${improvement}%` : `${improvement}%`;
  overallElement.className = improvement >= 0 ? 'summary-value positive' : 'summary-value negative';

  detailsElement.innerHTML = `
    First test average: ${firstAvg.toFixed(1)}/10<br>
    Latest test average: ${lastAvg.toFixed(1)}/10<br>
    Across ${submissions.length} graded tests
  `;
}

function calculateMonthlyImprovement2(topicScores) {
  const monthElement = document.getElementById('monthlyImprovement2');
  const detailsElement = document.getElementById('monthlyDetails2');

  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

  let monthlyImprovements = [];
  let hasMonthData = false;

  Object.entries(topicScores).forEach(([topic, scores]) => {
    const monthScores = scores.filter(s => s.date >= oneMonthAgo);
    if (monthScores.length >= 2) {
      hasMonthData = true;
      const firstScore = monthScores[0].grade;
      const lastScore = monthScores[monthScores.length - 1].grade;
      const improvement = firstScore === 0 ?
        (lastScore > 0 ? 100 : 0) :
        ((lastScore - firstScore) / firstScore * 100);
      monthlyImprovements.push({
        topic: topic,
        improvement: improvement,
        from: firstScore,
        to: lastScore
      });
    }
  });

  if (!hasMonthData) {
    monthElement.textContent = 'N/A';
    detailsElement.textContent = 'Not enough data in the past month';
    return;
  }

  const avgImprovement = monthlyImprovements.reduce((a, b) => a + b.improvement, 0) / monthlyImprovements.length;

  monthElement.textContent = avgImprovement > 0 ? `+${avgImprovement.toFixed(1)}%` : `${avgImprovement.toFixed(1)}%`;
  monthElement.className = avgImprovement >= 0 ? 'summary-value positive' : 'summary-value negative';

  monthlyImprovements.sort((a, b) => b.improvement - a.improvement);
  const topImprovements = monthlyImprovements.slice(0, 3);

  detailsElement.innerHTML = topImprovements.map(item =>
    `${item.topic}: ${item.improvement > 0 ? '+' : ''}${item.improvement.toFixed(1)}% (${item.from}${item.to})`
  ).join('<br>');
}

function calculateAllTimeImprovement2(topicScores) {
  const allTimeElement = document.getElementById('allTimeImprovement2');
  const detailsElement = document.getElementById('allTimeDetails2');

  let allTimeImprovements = [];

  Object.entries(topicScores).forEach(([topic, scores]) => {
    if (scores.length >= 2) {
      const firstScore = scores[0].grade;
      const lastScore = scores[scores.length - 1].grade;
      const improvement = firstScore === 0 ?
        (lastScore > 0 ? 100 : 0) :
        ((lastScore - firstScore) / firstScore * 100);
      allTimeImprovements.push({
        topic: topic,
        improvement: improvement,
        from: firstScore,
        to: lastScore,
        tests: scores.length
      });
    }
  });

  if (allTimeImprovements.length === 0) {
    allTimeElement.textContent = 'N/A';
    detailsElement.textContent = 'Not enough historical data';
    return;
  }

  const avgImprovement = allTimeImprovements.reduce((a, b) => a + b.improvement, 0) / allTimeImprovements.length;

  allTimeElement.textContent = avgImprovement > 0 ? `+${avgImprovement.toFixed(1)}%` : `${avgImprovement.toFixed(1)}%`;
  allTimeElement.className = avgImprovement >= 0 ? 'summary-value positive' : 'summary-value negative';

  allTimeImprovements.sort((a, b) => b.improvement - a.improvement);

  detailsElement.innerHTML = allTimeImprovements.slice(0, 3).map(item =>
    `${item.topic}: ${item.improvement > 0 ? '+' : ''}${item.improvement.toFixed(1)}% over ${item.tests} tests`
  ).join('<br>');
}

function generateTopicDetails2(topicScores) {
  const container = document.getElementById('topicDetailsList2');
  container.innerHTML = '';

  window.topicsData2 = [];

  Object.entries(topicScores).forEach(([topic, scores]) => {
    if (scores.length === 0) return;

    const gradedScores = scores.filter(s => !s.ungraded);
    const ungradedCount = scores.filter(s => s.ungraded).length;

    const scoresForCalc = gradedScores.length > 0 ? gradedScores : scores;

    const firstScore = scoresForCalc[0].grade;
    const lastScore = scoresForCalc[scoresForCalc.length - 1].grade;
    const avgScore = scoresForCalc.reduce((a, b) => a + b.grade, 0) / scoresForCalc.length;
    const improvement = scoresForCalc.length > 1 ? ((lastScore - firstScore) / (firstScore || 1) * 100) : 0;

    const topicCard = document.createElement('div');
    topicCard.className = 'topic-card';
    topicCard.setAttribute('data-filter', 'all');

    if (ungradedCount > 0) {
      topicCard.style.borderLeft = '4px solid #ff6b6b';
    }

    if (avgScore < 5) topicCard.setAttribute('data-filter-needs-work', 'true');
    if (avgScore >= 8) topicCard.setAttribute('data-filter-exceptional', 'true');
    if (scores[scores.length - 1].date > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
      topicCard.setAttribute('data-filter-recent', 'true');
    }

    let improvementBadge = '';
    if (scoresForCalc.length > 1) {
      const improvementClass = improvement >= 0 ? 'improvement-positive' : 'improvement-negative';
      improvementBadge = `
        <span class="${improvementClass}">
          ${improvement >= 0 ? '' : ''} ${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}%
        </span>
      `;
    }

    topicCard.innerHTML = `
      <div class="topic-header">
        <h4>${topic}</h4>
        ${improvementBadge}
      </div>
      ${ungradedCount > 0 ? `
        <div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
           ${ungradedCount} test(s) not fully graded
        </div>
      ` : ''}
      <div class="topic-stats">
        <div class="stat">
          <span class="stat-label">Average Score</span>
          <span class="stat-value" style="color: ${avgScore >= 7 ? '#48bb78' : avgScore >= 5 ? '#ed8936' : '#f56565'};">
            ${avgScore.toFixed(1)}/10
          </span>
        </div>
        <div class="stat">
          <span class="stat-label">Attempts</span>
          <span class="stat-value">${gradedScores.length > 0 ? `${gradedScores.length}/${scores.length}` : scores.length}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Progress</span>
          <span class="stat-value">${firstScore.toFixed(1)}  ${lastScore.toFixed(1)}</span>
        </div>
      </div>
      <div class="topic-progress-bar">
        <div class="progress-fill" style="width: ${(avgScore / 10) * 100}%; background: ${avgScore >= 7 ? '#48bb78' : avgScore >= 5 ? '#ed8936' : '#f56565'};"></div>
      </div>
    `;

    window.topicsData2.push({
      name: topic,
      avgScore: avgScore,
      improvement: improvement,
      attempts: scores.length,
      lastScore: lastScore,
      firstScore: firstScore,
      element: topicCard
    });

    container.appendChild(topicCard);
  });
}

function filterTopics2(filterType, event) {
  const cards = document.querySelectorAll('#topicDetailsList2 .topic-card');
  const buttons = document.querySelectorAll('#topicImprovements2 .filter-btn');

  buttons.forEach(btn => btn.classList.remove('active'));
  if (event && event.target) {
    event.target.classList.add('active');
  }

  cards.forEach(card => {
    if (filterType === 'all') {
      card.style.display = 'block';
    } else if (filterType === 'needs-work') {
      card.style.display = card.getAttribute('data-filter-needs-work') === 'true' ? 'block' : 'none';
    } else if (filterType === 'exceptional') {
      card.style.display = card.getAttribute('data-filter-exceptional') === 'true' ? 'block' : 'none';
    } else if (filterType === 'recent') {
      card.style.display = card.getAttribute('data-filter-recent') === 'true' ? 'block' : 'none';
    }
  });
}

function createTopicChart2(topicScores) {
  const canvas = document.getElementById('topicChart2');
  if (!canvas) {
    return;
  }
  const ctx = canvas.getContext('2d');

  try {
    if (window.topicChart2Instance) {
      window.topicChart2Instance.destroy();
      window.topicChart2Instance = null;
    }
  } catch (error) {
    window.topicChart2Instance = null;
  }

  const topics = Object.keys(topicScores);
  const avgScores = topics.map(topic => {
    const scores = topicScores[topic];
    return scores.reduce((a, b) => a + b.grade, 0) / scores.length;
  });

  try {
    window.topicChart2Instance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: topics,
        datasets: [{
          label: 'Average Score',
          data: avgScores,
          backgroundColor: avgScores.map(score =>
            score >= 7 ? '#48bb78' : score >= 5 ? '#ed8936' : '#f56565'
          ),
          borderColor: avgScores.map(score =>
            score >= 7 ? '#38a169' : score >= 5 ? '#dd6b20' : '#e53e3e'
          ),
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 10,
            ticks: {
              stepSize: 2
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  } catch (error) {
    window.topicChart2Instance = null;
  }
}

function createProgressChart2(submissions, topicScores) {
  const canvas = document.getElementById('progressChart2');
  if (!canvas) {
    return;
  }
  const ctx = canvas.getContext('2d');

  try {
    if (window.progressChart2Instance) {
      window.progressChart2Instance.destroy();
      window.progressChart2Instance = null;
    }
  } catch (error) {
    window.progressChart2Instance = null;
  }

  if (!submissions || submissions.length === 0) {
    canvas.parentElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>No submission data yet. Complete some tests to see your progress!</p>
      </div>
    `;
    return;
  }

  const dataPoints = submissions.map(sub => {
    const grades = Object.values(sub.grades || {});
    const avg = grades.length > 0 ? grades.reduce((a, b) => a + b, 0) / grades.length : 0;
    return {
      x: sub.date instanceof Date ? sub.date : new Date(sub.date),
      y: Math.round(avg * 10) / 10
    };
  }).filter(point => !isNaN(point.x.getTime()) && !isNaN(point.y));


  if (dataPoints.length === 0) {
    canvas.parentElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>No graded submissions yet. Complete some tests to see your progress!</p>
      </div>
    `;
    return;
  }

  try {
    window.progressChart2Instance = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Average Score',
          data: dataPoints,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: {
                day: 'MMM d'
              }
            },
            title: {
              display: true,
              text: 'Date'
            }
          },
          y: {
            beginAtZero: true,
            max: 10,
            ticks: {
              stepSize: 2
            },
            title: {
              display: true,
              text: 'Score'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  } catch (error) {
    canvas.parentElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>Error loading chart. Please refresh the page.</p>
      </div>
    `;
    window.progressChart2Instance = null;
  }
}

function showNoAnalyticsData2(message = null) {
  const container = document.querySelector('#analytics2 .analytics-container');
  const defaultMessage = 'Complete and get graded on some pronunciation tests to see your performance analytics!';
  const displayMessage = message || defaultMessage;

  container.innerHTML = `
    <div style="text-align: center; padding: 60px 20px;">
      <div style="font-size: 64px; margin-bottom: 20px;"></div>
      <h2 style="color: #2d3748; margin-bottom: 15px;">No Analytics Data Yet</h2>
      <p>${displayMessage}</p>
    </div>
  `;
}


let currentAnalyticsLevel = 1;
let level2AnalyticsData = null;

/**
 * Toggle between Level 1 and Level 2 analytics
 */
function showAnalyticsLevel(level) {
  currentAnalyticsLevel = level;

  const level1Btn = document.getElementById('analytics2Level1Btn');
  const level2Btn = document.getElementById('analytics2Level2Btn');
  const level1Section = document.getElementById('analytics2Level1Section');
  const level2Section = document.getElementById('analytics2Level2Section');

  if (level === 1) {
    level1Btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    level1Btn.style.color = 'white';
    level2Btn.style.background = '#e2e8f0';
    level2Btn.style.color = '#4a5568';
    level1Section.style.display = 'block';
    level2Section.style.display = 'none';
  } else {
    level1Btn.style.background = '#e2e8f0';
    level1Btn.style.color = '#4a5568';
    level2Btn.style.background = 'linear-gradient(135deg, #9f7aea 0%, #667eea 100%)';
    level2Btn.style.color = 'white';
    level1Section.style.display = 'none';
    level2Section.style.display = 'block';

    loadLevel2Analytics();
  }
}

/**
 * Load Level 2 Consonant Assimilation analytics
 */
async function loadLevel2Analytics() {
  try {
    let studentId;
    if (currentUserRole === 'teacher' || currentUserRole === 'admin') {
      const studentSelect = document.getElementById('analytics2StudentSelect');
      studentId = studentSelect ? studentSelect.value : null;
      if (!studentId) {
        showNoLevel2AnalyticsData('Please select a student to view Level 2 analytics.');
        return;
      }
    } else {
      studentId = currentUser.uid;
    }

    const snapshot = await db.collection('submissions2')
      .where('studentId', '==', studentId)
      .where('status', '==', 'graded')
      .get();

    if (snapshot.empty) {
      showNoLevel2AnalyticsData('No Level 2 grading data found for this student.');
      return;
    }

    const ruleScores = {};
    let hasLevel2Data = false;

    for (const doc of snapshot.docs) {
      const submission = doc.data();

      if (submission.level2Grades) {
        hasLevel2Data = true;
        const gradedAt = submission.level2GradedAt ? submission.level2GradedAt.toDate() : (submission.gradedAt ? submission.gradedAt.toDate() : new Date());

        Object.entries(submission.level2Grades).forEach(([ruleId, grade]) => {
          if (!ruleScores[ruleId]) {
            ruleScores[ruleId] = [];
          }
          ruleScores[ruleId].push({
            grade: grade,
            date: gradedAt
          });
        });
      }
    }

    if (!hasLevel2Data) {
      showNoLevel2AnalyticsData('This student has not been graded on Level 2 (Consonant Assimilation) yet.');
      return;
    }

    level2AnalyticsData = ruleScores;

    calculateLevel2Stats(ruleScores);
    createLevel2RuleChart(ruleScores);
    createLevel2CategoryChart(ruleScores);
    generateLevel2RuleDetails(ruleScores);

  } catch (error) {
    showNoLevel2AnalyticsData('Error loading Level 2 analytics: ' + error.message);
  }
}

/**
 * Calculate Level 2 summary stats
 */
function calculateLevel2Stats(ruleScores) {
  const overallElement = document.getElementById('level2OverallScore');
  const overallDetailsElement = document.getElementById('level2OverallDetails');
  const masteredElement = document.getElementById('level2RulesMastered');
  const masteredDetailsElement = document.getElementById('level2MasteredDetails');
  const practiceElement = document.getElementById('level2NeedsPractice');
  const practiceDetailsElement = document.getElementById('level2PracticeDetails');

  const latestScores = {};
  Object.entries(ruleScores).forEach(([ruleId, scores]) => {
    if (scores.length > 0) {
      const sorted = [...scores].sort((a, b) => b.date - a.date);
      latestScores[ruleId] = sorted[0].grade;
    }
  });

  const allScores = Object.values(latestScores);

  if (allScores.length === 0) {
    overallElement.textContent = '-';
    masteredElement.textContent = '0';
    practiceElement.textContent = '0';
    return;
  }

  const avgScore = allScores.reduce((a, b) => a + b, 0) / allScores.length;
  overallElement.textContent = avgScore.toFixed(1) + '/4';
  overallElement.style.color = avgScore >= 3.5 ? '#48bb78' : avgScore >= 2.5 ? '#ed8936' : '#f56565';
  overallDetailsElement.textContent = `Based on ${allScores.length} graded rules`;

  const mastered = allScores.filter(s => s === 4).length;
  masteredElement.textContent = mastered + '/22';
  masteredElement.style.color = mastered >= 15 ? '#48bb78' : mastered >= 10 ? '#ed8936' : '#f56565';
  masteredDetailsElement.textContent = mastered > 0 ? `${Math.round(mastered/22*100)}% mastered` : 'No rules mastered yet';

  const needsPractice = allScores.filter(s => s < 4).length;
  practiceElement.textContent = needsPractice;
  practiceElement.style.color = needsPractice > 10 ? '#f56565' : needsPractice > 5 ? '#ed8936' : '#48bb78';
  practiceDetailsElement.textContent = needsPractice > 0 ? `${needsPractice} rules need more practice` : 'All rules mastered!';
}

/**
 * Create Level 2 rule performance chart
 */
function createLevel2RuleChart(ruleScores) {
  const canvas = document.getElementById('level2RuleChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (window.level2RuleChartInstance) {
    window.level2RuleChartInstance.destroy();
  }

  const latestScores = {};
  Object.entries(ruleScores).forEach(([ruleId, scores]) => {
    if (scores.length > 0) {
      const sorted = [...scores].sort((a, b) => b.date - a.date);
      latestScores[ruleId] = sorted[0].grade;
    }
  });

  const labels = [];
  const data = [];
  const colors = [];

  CONSONANT_ASSIMILATION_RULES.forEach(rule => {
    const score = latestScores[rule.id] || 0;
    labels.push(`#${rule.id}`);
    data.push(score);

    if (score === 5) colors.push('#48bb78');
    else if (score >= 4) colors.push('#68d391');
    else if (score >= 3) colors.push('#ed8936');
    else if (score >= 2) colors.push('#fc8181');
    else if (score >= 1) colors.push('#f56565');
    else colors.push('#e2e8f0');
  });

  window.level2RuleChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Score',
        data: data,
        backgroundColor: colors,
        borderColor: colors.map(c => c === '#e2e8f0' ? '#cbd5e0' : c),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 5,
          ticks: {
            stepSize: 1
          },
          title: {
            display: true,
            text: 'Score (1-5)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Rule Number'
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              const ruleId = parseInt(context[0].label.replace('#', ''));
              const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id === ruleId);
              return rule ? rule.rule : `Rule ${ruleId}`;
            },
            label: function(context) {
              return `Score: ${context.raw}/5`;
            }
          }
        }
      }
    }
  });
}

/**
 * Create Level 2 category chart (grouped by assimilation type)
 */
function createLevel2CategoryChart(ruleScores) {
  const canvas = document.getElementById('level2CategoryChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (window.level2CategoryChartInstance) {
    window.level2CategoryChartInstance.destroy();
  }

  const latestScores = {};
  Object.entries(ruleScores).forEach(([ruleId, scores]) => {
    if (scores.length > 0) {
      const sorted = [...scores].sort((a, b) => b.date - a.date);
      latestScores[ruleId] = sorted[0].grade;
    }
  });

  const categories = {
    'Nasalization': [1, 5, 11, 13, 15, 16, 20],
    'Lateralization': [3, 4],
    'Liquid + Nasal': [2, 6, 10, 17],
    'Palatalization': [7, 8, 9],
    'Aspiration': [14, 18, 19, 21],
    'Other': [12, 22]
  };

  const categoryScores = {};
  Object.entries(categories).forEach(([category, ruleIds]) => {
    const scores = ruleIds.map(id => latestScores[id] || 0).filter(s => s > 0);
    categoryScores[category] = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
  });

  const labels = Object.keys(categoryScores);
  const data = Object.values(categoryScores);
  const colors = data.map(score => {
    if (score >= 4.5) return '#48bb78';
    else if (score >= 3.5) return '#68d391';
    else if (score >= 2.5) return '#ed8936';
    else if (score >= 1.5) return '#fc8181';
    else if (score > 0) return '#f56565';
    else return '#e2e8f0';
  });

  window.level2CategoryChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw.toFixed(1)}/5`;
            }
          }
        }
      }
    }
  });
}

/**
 * Generate Level 2 rule details
 */
function generateLevel2RuleDetails(ruleScores) {
  const container = document.getElementById('level2RuleDetailsList');
  if (!container) return;

  const latestScores = {};
  Object.entries(ruleScores).forEach(([ruleId, scores]) => {
    if (scores.length > 0) {
      const sorted = [...scores].sort((a, b) => b.date - a.date);
      latestScores[ruleId] = {
        grade: sorted[0].grade,
        date: sorted[0].date
      };
    }
  });

  let html = '';

  CONSONANT_ASSIMILATION_RULES.forEach(rule => {
    const scoreData = latestScores[rule.id];
    const score = scoreData ? scoreData.grade : 0;
    const date = scoreData ? scoreData.date : null;

    let statusClass = 'ungraded';
    let statusText = 'Not graded yet';
    let statusColor = '#e2e8f0';
    let reps = '-';

    if (score > 0) {
      if (score === 5) {
        statusClass = 'mastered';
        statusText = ' Mastered';
        statusColor = '#48bb78';
        reps = 'None needed';
      } else if (score >= 4) {
        statusClass = 'improving';
        statusText = ' Almost there';
        statusColor = '#68d391';
        reps = LEVEL2_DRILL_REPS[score] + ' per day';
      } else if (score >= 3) {
        statusClass = 'improving';
        statusText = ' Improving';
        statusColor = '#ed8936';
        reps = LEVEL2_DRILL_REPS[score] + ' per day';
      } else {
        statusClass = 'needs-work';
        statusText = ' Needs work';
        statusColor = '#f56565';
        reps = LEVEL2_DRILL_REPS[score] + ' per day';
      }
    }

    html += `
      <div class="topic-detail-card level2-rule-card" data-status="${statusClass}" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
          <div style="flex: 1; min-width: 200px;">
            <div style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 5px;">
              <span style="color: #9f7aea;">#${rule.id}</span> ${rule.rule}
            </div>
            <div style="font-size: 13px; color: #718096;">
              <strong>Example:</strong> ${rule.example}  <em>${rule.description}</em>
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 24px; font-weight: bold; color: ${statusColor};">
              ${score > 0 ? score + '/5' : '-'}
            </div>
            <div style="font-size: 12px; color: ${statusColor};">${statusText}</div>
            ${score > 0 && score < 5 ? `<div style="font-size: 11px; color: #805ad5; margin-top: 4px;">Drills: ${reps}</div>` : ''}
            ${date ? `<div style="font-size: 11px; color: #a0aec0; margin-top: 4px;">${date.toLocaleDateString()}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

/**
 * Filter Level 2 rule cards
 */
function filterLevel2Rules(filterType, event) {
  const buttons = event.target.parentElement.querySelectorAll('.filter-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  const cards = document.querySelectorAll('.level2-rule-card');
  cards.forEach(card => {
    const status = card.dataset.status;
    let show = false;

    switch (filterType) {
      case 'all':
        show = true;
        break;
      case 'needs-work':
        show = status === 'needs-work';
        break;
      case 'improving':
        show = status === 'improving';
        break;
      case 'mastered':
        show = status === 'mastered';
        break;
    }

    card.style.display = show ? 'block' : 'none';
  });
}

/**
 * Show no Level 2 analytics data message
 */
function showNoLevel2AnalyticsData(message = 'No Level 2 data available.') {
  const container = document.getElementById('analytics2Level2Section');
  if (!container) return;

  container.innerHTML = `
    <div style="text-align: center; padding: 60px 20px;">
      <div style="font-size: 64px; margin-bottom: 20px;"></div>
      <h2 style="color: #6b46c1; margin-bottom: 15px;">Level 2: Consonant Assimilation</h2>
      <p style="color: #718096;">${message}</p>
      <p style="color: #805ad5; font-size: 14px; margin-top: 15px;">
        Level 2 contains 22 consonant assimilation rules for advanced Korean pronunciation.
      </p>
    </div>
  `;
}

function initializeTab2System() {
}


/**
 * Switch between leaderboard category tabs
 */
function switchLeaderboardTab(category, context = 'teacher') {
  const prefix = context === 'student' ? 'student-' : '';

  const tabContainer = event.target.closest('.leaderboard-tabs');
  tabContainer.querySelectorAll('.leaderboard-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');

  const container = event.target.closest('.leaderboard-container');
  container.querySelectorAll('.leaderboard-section').forEach(section => section.classList.remove('active'));

  const targetSection = document.getElementById(`${prefix}leaderboard-${category}`);
  if (targetSection) {
    targetSection.classList.add('active');
  }
}

/**
 * Load all leaderboard data
 */
async function loadLeaderboardData() {
  try {
    const leitnerStatsSnapshot = await db.collection('leitnerStats').get();
    const leitnerStats = [];
    leitnerStatsSnapshot.forEach(doc => {
      leitnerStats.push({ id: doc.id, ...doc.data() });
    });

    const masteryDeckSnapshot = await db.collection('masteryDeck').get();
    const masteryByStudent = {};
    masteryDeckSnapshot.forEach(doc => {
      const data = doc.data();
      const studentId = data.studentId;
      if (!masteryByStudent[studentId]) {
        masteryByStudent[studentId] = 0;
      }
      masteryByStudent[studentId]++;
    });

    const usersSnapshot = await db.collection('users').get();
    const users = {};
    usersSnapshot.forEach(doc => {
      users[doc.id] = doc.data();
    });

    const testSubmissionsSnapshot = await db.collection('submissions')
      .where('status', '==', 'graded')
      .get();
    const testSubmissions = [];
    testSubmissionsSnapshot.forEach(doc => {
      testSubmissions.push({ id: doc.id, ...doc.data() });
    });

    const pronSubmissionsSnapshot = await db.collection('submissions2')
      .where('status', '==', 'graded')
      .get();
    const pronSubmissions = [];
    pronSubmissionsSnapshot.forEach(doc => {
      pronSubmissions.push({ id: doc.id, ...doc.data() });
    });

    console.log(`Leaderboard: ${leitnerStats.length} Leitner stats, ${Object.keys(masteryByStudent).length} students with mastery, ${testSubmissions.length} test submissions, ${pronSubmissions.length} pronunciation submissions`);

    displayPracticeStreakLeaderboard(leitnerStats, users);
    displayWordsMasteredLeaderboard(leitnerStats, users, masteryByStudent);
    displayFlashcardImprovementLeaderboard(leitnerStats, users, masteryByStudent);
    displayFlashcardOverallLeaderboard(leitnerStats, users, masteryByStudent);
    displayPronunciationLeaderboards(pronSubmissions, users);
    displayTestLeaderboards(testSubmissions, users);
    displayCombinedOverallLeaderboard(leitnerStats, pronSubmissions, users, masteryByStudent);

  } catch (error) {
  }
}

/**
 * Display practice streak leaderboard
 */
function displayPracticeStreakLeaderboard(stats, users) {
  const sorted = [...stats]
    .filter(s => s.currentStreak > 0 || s.longestStreak > 0)
    .sort((a, b) => {
      if (b.currentStreak !== a.currentStreak) return b.currentStreak - a.currentStreak;
      return b.longestStreak - a.longestStreak;
    })
    .slice(0, 30);

  const listHtml = generateLeaderboardList(sorted, users, (item) => ({
    score: item.currentStreak,
    label: 'day streak',
    detail: `Best: ${item.longestStreak} days | ${item.totalReviews || 0} reviews`
  }));

  updateLeaderboardList('leaderboard-practice-streak', listHtml);
  updateLeaderboardList('student-leaderboard-practice-streak', listHtml);
}

/**
 * Display words mastered leaderboard
 */
function displayWordsMasteredLeaderboard(stats, users, masteryByStudent = {}) {
  const allStudentIds = new Set([
    ...stats.map(s => s.id),
    ...Object.keys(masteryByStudent)
  ]);

  const combinedStats = [];
  allStudentIds.forEach(studentId => {
    const leitnerStat = stats.find(s => s.id === studentId) || {};
    const masteryCount = masteryByStudent[studentId] || 0;
    const leitnerMastered = leitnerStat.totalMastered || 0;
    const totalMastered = masteryCount + leitnerMastered;

    if (totalMastered > 0) {
      combinedStats.push({
        id: studentId,
        totalMastered: totalMastered,
        masteryDeckCount: masteryCount,
        leitnerMastered: leitnerMastered,
        totalCardsLearning: leitnerStat.totalCardsLearning || 0,
        totalCorrect: leitnerStat.totalCorrect || 0,
        totalReviews: leitnerStat.totalReviews || 0
      });
    }
  });

  const sorted = combinedStats
    .sort((a, b) => b.totalMastered - a.totalMastered)
    .slice(0, 30);

  const listHtml = generateLeaderboardList(sorted, users, (item) => ({
    score: item.totalMastered,
    label: 'words',
    detail: `${item.masteryDeckCount} game | ${item.leitnerMastered} SRS | ${item.totalCardsLearning} learning`
  }));

  updateLeaderboardList('leaderboard-words-mastered', listHtml);
  updateLeaderboardList('student-leaderboard-words-mastered', listHtml);
}

/**
 * Display flashcard improvement leaderboard
 */
function displayFlashcardImprovementLeaderboard(stats, users, masteryByStudent = {}) {
  const withImprovement = stats.map(s => {
    const masteryCount = masteryByStudent[s.id] || 0;
    const totalMastered = (s.totalMastered || 0) + masteryCount;
    const masteryRate = totalMastered / Math.max(s.totalCardsLearning + totalMastered, 1);
    const accuracy = (s.totalCorrect || 0) / Math.max(s.totalReviews, 1);
    const improvementScore = Math.round((masteryRate * 50 + accuracy * 30 + Math.min(s.currentStreak, 10) * 2) * 10) / 10;
    return { ...s, improvementScore, totalMastered, masteryCount };
  });

  const sorted = withImprovement
    .filter(s => s.improvementScore > 0)
    .sort((a, b) => b.improvementScore - a.improvementScore)
    .slice(0, 30);

  const listHtml = generateLeaderboardList(sorted, users, (item) => ({
    score: item.improvementScore,
    label: 'pts',
    detail: `${item.totalMastered || 0} mastered | ${Math.round((item.totalCorrect || 0) / Math.max(item.totalReviews, 1) * 100)}% acc`
  }));

  updateLeaderboardList('leaderboard-flashcard-improvement', listHtml);
}

/**
 * Display overall flashcard leaderboard
 */
function displayFlashcardOverallLeaderboard(stats, users, masteryByStudent = {}) {
  const withOverall = stats.map(s => {
    const masteryCount = masteryByStudent[s.id] || 0;
    const mastered = (s.totalMastered || 0) + masteryCount;
    const accuracy = (s.totalCorrect || 0) / Math.max(s.totalReviews, 1);
    const consistency = Math.min(s.longestStreak || 0, 30) / 30;
    const volume = Math.min(s.totalReviews || 0, 500) / 500;
    const overallScore = Math.round((mastered * 2 + accuracy * 30 + consistency * 15 + volume * 10) * 10) / 10;
    return { ...s, overallScore, totalMastered: mastered };
  });

  const sorted = withOverall
    .filter(s => s.overallScore > 0)
    .sort((a, b) => b.overallScore - a.overallScore)
    .slice(0, 30);

  const listHtml = generateLeaderboardList(sorted, users, (item) => ({
    score: item.overallScore,
    label: 'pts',
    detail: `${item.totalMastered || 0} mastered | ${item.longestStreak || 0} best streak`
  }));

  updateLeaderboardList('leaderboard-flashcard-overall', listHtml);
}

/**
 * Display pronunciation leaderboards (from submissions2 / Pronunciation Evaluation)
 */
function displayPronunciationLeaderboards(submissions, users) {
  const studentData = {};

  submissions.forEach(sub => {
    const studentId = sub.studentId;
    const studentEmail = sub.studentEmail;

    if (!studentData[studentId]) {
      studentData[studentId] = {
        email: studentEmail,
        allGrades: [],
        submissions: [],
        totalSubmissions: 0
      };
    }

    studentData[studentId].totalSubmissions++;

    if (sub.grades && typeof sub.grades === 'object') {
      const submissionGrades = [];
      Object.entries(sub.grades).forEach(([key, grade]) => {
        if (typeof grade === 'number' && !isNaN(grade)) {
          studentData[studentId].allGrades.push(grade);
          submissionGrades.push(grade);
        }
      });

      if (submissionGrades.length > 0) {
        const submissionAvg = submissionGrades.reduce((a, b) => a + b, 0) / submissionGrades.length;
        const submissionDate = sub.gradedAt ? sub.gradedAt.toDate() : (sub.submittedAt ? sub.submittedAt.toDate() : new Date());
        studentData[studentId].submissions.push({ avg: submissionAvg, date: submissionDate });
      }
    }
  });

  const studentAverages = Object.entries(studentData).map(([studentId, data]) => {
    const avgScore = data.allGrades.length > 0
      ? Math.round(data.allGrades.reduce((a, b) => a + b, 0) / data.allGrades.length * 10) / 10
      : 0;

    let improvement = 0;
    if (data.submissions.length >= 2) {
      data.submissions.sort((a, b) => a.date - b.date);
      const midpoint = Math.floor(data.submissions.length / 2);
      const firstHalf = data.submissions.slice(0, midpoint);
      const secondHalf = data.submissions.slice(midpoint);

      const firstAvg = firstHalf.reduce((sum, s) => sum + s.avg, 0) / firstHalf.length;
      const secondAvg = secondHalf.reduce((sum, s) => sum + s.avg, 0) / secondHalf.length;
      improvement = Math.round((secondAvg - firstAvg) * 10) / 10;
    }

    return {
      id: studentId,
      email: data.email,
      avgScore,
      totalSubmissions: data.totalSubmissions,
      totalGrades: data.allGrades.length,
      improvement
    };
  });

  const sortedAccuracy = [...studentAverages]
    .filter(s => s.avgScore > 0)
    .sort((a, b) => b.avgScore - a.avgScore)
    .slice(0, 30);

  const accuracyHtml = generateLeaderboardList(sortedAccuracy, users, (item) => ({
    score: item.avgScore,
    label: '/ 100',
    detail: `${item.totalSubmissions} tests | ${item.totalGrades} graded items`
  }), true);

  updateLeaderboardList('leaderboard-pronunciation-accuracy', accuracyHtml);
  updateLeaderboardList('student-leaderboard-pronunciation-accuracy', accuracyHtml);

  const sortedImprovement = [...studentAverages]
    .filter(s => s.totalSubmissions >= 2)
    .sort((a, b) => b.improvement - a.improvement)
    .slice(0, 30);

  const improvementHtml = generateLeaderboardList(sortedImprovement, users, (item) => ({
    score: item.improvement > 0 ? `+${item.improvement}` : item.improvement,
    label: 'pts',
    detail: `Avg: ${item.avgScore} | ${item.totalSubmissions} tests`
  }), true);

  updateLeaderboardList('leaderboard-pronunciation-improvement', improvementHtml);
}

/**
 * Display test leaderboards (from submissions / Evaluation)
 */
function displayTestLeaderboards(submissions, users) {
  const studentData = {};

  submissions.forEach(sub => {
    const studentId = sub.studentId;
    const studentEmail = sub.studentEmail;

    if (!studentData[studentId]) {
      studentData[studentId] = {
        email: studentEmail,
        allGrades: [],
        submissions: [],
        totalSubmissions: 0
      };
    }

    studentData[studentId].totalSubmissions++;

    if (sub.grades && typeof sub.grades === 'object') {
      const submissionGrades = [];
      Object.entries(sub.grades).forEach(([key, grade]) => {
        if (typeof grade === 'number' && !isNaN(grade)) {
          studentData[studentId].allGrades.push(grade);
          submissionGrades.push(grade);
        }
      });

      if (submissionGrades.length > 0) {
        const submissionAvg = submissionGrades.reduce((a, b) => a + b, 0) / submissionGrades.length;
        const submissionDate = sub.gradedAt ? sub.gradedAt.toDate() : (sub.submittedAt ? sub.submittedAt.toDate() : new Date());
        studentData[studentId].submissions.push({ avg: submissionAvg, date: submissionDate });
      }
    }
  });

  const studentAverages = Object.entries(studentData).map(([studentId, data]) => {
    const avgScore = data.allGrades.length > 0
      ? Math.round(data.allGrades.reduce((a, b) => a + b, 0) / data.allGrades.length * 10) / 10
      : 0;

    let improvement = 0;
    if (data.submissions.length >= 2) {
      data.submissions.sort((a, b) => a.date - b.date);
      const midpoint = Math.floor(data.submissions.length / 2);
      const firstHalf = data.submissions.slice(0, midpoint);
      const secondHalf = data.submissions.slice(midpoint);

      const firstAvg = firstHalf.reduce((sum, s) => sum + s.avg, 0) / firstHalf.length;
      const secondAvg = secondHalf.reduce((sum, s) => sum + s.avg, 0) / secondHalf.length;
      improvement = Math.round((secondAvg - firstAvg) * 10) / 10;
    }

    return {
      id: studentId,
      email: data.email,
      avgScore,
      totalSubmissions: data.totalSubmissions,
      totalGrades: data.allGrades.length,
      improvement
    };
  });

  const sortedScores = [...studentAverages]
    .filter(s => s.avgScore > 0)
    .sort((a, b) => b.avgScore - a.avgScore)
    .slice(0, 30);

  const scoresHtml = generateLeaderboardList(sortedScores, users, (item) => ({
    score: item.avgScore,
    label: '/ 100',
    detail: `${item.totalSubmissions} tests | ${item.totalGrades} graded topics`
  }), true);

  updateLeaderboardList('leaderboard-test-scores', scoresHtml);
  updateLeaderboardList('student-leaderboard-test-scores', scoresHtml);

  const sortedImprovement = [...studentAverages]
    .filter(s => s.totalSubmissions >= 2)
    .sort((a, b) => b.improvement - a.improvement)
    .slice(0, 30);

  const improvementHtml = generateLeaderboardList(sortedImprovement, users, (item) => ({
    score: item.improvement > 0 ? `+${item.improvement}` : item.improvement,
    label: 'pts',
    detail: `Avg: ${item.avgScore} | ${item.totalSubmissions} tests`
  }), true);

  updateLeaderboardList('leaderboard-test-improvement', improvementHtml);
}

/**
 * Display combined overall leaderboard (pronunciation + flashcard)
 */
function displayCombinedOverallLeaderboard(leitnerStats, pronunciationSubmissions, users, masteryByStudent = {}) {
  const pronunciationScores = {};
  pronunciationSubmissions.forEach(sub => {
    if (!pronunciationScores[sub.studentId]) {
      pronunciationScores[sub.studentId] = { grades: [], email: sub.studentEmail };
    }
    if (sub.grades && typeof sub.grades === 'object') {
      Object.values(sub.grades).forEach(grade => {
        if (typeof grade === 'number' && !isNaN(grade)) {
          pronunciationScores[sub.studentId].grades.push(grade);
        }
      });
    }
  });

  const flashcardScores = {};
  leitnerStats.forEach(stat => {
    const masteryCount = masteryByStudent[stat.id] || 0;
    const totalMastered = (stat.totalMastered || 0) + masteryCount;
    const accuracy = (stat.totalCorrect || 0) / Math.max(stat.totalReviews, 1);
    const masteryRate = totalMastered / Math.max(stat.totalCardsLearning + totalMastered, 1);
    flashcardScores[stat.id] = {
      accuracy,
      masteryRate,
      mastered: totalMastered,
      streak: stat.longestStreak || 0
    };
  });

  Object.keys(masteryByStudent).forEach(studentId => {
    if (!flashcardScores[studentId]) {
      const masteryCount = masteryByStudent[studentId];
      flashcardScores[studentId] = {
        accuracy: 0,
        masteryRate: 1, // 100% mastery rate if only mastery deck
        mastered: masteryCount,
        streak: 0
      };
    }
  });

  const allStudentIds = new Set([
    ...Object.keys(pronunciationScores),
    ...Object.keys(flashcardScores)
  ]);

  const combined = Array.from(allStudentIds).map(studentId => {
    const pronData = pronunciationScores[studentId] || { grades: [] };
    const flashData = flashcardScores[studentId] || { accuracy: 0, masteryRate: 0, mastered: 0 };

    const pronAvg = pronData.grades.length > 0
      ? pronData.grades.reduce((a, b) => a + b, 0) / pronData.grades.length / 100
      : 0;

    const combinedScore = Math.round(
      (pronAvg * 40 + flashData.accuracy * 30 + flashData.masteryRate * 20 + Math.min(flashData.streak, 30) / 30 * 10) * 100
    ) / 10;

    return {
      id: studentId,
      email: pronData.email,
      combinedScore,
      pronAvg: Math.round(pronAvg * 100),
      flashAccuracy: Math.round(flashData.accuracy * 100),
      mastered: flashData.mastered
    };
  });

  const sorted = combined
    .filter(s => s.combinedScore > 0)
    .sort((a, b) => b.combinedScore - a.combinedScore)
    .slice(0, 30);

  const listHtml = generateLeaderboardList(sorted, users, (item) => ({
    score: item.combinedScore,
    label: 'pts',
    detail: `Pron: ${item.pronAvg}% | Flash: ${item.flashAccuracy}% | ${item.mastered} mastered`
  }), true);

  updateLeaderboardList('leaderboard-combined-overall', listHtml);
}

/**
 * Generate leaderboard list HTML
 * @param {boolean} useEmail - If true, use item.email directly instead of looking up in users
 */
function generateLeaderboardList(items, users, getScoreData, useEmail = false) {
  if (items.length === 0) {
    return '<li class="leaderboard-empty"><div class="icon"></div><p>No data yet</p></li>';
  }

  return items.map((item, index) => {
    let displayName = 'Unknown';
    let avatarHtml = '';

    const user = users[item.id] || {};

    if (useEmail && item.email) {
      displayName = item.email.split('@')[0];
    } else {
      const email = user.email || item.studentEmail || item.email || item.id || 'Unknown';
      displayName = email.split('@')[0];
    }

    if (user.avatarUrl) {
      avatarHtml = `<div class="leaderboard-avatar"><img src="${user.avatarUrl}" alt=""></div>`;
    } else if (user.avatarEmoji) {
      avatarHtml = `<div class="leaderboard-avatar">${user.avatarEmoji}</div>`;
    } else {
      const initials = displayName.substring(0, 2).toUpperCase();
      avatarHtml = `<div class="leaderboard-avatar">${initials}</div>`;
    }

    const scoreData = getScoreData(item);

    let rankClass = 'normal';
    if (index === 0) rankClass = 'gold';
    else if (index === 1) rankClass = 'silver';
    else if (index === 2) rankClass = 'bronze';

    return `
      <li class="leaderboard-item">
        <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
        ${avatarHtml}
        <div class="leaderboard-info">
          <div class="leaderboard-name">${displayName}</div>
          <div class="leaderboard-detail">${scoreData.detail}</div>
        </div>
        <div class="leaderboard-score">
          <div class="value">${scoreData.score}</div>
          <div class="label">${scoreData.label}</div>
        </div>
      </li>
    `;
  }).join('');
}

/**
 * Update a leaderboard list element
 */
function updateLeaderboardList(elementId, html) {
  const element = document.getElementById(elementId);
  if (element) {
    element.innerHTML = html;
  }
}


const BADGE_DEFINITIONS = [
  {
    id: 'vocab_gains',
    name: 'Vocab Gains',
    icon: '',
    description: 'Master Korean vocabulary',
    metric: 'wordsMastered',
    tiers: [
      { threshold: 10, tier: 'bronze', label: 'Starter Gains' },
      { threshold: 25, tier: 'silver', label: 'Building Muscle' },
      { threshold: 50, tier: 'gold', label: 'Getting Swole' },
      { threshold: 100, tier: 'platinum', label: 'Vocab Beast' },
      { threshold: 250, tier: 'diamond', label: 'Word Crusher' },
      { threshold: 500, tier: 'legendary', label: 'Vocabulary Tank' },
      { threshold: 1000, tier: 'mythic', label: 'Lexicon Legend' },
      { threshold: 2500, tier: 'transcendent', label: 'Word God' },
      { threshold: 5000, tier: 'transcendent', label: 'Infinite Vocab' },
      { threshold: 10000, tier: 'transcendent', label: 'Beyond Mastery' }
    ]
  },
  {
    id: 'streak_warrior',
    name: 'Streak Warrior',
    icon: '',
    description: 'Maintain daily practice streaks',
    metric: 'currentStreak',
    tiers: [
      { threshold: 3, tier: 'bronze', label: 'Warming Up' },
      { threshold: 7, tier: 'silver', label: 'Week Warrior' },
      { threshold: 14, tier: 'gold', label: 'Fortnight Fighter' },
      { threshold: 30, tier: 'platinum', label: 'Monthly Monster' },
      { threshold: 60, tier: 'diamond', label: 'Two Month Titan' },
      { threshold: 90, tier: 'legendary', label: 'Quarter Champion' },
      { threshold: 180, tier: 'mythic', label: 'Half Year Hero' },
      { threshold: 365, tier: 'transcendent', label: 'Year of Steel' },
      { threshold: 730, tier: 'transcendent', label: 'Two Year Legend' },
      { threshold: 1000, tier: 'transcendent', label: 'Eternal Flame' }
    ]
  },
  {
    id: 'rep_counter',
    name: 'Rep Counter',
    icon: '',
    description: 'Total flashcard reviews completed',
    metric: 'totalReviews',
    tiers: [
      { threshold: 50, tier: 'bronze', label: 'First Set' },
      { threshold: 100, tier: 'silver', label: 'Warm Up Complete' },
      { threshold: 250, tier: 'gold', label: 'Getting Pumped' },
      { threshold: 500, tier: 'platinum', label: 'Heavy Lifter' },
      { threshold: 1000, tier: 'diamond', label: 'Rep Machine' },
      { threshold: 2500, tier: 'legendary', label: 'Iron Mind' },
      { threshold: 5000, tier: 'mythic', label: 'Unstoppable Force' },
      { threshold: 10000, tier: 'transcendent', label: 'Rep Deity' },
      { threshold: 25000, tier: 'transcendent', label: 'Infinite Reps' },
      { threshold: 50000, tier: 'transcendent', label: 'Beyond Counting' }
    ]
  },
  {
    id: 'accuracy_form',
    name: 'Perfect Form',
    icon: '',
    description: 'Flashcard accuracy percentage',
    metric: 'accuracy',
    tiers: [
      { threshold: 60, tier: 'bronze', label: 'Learning Form' },
      { threshold: 70, tier: 'silver', label: 'Good Posture' },
      { threshold: 80, tier: 'gold', label: 'Solid Technique' },
      { threshold: 85, tier: 'platinum', label: 'Sharp Shooter' },
      { threshold: 90, tier: 'diamond', label: 'Precision Master' },
      { threshold: 95, tier: 'legendary', label: 'Near Perfect' },
      { threshold: 98, tier: 'mythic', label: 'Flawless Form' },
      { threshold: 99, tier: 'transcendent', label: 'Perfection' }
    ]
  },
  {
    id: 'pronunciation_power',
    name: 'Voice Trainer',
    icon: '',
    description: 'Pronunciation test average score',
    metric: 'pronunciationAvg',
    tiers: [
      { threshold: 50, tier: 'bronze', label: 'Finding Voice' },
      { threshold: 60, tier: 'silver', label: 'Clear Speaker' },
      { threshold: 70, tier: 'gold', label: 'Strong Voice' },
      { threshold: 80, tier: 'platinum', label: 'Voice Power' },
      { threshold: 85, tier: 'diamond', label: 'Vocal Athlete' },
      { threshold: 90, tier: 'legendary', label: 'Voice Master' },
      { threshold: 95, tier: 'mythic', label: 'Native Sound' },
      { threshold: 98, tier: 'transcendent', label: 'Perfect Tone' }
    ]
  },
  {
    id: 'test_champion',
    name: 'Test Champion',
    icon: '',
    description: 'Tests completed',
    metric: 'testsCompleted',
    tiers: [
      { threshold: 1, tier: 'bronze', label: 'First Test' },
      { threshold: 5, tier: 'silver', label: 'Regular Tester' },
      { threshold: 10, tier: 'gold', label: 'Test Veteran' },
      { threshold: 25, tier: 'platinum', label: 'Test Warrior' },
      { threshold: 50, tier: 'diamond', label: 'Exam Expert' },
      { threshold: 100, tier: 'legendary', label: 'Test Legend' },
      { threshold: 200, tier: 'mythic', label: 'Exam Deity' },
      { threshold: 500, tier: 'transcendent', label: 'Infinite Tests' }
    ]
  },
  {
    id: 'test_score',
    name: 'Test Crusher',
    icon: '',
    description: 'Average test score',
    metric: 'testAvg',
    tiers: [
      { threshold: 50, tier: 'bronze', label: 'Passing Grade' },
      { threshold: 60, tier: 'silver', label: 'Solid Score' },
      { threshold: 70, tier: 'gold', label: 'Good Student' },
      { threshold: 80, tier: 'platinum', label: 'Honor Roll' },
      { threshold: 85, tier: 'diamond', label: 'Top Student' },
      { threshold: 90, tier: 'legendary', label: 'Elite Scorer' },
      { threshold: 95, tier: 'mythic', label: 'Test Prodigy' },
      { threshold: 98, tier: 'transcendent', label: 'Perfect Scholar' }
    ]
  },
  {
    id: 'daily_grinder',
    name: 'Daily Grinder',
    icon: '',
    description: 'Total days practiced',
    metric: 'totalDaysPracticed',
    tiers: [
      { threshold: 7, tier: 'bronze', label: 'Week One' },
      { threshold: 30, tier: 'silver', label: 'Month Strong' },
      { threshold: 60, tier: 'gold', label: 'Two Months In' },
      { threshold: 90, tier: 'platinum', label: 'Quarter Year' },
      { threshold: 180, tier: 'diamond', label: 'Half Year Grind' },
      { threshold: 365, tier: 'legendary', label: 'Year of Dedication' },
      { threshold: 500, tier: 'mythic', label: '500 Day Club' },
      { threshold: 730, tier: 'transcendent', label: 'Two Year Journey' },
      { threshold: 1000, tier: 'transcendent', label: '1000 Days Strong' }
    ]
  },
  {
    id: 'longest_streak',
    name: 'Streak Legend',
    icon: '',
    description: 'Longest streak ever achieved',
    metric: 'longestStreak',
    tiers: [
      { threshold: 7, tier: 'bronze', label: 'Week Record' },
      { threshold: 14, tier: 'silver', label: 'Two Week Best' },
      { threshold: 30, tier: 'gold', label: 'Monthly Record' },
      { threshold: 60, tier: 'platinum', label: 'Two Month Peak' },
      { threshold: 90, tier: 'diamond', label: 'Quarter Record' },
      { threshold: 180, tier: 'legendary', label: 'Half Year Peak' },
      { threshold: 365, tier: 'mythic', label: 'Year Record' },
      { threshold: 500, tier: 'transcendent', label: 'Legendary Streak' }
    ]
  },
  {
    id: 'leitner_master',
    name: 'Box Master',
    icon: '',
    description: 'Cards in highest Leitner boxes',
    metric: 'cardsInHighBoxes',
    tiers: [
      { threshold: 5, tier: 'bronze', label: 'First Mastered' },
      { threshold: 15, tier: 'silver', label: 'Growing Strong' },
      { threshold: 30, tier: 'gold', label: 'Box Builder' },
      { threshold: 50, tier: 'platinum', label: 'Retention Pro' },
      { threshold: 100, tier: 'diamond', label: 'Memory Athlete' },
      { threshold: 200, tier: 'legendary', label: 'Retention King' },
      { threshold: 500, tier: 'mythic', label: 'Memory Palace' },
      { threshold: 1000, tier: 'transcendent', label: 'Infinite Recall' }
    ]
  }
];

const XP_LEVELS = [
  { level: 1, xp: 0, title: ' Beginner', subtitle: 'Just Started' },
  { level: 2, xp: 100, title: ' Novice', subtitle: 'Finding Strength' },
  { level: 3, xp: 300, title: ' Trainee', subtitle: 'Building Foundation' },
  { level: 4, xp: 600, title: ' Amateur', subtitle: 'Getting Stronger' },
  { level: 5, xp: 1000, title: ' Intermediate', subtitle: 'Steady Progress' },
  { level: 6, xp: 1500, title: ' Advanced', subtitle: 'On Fire' },
  { level: 7, xp: 2200, title: ' Expert', subtitle: 'Diamond Mind' },
  { level: 8, xp: 3000, title: ' Master', subtitle: 'True Mastery' },
  { level: 9, xp: 4000, title: ' Champion', subtitle: 'Elite Status' },
  { level: 10, xp: 5500, title: ' Legend', subtitle: 'Legendary' },
  { level: 11, xp: 7500, title: ' Mythic', subtitle: 'Beyond Normal' },
  { level: 12, xp: 10000, title: ' Transcendent', subtitle: 'Ascended' }
];

const AVATAR_OPTIONS = [
  '', '', '', '', '', '', '', '', '', '',
  '', '', '', '', '', '', '', '', '', '',
  '', '', '', '', '', '', '', '', '', ''
];

/**
 * Load student profile data and badges
 */
async function loadStudentProfile() {
  if (!currentUser) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};

    const leitnerDoc = await db.collection('leitnerStats').doc(currentUser.uid).get();
    const leitnerStats = leitnerDoc.exists ? leitnerDoc.data() : {};

    const testSnapshot = await db.collection('submissions')
      .where('studentId', '==', currentUser.uid)
      .where('status', '==', 'graded')
      .get();

    const pronSnapshot = await db.collection('submissions2')
      .where('studentId', '==', currentUser.uid)
      .where('status', '==', 'graded')
      .get();

    const masterySnapshot = await db.collection('masteryDeck')
      .where('studentId', '==', currentUser.uid)
      .get();
    const wordsMasteredCount = masterySnapshot.size;

    const grammarMasterySnapshot = await db.collection('grammarMastery')
      .where('studentId', '==', currentUser.uid)
      .get();
    const grammarMasteredCount = grammarMasterySnapshot.size;

    const metrics = calculateProfileMetrics(leitnerStats, testSnapshot.docs, pronSnapshot.docs, wordsMasteredCount, grammarMasteredCount);

    updateProfileDisplay(userData, metrics);

    displayBadges(metrics);

  } catch (error) {
  }
}

/**
 * Calculate all profile metrics
 */
function calculateProfileMetrics(leitnerStats, testDocs, pronDocs, wordsMasteredCount = 0, grammarMasteredCount = 0) {
  const wordsMastered = wordsMasteredCount || leitnerStats.totalMastered || 0;
  const grammarMastered = grammarMasteredCount || 0;
  const currentStreak = leitnerStats.currentStreak || 0;
  const longestStreak = leitnerStats.longestStreak || 0;
  const totalReviews = leitnerStats.totalReviews || 0;
  const totalCorrect = leitnerStats.totalCorrect || 0;
  const accuracy = totalReviews > 0 ? Math.round((totalCorrect / totalReviews) * 100) : 0;
  const cardsInHighBoxes = (leitnerStats.boxCounts?.box6 || 0) + (leitnerStats.boxCounts?.box7 || 0) + (leitnerStats.boxCounts?.box8 || 0);

  const testsCompleted = testDocs.length;
  let testGrades = [];
  testDocs.forEach(doc => {
    const data = doc.data();
    if (data.grades) {
      Object.values(data.grades).forEach(g => {
        if (typeof g === 'number') testGrades.push(g);
      });
    }
  });
  const testAvg = testGrades.length > 0 ? Math.round(testGrades.reduce((a,b) => a+b, 0) / testGrades.length) : 0;

  let pronGrades = [];
  pronDocs.forEach(doc => {
    const data = doc.data();
    if (data.grades) {
      Object.values(data.grades).forEach(g => {
        if (typeof g === 'number') pronGrades.push(g);
      });
    }
  });
  const pronunciationAvg = pronGrades.length > 0 ? Math.round(pronGrades.reduce((a,b) => a+b, 0) / pronGrades.length) : 0;

  const totalDaysPracticed = Math.max(longestStreak, Math.floor(totalReviews / 10));

  const xp = calculateXP(wordsMastered, grammarMastered, totalReviews, testsCompleted, pronDocs.length, currentStreak);

  return {
    wordsMastered,
    grammarMastered,
    currentStreak,
    longestStreak,
    totalReviews,
    accuracy,
    cardsInHighBoxes,
    testsCompleted,
    testAvg,
    pronunciationAvg,
    totalDaysPracticed,
    xp
  };
}

/**
 * Calculate total XP
 */
function calculateXP(wordsMastered, grammarMastered, totalReviews, testsCompleted, pronTests, streak) {
  return (wordsMastered * 10) +
         (grammarMastered * 20) +
         (totalReviews * 1) +
         (testsCompleted * 50) +
         (pronTests * 50) +
         (streak * 5);
}

/**
 * Get level from XP
 */
function getLevelFromXP(xp) {
  let level = XP_LEVELS[0];
  for (const l of XP_LEVELS) {
    if (xp >= l.xp) level = l;
  }
  return level;
}

/**
 * Update profile display
 */
function updateProfileDisplay(userData, metrics) {
  const avatarDisplay = document.getElementById('profileAvatarDisplay');
  if (userData.avatarUrl) {
    avatarDisplay.innerHTML = `<img src="${userData.avatarUrl}" alt="Avatar">`;
  } else if (userData.avatarEmoji) {
    avatarDisplay.textContent = userData.avatarEmoji;
  } else {
    const email = currentUser.email || '';
    const initials = email.substring(0, 2).toUpperCase();
    avatarDisplay.textContent = initials;
  }

  const displayName = userData.displayName || currentUser.email?.split('@')[0] || 'Student';
  document.getElementById('profileDisplayName').textContent = displayName;
  document.getElementById('profileEmail').textContent = currentUser.email || '';

  const level = getLevelFromXP(metrics.xp);
  document.getElementById('profileLevelBadge').textContent = `${level.title}`;

  document.getElementById('profileTotalXP').textContent = metrics.xp.toLocaleString();
  document.getElementById('profileWordsMastered').textContent = metrics.wordsMastered;
  document.getElementById('profileGrammarMastered').textContent = metrics.grammarMastered || 0;
  document.getElementById('profileCurrentStreak').textContent = metrics.currentStreak;

  let badgesEarned = 0;
  BADGE_DEFINITIONS.forEach(badge => {
    const value = metrics[badge.metric] || 0;
    const earned = badge.tiers.filter(t => value >= t.threshold);
    badgesEarned += earned.length;
  });
  document.getElementById('profileBadgesEarned').textContent = badgesEarned;
}

/**
 * Display badges with progress
 */
function displayBadges(metrics) {
  const grid = document.getElementById('badgesGrid');
  if (!grid) return;

  let html = '';

  BADGE_DEFINITIONS.forEach(badge => {
    const value = metrics[badge.metric] || 0;

    let currentTier = null;
    let nextTier = badge.tiers[0];

    for (let i = 0; i < badge.tiers.length; i++) {
      if (value >= badge.tiers[i].threshold) {
        currentTier = badge.tiers[i];
        nextTier = badge.tiers[i + 1] || null;
      }
    }

    let progressPercent = 0;
    let progressText = '';

    if (currentTier && nextTier) {
      const progressRange = nextTier.threshold - currentTier.threshold;
      const currentProgress = value - currentTier.threshold;
      progressPercent = Math.min(100, (currentProgress / progressRange) * 100);
      progressText = `${value} / ${nextTier.threshold}`;
    } else if (currentTier && !nextTier) {
      progressPercent = 100;
      progressText = `${value} - MAX TIER! `;
    } else {
      progressPercent = (value / nextTier.threshold) * 100;
      progressText = `${value} / ${nextTier.threshold}`;
    }

    const tierClass = currentTier ? currentTier.tier : 'locked';
    const tierLabel = currentTier ? currentTier.label : 'Locked';
    const isLocked = !currentTier;

    html += `
      <div class="badge-card ${tierClass} ${isLocked ? 'locked' : ''}">
        <div class="badge-icon">${badge.icon}</div>
        <div class="badge-info">
          <div class="badge-name">${badge.name}</div>
          <div class="badge-tier">${isLocked ? ' Locked' : tierLabel}</div>
          <div class="badge-desc">${badge.description}</div>
          <div class="badge-progress">
            <div class="badge-progress-bar">
              <div class="badge-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="badge-progress-text">${progressText}</div>
          </div>
        </div>
      </div>
    `;
  });

  grid.innerHTML = html;
}


let studentProfileData = {
  coins: 0,
  monthlyGoal: 50,
  currentStreak: 0,
  longestStreak: 0,
  lastPracticeDate: null,
  activityOptIn: true,
  avatarUrl: null,
  totalMastered: 0,
  displayName: '',
  bio: '',
  koreanLevel: 'novice', // novice, beginner, intermediate, advanced
  favoriteKContent: '', // K-drama or K-pop
  totalVocabCards: 0,
  weeklyBoxCards: 0 // Cards in Day 4+ (weekly review)
};


/**
 * Open student profile modal when clicking on a student in Daily Activity
 */
async function openStudentProfileModal(studentId) {
  const modal = document.getElementById('studentProfileModal');
  if (!modal) return;

  document.getElementById('modalProfileName').textContent = 'Loading...';
  document.getElementById('modalProfileAvatar').innerHTML = '<div class="loading" style="width: 40px; height: 40px;"></div>';
  document.getElementById('modalProfileBio').textContent = 'Loading...';
  document.getElementById('modalProfileKContent').textContent = 'Loading...';
  document.getElementById('modalProfileCoins').textContent = '-';
  document.getElementById('modalProfileVocab').textContent = '-';
  document.getElementById('modalProfileWeekly').textContent = '-';
  document.getElementById('modalProfileMastered').textContent = '-';
  document.getElementById('modalProfileStreak').textContent = '-';

  document.getElementById('modalProfileBioSection').style.display = 'block';
  document.getElementById('modalProfileKContentSection').style.display = 'block';

  modal.style.display = 'flex';

  try {
    // Get user data
    let userData = {};
    try {
      const userDoc = await db.collection('users').doc(studentId).get();
      userData = userDoc.exists ? userDoc.data() : {};
    } catch(e) { console.log('Error fetching user:', e); }

    // Get profile data
    let profileData = {};
    try {
      const profileDoc = await db.collection('studentProfiles').doc(studentId).get();
      profileData = profileDoc.exists ? profileDoc.data() : {};
    } catch(e) { console.log('Error fetching profile:', e); }

    // Get vocab count
    let totalVocabCards = 0;
    try {
      const vocabSnapshot = await db.collection('studentFlashcards')
        .where('studentId', '==', studentId)
        .get();
      totalVocabCards = vocabSnapshot.size;
    } catch(e) { console.log('Error fetching vocab:', e); }

    // Get leitner progress - fetch all and filter client-side to avoid index issues
    let weeklyBoxCards = 0;
    let masteredCount = 0;
    try {
      const leitnerSnapshot = await db.collection('leitnerProgress')
        .where('studentId', '==', studentId)
        .get();
      leitnerSnapshot.forEach(doc => {
        const box = doc.data().box || 0;
        if (box >= 4) weeklyBoxCards++;
        if (box >= 8) masteredCount++;
      });
    } catch(e) { console.log('Error fetching leitner:', e); }

    // Get streak
    let currentStreak = 0;
    try {
      const statsDoc = await db.collection('leitnerStats').doc(studentId).get();
      if (statsDoc.exists) {
        currentStreak = statsDoc.data().currentStreak || 0;
      }
    } catch(e) { console.log('Error fetching stats:', e); }

    // Update UI with fetched data
    const displayName = userData.displayName || profileData.displayName || userData.email?.split('@')[0] || 'Student';
    document.getElementById('modalProfileName').textContent = displayName;

    const avatarEl = document.getElementById('modalProfileAvatar');
    const avatarUrl = userData.avatarUrl || userData.photoUrl || userData.photoURL || profileData.avatarUrl;
    if (avatarUrl) {
      avatarEl.innerHTML = `<img src="${avatarUrl}" alt="${displayName}" style="width: 100%; height: 100%; object-fit: cover;">`;
    } else {
      const initials = displayName.split(' ').map(s => s[0]).join('').slice(0, 2).toUpperCase();
      avatarEl.innerHTML = `<span style="font-size: 36px;">${initials || ''}</span>`;
    }

    const levelEl = document.getElementById('modalProfileLevel');
    const level = profileData.koreanLevel || 'novice';
    const levelConfig = {
      'novice': { emoji: '', label: 'Novice', bg: '#fef3c7', color: '#92400e' },
      'beginner': { emoji: '', label: 'Beginner', bg: '#dbeafe', color: '#1e40af' },
      'intermediate': { emoji: '', label: 'Intermediate', bg: '#d1fae5', color: '#065f46' },
      'advanced': { emoji: '', label: 'Advanced', bg: '#fae8ff', color: '#86198f' }
    };
    const levelInfo = levelConfig[level] || levelConfig['novice'];
    levelEl.innerHTML = `${levelInfo.emoji} ${levelInfo.label}`;
    levelEl.style.background = levelInfo.bg;
    levelEl.style.color = levelInfo.color;

    document.getElementById('modalProfileBio').textContent = profileData.bio || 'No bio yet';
    document.getElementById('modalProfileKContent').textContent = profileData.favoriteKContent || 'Not specified';

    document.getElementById('modalProfileCoins').textContent = userData.coins || profileData.coins || 0;
    document.getElementById('modalProfileVocab').textContent = totalVocabCards;
    document.getElementById('modalProfileWeekly').textContent = weeklyBoxCards;
    document.getElementById('modalProfileMastered').textContent = masteredCount;
    document.getElementById('modalProfileStreak').textContent = currentStreak;

  } catch (error) {
    console.error('Error in openStudentProfileModal:', error);
    document.getElementById('modalProfileName').textContent = 'Error loading profile';
    document.getElementById('modalProfileAvatar').innerHTML = '';
    document.getElementById('modalProfileBio').textContent = 'Could not load data';
    document.getElementById('modalProfileKContent').textContent = 'Could not load data';
  }
}

/**
 * Close student profile modal
 */
function closeStudentProfileModal() {
  const modal = document.getElementById('studentProfileModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

/**
 * Save student profile edits
 */
async function saveStudentProfileEdits() {
  if (!currentUser) return;

  const displayName = document.getElementById('editDisplayName')?.value?.trim() || '';
  const bio = document.getElementById('editBio')?.value?.trim() || '';
  const koreanLevel = document.getElementById('editKoreanLevel')?.value || 'novice';
  const favoriteKContent = document.getElementById('editFavoriteKContent')?.value?.trim() || '';

  try {
    if (displayName) {
      await db.collection('users').doc(currentUser.uid).update({
        displayName: displayName
      });
    }

    await db.collection('studentProfiles').doc(currentUser.uid).set({
      displayName: displayName,
      bio: bio,
      koreanLevel: koreanLevel,
      favoriteKContent: favoriteKContent,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    studentProfileData.displayName = displayName;
    studentProfileData.bio = bio;
    studentProfileData.koreanLevel = koreanLevel;
    studentProfileData.favoriteKContent = favoriteKContent;

    if (displayName) {
      document.getElementById('panelDisplayName').textContent = displayName;
    }

    showToast(' Profile saved!');

  } catch (error) {
    showToast(' Failed to save profile');
  }
}

/**
 * Load profile edit fields when panel opens
 */
async function loadProfileEditFields() {
  if (!currentUser) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};

    const profileDoc = await db.collection('studentProfiles').doc(currentUser.uid).get();
    const profileData = profileDoc.exists ? profileDoc.data() : {};

    const editDisplayName = document.getElementById('editDisplayName');
    const editBio = document.getElementById('editBio');
    const editKoreanLevel = document.getElementById('editKoreanLevel');
    const editFavoriteKContent = document.getElementById('editFavoriteKContent');

    if (editDisplayName) editDisplayName.value = userData.displayName || profileData.displayName || '';
    if (editBio) editBio.value = profileData.bio || '';
    if (editKoreanLevel) editKoreanLevel.value = profileData.koreanLevel || 'novice';
    if (editFavoriteKContent) editFavoriteKContent.value = profileData.favoriteKContent || '';

  } catch (error) {
  }
}

function openProfilePanel() {
  document.getElementById('profilePanelOverlay').classList.add('active');
  loadProfilePanelData();
  updateDailyCorrectionsPreview(); // Update daily corrections preview
}

function closeProfilePanel() {
  document.getElementById('profilePanelOverlay').classList.remove('active');
}

function closeProfilePanelOnOverlay(event) {
  if (event.target.id === 'profilePanelOverlay') {
    closeProfilePanel();
  }
}

async function loadProfilePanelData() {
  if (!currentUser) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};

    const profileDoc = await db.collection('studentProfiles').doc(currentUser.uid).get();
    if (profileDoc.exists) {
      studentProfileData = { ...studentProfileData, ...profileDoc.data() };
    }

    const displayName = userData.displayName || currentUser.email?.split('@')[0] || 'Student';
    document.getElementById('panelDisplayName').textContent = displayName;

    updatePanelAvatar(userData);

    document.getElementById('panelCoinsCount').textContent = studentProfileData.coins || 0;
    document.getElementById('floatingCoinsCount').textContent = studentProfileData.coins || 0;

    await updateStreakDisplay();

    await loadPanelStats();

    updateGoalsDisplay();

    await loadActivityCalendar();

    loadPanelBadges();

    await loadActivityFeed();

    document.getElementById('activityOptIn').checked = studentProfileData.activityOptIn !== false;

    await loadProfileEditFields();

  } catch (error) {
  }
}

function updatePanelAvatar(userData) {
  const panelAvatar = document.getElementById('panelAvatarDisplay');
  const floatingAvatar = document.getElementById('floatingProfileImg');

  if (userData.avatarUrl) {
    panelAvatar.innerHTML = `<img src="${userData.avatarUrl}" alt="Avatar">`;
    floatingAvatar.innerHTML = `<img src="${userData.avatarUrl}" alt="Avatar">`;
    studentProfileData.avatarUrl = userData.avatarUrl;
  } else {
    panelAvatar.innerHTML = '<span class="no-photo-large"></span>';
    floatingAvatar.innerHTML = '<span class="no-photo"></span>';
  }
}

async function updateStreakDisplay() {
  const today = new Date().toDateString();
  const lastPractice = studentProfileData.lastPracticeDate;

  if (lastPractice) {
    const lastDate = new Date(lastPractice);
    const daysDiff = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));

    if (daysDiff > 1) {
      studentProfileData.currentStreak = 0;
      await saveStudentProfile();
    }
  }

  try {
    const statsDoc = await db.collection('leitnerStats').doc(currentUser.uid).get();
    if (statsDoc.exists) {
      const leitnerStreak = statsDoc.data().currentStreak || 0;
      document.getElementById('panelStreakCount').textContent = leitnerStreak;
    } else {
      document.getElementById('panelStreakCount').textContent = studentProfileData.currentStreak || 0;
    }
  } catch(e) {
    document.getElementById('panelStreakCount').textContent = studentProfileData.currentStreak || 0;
  }
}

async function loadPanelStats() {
  if (!currentUser) return;

  try {
    const weekStart = getWeekStartEST();

    let currentStreak = 0;
    try {
      const statsDoc = await db.collection('leitnerStats').doc(currentUser.uid).get();
      if (statsDoc.exists) {
        currentStreak = statsDoc.data().currentStreak || 0;
      }
    } catch(e) {
    }
    document.getElementById('panelStreakDays').textContent = currentStreak;

    let pronDrillsThisWeek = 0;
    try {
      const pronStatsDoc = await db.collection('studentPronunciationStats').doc(currentUser.uid).get();
      if (pronStatsDoc.exists) {
        const drillLog = pronStatsDoc.data().drillLog || {};
        pronDrillsThisWeek = sumWeeklyFromLog(drillLog, weekStart);
      }
    } catch(e) {
    }
    document.getElementById('panelPronDrills').textContent = pronDrillsThisWeek;

    let leitnerRepsThisWeek = 0;

    try {
      const leitnerStatsDoc = await db.collection('leitnerStats').doc(currentUser.uid).get();
      if (leitnerStatsDoc.exists) {
        const studyLog = leitnerStatsDoc.data().studyLog || {};
        leitnerRepsThisWeek += sumWeeklyFromLog(studyLog, weekStart);
      }
    } catch(e) {}

    try {
      const myCardsStatsDoc = await db.collection('myCardsStats').doc(currentUser.uid).get();
      if (myCardsStatsDoc.exists) {
        const reviewLog = myCardsStatsDoc.data().reviewLog || {};
        leitnerRepsThisWeek += sumWeeklyFromLog(reviewLog, weekStart);
      }
    } catch(e) {}

    try {
      const studentFlashcardStatsDoc = await db.collection('studentFlashcardStats').doc(currentUser.uid).get();
      if (studentFlashcardStatsDoc.exists) {
        const reviewLog = studentFlashcardStatsDoc.data().reviewLog || {};
        leitnerRepsThisWeek += sumWeeklyFromLog(reviewLog, weekStart);
      }
    } catch(e) {}

    document.getElementById('panelLeitnerReps').textContent = leitnerRepsThisWeek;

    let totalRecordingSeconds = 0;
    try {
      const submissionsSnap = await db.collection('dailySubmissions')
        .where('studentId', '==', currentUser.uid)
        .get();

      submissionsSnap.docs.forEach(doc => {
        const data = doc.data();
        if (data.recordingDuration) {
          totalRecordingSeconds += data.recordingDuration;
        }
      });
    } catch(e) {}

    document.getElementById('panelRecordingTime').textContent = formatDuration(totalRecordingSeconds);

    studentProfileData.weeklyPronDrills = pronDrillsThisWeek;
    studentProfileData.weeklyLeitnerReps = leitnerRepsThisWeek;
    studentProfileData.totalRecordingTime = totalRecordingSeconds;
    studentProfileData.currentStreak = currentStreak;

    try {
      const masterySnapshot = await db.collection('masteryDeck')
        .where('studentId', '==', currentUser.uid)
        .get();
      studentProfileData.totalMastered = masterySnapshot.size;
    } catch(e) {
      studentProfileData.totalMastered = 0;
    }

  } catch (error) {
  }
}

function getWeekStartEST() {
  const now = new Date();

  const estOffset = -5 * 60; // EST is UTC-5 in minutes
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const estTime = new Date(utc + (estOffset * 60000));

  if (estTime.getHours() < 3) {
    estTime.setDate(estTime.getDate() - 1);
  }

  const dayOfWeek = estTime.getDay(); // 0 = Sunday, 1 = Monday
  const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

  const monday = new Date(estTime);
  monday.setDate(monday.getDate() - daysToMonday);
  monday.setHours(3, 0, 0, 0); // 3AM EST

  return monday;
}

function sumWeeklyFromLog(log, weekStart) {
  if (!log) return 0;

  let total = 0;
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 7);

  Object.entries(log).forEach(([dateStr, count]) => {
    const logDate = new Date(dateStr + 'T12:00:00'); // Noon to avoid timezone issues
    if (logDate >= weekStart && logDate < weekEnd) {
      total += count;
    }
  });

  return total;
}

function formatDuration(totalSeconds) {
  if (!totalSeconds || totalSeconds === 0) return '0:00';

  totalSeconds = Math.round(totalSeconds);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  if (hours > 0) {
    return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
  return `${minutes}:${String(seconds).padStart(2, '0')}`;
}

async function showStatDetail(statType) {
  const existingModal = document.getElementById('statDetailModal');
  if (existingModal) existingModal.remove();

  let title = '';
  let content = '';

  const weekStart = getWeekStartEST();

  switch(statType) {
    case 'streak':
      title = ' Streak Details';
      const streakData = await getStreakDetails();
      content = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; font-weight: bold; color: #f6ad55;">${streakData.current}</div>
          <div style="color: #a0aec0;">Current Streak (days)</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #ffd700;">${streakData.longest}</div>
            <div style="font-size: 12px; color: #a0aec0;">Longest Streak</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #68d391;">${streakData.totalDays}</div>
            <div style="font-size: 12px; color: #a0aec0;">Total Active Days</div>
          </div>
        </div>
        <div style="margin-top: 20px; padding: 15px; background: rgba(246, 173, 85, 0.1); border-radius: 10px; border: 1px solid rgba(246, 173, 85, 0.3);">
          <div style="font-size: 12px; color: #f6ad55;"> Keep your streak alive by completing a pronunciation drill or Leitner review each day!</div>
        </div>
      `;
      break;

    case 'pronDrills':
      title = ' Pronunciation Drills';
      const pronData = await getPronDrillDetails();
      content = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; font-weight: bold; color: #f687b3;">${pronData.thisWeek}</div>
          <div style="color: #a0aec0;">Drills This Week</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #a78bfa;">${pronData.allTime}</div>
            <div style="font-size: 12px; color: #a0aec0;">All-Time Drills</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #68d391;">${pronData.wordsTotal}</div>
            <div style="font-size: 12px; color: #a0aec0;">Words Practiced</div>
          </div>
        </div>
        <div style="margin-top: 20px; font-size: 12px; color: #718096;">
          Each drill = 20 words of pronunciation practice
        </div>
      `;
      break;

    case 'leitnerReps':
      title = ' Leitner Reps';
      const leitnerData = await getLeitnerRepsDetails();
      content = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; font-weight: bold; color: #667eea;">${leitnerData.thisWeek}</div>
          <div style="color: #a0aec0;">Reps This Week</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #a78bfa;">${leitnerData.allTime}</div>
            <div style="font-size: 12px; color: #a0aec0;">All-Time Reviews</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #ffd700;">${leitnerData.mastered}</div>
            <div style="font-size: 12px; color: #a0aec0;">Cards Mastered</div>
          </div>
        </div>
        <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
          <div style="font-size: 11px; color: #a0aec0; margin-bottom: 8px;">This week's breakdown:</div>
          <div style="display: flex; justify-content: space-around; font-size: 12px;">
            <div><span style="color: #667eea;"> Flashcard Games:</span> <span style="color: white;">${leitnerData.fromGames}</span></div>
            <div><span style="color: #48bb78;"> My Cards:</span> <span style="color: white;">${leitnerData.fromMyCards}</span></div>
          </div>
        </div>
      `;
      break;

    case 'recordingTime':
      title = ' Recording Time';
      const recordingData = await getRecordingTimeDetails();
      content = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; font-weight: bold; color: #38b2ac;">${recordingData.formatted}</div>
          <div style="color: #a0aec0;">Total Recording Time</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #68d391;">${recordingData.submissions}</div>
            <div style="font-size: 12px; color: #a0aec0;">Submissions</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #fbd38d;">${recordingData.avgDuration}</div>
            <div style="font-size: 12px; color: #a0aec0;">Avg Duration</div>
          </div>
        </div>
        <div style="margin-top: 20px; font-size: 12px; color: #718096;">
          Keep recording to improve your pronunciation! 
        </div>
      `;
      break;
  }

  const modal = document.createElement('div');
  modal.id = 'statDetailModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

  modal.innerHTML = `
    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 25px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: white; font-size: 18px;">${title}</h3>
        <button onclick="this.closest('#statDetailModal').remove()" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;"></button>
      </div>
      ${content}
    </div>
  `;

  document.body.appendChild(modal);
}

async function getStreakDetails() {
  let current = 0, longest = 0, totalDays = 0;

  try {
    const doc = await db.collection('leitnerStats').doc(currentUser.uid).get();
    if (doc.exists) {
      const data = doc.data();
      current = data.currentStreak || 0;
      longest = data.longestStreak || 0;
      totalDays = Object.keys(data.studyLog || {}).length;
    }
  } catch(e) {}

  return { current, longest, totalDays };
}

async function getPronDrillDetails() {
  let thisWeek = 0, allTime = 0, wordsTotal = 0;
  const weekStart = getWeekStartEST();

  try {
    const doc = await db.collection('studentPronunciationStats').doc(currentUser.uid).get();
    if (doc.exists) {
      const data = doc.data();
      allTime = data.totalDrillsCompleted || 0;
      wordsTotal = allTime * 20;
      thisWeek = sumWeeklyFromLog(data.drillLog || {}, weekStart);
    }
  } catch(e) {}

  return { thisWeek, allTime, wordsTotal };
}

async function getLeitnerRepsDetails() {
  let thisWeek = 0, allTime = 0, mastered = 0, fromGames = 0, fromMyCards = 0;
  const weekStart = getWeekStartEST();

  try {
    const leitnerDoc = await db.collection('leitnerStats').doc(currentUser.uid).get();
    if (leitnerDoc.exists) {
      const data = leitnerDoc.data();
      allTime += data.totalReviews || 0;
      mastered = data.totalMastered || 0;
      fromGames = sumWeeklyFromLog(data.studyLog || {}, weekStart);
      thisWeek += fromGames;
    }

    const myCardsDoc = await db.collection('myCardsStats').doc(currentUser.uid).get();
    if (myCardsDoc.exists) {
      const data = myCardsDoc.data();
      allTime += data.totalReviews || 0;
      fromMyCards = sumWeeklyFromLog(data.reviewLog || {}, weekStart);
      thisWeek += fromMyCards;
    }

    const studentDoc = await db.collection('studentFlashcardStats').doc(currentUser.uid).get();
    if (studentDoc.exists) {
      const data = studentDoc.data();
      allTime += data.totalReviews || 0;
      const studentWeekly = sumWeeklyFromLog(data.reviewLog || {}, weekStart);
      fromMyCards += studentWeekly;
      thisWeek += studentWeekly;
    }
  } catch(e) {}

  return { thisWeek, allTime, mastered, fromGames, fromMyCards };
}

async function getRecordingTimeDetails() {
  let totalSeconds = 0, submissions = 0;

  try {
    const snap = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .get();

    submissions = snap.size;
    snap.docs.forEach(doc => {
      totalSeconds += doc.data().recordingDuration || 0;
    });
  } catch(e) {}

  const avgSeconds = submissions > 0 ? Math.round(totalSeconds / submissions) : 0;

  return {
    formatted: formatDuration(totalSeconds),
    submissions,
    avgDuration: formatDuration(avgSeconds)
  };
}

function updateGoalsDisplay() {
  const goal = studentProfileData.monthlyGoal || 50;
  const current = studentProfileData.totalMastered || 0;
  const percent = Math.min(100, Math.round((current / goal) * 100));

  document.getElementById('goalsProgressFill').style.width = `${percent}%`;
  document.getElementById('goalsProgressText').textContent = `${current} / ${goal}`;
  document.getElementById('goalsPercentText').textContent = `${percent}%`;
}

function openGoalsModal() {
  document.getElementById('goalsModalOverlay').classList.add('active');
  document.getElementById('goalsInput').value = studentProfileData.monthlyGoal || 50;
  checkGoalsWarning();
}

function closeGoalsModal() {
  document.getElementById('goalsModalOverlay').classList.remove('active');
}

function checkGoalsWarning() {
  const value = parseInt(document.getElementById('goalsInput').value) || 0;
  const warning = document.getElementById('goalsWarning');
  warning.style.display = value > 500 ? 'block' : 'none';
}

async function saveGoal() {
  if (!currentUser) return;

  const goal = Math.max(50, parseInt(document.getElementById('goalsInput').value) || 50);
  studentProfileData.monthlyGoal = goal;

  await saveStudentProfile();
  updateGoalsDisplay();
  closeGoalsModal();

  showToast(' Goal saved: ' + goal + ' words/phrases per month');
}

async function loadActivityCalendar() {
  if (!currentUser) return;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();

  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendarMonthLabel').textContent = `${monthNames[month]} ${year}`;

  const startOfMonth = new Date(year, month, 1);
  const endOfMonth = new Date(year, month + 1, 0);

  try {
    const activityDoc = await db.collection('studentActivity').doc(currentUser.uid).get();
    const activityData = activityDoc.exists ? activityDoc.data() : {};
    const dailyActivity = activityData.dailyActivity || {};

    const submissionsSnapshot = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .get();

    const submissionDates = new Set();
    const gradedDates = new Set();
    submissionsSnapshot.forEach(doc => {
      const data = doc.data();
      const submitDate = data.submittedAt?.toDate?.();
      if (submitDate) {
        const dateKey = `${submitDate.getFullYear()}-${String(submitDate.getMonth() + 1).padStart(2, '0')}-${String(submitDate.getDate()).padStart(2, '0')}`;
        submissionDates.add(dateKey);
        if (data.isGraded) {
          gradedDates.add(dateKey);
        }
      }
    });

    const grid = document.getElementById('activityCalendarGrid');
    let html = '';

    const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    dayLabels.forEach(d => {
      html += `<div class="calendar-day-label">${d}</div>`;
    });

    const firstDay = startOfMonth.getDay();
    for (let i = 0; i < firstDay; i++) {
      html += '<div class="calendar-day empty"></div>';
    }

    const daysInMonth = endOfMonth.getDate();
    const today = now.getDate();

    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const activity = dailyActivity[dateKey] || 0;

      let level = 0;
      if (activity >= 10) level = 4;
      else if (activity >= 5) level = 3;
      else if (activity >= 3) level = 2;
      else if (activity >= 1) level = 1;

      const isToday = day === today ? 'today' : '';
      const hasSubmission = submissionDates.has(dateKey);
      const isGraded = gradedDates.has(dateKey);

      const dateObj = new Date(year, month, day);
      const dayOfWeek = dateObj.getDay();
      const characterUrl = typeof NOTIFICATION_CHARACTERS !== 'undefined' ? NOTIFICATION_CHARACTERS[dayOfWeek] : '';

      const clickable = hasSubmission ? `onclick="openDailyCorrectionsPage('${dateKey}')" style="cursor: pointer; position: relative;"` : 'style="position: relative;"';

      let indicator = '';
      if (isGraded && level > 0 && characterUrl) {
        indicator = `<img src="${characterUrl}" style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; object-fit: contain; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));" alt="Graded">`;
      } else if (hasSubmission) {
        indicator = `<span style="position: absolute; top: -2px; right: -2px; font-size: 8px;">${isGraded ? '' : ''}</span>`;
      }

      const border = hasSubmission ? `border: 2px solid ${isGraded ? '#48bb78' : '#f687b3'};` : '';

      html += `<div class="calendar-day level-${level} ${isToday}" data-date="${dateKey}" ${clickable} title="${dateKey}: ${activity} activities${hasSubmission ? (isGraded ? ' - Graded!' : ' - Submitted') : ''}" style="${border}"><span style="font-size: 9px; position: absolute; top: 1px; left: 2px; color: rgba(255,255,255,0.7);">${day}</span>${indicator}</div>`;
    }

    grid.innerHTML = html;

  } catch (error) {
  }
}

function loadPanelBadges() {
  const grid = document.getElementById('badgesPanelGrid');

  const badges = [
    { icon: '', name: '7-Day Streak', earned: studentProfileData.currentStreak >= 7 },
    { icon: '', name: '30-Day Streak', earned: studentProfileData.currentStreak >= 30 },
    { icon: '', name: '100 Words', earned: studentProfileData.totalMastered >= 100 },
    { icon: '', name: '500 Words', earned: studentProfileData.totalMastered >= 500 },
    { icon: '', name: '50 Phrases', earned: false }, // Will be updated
    { icon: '', name: 'Perfect Pronunciation', earned: false },
    { icon: '', name: 'Grammar Master', earned: false },
    { icon: '', name: '1000 Coins', earned: (studentProfileData.coins || 0) >= 1000 }
  ];

  grid.innerHTML = badges.map(b => `
    <div class="badge-panel-item ${b.earned ? 'earned' : 'unearned'}">
      <div class="badge-icon">${b.icon}</div>
      <div class="badge-name">${b.name}</div>
    </div>
  `).join('');
}

async function loadActivityFeed() {
  const feed = document.getElementById('activityFeed');
  if (!feed) {
    return;
  }

  try {
    const activitySnapshot = await db.collection('activityFeed')
      .orderBy('timestamp', 'desc')
      .limit(20)
      .get();


    if (activitySnapshot.empty) {
      feed.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No recent activity yet. Start practicing to see updates!</p>';
      return;
    }

    const activities = [];
    activitySnapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.optIn !== false) { // Only show if opted in
        activities.push(data);
      }
    });

    if (activities.length === 0) {
      feed.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No recent activity to show.</p>';
      return;
    }

    feed.innerHTML = activities.slice(0, 10).map(a => `
      <div class="activity-feed-item">
        <div class="activity-feed-avatar">
          ${a.avatarUrl ? `<img src="${a.avatarUrl}" alt="">` : a.initials || ''}
        </div>
        <div class="activity-feed-content">
          <div class="activity-feed-text">${a.message}</div>
          <div class="activity-feed-time">${getTimeAgo(a.timestamp)}</div>
        </div>
      </div>
    `).join('');

  } catch (error) {
    feed.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">Unable to load activity feed.</p>';
  }
}

function getTimeAgo(timestamp) {
  if (!timestamp) return '';

  const now = new Date();
  const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  const diff = Math.floor((now - time) / 1000);

  if (diff < 60) return 'Just now';
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return `${Math.floor(diff / 86400)}d ago`;
}

async function toggleActivityOptIn() {
  if (!currentUser) return;

  studentProfileData.activityOptIn = document.getElementById('activityOptIn').checked;
  await saveStudentProfile();

  showToast(studentProfileData.activityOptIn ? ' Your activity will be visible to others' : ' Your activity is now private');
}

function openAvatarUpload() {
  document.getElementById('avatarUploadInput').click();
}

async function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file || !currentUser) return;

  try {
    showToast(' Uploading avatar...');

    const storageRef = storage.ref(`avatars/${currentUser.uid}/${Date.now()}_${file.name}`);
    await storageRef.put(file);
    const avatarUrl = await storageRef.getDownloadURL();

    await db.collection('users').doc(currentUser.uid).set({
      avatarUrl: avatarUrl
    }, { merge: true });

    updatePanelAvatar({ avatarUrl });

    showToast(' Avatar updated!');

  } catch (error) {
    showToast(' Failed to upload avatar');
  }
}

async function saveStudentProfile() {
  if (!currentUser) return;

  try {
    await db.collection('studentProfiles').doc(currentUser.uid).set(studentProfileData, { merge: true });
  } catch (error) {
  }
}

async function awardCoins(amount, activity) {
  if (!currentUser) return;

  const finalAmount = swipeMode.enabled ? 1 : amount;
  studentProfileData.coins = (studentProfileData.coins || 0) + finalAmount;
  await saveStudentProfile();

  if (document.getElementById('panelCoinsCount')) {
    document.getElementById('panelCoinsCount').textContent = studentProfileData.coins;
  }
  if (document.getElementById('floatingCoinsCount')) {
    document.getElementById('floatingCoinsCount').textContent = studentProfileData.coins;
  }

  trackDailyProgress('coins', finalAmount);

  await recordActivity(`earned ${finalAmount} coins from ${activity}! `);

  showToast(` +${finalAmount} coin${finalAmount > 1 ? 's' : ''}!`);
}

/**
 * Award coins with animated popup (for per-word rewards)
 * Shows floating coin animation without toast spam
 */
function awardCoinsWithPopup(amount, showToastMsg = false) {
  if (!currentUser) return;

  const finalAmount = swipeMode.enabled ? 1 : amount;
  studentProfileData.coins = (studentProfileData.coins || 0) + finalAmount;

  if (document.getElementById('panelCoinsCount')) {
    document.getElementById('panelCoinsCount').textContent = studentProfileData.coins;
  }
  if (document.getElementById('floatingCoinsCount')) {
    document.getElementById('floatingCoinsCount').textContent = studentProfileData.coins;
  }

  trackDailyProgress('coins', finalAmount);

  showCoinPopup(finalAmount);

  playCoinSound();

  saveStudentProfile().catch(() => {});

  if (showToastMsg) {
    showToast(` +${finalAmount} coin${finalAmount > 1 ? 's' : ''}!`);
  }
}

/**
 * Show floating coin animation
 */
function showCoinPopup(amount) {
  const popup = document.createElement('div');
  popup.className = 'coin-popup-animation';
  popup.innerHTML = `
    <span style="font-size: 28px;"></span>
    <span style="font-weight: bold; color: #f6ad55;">+${amount}</span>
  `;
  popup.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #fefcbf 0%, #f6e05e 100%);
    border: 3px solid #d69e2e;
    border-radius: 50px;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    z-index: 10002;
    box-shadow: 0 4px 20px rgba(214, 158, 46, 0.4);
    animation: coinPopup 0.8s ease-out forwards;
  `;

  document.body.appendChild(popup);

  setTimeout(() => {
    if (popup.parentNode) popup.remove();
  }, 800);
}

/**
 * Play realistic coin sound effect
 */
function playCoinSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const createTone = (freq, startTime, duration, gain) => {
      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      osc.connect(gainNode);
      gainNode.connect(audioContext.destination);

      osc.frequency.value = freq;
      osc.type = 'sine';

      gainNode.gain.setValueAtTime(gain, startTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

      osc.start(startTime);
      osc.stop(startTime + duration);
    };

    const now = audioContext.currentTime;

    createTone(2400, now, 0.08, 0.15);
    createTone(3200, now, 0.06, 0.1);

    createTone(2000, now + 0.07, 0.06, 0.12);
    createTone(2800, now + 0.07, 0.05, 0.08);

    createTone(1800, now + 0.12, 0.05, 0.08);
    createTone(2600, now + 0.12, 0.04, 0.05);

    createTone(1600, now + 0.16, 0.04, 0.05);

    const shimmer = audioContext.createOscillator();
    const shimmerGain = audioContext.createGain();
    shimmer.connect(shimmerGain);
    shimmerGain.connect(audioContext.destination);
    shimmer.frequency.value = 4000;
    shimmer.type = 'sine';
    shimmerGain.gain.setValueAtTime(0.03, now);
    shimmerGain.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
    shimmer.start(now);
    shimmer.stop(now + 0.25);

  } catch (e) {
  }
}

async function recordPracticeActivity(activityType) {
  if (!currentUser) return;

  const today = new Date();
  const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  const todayStr = today.toDateString();

  try {
    const activityDoc = await db.collection('studentActivity').doc(currentUser.uid).get();
    const activityData = activityDoc.exists ? activityDoc.data() : { dailyActivity: {} };

    activityData.dailyActivity = activityData.dailyActivity || {};
    activityData.dailyActivity[dateKey] = (activityData.dailyActivity[dateKey] || 0) + 1;

    await db.collection('studentActivity').doc(currentUser.uid).set(activityData, { merge: true });

  } catch (error) {
  }

  const lastPractice = studentProfileData.lastPracticeDate;

  if (lastPractice !== todayStr) {
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (lastPractice === yesterday.toDateString()) {
      studentProfileData.currentStreak = (studentProfileData.currentStreak || 0) + 1;
    } else if (!lastPractice || new Date(lastPractice) < yesterday) {
      studentProfileData.currentStreak = 1;
    }

    if (studentProfileData.currentStreak > (studentProfileData.longestStreak || 0)) {
      studentProfileData.longestStreak = studentProfileData.currentStreak;
    }

    studentProfileData.lastPracticeDate = todayStr;
    await saveStudentProfile();
  }
}

async function recordActivity(message) {
  if (!currentUser || studentProfileData.activityOptIn === false) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};
    const displayName = userData.displayName || currentUser.email?.split('@')[0] || 'Student';

    await db.collection('activityFeed').add({
      oderId: currentUser.uid,
      displayName: displayName.split(' ')[0], // First name only
      avatarUrl: userData.avatarUrl || null,
      initials: displayName.substring(0, 2).toUpperCase(),
      message: `${displayName.split(' ')[0]} ${message}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      optIn: studentProfileData.activityOptIn
    });
  } catch (error) {
  }
}

async function initFloatingProfile() {
  if (!currentUser) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};

    const profileDoc = await db.collection('studentProfiles').doc(currentUser.uid).get();
    if (profileDoc.exists) {
      studentProfileData = { ...studentProfileData, ...profileDoc.data() };
    }

    updatePanelAvatar(userData);
    document.getElementById('floatingCoinsCount').textContent = studentProfileData.coins || 0;

  } catch (error) {
  }
}


let dailyActivityState = {
  currentScript: null,
  teacherAudioBlob: null,
  teacherVideoBlob: null,
  mediaRecorder: null,
  audioChunks: [],
  videoChunks: [],
  videoStream: null,
  generatedVocabulary: [],
  selectedSounds: [],
  gradedSounds: {},
  videoBlob: null,
  videoRecorder: null
};

const DAILY_ACTIVITY_SOUNDS = {
  consonants: [
    { char: '', name: 'giyeok' }, { char: '', name: 'ssang-giyeok' },
    { char: '', name: 'nieun' }, { char: '', name: 'digeut' },
    { char: '', name: 'ssang-digeut' }, { char: '', name: 'rieul' },
    { char: '', name: 'mieum' }, { char: '', name: 'bieup' },
    { char: '', name: 'ssang-bieup' }, { char: '', name: 'siot' },
    { char: '', name: 'ssang-siot' }, { char: '', name: 'ieung' },
    { char: '', name: 'jieut' }, { char: '', name: 'ssang-jieut' },
    { char: '', name: 'chieut' }, { char: '', name: 'kieuk' },
    { char: '', name: 'tieut' }, { char: '', name: 'pieup' },
    { char: '', name: 'hieut' }
  ],
  vowels: [
    { char: '', name: 'a' }, { char: '', name: 'ae' },
    { char: '', name: 'ya' }, { char: '', name: 'yae' },
    { char: '', name: 'eo' }, { char: '', name: 'e' },
    { char: '', name: 'yeo' }, { char: '', name: 'ye' },
    { char: '', name: 'o' }, { char: '', name: 'wa' },
    { char: '', name: 'wae' }, { char: '', name: 'oe' },
    { char: '', name: 'yo' }, { char: '', name: 'u' },
    { char: '', name: 'wo' }, { char: '', name: 'we' },
    { char: '', name: 'wi' }, { char: '', name: 'yu' },
    { char: '', name: 'eu' }, { char: '', name: 'ui' },
    { char: '', name: 'i' }
  ]
};

const DAILY_DRILL_REPS = {
  1: 1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1, 7: 1, 8: 1, 9: 1, 10: 0
};

const DAILY_DRILL_TOTAL_DAYS = 1;

async function generateDailyScript() {
  const topic = document.getElementById('dailyScriptTopic')?.value?.trim();
  if (!topic) { showToast(' Please enter a topic'); return; }

  const formalityRadio = document.querySelector('input[name="formalityLevel"]:checked');
  const formality = formalityRadio?.value || 'haeyo';

  const formalityInstructions = {
    'haeyo': 'Use  (polite informal speech) - endings like , , , etc. This is the most common conversational style.',
    'seyo': 'Use / (formal polite speech) - endings like , , , etc. This is more formal and respectful.',
    'banmal': 'Use  (informal/casual speech) - endings like , , , etc. This is used between close friends or to younger people.'
  };

  const btn = document.getElementById('generateScriptBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = ' Generating...'; }

  try {
    const prompt = `Create a Korean conversation script for language learners about: "${topic}"

REQUIREMENTS:
1. Write a dialogue between two people labeled A and B
2. Write 5-10 exchanges (each person speaks 5-10 times)
3. ${formalityInstructions[formality]}
4. Make it realistic - like an actual Korean conversation

FORMAT THE DIALOGUE EXACTLY LIKE THIS:
A: [Korean sentence]
B: [Korean sentence]
A: [Korean sentence]
B: [Korean sentence]
(continue...)

Each line MUST start with "A:" or "B:" followed by their dialogue.

IMPORTANT - After the script, you MUST provide a COMPLETE vocabulary list of ALL Korean words used in the script.

After the dialogue, add:
---VOCABULARY---
{"nouns":[{"korean":"","english":"hospital"},{"korean":"","english":"foot"}],"verbs":[{"korean":"","english":"to go"},{"korean":"","english":"to hurt"}],"adverbs":[{"korean":"","english":"quickly"},{"korean":"","english":"really"}],"adjectives":[{"korean":"","english":"painful"}],"expressions":[{"korean":"","english":"it's okay"}]}

CRITICAL: Include EVERY noun, verb, adverb, adjective, and common expression from your script. The vocabulary should have 15-30 words minimum. Do not skip any words.`;

    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. You create natural conversation scripts in A:/B: dialogue format and provide COMPREHENSIVE vocabulary lists with EVERY word from the script. Always respond in the exact format requested.' },
      { role: 'user', content: prompt }
    ], 0.7);

    const content = typeof response === 'string' ? response : JSON.stringify(response);

    const vocabSplit = content.split('---VOCABULARY---');
    const scriptText = vocabSplit[0].trim();

    document.getElementById('dailyScriptContent').value = scriptText;
    document.getElementById('generatedScriptBox').style.display = 'block';
    dailyActivityState.currentScript = scriptText;
    dailyActivityState.generatedVocabulary = { nouns: [], verbs: [], adverbs: [], adjectives: [], expressions: [] };
    dailyActivityState.formality = formality; // Store formality level

    if (vocabSplit[1]) {
      try {
        const jsonMatch = vocabSplit[1].match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          dailyActivityState.generatedVocabulary = {
            nouns: parsed.nouns || [],
            verbs: parsed.verbs || [],
            adverbs: parsed.adverbs || [],
            adjectives: parsed.adjectives || [],
            expressions: parsed.expressions || []
          };
          renderVocabPreview(dailyActivityState.generatedVocabulary);
        }
      } catch(e) { }
    }

    showToast(' Script generated!');
  } catch (error) {
    showToast(' Failed to generate script: ' + error.message);
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = ' Generate Script'; }
  }
}

function renderVocabPreview(vocabulary) {
  const container = document.getElementById('vocabPreview');
  if (!container || !vocabulary) return;

  const allWords = [
    ...(vocabulary.nouns || []).map(w => ({ ...w, type: 'noun' })),
    ...(vocabulary.verbs || []).map(w => ({ ...w, type: 'verb' })),
    ...(vocabulary.adverbs || []).map(w => ({ ...w, type: 'adverb' })),
    ...(vocabulary.adjectives || []).map(w => ({ ...w, type: 'adj' })),
    ...(vocabulary.expressions || []).map(w => ({ ...w, type: 'expr' }))
  ];

  if (allWords.length === 0) {
    container.innerHTML = '<div style="color:#718096;font-size:13px">No vocabulary extracted</div>';
    return;
  }

  const typeColors = {
    noun: '#667eea',
    verb: '#48bb78',
    adverb: '#ed8936',
    adj: '#e53e3e',
    expr: '#9f7aea'
  };

  let html = `<div style="font-size:12px;color:#718096;margin-bottom:10px"> Vocabulary Keywords (${allWords.length} words):</div><div style="display:flex;flex-wrap:wrap;gap:6px">`;

  allWords.forEach(w => {
    const color = typeColors[w.type] || '#667eea';
    html += `<span class="vocab-tag" style="border-left:3px solid ${color}">
      <span class="korean">${w.korean}</span>
      <span class="english" style="color:#718096">(${w.english})</span>
    </span>`;
  });

  html += '</div>';
  container.innerHTML = html;
}

async function startTeacherVideoRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

    const liveVideo = document.getElementById('teacherVideoLive');
    if (liveVideo) {
      liveVideo.srcObject = stream;
      liveVideo.style.display = 'block';
    }
    document.getElementById('teacherVideoPreview').style.display = 'none';

    dailyActivityState.videoStream = stream;
    dailyActivityState.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
    dailyActivityState.videoChunks = [];

    dailyActivityState.mediaRecorder.ondataavailable = e => dailyActivityState.videoChunks.push(e.data);
    dailyActivityState.mediaRecorder.onstop = () => {
      dailyActivityState.teacherVideoBlob = new Blob(dailyActivityState.videoChunks, { type: 'video/webm' });

      const liveVideo = document.getElementById('teacherVideoLive');
      if (liveVideo) liveVideo.style.display = 'none';

      const preview = document.getElementById('teacherVideoPreview');
      if (preview) {
        preview.src = URL.createObjectURL(dailyActivityState.teacherVideoBlob);
        preview.style.display = 'block';
      }
      document.getElementById('teacherVideoStatus').textContent = ' Video saved!';
      stream.getTracks().forEach(t => t.stop());
    };

    dailyActivityState.mediaRecorder.start();
    document.getElementById('startTeacherVideoBtn').style.display = 'none';
    document.getElementById('stopTeacherVideoBtn').style.display = 'inline-flex';
    document.getElementById('teacherVideoStatus').textContent = ' Recording...';
  } catch (error) {
    showToast(' Could not access camera/microphone');
  }
}

function stopTeacherVideoRecording() {
  if (dailyActivityState.mediaRecorder) {
    dailyActivityState.mediaRecorder.stop();
    document.getElementById('startTeacherVideoBtn').style.display = 'inline-flex';
    document.getElementById('stopTeacherVideoBtn').style.display = 'none';
  }
}

/**
 * Open fullscreen recording modal with script, countdown, and controls
 */
async function openTeacherRecordingModal() {
  const script = document.getElementById('dailyScriptContent')?.value?.trim();
  if (!script) {
    showToast(' Please enter a script first');
    return;
  }

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  } catch (error) {
    showToast(' Could not access camera/microphone');
    return;
  }

  dailyActivityState.videoStream = stream;

  const formattedScript = script
    .replace(/([AB])\s*[:.]\s*/gi, '<br><strong style="color:#667eea">$1:</strong> ')
    .trim();

  const modal = document.createElement('div');
  modal.id = 'teacherRecordModal';
  modal.style.cssText = `
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  modal.innerHTML = `
    <div style="width:100%;max-width:600px;display:flex;flex-direction:column;gap:15px;max-height:90vh">
      <!-- Script Display -->
      <div style="background:white;border-radius:12px;padding:15px;max-height:200px;overflow-y:auto">
        <div style="font-size:11px;color:#718096;margin-bottom:8px;text-transform:uppercase"> Script to Read:</div>
        <div style="font-size:15px;line-height:1.8;color:#1a202c">${formattedScript}</div>
      </div>

      <!-- Video Preview -->
      <div style="position:relative;background:#000;border-radius:12px;overflow:hidden;aspect-ratio:16/9;max-height:300px">
        <video id="teacherRecordLive" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover"></video>

        <!-- Countdown Overlay -->
        <div id="recordCountdown" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center">
          <span style="font-size:80px;color:white;font-weight:bold" id="countdownNumber">3</span>
        </div>

        <!-- Recording Indicator -->
        <div id="recordingIndicator" style="display:none;position:absolute;top:15px;left:15px;background:rgba(239,68,68,0.9);color:white;padding:5px 12px;border-radius:20px;font-size:13px;font-weight:600">
           Recording
        </div>

        <!-- Timer -->
        <div id="recordTimer" style="display:none;position:absolute;top:15px;right:15px;background:rgba(0,0,0,0.7);color:white;padding:5px 12px;border-radius:20px;font-size:13px;font-family:monospace">
          00:00
        </div>
      </div>

      <!-- Controls -->
      <div style="display:flex;gap:10px;justify-content:center">
        <button id="recordModalPauseBtn" onclick="pauseTeacherRecording()" style="display:none;padding:12px 24px;background:#f59e0b;color:white;border:none;border-radius:25px;font-weight:600;cursor:pointer;font-size:14px">
           Pause
        </button>
        <button id="recordModalResumeBtn" onclick="resumeTeacherRecording()" style="display:none;padding:12px 24px;background:#10b981;color:white;border:none;border-radius:25px;font-weight:600;cursor:pointer;font-size:14px">
           Resume
        </button>
        <button id="recordModalStopBtn" onclick="finishTeacherRecording()" style="display:none;padding:12px 24px;background:#10b981;color:white;border:none;border-radius:25px;font-weight:600;cursor:pointer;font-size:14px">
           Finish Recording
        </button>
        <button id="recordModalRestartBtn" onclick="restartTeacherRecording()" style="display:none;padding:12px 24px;background:#6366f1;color:white;border:none;border-radius:25px;font-weight:600;cursor:pointer;font-size:14px">
           Restart
        </button>
        <button id="recordModalCancelBtn" onclick="cancelTeacherRecording()" style="padding:12px 24px;background:#64748b;color:white;border:none;border-radius:25px;font-weight:600;cursor:pointer;font-size:14px">
           Cancel
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  const liveVideo = document.getElementById('teacherRecordLive');
  if (liveVideo) {
    liveVideo.srcObject = stream;
  }

  startRecordingCountdown();
}

let recordingTimerInterval = null;
let recordingStartTime = null;
let recordingPausedTime = 0;

function startRecordingCountdown() {
  const countdownEl = document.getElementById('recordCountdown');
  const numberEl = document.getElementById('countdownNumber');
  let count = 3;

  const countInterval = setInterval(() => {
    count--;
    if (count > 0) {
      numberEl.textContent = count;
    } else {
      clearInterval(countInterval);
      countdownEl.style.display = 'none';
      startActualRecording();
    }
  }, 1000);
}

function startActualRecording() {
  const stream = dailyActivityState.videoStream;
  if (!stream) return;

  dailyActivityState.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
  dailyActivityState.videoChunks = [];

  dailyActivityState.mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) {
      dailyActivityState.videoChunks.push(e.data);
    }
  };

  dailyActivityState.mediaRecorder.start(1000); // Collect data every second for pause/resume

  document.getElementById('recordingIndicator').style.display = 'block';
  document.getElementById('recordTimer').style.display = 'block';
  document.getElementById('recordModalPauseBtn').style.display = 'inline-block';
  document.getElementById('recordModalStopBtn').style.display = 'inline-block';
  document.getElementById('recordModalRestartBtn').style.display = 'inline-block';

  recordingStartTime = Date.now();
  recordingPausedTime = 0;
  recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
}

function updateRecordingTimer() {
  const timerEl = document.getElementById('recordTimer');
  if (!timerEl || !recordingStartTime) return;

  const elapsed = Math.floor((Date.now() - recordingStartTime - recordingPausedTime) / 1000);
  const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
  const secs = (elapsed % 60).toString().padStart(2, '0');
  timerEl.textContent = `${mins}:${secs}`;
}

function pauseTeacherRecording() {
  if (dailyActivityState.mediaRecorder && dailyActivityState.mediaRecorder.state === 'recording') {
    dailyActivityState.mediaRecorder.pause();
    dailyActivityState.pauseStartTime = Date.now();

    document.getElementById('recordingIndicator').innerHTML = ' Paused';
    document.getElementById('recordingIndicator').style.background = 'rgba(245,158,11,0.9)';
    document.getElementById('recordModalPauseBtn').style.display = 'none';
    document.getElementById('recordModalResumeBtn').style.display = 'inline-block';
  }
}

function resumeTeacherRecording() {
  if (dailyActivityState.mediaRecorder && dailyActivityState.mediaRecorder.state === 'paused') {
    dailyActivityState.mediaRecorder.resume();
    recordingPausedTime += Date.now() - dailyActivityState.pauseStartTime;

    document.getElementById('recordingIndicator').innerHTML = ' Recording';
    document.getElementById('recordingIndicator').style.background = 'rgba(239,68,68,0.9)';
    document.getElementById('recordModalPauseBtn').style.display = 'inline-block';
    document.getElementById('recordModalResumeBtn').style.display = 'none';
  }
}

function restartTeacherRecording() {
  if (dailyActivityState.mediaRecorder) {
    dailyActivityState.mediaRecorder.stop();
  }
  clearInterval(recordingTimerInterval);

  document.getElementById('recordCountdown').style.display = 'flex';
  document.getElementById('countdownNumber').textContent = '3';
  document.getElementById('recordingIndicator').style.display = 'none';
  document.getElementById('recordingIndicator').innerHTML = ' Recording';
  document.getElementById('recordingIndicator').style.background = 'rgba(239,68,68,0.9)';
  document.getElementById('recordTimer').style.display = 'none';
  document.getElementById('recordTimer').textContent = '00:00';
  document.getElementById('recordModalPauseBtn').style.display = 'none';
  document.getElementById('recordModalResumeBtn').style.display = 'none';
  document.getElementById('recordModalStopBtn').style.display = 'none';
  document.getElementById('recordModalRestartBtn').style.display = 'none';

  dailyActivityState.videoChunks = [];

  startRecordingCountdown();
}

function finishTeacherRecording() {
  if (dailyActivityState.mediaRecorder) {
    dailyActivityState.mediaRecorder.onstop = () => {
      dailyActivityState.teacherVideoBlob = new Blob(dailyActivityState.videoChunks, { type: 'video/webm' });

      const preview = document.getElementById('teacherVideoPreview');
      if (preview) {
        preview.src = URL.createObjectURL(dailyActivityState.teacherVideoBlob);
        preview.style.display = 'block';
      }
      document.getElementById('teacherVideoStatus').textContent = ' Video saved!';

      closeTeacherRecordModal();
    };

    dailyActivityState.mediaRecorder.stop();
  }

  clearInterval(recordingTimerInterval);
}

function cancelTeacherRecording() {
  if (dailyActivityState.mediaRecorder && dailyActivityState.mediaRecorder.state !== 'inactive') {
    dailyActivityState.mediaRecorder.stop();
  }

  clearInterval(recordingTimerInterval);
  closeTeacherRecordModal();
}

function closeTeacherRecordModal() {
  if (dailyActivityState.videoStream) {
    dailyActivityState.videoStream.getTracks().forEach(t => t.stop());
    dailyActivityState.videoStream = null;
  }

  const modal = document.getElementById('teacherRecordModal');
  if (modal) modal.remove();
}

async function saveDailyActivity(status, publishDate) {
  const script = document.getElementById('dailyScriptContent')?.value?.trim();
  if (!script) { showToast(' Please enter a script'); return; }
  if (!dailyActivityState.teacherVideoBlob) { showToast(' Please record a video'); return; }

  try {
    showToast(' Analyzing sentences...');

    const sentenceAnalysis = await analyzeScriptSentences(script);

    showToast(' Uploading video...');
    const videoRef = storage.ref(`daily-videos/${Date.now()}.webm`);
    await videoRef.put(dailyActivityState.teacherVideoBlob);
    const videoUrl = await videoRef.getDownloadURL();

    const deadline = new Date(publishDate);
    deadline.setDate(deadline.getDate() + 1);
    deadline.setHours(4, 0, 0, 0);

    let teacherName = currentUser.displayName || 'Teacher';
    let teacherPhotoUrl = currentUser.photoURL || null;
    let teacherBio = '';

    try {
      const teacherDoc = await db.collection('teachers').doc(currentUser.uid).get();
      if (teacherDoc.exists) {
        const teacherData = teacherDoc.data();
        teacherName = teacherData.displayName || teacherName;
        teacherPhotoUrl = teacherData.photoUrl || teacherPhotoUrl;
        teacherBio = teacherData.bio || '';
      }
    } catch(e) { }

    await db.collection('dailyActivities').add({
      type: 'pronunciation', script, vocabulary: dailyActivityState.generatedVocabulary,
      teacherVideoUrl: videoUrl, teacherId: currentUser.uid,
      teacherName: teacherName,
      teacherPhotoUrl: teacherPhotoUrl,
      teacherBio: teacherBio,
      formality: dailyActivityState.formality || 'haeyo',
      sentenceAnalysis: sentenceAnalysis, // PRE-ANALYZED DATA for instant student tooltips
      status,
      publishDate: firebase.firestore.Timestamp.fromDate(publishDate),
      deadline: firebase.firestore.Timestamp.fromDate(deadline),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(), submissionCount: 0
    });

    showToast(status === 'published' ? ' Published!' : ' Scheduled!');
    document.getElementById('dailyScriptTopic').value = '';
    document.getElementById('dailyScriptContent').value = '';
    document.getElementById('generatedScriptBox').style.display = 'none';
    switchTab('manageDailyActivities');
    loadDailyActivities();
  } catch (error) { console.error(error); showToast(' Failed to save'); }
}

/**
 * Analyze all sentences in a script - called ONCE when teacher publishes
 * Returns an object keyed by Korean sentence text
 */
async function analyzeScriptSentences(script) {
  if (!script) return {};

  const lines = script.split('\n').filter(line => line.trim());
  const sentences = [];

  lines.forEach((line, index) => {
    const speakerMatch = line.match(/^([AB])\s*[:.]\s*(.+)$/i);
    if (speakerMatch) {
      sentences.push({
        korean: speakerMatch[2].trim(),
        speaker: speakerMatch[1].toUpperCase(),
        index: index
      });
    }
  });

  if (sentences.length === 0) return {};


  const prompt = `Analyze these Korean sentences and provide translations and vocabulary.

${sentences.map((s, i) => `${i + 1}. "${s.korean}"`).join('\n')}

For EACH sentence, provide:
1. Natural English translation
2. Key vocabulary words (3-5 most important) with meanings and part of speech

Respond in this exact JSON format:
{
  "sentences": [
    {
      "index": 0,
      "korean": "original sentence",
      "english": "English translation",
      "vocabulary": [
        {"korean": "word1", "english": "meaning1", "partOfSpeech": "noun"},
        {"korean": "word2", "english": "meaning2", "partOfSpeech": "verb"}
      ]
    }
  ]
}`;

  try {
    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown.' },
      { role: 'user', content: prompt }
    ], 0.3);

    let aiData = null;
    try {
      const jsonStr = typeof response === 'string' ? response : JSON.stringify(response);
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      aiData = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
    } catch(e) {
      return {};
    }

    const analysis = {};
    if (aiData?.sentences) {
      aiData.sentences.forEach((sentenceAnalysis, i) => {
        const originalSentence = sentences[i];
        if (originalSentence) {
          analysis[originalSentence.korean] = {
            english: sentenceAnalysis.english || '',
            vocabulary: sentenceAnalysis.vocabulary || []
          };
        }
      });
    }

    console.log(`Successfully analyzed ${Object.keys(analysis).length} sentences`);
    return analysis;

  } catch(e) {
    return {};
  }
}

async function scheduleDailyScript() {
  const time = document.getElementById('dailyScriptSchedule')?.value;
  if (!time) { showToast(' Select a date/time'); return; }
  await saveDailyActivity('scheduled', new Date(time));
}

async function publishDailyScriptNow() { await saveDailyActivity('published', new Date()); }

async function loadDailyActivities(filter = 'all') {
  const container = document.getElementById('dailyActivitiesList');
  if (!container) return;
  container.innerHTML = '<div style="text-align:center;padding:40px"><div class="loading"></div></div>';

  try {
    const snapshot = await db.collection('dailyActivities').orderBy('createdAt','desc').get();

    let activities = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.type === 'pronunciation') {
        activities.push({ id: doc.id, ...data });
      }
    });

    if (activities.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#718096;padding:40px">No activities yet. Create one to get started!</p>';
      return;
    }

    let html = '';
    const now = new Date();

    activities.forEach(a => {
      const publishDate = a.publishDate?.toDate() || new Date();
      let deadline;
      if (a.deadline?.toDate) {
        deadline = a.deadline.toDate();
      } else if (a.deadline) {
        deadline = new Date(a.deadline);
      } else {
        deadline = new Date();
        deadline.setDate(deadline.getDate() + 1);
        deadline.setHours(4, 0, 0, 0);
      }
      const isPast = now > deadline;
      // A post is "live/published" if:
      // 1. status is 'published' and publish date has passed, OR
      // 2. status is 'scheduled' but publish date has passed (auto-published)
      const isPublished = now >= publishDate && (a.status === 'published' || a.status === 'scheduled');
      // A post is "scheduled" only if status is 'scheduled' AND publish date is still in the future
      const isScheduled = a.status === 'scheduled' && now < publishDate;

      if (filter === 'scheduled' && !isScheduled) return;
      if (filter === 'published' && !isPublished) return;
      if (filter === 'past' && !isPast) return;

      // Format scheduled time for display in EST (New York)
      const scheduledTimeStr = isScheduled ? publishDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: 'America/New_York' }) + ' EST' : '';

      const statusBadge = isPast
        ? '<span style="background:#e2e8f0;color:#4a5568;padding:4px 12px;border-radius:12px;font-size:12px">Past</span>'
        : isScheduled
          ? `<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:12px;font-size:12px"> Scheduled for ${scheduledTimeStr}</span>`
          : '<span style="background:#c6f6d5;color:#276749;padding:4px 12px;border-radius:12px;font-size:12px">Live</span>';

      const date = publishDate.toLocaleDateString();
      const scriptPreview = (a.script || '').substring(0, 100) + ((a.script || '').length > 100 ? '...' : '');

      html += `<div style="background:white;border-radius:12px;padding:20px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,0.05);border:1px solid #e2e8f0">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div>
            <div style="font-weight:600;color:#1a202c;margin-bottom:5px"> Pronunciation Challenge</div>
            <div style="color:#718096;font-size:13px">${date}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            ${statusBadge}
            <span style="color:#667eea;font-weight:500;font-size:13px">${a.submissionCount||0} submissions</span>
          </div>
        </div>
        <div style="background:#f8fafc;padding:10px;border-radius:8px;font-size:13px;color:#4a5568;margin-bottom:12px">${scriptPreview}</div>
        <div style="display:flex;gap:10px">
          <button onclick="editDailyActivity('${a.id}')" class="btn" style="font-size:12px;padding:6px 12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer"> Edit</button>
          <button onclick="deleteDailyActivity('${a.id}')" class="btn btn-secondary" style="font-size:12px;padding:6px 12px;color:#e53e3e"> Delete</button>
        </div>
      </div>`;
    });

    container.innerHTML = html || '<p style="text-align:center;color:#718096;padding:40px">No activities match this filter.</p>';
  } catch(e) {
    container.innerHTML = '<p style="color:#e53e3e;text-align:center;padding:40px">Error loading activities. Check console for details.</p>';
  }
}

function filterDailyActivities(filter) { loadDailyActivities(filter); }

async function editDailyActivity(activityId) {
  try {
    const doc = await db.collection('dailyActivities').doc(activityId).get();
    if (!doc.exists) {
      showToast(' Activity not found');
      return;
    }
    const activity = doc.data();

    switchTab('createDailyPronunciation');

    dailyActivityState.editingActivityId = activityId;

    document.getElementById('dailyScriptTopic').value = activity.topic || '';
    document.getElementById('dailyScriptContent').value = activity.script || '';
    document.getElementById('generatedScriptBox').style.display = 'block';

    dailyActivityState.currentScript = activity.script;
    dailyActivityState.generatedVocabulary = activity.vocabulary || {};

    if (activity.vocabulary) {
      renderVocabPreview(activity.vocabulary);
    }

    const publishBtn = document.querySelector('[onclick*="publishDailyScriptNow"]');
    if (publishBtn) {
      publishBtn.innerHTML = ' Update Activity';
      publishBtn.onclick = () => updateDailyActivity(activityId);
    }

    showToast(' Editing activity - make changes and click Update');

  } catch(e) {
    showToast(' Error loading activity');
  }
}

async function updateDailyActivity(activityId) {
  const script = document.getElementById('dailyScriptContent')?.value?.trim();
  if (!script) {
    showToast(' Please enter a script');
    return;
  }

  try {
    await db.collection('dailyActivities').doc(activityId).update({
      script: script,
      vocabulary: dailyActivityState.generatedVocabulary || {},
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(' Activity updated!');
    dailyActivityState.editingActivityId = null;

    const publishBtn = document.querySelector('[onclick*="updateDailyActivity"]');
    if (publishBtn) {
      publishBtn.innerHTML = ' Publish Now';
      publishBtn.onclick = publishDailyScriptNow;
    }

    document.getElementById('dailyScriptTopic').value = '';
    document.getElementById('dailyScriptContent').value = '';
    document.getElementById('generatedScriptBox').style.display = 'none';

    switchTab('manageDailyActivities');

  } catch(e) {
    showToast(' Failed to update');
  }
}

async function deleteDailyActivity(id) {
  if (!confirm('Delete this activity?')) return;
  try { await db.collection('dailyActivities').doc(id).delete(); showToast(' Deleted'); loadDailyActivities(); }
  catch(e) { showToast(' Failed'); }
}

let pronCarouselState = {
  entries: [],
  index: 0,
  cardWidth: 0,
  gap: 10,
  activity: null,
  hallOpen: false,
  closeTimer: null,
  activeDrag: null,
  activeDropStudent: null,
  isLoading: false,
  lastLoadTime: 0,
  forceRefresh: false
};

async function loadStudentDailyActivity() {
  // Prevent multiple simultaneous loads
  const now = Date.now();
  if (pronCarouselState.isLoading) {
    return;
  }
  
  // Allow reload if it's been more than 2 seconds OR if we're forcing a refresh
  const timeSinceLastLoad = now - pronCarouselState.lastLoadTime;
  if (timeSinceLastLoad < 2000 && pronCarouselState.entries.length > 0 && !pronCarouselState.forceRefresh) {
    return;
  }
  
  pronCarouselState.isLoading = true;
  pronCarouselState.lastLoadTime = now;
  pronCarouselState.forceRefresh = false;

  const teacherCard = document.getElementById('pronTeacherCard');
  const viewport = document.getElementById('pronViewport');
  const track = document.getElementById('pronTrack');
  const controls = document.getElementById('pronControls');

  if (!teacherCard) return;

  try {
    const snapshot = await db.collection('dailyActivities')
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get();

    let activity = null;
    const nowDate = new Date();

    for (const doc of snapshot.docs) {
      const data = doc.data();
      const publishDate = data.publishDate?.toDate() || new Date();

      // Show published activities OR scheduled activities whose publishDate has passed
      if (data.type === 'pronunciation' && 
          ((data.status === 'published') || 
           (data.status === 'scheduled' && publishDate <= nowDate))) {
        activity = { id: doc.id, ...data };
        break;
      }
    }

    if (!activity) {
      teacherCard.innerHTML = `
        <div class="da-empty-state">
          <div class="empty-icon"></div>
          <p>No pronunciation challenge available today.</p>
          <p style="font-size:12px;margin-top:8px;opacity:0.7">Check back soon!</p>
        </div>`;
      viewport.style.display = 'none';
      controls.style.display = 'none';
      // Clear old entries when no activity
      pronCarouselState.entries = [];
      pronCarouselState.activity = null;
      return;
    }

    // If the activity has changed from what we had before, clear old entries
    if (pronCarouselState.activity && pronCarouselState.activity.id !== activity.id) {
      pronCarouselState.entries = [];
    }

    pronCarouselState.activity = activity;
    let deadline;
    if (activity.deadline?.toDate) {
      deadline = activity.deadline.toDate();
    } else if (activity.deadline) {
      deadline = new Date(activity.deadline);
    } else {
      deadline = new Date();
      deadline.setDate(deadline.getDate() + 1);
      deadline.setHours(4, 0, 0, 0);
    }
    const isPast = now > deadline;

    const subSnap = await db.collection('dailySubmissions')
      .where('activityId', '==', activity.id)
      .where('studentId', '==', currentUser.uid)
      .get();
    const hasSubmitted = !subSnap.empty;

    const allSubsSnap = await db.collection('dailySubmissions')
      .where('activityId', '==', activity.id)
      .get();
    
    // Sort submissions client-side by submittedAt (newest first) for consistent ordering
    const sortedDocs = allSubsSnap.docs.sort((a, b) => {
      const aTime = a.data().submittedAt?.toDate?.() || new Date(0);
      const bTime = b.data().submittedAt?.toDate?.() || new Date(0);
      return bTime - aTime;
    });

    const teacherName = activity.teacherName || 'Teacher';
    const teacherPhotoUrl = activity.teacherPhotoUrl || null;
    const teacherInitials = teacherName.split(' ').map(s => s[0]).join('').slice(0,2).toUpperCase();

    const teacherAvatarHtml = teacherPhotoUrl
      ? `<img src="${teacherPhotoUrl}" alt="${teacherName}">`
      : teacherInitials;

    let recordBtnClass = 'da-record-btn';
    let recordBtnContent = ' Record My Entry';
    let recordBtnOnclick = `openStudentRecordingModal('${activity.id}')`;
    let recordBtnStyle = 'background: linear-gradient(135deg, #f56565 0%, #c53030 100%); border-color: #f56565;';

    if (hasSubmitted) {
      recordBtnClass += ' submitted';
      recordBtnContent = ' You\'ve submitted!';
      recordBtnOnclick = '';
      recordBtnStyle = '';
    } else if (isPast) {
      recordBtnClass += ' deadline-passed';
      recordBtnContent = ' Deadline passed';
      recordBtnOnclick = '';
      recordBtnStyle = '';
    }

    teacherCard.className = 'da-teacher-card has-content';
    teacherCard.innerHTML = `
      <div class="da-teacher-header" style="margin-bottom:12px">
        <div class="da-teacher-avatar">${teacherAvatarHtml}</div>
        <div class="da-teacher-info">
          <div class="da-teacher-label">Today's Challenge</div>
          <p class="da-teacher-name">${teacherName}</p>
        </div>
      </div>

      <!-- Video + Script Layout -->
      <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap">
        <!-- Video Thumbnail (YouTube size ~16:9) -->
        ${activity.teacherVideoUrl ? `
          <div style="flex-shrink:0;width:280px">
            <div class="da-video-container" style="position:relative;border-radius:10px;overflow:hidden;background:#000;aspect-ratio:16/9">
              <video id="teacherInlineVideo" src="${activity.teacherVideoUrl}" style="width:100%;height:100%;object-fit:cover" onclick="toggleInlineVideo(this)"></video>
              <div id="videoPlayOverlay" onclick="toggleInlineVideo(document.getElementById('teacherInlineVideo'))" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity 0.2s">
                <div style="background:rgba(0,0,0,0.7);border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center">
                  <span style="color:white;font-size:20px;margin-left:3px"></span>
                </div>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:6px">
              <span style="font-size:11px;color:#667eea;cursor:pointer" onclick="expandTeacherVideo('${activity.teacherVideoUrl}')"> Expand</span>
              <span style="font-size:11px;color:#718096">Click to play</span>
            </div>
          </div>
        ` : ''}

        <!-- Script on the right -->
        <div style="flex:1;min-width:200px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <span style="font-size:10px;color:#a0aec0;text-transform:uppercase;letter-spacing:0.5px;"> Script</span>
            <div style="display:flex;align-items:center;gap:6px;">
              <button onclick="adjustScriptFontSize(-2)" style="width:22px;height:22px;border-radius:4px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:#e2e8f0;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;">A-</button>
              <button onclick="adjustScriptFontSize(2)" style="width:22px;height:22px;border-radius:4px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:#e2e8f0;cursor:pointer;font-size:12px;font-weight:bold;display:flex;align-items:center;justify-content:center;">A+</button>
            </div>
          </div>
          <div class="da-script-preview" id="dailyActivityScriptText" style="max-height:160px;overflow-y:auto;font-size:14px;line-height:1.6">${renderScriptWithVocabKeywords(activity.script, activity.vocabulary)}</div>
        </div>
      </div>

      ${activity.teacherAudioUrl && !activity.teacherVideoUrl ? `<audio class="da-teacher-audio" src="${activity.teacherAudioUrl}" controls style="width:100%;margin-bottom:12px"></audio>` : ''}
      <button class="${recordBtnClass}" style="${recordBtnStyle}" ${recordBtnOnclick ? `onclick="${recordBtnOnclick}"` : ''}>${recordBtnContent}</button>
    `;

    if (activity.sentenceAnalysis) {
      window.preRenderedSentenceData = activity.sentenceAnalysis;
      console.log(`Loaded ${Object.keys(activity.sentenceAnalysis).length} pre-analyzed sentences from activity`);
    } else {
      preRenderSentenceAnalysis(activity.script);
    }

    pronCarouselState.entries = [];
    
    const seenStudentIds = new Set();

    for (const doc of sortedDocs) {
      const sub = doc.data();
      
      // Skip duplicate entries for the same student (show only their latest)
      if (seenStudentIds.has(sub.studentId)) continue;
      seenStudentIds.add(sub.studentId);
      
      const isMe = sub.studentId === currentUser.uid;

      let studentName = 'Student';
      let studentPhotoUrl = null;
      let vocabCount = 0;
      let coins = 0;

      try {
        const userDoc = await db.collection('users').doc(sub.studentId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          studentName = userData.displayName || userData.email?.split('@')[0] || 'Student';
          studentPhotoUrl = userData.avatarUrl || userData.photoUrl || userData.photoURL || null;
          coins = userData.coins || 0;
        }
      } catch(e) {
        console.log('Error fetching user data:', e);
      }
      
      // Try to get coins from studentProfiles if not in users
      try {
        if (coins === 0) {
          const profileDoc = await db.collection('studentProfiles').doc(sub.studentId).get();
          if (profileDoc.exists) {
            const profileData = profileDoc.data();
            coins = profileData.coins || 0;
          }
        }
      } catch(e) {
        console.log('Error fetching profile data:', e);
      }
      
      // Try to get vocab count from studentFlashcards
      try {
        const vocabSnapshot = await db.collection('studentFlashcards')
          .where('studentId', '==', sub.studentId)
          .get();
        vocabCount = vocabSnapshot.size;
      } catch(e) {
        console.log('Error fetching vocab count:', e);
      }

      pronCarouselState.entries.push({
        id: doc.id,
        studentId: sub.studentId,
        studentName,
        studentPhotoUrl,
        audioUrl: sub.audioUrl,
        submittedAt: sub.submittedAt?.toDate(),
        isMe,
        vocabCount,
        coins,
        isGraded: sub.isGraded,
        activityId: activity.id
      });
    }

    if (pronCarouselState.entries.length > 0) {
      renderPronCarousel();
      viewport.style.display = 'block';
      controls.style.display = 'flex';
      setupPronCarouselDrag();
      renderPronHallGrid();
    } else {
      viewport.style.display = 'none';
      controls.style.display = 'none';
    }

  } catch(e) {
    teacherCard.innerHTML = `<div class="da-empty-state"><p style="color:#f87171">Error loading challenge. Please try again.</p></div>`;
  } finally {
    pronCarouselState.isLoading = false;
  }
}

/**
 * Expand teacher video to fullscreen modal
 */
function expandTeacherVideo(videoUrl) {
  const inlineVideo = document.getElementById('teacherInlineVideo');
  if (inlineVideo) inlineVideo.pause();

  const existing = document.getElementById('teacherVideoModal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'teacherVideoModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  modal.onclick = (e) => {
    if (e.target === modal) closeTeacherVideoModal();
  };

  modal.innerHTML = `
    <div style="position:relative;max-width:90vw;max-height:80vh">
      <button onclick="closeTeacherVideoModal()" style="position:absolute;top:-40px;right:0;background:none;border:none;color:white;font-size:30px;cursor:pointer;padding:5px"></button>
      <video src="${videoUrl}" controls autoplay style="max-width:100%;max-height:80vh;border-radius:12px;background:#000"></video>
    </div>
  `;

  document.body.appendChild(modal);
}

/**
 * Toggle inline video play/pause
 */
function toggleInlineVideo(videoEl) {
  const overlay = document.getElementById('videoPlayOverlay');

  if (videoEl.paused) {
    videoEl.play();
    if (overlay) overlay.style.opacity = '0';
    videoEl.controls = true;
  } else {
    videoEl.pause();
    if (overlay) overlay.style.opacity = '1';
    videoEl.controls = false;
  }
}

function closeTeacherVideoModal() {
  const modal = document.getElementById('teacherVideoModal');
  if (modal) {
    const video = modal.querySelector('video');
    if (video) video.pause();
    modal.remove();
  }
}

function renderPronCarousel() {
  const track = document.getElementById('pronTrack');
  if (!track) return;

  track.innerHTML = pronCarouselState.entries.map((entry, i) => {
    const initials = entry.studentName.split(' ').map(s => s[0]).join('').slice(0,2).toUpperCase();
    const avatarHtml = entry.studentPhotoUrl
      ? `<img src="${entry.studentPhotoUrl}" alt="${entry.studentName}">`
      : initials;
    const timeStr = entry.submittedAt ? entry.submittedAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

    return `
      <article class="da-student-card" data-entry="${i}" data-student-id="${entry.studentId}" onclick="openStudentProfileModal('${entry.studentId}')" style="cursor: pointer;">
        <div class="da-student-inner">
          <div class="da-student-top">
            <div class="da-student-avatar">${avatarHtml}</div>
            <div style="min-width:0;flex:1;">
              <p class="da-student-name">${entry.studentName}${entry.isMe ? ' (You)' : ''}</p>
              <p class="da-student-meta">${timeStr}</p>
            </div>
          </div>
          <div class="da-student-stats">
            <span class="da-stat-badge coins"> ${entry.coins}</span>
            <span class="da-stat-badge vocab"> ${entry.vocabCount}</span>
          </div>
        </div>
        <div class="da-audio-dropdown">
          <audio src="${entry.audioUrl}" controls></audio>
          ${entry.isMe && !entry.isGraded ? `
            <button onclick="event.stopPropagation(); deleteMyDailySubmission('${entry.id}', '${entry.activityId}')"
                    style="width:100%;margin-top:8px;padding:8px;background:rgba(248,113,113,0.2);color:#f87171;border:1px solid rgba(248,113,113,0.3);border-radius:8px;font-size:11px;cursor:pointer;">
               Delete Submission
            </button>
          ` : ''}
        </div>
      </article>
    `;
  }).join('');

  setTimeout(() => {
    const firstCard = track.querySelector('.da-student-card');
    if (firstCard) {
      pronCarouselState.cardWidth = firstCard.getBoundingClientRect().width;
    }
    updatePronCarouselPosition();
  }, 50);
}

function updatePronCarouselPosition() {
  const track = document.getElementById('pronTrack');
  const counter = document.getElementById('pronCounter');
  if (!track) return;

  const x = -(pronCarouselState.index * (pronCarouselState.cardWidth + pronCarouselState.gap));
  track.style.transform = `translate3d(${x}px,0,0)`;

  if (counter) {
    counter.textContent = `${pronCarouselState.index + 1} / ${pronCarouselState.entries.length}`;
  }
}

function pronCarouselNext() {
  pronCarouselState.index = (pronCarouselState.index + 1) % pronCarouselState.entries.length;
  updatePronCarouselPosition();
}

function pronCarouselPrev() {
  pronCarouselState.index = (pronCarouselState.index - 1 + pronCarouselState.entries.length) % pronCarouselState.entries.length;
  updatePronCarouselPosition();
}

document.addEventListener('DOMContentLoaded', () => {
  const prevBtn = document.getElementById('pronPrevBtn');
  const nextBtn = document.getElementById('pronNextBtn');
  if (prevBtn) prevBtn.addEventListener('click', pronCarouselPrev);
  if (nextBtn) nextBtn.addEventListener('click', pronCarouselNext);
});

function setupPronCarouselDrag() {
  const track = document.getElementById('pronTrack');
  if (!track) return;

  track.addEventListener('click', (e) => {
    const card = e.target.closest('.da-student-card');
    if (!card) return;

    if (e.target.tagName === 'AUDIO' || e.target.tagName === 'BUTTON') return;

    const wasExpanded = card.classList.contains('expanded');
    track.querySelectorAll('.da-student-card').forEach(c => c.classList.remove('expanded'));
    if (!wasExpanded) {
      card.classList.add('expanded');
    }
  });

  track.addEventListener('pointerdown', (e) => {
    const card = e.target.closest('.da-student-card');
    if (!card) return;
    if (e.target.tagName === 'AUDIO' || e.target.tagName === 'BUTTON') return;

    const entryIndex = Number(card.dataset.entry || 0);
    pronCarouselState.activeDrag = {
      entryIndex,
      startX: e.clientX,
      startY: e.clientY,
      dragging: false,
      pointerId: e.pointerId
    };

    card.setPointerCapture(e.pointerId);
  });

  track.addEventListener('pointermove', (e) => {
    if (!pronCarouselState.activeDrag) return;

    const dx = e.clientX - pronCarouselState.activeDrag.startX;
    const dy = e.clientY - pronCarouselState.activeDrag.startY;
    const dist = Math.hypot(dx, dy);

    if (!pronCarouselState.activeDrag.dragging && dist > 10) {
      pronCarouselState.activeDrag.dragging = true;
      openPronHallNear(e.clientX, e.clientY, pronCarouselState.activeDrag.entryIndex);
    }

    if (pronCarouselState.activeDrag.dragging && pronCarouselState.hallOpen) {
      openPronHallNear(e.clientX, e.clientY, pronCarouselState.activeDrag.entryIndex);

      const el = document.elementFromPoint(e.clientX, e.clientY);
      const node = el && el.closest ? el.closest('.da-hall-student') : null;
      if (node) setPronActiveDrop(node);
      else clearPronActiveDrop();
    }
  });

  track.addEventListener('pointerup', () => {
    if (!pronCarouselState.activeDrag) return;

    if (pronCarouselState.activeDrag.dragging && pronCarouselState.activeDropStudent) {
      const studentId = pronCarouselState.activeDropStudent.dataset.studentId;
      jumpToPronStudent(studentId);
    }
    pronCarouselState.activeDrag = null;
  });

  track.addEventListener('pointercancel', () => {
    pronCarouselState.activeDrag = null;
  });
}

function renderPronHallGrid() {
  const grid = document.getElementById('daHallGrid');
  if (!grid) return;

  const studentMap = new Map();
  for (const entry of pronCarouselState.entries) {
    if (!studentMap.has(entry.studentId)) {
      studentMap.set(entry.studentId, entry);
    }
  }

  grid.innerHTML = [...studentMap.values()].map(entry => {
    const initials = entry.studentName.split(' ').map(s => s[0]).join('').slice(0,2).toUpperCase();
    const avatarHtml = entry.studentPhotoUrl
      ? `<img src="${entry.studentPhotoUrl}" alt="${entry.studentName}">`
      : initials;

    return `
      <div class="da-hall-student" data-student-id="${entry.studentId}" tabindex="0">
        <div class="da-hall-student-row">
          <div class="da-hall-avatar">${avatarHtml}</div>
          <div style="min-width:0;">
            <p class="da-hall-name">${entry.studentName}</p>
            <p class="da-hall-stats"> ${entry.coins}   ${entry.vocabCount}</p>
          </div>
        </div>
      </div>
    `;
  }).join('');

  grid.querySelectorAll('.da-hall-student').forEach(el => {
    el.addEventListener('click', () => {
      const studentId = el.dataset.studentId;
      jumpToPronStudent(studentId);
    });
  });

  grid.addEventListener('mousemove', (e) => {
    const node = e.target.closest('.da-hall-student');
    if (node) setPronActiveDrop(node);
    else clearPronActiveDrop();
  });
  grid.addEventListener('mouseleave', clearPronActiveDrop);
}

function openPronHallNear(x, y, sourceEntryIndex) {
  const hall = document.getElementById('daHallPopup');
  if (!hall) return;

  const pad = 12;
  const isMobile = window.innerWidth <= 768;
  const w = Math.min(760, window.innerWidth - pad*2);
  const h = Math.min(440, window.innerHeight - (isMobile ? 200 : 100));

  hall.style.width = w + 'px';

  // Center the hall on screen
  let left = (window.innerWidth - w) / 2;
  let top = (window.innerHeight - h) / 2;
  
  // Ensure it stays within bounds
  if (left < pad) left = pad;
  if (top < pad) top = pad;
  if (isMobile) {
    top = Math.min(top, window.innerHeight - h - 100); // Account for nav bar
  }

  hall.style.left = left + 'px';
  hall.style.top = top + 'px';

  const entry = pronCarouselState.entries[sourceEntryIndex] || pronCarouselState.entries[0];
  const subtitle = document.getElementById('daHallSubtitle');
  if (subtitle && entry) {
    subtitle.textContent = `Dragging: ${entry.studentName}  drop/click any student to jump.`;
  }

  hall.classList.add('open');
  hall.setAttribute('aria-hidden', 'false');
  pronCarouselState.hallOpen = true;
}

function closePronHall() {
  const hall = document.getElementById('daHallPopup');
  if (hall) {
    hall.classList.remove('open');
    hall.setAttribute('aria-hidden', 'true');
  }
  pronCarouselState.hallOpen = false;
  clearPronActiveDrop();
}

// Alias for the close button
function closeHallOfFame() {
  closePronHall();
}

function schedulePronHallClose() {
  clearTimeout(pronCarouselState.closeTimer);
  pronCarouselState.closeTimer = setTimeout(closePronHall, 120);
}

document.addEventListener('DOMContentLoaded', () => {
  const hall = document.getElementById('daHallPopup');
  if (hall) {
    hall.addEventListener('mouseenter', () => clearTimeout(pronCarouselState.closeTimer));
    hall.addEventListener('mouseleave', schedulePronHallClose);
  }
});

function clearPronActiveDrop() {
  if (pronCarouselState.activeDropStudent) {
    pronCarouselState.activeDropStudent.classList.remove('active-drop');
    pronCarouselState.activeDropStudent = null;
  }
}

function setPronActiveDrop(el) {
  if (pronCarouselState.activeDropStudent === el) return;
  clearPronActiveDrop();
  pronCarouselState.activeDropStudent = el;
  if (el) el.classList.add('active-drop');
}

function jumpToPronStudent(studentId) {
  const index = pronCarouselState.entries.findIndex(e => e.studentId === studentId);
  if (index >= 0) {
    pronCarouselState.index = index;
    updatePronCarouselPosition();
  }
}

window.addEventListener('resize', () => {
  const track = document.getElementById('pronTrack');
  if (track) {
    const firstCard = track.querySelector('.da-student-card');
    if (firstCard) {
      pronCarouselState.cardWidth = firstCard.getBoundingClientRect().width;
      updatePronCarouselPosition();
    }
  }
});

let grammarCarouselState = {
  entries: [],
  index: 0,
  cardWidth: 0,
  gap: 10
};

document.addEventListener('DOMContentLoaded', () => {
  const prevBtn = document.getElementById('grammarPrevBtn');
  const nextBtn = document.getElementById('grammarNextBtn');
  if (prevBtn) prevBtn.addEventListener('click', grammarCarouselPrev);
  if (nextBtn) nextBtn.addEventListener('click', grammarCarouselNext);
});

function grammarCarouselNext() {
  if (grammarCarouselState.entries.length === 0) return;
  grammarCarouselState.index = (grammarCarouselState.index + 1) % grammarCarouselState.entries.length;
  updateGrammarCarouselPosition();
}

function grammarCarouselPrev() {
  if (grammarCarouselState.entries.length === 0) return;
  grammarCarouselState.index = (grammarCarouselState.index - 1 + grammarCarouselState.entries.length) % grammarCarouselState.entries.length;
  updateGrammarCarouselPosition();
}

function updateGrammarCarouselPosition() {
  const track = document.getElementById('grammarTrack');
  const counter = document.getElementById('grammarCounter');
  if (!track) return;

  const x = -(grammarCarouselState.index * (grammarCarouselState.cardWidth + grammarCarouselState.gap));
  track.style.transform = `translate3d(${x}px,0,0)`;

  if (counter && grammarCarouselState.entries.length > 0) {
    counter.textContent = `${grammarCarouselState.index + 1} / ${grammarCarouselState.entries.length}`;
  }
}

function renderGrammarCarousel(entries) {
  grammarCarouselState.entries = entries;
  grammarCarouselState.index = 0;

  const track = document.getElementById('grammarTrack');
  const viewport = document.getElementById('grammarViewport');
  const controls = document.getElementById('grammarControls');

  if (!track || entries.length === 0) {
    if (viewport) viewport.style.display = 'none';
    if (controls) controls.style.display = 'none';
    return;
  }

  track.innerHTML = entries.map((entry, i) => {
    const initials = entry.studentName.split(' ').map(s => s[0]).join('').slice(0,2).toUpperCase();
    const avatarHtml = entry.studentPhotoUrl
      ? `<img src="${entry.studentPhotoUrl}" alt="${entry.studentName}">`
      : initials;
    const timeStr = entry.submittedAt ? entry.submittedAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

    return `
      <article class="da-student-card" data-entry="${i}">
        <div class="da-student-inner">
          <div class="da-student-top">
            <div class="da-student-avatar">${avatarHtml}</div>
            <div style="min-width:0;flex:1;">
              <p class="da-student-name">${entry.studentName}${entry.isMe ? ' (You)' : ''}</p>
              <p class="da-student-meta">${timeStr}</p>
            </div>
          </div>
          <div class="da-student-stats">
            <span class="da-stat-badge coins"> ${entry.coins || 0}</span>
            <span class="da-stat-badge vocab"> ${entry.vocabCount || 0}</span>
          </div>
        </div>
        <div class="da-audio-dropdown">
          <audio src="${entry.audioUrl}" controls></audio>
        </div>
      </article>
    `;
  }).join('');

  if (viewport) viewport.style.display = 'block';
  if (controls) controls.style.display = 'flex';

  track.querySelectorAll('.da-student-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.tagName === 'AUDIO') return;
      const wasExpanded = card.classList.contains('expanded');
      track.querySelectorAll('.da-student-card').forEach(c => c.classList.remove('expanded'));
      if (!wasExpanded) card.classList.add('expanded');
    });
  });

  setTimeout(() => {
    const firstCard = track.querySelector('.da-student-card');
    if (firstCard) {
      grammarCarouselState.cardWidth = firstCard.getBoundingClientRect().width;
      updateGrammarCarouselPosition();
    }
  }, 50);
}

function renderScriptWithVocabKeywords(script, vocabulary) {
  if (!script) return '';

  window.dailySentences = window.dailySentences || {};

  const lines = script.split('\n').filter(line => line.trim());

  let html = '';
  lines.forEach((line, index) => {
    const speakerMatch = line.match(/^([AB])\s*[:.]\s*(.+)$/i);

    if (speakerMatch) {
      const speaker = speakerMatch[1].toUpperCase();
      const sentence = speakerMatch[2].trim();
      const sentenceId = `sentence_${Date.now()}_${index}`;

      window.dailySentences[sentenceId] = {
        korean: sentence,
        speaker: speaker,
        fullLine: line
      };

      html += `
        <div style="margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px;">
          <strong style="color:#fff;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:4px;flex-shrink:0">${speaker}</strong>
          <span class="extractable-sentence"
                data-sentence-id="${sentenceId}"
                onclick="showSentenceTooltip(event, '${sentenceId}')"
                style="cursor:pointer;padding:4px 8px;border-radius:6px;transition:background 0.2s;border-bottom:2px dotted rgba(255,255,255,0.4)"
                onmouseover="this.style.background='rgba(255,255,255,0.15)'"
                onmouseout="this.style.background='transparent'">
            ${sentence}
          </span>
        </div>
      `;
    } else if (line.trim()) {
      html += `<div style="margin-bottom: 8px;">${line}</div>`;
    }
  });

  return html;
}

let currentDailySentence = null;

window.preRenderedSentenceData = window.preRenderedSentenceData || {};

/**
 * Pre-analyze all sentences in a daily activity script
 * This is a FALLBACK for old activities that don't have sentenceAnalysis
 * New activities have this data pre-computed when the teacher publishes
 */
async function preRenderSentenceAnalysis(script) {
  if (!script) return;

  if (window.preRenderedSentenceData && Object.keys(window.preRenderedSentenceData).length > 0) {
    return;
  }

  const lines = script.split('\n').filter(line => line.trim());
  const sentences = [];

  lines.forEach((line, index) => {
    const speakerMatch = line.match(/^([AB])\s*[:.]\s*(.+)$/i);
    if (speakerMatch) {
      sentences.push({
        korean: speakerMatch[2].trim(),
        speaker: speakerMatch[1].toUpperCase(),
        index: index
      });
    }
  });

  if (sentences.length === 0) return;


  const prompt = `Analyze these Korean sentences and provide translations and vocabulary.

${sentences.map((s, i) => `${i + 1}. "${s.korean}"`).join('\n')}

For EACH sentence, provide:
1. Natural English translation
2. Key vocabulary words (3-5 most important) with meanings and part of speech

Respond in this exact JSON format:
{
  "sentences": [
    {
      "index": 0,
      "korean": "original sentence",
      "english": "English translation",
      "vocabulary": [
        {"korean": "word1", "english": "meaning1", "partOfSpeech": "noun"},
        {"korean": "word2", "english": "meaning2", "partOfSpeech": "verb"}
      ]
    }
  ]
}`;

  try {
    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown.' },
      { role: 'user', content: prompt }
    ], 0.3);

    let aiData = null;
    try {
      const jsonStr = typeof response === 'string' ? response : JSON.stringify(response);
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      aiData = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
    } catch(e) {
      return;
    }

    if (aiData?.sentences) {
      window.preRenderedSentenceData = window.preRenderedSentenceData || {};

      aiData.sentences.forEach((sentenceAnalysis, i) => {
        const originalSentence = sentences[i];
        if (originalSentence) {
          window.preRenderedSentenceData[originalSentence.korean] = {
            english: sentenceAnalysis.english,
            vocabulary: sentenceAnalysis.vocabulary || []
          };
        }
      });
      console.log(`[Fallback] Pre-rendered ${Object.keys(window.preRenderedSentenceData).length} sentences`);
    }
  } catch(e) {
  }
}

function showSentenceTooltip(event, sentenceId) {
  event.stopPropagation();

  const sentenceData = window.dailySentences?.[sentenceId];
  if (!sentenceData) return;

  currentDailySentence = { ...sentenceData };

  const existingTooltip = document.getElementById('sentenceTooltip');
  if (existingTooltip) existingTooltip.remove();

  const tooltip = document.createElement('div');
  tooltip.id = 'sentenceTooltip';
  tooltip.style.cssText = `
    position: fixed;
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 10001;
    max-width: 350px;
    min-width: 300px;
  `;

  document.body.appendChild(tooltip);

  const rect = event.target.getBoundingClientRect();
  let left = Math.min(rect.left, window.innerWidth - 370);
  let top = rect.bottom + 10;

  if (top + 300 > window.innerHeight) {
    top = rect.top - 300;
  }

  tooltip.style.left = Math.max(10, left) + 'px';
  tooltip.style.top = Math.max(10, top) + 'px';

  const preRendered = window.preRenderedSentenceData?.[sentenceData.korean];

  if (preRendered) {
    currentDailySentence.english = preRendered.english;
    currentDailySentence.vocabulary = preRendered.vocabulary;
    renderSentenceTooltipContent(tooltip, sentenceData.korean, preRendered.english, preRendered.vocabulary);
  } else {
    tooltip.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div class="loading" style="width: 24px; height: 24px; margin: 0 auto 10px;"></div>
        <div style="color: #718096; font-size: 13px;">Analyzing sentence...</div>
      </div>
    `;

    fetchSentenceAnalysis(sentenceData.korean, tooltip);
  }

  setTimeout(() => {
    document.addEventListener('click', handleSentenceTooltipOutsideClick);
  }, 10);
}

/**
 * Handle clicks outside the tooltip to close it
 */
function handleSentenceTooltipOutsideClick(event) {
  const tooltip = document.getElementById('sentenceTooltip');
  if (tooltip && !tooltip.contains(event.target)) {
    closeSentenceTooltip();
    document.removeEventListener('click', handleSentenceTooltipOutsideClick);
  }
}

/**
 * Render the tooltip content with pre-rendered or fetched data
 */
function renderSentenceTooltipContent(tooltip, korean, english, vocabulary) {
  const posColors = {
    'noun': '#667eea',
    'verb': '#48bb78',
    'action verb': '#48bb78',
    'descriptive verb': '#38b2ac',
    'adjective': '#9f7aea',
    'adverb': '#ed8936',
    'expression': '#f56565'
  };

  let vocabHtml = '';
  if (vocabulary && vocabulary.length > 0) {
    vocabHtml = `
      <div style="margin-bottom: 12px;">
        <div style="font-size: 11px; color: #667eea; margin-bottom: 8px; font-weight: 600;"> Vocabulary Words:</div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
          ${vocabulary.map(v => {
            const koreanWord = (v.korean || '').replace(/'/g, "\\'");
            const englishWord = (v.english || '').replace(/'/g, "\\'");
            const pos = (v.partOfSpeech || '').replace(/'/g, "\\'");
            const color = posColors[v.partOfSpeech?.toLowerCase()] || '#667eea';
            return `
            <span onclick="event.stopPropagation(); extractVocabWordKeepTooltip('${koreanWord}', '${englishWord}', '${pos}', this)"
                  style="background: #f7fafc; border-left: 3px solid ${color}; padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;"
                  onmouseover="this.style.background='#edf2f7'"
                  onmouseout="this.style.background='#f7fafc'">
              <span style="color: #1a202c; font-weight: 500;">${v.korean}</span>
              <span style="color: #718096; margin-left: 4px;">${v.english}</span>
            </span>
          `}).join('')}
        </div>
        <div style="font-size: 10px; color: #a0aec0; margin-top: 6px;">Click a word to add to flashcards</div>
      </div>
    `;
  }

  tooltip.innerHTML = `
    <div style="margin-bottom: 10px;">
      <div style="font-size: 11px; color: #667eea; margin-bottom: 5px; font-weight: 600;"> Korean:</div>
      <div style="font-size: 15px; color: #1a202c; font-weight: 500; line-height: 1.5;">${korean}</div>
    </div>
    <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #667eea;">
      <div style="font-size: 11px; color: #667eea; margin-bottom: 4px; font-weight: 600;"> English:</div>
      <div style="font-size: 14px; color: #2d3748;">${english || 'Translation unavailable'}</div>
    </div>
    ${vocabHtml}
    <button onclick="event.stopPropagation(); saveSentenceToMyPhrases()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
       Add Phrase to My Flashcards
    </button>
  `;
}

/**
 * Fetch sentence analysis on-demand (fallback when not pre-rendered)
 */
async function fetchSentenceAnalysis(korean, tooltip) {
  try {
    const prompt = `Analyze this Korean sentence: "${korean}"

Provide:
1. Natural English translation
2. Key vocabulary words (3-5 most important words) with their meanings and part of speech

Respond in this exact JSON format:
{
  "english": "the English translation",
  "vocabulary": [
    {"korean": "word1", "english": "meaning1", "partOfSpeech": "noun"},
    {"korean": "word2", "english": "meaning2", "partOfSpeech": "verb"}
  ]
}`;

    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown.' },
      { role: 'user', content: prompt }
    ], 0.3);

    let aiData = null;
    try {
      const jsonStr = typeof response === 'string' ? response : JSON.stringify(response);
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      aiData = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
    } catch(e) {
      aiData = null;
    }

    if (aiData) {
      window.preRenderedSentenceData[korean] = {
        english: aiData.english,
        vocabulary: aiData.vocabulary || []
      };
    }

    currentDailySentence.english = aiData?.english || '';
    currentDailySentence.vocabulary = aiData?.vocabulary || [];

    renderSentenceTooltipContent(tooltip, korean, aiData?.english, aiData?.vocabulary);

  } catch(e) {
    tooltip.innerHTML = `
      <div style="margin-bottom: 10px;">
        <div style="font-size: 11px; color: #667eea; margin-bottom: 5px;"> Korean Sentence:</div>
        <div style="font-size: 16px; color: #1a202c; font-weight: 500; line-height: 1.5;">${korean}</div>
      </div>
      <div style="background: #fff5f5; padding: 10px; border-radius: 8px; margin-bottom: 12px; color: #c53030; font-size: 13px;">
        Could not analyze sentence. You can still save it!
      </div>
      <button onclick="event.stopPropagation(); saveSentenceToMyPhrases()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
         Add to My Phrases
      </button>
    `;
  }
}

async function extractVocabWordKeepTooltip(korean, english, partOfSpeech, element) {
  if (!currentUser) {
    showToast(' Please log in first');
    return;
  }

  window.pendingVocabWords = window.pendingVocabWords || new Set();

  if (window.pendingVocabWords.has(korean)) {
    element.innerHTML = '<span style="color: #ed8936;"> Adding...</span>';
    return;
  }

  window.pendingVocabWords.add(korean);

  element.innerHTML = '<span style="color: #48bb78;"> Added!</span>';
  element.style.background = '#f0fff4';
  element.style.pointerEvents = 'none';

  const posFolders = {
    'noun': ' Nouns',
    'verb': ' Action Verbs',
    'action verb': ' Action Verbs',
    'descriptive verb': ' Descriptive Verbs',
    'adjective': ' Adjectives',
    'adverb': ' Adverbs',
    'expression': ' Expressions'
  };

  const folderName = posFolders[partOfSpeech?.toLowerCase()] || ' Nouns';

  (async () => {
    try {
      let folderId = null;
      const foldersSnap = await db.collection('studentFolders')
        .where('studentId', '==', currentUser.uid)
        .where('name', '==', folderName)
        .get();

      if (foldersSnap.empty) {
        const folderRef = await db.collection('studentFolders').add({
          studentId: currentUser.uid,
          name: folderName,
          isPartOfSpeechFolder: true,
          isVocabulary: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        folderId = folderRef.id;
      } else {
        folderId = foldersSnap.docs[0].id;
      }

      const existingSnap = await db.collection('studentFlashcards')
        .where('studentId', '==', currentUser.uid)
        .where('korean', '==', korean)
        .get();

      if (!existingSnap.empty) {
        element.innerHTML = '<span style="color: #ed8936;"> Already saved!</span>';
        window.pendingVocabWords.delete(korean);
        return;
      }

      const flashcardRef = await db.collection('studentFlashcards').add({
        studentId: currentUser.uid,
        folderId: folderId,
        korean: korean,
        english: english,
        partOfSpeech: partOfSpeech,
        situationalData: null, // Will be added in background
        isVocabulary: true,
        source: 'daily-sentence-vocab',
        leitnerBox: 1,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });


      generateSituationalDataInBackground(flashcardRef.id, korean, english);

    } catch(e) {
    } finally {
      window.pendingVocabWords.delete(korean);
    }
  })();
}

/**
 * Generate situational data in background and update the flashcard
 * Uses a shared cache so each word only needs to be generated ONCE
 * All other students get the cached data instantly
 */
async function generateSituationalDataInBackground(flashcardId, korean, english) {
  console.log(` Starting situational data generation for: ${korean} (${english})`);

  try {
    const sanitize = (str) => str.trim().toLowerCase().replace(/[^a-z0-9-]/g, '_').substring(0, 50);
    const cacheKey = `${sanitize(korean)}_${sanitize(english)}`;


    const cacheDoc = await db.collection('situationalCache').doc(cacheKey).get();

    if (cacheDoc.exists) {
      const cachedData = cacheDoc.data();

      await db.collection('studentFlashcards').doc(flashcardId).update({
        situationalData: cachedData.situationalData
      });

      return;
    }


    const prompt = buildSituationalPrompt(korean, english);
    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only.' },
      { role: 'user', content: prompt }
    ], 0.7);


    const jsonMatch = (typeof response === 'string' ? response : JSON.stringify(response)).match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const situationalData = JSON.parse(jsonMatch[0]);


      await db.collection('situationalCache').doc(cacheKey).set({
        korean: korean,
        english: english,
        situationalData: situationalData,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });


      await db.collection('studentFlashcards').doc(flashcardId).update({
        situationalData: situationalData
      });

    } else {
    }
  } catch(e) {
  }
}

async function extractVocabWord(korean, english, partOfSpeech) {
  if (!currentUser) {
    showToast(' Please log in first');
    return;
  }

  const posFolders = {
    'noun': ' Nouns',
    'verb': ' Action Verbs',
    'action verb': ' Action Verbs',
    'descriptive verb': ' Descriptive Verbs',
    'adjective': ' Adjectives',
    'adverb': ' Adverbs',
    'expression': ' Expressions'
  };

  const folderName = posFolders[partOfSpeech?.toLowerCase()] || ' Nouns';

  try {
    let folderId = null;
    const foldersSnap = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('name', '==', folderName)
      .get();

    if (foldersSnap.empty) {
      const folderRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: folderName,
        isPartOfSpeechFolder: true,
        isVocabulary: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      folderId = folderRef.id;
    } else {
      folderId = foldersSnap.docs[0].id;
    }

    const existingSnap = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('korean', '==', korean)
      .get();

    if (!existingSnap.empty) {
      showToast(` "${korean}" is already in your flashcards!`);
      return;
    }

    let situationalData = null;
    try {
      const prompt = buildSituationalPrompt(korean, english);
      const response = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only.' },
        { role: 'user', content: prompt }
      ], 0.7);

      const jsonMatch = (typeof response === 'string' ? response : JSON.stringify(response)).match(/\{[\s\S]*\}/);
      if (jsonMatch) situationalData = JSON.parse(jsonMatch[0]);
    } catch(e) { }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: folderId,
      korean: korean,
      english: english,
      partOfSpeech: partOfSpeech,
      situationalData: situationalData,
      isVocabulary: true,
      source: 'daily-sentence-vocab',
      leitnerBox: 1,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(` "${korean}" added to ${folderName}!`);

  } catch(e) {
    showToast(' Failed to save word');
  }
}

function closeSentenceTooltip() {
  const tooltip = document.getElementById('sentenceTooltip');
  if (tooltip) tooltip.remove();
  currentDailySentence = null;
}

async function saveSentenceToMyPhrases() {
  if (!currentDailySentence || !currentUser) {
    showToast(' No sentence selected');
    return;
  }

  const { korean, speaker } = currentDailySentence;

  const btn = document.querySelector('#sentenceTooltip button');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = ' Generating translation...';
  }

  try {
    let folderId = null;
    const foldersSnap = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('isPhrases', '==', true)
      .get();

    if (foldersSnap.empty) {
      const folderRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: 'My Phrases',
        isPhrases: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      folderId = folderRef.id;
    } else {
      folderId = foldersSnap.docs[0].id;
    }

    const existingSnap = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('korean', '==', korean)
      .get();

    if (!existingSnap.empty) {
      showToast(` This phrase is already saved!`);
      closeSentenceTooltip();
      return;
    }

    let english = '';
    try {
      const response = await callAIProxy([
        { role: 'system', content: 'You are a Korean-English translator. Provide natural, fluent translations. Respond with just the translation, nothing else.' },
        { role: 'user', content: `Translate to English: "${korean}"` }
      ], 0.3);
      english = typeof response === 'string' ? response.trim() : '';
    } catch(e) {
      english = '(Translation pending)';
    }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: folderId,
      korean: korean,
      english: english,
      isPhrase: true,
      source: 'daily-activity-sentence',
      leitnerBox: 1,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(` Phrase saved to My Phrases!`);
    closeSentenceTooltip();

    if (typeof loadMyFlashcards === 'function') {
      loadMyFlashcards();
    }

  } catch(e) {
    showToast(' Failed to save phrase');
  }
}

function showTeacherProfile(teacherId, encodedName, encodedPhotoUrl, encodedBio) {
  const name = decodeURIComponent(encodedName);
  const photoUrl = decodeURIComponent(encodedPhotoUrl);
  const bio = decodeURIComponent(encodedBio);

  const existing = document.getElementById('teacherProfileModal');
  if (existing) existing.remove();

  const photoHtml = photoUrl
    ? `<img src="${photoUrl}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:4px solid #667eea">`
    : `<div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:48px;border:4px solid #667eea"></div>`;

  const modal = document.createElement('div');
  modal.id = 'teacherProfileModal';
  modal.className = 'grading-modal-overlay active';
  modal.innerHTML = `
    <div class="grading-modal" style="max-width:400px;text-align:center">
      <div style="padding:30px">
        ${photoHtml}
        <h2 style="margin:15px 0 10px;color:#1a202c">${name}</h2>
        <div style="color:#667eea;font-size:14px;margin-bottom:20px">Korean Teacher</div>
        ${bio ? `<div style="background:#f7fafc;padding:15px;border-radius:10px;color:#4a5568;font-size:14px;line-height:1.6;text-align:left">${bio}</div>` : '<div style="color:#a0aec0;font-style:italic">No bio available</div>'}
        <button onclick="document.getElementById('teacherProfileModal').remove()" style="margin-top:20px;padding:12px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer">
          Close
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

let gradedNotifications = [];

async function checkDailyActivityNotifications() {
  if (!currentUser) return;

  try {
    const submissionsSnap = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .where('isGraded', '==', true)
      .get();

    const unviewedSubmissions = submissionsSnap.docs.filter(doc => {
      const data = doc.data();
      return data.notificationViewed !== true;
    });

    if (unviewedSubmissions.length === 0) {
      hideProfileNotification();
      gradedNotifications = [];
      return;
    }

    gradedNotifications = unviewedSubmissions.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    showProfileNotification(unviewedSubmissions.length);


  } catch(e) {
  }
}

function showProfileNotification(count) {
  setTimeout(() => {
    const profileBtn = document.getElementById('floatingProfileBtn');
    if (!profileBtn) {
      const btnByClass = document.querySelector('.floating-profile-btn');
      if (btnByClass) {
        addNotificationToButton(btnByClass, count);
      }
      return;
    }
    addNotificationToButton(profileBtn, count);
  }, 500);
}

function addNotificationToButton(profileBtn, count) {
  const existing = document.getElementById('gradeNotificationBadge');
  if (existing) existing.remove();

  const dayOfWeek = new Date().getDay();
  const characterUrl = NOTIFICATION_CHARACTERS[dayOfWeek];
  const fallbackEmoji = NOTIFICATION_EMOJI[dayOfWeek];

  if (!document.getElementById('gradeNotificationStyles')) {
    const style = document.createElement('style');
    style.id = 'gradeNotificationStyles';
    style.textContent = `
      @keyframes gradeShake {
        0%, 100% { transform: rotate(0deg); }
        10% { transform: rotate(-12deg) scale(1.1); }
        20% { transform: rotate(12deg) scale(1.1); }
        30% { transform: rotate(-12deg) scale(1.1); }
        40% { transform: rotate(12deg) scale(1.1); }
        50% { transform: rotate(0deg); }
      }
      @keyframes gradeBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
      }
      #gradeNotificationBadge {
        position: absolute;
        top: -20px;
        right: -15px;
        width: 55px;
        height: 55px;
        animation: gradeShake 0.8s ease-in-out infinite, gradeBounce 0.5s ease-in-out infinite;
        cursor: pointer;
        z-index: 1000;
        filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
      }
      #gradeNotificationBadge img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      #gradeNotificationBadge .grade-notif-emoji {
        font-size: 40px;
        text-shadow: 0 3px 10px rgba(0,0,0,0.3);
      }
      #gradeNotificationBadge .grade-notif-count {
        position: absolute;
        top: -3px;
        right: -3px;
        background: linear-gradient(135deg, #f56565, #c53030);
        color: white;
        font-size: 12px;
        font-weight: bold;
        min-width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .calendar-grade-notif {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 24px;
        height: 24px;
        animation: gradeShake 1s ease-in-out infinite;
        cursor: pointer;
        z-index: 10;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      }
    `;
    document.head.appendChild(style);
  }

  const notification = document.createElement('div');
  notification.id = 'gradeNotificationBadge';

  const img = document.createElement('img');
  img.src = characterUrl;
  img.alt = 'Grade ready!';
  img.style.cssText = 'width: 100%; height: 100%; object-fit: contain;';
  img.onerror = function() {
    notification.innerHTML = `<span class="grade-notif-emoji">${fallbackEmoji}</span>${count > 1 ? '<span class="grade-notif-count">' + count + '</span>' : ''}`;
  };

  notification.appendChild(img);

  if (count > 1) {
    const countBadge = document.createElement('span');
    countBadge.className = 'grade-notif-count';
    countBadge.textContent = count;
    notification.appendChild(countBadge);
  }

  notification.onclick = (e) => {
    e.stopPropagation();
    e.preventDefault();
    switchTab('dailyActivity');
  };

  profileBtn.appendChild(notification);

}

function hideProfileNotification() {
  const notification = document.getElementById('gradeNotificationBadge');
  if (notification) {
    notification.remove();
  }
}

function updateCalendarWithGradeNotifications() {
  if (!gradedNotifications || gradedNotifications.length === 0) return;

  gradedNotifications.forEach(sub => {
    const gradedDate = sub.gradedAt?.toDate();
    if (!gradedDate) return;

    const year = gradedDate.getFullYear();
    const month = String(gradedDate.getMonth() + 1).padStart(2, '0');
    const day = String(gradedDate.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;

    let calendarCell = document.querySelector(`[data-date="${dateStr}"]`);
    if (!calendarCell) {
      calendarCell = document.querySelector(`[data-day="${gradedDate.getDate()}"][data-month="${gradedDate.getMonth()}"]`);
    }
    if (!calendarCell) return;

    if (calendarCell.querySelector('.calendar-grade-notif')) return;

    const dayOfWeek = gradedDate.getDay();
    const characterUrl = NOTIFICATION_CHARACTERS[dayOfWeek];

    const notifIcon = document.createElement('img');
    notifIcon.className = 'calendar-grade-notif';
    notifIcon.src = characterUrl;
    notifIcon.alt = 'Graded!';
    notifIcon.onclick = (e) => {
      e.stopPropagation();
      viewGradedSubmission(sub.id);
    };

    calendarCell.style.position = 'relative';
    calendarCell.appendChild(notifIcon);
  });
}

async function viewGradedSubmission(submissionId) {
  try {
    await db.collection('dailySubmissions').doc(submissionId).update({
      notificationViewed: true
    });

    checkDailyActivityNotifications();

    switchTab('dailyActivity');

  } catch(e) {
  }
}

async function markDailyNotificationsViewed() {
  if (!currentUser) return;

  try {
    const submissionsSnap = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .where('isGraded', '==', true)
      .get();

    const unviewedDocs = submissionsSnap.docs.filter(doc => {
      const data = doc.data();
      return data.notificationViewed !== true;
    });

    if (unviewedDocs.length === 0) return;

    const batch = db.batch();
    unviewedDocs.forEach(doc => {
      batch.update(doc.ref, { notificationViewed: true });
    });
    await batch.commit();

    hideProfileNotification();
    gradedNotifications = [];


  } catch(e) {
  }
}

async function loadTeacherProfile() {
  if (!currentUser) return;

  try {
    const doc = await db.collection('teachers').doc(currentUser.uid).get();
    if (doc.exists) {
      const data = doc.data();
      document.getElementById('teacherDisplayNameInput').value = data.displayName || '';
      document.getElementById('teacherBioInput').value = data.bio || '';

      if (data.photoUrl) {
        document.getElementById('teacherProfilePhotoPreview').innerHTML =
          `<img src="${data.photoUrl}" style="width:100%;height:100%;object-fit:cover">`;
      }
    } else {
      document.getElementById('teacherDisplayNameInput').value = currentUser.displayName || '';
    }
  } catch(e) {
  }
}

function previewTeacherProfilePhoto() {
  const input = document.getElementById('teacherProfilePhotoInput');
  const preview = document.getElementById('teacherProfilePhotoPreview');

  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover">`;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

async function saveTeacherProfile() {
  if (!currentUser) return;

  const displayName = document.getElementById('teacherDisplayNameInput').value.trim();
  const bio = document.getElementById('teacherBioInput').value.trim();
  const photoInput = document.getElementById('teacherProfilePhotoInput');

  if (!displayName) {
    showToast(' Please enter a display name');
    return;
  }

  try {
    showToast(' Saving profile...');

    let photoUrl = null;

    if (photoInput.files && photoInput.files[0]) {
      const file = photoInput.files[0];
      const storageRef = storage.ref(`teacher-profiles/${currentUser.uid}/photo_${Date.now()}`);
      await storageRef.put(file);
      photoUrl = await storageRef.getDownloadURL();
    } else {
      const existingDoc = await db.collection('teachers').doc(currentUser.uid).get();
      if (existingDoc.exists) {
        photoUrl = existingDoc.data().photoUrl || null;
      }
    }

    await db.collection('teachers').doc(currentUser.uid).set({
      displayName: displayName,
      bio: bio,
      photoUrl: photoUrl,
      email: currentUser.email,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    showToast(' Profile saved!');

  } catch(e) {
    showToast(' Failed to save profile');
  }
}

function formatDialogueForDisplay(script) {
  if (!script) return '';

  let formatted = script;

  formatted = formatted
    .replace(/\s*([AB])\s*[:.]\s*/gi, '<br><strong style="color:#fff;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:4px;margin-right:8px">$1</strong>')
    .trim();

  if (formatted.startsWith('<br>')) {
    formatted = formatted.substring(4);
  }

  if (!formatted.includes('<strong')) {
    formatted = script
      .replace(/([.?!])\s+/g, '$1<br><br>')
      .trim();
  }

  return formatted;
}

let currentDailyVocabWord = null;

function showDailyVocabTooltip(event, wordId) {
  event.stopPropagation();

  const wordData = window.dailyVocabData?.[wordId];
  if (!wordData) {
    return;
  }

  currentDailyVocabWord = { ...wordData };

  const tooltip = document.getElementById('dailyVocabTooltip');
  if (!tooltip) return;

  const posLabels = {
    'noun': { label: ' (Noun)', color: '#667eea' },
    'verb': { label: ' (Verb)', color: '#48bb78' },
    'adverb': { label: ' (Adverb)', color: '#ed8936' },
    'adjective': { label: ' (Adjective)', color: '#9f7aea' },
    'expression': { label: ' (Expression)', color: '#f56565' },
    'word': { label: ' (Word)', color: '#718096' }
  };

  const pos = posLabels[wordData.type] || posLabels['word'];

  tooltip.innerHTML = `
    <div style="margin-bottom: 8px;">
      <span style="font-size: 20px; font-weight: bold; color: #1a202c;">${wordData.korean}</span>
    </div>
    <div style="color: #4a5568; font-size: 14px; margin-bottom: 8px;">${wordData.english}</div>
    <div style="margin-bottom: 12px;">
      <span style="background: ${pos.color}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">${pos.label}</span>
    </div>

    <div style="background: #f7fafc; border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 12px; color: #718096;">
       Click below to add this word to your flashcards with AI-generated situational practice sentences!
    </div>

    <button id="saveVocabBtn" onclick="saveDailyVocabWordWithSituational()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
       Add to My Flashcards
    </button>
  `;

  tooltip.style.left = Math.max(10, Math.min(event.pageX - 120, window.innerWidth - 280)) + 'px';
  tooltip.style.top = (event.pageY + 15) + 'px';

  setTimeout(() => {
    document.addEventListener('click', closeDailyVocabTooltip, { once: true });
  }, 10);
}

function closeDailyVocabTooltip() {
  const tooltip = document.getElementById('dailyVocabTooltip');
  if (tooltip) tooltip.style.display = 'none';
}

async function saveDailyVocabWordWithSituational() {
  if (!currentDailyVocabWord || !currentUser) return;

  const saveBtn = document.getElementById('saveVocabBtn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = ' Generating situational practice...';
  }

  try {
    const posFolders = {
      'noun': ' Nouns',
      'action verb': ' Action Verbs',
      'descriptive verb': ' Descriptive Verbs',
      'adjective': ' Adjectives',
      'adverb': ' Adverbs',
      'conjunction': ' Conjunctions',
      'expression': ' Expressions',
      'verb': ' Action Verbs'
    };

    const pos = (currentDailyVocabWord.type || 'noun').toLowerCase();
    const folderName = posFolders[pos] || ' Nouns';

    let folderId = null;
    const foldersSnap = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('name', '==', folderName)
      .get();

    if (foldersSnap.empty) {
      const newFolder = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: folderName,
        isPartOfSpeechFolder: true,
        isVocabulary: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      folderId = newFolder.id;
    } else {
      folderId = foldersSnap.docs[0].id;
    }

    const existingSnap = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('korean', '==', currentDailyVocabWord.korean)
      .get();

    if (!existingSnap.empty) {
      const existingCard = existingSnap.docs[0].data();
      let existingFolderName = 'your flashcards';
      try {
        const folderDoc = await db.collection('studentFolders').doc(existingCard.folderId).get();
        if (folderDoc.exists) existingFolderName = folderDoc.data().name || 'your flashcards';
      } catch(e) {}

      showToast(` "${currentDailyVocabWord.korean}" already exists in ${existingFolderName}!`);
      closeDailyVocabTooltip();
      return;
    }

    let situationalData = null;
    try {
      const prompt = buildSituationalPrompt(currentDailyVocabWord.korean, currentDailyVocabWord.english);
      const response = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.7);

      if (typeof response === 'string') {
        situationalData = JSON.parse(response);
      } else {
        situationalData = response;
      }
    } catch(aiError) {
    }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: folderId,
      korean: currentDailyVocabWord.korean,
      english: currentDailyVocabWord.english,
      partOfSpeech: currentDailyVocabWord.type || 'word',
      situationalData: situationalData,
      leitnerBox: 1,
      isVocabulary: true,
      source: 'daily-activity',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(` "${currentDailyVocabWord.korean}" added to ${folderName}!`);
    closeDailyVocabTooltip();

    if (typeof loadMyFlashcards === 'function') {
      loadMyFlashcards();
    }

  } catch(e) {
    showToast(' Failed to save');

    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = ' Add to My Flashcards';
    }
  }
}

let studentRecState = { mediaRecorder: null, audioChunks: [], audioBlob: null, transcript: '' };

let currentRecordingActivity = null;

async function openStudentRecordingModal(activityId) {
  try {
    const activityDoc = await db.collection('dailyActivities').doc(activityId).get();
    if (!activityDoc.exists) {
      showToast(' Activity not found');
      return;
    }
    currentRecordingActivity = { id: activityId, ...activityDoc.data() };
  } catch(e) {
    showToast(' Could not load activity');
    return;
  }

  const plainScript = (currentRecordingActivity.script || '')
    .replace(/([AB])\s*[:.]\s*/gi, '<strong style="color:#667eea">$1:</strong> ')
    .replace(/\n+/g, ' &nbsp;&nbsp; ');

  let modal = document.getElementById('studentRecordModal');
  if (modal) {
    modal.remove();
  }

  modal = document.createElement('div');
  modal.id = 'studentRecordModal';
  modal.style.cssText = `
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

  modal.innerHTML = `
    <div style="width:100%;max-width:650px;display:flex;flex-direction:column;align-items:center;gap:20px">

      <!-- Script Display - Full focus, no scroll -->
      <div style="background:white;border-radius:12px;padding:25px 30px;width:100%">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="font-size:11px;color:#718096;text-transform:uppercase;letter-spacing:1px"> Read this script</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:10px;color:#718096;">Font:</span>
            <button onclick="adjustScriptFontSize(-2)" style="width:24px;height:24px;border-radius:4px;border:1px solid #e2e8f0;background:white;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;">A-</button>
            <button onclick="adjustScriptFontSize(2)" style="width:24px;height:24px;border-radius:4px;border:1px solid #e2e8f0;background:white;cursor:pointer;font-size:14px;font-weight:bold;display:flex;align-items:center;justify-content:center;">A+</button>
          </div>
        </div>
        <div id="modalScriptText" style="font-size:${parseInt(localStorage.getItem('scriptFontSize') || '18')}px;line-height:2;color:#1a202c;text-align:center">${plainScript}</div>
      </div>

      <!-- Controls Row -->
      <div style="display:flex;align-items:center;gap:20px;width:100%;justify-content:center">

        <!-- Teacher Video (small) -->
        ${currentRecordingActivity.teacherVideoUrl ? `
          <div style="flex-shrink:0">
            <div style="position:relative;cursor:pointer" onclick="toggleStudentModalTeacherVideo(document.getElementById('studentModalTeacherVideo'))">
              <video id="studentModalTeacherVideo" src="${currentRecordingActivity.teacherVideoUrl}" style="width:100px;height:56px;border-radius:6px;object-fit:cover;background:#000"></video>
              <div id="studentModalVideoOverlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;border-radius:6px;transition:opacity 0.2s">
                <div style="background:rgba(0,0,0,0.6);border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center">
                  <span id="studentModalVideoIcon" style="color:white;font-size:10px;margin-left:2px"></span>
                </div>
              </div>
            </div>
            <div style="font-size:9px;color:#718096;text-align:center;margin-top:3px">Teacher</div>
          </div>
        ` : (currentRecordingActivity.teacherAudioUrl ? `
          <div style="flex-shrink:0">
            <audio src="${currentRecordingActivity.teacherAudioUrl}" controls style="height:32px;width:150px"></audio>
            <div style="font-size:9px;color:#718096;text-align:center;margin-top:3px">Teacher Audio</div>
          </div>
        ` : '')}

        <!-- Recording Button -->
        <div style="text-align:center">
          <div id="studentRecStatus" style="color:#a0aec0;font-size:12px;margin-bottom:6px">Tap to record</div>
          <button id="startStudRecBtn" onclick="startStudentRecFullscreen()" style="padding:14px 32px;background:linear-gradient(135deg,#f56565,#c53030);color:white;border:none;border-radius:30px;font-weight:600;cursor:pointer;font-size:15px">
             Start Recording
          </button>
          <button id="stopStudRecBtn" onclick="stopStudentRecFullscreen()" style="display:none;padding:14px 32px;background:#10b981;color:white;border:none;border-radius:30px;font-weight:600;cursor:pointer;font-size:15px">
             Finish & Submit
          </button>
        </div>
      </div>

      <!-- Recording Indicator & Transcription (appears during/after recording) -->
      <div id="recordingFeedback" style="display:none;width:100%;max-width:500px">
        <div id="studentRecIndicator" style="text-align:center;margin-bottom:10px">
          <span style="background:rgba(239,68,68,0.9);color:white;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:600"> Recording...</span>
        </div>
        <div id="liveTranscriptBox" style="background:rgba(255,255,255,0.95);border-radius:8px;padding:12px;text-align:left;max-height:80px;overflow-y:auto">
          <div style="font-size:10px;color:#667eea;margin-bottom:4px"> Live Transcription:</div>
          <div id="liveTranscriptText" style="font-size:14px;color:#2d3748;line-height:1.5"><em style="color:#a0aec0">Listening...</em></div>
        </div>
      </div>

      <!-- Audio Preview (appears after recording) -->
      <audio id="studentAudioPrev" controls style="display:none;width:100%;max-width:400px"></audio>

      <!-- Cancel Button -->
      <button onclick="closeStudentRecModal()" style="background:none;color:#718096;border:1px solid #718096;padding:10px 25px;border-radius:25px;cursor:pointer;font-size:13px;margin-top:10px">
         Cancel
      </button>
    </div>
  `;
  document.body.appendChild(modal);

  studentRecState = { mediaRecorder: null, audioChunks: [], audioBlob: null, transcript: '' };
}

/**
 * Adjust script font size in recording modal and daily activity
 */
let scriptFontSize = parseInt(localStorage.getItem('scriptFontSize') || '18');

function adjustScriptFontSize(delta) {
  scriptFontSize = Math.max(12, Math.min(36, scriptFontSize + delta));
  localStorage.setItem('scriptFontSize', scriptFontSize);
  
  // Update modal script
  const modalScript = document.getElementById('modalScriptText');
  if (modalScript) {
    modalScript.style.fontSize = scriptFontSize + 'px';
  }
  
  // Update main daily activity script
  const mainScript = document.getElementById('dailyActivityScriptText');
  if (mainScript) {
    mainScript.style.fontSize = scriptFontSize + 'px';
  }
  
  // Update all da-script-preview elements
  document.querySelectorAll('.da-script-preview').forEach(el => {
    el.style.fontSize = scriptFontSize + 'px';
  });
}

/**
 * Toggle teacher video in student modal (small inline player)
 */
function toggleStudentModalTeacherVideo(videoEl) {
  const overlay = document.getElementById('studentModalVideoOverlay');
  const icon = document.getElementById('studentModalVideoIcon');

  if (videoEl.paused) {
    videoEl.play();
    if (overlay) overlay.style.opacity = '0';
    if (icon) icon.textContent = '';
  } else {
    videoEl.pause();
    if (overlay) overlay.style.opacity = '1';
    if (icon) icon.textContent = '';
  }
}

/**
 * Start student recording with fullscreen modal
 */
async function startStudentRecFullscreen() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    studentRecState.mediaRecorder = new MediaRecorder(stream);
    studentRecState.audioChunks = [];
    studentRecState.transcript = '';
    studentRecState.stream = stream;

    studentRecState.mediaRecorder.ondataavailable = e => studentRecState.audioChunks.push(e.data);
    studentRecState.mediaRecorder.onstop = () => {
      studentRecState.audioBlob = new Blob(studentRecState.audioChunks, { type: 'audio/webm' });
      const prev = document.getElementById('studentAudioPrev');
      if (prev) { prev.src = URL.createObjectURL(studentRecState.audioBlob); prev.style.display = 'block'; }

      document.getElementById('studentRecStatus').textContent = ' Saved!';
      document.getElementById('studentRecIndicator').innerHTML = '<span style="background:rgba(72,187,120,0.9);color:white;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:600"> Recording saved</span>';

      document.getElementById('submitSection').style.display = 'block';

      stream.getTracks().forEach(t => t.stop());

      const transcript = stopDailyActivityTranscription();
      studentRecState.transcript = transcript;

      const liveText = document.getElementById('liveTranscriptText');
      if (liveText) {
        if (transcript) {
          liveText.innerHTML = transcript;
        } else {
          liveText.innerHTML = '<em style="color:#a0aec0">No speech detected. Your recording is still saved.</em>';
        }
      }
    };

    studentRecState.mediaRecorder.start();
    document.getElementById('startStudRecBtn').style.display = 'none';
    document.getElementById('stopStudRecBtn').style.display = 'inline-block';
    document.getElementById('studentRecStatus').textContent = 'Recording...';

    document.getElementById('recordingFeedback').style.display = 'block';

    startDailyActivityTranscription();

  } catch(e) {
    showToast(' Mic error: ' + e.message);
  }
}

/**
 * Stop student recording in fullscreen modal - auto submits
 */
function stopStudentRecFullscreen() {
  if (studentRecState.mediaRecorder) {
    const activityId = currentRecordingActivity?.id;

    studentRecState.mediaRecorder.onstop = async () => {
      studentRecState.audioBlob = new Blob(studentRecState.audioChunks, { type: 'audio/webm' });

      document.getElementById('studentRecStatus').textContent = ' Uploading...';
      document.getElementById('studentRecIndicator').innerHTML = '<span style="background:rgba(102,126,234,0.9);color:white;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:600"> Uploading...</span>';
      document.getElementById('stopStudRecBtn').style.display = 'none';

      if (studentRecState.stream) {
        studentRecState.stream.getTracks().forEach(t => t.stop());
      }

      const transcript = stopDailyActivityTranscription();
      studentRecState.transcript = transcript;

      const liveText = document.getElementById('liveTranscriptText');
      if (liveText) {
        if (transcript) {
          liveText.innerHTML = transcript;
        } else {
          liveText.innerHTML = '<em style="color:#a0aec0">No speech detected. Your recording is still saved.</em>';
        }
      }

      if (activityId) {
        await submitStudentRec(activityId);
      }
    };

    studentRecState.mediaRecorder.stop();
  }
}

/**
 * Format dialogue script with hoverable sentences for instant translation
 * Uses pre-rendered sentenceAnalysis - no AI calls needed!
 */
function formatDialogueScriptWithHover(script, sentenceAnalysis) {
  if (!script) return '';

  const lines = script.split('\n').filter(line => line.trim());
  let html = '';

  lines.forEach((line, index) => {
    const speakerMatch = line.match(/^([AB])\s*[:.]\s*(.+)$/i);

    if (speakerMatch) {
      const speaker = speakerMatch[1].toUpperCase();
      const sentence = speakerMatch[2].trim();

      const analysis = sentenceAnalysis[sentence];
      const englishTranslation = analysis?.english || '';

      const escapedEnglish = englishTranslation.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      html += `
        <div style="margin-bottom:8px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background 0.2s"
             class="hoverable-script-line"
             onclick="toggleSentenceTranslation(this)"
             data-english="${escapedEnglish}">
          <strong style="color:#667eea;font-size:13px">${speaker}:</strong>
          <span style="font-size:13px">${sentence}</span>
          <div class="sentence-translation" style="display:none;background:#e8f4f8;padding:5px 8px;border-radius:4px;margin-top:4px;font-size:11px;color:#2d3748;border-left:2px solid #667eea">
             ${englishTranslation || '<em style="color:#a0aec0">Translation not available</em>'}
          </div>
        </div>
      `;
    } else if (line.trim()) {
      html += `<div style="margin-bottom:6px;font-size:13px">${line}</div>`;
    }
  });

  return html;
}

/**
 * Toggle sentence translation visibility
 */
function toggleSentenceTranslation(element) {
  const translationDiv = element.querySelector('.sentence-translation');
  if (translationDiv) {
    const isVisible = translationDiv.style.display !== 'none';
    translationDiv.style.display = isVisible ? 'none' : 'block';
    element.style.background = isVisible ? 'transparent' : 'rgba(102, 126, 234, 0.1)';
  }
}

function formatDialogueScript(script) {
  if (!script) return '';

  let formatted = script
    .replace(/([AB])\s*[:.]\s*/gi, '\n<strong style="color:#667eea">$1:</strong> ')
    .replace(/\n\s*\n/g, '\n')
    .replace(/([.?!])\s*([AB])/g, '$1\n<strong style="color:#667eea">$2</strong>')
    .trim();

  if (!formatted.includes('<strong')) {
    formatted = script
      .replace(/([.?!])\s+/g, '$1<br><br>')
      .trim();
  }

  formatted = formatted.replace(/\n/g, '<br>');

  return formatted;
}

function closeStudentRecModal() {
  stopDailyActivityTranscription();

  if (studentRecState.mediaRecorder && studentRecState.mediaRecorder.state !== 'inactive') {
    studentRecState.mediaRecorder.stop();
  }

  if (studentRecState.stream) {
    studentRecState.stream.getTracks().forEach(t => t.stop());
  }

  const teacherVideo = document.getElementById('studentModalTeacherVideo');
  if (teacherVideo) teacherVideo.pause();

  const modal = document.getElementById('studentRecordModal');
  if (modal) modal.remove();
}

async function startStudentRec() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    studentRecState.mediaRecorder = new MediaRecorder(stream);
    studentRecState.audioChunks = [];
    studentRecState.transcript = '';

    studentRecState.mediaRecorder.ondataavailable = e => studentRecState.audioChunks.push(e.data);
    studentRecState.mediaRecorder.onstop = () => {
      studentRecState.audioBlob = new Blob(studentRecState.audioChunks, { type: 'audio/webm' });
      const prev = document.getElementById('studentAudioPrev');
      if (prev) { prev.src = URL.createObjectURL(studentRecState.audioBlob); prev.style.display = 'block'; }
      document.getElementById('studentRecStatus').textContent = ' Saved!';
      document.getElementById('submitStudRecBtn').disabled = false;
      stream.getTracks().forEach(t => t.stop());

      const transcript = stopDailyActivityTranscription();
      studentRecState.transcript = transcript;

      const liveBox = document.getElementById('liveTranscriptBox');
      const liveText = document.getElementById('liveTranscriptText');
      if (liveBox && liveText) {
        if (transcript) {
          liveText.innerHTML = transcript;
          liveBox.style.borderColor = '#48bb78';
        } else {
          liveText.innerHTML = '<em style="color:#a0aec0">No speech detected. Your recording is still saved.</em>';
        }
      }
    };

    studentRecState.mediaRecorder.start();
    document.getElementById('startStudRecBtn').style.display = 'none';
    document.getElementById('stopStudRecBtn').style.display = 'inline-flex';
    document.getElementById('studentRecStatus').textContent = ' Recording...';

    const liveBox = document.getElementById('liveTranscriptBox');
    if (liveBox) liveBox.style.display = 'block';

    startDailyActivityTranscription();

  } catch(e) {
    showToast(' Mic error: ' + e.message);
  }
}

function stopStudentRec() {
  if (studentRecState.mediaRecorder) {
    studentRecState.mediaRecorder.stop();
    document.getElementById('startStudRecBtn').style.display = 'inline-flex';
    document.getElementById('stopStudRecBtn').style.display = 'none';
  }
}

let dailyActivityTranscription = {
  recognition: null,
  isTranscribing: false,
  finalText: '',
  interimText: ''
};

function startDailyActivityTranscription() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  dailyActivityTranscription.recognition = new SpeechRecognition();
  dailyActivityTranscription.recognition.lang = 'ko-KR';
  dailyActivityTranscription.recognition.continuous = true;
  dailyActivityTranscription.recognition.interimResults = true;
  dailyActivityTranscription.recognition.maxAlternatives = 1;

  dailyActivityTranscription.finalText = '';
  dailyActivityTranscription.interimText = '';
  dailyActivityTranscription.isTranscribing = true;

  dailyActivityTranscription.recognition.onresult = (event) => {
    let interim = '';
    let final = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        final += transcript + ' ';
      } else {
        interim += transcript;
      }
    }

    if (final) {
      dailyActivityTranscription.finalText += final;
    }
    dailyActivityTranscription.interimText = interim;

    const liveText = document.getElementById('liveTranscriptText');
    if (liveText) {
      const displayText = dailyActivityTranscription.finalText +
                          '<span style="color:#a0aec0">' + dailyActivityTranscription.interimText + '</span>';
      liveText.innerHTML = displayText || '<em style="color:#a0aec0">Listening...</em>';
    }
  };

  dailyActivityTranscription.recognition.onerror = (event) => {
    if (event.error === 'no-speech' && dailyActivityTranscription.isTranscribing) {
      setTimeout(() => {
        if (dailyActivityTranscription.isTranscribing && dailyActivityTranscription.recognition) {
          try {
            dailyActivityTranscription.recognition.start();
          } catch(e) {}
        }
      }, 100);
    }
  };

  dailyActivityTranscription.recognition.onend = () => {
    if (dailyActivityTranscription.isTranscribing) {
      try {
        dailyActivityTranscription.recognition.start();
      } catch(e) {
      }
    }
  };

  try {
    dailyActivityTranscription.recognition.start();
  } catch(e) {
  }
}

function stopDailyActivityTranscription() {
  dailyActivityTranscription.isTranscribing = false;

  if (dailyActivityTranscription.recognition) {
    try {
      dailyActivityTranscription.recognition.stop();
    } catch(e) {}
    dailyActivityTranscription.recognition = null;
  }

  const result = (dailyActivityTranscription.finalText + dailyActivityTranscription.interimText).trim();
  return result;
}

async function submitStudentRec(activityId) {
  if (!studentRecState.audioBlob) return;
  try {
    showToast(' Submitting...');

    let recordingDuration = 0;
    try {
      const tempAudioUrl = URL.createObjectURL(studentRecState.audioBlob);
      const tempAudio = new Audio(tempAudioUrl);
      await new Promise((resolve) => {
        tempAudio.onloadedmetadata = () => {
          recordingDuration = Math.round(tempAudio.duration);
          resolve();
        };
        tempAudio.onerror = () => resolve();
        setTimeout(resolve, 2000); // Timeout fallback
      });
      URL.revokeObjectURL(tempAudioUrl);
    } catch(e) {
    }

    const ref = storage.ref(`daily-submissions/${activityId}/${currentUser.uid}_${Date.now()}.webm`);
    await ref.put(studentRecState.audioBlob);
    const url = await ref.getDownloadURL();

    await db.collection('dailySubmissions').add({
      activityId,
      studentId: currentUser.uid,
      audioUrl: url,
      transcript: studentRecState.transcript || '', // Include transcript!
      recordingDuration: recordingDuration, // Track duration for stats
      submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
      isGraded: false,
      grades: {},
      totalScore: 0
    });

    await db.collection('dailyActivities').doc(activityId).update({ submissionCount: firebase.firestore.FieldValue.increment(1) });
    // Coins removed from daily activities - only earned through drills, flashcard games, etc.
    recordPracticeActivity('daily-pronunciation');
    showToast(' Submitted!');
    closeStudentRecModal();
    loadStudentDailyActivity();
  } catch(e) { console.error(e); showToast(' Failed'); }
}

async function deleteMyDailySubmission(submissionId, activityId) {
  if (!confirm('Are you sure you want to delete your submission?\n\n Any drills created from this submission will also be deleted.')) {
    return;
  }

  try {
    showToast(' Deleting...');

    const drillsSnapshot = await db.collection('pronunciationLeitner')
      .where('studentId', '==', currentUser.uid)
      .where('submissionId', '==', submissionId)
      .get();

    const deletePromises = [];
    drillsSnapshot.forEach(doc => {
      deletePromises.push(db.collection('pronunciationLeitner').doc(doc.id).delete());
    });
    await Promise.all(deletePromises);

    await db.collection('dailySubmissions').doc(submissionId).delete();

    await db.collection('dailyActivities').doc(activityId).update({
      submissionCount: firebase.firestore.FieldValue.increment(-1)
    });

    // No coin deduction - coins not awarded for daily activities anymore

    await recordActivity('deleted daily submission');

    showToast(' Submission deleted.');
    loadStudentDailyActivity();

  } catch(e) {
    showToast(' Failed to delete');
  }
}


const teamworkState = {
  currentConversation: null,
  mediaRecorder: null,
  mediaStream: null,
  recordedChunks: [],
  isRecording: false,
  recordingType: null, // 'video' or 'audio'
  recordingMode: null, // 'start', 'respond', 'reply'
  recordingTimer: null,
  recordingSeconds: 0,
  transcription: '',
  aiCorrection: null,
  mediaBlob: null,
  speechRecognition: null
};

function hideTeamworkInstructions() {
  const banner = document.getElementById('teamworkInstructionsBanner');
  if (banner) {
    banner.style.display = 'none';
    localStorage.setItem('hideTeamworkInstructions', 'true');
  }
}

function checkTeamworkInstructionsVisibility() {
  const hidden = localStorage.getItem('hideTeamworkInstructions');
  if (hidden === 'true') {
    const banner = document.getElementById('teamworkInstructionsBanner');
    if (banner) banner.style.display = 'none';
  }
}

async function loadTeamworkActivity() {
  if (!currentUser) return;

  const statusText = document.getElementById('teamworkStatusText');
  const statusEl = document.querySelector('.teamwork-status');

  checkTeamworkInstructionsVisibility();

  try {
    document.getElementById('teamworkEmpty').style.display = 'none';
    document.getElementById('teamworkWaiting').style.display = 'none';
    document.getElementById('teamworkThread').style.display = 'none';
    document.getElementById('teamworkRespond').style.display = 'none';
    document.getElementById('teamworkCompleted').style.display = 'none';

    let activeConversation = null;
    let userRole = null;
    let needsToRespond = false;

    const asStudentASnap = await db.collection('teamworkConversations')
      .where('studentAId', '==', currentUser.uid)
      .get();

    let studentAConvs = asStudentASnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    studentAConvs.sort((a, b) => {
      const aTime = a.createdAt?.toDate?.() || new Date(0);
      const bTime = b.createdAt?.toDate?.() || new Date(0);
      return bTime - aTime;
    });

    for (const conv of studentAConvs) {
      if (conv.status === 'waiting' || conv.status === 'pending_reply') {
        activeConversation = conv;
        userRole = 'studentA';
        if (conv.status === 'pending_reply') {
          needsToRespond = true;
        }
        break;
      }
    }

    if (!activeConversation) {
      const asStudentBSnap = await db.collection('teamworkConversations')
        .where('studentBId', '==', currentUser.uid)
        .get();

      let studentBConvs = asStudentBSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      studentBConvs.sort((a, b) => {
        const aTime = a.createdAt?.toDate?.() || new Date(0);
        const bTime = b.createdAt?.toDate?.() || new Date(0);
        return bTime - aTime;
      });

      for (const conv of studentBConvs) {
        if (conv.status === 'active' || conv.status === 'pending_reply') {
          activeConversation = conv;
          userRole = 'studentB';
          needsToRespond = conv.status === 'active';
          break;
        }
      }
    }

    teamworkState.currentConversation = activeConversation;

    if (!activeConversation) {
      const availableSnap = await db.collection('teamworkConversations')
        .where('status', '==', 'waiting')
        .get();

      let availableConvs = availableSnap.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(conv => conv.studentAId !== currentUser.uid);

      availableConvs.sort((a, b) => {
        const aTime = a.createdAt?.toDate?.() || new Date(0);
        const bTime = b.createdAt?.toDate?.() || new Date(0);
        return bTime - aTime;
      });

      if (availableConvs.length > 0) {
        const availableConv = availableConvs[0];
        teamworkState.currentConversation = availableConv;

        document.getElementById('teamworkRespond').style.display = 'block';
        statusEl.className = 'teamwork-status active';
        statusText.textContent = 'New question for you!';

        await loadTeamworkRespondPreview(availableConv);
      } else {
        document.getElementById('teamworkEmpty').style.display = 'block';
        statusEl.className = 'teamwork-status';
        statusText.textContent = 'Start a conversation!';
      }
    } else if (activeConversation.status === 'waiting' && userRole === 'studentA') {
      document.getElementById('teamworkWaiting').style.display = 'block';
      statusEl.className = 'teamwork-status waiting';
      statusText.textContent = 'Waiting for response...';
      await loadTeamworkWaitingPreview(activeConversation);
    } else if (needsToRespond || activeConversation.status === 'pending_reply') {
      document.getElementById('teamworkThread').style.display = 'block';
      statusEl.className = 'teamwork-status active';
      statusText.textContent = 'Your turn to respond!';
      await loadTeamworkThread(activeConversation, userRole);
    } else if (activeConversation.status === 'completed') {
      document.getElementById('teamworkCompleted').style.display = 'block';
      statusEl.className = 'teamwork-status';
      statusText.textContent = 'Completed!';
    }

  } catch (error) {
    statusText.textContent = 'Ready to start!';
    document.getElementById('teamworkEmpty').style.display = 'block';
  }
}

async function createTeamworkNotification(recipientId, type, conversationId, senderName) {
  if (!recipientId || recipientId === currentUser.uid) return;

  try {
    const notificationData = {
      recipientId: recipientId,
      type: 'teamwork',
      subtype: type, // 'response', 'reply', 'complete'
      conversationId: conversationId,
      senderName: senderName,
      senderId: currentUser.uid,
      read: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (type === 'response') {
      notificationData.message = `${senderName} answered your question!`;
    } else if (type === 'reply') {
      notificationData.message = `${senderName} replied to your conversation!`;
    } else if (type === 'complete') {
      notificationData.message = `Teamwork conversation completed! `;
    }

    await db.collection('notifications').add(notificationData);

  } catch (e) {
  }
}

async function loadTeamworkWaitingPreview(conversation) {
  const card = document.getElementById('teamworkMyQuestionCard');
  if (!card) return;

  const entry = conversation.entries?.[0];
  if (!entry) {
    card.innerHTML = '<div style="padding: 20px; color: white; text-align: center;">Your question has been sent!</div>';
    return;
  }

  let userName = 'You';
  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (userDoc.exists) {
      userName = userDoc.data().displayName || 'You';
    }
  } catch(e) {}

  let translation = entry.translation || '';
  if (!translation && entry.transcription) {
    translation = await getTeamworkTranslation(entry.transcription);
  }

  card.innerHTML = `
    <div class="teamwork-card-header">
      <div class="teamwork-card-avatar">${userName.charAt(0).toUpperCase()}</div>
      <div>
        <div class="teamwork-card-name">${userName}</div>
        <div class="teamwork-card-label"> Your Question</div>
      </div>
    </div>
    <div class="teamwork-card-video">
      <video src="${entry.mediaUrl}" controls playsinline></video>
    </div>
    <div class="teamwork-card-transcript">
      <div class="teamwork-card-transcript-toggle" onclick="toggleTeamworkCardTranscript(this)">
         Show Korean Transcription 
      </div>
      <div class="teamwork-card-korean">
        ${entry.transcription || '(No transcription)'}
        ${translation ? `
          <div class="hover-translation">
            <div class="translation-label"> English Translation</div>
            ${translation}
          </div>
        ` : `
          <div class="hover-translation">
            <div class="translation-label"> English Translation</div>
            <em>Hover to see translation</em>
          </div>
        `}
      </div>
    </div>
  `;
}

async function loadTeamworkRespondPreview(conversation) {
  const card = document.getElementById('teamworkQuestionCard');
  if (!card) return;

  const entry = conversation.entries?.[0];
  if (!entry) {
    card.innerHTML = '<div style="padding: 20px; color: white; text-align: center;">Loading question...</div>';
    return;
  }

  let studentAName = 'Classmate';
  try {
    const userDoc = await db.collection('users').doc(conversation.studentAId).get();
    if (userDoc.exists) {
      studentAName = userDoc.data().displayName || 'Classmate';
    }
  } catch(e) {}

  let translation = entry.translation || '';
  if (!translation && entry.transcription) {
    translation = await getTeamworkTranslation(entry.transcription);
  }

  card.innerHTML = `
    <div class="teamwork-card-header">
      <div class="teamwork-card-avatar">${studentAName.charAt(0).toUpperCase()}</div>
      <div>
        <div class="teamwork-card-name">${studentAName}</div>
        <div class="teamwork-card-label"> Asked you a question</div>
      </div>
    </div>
    <div class="teamwork-card-video">
      <video src="${entry.mediaUrl}" controls playsinline></video>
    </div>
    <div class="teamwork-card-transcript">
      <div class="teamwork-card-transcript-toggle" onclick="toggleTeamworkCardTranscript(this)">
         Show Korean Transcription 
      </div>
      <div class="teamwork-card-korean">
        ${entry.transcription || '(No transcription)'}
        <div class="hover-translation">
          <div class="translation-label"> English Translation</div>
          ${translation || 'Translation loading...'}
        </div>
      </div>
    </div>
  `;
}

async function getTeamworkTranslation(koreanText) {
  if (!koreanText || koreanText.trim() === '') return '';

  try {
    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean to English translator. Translate the given Korean text to natural English. Only respond with the translation, nothing else.' },
      { role: 'user', content: `Translate to English: "${koreanText}"` }
    ], 0.3);

    return response.choices?.[0]?.message?.content || response || '';
  } catch (e) {
    return '';
  }
}

function toggleTeamworkCardTranscript(toggleEl) {
  const korean = toggleEl.nextElementSibling;

  if (korean) {
    korean.classList.toggle('show');

    const isShowing = korean.classList.contains('show');
    toggleEl.innerHTML = isShowing
      ? ' Hide Korean Transcription '
      : ' Show Korean Transcription ';
  }
}

async function loadTeamworkThread(conversation, userRole) {
  const container = document.querySelector('.teamwork-thread-container');
  if (!container) return;

  const entries = conversation.entries || [];
  let html = '';

  const totalSteps = 3;
  const currentStep = entries.length;
  html += `
    <div class="teamwork-progress">
      <div class="progress-label">Conversation Progress</div>
      <div class="progress-steps">
        ${[1,2,3].map(step => `
          <div class="progress-step ${step <= currentStep ? 'completed' : ''} ${step === currentStep + 1 ? 'current' : ''}">
            <div class="step-circle">${step <= currentStep ? '' : step}</div>
            <div class="step-label">${step === 1 ? 'Question' : step === 2 ? 'Response' : 'Reply'}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  const userNames = {};
  try {
    if (conversation.studentAId) {
      const docA = await db.collection('users').doc(conversation.studentAId).get();
      userNames[conversation.studentAId] = docA.exists ? docA.data().displayName : 'Student A';
    }
    if (conversation.studentBId) {
      const docB = await db.collection('users').doc(conversation.studentBId).get();
      userNames[conversation.studentBId] = docB.exists ? docB.data().displayName : 'Student B';
    }
  } catch(e) {}

  for (let i = 0; i < entries.length; i++) {
    if (!entries[i].translation && entries[i].transcription) {
      entries[i].translation = await getTeamworkTranslation(entries[i].transcription);
    }
  }

  entries.forEach((entry, index) => {
    const isStudentA = entry.authorId === conversation.studentAId;
    const authorName = userNames[entry.authorId] || (isStudentA ? 'Student A' : 'Student B');
    const isVideo = entry.mediaType === 'video';
    const entryClass = isStudentA ? 'student-a' : 'student-b';
    const badgeClass = isVideo ? 'video' : 'audio';
    const badgeText = isVideo ? ' Video' : ' Audio';
    const entryLabel = index === 0 ? 'Question' : (index === 1 ? 'Response' : 'Reply');
    const isMe = entry.authorId === currentUser.uid;
    const translation = entry.translation || '';

    html += `
      <div class="teamwork-entry ${entryClass}">
        <div class="teamwork-entry-header">
          <div class="teamwork-entry-user">
            <div class="teamwork-entry-avatar" style="background: ${isStudentA ? 'linear-gradient(135deg, #48bb78, #38a169)' : 'linear-gradient(135deg, #667eea, #764ba2)'};">${authorName.charAt(0).toUpperCase()}</div>
            <div>
              <div class="teamwork-entry-name">${authorName} ${isMe ? '(You)' : ''}</div>
              <div style="font-size: 11px; color: #718096;">${entryLabel}</div>
            </div>
          </div>
          <span class="teamwork-entry-badge ${badgeClass}">${badgeText}</span>
        </div>
        <div class="teamwork-entry-body">
          <div class="teamwork-media-section">
            ${isVideo ? `
              <div class="teamwork-video-container">
                <video src="${entry.mediaUrl}" controls style="width: 100%; height: 100%; object-fit: cover;"></video>
              </div>
            ` : `
              <div class="teamwork-audio-container">
                <audio src="${entry.mediaUrl}" controls style="width: 100%;"></audio>
              </div>
            `}
          </div>
          <div class="teamwork-transcription-section">
            <button onclick="toggleTeamworkTranscript(this)" class="teamwork-transcript-toggle">
               Show Korean
            </button>
            <div class="teamwork-transcript-content">
              <div class="teamwork-korean-text teamwork-hoverable" data-translation="${encodeURIComponent(translation)}">
                ${entry.transcription || 'No transcription'}
                <div class="teamwork-hover-tooltip">
                  <div class="tooltip-label"> English</div>
                  <div class="tooltip-text">${translation || 'Translation not available'}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  const needsResponse = checkIfNeedsResponse(conversation, userRole);

  if (needsResponse && entries.length < 3) {
    const isStudentB = needsResponse === 'studentB';
    html += `
      <div class="teamwork-response-prompt">
        <p> ${isStudentB ? 'Answer their question and ask one back!' : 'Send your final reply to complete the conversation!'}</p>
        <button onclick="openTeamworkRecorder('${isStudentB ? 'respond' : 'reply'}')" class="btn teamwork-respond-btn">
           Record ${isStudentB ? 'Response' : 'Reply'}
        </button>
      </div>
    `;
  } else if (entries.length >= 3 || conversation.status === 'completed') {
    html += `
      <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #c6f6d5, #9ae6b4); border-radius: 12px; margin-top: 15px;">
        <div style="font-size: 48px; margin-bottom: 10px;"></div>
        <div style="color: #22543d; font-weight: 700; font-size: 18px;">Conversation Complete!</div>
        <div style="color: #276749; font-size: 14px; margin-top: 5px;">Great teamwork practice! +15 coins each</div>
        <button onclick="document.getElementById('teamworkCompleted').style.display='block'; document.getElementById('teamworkThread').style.display='none';" class="btn" style="margin-top: 15px; background: linear-gradient(135deg, #48bb78, #38a169);">
           Done
        </button>
      </div>
    `;
  }

  container.innerHTML = html;
}

function checkIfNeedsResponse(conversation, userRole) {
  const entries = conversation.entries || [];

  if (entries.length === 0) return null;
  if (entries.length === 1 && conversation.status === 'waiting') return 'studentB';
  if (entries.length === 2 && userRole === 'studentA' && conversation.status === 'pending_reply') return 'studentA';

  return null;
}

function toggleTeamworkTranscript(btn) {
  const content = btn.nextElementSibling;
  if (content) {
    content.classList.toggle('expanded');
    btn.textContent = content.classList.contains('expanded') ? ' Hide Korean' : ' Show Korean';
  }
}

async function openTeamworkRecorder(mode) {
  teamworkState.recordingMode = mode;
  teamworkState.recordingType = mode === 'start' ? 'video' : 'audio';
  teamworkState.mediaBlob = null;
  teamworkState.transcription = '';
  teamworkState.aiCorrection = null;

  const modal = document.getElementById('teamworkRecorderModal');
  const title = document.getElementById('teamworkRecorderTitle');
  const instructions = document.getElementById('teamworkModalInstructions');
  const videoPreview = document.getElementById('teamworkVideoPreview');
  const audioVisualizer = document.getElementById('teamworkAudioVisualizer');

  if (mode === 'start') {
    title.textContent = ' Record Video Question';
    instructions.innerHTML = `
      <p><strong>Ask a question in Korean!</strong></p>
      <p style="font-size: 13px; margin-top: 8px; color: #a0aec0;">Example:   ? (What did you do today?)</p>
    `;
  } else if (mode === 'respond') {
    title.textContent = ' Record Your Response';
    instructions.innerHTML = `
      <p><strong>Answer their question in Korean, then ask them a question back!</strong></p>
      <p style="font-size: 13px; margin-top: 8px; color: #a0aec0;">Make sure to include your own question at the end.</p>
    `;
  } else {
    title.textContent = ' Record Final Reply';
    instructions.innerHTML = `
      <p><strong>Answer their question to complete the conversation!</strong></p>
      <p style="font-size: 13px; margin-top: 8px; color: #a0aec0;">This is the final message in your conversation. </p>
    `;
  }

  document.getElementById('teamworkTranscriptionSection').style.display = 'none';
  document.getElementById('teamworkRecordBtn').classList.remove('recording');
  document.getElementById('teamworkRecordText').textContent = 'Start Recording';
  document.getElementById('teamworkRecordingTimer').classList.remove('active');
  document.getElementById('teamworkRecordingTimer').style.display = 'none';
  document.getElementById('teamworkSubmitBtn').disabled = true;

  if (teamworkState.recordingType === 'video') {
    videoPreview.style.display = 'block';
    audioVisualizer.style.display = 'none';
    await startVideoPreview();
  } else {
    videoPreview.style.display = 'none';
    audioVisualizer.style.display = 'flex';
  }

  modal.style.display = 'flex';
}

function closeTeamworkRecorder() {
  stopTeamworkRecording();
  stopVideoPreview();
  document.getElementById('teamworkRecorderModal').style.display = 'none';
}

async function startVideoPreview() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' },
      audio: true
    });
    teamworkState.mediaStream = stream;
    const video = document.getElementById('teamworkVideoPreview');
    video.srcObject = stream;
  } catch (e) {
    showToast(' Could not access camera. Please allow camera permissions.');
  }
}

function stopVideoPreview() {
  if (teamworkState.mediaStream) {
    teamworkState.mediaStream.getTracks().forEach(track => track.stop());
    teamworkState.mediaStream = null;
  }
  const video = document.getElementById('teamworkVideoPreview');
  if (video) video.srcObject = null;
}

async function toggleTeamworkRecording() {
  if (teamworkState.isRecording) {
    stopTeamworkRecording();
  } else {
    await startTeamworkRecording();
  }
}

async function startTeamworkRecording() {
  try {
    let stream;

    if (teamworkState.recordingType === 'video') {
      stream = teamworkState.mediaStream;
      if (!stream) {
        await startVideoPreview();
        stream = teamworkState.mediaStream;
      }
    } else {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      teamworkState.mediaStream = stream;
    }

    if (!stream) {
      showToast(' Could not access microphone');
      return;
    }

    teamworkState.recordedChunks = [];
    teamworkState.mediaRecorder = new MediaRecorder(stream);

    teamworkState.mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        teamworkState.recordedChunks.push(e.data);
      }
    };

    teamworkState.mediaRecorder.onstop = () => {
      const mimeType = teamworkState.recordingType === 'video' ? 'video/webm' : 'audio/webm';
      teamworkState.mediaBlob = new Blob(teamworkState.recordedChunks, { type: mimeType });
      processTeamworkRecording();
    };

    teamworkState.mediaRecorder.start();
    teamworkState.isRecording = true;

    document.getElementById('teamworkRecordBtn').classList.add('recording');
    document.getElementById('teamworkRecordText').textContent = ' Stop Recording';
    document.getElementById('teamworkRecordingTimer').classList.add('active');
    document.getElementById('teamworkRecordingTimer').style.display = 'block';

    teamworkState.recordingSeconds = 0;
    teamworkState.recordingTimer = setInterval(() => {
      teamworkState.recordingSeconds++;
      const mins = Math.floor(teamworkState.recordingSeconds / 60);
      const secs = teamworkState.recordingSeconds % 60;
      document.getElementById('teamworkRecordingTimer').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
    }, 1000);

    startTeamworkTranscription();

  } catch (e) {
    showToast(' Could not start recording');
  }
}

function stopTeamworkRecording() {
  if (teamworkState.mediaRecorder && teamworkState.isRecording) {
    teamworkState.mediaRecorder.stop();
    teamworkState.isRecording = false;

    if (teamworkState.recordingTimer) {
      clearInterval(teamworkState.recordingTimer);
      teamworkState.recordingTimer = null;
    }

    document.getElementById('teamworkRecordBtn').classList.remove('recording');
    document.getElementById('teamworkRecordText').textContent = 'Start Recording';

    if (teamworkState.recordingType === 'audio' && teamworkState.mediaStream) {
      teamworkState.mediaStream.getTracks().forEach(track => track.stop());
      teamworkState.mediaStream = null;
    }
  }

  if (teamworkState.speechRecognition) {
    try {
      teamworkState.speechRecognition.stop();
    } catch(e) {}
  }
}

function startTeamworkTranscription() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  teamworkState.speechRecognition = new SpeechRecognition();
  teamworkState.speechRecognition.lang = 'ko-KR';
  teamworkState.speechRecognition.continuous = true;
  teamworkState.speechRecognition.interimResults = true;

  let finalTranscript = '';

  teamworkState.speechRecognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript + ' ';
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    teamworkState.transcription = (finalTranscript + interim).trim();
  };

  teamworkState.speechRecognition.onerror = (e) => {
  };

  teamworkState.speechRecognition.onend = () => {
    if (teamworkState.isRecording) {
      try {
        teamworkState.speechRecognition.start();
      } catch(e) {}
    }
  };

  try {
    teamworkState.speechRecognition.start();
  } catch(e) {
  }
}

async function processTeamworkRecording() {
  document.getElementById('teamworkTranscriptionSection').style.display = 'block';
  document.getElementById('teamworkTranscriptionText').textContent = teamworkState.transcription || '(   - No speech detected)';

  await getTeamworkAICorrection();
}

async function getTeamworkAICorrection() {
  const correctionEl = document.getElementById('teamworkCorrectionText');
  correctionEl.innerHTML = '<div class="correction-loading"> Analyzing your Korean...</div>';

  if (!teamworkState.transcription || teamworkState.transcription.trim() === '') {
    correctionEl.innerHTML = `
      <div style="color: #f6ad55;">
         No speech detected. You can still submit, or try re-recording and speaking more clearly.
      </div>
    `;
    document.getElementById('teamworkSubmitBtn').disabled = false;
    return;
  }

  try {
    const contextInfo = teamworkState.recordingMode === 'start'
      ? 'The student is asking a question to start a conversation.'
      : teamworkState.recordingMode === 'respond'
      ? 'The student is answering a question and should also ask a follow-up question back.'
      : 'The student is giving a final reply to complete the conversation.';

    const prompt = `You are a Korean language tutor helping a beginner/intermediate student. Analyze their Korean speech and provide helpful corrections.

Context: ${contextInfo}

Student's Korean transcription: "${teamworkState.transcription}"

Please provide your analysis in this EXACT format:

**GRAMMAR CHECK:**
[If there are grammar errors, list each one like this:]
- Original: [the incorrect part in Korean]
- Corrected: [the correct version in Korean]
- Explanation: [brief explanation in English of why this is wrong and how to fix it]

[If no grammar errors, write: "No grammar errors detected! !"]

**VOCABULARY CHECK:**
[If there are vocabulary issues or more natural alternatives, suggest them]

**POLITENESS LEVEL:**
[Comment on whether the politeness level (/) is appropriate]

**SUGGESTION:**
[Suggest ONE way to make the sentence more expressive by adding an adverb or intensifier like , , , , , etc. Show the enhanced sentence.]

${teamworkState.recordingMode === 'respond' ? `
**QUESTION CHECK:**
[Check if the student included a question for their partner. If not, remind them to ask a question back.]
` : ''}

Keep explanations concise and encouraging. Use Korean examples where helpful.`;

    const response = await callAIProxy([
      { role: 'system', content: 'You are a helpful Korean language tutor. Provide corrections in a clear, structured format. Be encouraging but thorough.' },
      { role: 'user', content: prompt }
    ], 0.7);

    const aiResponse = response.choices?.[0]?.message?.content || response;

    let formattedResponse = aiResponse
      .replace(/\*\*(.+?)\*\*/g, '<strong style="color: #667eea;">$1</strong>')
      .replace(/- Original: (.+)/g, '<div style="margin-left: 10px;"><span class="correction-original">$1</span></div>')
      .replace(/- Corrected: (.+)/g, '<div style="margin-left: 10px;"> <span class="correction-fixed">$1</span></div>')
      .replace(/- Explanation: (.+)/g, '<div style="margin-left: 10px; font-size: 13px; color: #a0aec0; margin-bottom: 10px;"> $1</div>')
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>');

    const isGood = aiResponse.includes('No grammar errors') || aiResponse.includes('') || aiResponse.includes('');

    correctionEl.innerHTML = `
      <div class="ai-correction-result" style="line-height: 1.6;">
        ${isGood ? '<div style="color: #48bb78; font-weight: 600; margin-bottom: 10px;"> !</div>' : ''}
        ${formattedResponse}
      </div>
    `;

    document.getElementById('teamworkSubmitBtn').disabled = false;
    teamworkState.aiCorrection = correctionEl.innerHTML;

  } catch (e) {

    correctionEl.innerHTML = `
      <div style="color: #f6ad55; margin-bottom: 10px;">
         Could not get AI analysis. Basic check:
      </div>
      <div style="color: #a0aec0;">
        ${teamworkState.transcription.includes('') || teamworkState.transcription.includes('')
          ? ' Polite form detected'
          : ' Consider adding polite endings (- or -)'}
      </div>
      ${teamworkState.recordingMode === 'respond' && !teamworkState.transcription.includes('?')
        ? '<div style="color: #667eea; margin-top: 10px;"> Remember to ask a question back to your partner!</div>'
        : ''}
      <div style="margin-top: 15px; color: #48bb78;">Your recording is ready to submit!</div>
    `;
    document.getElementById('teamworkSubmitBtn').disabled = false;
  }
}

function rerecordTeamwork() {
  teamworkState.mediaBlob = null;
  teamworkState.transcription = '';
  teamworkState.aiCorrection = null;
  teamworkState.recordedChunks = [];

  document.getElementById('teamworkTranscriptionSection').style.display = 'none';
  document.getElementById('teamworkSubmitBtn').disabled = true;
  document.getElementById('teamworkRecordingTimer').style.display = 'none';

  if (teamworkState.recordingType === 'video') {
    startVideoPreview();
  }
}

async function submitTeamworkEntry() {
  if (!teamworkState.mediaBlob) {
    showToast(' Please record first');
    return;
  }

  showToast(' Submitting...');
  document.getElementById('teamworkSubmitBtn').disabled = true;

  try {
    let currentUserName = 'Student';
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        currentUserName = userDoc.data().displayName || 'Student';
      }
    } catch(e) {}

    const timestamp = Date.now();
    const ext = 'webm';
    const path = `teamwork/${currentUser.uid}/${timestamp}.${ext}`;
    const ref = storage.ref(path);
    await ref.put(teamworkState.mediaBlob);
    const mediaUrl = await ref.getDownloadURL();

    const entry = {
      authorId: currentUser.uid,
      authorName: currentUserName,
      mediaUrl: mediaUrl,
      mediaType: teamworkState.recordingType,
      transcription: teamworkState.transcription || '',
      translation: '', // Would be populated by translation API
      createdAt: new Date()
    };

    if (teamworkState.recordingMode === 'start') {
      await db.collection('teamworkConversations').add({
        studentAId: currentUser.uid,
        studentAName: currentUserName,
        studentBId: null,
        studentBName: null,
        status: 'waiting',
        entries: [entry],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showToast(' Question sent! Waiting for a partner...');

    } else {
      const conv = teamworkState.currentConversation;
      if (!conv) {
        showToast(' Conversation not found');
        return;
      }

      const updates = {
        entries: firebase.firestore.FieldValue.arrayUnion(entry),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (teamworkState.recordingMode === 'respond') {
        updates.studentBId = currentUser.uid;
        updates.studentBName = currentUserName;
        updates.status = 'pending_reply';

        await createTeamworkNotification(conv.studentAId, 'response', conv.id, currentUserName);

      } else if (teamworkState.recordingMode === 'reply') {
        updates.status = 'completed';

        await createTeamworkNotification(conv.studentBId, 'complete', conv.id, currentUserName);
      }

      await db.collection('teamworkConversations').doc(conv.id).update(updates);

      showToast(' Response sent!');
    }

    awardCoins(15, 'Teamwork Activity');

    closeTeamworkRecorder();
    loadTeamworkActivity();

  } catch (e) {
    showToast(' Failed to submit. Please try again.');
    document.getElementById('teamworkSubmitBtn').disabled = false;
  }
}

async function checkTeamworkNotifications() {
  if (!currentUser) return 0;

  try {
    const notifSnap = await db.collection('notifications')
      .where('recipientId', '==', currentUser.uid)
      .where('type', '==', 'teamwork')
      .where('read', '==', false)
      .get();

    return notifSnap.size;
  } catch(e) {
    return 0;
  }
}

function initTeamworkActivity() {
  if (currentUser && currentUserRole === 'student') {
    loadTeamworkActivity();
  }
}


const kpopState = {
  videoBlob: null,
  audioBlob: null,
  videoStream: null,
  audioStream: null,
  mediaRecorder: null,
  recordedChunks: [],
  isRecording: false,
  recordingTimer: null,
  recordingSeconds: 0,
  transcription: '',
  currentPostId: null,
  speechRecognition: null
};

function hideKpopInstructions() {
  const banner = document.getElementById('kpopInstructionsBanner');
  if (banner) {
    banner.style.display = 'none';
    localStorage.setItem('hideKpopInstructions', 'true');
  }
}

function checkKpopInstructionsVisibility() {
  const hidden = localStorage.getItem('hideKpopInstructions');
  if (hidden === 'true') {
    const banner = document.getElementById('kpopInstructionsBanner');
    if (banner) banner.style.display = 'none';
  }
}

function initKpopActivity() {
  if (currentUser && currentUserRole === 'student') {
    checkKpopInstructionsVisibility();
    loadKpopFeed();
  }
}

async function loadKpopFeed() {
  const feed = document.getElementById('kpopFeed');
  const statusText = document.getElementById('kpopStatusText');
  const statusEl = document.getElementById('kpopStatus');

  if (!feed) return;

  try {
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const postsSnap = await db.collection('kpopPosts')
      .where('createdAt', '>=', sevenDaysAgo)
      .orderBy('createdAt', 'desc')
      .limit(20)
      .get();

    if (postsSnap.empty) {
      feed.innerHTML = `
        <div class="kpop-empty-state">
          <div class="empty-icon"></div>
          <h4>No posts yet!</h4>
          <p>Be the first to share your favorite Kpop/Kdrama clip!</p>
        </div>
      `;
      statusText.textContent = 'Share something!';
      return;
    }

    let html = '';

    for (const doc of postsSnap.docs) {
      const post = { id: doc.id, ...doc.data() };

      let translation = post.translation || '';
      if (!translation && post.transcription) {
        translation = await getKpopTranslation(post.transcription);
      }

      const reactions = post.reactions || {};
      const likeCount = reactions.like || 0;
      const heartCount = reactions.heart || 0;
      const fireCount = reactions.fire || 0;
      const commentCount = post.commentCount || 0;

      const userReactions = post.userReactions || {};
      const userLiked = userReactions[currentUser.uid]?.like || false;
      const userHearted = userReactions[currentUser.uid]?.heart || false;
      const userFired = userReactions[currentUser.uid]?.fire || false;

      const createdAt = post.createdAt?.toDate?.() || new Date();
      const timeAgo = getTimeAgo(createdAt);

      const categoryClass = post.category || 'other';
      const categoryLabel = {
        'kpop': ' Kpop',
        'kdrama': ' Kdrama',
        'variety': ' Variety',
        'movie': ' Movie',
        'other': ' Other'
      }[categoryClass] || ' Other';

      html += `
        <div class="kpop-post-card" data-post-id="${post.id}">
          <div class="kpop-post-header">
            <div class="kpop-post-user">
              <div class="kpop-post-avatar">${(post.authorName || 'U').charAt(0).toUpperCase()}</div>
              <div class="kpop-post-user-info">
                <div class="kpop-post-username">${post.authorName || 'Student'}</div>
                <div class="kpop-post-meta">${timeAgo}${post.source ? '  ' + post.source : ''}</div>
              </div>
            </div>
            <span class="kpop-post-category ${categoryClass}">${categoryLabel}</span>
          </div>

          <div class="kpop-post-video">
            <video src="${post.videoUrl}" controls playsinline></video>
          </div>

          ${post.audioUrl ? `
            <div class="kpop-post-audio">
              <div class="kpop-post-audio-label"> Student's Pronunciation:</div>
              <audio src="${post.audioUrl}" controls></audio>
            </div>
          ` : ''}

          ${post.transcription ? `
            <div class="kpop-post-transcription">
              <div class="kpop-post-korean" data-translation="${encodeURIComponent(translation)}">
                ${post.transcription}
                <div class="kpop-translation-tooltip">
                  <div class="kpop-translation-label"> English Translation</div>
                  ${translation || 'Hover to see translation'}
                </div>
              </div>
            </div>
          ` : ''}

          ${post.explanation ? `
            <div class="kpop-post-explanation">
              <div class="kpop-post-explanation-label"> Explanation:</div>
              <div class="kpop-post-explanation-text">${post.explanation}</div>
            </div>
          ` : ''}

          <div class="kpop-post-reactions">
            <div class="kpop-reaction-buttons">
              <button class="kpop-reaction-btn ${userLiked ? 'active' : ''}" onclick="toggleKpopReaction('${post.id}', 'like')">
                 <span class="kpop-reaction-count">${likeCount || ''}</span>
              </button>
              <button class="kpop-reaction-btn ${userHearted ? 'active' : ''}" onclick="toggleKpopReaction('${post.id}', 'heart')">
                 <span class="kpop-reaction-count">${heartCount || ''}</span>
              </button>
              <button class="kpop-reaction-btn ${userFired ? 'active' : ''}" onclick="toggleKpopReaction('${post.id}', 'fire')">
                 <span class="kpop-reaction-count">${fireCount || ''}</span>
              </button>
            </div>
            <button class="kpop-comment-btn" onclick="openKpopComments('${post.id}')">
               <span>${commentCount || ''}</span><span class="kpop-comment-btn-text"> Comments</span>
            </button>
          </div>
        </div>
      `;
    }

    feed.innerHTML = html;
    statusText.textContent = `${postsSnap.size} posts`;
    statusEl.classList.add('active');

  } catch (error) {
    feed.innerHTML = `
      <div class="kpop-empty-state">
        <div class="empty-icon"></div>
        <h4>Share your favorite clips!</h4>
        <p>Be the first to post a Kpop or Kdrama moment!</p>
      </div>
    `;
    statusText.textContent = 'Ready';
  }
}

async function getKpopTranslation(koreanText) {
  if (!koreanText || koreanText.trim() === '') return '';

  try {
    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean to English translator. Translate the given Korean text to natural English. Only respond with the translation, nothing else.' },
      { role: 'user', content: `Translate to English: "${koreanText}"` }
    ], 0.3);

    return response.choices?.[0]?.message?.content || response || '';
  } catch (e) {
    return '';
  }
}

function getTimeAgo(date) {
  if (!date) return '';

  const actualDate = date.toDate ? date.toDate() : (date instanceof Date ? date : new Date(date));
  const seconds = Math.floor((new Date() - actualDate) / 1000);

  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
  if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';

  return actualDate.toLocaleDateString();
}

async function openKpopRecorder() {
  kpopState.videoBlob = null;
  kpopState.audioBlob = null;
  kpopState.transcription = '';
  kpopState.recordedChunks = [];

  document.getElementById('kpopStep1').style.display = 'block';
  document.getElementById('kpopStep2').style.display = 'none';
  document.getElementById('kpopStep3').style.display = 'none';
  document.getElementById('kpopSubmitSection').style.display = 'none';
  document.getElementById('kpopStartRecordBtn').style.display = 'inline-flex';
  document.getElementById('kpopStopRecordBtn').style.display = 'none';
  document.getElementById('kpopRecordingIndicator').style.display = 'none';
  document.getElementById('kpopTranscriptionResult').style.display = 'none';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' },
      audio: true
    });
    kpopState.videoStream = stream;
    document.getElementById('kpopVideoPreview').srcObject = stream;
  } catch (e) {
    showToast(' Could not access camera. Please allow camera permissions.');
    return;
  }

  document.getElementById('kpopRecorderModal').style.display = 'flex';
}

function closeKpopRecorder() {
  if (kpopState.videoStream) {
    kpopState.videoStream.getTracks().forEach(track => track.stop());
    kpopState.videoStream = null;
  }
  if (kpopState.audioStream) {
    kpopState.audioStream.getTracks().forEach(track => track.stop());
    kpopState.audioStream = null;
  }

  if (kpopState.mediaRecorder && kpopState.isRecording) {
    kpopState.mediaRecorder.stop();
    kpopState.isRecording = false;
  }

  if (kpopState.recordingTimer) {
    clearInterval(kpopState.recordingTimer);
    kpopState.recordingTimer = null;
  }

  document.getElementById('kpopRecorderModal').style.display = 'none';
}

async function startKpopRecording() {
  if (!kpopState.videoStream) {
    showToast(' Camera not available');
    return;
  }

  kpopState.recordedChunks = [];
  kpopState.mediaRecorder = new MediaRecorder(kpopState.videoStream);

  kpopState.mediaRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) {
      kpopState.recordedChunks.push(e.data);
    }
  };

  kpopState.mediaRecorder.onstop = () => {
    kpopState.videoBlob = new Blob(kpopState.recordedChunks, { type: 'video/webm' });
    onKpopVideoRecorded();
  };

  kpopState.mediaRecorder.start();
  kpopState.isRecording = true;

  document.getElementById('kpopStartRecordBtn').style.display = 'none';
  document.getElementById('kpopStopRecordBtn').style.display = 'inline-flex';
  document.getElementById('kpopRecordingIndicator').style.display = 'flex';

  kpopState.recordingSeconds = 0;
  kpopState.recordingTimer = setInterval(() => {
    kpopState.recordingSeconds++;
    const mins = Math.floor(kpopState.recordingSeconds / 60);
    const secs = kpopState.recordingSeconds % 60;
    document.getElementById('kpopRecordingTime').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
  }, 1000);
}

function stopKpopRecording() {
  if (kpopState.mediaRecorder && kpopState.isRecording) {
    kpopState.mediaRecorder.stop();
    kpopState.isRecording = false;

    if (kpopState.recordingTimer) {
      clearInterval(kpopState.recordingTimer);
      kpopState.recordingTimer = null;
    }

    document.getElementById('kpopStopRecordBtn').style.display = 'none';
    document.getElementById('kpopRecordingIndicator').style.display = 'none';
  }
}

function onKpopVideoRecorded() {
  const videoUrl = URL.createObjectURL(kpopState.videoBlob);
  const videoPreview = document.getElementById('kpopVideoPreview');
  videoPreview.srcObject = null;
  videoPreview.src = videoUrl;
  videoPreview.controls = true;
  videoPreview.muted = false;

  if (kpopState.videoStream) {
    kpopState.videoStream.getTracks().forEach(track => track.stop());
    kpopState.videoStream = null;
  }

  document.getElementById('kpopStep2').style.display = 'block';

  document.getElementById('kpopStep3').style.display = 'block';

  document.getElementById('kpopSubmitSection').style.display = 'flex';

  showToast(' Video recorded! Add your pronunciation and explanation.');
}

async function startKpopAudioRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    kpopState.audioStream = stream;

    kpopState.recordedChunks = [];
    kpopState.mediaRecorder = new MediaRecorder(stream);

    kpopState.mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        kpopState.recordedChunks.push(e.data);
      }
    };

    kpopState.mediaRecorder.onstop = () => {
      kpopState.audioBlob = new Blob(kpopState.recordedChunks, { type: 'audio/webm' });
      onKpopAudioRecorded();
    };

    kpopState.mediaRecorder.start();
    kpopState.isRecording = true;

    document.getElementById('kpopStartAudioBtn').style.display = 'none';
    document.getElementById('kpopStopAudioBtn').style.display = 'inline-flex';

    kpopState.recordingSeconds = 0;
    kpopState.recordingTimer = setInterval(() => {
      kpopState.recordingSeconds++;
      const mins = Math.floor(kpopState.recordingSeconds / 60);
      const secs = kpopState.recordingSeconds % 60;
      document.getElementById('kpopAudioTimer').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
    }, 1000);

    startKpopTranscription();

  } catch (e) {
    showToast(' Could not access microphone');
  }
}

function stopKpopAudioRecording() {
  if (kpopState.mediaRecorder && kpopState.isRecording) {
    kpopState.mediaRecorder.stop();
    kpopState.isRecording = false;

    if (kpopState.recordingTimer) {
      clearInterval(kpopState.recordingTimer);
      kpopState.recordingTimer = null;
    }

    if (kpopState.audioStream) {
      kpopState.audioStream.getTracks().forEach(track => track.stop());
      kpopState.audioStream = null;
    }

    if (kpopState.speechRecognition) {
      try {
        kpopState.speechRecognition.stop();
      } catch(e) {}
    }

    document.getElementById('kpopStopAudioBtn').style.display = 'none';
    document.getElementById('kpopStartAudioBtn').style.display = 'inline-flex';
    document.getElementById('kpopStartAudioBtn').innerHTML = '<span></span> Re-record';
  }
}

function startKpopTranscription() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  kpopState.speechRecognition = new SpeechRecognition();
  kpopState.speechRecognition.lang = 'ko-KR';
  kpopState.speechRecognition.continuous = true;
  kpopState.speechRecognition.interimResults = true;

  let finalTranscript = '';

  kpopState.speechRecognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript + ' ';
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    kpopState.transcription = (finalTranscript + interim).trim();
  };

  kpopState.speechRecognition.onerror = (e) => {
  };

  kpopState.speechRecognition.onend = () => {
    if (kpopState.isRecording) {
      try {
        kpopState.speechRecognition.start();
      } catch(e) {}
    }
  };

  try {
    kpopState.speechRecognition.start();
  } catch(e) {
  }
}

function onKpopAudioRecorded() {
  document.getElementById('kpopTranscriptionResult').style.display = 'block';
  document.getElementById('kpopTranscriptionText').textContent = kpopState.transcription || '(No transcription detected)';

  document.getElementById('kpopStep3').style.display = 'block';

  document.getElementById('kpopSubmitSection').style.display = 'flex';

  showToast(' Great! Now explain what the phrase means.');
}

function rerecordKpop() {
  closeKpopRecorder();
  setTimeout(() => openKpopRecorder(), 300);
}

async function submitKpopPost() {
  if (!kpopState.videoBlob) {
    showToast(' Please record a video first');
    return;
  }

  const explanation = document.getElementById('kpopExplanationInput').value.trim();

  showToast(' Uploading your post...');
  document.getElementById('kpopSubmitBtn').disabled = true;

  try {
    let userName = 'Student';
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        userName = userDoc.data().displayName || 'Student';
      }
    } catch(e) {}

    const timestamp = Date.now();

    const videoPath = `kpop/${currentUser.uid}/${timestamp}_video.webm`;
    const videoRef = storage.ref(videoPath);
    await videoRef.put(kpopState.videoBlob);
    const videoUrl = await videoRef.getDownloadURL();

    let audioUrl = null;
    if (kpopState.audioBlob) {
      const audioPath = `kpop/${currentUser.uid}/${timestamp}_audio.webm`;
      const audioRef = storage.ref(audioPath);
      await audioRef.put(kpopState.audioBlob);
      audioUrl = await audioRef.getDownloadURL();
    }

    let translation = '';
    if (kpopState.transcription) {
      translation = await getKpopTranslation(kpopState.transcription);
    }

    const postData = {
      authorId: currentUser.uid,
      authorName: userName,
      videoUrl: videoUrl,
      audioUrl: audioUrl,
      transcription: kpopState.transcription || '',
      translation: translation,
      explanation: explanation,
      category: document.getElementById('kpopCategorySelect').value,
      source: document.getElementById('kpopSourceInput').value.trim(),
      reactions: { like: 0, heart: 0, fire: 0 },
      userReactions: {},
      commentCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('kpopPosts').add(postData);

    awardCoins(10, 'Kpop/Kdrama Post');

    showToast(' Post shared successfully!');
    closeKpopRecorder();
    loadKpopFeed();

  } catch (e) {
    showToast(' Failed to upload. Please try again.');
    document.getElementById('kpopSubmitBtn').disabled = false;
  }
}

async function toggleKpopReaction(postId, reactionType) {
  if (!currentUser) return;

  try {
    const postRef = db.collection('kpopPosts').doc(postId);
    const postDoc = await postRef.get();

    if (!postDoc.exists) return;

    const post = postDoc.data();
    const userReactions = post.userReactions || {};
    const currentUserReaction = userReactions[currentUser.uid] || {};

    const isActive = currentUserReaction[reactionType] || false;

    const updates = {};
    updates[`userReactions.${currentUser.uid}.${reactionType}`] = !isActive;
    updates[`reactions.${reactionType}`] = firebase.firestore.FieldValue.increment(isActive ? -1 : 1);

    await postRef.update(updates);

    loadKpopFeed();

  } catch (e) {
  }
}

async function openKpopComments(postId) {
  kpopState.currentPostId = postId;

  document.getElementById('kpopCommentModal').style.display = 'flex';
  document.getElementById('kpopCommentsList').innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">Loading comments...</div>';

  await loadKpopComments(postId);
}

function closeKpopCommentModal() {
  document.getElementById('kpopCommentModal').style.display = 'none';
  kpopState.currentPostId = null;
}

async function loadKpopComments(postId) {
  const list = document.getElementById('kpopCommentsList');

  if (!postId) {
    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No comments yet. Be the first!</div>';
    return;
  }

  try {
    // First verify the post exists
    const postDoc = await db.collection('kpopPosts').doc(postId).get();
    if (!postDoc.exists) {
      list.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No comments yet. Be the first!</div>';
      return;
    }

    // Try to get comments - use simple query without orderBy to avoid index requirement
    let commentsSnap;
    try {
      commentsSnap = await db.collection('kpopPosts').doc(postId)
        .collection('comments')
        .limit(50)
        .get();
    } catch (queryError) {
      console.error('Comments query error:', queryError);
      list.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No comments yet. Be the first!</div>';
      return;
    }

    if (commentsSnap.empty) {
      list.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No comments yet. Be the first!</div>';
      return;
    }

    let html = '';

    // Sort client-side by createdAt
    const sortedDocs = commentsSnap.docs.sort((a, b) => {
      const aTime = a.data().createdAt?.toDate?.() || new Date(0);
      const bTime = b.data().createdAt?.toDate?.() || new Date(0);
      return bTime - aTime;
    });

    sortedDocs.forEach(doc => {
      const comment = doc.data();
      const createdAt = comment.createdAt?.toDate?.() || new Date();
      const timeAgo = getTimeAgo(createdAt);

      html += `
        <div class="kpop-comment-item">
          <div class="kpop-comment-avatar">${(comment.authorName || 'U').charAt(0).toUpperCase()}</div>
          <div class="kpop-comment-content">
            <div class="kpop-comment-username">${comment.authorName || 'Student'}</div>
            <div class="kpop-comment-text">${comment.text}</div>
            <div class="kpop-comment-time">${timeAgo}</div>
          </div>
        </div>
      `;
    });

    list.innerHTML = html;

  } catch (e) {
    console.error('Error loading comments:', e);
    // Show friendly message instead of error
    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">No comments yet. Be the first!</div>';
  }
}

async function submitKpopComment() {
  const input = document.getElementById('kpopCommentInput');
  const text = input.value.trim();

  if (!text || !kpopState.currentPostId) return;

  try {
    let userName = 'Student';
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        userName = userDoc.data().displayName || 'Student';
      }
    } catch(e) {}

    await db.collection('kpopPosts').doc(kpopState.currentPostId)
      .collection('comments').add({
        authorId: currentUser.uid,
        authorName: userName,
        text: text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    await db.collection('kpopPosts').doc(kpopState.currentPostId).update({
      commentCount: firebase.firestore.FieldValue.increment(1)
    });

    input.value = '';

    await loadKpopComments(kpopState.currentPostId);

    loadKpopFeed();

  } catch (e) {
    showToast(' Failed to post comment');
  }
}


const grammarBlabberState = {
  currentDay: null,
  currentActivity: null,
  currentPromptIndex: 0,
  prompts: [],
  completedPrompts: [],
  audioBlob: null,
  audioStream: null,
  mediaRecorder: null,
  recordedChunks: [],
  isRecording: false,
  recordingTimer: null,
  recordingSeconds: 0,
  transcription: '',
  speechRecognition: null
};

const grammarActivities = {
  0: { // Sunday
    title: "Free Talk Sunday",
    subtitle: "  ",
    description: "It's free talk day! Practice speaking about anything you want in Korean. Tell us about your weekend!",
    type: "free_talk",
    prompts: [
      { text: "Tell us about your weekend plans", hint: "   ?" },
      { text: "Describe your favorite hobby", hint: " ?" },
      { text: "Talk about what you ate today", hint: "  ?" }
    ]
  },
  1: { // Monday
    title: "Conjugation Monday",
    subtitle: "  ",
    description: "Practice verb conjugations! Convert the given verb into the correct form.",
    type: "conjugation",
    prompts: [
      { text: "  Past tense ()", hint: "I went to school   ___" },
      { text: "  Present tense ()", hint: "I eat rice   ___" },
      { text: "  Future tense ( )", hint: "I will study   ___" }
    ]
  },
  2: { // Tuesday
    title: "Particle Tuesday",
    subtitle: " ",
    description: "Master Korean particles! Fill in the correct particle for each sentence.",
    type: "particles",
    prompts: [
      { text: "Use / (object marker)", hint: "I eat an apple  ___ " },
      { text: "Use / (subject marker)", hint: "The weather is good  ___ " },
      { text: "Use  (location/time)", hint: "I go to school  ___ " }
    ]
  },
  3: { // Wednesday
    title: "Sentence Building Wednesday",
    subtitle: " ",
    description: "Build complete sentences! Use the given words to form a natural Korean sentence.",
    type: "sentence_building",
    prompts: [
      { text: " /  / ", hint: "Yesterday / friend / meet" },
      { text: " /  / ", hint: "Tomorrow / movie / watch" },
      { text: " /  / ", hint: "Now / Korean / study" }
    ]
  },
  4: { // Thursday
    title: "Honorific Thursday",
    subtitle: " ",
    description: "Practice formal and polite speech! Convert casual sentences to honorific form.",
    type: "honorifics",
    prompts: [
      { text: " ?  ", hint: "Did you eat? (polite form)" },
      { text: " ?  ", hint: "Where are you going? (polite form)" },
      { text: " ?  ", hint: "What's your name? (polite form)" }
    ]
  },
  5: { // Friday
    title: "Expression Friday",
    subtitle: " ",
    description: "Learn useful expressions! Practice common Korean expressions and idioms.",
    type: "expressions",
    prompts: [
      { text: "Say 'Nice to meet you'", hint: " " },
      { text: "Say 'It's been a while'", hint: "" },
      { text: "Say 'I'm looking forward to it'", hint: "" }
    ]
  },
  6: { // Saturday
    title: "Story Saturday",
    subtitle: " ",
    description: "Create a mini story! Continue the story using proper grammar and vocabulary.",
    type: "storytelling",
    prompts: [
      { text: "Start:  ...", hint: "One day... (continue the story)" },
      { text: "Describe a character", hint: " ... (That person...)" },
      { text: "End the story", hint: "... (So...)" }
    ]
  }
};

function initGrammarBlabber() {
  if (currentUser && currentUserRole === 'student') {
    loadGrammarBlabber();
  }
}

async function loadGrammarBlabber() {
  const container = document.getElementById('grammarBlabberContainer');
  const activityArea = document.getElementById('grammarActivityArea');
  const dayIndicator = document.getElementById('grammarDayIndicator');
  const statusText = document.getElementById('grammarBlabberStatusText');
  const statusEl = document.getElementById('grammarBlabberStatus');

  if (!container) return;

  try {
    const today = new Date().getDay();
    grammarBlabberState.currentDay = today;
    grammarBlabberState.currentActivity = grammarActivities[today];

    const activity = grammarBlabberState.currentActivity;
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    document.getElementById('grammarDayBadge').textContent = dayNames[today];
    document.getElementById('grammarActivityType').textContent = activity.title;

    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    const completedSnap = await db.collection('grammarBlabberResponses')
      .where('userId', '==', currentUser.uid)
      .where('createdAt', '>=', todayStart)
      .get();

    grammarBlabberState.completedPrompts = completedSnap.docs.map(doc => doc.data().promptIndex);

    let promptsHtml = '';
    activity.prompts.forEach((prompt, index) => {
      const isCompleted = grammarBlabberState.completedPrompts.includes(index);
      promptsHtml += `
        <div class="grammar-prompt-item ${isCompleted ? 'completed' : ''}" data-index="${index}">
          <div class="prompt-text">${prompt.text}</div>
          ${isCompleted ?
            `<span class="prompt-status"></span>` :
            `<button class="grammar-start-btn" onclick="openGrammarRecorder(${index})"> Practice</button>`
          }
        </div>
      `;
    });

    container.innerHTML = `
      <div class="grammar-activity-card">
        <div class="grammar-activity-header">
          <div class="grammar-activity-title">${activity.title}</div>
          <div class="grammar-activity-subtitle">${activity.subtitle}</div>
        </div>
        <div class="grammar-activity-body">
          <div class="grammar-activity-description">${activity.description}</div>

          <div class="grammar-example-box">
            <div class="grammar-example-label">Today's Focus</div>
            <div class="grammar-example-korean">${activity.prompts[0].hint}</div>
          </div>

          <div class="grammar-prompts-list">
            ${promptsHtml}
          </div>
        </div>
      </div>
    `;

    await loadGrammarResponses();

    const completedCount = grammarBlabberState.completedPrompts.length;
    const totalPrompts = activity.prompts.length;

    if (completedCount === totalPrompts) {
      statusText.textContent = 'All done! ';
      statusEl.classList.add('completed');
    } else {
      statusText.textContent = `${completedCount}/${totalPrompts} completed`;
      statusEl.classList.add('active');
    }

  } catch (error) {
    container.innerHTML = `
      <div class="grammar-activity-card">
        <div class="grammar-activity-body" style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <h4>Grammar Practice</h4>
          <p style="color: #718096;">Practice your Korean grammar every day!</p>
        </div>
      </div>
    `;
    statusText.textContent = 'Ready';
  }
}

async function loadGrammarResponses() {
  const container = document.getElementById('grammarBlabberContainer');
  const card = container.querySelector('.grammar-activity-card');
  if (!card) return;

  try {
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    const responsesSnap = await db.collection('grammarBlabberResponses')
      .where('createdAt', '>=', todayStart)
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get();

    if (responsesSnap.empty) return;

    let responsesHtml = `
      <div class="grammar-responses-section">
        <div class="grammar-responses-title"> Recent Responses from Classmates</div>
    `;

    responsesSnap.docs.forEach(doc => {
      const response = doc.data();
      if (response.userId === currentUser.uid) return; // Skip own responses

      responsesHtml += `
        <div class="grammar-response-item">
          <div class="grammar-response-avatar">${(response.userName || 'S').charAt(0).toUpperCase()}</div>
          <div class="grammar-response-content">
            <div class="grammar-response-name">${response.userName || 'Student'}</div>
            <div class="grammar-response-text">${response.transcription || ''}</div>
            ${response.audioUrl ? `
              <div class="grammar-response-audio">
                <audio src="${response.audioUrl}" controls></audio>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    });

    responsesHtml += '</div>';

    card.querySelector('.grammar-activity-body').insertAdjacentHTML('beforeend', responsesHtml);

  } catch (e) {
  }
}

function openGrammarRecorder(promptIndex) {
  grammarBlabberState.currentPromptIndex = promptIndex;
  grammarBlabberState.audioBlob = null;
  grammarBlabberState.transcription = '';
  grammarBlabberState.recordedChunks = [];

  const activity = grammarBlabberState.currentActivity;
  const prompt = activity.prompts[promptIndex];

  document.getElementById('grammarRecorderTitle').textContent = activity.title;
  document.getElementById('grammarPromptText').textContent = prompt.text;
  document.getElementById('grammarPromptHint').textContent = ` Hint: ${prompt.hint}`;

  document.getElementById('grammarTranscriptionSection').style.display = 'none';
  document.getElementById('grammarStartRecordBtn').style.display = 'inline-flex';
  document.getElementById('grammarStopRecordBtn').style.display = 'none';
  document.getElementById('grammarRecordTimer').textContent = '0:00';
  document.getElementById('grammarAudioVisualizer').classList.remove('recording');
  document.getElementById('grammarSubmitBtn').disabled = true;

  document.getElementById('grammarRecorderModal').style.display = 'flex';
}

function closeGrammarRecorder() {
  if (grammarBlabberState.isRecording) {
    stopGrammarRecording();
  }

  if (grammarBlabberState.audioStream) {
    grammarBlabberState.audioStream.getTracks().forEach(track => track.stop());
    grammarBlabberState.audioStream = null;
  }

  document.getElementById('grammarRecorderModal').style.display = 'none';
}

async function startGrammarRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    grammarBlabberState.audioStream = stream;

    grammarBlabberState.recordedChunks = [];
    grammarBlabberState.mediaRecorder = new MediaRecorder(stream);

    grammarBlabberState.mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        grammarBlabberState.recordedChunks.push(e.data);
      }
    };

    grammarBlabberState.mediaRecorder.onstop = () => {
      grammarBlabberState.audioBlob = new Blob(grammarBlabberState.recordedChunks, { type: 'audio/webm' });
      onGrammarRecordingComplete();
    };

    grammarBlabberState.mediaRecorder.start();
    grammarBlabberState.isRecording = true;

    document.getElementById('grammarStartRecordBtn').style.display = 'none';
    document.getElementById('grammarStopRecordBtn').style.display = 'inline-flex';
    document.getElementById('grammarAudioVisualizer').classList.add('recording');

    grammarBlabberState.recordingSeconds = 0;
    grammarBlabberState.recordingTimer = setInterval(() => {
      grammarBlabberState.recordingSeconds++;
      const mins = Math.floor(grammarBlabberState.recordingSeconds / 60);
      const secs = grammarBlabberState.recordingSeconds % 60;
      document.getElementById('grammarRecordTimer').textContent = `${mins}:${String(secs).padStart(2, '0')}`;
    }, 1000);

    startGrammarTranscription();

  } catch (e) {
    showToast(' Could not access microphone');
  }
}

function stopGrammarRecording() {
  if (grammarBlabberState.mediaRecorder && grammarBlabberState.isRecording) {
    grammarBlabberState.mediaRecorder.stop();
    grammarBlabberState.isRecording = false;

    if (grammarBlabberState.recordingTimer) {
      clearInterval(grammarBlabberState.recordingTimer);
      grammarBlabberState.recordingTimer = null;
    }

    if (grammarBlabberState.audioStream) {
      grammarBlabberState.audioStream.getTracks().forEach(track => track.stop());
      grammarBlabberState.audioStream = null;
    }

    if (grammarBlabberState.speechRecognition) {
      try {
        grammarBlabberState.speechRecognition.stop();
      } catch(e) {}
    }

    document.getElementById('grammarStopRecordBtn').style.display = 'none';
    document.getElementById('grammarAudioVisualizer').classList.remove('recording');
  }
}

function startGrammarTranscription() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  grammarBlabberState.speechRecognition = new SpeechRecognition();
  grammarBlabberState.speechRecognition.lang = 'ko-KR';
  grammarBlabberState.speechRecognition.continuous = true;
  grammarBlabberState.speechRecognition.interimResults = true;

  let finalTranscript = '';

  grammarBlabberState.speechRecognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript + ' ';
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    grammarBlabberState.transcription = (finalTranscript + interim).trim();
  };

  grammarBlabberState.speechRecognition.onend = () => {
    if (grammarBlabberState.isRecording) {
      try {
        grammarBlabberState.speechRecognition.start();
      } catch(e) {}
    }
  };

  try {
    grammarBlabberState.speechRecognition.start();
  } catch(e) {}
}

async function onGrammarRecordingComplete() {
  document.getElementById('grammarTranscriptionSection').style.display = 'block';
  document.getElementById('grammarTranscriptionText').textContent = grammarBlabberState.transcription || '(  )';

  await getGrammarFeedback();
}

async function getGrammarFeedback() {
  const feedbackBox = document.getElementById('grammarFeedbackBox');
  feedbackBox.innerHTML = '<div class="grammar-feedback-loading"> Checking your grammar...</div>';

  const activity = grammarBlabberState.currentActivity;
  const prompt = activity.prompts[grammarBlabberState.currentPromptIndex];

  if (!grammarBlabberState.transcription) {
    feedbackBox.innerHTML = `
      <div class="grammar-feedback-error">
         No speech detected. Try recording again and speak clearly.
      </div>
    `;
    document.getElementById('grammarSubmitBtn').disabled = false;
    return;
  }

  try {
    const response = await callAIProxy([
      { role: 'system', content: `You are a Korean grammar tutor. Evaluate the student's Korean response for the given prompt. Be encouraging but provide corrections if needed. Keep feedback concise (2-3 sentences max).` },
      { role: 'user', content: `
Prompt: ${prompt.text}
Hint: ${prompt.hint}
Student's response: "${grammarBlabberState.transcription}"

Evaluate if the response correctly addresses the prompt. Check grammar, particles, and conjugation. Provide brief feedback.` }
    ], 0.7);

    const feedback = response.choices?.[0]?.message?.content || response || '';

    const isCorrect = feedback.toLowerCase().includes('correct') ||
                      feedback.toLowerCase().includes('good') ||
                      feedback.toLowerCase().includes('great') ||
                      feedback.includes('') ||
                      feedback.includes('');

    feedbackBox.innerHTML = `
      <div class="grammar-feedback-result">
        ${isCorrect ? '<div class="grammar-feedback-correct"> Good job!</div>' : ''}
        <div style="margin-top: 8px;">${feedback}</div>
      </div>
    `;

    document.getElementById('grammarSubmitBtn').disabled = false;

  } catch (e) {
    feedbackBox.innerHTML = `
      <div class="grammar-feedback-result">
        Your response has been recorded. Keep practicing! 
      </div>
    `;
    document.getElementById('grammarSubmitBtn').disabled = false;
  }
}

function rerecordGrammar() {
  grammarBlabberState.audioBlob = null;
  grammarBlabberState.transcription = '';
  grammarBlabberState.recordedChunks = [];

  document.getElementById('grammarTranscriptionSection').style.display = 'none';
  document.getElementById('grammarStartRecordBtn').style.display = 'inline-flex';
  document.getElementById('grammarRecordTimer').textContent = '0:00';
  document.getElementById('grammarSubmitBtn').disabled = true;
}

async function submitGrammarResponse() {
  if (!grammarBlabberState.audioBlob) {
    showToast(' Please record first');
    return;
  }

  showToast(' Submitting...');
  document.getElementById('grammarSubmitBtn').disabled = true;

  try {
    let userName = 'Student';
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        userName = userDoc.data().displayName || 'Student';
      }
    } catch(e) {}

    const timestamp = Date.now();
    const audioPath = `grammarBlabber/${currentUser.uid}/${timestamp}.webm`;
    const audioRef = storage.ref(audioPath);
    await audioRef.put(grammarBlabberState.audioBlob);
    const audioUrl = await audioRef.getDownloadURL();

    await db.collection('grammarBlabberResponses').add({
      userId: currentUser.uid,
      userName: userName,
      day: grammarBlabberState.currentDay,
      activityType: grammarBlabberState.currentActivity.type,
      promptIndex: grammarBlabberState.currentPromptIndex,
      promptText: grammarBlabberState.currentActivity.prompts[grammarBlabberState.currentPromptIndex].text,
      transcription: grammarBlabberState.transcription,
      audioUrl: audioUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    awardCoins(5, 'Grammar Blabber');

    showToast(' Great practice!');
    closeGrammarRecorder();
    loadGrammarBlabber();

  } catch (e) {
    showToast(' Failed to submit. Please try again.');
    document.getElementById('grammarSubmitBtn').disabled = false;
  }
}

async function openDailyGradingModal(submissionId) {
  document.getElementById('dailyGradingModal')?.classList.add('active');

  dailyActivityState.currentSubmissionId = submissionId;
  dailyActivityState.selectedSounds = [];
  dailyActivityState.gradedSounds = {};
  dailyActivityState.videoBlob = null;
  dailyActivityState.videoStream = null;
  dailyActivityState.videoTranscript = ''; // Reset video transcript
  dailyActivityState.currentActivity = null;
  dailyActivityState.currentSubmission = null;

  document.getElementById('videoPlaceholder').style.display = 'flex';
  document.getElementById('teacherVideoPreview').style.display = 'none';
  document.getElementById('teacherVideoPlayback').style.display = 'none';
  document.getElementById('startVideoBtn').style.display = 'inline-flex';
  document.getElementById('stopVideoBtn').style.display = 'none';
  document.getElementById('retakeVideoBtn').style.display = 'none';
  document.getElementById('videoRecordTimer').style.display = 'none';

  document.getElementById('teacherTranscriptBox').style.display = 'none';
  document.getElementById('teacherTranscriptBox').style.borderColor = '#e2e8f0';
  document.getElementById('teacherTranscriptText').innerHTML = '<em style="color: #a0aec0;">Listening...</em>';

  document.getElementById('aiAnalysisSection').style.display = 'none';
  document.getElementById('gradesReferencePanel').style.display = 'none';
  document.getElementById('gradesReferenceList').innerHTML = '';

  try {
    const submissionDoc = await db.collection('dailySubmissions').doc(submissionId).get();
    if (!submissionDoc.exists) {
      showToast(' Submission not found');
      closeDailyGradingModal();
      return;
    }
    const submission = submissionDoc.data();
    dailyActivityState.currentSubmission = submission;

    const activityDoc = await db.collection('dailyActivities').doc(submission.activityId).get();
    const activity = activityDoc.exists ? activityDoc.data() : {};
    dailyActivityState.currentActivity = activity;

    let studentName = 'Student';
    let studentId = submission.studentId;
    try {
      const userDoc = await db.collection('users').doc(submission.studentId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        studentName = userData.displayName || userData.email?.split('@')[0] || 'Student';
      }
    } catch(e) {}
    dailyActivityState.studentId = studentId;
    dailyActivityState.studentName = studentName;

    document.getElementById('gradingStudentInfo').textContent = studentName;
    document.getElementById('gradingStudentAudio').src = submission.audioUrl || '';

    const originalScript = (activity.script || 'Script not available')
      .replace(/\n/g, ' ')
      .replace(/\s*[AB]\s*[:]\s*/gi, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    document.getElementById('gradingOriginalText').textContent = originalScript;
    dailyActivityState.originalScript = originalScript;

    if (submission.transcript) {
      document.getElementById('gradingStudentText').textContent = submission.transcript;
      dailyActivityState.studentTranscript = submission.transcript;
      document.getElementById('aiAnalysisSection').style.display = 'block';
      generateAIAnalysis();
    } else {
      document.getElementById('gradingStudentText').innerHTML = `
        <div style="color: #718096; text-align: center;">
          <div style="margin-bottom: 10px;">No transcript available yet.</div>
          <button onclick="transcribeStudentAudio()" style="padding: 8px 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px;">
             Add Transcript Manually
          </button>
          <div style="font-size: 11px; color: #a0aec0; margin-top: 8px;">
            This is an older submission. New submissions include automatic transcripts.
          </div>
        </div>
      `;
    }

  } catch(e) {
    showToast(' Error loading submission data');
  }

  renderSoundSelectionGrids();
}

function closeDailyGradingModal() {
  if (dailyActivityState.videoStream) {
    dailyActivityState.videoStream.getTracks().forEach(t => t.stop());
    dailyActivityState.videoStream = null;
  }
  document.getElementById('dailyGradingModal')?.classList.remove('active');
}

function renderSoundSelectionGrids() {
  const consonantGrid = document.getElementById('consonantGrid');
  const vowelGrid = document.getElementById('vowelGrid');
  const assimilationGrid = document.getElementById('assimilationGrid');

  if (!consonantGrid || !vowelGrid || !assimilationGrid) return;

  let consonantHtml = '';
  DAILY_ACTIVITY_SOUNDS.consonants.forEach(s => {
    const key = `L1C-${s.char}`;
    const isGraded = dailyActivityState.gradedSounds[key] !== undefined;
    const isDisabled = Object.keys(dailyActivityState.gradedSounds).length >= 5 && !isGraded;

    consonantHtml += `<div class="sound-item ${isGraded ? 'graded' : ''} ${isDisabled ? 'disabled' : ''}"
      onclick="${isDisabled ? '' : `selectDailySound('L1C', '${s.char}', '${s.name}')`}"
      style="padding: 10px 14px; background: ${isGraded ? 'linear-gradient(135deg, #48bb78, #38a169)' : '#f1f5f9'};
             border: 2px solid ${isGraded ? '#38a169' : '#e2e8f0'}; border-radius: 10px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};
             text-align: center; opacity: ${isDisabled ? '0.4' : '1'}; color: ${isGraded ? 'white' : '#1a202c'}; transition: all 0.2s; min-width: 55px;">
      <div style="font-size: 20px; font-weight: bold;">${s.char}</div>
      <div style="font-size: 9px; opacity: 0.7;">${s.name}</div>
      ${isGraded ? `<div style="font-size: 11px; margin-top: 3px; font-weight: bold;">${dailyActivityState.gradedSounds[key]}/10</div>` : ''}
    </div>`;
  });
  consonantGrid.innerHTML = consonantHtml;

  let vowelHtml = '';
  DAILY_ACTIVITY_SOUNDS.vowels.forEach(s => {
    const key = `L1V-${s.char}`;
    const isGraded = dailyActivityState.gradedSounds[key] !== undefined;
    const isDisabled = Object.keys(dailyActivityState.gradedSounds).length >= 5 && !isGraded;

    vowelHtml += `<div class="sound-item ${isGraded ? 'graded' : ''} ${isDisabled ? 'disabled' : ''}"
      onclick="${isDisabled ? '' : `selectDailySound('L1V', '${s.char}', '${s.name}')`}"
      style="padding: 10px 14px; background: ${isGraded ? 'linear-gradient(135deg, #48bb78, #38a169)' : 'linear-gradient(135deg, #f3e8ff, #e9d8fd)'};
             border: 2px solid ${isGraded ? '#38a169' : '#d6bcfa'}; border-radius: 10px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};
             text-align: center; opacity: ${isDisabled ? '0.4' : '1'}; color: ${isGraded ? 'white' : '#553c9a'}; transition: all 0.2s; min-width: 55px;">
      <div style="font-size: 20px; font-weight: bold;">${s.char}</div>
      <div style="font-size: 9px; opacity: 0.7;">${s.name}</div>
      ${isGraded ? `<div style="font-size: 11px; margin-top: 3px; font-weight: bold;">${dailyActivityState.gradedSounds[key]}/10</div>` : ''}
    </div>`;
  });
  vowelGrid.innerHTML = vowelHtml;

  let assimilationHtml = '';
  CONSONANT_ASSIMILATION_RULES.forEach(rule => {
    const key = `L2-${rule.id}`;
    const isGraded = dailyActivityState.gradedSounds[key] !== undefined;
    const isDisabled = Object.keys(dailyActivityState.gradedSounds).length >= 5 && !isGraded;

    const shortRule = rule.rule.length > 20 ? rule.rule.substring(0, 18) + '...' : rule.rule;

    assimilationHtml += `<div class="sound-item ${isGraded ? 'graded' : ''} ${isDisabled ? 'disabled' : ''}"
      onclick="${isDisabled ? '' : `selectDailySound('L2', '${rule.id}', '${rule.description}')`}"
      title="${rule.rule} (${rule.example})"
      style="padding: 8px 12px; background: ${isGraded ? 'linear-gradient(135deg, #48bb78, #38a169)' : 'linear-gradient(135deg, #fef3c7, #fde68a)'};
             border: 2px solid ${isGraded ? '#38a169' : '#f6e05e'}; border-radius: 10px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};
             text-align: center; opacity: ${isDisabled ? '0.4' : '1'}; color: ${isGraded ? 'white' : '#744210'}; transition: all 0.2s; min-width: 80px;">
      <div style="font-size: 11px; font-weight: bold;">#${rule.id}</div>
      <div style="font-size: 9px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">${shortRule}</div>
      ${isGraded ? `<div style="font-size: 11px; margin-top: 2px; font-weight: bold;">${dailyActivityState.gradedSounds[key]}/10</div>` : ''}
    </div>`;
  });
  assimilationGrid.innerHTML = assimilationHtml;

  document.getElementById('soundsSelectedCount').textContent = `${Object.keys(dailyActivityState.gradedSounds).length}/5 graded`;
  document.getElementById('submitDailyGradeBtn').disabled = Object.keys(dailyActivityState.gradedSounds).length < 5;

  const summaryDiv = document.getElementById('gradedSoundsSummary');
  const listDiv = document.getElementById('gradedSoundsList');
  if (Object.keys(dailyActivityState.gradedSounds).length > 0) {
    summaryDiv.style.display = 'block';
    let summaryHtml = '';
    Object.entries(dailyActivityState.gradedSounds).forEach(([key, grade]) => {
      const [level, id] = key.split('-');
      let displayName = id;
      if (level === 'L2') {
        const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id == id);
        displayName = rule ? `Rule #${id}` : id;
      }
      summaryHtml += `<span style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 8px 15px; border-radius: 20px; font-weight: 600;">${displayName}: ${grade}/10</span>`;
    });
    listDiv.innerHTML = summaryHtml;
  } else {
    summaryDiv.style.display = 'none';
  }
}

function selectDailySound(level, id, name) {
  const key = `${level}-${id}`;
  if (dailyActivityState.gradedSounds[key] !== undefined) return;
  if (Object.keys(dailyActivityState.gradedSounds).length >= 5) return;

  dailyActivityState.currentSoundKey = key;
  dailyActivityState.currentSoundLevel = level;
  dailyActivityState.currentSoundId = id;

  let title = '';
  if (level === 'L1') {
    title = `Grade Consonant: ${id}`;
  } else {
    const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id == id);
    title = rule ? `Grade Rule #${id}: ${rule.rule}` : `Grade Rule #${id}`;
  }

  document.getElementById('soundGradeTitle').textContent = title;
  document.getElementById('soundGradePopup').style.display = 'block';
}

function assignSoundGrade(grade) {
  const key = dailyActivityState.currentSoundKey;
  dailyActivityState.gradedSounds[key] = grade;
  document.getElementById('soundGradePopup').style.display = 'none';
  renderSoundSelectionGrids();
  updateGradesReferencePanel();
}

function updateGradesReferencePanel() {
  const panel = document.getElementById('gradesReferencePanel');
  const list = document.getElementById('gradesReferenceList');

  if (!panel || !list) return;

  const grades = dailyActivityState.gradedSounds;
  const gradeCount = Object.keys(grades).length;

  if (gradeCount === 0) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = 'block';

  let html = '';
  for (const [key, grade] of Object.entries(grades)) {
    const parts = key.split('-');
    const level = parts[0];
    const id = parts.slice(1).join('-');

    let label = id;
    let color = '#667eea';

    if (level === 'L1C') {
      const sound = DAILY_ACTIVITY_SOUNDS.consonants.find(s => s.char === id);
      label = sound ? `${id} (${sound.name})` : id;
      color = '#667eea';
    } else if (level === 'L1V') {
      const sound = DAILY_ACTIVITY_SOUNDS.vowels.find(s => s.char === id);
      label = sound ? `${id} (${sound.name})` : id;
      color = '#9f7aea';
    } else if (level === 'L2') {
      const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id == id);
      label = rule ? `#${id}: ${rule.rule}` : `Rule #${id}`;
      color = '#ed8936';
    }

    let gradeColor = '#48bb78'; // green for good
    if (grade <= 4) gradeColor = '#f56565'; // red for low
    else if (grade <= 6) gradeColor = '#ed8936'; // orange for medium
    else if (grade <= 8) gradeColor = '#ecc94b'; // yellow for decent

    html += `
      <div style="background: white; border: 2px solid ${color}; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px;">
        <span style="font-weight: 600; color: ${color};">${label}</span>
        <span style="background: ${gradeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 12px;">${grade}/10</span>
      </div>
    `;
  }

  list.innerHTML = html;
}

let transcriptionInProgress = false;

async function transcribeStudentAudio() {
  const audioUrl = dailyActivityState.currentSubmission?.audioUrl;
  if (!audioUrl) {
    showToast(' No audio to transcribe');
    return;
  }

  document.getElementById('gradingStudentText').innerHTML = `
    <div style="color: #718096; text-align: center; padding: 10px;">
      <div style="margin-bottom: 15px;">
        <strong> Manual Transcription</strong>
      </div>
      <div style="font-size: 13px; margin-bottom: 15px; line-height: 1.6;">
        This is an older submission without automatic transcription.<br>
        Please listen to the audio above and type what you hear below:
      </div>
      <textarea id="manualTranscriptInput"
                placeholder="Type what the student said in Korean..."
                style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
        <button onclick="saveManualTranscript()" style="padding: 8px 20px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">
           Save Transcript
        </button>
        <button onclick="cancelManualTranscript()" style="padding: 8px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">
          Cancel
        </button>
      </div>
      <div style="font-size: 11px; color: #a0aec0; margin-top: 10px;">
         New submissions automatically include transcripts from live recording.
      </div>
    </div>
  `;
}

async function saveManualTranscript() {
  const input = document.getElementById('manualTranscriptInput');
  const transcript = input?.value?.trim();

  if (!transcript) {
    showToast(' Please type the transcript first');
    return;
  }

  try {
    await db.collection('dailySubmissions').doc(dailyActivityState.currentSubmissionId).update({
      transcript: transcript,
      transcribedAt: firebase.firestore.FieldValue.serverTimestamp(),
      transcribedBy: currentUser.uid
    });

    document.getElementById('gradingStudentText').textContent = transcript;
    dailyActivityState.studentTranscript = transcript;

    document.getElementById('aiAnalysisSection').style.display = 'block';
    generateAIAnalysis();

    showToast(' Transcript saved!');
  } catch(e) {
    showToast(' Failed to save transcript');
  }
}

function cancelManualTranscript() {
  document.getElementById('gradingStudentText').innerHTML = `
    <div style="color: #718096; text-align: center;">
      <div style="margin-bottom: 10px;">No transcript available.</div>
      <button onclick="transcribeStudentAudio()" style="padding: 8px 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px;">
         Add Transcript Manually
      </button>
    </div>
  `;
}

async function generateAIAnalysis() {
  const original = dailyActivityState.originalScript;
  const studentSaid = dailyActivityState.studentTranscript || document.getElementById('gradingStudentText').textContent;

  if (!original || !studentSaid || studentSaid.includes('not available') || studentSaid.includes('transcription requires') || studentSaid.includes('No transcript')) {
    showToast(' Need both transcripts for AI analysis');
    return;
  }

  document.getElementById('aiGoodPoints').innerHTML = '<div class="loading" style="margin: 10px auto;"></div>';
  document.getElementById('aiSuggestions').innerHTML = '';
  document.getElementById('aiAnalysisSection').style.display = 'block';

  try {
    const prompt = `You are a Korean pronunciation teacher. Compare what the student said vs the original script and provide feedback.

ORIGINAL SCRIPT (what they should have said):
"${original}"

STUDENT'S TRANSCRIPTION (what they actually said):
"${studentSaid}"

Analyze the differences between these two texts and provide:

1. TWO positive points about what the student did well (be encouraging, note any difficult sounds they got right)

2. FIVE specific pronunciation corrections based on the DIFFERENCES you see:
   - Point out specific words or sounds that were different
   - Focus on Korean consonants (,,,,,,,,,,,,, and double consonants)
   - Focus on Korean vowels (,,,,,,, and compound vowels)
   - Note any consonant assimilation rules they may have missed

Format your response EXACTLY like this:
GOOD:
- [positive point 1]
- [positive point 2]

SUGGESTIONS:
- [specific correction 1 with the word/sound]
- [specific correction 2 with the word/sound]
- [specific correction 3 with the word/sound]
- [specific correction 4 with the word/sound]
- [specific correction 5 with the word/sound]

Keep each point to 1-2 sentences. Be specific about which Korean sounds need work.`;

    const response = await callAIProxy([
      { role: 'system', content: 'You are a helpful Korean pronunciation coach. Compare the original script with what the student said and provide specific, actionable feedback.' },
      { role: 'user', content: prompt }
    ], 0.7);

    const content = typeof response === 'string' ? response : JSON.stringify(response);

    const goodMatch = content.match(/GOOD:([\s\S]*?)SUGGESTIONS:/i);
    const suggestMatch = content.match(/SUGGESTIONS:([\s\S]*?)$/i);

    const goodPoints = goodMatch ? goodMatch[1].trim() : 'Good effort on the practice!';
    const suggestions = suggestMatch ? suggestMatch[1].trim() : 'Keep practicing regularly.';

    document.getElementById('aiGoodPoints').innerHTML = `<strong> Strengths:</strong><br>${goodPoints.replace(/- /g, ' ').replace(/\n/g, '<br>')}`;
    document.getElementById('aiSuggestions').innerHTML = `<strong> Corrections:</strong><br>${suggestions.replace(/- /g, ' ').replace(/\n/g, '<br>')}`;

  } catch(e) {
    document.getElementById('aiGoodPoints').textContent = 'Could not generate AI analysis';
    document.getElementById('aiSuggestions').textContent = '';
  }
}

async function startVideoRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: true
    });
    dailyActivityState.videoStream = stream;

    const preview = document.getElementById('teacherVideoPreview');
    preview.srcObject = stream;
    preview.style.display = 'block';
    document.getElementById('videoPlaceholder').style.display = 'none';
    document.getElementById('teacherVideoPlayback').style.display = 'none';

    dailyActivityState.videoRecorder = new MediaRecorder(stream);
    dailyActivityState.videoChunks = [];

    dailyActivityState.videoRecorder.ondataavailable = e => {
      if (e.data.size > 0) dailyActivityState.videoChunks.push(e.data);
    };

    dailyActivityState.videoRecorder.onstop = () => {
      dailyActivityState.videoBlob = new Blob(dailyActivityState.videoChunks, { type: 'video/webm' });
      const playback = document.getElementById('teacherVideoPlayback');
      playback.src = URL.createObjectURL(dailyActivityState.videoBlob);
      playback.style.display = 'block';
      preview.style.display = 'none';
      stream.getTracks().forEach(t => t.stop());
      dailyActivityState.videoStream = null;
      document.getElementById('startVideoBtn').style.display = 'none';
      document.getElementById('stopVideoBtn').style.display = 'none';
      document.getElementById('retakeVideoBtn').style.display = 'inline-flex';
      document.getElementById('videoRecordTimer').style.display = 'none';

      const transcript = stopTeacherVideoTranscription();
      dailyActivityState.videoTranscript = transcript;
    };

    dailyActivityState.videoRecorder.start();
    document.getElementById('startVideoBtn').style.display = 'none';
    document.getElementById('stopVideoBtn').style.display = 'inline-flex';

    dailyActivityState.recordingStartTime = Date.now();
    document.getElementById('videoRecordTimer').style.display = 'block';
    dailyActivityState.timerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - dailyActivityState.recordingStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('videoRecordTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      if (elapsed >= 60) stopVideoRecording();
    }, 1000);

    startTeacherVideoTranscription();

  } catch(e) {
    showToast(' Could not access camera: ' + e.message);
  }
}

function stopVideoRecording() {
  if (dailyActivityState.videoRecorder && dailyActivityState.videoRecorder.state === 'recording') {
    dailyActivityState.videoRecorder.stop();
  }
  if (dailyActivityState.timerInterval) {
    clearInterval(dailyActivityState.timerInterval);
    dailyActivityState.timerInterval = null;
  }
}

let teacherVideoTranscription = {
  recognition: null,
  isTranscribing: false,
  finalText: '',
  interimText: ''
};

function startTeacherVideoTranscription() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const transcriptBox = document.getElementById('teacherTranscriptBox');
  const transcriptText = document.getElementById('teacherTranscriptText');
  if (transcriptBox) transcriptBox.style.display = 'block';
  if (transcriptText) transcriptText.innerHTML = '<em style="color: #a0aec0;">Listening (Korean)...</em>';

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  teacherVideoTranscription.recognition = new SpeechRecognition();
  teacherVideoTranscription.recognition.lang = 'ko-KR'; // Korean for feedback
  teacherVideoTranscription.recognition.continuous = true;
  teacherVideoTranscription.recognition.interimResults = true;
  teacherVideoTranscription.recognition.maxAlternatives = 1;

  teacherVideoTranscription.finalText = '';
  teacherVideoTranscription.interimText = '';
  teacherVideoTranscription.isTranscribing = true;

  teacherVideoTranscription.recognition.onresult = (event) => {
    let interim = '';
    let final = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        final += transcript + ' ';
      } else {
        interim += transcript;
      }
    }

    if (final) {
      teacherVideoTranscription.finalText += final;
    }
    teacherVideoTranscription.interimText = interim;

    const transcriptText = document.getElementById('teacherTranscriptText');
    if (transcriptText) {
      const fullText = teacherVideoTranscription.finalText + '<span style="color: #a0aec0;">' + interim + '</span>';
      transcriptText.innerHTML = fullText || '<em style="color: #a0aec0;">Listening (Korean)...</em>';
    }
  };

  teacherVideoTranscription.recognition.onerror = (event) => {
    if (event.error === 'no-speech' && teacherVideoTranscription.isTranscribing) {
      setTimeout(() => {
        if (teacherVideoTranscription.isTranscribing && teacherVideoTranscription.recognition) {
          try { teacherVideoTranscription.recognition.start(); } catch(e) {}
        }
      }, 100);
    }
  };

  teacherVideoTranscription.recognition.onend = () => {
    if (teacherVideoTranscription.isTranscribing) {
      try { teacherVideoTranscription.recognition.start(); } catch(e) {
      }
    }
  };

  try {
    teacherVideoTranscription.recognition.start();
    console.log('Teacher video transcription started (Korean)');
  } catch(e) {
  }
}

function stopTeacherVideoTranscription() {
  teacherVideoTranscription.isTranscribing = false;

  if (teacherVideoTranscription.recognition) {
    try { teacherVideoTranscription.recognition.stop(); } catch(e) {}
    teacherVideoTranscription.recognition = null;
  }

  const result = (teacherVideoTranscription.finalText + teacherVideoTranscription.interimText).trim();

  const transcriptText = document.getElementById('teacherTranscriptText');
  if (transcriptText) {
    if (result) {
      transcriptText.textContent = result;
      document.getElementById('teacherTranscriptBox').style.borderColor = '#48bb78';
    } else {
      transcriptText.innerHTML = '<em style="color: #a0aec0;">No speech detected.</em>';
    }
  }

  return result;
}

function retakeVideo() {
  dailyActivityState.videoBlob = null;
  dailyActivityState.videoTranscript = '';
  document.getElementById('teacherVideoPlayback').style.display = 'none';
  document.getElementById('videoPlaceholder').style.display = 'flex';
  document.getElementById('startVideoBtn').style.display = 'inline-flex';
  document.getElementById('retakeVideoBtn').style.display = 'none';
  document.getElementById('videoRecordTimer').textContent = '0:00';

  document.getElementById('teacherTranscriptBox').style.display = 'none';
  document.getElementById('teacherTranscriptBox').style.borderColor = '#e2e8f0';
  document.getElementById('teacherTranscriptText').innerHTML = '<em style="color: #a0aec0;">Listening...</em>';
}

async function submitDailyGrade() {
  if (Object.keys(dailyActivityState.gradedSounds).length < 5) {
    showToast(' Please grade exactly 5 sounds');
    return;
  }

  if (!dailyActivityState.videoBlob) {
    showToast(' Please record a feedback video before submitting');
    return;
  }

  const total = Object.values(dailyActivityState.gradedSounds).reduce((a,b) => a+b, 0);
  const studentId = dailyActivityState.studentId;
  const submissionId = dailyActivityState.currentSubmissionId;

  try {
    showToast(' Submitting grade and creating drills...');

    const submissionDoc = await db.collection('dailySubmissions').doc(submissionId).get();
    const submissionData = submissionDoc.data();
    const submittedAt = submissionData?.submittedAt?.toDate?.() || new Date();
    const submissionDateStr = submittedAt.toISOString().split('T')[0]; // YYYY-MM-DD

    let videoUrl = null;

    if (dailyActivityState.videoBlob) {
      const videoFileName = `daily-feedback/${submissionId}_${Date.now()}.webm`;
      const videoRef = storage.ref(videoFileName);
      await videoRef.put(dailyActivityState.videoBlob);
      videoUrl = await videoRef.getDownloadURL();
    }

    const updateData = {
      isGraded: true,
      grades: dailyActivityState.gradedSounds,
      totalScore: total,
      gradedAt: firebase.firestore.FieldValue.serverTimestamp(),
      gradedBy: currentUser.uid,
      notificationViewed: false // Notify student that grade is ready
    };

    if (videoUrl) {
      updateData.videoFeedbackUrl = videoUrl;

      if (dailyActivityState.videoTranscript) {
        updateData.feedbackTranscript = dailyActivityState.videoTranscript;
      }
    } else {
      console.log('Daily Grade - No video recorded (videoBlob was null)');
    }


    await db.collection('dailySubmissions').doc(submissionId).update(updateData);

    await createDailyActivityDrills(studentId, submissionId, dailyActivityState.gradedSounds, submissionDateStr);

    showToast(' Grade submitted & drills created!');
    closeDailyGradingModal();
    loadDailySubmissions();

  } catch(e) {
    showToast(' Failed to submit grade');
  }
}

async function regradeDailySubmission(submissionId) {
  if (!confirm('Are you sure you want to regrade this submission?\n\nThis will:\n Clear the previous grades\n Delete any drills created from the previous grading\n Allow you to grade again with new scores')) {
    return;
  }

  try {
    showToast(' Preparing for regrade...');

    const submissionDoc = await db.collection('dailySubmissions').doc(submissionId).get();
    if (!submissionDoc.exists) {
      showToast(' Submission not found');
      return;
    }

    const submission = submissionDoc.data();
    const studentId = submission.studentId;

    const drillsSnapshot = await db.collection('pronunciationLeitner')
      .where('studentId', '==', studentId)
      .where('submissionId', '==', submissionId)
      .get();

    const deletePromises = [];
    drillsSnapshot.forEach(doc => {
      deletePromises.push(db.collection('pronunciationLeitner').doc(doc.id).delete());
    });

    if (deletePromises.length > 0) {
      await Promise.all(deletePromises);
    }

    await db.collection('dailySubmissions').doc(submissionId).update({
      isGraded: false,
      grades: {},
      totalScore: 0,
      gradedAt: null,
      regradedAt: firebase.firestore.FieldValue.serverTimestamp(),
      previousGrades: submission.grades || {} // Store previous grades for reference
    });

    showToast(' Ready for regrading');

    loadDailySubmissions();

    setTimeout(() => {
      openDailyGradingModal(submissionId);
    }, 500);

  } catch(e) {
    showToast(' Failed to prepare regrade');
  }
}

async function createDailyActivityDrills(studentId, submissionId, grades, submissionDateStr) {
  const assignedDate = submissionDateStr || new Date().toISOString().split('T')[0];

  let level1Config = null;
  let level2Videos = null;
  let level2Drills = null;

  try {
    const level1Doc = await db.collection('adminSettings').doc('level1Config').get();
    if (level1Doc.exists) level1Config = level1Doc.data();

    const level2VideosDoc = await db.collection('adminSettings').doc('level2Videos').get();
    if (level2VideosDoc.exists) level2Videos = level2VideosDoc.data()?.videos || {};

    const level2DrillsDoc = await db.collection('adminSettings').doc('level2Drills').get();
    if (level2DrillsDoc.exists) level2Drills = level2DrillsDoc.data()?.drills || {};
  } catch(e) {
  }

  for (const [key, grade] of Object.entries(grades)) {
    if (grade >= 10) continue;

    const parts = key.split('-');
    const level = parts[0]; // L1C, L1V, or L2
    const id = parts.slice(1).join('-'); // Character or rule ID

    const requiredReps = DAILY_DRILL_REPS[grade] || 1;
    if (requiredReps === 0) continue;

    let drillWords = [];
    let topicLabel = '';
    let topicDescription = '';
    let videoUrl = '';
    let drillLevel = 1;

    if (level === 'L1C') {
      topicLabel = `Daily: ${id}`;
      topicDescription = 'Daily Activity - Consonant Drill';
      drillLevel = 1;

      if (level1Config?.consonants?.[id]) {
        const config = level1Config.consonants[id];
        videoUrl = config.video || '';

        if (config.drills && config.drills[grade]) {
          drillWords = config.drills[grade];
        }
      }

      if (!drillWords || drillWords.length === 0) {
        drillWords = getDefaultConsonantDrillWords(id);
      }

    } else if (level === 'L1V') {
      topicLabel = `Daily: ${id}`;
      topicDescription = 'Daily Activity - Vowel Drill';
      drillLevel = 1;

      if (level1Config?.vowels?.[id]) {
        const config = level1Config.vowels[id];
        videoUrl = config.video || '';

        if (config.drills && config.drills[grade]) {
          drillWords = config.drills[grade];
        }
      }

      if (!drillWords || drillWords.length === 0) {
        drillWords = getDefaultVowelDrillWords(id);
      }

    } else if (level === 'L2') {
      const ruleId = parseInt(id);
      const rule = CONSONANT_ASSIMILATION_RULES.find(r => r.id === ruleId);
      topicLabel = rule ? `Daily: ${rule.rule}` : `Daily: Rule #${id}`;
      topicDescription = rule ? rule.description : 'Daily Activity - Assimilation Drill';
      drillLevel = 2;

      if (level2Videos && level2Videos[ruleId]) {
        videoUrl = level2Videos[ruleId];
      }

      if (level2Drills && level2Drills[ruleId]) {
        const scoreKey = grade <= 3 ? 1 : grade <= 5 ? 2 : grade <= 7 ? 3 : 4;
        drillWords = level2Drills[ruleId][scoreKey] || [];
      }

      if (!drillWords || drillWords.length === 0) {
        drillWords = getDefaultAssimilationDrillWords(ruleId);
      }
    }

    if (!Array.isArray(drillWords)) drillWords = [];
    drillWords = drillWords.filter(w => w).slice(0, 20);

    if (drillWords.length === 0) {
      continue;
    }

    try {
      const existing = await db.collection('pronunciationLeitner')
        .where('studentId', '==', studentId)
        .where('topic', '==', `daily-${key}`)
        .where('submissionId', '==', submissionId)
        .get();

      const drillData = {
        grade: grade,
        requiredRepetitions: requiredReps,
        drillWords: drillWords,
        videoUrl: videoUrl, // Store video URL with drill
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (!existing.empty) {
        await db.collection('pronunciationLeitner').doc(existing.docs[0].id).update(drillData);
      } else {

        await db.collection('pronunciationLeitner').add({
          studentId: studentId,
          topic: `daily-${key}`,
          topicLabel: topicLabel,
          topicDescription: topicDescription,
          level: drillLevel,
          grade: grade,
          requiredRepetitions: requiredReps,
          completedRepetitionsToday: 0,
          drillWords: drillWords,
          videoUrl: videoUrl, // Store video URL with drill
          testTitle: 'Daily Pronunciation Activity',
          submissionId: submissionId,
          assignedDate: assignedDate, // Date of SUBMISSION (not grading date) - for proper date filtering
          currentDay: 1,
          totalDays: DAILY_DRILL_TOTAL_DAYS, // 1 day only
          completedToday: false,
          lastCompletedDate: null,
          isComplete: false,
          isDailyActivity: true, // Flag to identify daily activity drills
          correctCount: 0,
          totalReviews: 0,
          startedAt: firebase.firestore.FieldValue.serverTimestamp(),
          addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }


    } catch(e) {
    }
  }
}

function getDefaultConsonantDrillWords(consonant) {
  const defaults = {
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
  };
  return defaults[consonant] || ['  1', '  2', '  3', '  4', '  5', '  6', '  7', '  8', '  9', '  10', '  11', '  12', '  13', '  14', '  15', '  16', '  17', '  18', '  19', '  20'];
}

function getDefaultVowelDrillWords(vowel) {
  const defaults = {
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    '': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
  };
  return defaults[vowel] || ['  1', '  2', '  3', '  4', '  5', '  6', '  7', '  8', '  9', '  10', '  11', '  12', '  13', '  14', '  15', '  16', '  17', '  18', '  19', '  20'];
}

function getDefaultAssimilationDrillWords(ruleId) {
  const defaults = {
    1: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    2: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    3: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    4: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    5: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    6: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    7: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    8: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    9: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    10: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    11: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    12: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    13: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    14: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    15: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    16: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    17: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    18: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    19: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    20: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    21: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    22: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
  };
  return defaults[ruleId] || ['  1', '  2', '  3', '  4', '  5', '  6', '  7', '  8', '  9', '  10', '  11', '  12', '  13', '  14', '  15', '  16', '  17', '  18', '  19', '  20'];
}


let dailyCorrectionsSelectedDate = null; // Current selected date (YYYY-MM-DD)
let dailyCorrectionsAllSubmissions = []; // Cache all submissions

async function openDailyCorrectionsPage(dateStr = null) {
  closeProfilePanel();

  document.getElementById('dailyCorrectionsOverlay').style.display = 'block';
  document.body.style.overflow = 'hidden';

  dailyCorrectionsSelectedDate = dateStr || new Date().toISOString().split('T')[0];

  await loadAllDailyCorrectionsData();
  displayDailyCorrectionsForDate(dailyCorrectionsSelectedDate);
}

function navigateDailyCorrectionsDate(direction) {
  const currentDate = new Date(dailyCorrectionsSelectedDate + 'T12:00:00');
  currentDate.setDate(currentDate.getDate() + direction);
  dailyCorrectionsSelectedDate = currentDate.toISOString().split('T')[0];
  displayDailyCorrectionsForDate(dailyCorrectionsSelectedDate);
}

function goToTodayCorrections() {
  dailyCorrectionsSelectedDate = new Date().toISOString().split('T')[0];
  displayDailyCorrectionsForDate(dailyCorrectionsSelectedDate);
}

async function loadAllDailyCorrectionsData() {
  if (!currentUser) return;

  try {
    const snapshot = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .get();

    dailyCorrectionsAllSubmissions = [];
    snapshot.forEach(doc => {
      dailyCorrectionsAllSubmissions.push({ id: doc.id, ...doc.data() });
    });

  } catch (e) {
  }
}

function displayDailyCorrectionsForDate(dateStr) {
  const dateObj = new Date(dateStr + 'T12:00:00');
  document.getElementById('dailyDrillsDate').textContent = dateObj.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  loadVideoForDate(dateStr);

  loadDrillsForDate(dateStr);

  loadPastCorrections();
}

async function loadVideoForDate(dateStr) {
  const submission = dailyCorrectionsAllSubmissions.find(sub => {
    const submittedDate = sub.submittedAt?.toDate?.();
    if (!submittedDate) return false;
    return submittedDate.toISOString().split('T')[0] === dateStr;
  });

  const gradedSubmission = submission && submission.isGraded ? submission : null;

  if (!gradedSubmission) {
    if (submission) {
      document.getElementById('noVideoMessage').innerHTML = `
        <div style="color: #718096; text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;"></div>
          <div>Awaiting teacher feedback</div>
          <div style="font-size: 13px; margin-top: 5px;">Your submission is pending review</div>
        </div>
      `;
    } else {
      document.getElementById('noVideoMessage').innerHTML = `
        <div style="color: #718096; text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;"></div>
          <div>No activity for this date</div>
          <div style="font-size: 13px; margin-top: 5px;">No daily activity was submitted on this day</div>
        </div>
      `;
    }
    document.getElementById('noVideoMessage').style.display = 'block';
    document.getElementById('latestCorrectionVideo').style.display = 'none';
    document.getElementById('correctionGrades').style.display = 'none';
    document.getElementById('latestCorrectionDate').textContent = '';
    document.getElementById('teacherFeedbackColumn').style.display = 'none';
    document.getElementById('studentRecordingSection').style.display = 'none';

    if (submission && submission.audioUrl) {
      document.getElementById('studentRecordingSection').style.display = 'block';
      document.getElementById('studentRecordingAudio').src = submission.audioUrl;
      if (submission.transcript) {
        document.getElementById('studentRecordingTranscript').innerHTML = `
          <div style="font-size: 11px; color: #718096; margin-bottom: 5px;"> Your transcript:</div>
          <div style="color: #e2e8f0;">${submission.transcript}</div>
        `;
      } else {
        document.getElementById('studentRecordingTranscript').innerHTML = '';
      }
    }
    return;
  }

  window.currentFeedbackSubmission = gradedSubmission;


  const gradedDate = gradedSubmission.gradedAt?.toDate?.();
  document.getElementById('latestCorrectionDate').textContent = gradedDate
    ? `Graded ${gradedDate.toLocaleDateString()}`
    : '';

  if (gradedSubmission.videoFeedbackUrl) {
    document.getElementById('latestCorrectionVideo').src = gradedSubmission.videoFeedbackUrl;
    document.getElementById('latestCorrectionVideo').style.display = 'block';
    document.getElementById('noVideoMessage').style.display = 'none';

    if (gradedSubmission.feedbackTranscript) {
      document.getElementById('teacherFeedbackColumn').style.display = 'block';
      renderHoverableKoreanTranscript(gradedSubmission.feedbackTranscript);
      document.getElementById('feedbackTranslationContent').style.display = 'none';
      document.getElementById('feedbackTranscriptContent').style.display = 'block';
      document.getElementById('toggleTranslationBtn').textContent = ' English';
    } else {
      document.getElementById('teacherFeedbackColumn').style.display = 'none';
    }
  } else {
    document.getElementById('noVideoMessage').innerHTML = `
      <div style="color: #718096; text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 10px;"></div>
        <div>Graded!</div>
        <div style="font-size: 13px; margin-top: 5px;">No video feedback for this submission</div>
      </div>
    `;
    document.getElementById('noVideoMessage').style.display = 'block';
    document.getElementById('latestCorrectionVideo').style.display = 'none';
    document.getElementById('teacherFeedbackColumn').style.display = 'none';
  }

  if (gradedSubmission.audioUrl) {
    document.getElementById('studentRecordingSection').style.display = 'block';
    document.getElementById('studentRecordingAudio').src = gradedSubmission.audioUrl;
    if (gradedSubmission.transcript) {
      document.getElementById('studentRecordingTranscript').innerHTML = `
        <div style="font-size: 11px; color: #718096; margin-bottom: 5px;"> Your transcript:</div>
        <div style="color: #e2e8f0;">${gradedSubmission.transcript}</div>
      `;
    } else {
      document.getElementById('studentRecordingTranscript').innerHTML = '';
    }
  } else {
    document.getElementById('studentRecordingSection').style.display = 'none';
  }

  if (gradedSubmission.grades && Object.keys(gradedSubmission.grades).length > 0) {
    document.getElementById('correctionGrades').style.display = 'block';
    let gradesHtml = '';
    Object.entries(gradedSubmission.grades).forEach(([key, grade]) => {
      const parts = key.split('-');
      const level = parts[0];
      const id = parts.slice(1).join('-');
      let displayName = id;
      if (level === 'L2') {
        const rule = typeof CONSONANT_ASSIMILATION_RULES !== 'undefined' ? CONSONANT_ASSIMILATION_RULES.find(r => r.id == id) : null;
        displayName = rule ? `Rule #${id}` : id;
      }
      const color = grade >= 8 ? '#48bb78' : grade >= 5 ? '#ecc94b' : '#f56565';
      gradesHtml += `<span style="background: ${color}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 13px; font-weight: 500;">${displayName}: ${grade}/10</span>`;
    });
    document.getElementById('correctionGradesList').innerHTML = gradesHtml;
  } else {
    document.getElementById('correctionGrades').style.display = 'none';
  }
}

async function loadDrillsForDate(dateStr) {
  if (!currentUser) return;

  const container = document.getElementById('dailyDrillsContainer');

  try {
    const snapshot = await db.collection('pronunciationLeitner')
      .where('studentId', '==', currentUser.uid)
      .get();

    let drills = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.isDailyActivity) {
        const assignedDate = data.assignedDate;
        const addedDate = data.addedAt?.toDate?.()?.toISOString().split('T')[0];

        if (assignedDate === dateStr || (!assignedDate && addedDate === dateStr)) {
          drills.push({ id: doc.id, ...data });
        }
      }
    });

    if (drills.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #718096;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <div style="font-size: 16px; margin-bottom: 5px;">No drills for this date</div>
          <div style="font-size: 13px;">Drills are assigned when teacher grades your submission</div>
        </div>
      `;
      document.getElementById('drillsProgress').textContent = '0/0';
      return;
    }

    const completedCount = drills.filter(d => d.completedToday || d.isComplete).length;
    document.getElementById('drillsProgress').textContent = `${completedCount}/${drills.length} complete`;

    const drillsBySubmission = {};
    for (const drill of drills) {
      const subId = drill.submissionId || 'unknown';
      if (!drillsBySubmission[subId]) {
        drillsBySubmission[subId] = [];
      }
      drillsBySubmission[subId].push(drill);
    }

    let level1Config = null;
    let level2Videos = null;

    for (const drill of drills) {
      if (!drill.videoUrl && drill.topic) {
        const topicParts = drill.topic.replace('daily-', '').split('-');
        const level = topicParts[0] || '';
        const id = topicParts.slice(1).join('-');

        try {
          if (level === 'L1' || level === 'L1C' || level === 'L1V') {
            if (!level1Config) {
              const configDoc = await db.collection('adminSettings').doc('level1Config').get();
              if (configDoc.exists) level1Config = configDoc.data();
            }
            if (level1Config) {
              if ((level === 'L1' || level === 'L1C') && level1Config.consonants?.[id]?.video) {
                drill.videoUrl = level1Config.consonants[id].video;
              } else if (level === 'L1V' && level1Config.vowels?.[id]?.video) {
                drill.videoUrl = level1Config.vowels[id].video;
              }
            }
          } else if (level === 'L2') {
            if (!level2Videos) {
              const videosDoc = await db.collection('adminSettings').doc('level2Videos').get();
              if (videosDoc.exists) level2Videos = videosDoc.data().videos || {};
            }
            if (level2Videos && level2Videos[parseInt(id)]) {
              drill.videoUrl = level2Videos[parseInt(id)];
            }
          }
        } catch(e) {
        }
      }
    }

    let html = '';
    let submissionIndex = 0;

    for (const [submissionId, submissionDrills] of Object.entries(drillsBySubmission)) {
      submissionIndex++;

      submissionDrills.sort((a, b) => {
        const timeA = a.addedAt?.toDate?.() || new Date(0);
        const timeB = b.addedAt?.toDate?.() || new Date(0);
        return timeB - timeA;
      });

      const firstDrill = submissionDrills[0];
      const completedInSubmission = submissionDrills.filter(d => d.completedToday || d.isComplete).length;
      const totalInSubmission = submissionDrills.length;
      const allCompleted = completedInSubmission === totalInSubmission;

      html += `
        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
                    border: 2px solid ${allCompleted ? 'rgba(72, 187, 120, 0.3)' : 'rgba(102, 126, 234, 0.2)'};
                    border-radius: 16px; padding: 20px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div>
              <div style="font-size: 16px; font-weight: 700; color: ${allCompleted ? '#48bb78' : '#e2e8f0'};">
                ${allCompleted ? '' : ''} Pronunciation Drills
              </div>
              <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                ${completedInSubmission}/${totalInSubmission} completed
              </div>
            </div>
            <div style="background: ${allCompleted ? 'rgba(72, 187, 120, 0.2)' : 'rgba(102, 126, 234, 0.2)'};
                        padding: 8px 16px; border-radius: 20px;
                        color: ${allCompleted ? '#48bb78' : '#a78bfa'}; font-size: 13px; font-weight: 600;">
              ${allCompleted ? ' All Done!' : `${totalInSubmission - completedInSubmission} remaining`}
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
      `;

      for (const drill of submissionDrills) {
        const isCompleted = drill.completedToday || drill.isComplete;
        const wordCount = drill.drillWords?.length || 0;
        const hasVideo = drill.videoUrl ? true : false;

        html += `
          <div style="background: ${isCompleted ? 'rgba(72, 187, 120, 0.15)' : 'rgba(255, 255, 255, 0.05)'};
                      border: 1px solid ${isCompleted ? 'rgba(72, 187, 120, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
                      border-radius: 10px; padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="font-size: 15px; font-weight: 600; color: ${isCompleted ? '#48bb78' : '#e2e8f0'}; margin-bottom: 4px;">
                  ${isCompleted ? '' : ''} ${drill.topicLabel || 'Pronunciation Drill'}
                </div>
                <div style="font-size: 12px; color: #718096;">
                  ${wordCount} flashcards  Grade: ${drill.grade}/10
                </div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                ${!isCompleted ? `
                  <button onclick="startDailyDrill('${drill.id}')" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px;">
                     Start
                  </button>
                  ${hasVideo ? `<a href="${drill.videoUrl}" target="_blank" style="color: #ed8936; text-decoration: none; font-size: 10px;"> Watch tutorial</a>` : ''}
                ` : `
                  <div style="padding: 10px 16px; background: rgba(72, 187, 120, 0.2); border-radius: 20px; color: #48bb78; font-weight: 600; font-size: 13px;"> Done</div>
                `}
              </div>
            </div>
          </div>
        `;
      }

      html += '</div></div>';
    }

    container.innerHTML = html;

  } catch(e) {
    container.innerHTML = `<div style="color: #f56565; text-align: center; padding: 20px;">Error loading drills</div>`;
  }
}

function closeDailyCorrectionsPage() {
  document.getElementById('dailyCorrectionsOverlay').style.display = 'none';
  document.body.style.overflow = '';
}

function toggleStudentRecordingDropdown() {
  const dropdown = document.getElementById('studentRecordingDropdown');
  const arrow = document.getElementById('studentRecordingArrow');
  if (dropdown && arrow) {
    const isHidden = dropdown.style.display === 'none';
    dropdown.style.display = isHidden ? 'block' : 'none';
    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

async function loadLatestVideoCorrection() {
}

async function loadDailyActivityDrills() {
  // Reload drills for the currently selected date in daily corrections
  if (dailyCorrectionsSelectedDate) {
    await loadDrillsForDate(dailyCorrectionsSelectedDate);
  } else {
    // If no date selected, use today
    const today = new Date().toISOString().split('T')[0];
    await loadDrillsForDate(today);
  }
}

function renderHoverableKoreanTranscript(transcript) {
  const container = document.getElementById('feedbackTranscriptContent');
  if (!container) return;

  const words = transcript.split(/(\s+)/);

  let html = '';
  words.forEach((word, index) => {
    if (/^\s+$/.test(word)) {
      html += word;
    } else if (word.trim()) {
      const wordId = `feedback_word_${index}`;
      html += `<span
        id="${wordId}"
        class="hoverable-korean-word"
        style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.2s;"
        onmouseenter="showFeedbackWordTooltip('${wordId}', '${escapeForAttribute(word)}')"
        onmouseleave="scheduleFeedbackTooltipHide()"
      >${word}</span>`;
    }
  });

  container.innerHTML = html;
}

function escapeForAttribute(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

let feedbackWordTooltipTimeout = null;
let currentFeedbackWordData = null;
let isHoveringTooltip = false;

async function showFeedbackWordTooltip(wordId, korean) {
  const wordEl = document.getElementById(wordId);
  if (!wordEl) return;

  if (feedbackWordTooltipTimeout) {
    clearTimeout(feedbackWordTooltipTimeout);
    feedbackWordTooltipTimeout = null;
  }

  wordEl.style.background = 'rgba(159, 122, 234, 0.3)';

  const existingTooltip = document.getElementById('feedbackWordTooltip');
  if (existingTooltip) existingTooltip.remove();

  const tooltip = document.createElement('div');
  tooltip.id = 'feedbackWordTooltip';
  tooltip.innerHTML = `
    <div style="text-align: center; padding: 10px;">
      <div class="loading" style="width: 20px; height: 20px; margin: 0 auto;"></div>
      <div style="font-size: 11px; color: #a0aec0; margin-top: 5px;">Loading...</div>
    </div>
  `;
  tooltip.style.cssText = `
    position: absolute;
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 10px;
    padding: 12px;
    min-width: 220px;
    max-width: 300px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    z-index: 10000;
    font-size: 13px;
  `;

  tooltip.onmouseenter = () => {
    isHoveringTooltip = true;
    if (feedbackWordTooltipTimeout) {
      clearTimeout(feedbackWordTooltipTimeout);
      feedbackWordTooltipTimeout = null;
    }
  };
  tooltip.onmouseleave = () => {
    isHoveringTooltip = false;
    scheduleFeedbackTooltipHide();
  };

  document.body.appendChild(tooltip);

  const rect = wordEl.getBoundingClientRect();
  tooltip.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
  tooltip.style.top = (rect.bottom + 8 + window.scrollY) + 'px';

  try {
    const prompt = `For the Korean word "${korean}", provide:
1. English translation (most common meaning in context)
2. Part of speech (choose exactly one: noun, action verb, descriptive verb, adjective, adverb, conjunction, expression)
3. One short example sentence using this word (Korean with English translation)

CRITICAL CLASSIFICATION RULES:
- If the word ends in  and describes a STATE or QUALITY (not an action), it is a DESCRIPTIVE VERB, NOT an adjective.
  Examples of DESCRIPTIVE VERBS: , , , , , , , , , , , , , , , , 
- ADJECTIVES in Korean are modifier forms that come BEFORE nouns and do NOT end in .
  Examples of ADJECTIVES: , , , , , , , , , 
- ACTION VERBS end in  and describe ACTIONS: , , , , , , 
- Conjunctions: , , , , , , 

Remember:  = descriptive verb,  = adjective. The - ending for states/qualities = descriptive verb.

Respond in this exact JSON format:
{
  "english": "the translation",
  "partOfSpeech": "noun",
  "exampleKorean": " ",
  "exampleEnglish": "English translation of example"
}`;

    const response = await callAIProxy([
      { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no extra text.' },
      { role: 'user', content: prompt }
    ], 0.3);

    let data;
    try {
      const jsonStr = typeof response === 'string' ? response : JSON.stringify(response);
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      data = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
    } catch(e) {
      data = null;
    }

    if (data && document.getElementById('feedbackWordTooltip')) {
      currentFeedbackWordData = { korean, ...data };

      const posColors = {
        'noun': '#667eea',
        'action verb': '#48bb78',
        'descriptive verb': '#38b2ac',
        'adjective': '#9f7aea',
        'adverb': '#ed8936',
        'conjunction': '#ec4899',
        'expression': '#f56565'
      };
      const posLabels = {
        'noun': ' (Noun)',
        'action verb': '  (Action Verb)',
        'descriptive verb': '  (Descriptive Verb)',
        'adjective': ' (Adjective)',
        'adverb': ' (Adverb)',
        'conjunction': ' (Conjunction)',
        'expression': ' (Expression)'
      };

      const posColor = posColors[data.partOfSpeech?.toLowerCase()] || '#667eea';
      const posLabel = posLabels[data.partOfSpeech?.toLowerCase()] || data.partOfSpeech;

      tooltip.innerHTML = `
        <div style="font-size: 20px; font-weight: bold; color: white; margin-bottom: 8px;">${korean}</div>
        <div style="color: #e2e8f0; margin-bottom: 8px;">${data.english || 'Translation unavailable'}</div>
        <div style="display: inline-block; background: ${posColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 10px;">
          ${posLabel}
        </div>
        <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 8px; margin-bottom: 10px;">
          <div style="color: #a78bfa; font-size: 11px; margin-bottom: 4px;">Example:</div>
          <div style="color: white; font-size: 13px;">${data.exampleKorean || ''}</div>
          <div style="color: #a0aec0; font-size: 12px; font-style: italic;">${data.exampleEnglish || ''}</div>
        </div>
        <button onclick="addFeedbackWordToFlashcards()" style="width: 100%; padding: 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
           Add to My Flashcards
        </button>
      `;
    }
  } catch(e) {
    if (document.getElementById('feedbackWordTooltip')) {
      tooltip.innerHTML = `
        <div style="text-align: center; color: #a0aec0; padding: 10px;">
          Could not load word data
        </div>
      `;
    }
  }
}

function scheduleFeedbackTooltipHide() {
  if (feedbackWordTooltipTimeout) {
    clearTimeout(feedbackWordTooltipTimeout);
  }

  feedbackWordTooltipTimeout = setTimeout(() => {
    if (!isHoveringTooltip) {
      hideFeedbackWordTooltip();
    }
  }, 300); // 300ms delay before hiding
}

function hideFeedbackWordTooltip() {
  if (feedbackWordTooltipTimeout) {
    clearTimeout(feedbackWordTooltipTimeout);
    feedbackWordTooltipTimeout = null;
  }

  const tooltip = document.getElementById('feedbackWordTooltip');
  if (tooltip) tooltip.remove();

  document.querySelectorAll('.hoverable-korean-word').forEach(el => {
    el.style.background = 'transparent';
  });

  currentFeedbackWordData = null;
  isHoveringTooltip = false;
}

async function addFeedbackWordToFlashcards() {
  if (!currentFeedbackWordData || !currentUser) {
    showToast(' No word data available');
    return;
  }

  const { korean, english, partOfSpeech, exampleKorean, exampleEnglish } = currentFeedbackWordData;

  const posFolders = {
    'noun': ' Nouns',
    'action verb': ' Action Verbs',
    'descriptive verb': ' Descriptive Verbs',
    'adjective': ' Adjectives',
    'adverb': ' Adverbs',
    'conjunction': ' Conjunctions',
    'expression': ' Expressions'
  };

  const folderName = posFolders[partOfSpeech?.toLowerCase()] || ' Nouns';

  const tooltipBtn = document.querySelector('#feedbackWordTooltip button');
  if (tooltipBtn) {
    tooltipBtn.disabled = true;
    tooltipBtn.innerHTML = ' Generating practice sentences...';
  }

  try {
    let folderQuery = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('name', '==', folderName)
      .get();

    let folderId;
    if (folderQuery.empty) {
      const folderDoc = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: folderName,
        isPartOfSpeechFolder: true,
        isVocabulary: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      folderId = folderDoc.id;
    } else {
      folderId = folderQuery.docs[0].id;
    }

    const existingQuery = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('folderId', '==', folderId)
      .where('korean', '==', korean)
      .get();

    if (!existingQuery.empty) {
      showToast(` "${korean}" is already in your ${folderName} folder!`);
      hideFeedbackWordTooltip();
      return;
    }

    const anyExistingQuery = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('korean', '==', korean)
      .get();

    if (!anyExistingQuery.empty) {
      const existingCard = anyExistingQuery.docs[0].data();
      const existingFolderId = existingCard.folderId;

      let existingFolderName = 'another folder';
      try {
        const folderDoc = await db.collection('studentFolders').doc(existingFolderId).get();
        if (folderDoc.exists) {
          existingFolderName = folderDoc.data().name || 'another folder';
        }
      } catch(e) {}

      showToast(` "${korean}" already exists in ${existingFolderName}!`);
      hideFeedbackWordTooltip();
      return;
    }

    let situationalData = null;
    try {
      const prompt = buildSituationalPrompt(korean, english);
      const response = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert who specializes in creating natural, colloquial Korean conversation examples. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.7);

      if (typeof response === 'string') {
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          situationalData = JSON.parse(jsonMatch[0]);
        }
      } else {
        situationalData = response;
      }
    } catch(aiError) {
    }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: folderId,
      korean: korean,
      english: english,
      partOfSpeech: partOfSpeech,
      exampleKorean: exampleKorean,
      exampleEnglish: exampleEnglish,
      situationalData: situationalData,
      leitnerBox: 1,
      isVocabulary: true,
      source: 'teacher-feedback',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(` Added "${korean}" to ${folderName}!`);
    hideFeedbackWordTooltip();

    if (typeof loadMyFlashcards === 'function') {
      loadMyFlashcards();
    }

  } catch(e) {
    showToast(' Failed to add flashcard');

    if (tooltipBtn) {
      tooltipBtn.disabled = false;
      tooltipBtn.innerHTML = ' Add to My Flashcards';
    }
  }
}

async function toggleFeedbackTranslation() {
  const transcriptDiv = document.getElementById('feedbackTranscriptContent');
  const translationDiv = document.getElementById('feedbackTranslationContent');
  const toggleBtn = document.getElementById('toggleTranslationBtn');

  if (!window.currentFeedbackSubmission?.feedbackTranscript) return;

  const isShowingKorean = transcriptDiv.style.display !== 'none';

  if (isShowingKorean) {
    transcriptDiv.style.display = 'none';
    translationDiv.style.display = 'block';
    toggleBtn.textContent = ' Korean';

    if (!translationDiv.dataset.translated) {
      translationDiv.innerHTML = '<em>Translating...</em>';

      try {
        const prompt = `Translate this Korean text to natural English:
"${window.currentFeedbackSubmission.feedbackTranscript}"

Just provide the English translation, no explanation.`;

        const response = await callAIProxy([
          { role: 'system', content: 'You are a Korean-English translator. Provide natural, fluent translations.' },
          { role: 'user', content: prompt }
        ], 0.5);

        const translation = typeof response === 'string' ? response : JSON.stringify(response);
        translationDiv.textContent = translation;
        translationDiv.dataset.translated = 'true';
      } catch(e) {
        translationDiv.textContent = 'Translation failed. Please try again.';
      }
    }
  } else {
    transcriptDiv.style.display = 'block';
    translationDiv.style.display = 'none';
    toggleBtn.textContent = ' English';
  }
}

async function startDailyDrill(drillId) {
  try {
    const drillDoc = await db.collection('pronunciationLeitner').doc(drillId).get();
    if (!drillDoc.exists) {
      showToast(' Drill not found');
      return;
    }

    const drill = { id: drillDoc.id, ...drillDoc.data() };
    let drillWords = drill.drillWords || [];
    let videoUrl = drill.videoUrl || '';
    let needsUpdate = false;

    const topicParts = drill.topic ? drill.topic.replace('daily-', '').split('-') : [];
    const level = topicParts[0] || ''; // L1, L1C, L1V, or L2
    const id = topicParts.slice(1).join('-'); // Character or rule ID

    if (drillWords.length < 20 && drill.topic) {

      if (level === 'L1' || level === 'L1C') {
        drillWords = getDefaultConsonantDrillWords(id);
      } else if (level === 'L1V') {
        drillWords = getDefaultVowelDrillWords(id);
      } else if (level === 'L2') {
        drillWords = getDefaultAssimilationDrillWords(parseInt(id));
      }

      drillWords = drillWords.slice(0, 20);
      needsUpdate = true;
    }

    if (!videoUrl && drill.topic) {

      try {
        if (level === 'L1' || level === 'L1C') {
          const configDoc = await db.collection('adminSettings').doc('level1Config').get();
          if (configDoc.exists) {
            const config = configDoc.data();
            if (config.consonants?.[id]?.video) {
              videoUrl = config.consonants[id].video;
              needsUpdate = true;
            }
          }
        } else if (level === 'L1V') {
          const configDoc = await db.collection('adminSettings').doc('level1Config').get();
          if (configDoc.exists) {
            const config = configDoc.data();
            if (config.vowels?.[id]?.video) {
              videoUrl = config.vowels[id].video;
              needsUpdate = true;
            }
          }
        } else if (level === 'L2') {
          const videosDoc = await db.collection('adminSettings').doc('level2Videos').get();
          if (videosDoc.exists) {
            const videos = videosDoc.data().videos || {};
            if (videos[parseInt(id)]) {
              videoUrl = videos[parseInt(id)];
              needsUpdate = true;
            }
          }
        }
      } catch(configErr) {
      }
    }

    if (needsUpdate) {
      try {
        const updateData = {};
        if (drillWords.length >= 20) updateData.drillWords = drillWords;
        if (videoUrl) updateData.videoUrl = videoUrl;

        if (Object.keys(updateData).length > 0) {
          await db.collection('pronunciationLeitner').doc(drillId).update(updateData);
        }
      } catch(updateErr) {
      }
    }

    drill.videoUrl = videoUrl;

    const gameAssets = await loadDailyDrillGameAssets();

    dailyDrillPopupState = {
      drillId: drillId,
      drill: drill,
      words: drillWords,
      currentWordIndex: 0,
      correctCount: 0,
      firstTryCorrectCount: 0,  // Track first-try correct for percentage/GIF
      firstTryCorrectInSet: 0,  // Track first-try correct in current set
      wordAttempted: {},        // Track which words have been attempted (by index)
      totalAttempts: 0,
      recognition: null,
      isListening: false,
      shouldContinueListening: true,
      currentSet: 0,
      correctInCurrentSet: 0,
      setResults: [],
      gameAssets: gameAssets
    };

    if (dailyDrillPopupState.words.length === 0) {
      showToast(' No words in this drill');
      return;
    }


    document.getElementById('dailyDrillPopupTitle').textContent = drill.topicLabel || 'Pronunciation Drill';
    document.getElementById('dailyDrillPopupSubtitle').textContent = `Set 1 of 4  ${drill.topicDescription || ''}`;

    document.getElementById('dailyDrillPopup').style.display = 'flex';

    showDailyDrillWord();

  } catch(e) {
    showToast(' Error loading drill');
  }
}

let dailyDrillPopupState = {
  drillId: null,
  drill: null,
  words: [],
  currentWordIndex: 0,
  correctCount: 0,
  firstTryCorrectCount: 0,  // Track first-try correct for percentage/GIF
  firstTryCorrectInSet: 0,  // Track first-try correct in current set
  wordAttempted: {},        // Track which words have been attempted (by index)
  totalAttempts: 0,
  recognition: null,
  isListening: false,
  shouldContinueListening: true,
  currentSet: 0,           // 0-3 (4 sets)
  correctInCurrentSet: 0,  // 0-5 for each set
  setResults: [],          // Array of {correct: X, total: 5} for each completed set
  gameAssets: null
};

async function loadDailyDrillGameAssets() {
  try {
    if (universalGameAssets && universalGameAssets.progressSounds && universalGameAssets.progressSounds[0]) {
      return universalGameAssets;
    }

    const doc = await db.collection('settings').doc('universalGameAssets').get();
    if (doc.exists) {
      const data = doc.data();
      return {
        progressImage: data.progressImage || null,
        progressSounds: data.progressSounds || [null, null, null, null],
        perfectImage: data.perfectImage || null,
        perfectSound: data.perfectSound || null,
        endGifs: data.endGifs || [null, null, null, null, null, null],
        endSounds: data.endSounds || [null, null, null, null, null, null]
      };
    }
  } catch(e) {
  }
  return null;
}

function showDailyDrillWord() {
  const state = dailyDrillPopupState;
  const word = state.words[state.currentWordIndex];

  if (!word) {
    finishDailyDrill();
    return;
  }

  const wordText = typeof word === 'object' ? word.korean || word.word || word : word;
  const meaningText = typeof word === 'object' ? word.english || word.meaning || '' : '';

  state.currentWordText = wordText;

  document.getElementById('dailyDrillWord').textContent = wordText;
  document.getElementById('dailyDrillMeaning').textContent = meaningText;

  const currentSet = Math.floor(state.currentWordIndex / 5) + 1; // 1-4
  const wordInSet = (state.currentWordIndex % 5) + 1; // 1-5

  document.getElementById('dailyDrillWordCount').textContent = `Set ${currentSet}/4  Word ${wordInSet}/5`;
  document.getElementById('dailyDrillPopupSubtitle').textContent = `Word ${state.currentWordIndex + 1} of ${state.words.length}`;

  const progress = (state.currentWordIndex / state.words.length) * 100;
  document.getElementById('dailyDrillProgressBar').style.width = `${progress}%`;

  document.getElementById('dailyDrillFeedback').style.display = 'none';
  document.getElementById('dailyDrillRecognizedText').textContent = '';
  document.getElementById('dailyDrillListeningText').textContent = 'Listening... Say the word!';

  updateDailyDrillStats();

  if (!state.isListening && state.shouldContinueListening) {
    setTimeout(() => {
      if (state.shouldContinueListening && !state.isListening) {
        startDailyDrillListening();
      }
    }, 300);
  }
}

function playDailyDrillAudio() {
  const state = dailyDrillPopupState;
  const wordText = state.currentWordText || document.getElementById('dailyDrillWord').textContent;

  if (!wordText) return;

  if (state.recognition && state.isListening) {
    try {
      state.recognition.abort();
    } catch(e) {}
    state.isListening = false;
  }

  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(wordText);
    utterance.lang = 'ko-KR';
    utterance.rate = 0.8; // Slightly slower for clarity

    const voices = window.speechSynthesis.getVoices();
    const koreanVoice = voices.find(v => v.lang.startsWith('ko'));
    if (koreanVoice) {
      utterance.voice = koreanVoice;
    }

    utterance.onend = () => {
      setTimeout(() => {
        if (state.shouldContinueListening && !state.isListening) {
          startDailyDrillListening();
        }
      }, 300);
    };

    window.speechSynthesis.speak(utterance);

    const audioBtn = document.getElementById('dailyDrillAudioBtn');
    audioBtn.style.background = 'rgba(72, 187, 120, 0.3)';
    setTimeout(() => {
      audioBtn.style.background = 'rgba(255,255,255,0.1)';
    }, 500);
  } else {
    showToast(' Text-to-speech not supported in this browser');
  }
}

function playDrillSound(type) {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    if (type === 'correct') {
      oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
      oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
      oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.4);
    } else {
      oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
      oscillator.type = 'square';
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }
  } catch(e) {
  }
}

function playDailyDrillCorrectSound(correctInSet) {
  const state = dailyDrillPopupState;
  const assets = state.gameAssets;

  if (!assets) {
    playDrillSound('correct');
    return;
  }

  let soundToPlay = null;

  if (correctInSet === 5) {
    soundToPlay = assets.perfectSound;
  } else if (correctInSet >= 1 && correctInSet <= 4) {
    soundToPlay = assets.progressSounds[correctInSet - 1];
  }

  if (soundToPlay) {
    playBase64Sound(soundToPlay);
  } else {
    playDrillSound('correct');
  }
}

function playBase64Sound(base64Data) {
  if (!base64Data) return;

  try {
    const audio = new Audio(base64Data);
    audio.volume = 0.6;
    audio.play().catch(() => {});
  } catch(e) {
  }
}

function showSetCompletionCelebration(correctInSet) {
  const state = dailyDrillPopupState;
  const assets = state.gameAssets;

  // Use firstTryCorrectInSet for set results (strict scoring)
  state.setResults.push({
    correct: state.firstTryCorrectInSet,
    total: 5
  });

  const isLastSet = state.currentWordIndex >= 19;

  // Show celebration based on first-try correct count
  const firstTryCorrect = state.firstTryCorrectInSet;
  
  const celebrationHtml = `
    <div id="setCompletionOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center;
                justify-content: center; z-index: 100; animation: fadeIn 0.3s ease;">
      ${assets?.perfectImage && firstTryCorrect === 5 ? `
        <img src="${assets.perfectImage}" style="max-width: 200px; max-height: 200px; margin-bottom: 20px; animation: bounceIn 0.5s ease;">
      ` : `
        <div style="font-size: 80px; margin-bottom: 20px; animation: bounceIn 0.5s ease;">
          ${firstTryCorrect === 5 ? '' : firstTryCorrect >= 3 ? '' : ''}
        </div>
      `}
      <div style="font-size: 28px; font-weight: bold; color: ${firstTryCorrect === 5 ? '#48bb78' : '#fbbf24'}; margin-bottom: 10px;">
        ${firstTryCorrect === 5 ? 'PERFECT SET!' : `${firstTryCorrect}/5 Correct!`}
      </div>
      <div style="font-size: 16px; color: #a0aec0; margin-bottom: 25px;">
        Set ${state.setResults.length} Complete
      </div>
      <button onclick="continueAfterSetCelebration()" style="padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);
              color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer;">
        ${isLastSet ? ' See Final Results' : ' Next Set'}
      </button>
    </div>
  `;

  const popup = document.getElementById('dailyDrillPopup');
  const overlay = document.createElement('div');
  overlay.innerHTML = celebrationHtml;
  popup.querySelector('div').appendChild(overlay.firstElementChild);

  if (firstTryCorrect === 5) {
    createDailyDrillConfetti();
  }
}

function continueAfterSetCelebration() {
  const state = dailyDrillPopupState;

  const overlay = document.getElementById('setCompletionOverlay');
  if (overlay) overlay.remove();

  state.correctInCurrentSet = 0;
  state.firstTryCorrectInSet = 0;

  if (state.currentWordIndex >= state.words.length - 1) {
    finishDailyDrill();
  } else {
    advanceDailyDrill();
  }
}

function createDailyDrillConfetti() {
  const colors = ['#00d9ff', '#48bb78', '#f6e05e', '#ed64a6', '#9f7aea', '#667eea'];
  const popup = document.getElementById('dailyDrillPopup');

  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.style.cssText = `
      position: absolute;
      width: 10px;
      height: 10px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      left: ${Math.random() * 100}%;
      top: -20px;
      border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
      animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
      animation-delay: ${Math.random() * 0.5}s;
      z-index: 200;
    `;
    popup.appendChild(confetti);
    setTimeout(() => confetti.remove(), 4000);
  }
}

function startDailyDrillListening() {
  const state = dailyDrillPopupState;

  if (!state.shouldContinueListening || state.isListening) {
    return;
  }

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast(' Speech recognition not supported. Use Chrome for best results.');
    return;
  }

  if (!state.recognition) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    state.recognition = new SpeechRecognition();
    state.recognition.lang = 'ko-KR';
    state.recognition.interimResults = true;
    state.recognition.continuous = true; // TRUE continuous mode - stays open
    state.recognition.maxAlternatives = 5;

    state.recognition.onstart = () => {
      console.log('Speech recognition started (continuous mode)');
      state.isListening = true;
      const listeningText = document.getElementById('dailyDrillListeningText');
      if (listeningText) listeningText.textContent = 'Listening... Say the word!';
    };

    state.recognition.onresult = (event) => {
      const resultIndex = event.results.length - 1;
      const results = event.results[resultIndex];
      let recognized = results[0].transcript.trim();

      const recognizedEl = document.getElementById('dailyDrillRecognizedText');
      if (recognizedEl) recognizedEl.textContent = recognized;

      if (!results.isFinal) return;


      const targetText = state.currentWordText;

      const normalizedRecognized = normalizeKoreanForDrillComparison(recognized);
      const normalizedTarget = normalizeKoreanForDrillComparison(targetText);

      console.log(`[Drill Debug] Target: "${targetText}" -> Normalized: "${normalizedTarget}"`);
      console.log(`[Drill Debug] Said: "${recognized}" -> Normalized: "${normalizedRecognized}"`);
      console.log(`[Drill Debug] Exact match: ${normalizedRecognized === normalizedTarget}`);

      // Only check the FIRST (best) result - do NOT loop through alternatives
      // Google's alternatives often include the "correct" word even when mispronounced
      const isCorrect = normalizedRecognized === normalizedTarget;

      console.log(`[Drill Debug] Final isCorrect: ${isCorrect}`);


      state.totalAttempts++;

      if (isCorrect) {
        // Text matched - they pass
        state.correctCount++;
        state.correctInCurrentSet++;

        // Check if this is a first-try (word hasn't been attempted before)
        const isFirstTry = !state.wordAttempted[state.currentWordIndex];
        
        if (isFirstTry) {
          state.firstTryCorrectCount++;
          state.firstTryCorrectInSet++;
        }
        
        // Mark this word as attempted
        state.wordAttempted[state.currentWordIndex] = true;

        // Award 3 coins for correct answer
        awardCoinsWithPopup(3);

        playDailyDrillCorrectSound(state.correctInCurrentSet);

        const wordInSet = (state.currentWordIndex % 5) + 1;

        showDailyDrillFeedback(true, ' Perfect!');

        if (wordInSet === 5) {
          showSetCompletionCelebration(state.firstTryCorrectInSet);
        } else {
          setTimeout(() => {
            advanceDailyDrill();
          }, 600);
        }

      } else {
        // Text didn't match - they must try again
        // Mark this word as attempted (they got it wrong)
        state.wordAttempted[state.currentWordIndex] = true;
        
        playDrillSound('incorrect');

        const listeningText = document.getElementById('dailyDrillListeningText');
        if (listeningText) listeningText.textContent = 'Try again...';
        
        showDailyDrillFeedback(false, `You said: "${recognized}" - Try again!`);

        setTimeout(() => {
          const feedback = document.getElementById('dailyDrillFeedback');
          if (feedback) feedback.style.display = 'none';
          if (listeningText) listeningText.textContent = 'Listening... Say the word!';
          const recognizedEl = document.getElementById('dailyDrillRecognizedText');
          if (recognizedEl) recognizedEl.textContent = '';
        }, 2500);  // 2.5 seconds to read the message before listening again
      }
    };

    state.recognition.onerror = (event) => {

      if (event.error === 'no-speech') {
        const listeningText = document.getElementById('dailyDrillListeningText');
        if (listeningText) listeningText.textContent = 'Say the word...';
      } else if (event.error === 'audio-capture' || event.error === 'not-allowed') {
        showToast(' Microphone access needed. Please allow in browser settings.');
        state.isListening = false;
        state.shouldContinueListening = false;
      }
    };

    state.recognition.onend = () => {
      state.isListening = false;

      if (state.shouldContinueListening) {
        setTimeout(() => {
          if (state.shouldContinueListening && !state.isListening && state.recognition) {
            try {
              state.recognition.start();
              state.isListening = true;
            } catch(e) {
            }
          }
        }, 100);
      }
    };
  }

  try {
    state.recognition.start();
    state.isListening = true;
  } catch(e) {
    state.isListening = false;
  }
}

function normalizeKoreanForComparison(text) {
  return text
    .replace(/\s+/g, '') // Remove spaces
    .replace(/[.,!?~]/g, '') // Remove punctuation
    .toLowerCase()
    .trim();
}

function normalizeKoreanForDrillComparison(text) {
  let normalized = text
    .replace(/\s+/g, '') // Remove spaces
    .replace(/[.,!?~]/g, '') // Remove punctuation
    .toLowerCase()
    .trim();


  let result = '';
  for (let i = 0; i < normalized.length; i++) {
    const char = normalized[i];
    const code = char.charCodeAt(0);

    if (code >= 0xAC00 && code <= 0xD7A3) {
      const syllableIndex = code - 0xAC00;
      const initial = Math.floor(syllableIndex / 588); //  (19 types)
      const medial = Math.floor((syllableIndex % 588) / 28); //  (21 types)
      const final = syllableIndex % 28; //  (28 types, 0 = no final)

      // Vowel indices: =1, =3, =5, =7
      // Initial  = 11
      
      let normalizedMedial = medial;
      
      if (initial === 11) {
        // With  initial: / equivalent, / equivalent, but NOT all four equivalent
        // (=1) and (=5) -> normalize to 1
        // (=3) and (=7) -> normalize to 3
        if (medial === 1 || medial === 5) {
          normalizedMedial = 1; // / -> 
        } else if (medial === 3 || medial === 7) {
          normalizedMedial = 3; // / -> 
        }
      } else {
        // With any other consonant: /// are ALL equivalent
        // /// all sound the same
        if (medial === 1 || medial === 3 || medial === 5 || medial === 7) {
          normalizedMedial = 1; // Treat all as 
        }
      }

      const newCode = 0xAC00 + (initial * 588) + (normalizedMedial * 28) + final;
      result += String.fromCharCode(newCode);
    } else {
      result += char;
    }
  }

  return result;
}

function normalizeKorean(text) {
  return normalizeKoreanForComparison(text);
}

function showDailyDrillFeedback(isCorrect, message) {
  const feedback = document.getElementById('dailyDrillFeedback');
  const feedbackText = document.getElementById('dailyDrillFeedbackText');

  feedback.style.display = 'block';
  feedback.style.background = isCorrect ? 'rgba(72, 187, 120, 0.2)' : 'rgba(245, 101, 101, 0.2)';
  feedback.style.border = `1px solid ${isCorrect ? 'rgba(72, 187, 120, 0.4)' : 'rgba(245, 101, 101, 0.4)'}`;
  feedbackText.style.color = isCorrect ? '#48bb78' : '#f56565';
  feedbackText.textContent = message;

  updateDailyDrillStats();
}

function skipDailyDrillWord() {
  const state = dailyDrillPopupState;

  if (state.recognition) {
    try {
      state.recognition.abort();
    } catch(e) {}
  }
  state.isListening = false;

  state.totalAttempts++;
  advanceDailyDrill();
}

function advanceDailyDrill() {
  const state = dailyDrillPopupState;

  state.currentWordIndex++;

  if (state.currentWordIndex >= state.words.length) {
    finishDailyDrill();
    return;
  }

  showDailyDrillWord();
}

function updateDailyDrillStats() {
  const state = dailyDrillPopupState;

  document.getElementById('dailyDrillCorrectCount').textContent = state.correctCount;
  document.getElementById('dailyDrillTotalCount').textContent = state.totalAttempts;

  const accuracy = state.totalAttempts > 0 ? Math.round((state.correctCount / state.totalAttempts) * 100) : 0;
  document.getElementById('dailyDrillAccuracy').textContent = `${accuracy}%`;
}

async function finishDailyDrill() {
  const state = dailyDrillPopupState;

  state.shouldContinueListening = false;
  if (state.recognition) {
    try {
      state.recognition.abort();
    } catch(e) {}
    state.recognition = null;
  }
  state.isListening = false;

  try {
    const isComplete = true;

    await db.collection('pronunciationLeitner').doc(state.drillId).update({
      completedRepetitionsToday: 1,
      completedToday: true,
      isComplete: isComplete,
      correctCount: (state.drill.correctCount || 0) + state.correctCount,
      totalReviews: (state.drill.totalReviews || 0) + state.totalAttempts,
      lastCompletedDate: firebase.firestore.FieldValue.serverTimestamp(),
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });

    const today = new Date();
    const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    await db.collection('studentPronunciationStats').doc(currentUser.uid).set({
      totalDrillsCompleted: firebase.firestore.FieldValue.increment(1),
      lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
      [`drillLog.${dateKey}`]: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });

    await db.collection('leitnerStats').doc(currentUser.uid).set({
      [`studyLog.${dateKey}`]: firebase.firestore.FieldValue.increment(1),
      lastStudyDate: dateKey
    }, { merge: true });

    // Use firstTryCorrectCount for percentage/GIF (strict scoring)
    const percentage = state.words.length > 0 ? Math.round((state.firstTryCorrectCount / state.words.length) * 100) : 0;

    let tierIndex = 0;
    if (percentage <= 50) tierIndex = 0;
    else if (percentage <= 60) tierIndex = 1;
    else if (percentage <= 70) tierIndex = 2;
    else if (percentage <= 80) tierIndex = 3;
    else if (percentage <= 90) tierIndex = 4;
    else tierIndex = 5; // 91-100%

    const assets = state.gameAssets;
    const endGif = assets?.endGifs?.[tierIndex];
    const endSound = assets?.endSounds?.[tierIndex];

    if (endSound) {
      playBase64Sound(endSound);
    }

    let emoji = '';
    if (percentage >= 90) emoji = '';
    else if (percentage >= 70) emoji = '';
    else if (percentage >= 50) emoji = '';

    document.getElementById('dailyDrillPopup').querySelector('div > div').innerHTML = `
      <div style="text-align: center; padding: 40px 30px; max-height: 90vh; overflow-y: auto;">
        ${endGif ? `
          <img src="${endGif}" style="max-width: 250px; max-height: 200px; margin-bottom: 20px; border-radius: 12px;">
        ` : `
          <div style="font-size: 80px; margin-bottom: 20px;">${emoji}</div>
        `}
        <div style="font-size: 28px; font-weight: bold; color: white; margin-bottom: 10px;">
          Drill Complete!
        </div>
        <div style="font-size: 48px; font-weight: bold; color: ${percentage >= 70 ? '#48bb78' : percentage >= 50 ? '#fbbf24' : '#f56565'}; margin-bottom: 15px;">
          ${percentage}%
        </div>
        <div style="font-size: 16px; color: #a0aec0; margin-bottom: 20px;">
          ${state.firstTryCorrectCount}/${state.words.length} words correct on first try
        </div>

        <!-- Set Results Summary -->
        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 25px;">
          <div style="font-size: 14px; color: #a0aec0; margin-bottom: 10px;">Set Results:</div>
          <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            ${state.setResults.map((result, i) => `
              <div style="background: ${result.correct === 5 ? 'rgba(72, 187, 120, 0.3)' : 'rgba(251, 191, 36, 0.3)'};
                          padding: 8px 15px; border-radius: 8px;">
                <div style="font-size: 12px; color: #a0aec0;">Set ${i + 1}</div>
                <div style="font-size: 18px; font-weight: bold; color: ${result.correct === 5 ? '#48bb78' : '#fbbf24'};">
                  ${result.correct}/5
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <button onclick="closeDailyDrillPopup(); loadDailyActivityDrills();"
                style="padding: 15px 40px; background: linear-gradient(135deg, #48bb78, #38a169);
                       color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer;">
          Continue
        </button>
      </div>
    `;

    if (percentage >= 80) {
      createDailyDrillConfetti();
    }

  } catch(e) {
    showToast(' Error saving progress');
  }
}

function closeDailyDrillPopup() {
  dailyDrillPopupState.shouldContinueListening = false;

  if (dailyDrillPopupState.recognition) {
    try {
      dailyDrillPopupState.recognition.abort();
    } catch(e) {}
  }

  document.getElementById('dailyDrillPopup').style.display = 'none';
  
  // Restore the popup HTML to original state for next drill
  const popup = document.getElementById('dailyDrillPopup');
  popup.querySelector('div > div').innerHTML = `
    <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; display: flex; align-items: center; justify-content: space-between;">
      <div>
        <div id="dailyDrillPopupTitle" style="font-size: 18px; font-weight: 700; color: white;">Pronunciation Drill</div>
        <div id="dailyDrillPopupSubtitle" style="font-size: 13px; color: rgba(255,255,255,0.8);"></div>
      </div>
      <button onclick="closeDailyDrillPopup()" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer;"></button>
    </div>

    <div style="padding: 15px 20px; background: rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #a0aec0;">
        <span id="dailyDrillWordCount">Word 1 of 20</span>
        <span id="dailyDrillRepCount">One-time practice</span>
      </div>
      <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
        <div id="dailyDrillProgressBar" style="height: 100%; width: 0%; background: linear-gradient(135deg, #48bb78, #38a169); transition: width 0.3s;"></div>
      </div>
    </div>

    <div style="padding: 30px; text-align: center;">
      <div id="dailyDrillCard" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 16px; padding: 40px; margin-bottom: 25px; position: relative;">
        <button id="dailyDrillAudioBtn" onclick="playDailyDrillAudio()" style="position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Listen to pronunciation">
          
        </button>
        <div id="dailyDrillWord" style="font-size: 48px; font-weight: bold; color: white; margin-bottom: 10px;"></div>
        <div id="dailyDrillMeaning" style="font-size: 16px; color: #a0aec0;">bag</div>
      </div>

      <div id="dailyDrillVoiceStatus" style="margin-bottom: 20px;">
        <div id="dailyDrillListeningIndicator" style="color: #f56565; font-size: 16px; margin-bottom: 10px;">
          <span class="pulse-dot" style="display: inline-block; width: 12px; height: 12px; background: #f56565; border-radius: 50%; margin-right: 8px; animation: pulse 1s infinite;"></span>
          <span id="dailyDrillListeningText">Listening... Say the word!</span>
        </div>
        <div id="dailyDrillRecognizedText" style="color: #68d391; font-size: 18px; min-height: 30px;"></div>
      </div>

      <div id="dailyDrillFeedback" style="display: none; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
        <div id="dailyDrillFeedbackText" style="font-size: 16px; font-weight: 600;"></div>
      </div>

      <div style="display: flex; gap: 15px; justify-content: center;">
        <button id="dailyDrillSkipBtn" onclick="skipDailyDrillWord()" style="padding: 15px 25px; background: rgba(255,255,255,0.1); color: #a0aec0; border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; font-size: 14px; cursor: pointer;">
          Skip 
        </button>
      </div>
    </div>

    <div id="dailyDrillStatsBar" style="padding: 15px 20px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-around; text-align: center;">
      <div>
        <div id="dailyDrillCorrectCount" style="font-size: 24px; font-weight: bold; color: #48bb78;">0</div>
        <div style="font-size: 11px; color: #68d391;">Correct</div>
      </div>
      <div>
        <div id="dailyDrillTotalCount" style="font-size: 24px; font-weight: bold; color: #a0aec0;">0</div>
        <div style="font-size: 11px; color: #718096;">Total</div>
      </div>
      <div>
        <div id="dailyDrillAccuracy" style="font-size: 24px; font-weight: bold; color: #667eea;">0%</div>
        <div style="font-size: 11px; color: #a78bfa;">Accuracy</div>
      </div>
    </div>
  `;

  dailyDrillPopupState = {
    drillId: null,
    drill: null,
    words: [],
    currentWordIndex: 0,
    correctCount: 0,
    firstTryCorrectCount: 0,
    firstTryCorrectInSet: 0,
    wordAttempted: {},
    totalAttempts: 0,
    recognition: null,
    isListening: false,
    shouldContinueListening: false,
    currentWordText: '',
    currentSet: 0,
    correctInCurrentSet: 0,
    setResults: [],
    gameAssets: null
  };
}

async function loadPastCorrections() {
  if (!currentUser) return;

  const container = document.getElementById('pastCorrectionsContainer');

  try {
    const submissionsSnap = await db.collection('dailySubmissions')
      .where('studentId', '==', currentUser.uid)
      .get();

    const drillsSnap = await db.collection('pronunciationLeitner')
      .where('studentId', '==', currentUser.uid)
      .get();

    const drillsByDate = {};
    drillsSnap.forEach(doc => {
      const data = doc.data();
      if (data.isDailyActivity && data.assignedDate) {
        if (!drillsByDate[data.assignedDate]) {
          drillsByDate[data.assignedDate] = [];
        }
        drillsByDate[data.assignedDate].push({ id: doc.id, ...data });
      }
    });

    let corrections = [];
    submissionsSnap.forEach(doc => {
      const data = doc.data();
      if (data.isGraded) {
        corrections.push({ id: doc.id, ...data });
      }
    });

    corrections.sort((a, b) => {
      const timeA = a.gradedAt?.toDate?.() || new Date(0);
      const timeB = b.gradedAt?.toDate?.() || new Date(0);
      return timeB - timeA;
    });

    corrections = corrections.slice(0, 10);

    const todayStr = new Date().toISOString().split('T')[0];

    const pastDrillDates = Object.keys(drillsByDate)
      .filter(date => date !== todayStr)
      .sort((a, b) => b.localeCompare(a)); // Sort descending

    if (corrections.length === 0 && pastDrillDates.length === 0) {
      container.innerHTML = `<div style="color: #718096; text-align: center; padding: 20px;">No past corrections yet</div>`;
      return;
    }

    let html = '';

    pastDrillDates.forEach(dateStr => {
      const drills = drillsByDate[dateStr];
      const dateObj = new Date(dateStr + 'T12:00:00');
      const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const completedCount = drills.filter(d => d.isComplete || d.completedToday).length;
      const totalCount = drills.length;
      const allDone = completedCount === totalCount;

      html += `
        <div style="background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 12px; overflow: hidden;">
          <div onclick="togglePastDrillsExpand('${dateStr}')" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 24px;">${allDone ? '' : ''}</div>
              <div>
                <div style="color: #e2e8f0; font-size: 14px; font-weight: 600;">${formattedDate}</div>
                <div style="color: #718096; font-size: 12px;">${completedCount}/${totalCount} drills completed</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="padding: 4px 10px; background: ${allDone ? 'rgba(72,187,120,0.2)' : 'rgba(246,173,85,0.2)'}; border-radius: 10px; font-size: 11px; color: ${allDone ? '#48bb78' : '#f6ad55'};">
                ${allDone ? 'Complete' : `${totalCount - completedCount} left`}
              </span>
              <span id="pastDrillArrow-${dateStr}" style="color: #718096; transition: transform 0.2s;"></span>
            </div>
          </div>
          <div id="pastDrillList-${dateStr}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            ${drills.map(drill => {
              const isDone = drill.isComplete || drill.completedToday;
              return `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: ${isDone ? 'rgba(72,187,120,0.1)' : 'rgba(255,255,255,0.03)'}; border-radius: 8px; margin-top: 10px;">
                  <div>
                    <div style="color: ${isDone ? '#48bb78' : '#e2e8f0'}; font-size: 13px;">${isDone ? '' : ''} ${drill.topicLabel || 'Drill'}</div>
                    <div style="color: #718096; font-size: 11px;">Grade: ${drill.grade}/10</div>
                  </div>
                  ${!isDone ? `
                    <button onclick="startDailyDrill('${drill.id}')" style="padding: 6px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 11px; cursor: pointer;">
                       Start
                    </button>
                  ` : `
                    <span style="color: #48bb78; font-size: 11px;">Done</span>
                  `}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    if (corrections.length > 0) {
      html += `<div style="color: #a0aec0; font-size: 12px; margin: 15px 0 10px 0; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);"> Video Feedback History</div>`;
      corrections.forEach(sub => {
        const gradedDate = sub.gradedAt?.toDate?.();
        const totalScore = sub.totalScore || 0;
        const hasVideo = !!sub.videoFeedbackUrl;

        html += `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 24px;">${hasVideo ? '' : ''}</div>
              <div>
                <div style="color: #e2e8f0; font-size: 14px;">${gradedDate ? gradedDate.toLocaleDateString() : 'Unknown date'}</div>
                <div style="color: #718096; font-size: 12px;">Score: ${totalScore}/50</div>
              </div>
            </div>
            ${hasVideo ? `
              <button onclick="playPastCorrection('${sub.videoFeedbackUrl}')" style="padding: 8px 15px; background: rgba(246, 135, 179, 0.2); border: 1px solid rgba(246, 135, 179, 0.4); border-radius: 15px; color: #f687b3; font-size: 12px; cursor: pointer;">
                 Watch
              </button>
            ` : ''}
          </div>
        `;
      });
    }

    container.innerHTML = html;

  } catch(e) {
    container.innerHTML = `<div style="color: #f56565; text-align: center; padding: 20px;">Error loading history</div>`;
  }
}

function togglePastDrillsExpand(dateStr) {
  const list = document.getElementById(`pastDrillList-${dateStr}`);
  const arrow = document.getElementById(`pastDrillArrow-${dateStr}`);
  if (list && arrow) {
    const isHidden = list.style.display === 'none';
    list.style.display = isHidden ? 'block' : 'none';
    arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
  }
}

function playPastCorrection(videoUrl) {
  const videoEl = document.getElementById('latestCorrectionVideo');
  videoEl.src = videoUrl;
  videoEl.style.display = 'block';
  document.getElementById('noVideoMessage').style.display = 'none';
  videoEl.play();

  videoEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function updateDailyCorrectionsPreview() {
  if (!currentUser) return;

  const preview = document.getElementById('dailyCorrectionsPreview');
  if (!preview) return;

  try {
    const snapshot = await db.collection('pronunciationLeitner')
      .where('studentId', '==', currentUser.uid)
      .get();

    let pendingCount = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.isDailyActivity && !data.isComplete) {
        pendingCount++;
      }
    });

    if (pendingCount > 0) {
      preview.innerHTML = `<span style="color: #f687b3; font-weight: 500;"> ${pendingCount} drill${pendingCount > 1 ? 's' : ''} pending</span>`;
    } else {
      preview.innerHTML = `<span style="color: #68d391;"> All drills complete!</span>`;
    }

  } catch(e) {
  }
}


async function loadDailyActivitySelector() {
  const selector = document.getElementById('dailyActivitySelector');
  if (!selector) return;

  try {
    const snapshot = await db.collection('dailyActivities').orderBy('createdAt','desc').limit(30).get();
    let html = '<option value="">-- Select an activity --</option>';

    snapshot.forEach(doc => {
      const a = doc.data();
      if (a.type === 'pronunciation') {
        const date = a.publishDate?.toDate()?.toLocaleDateString() || a.createdAt?.toDate()?.toLocaleDateString() || 'Unknown';
        html += `<option value="${doc.id}">${date} - ${a.submissionCount||0} submissions</option>`;
      }
    });
    selector.innerHTML = html;
  } catch(e) {
    selector.innerHTML = '<option value="">Error loading activities</option>';
  }
}

async function loadDailySubmissions() {
  const activityId = document.getElementById('dailyActivitySelector')?.value;
  const container = document.getElementById('dailySubmissionsContainer');
  if (!activityId || !container) return;

  container.innerHTML = '<div style="text-align:center;padding:40px"><div class="loading"></div></div>';

  try {
    const snapshot = await db.collection('dailySubmissions').where('activityId','==',activityId).get();

    if (snapshot.empty) {
      container.innerHTML = '<p style="text-align:center;padding:40px;color:#718096">No submissions yet for this activity.</p>';
      return;
    }

    let submissions = [];
    snapshot.forEach(doc => {
      submissions.push({ id: doc.id, ...doc.data() });
    });
    submissions.sort((a, b) => {
      const timeA = a.submittedAt?.toDate() || new Date(0);
      const timeB = b.submittedAt?.toDate() || new Date(0);
      return timeB - timeA;
    });

    let html = '<div class="film-roll-container">';

    for (const sub of submissions) {
      let name = 'Student';
      try {
        const userDoc = await db.collection('users').doc(sub.studentId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          name = userData.displayName || userData.email?.split('@')[0] || 'Student';
        }
      } catch(e){}

      const submissionTime = sub.submittedAt?.toDate();

      html += `<div class="student-entry-card">
        <div class="student-header">
          <div class="student-avatar">${name.substring(0,2).toUpperCase()}</div>
          <div class="student-info">
            <div class="student-name">${name}</div>
            <div class="submission-time" style="font-size:11px;color:#718096">${submissionTime ? submissionTime.toLocaleString() : ''}</div>
          </div>
        </div>
        <audio src="${sub.audioUrl}" controls style="width:100%;margin:10px 0"></audio>
        ${sub.isGraded ?
          `<div class="grade-badge graded"> ${sub.totalScore}/50</div>
           <div style="margin-top:8px;font-size:12px;color:#718096">
             Graded sounds: ${Object.entries(sub.grades || {}).map(([k,v]) => `${k}:${v}`).join(', ')}
           </div>
           <button onclick="regradeDailySubmission('${sub.id}')" class="btn" style="width:100%;margin-top:10px;background:linear-gradient(135deg,#ed8936,#dd6b20);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer">
              Regrade This Submission
           </button>` :
          `<button onclick="openDailyGradingModal('${sub.id}')" class="btn" style="width:100%;margin-top:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer">
             Grade This Submission
          </button>`}
      </div>`;
    }
    html += '</div>';
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<p style="color:#e53e3e;text-align:center;padding:40px">Error loading submissions. Check console.</p>';
  }
}

/**
 * Open avatar selection modal
 */
function openAvatarModal() {
  let modal = document.getElementById('avatarModal');

  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'avatarModal';
    modal.className = 'avatar-modal';
    modal.innerHTML = `
      <div class="avatar-modal-content">
        <div class="avatar-modal-header">
          <h3>Choose Your Avatar</h3>
          <button class="avatar-modal-close" onclick="closeAvatarModal()">&times;</button>
        </div>

        <p style="color: #718096; margin-bottom: 15px;">Select a fitness emoji:</p>
        <div class="avatar-grid" id="avatarGrid">
          ${AVATAR_OPTIONS.map(emoji => `
            <div class="avatar-option" onclick="selectAvatar('${emoji}')">${emoji}</div>
          `).join('')}
        </div>

        <div class="avatar-upload-section">
          <p style="color: #718096; margin-bottom: 10px;">Or upload your photo:</p>
          <input type="file" id="avatarFileInput" accept="image/*" style="display: none;" onchange="uploadAvatarFile(event)">
          <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">
             Upload Photo
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  modal.classList.add('active');
}

/**
 * Close avatar modal
 */
function closeAvatarModal() {
  const modal = document.getElementById('avatarModal');
  if (modal) {
    modal.classList.remove('active');
  }
}

/**
 * Select emoji avatar
 */
async function selectAvatar(emoji) {
  if (!currentUser) return;

  try {
    await db.collection('users').doc(currentUser.uid).set({
      avatarEmoji: emoji,
      avatarUrl: null,
      email: currentUser.email
    }, { merge: true });

    document.getElementById('profileAvatarDisplay').textContent = emoji;
    closeAvatarModal();

  } catch (error) {
    alert('Failed to save avatar. Please try again.');
  }
}

/**
 * Upload avatar photo file
 */
async function uploadAvatarFile(event) {
  const file = event.target.files[0];
  if (!file || !currentUser) return;

  if (!file.type.startsWith('image/')) {
    alert('Please select an image file.');
    return;
  }

  if (file.size > 2 * 1024 * 1024) {
    alert('Image must be less than 2MB.');
    return;
  }

  try {
    document.getElementById('profileAvatarDisplay').innerHTML = '<div class="loading"></div>';

    const storageRef = firebase.storage().ref();
    const avatarRef = storageRef.child(`avatars/${currentUser.uid}`);

    await avatarRef.put(file);
    const downloadUrl = await avatarRef.getDownloadURL();

    await db.collection('users').doc(currentUser.uid).set({
      avatarUrl: downloadUrl,
      avatarEmoji: null,
      email: currentUser.email
    }, { merge: true });

    document.getElementById('profileAvatarDisplay').innerHTML = `<img src="${downloadUrl}" alt="Avatar">`;
    closeAvatarModal();

  } catch (error) {
    alert('Failed to upload avatar. Please try again.');
    const initials = (currentUser.email || 'U').substring(0, 2).toUpperCase();
    document.getElementById('profileAvatarDisplay').textContent = initials;
  }
}


let grammarLeitnerCards = [];
let grammarDueCards = [];
let grammarMasteryCards = [];
let grammarLeitnerStats = null;

const GRAMMAR_DRILL_REQUIREMENTS = {
  '1-3': 75,  // Grade 1-3: 75 drills per day
  '4-5': 50,  // Grade 4-5: 50 drills per day
  '6-7': 35,  // Grade 6-7: 35 drills per day
  '8-9': 20,  // Grade 8-9: 20 drills per day
  '10': 0     // Grade 10: no drilling needed
};

function getRequiredDrills(grade) {
  if (grade >= 1 && grade <= 3) return 38;  // Was 75
  if (grade >= 4 && grade <= 5) return 25;  // Was 50
  if (grade >= 6 && grade <= 7) return 18;  // Was 35
  if (grade >= 8 && grade <= 9) return 10;  // Was 20
  return 0; // Grade 10
}

/**
 * Load Grammar Leitner cards for the current student
 */
async function loadGrammarLeitnerCards() {
  if (!currentUser) return;

  try {
    const snapshot = await db.collection('grammarLeitner')
      .where('studentId', '==', currentUser.uid)
      .get();

    grammarLeitnerCards = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    calculateGrammarDueCards();
    updateGrammarLeitnerBadge();

  } catch (error) {
  }
}

/**
 * Calculate which grammar cards are due for review
 */
function calculateGrammarDueCards() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);

  grammarDueCards = grammarLeitnerCards.filter(card => {
    if (card.box >= 8) return false; // Mastered
    if (card.box === 1) return true; // Day 1 always due

    const nextReview = card.nextReviewDate?.toDate ? card.nextReviewDate.toDate() : new Date(card.nextReviewDate);
    nextReview.setHours(0, 0, 0, 0);
    return nextReview <= now;
  });
}

/**
 * Update the grammar leitner badge count
 */
function updateGrammarLeitnerBadge() {
  const badge = document.getElementById('grammarLeitnerBadge');
  if (!badge) return;

  const dueCount = grammarDueCards.length;
  if (dueCount > 0) {
    badge.textContent = dueCount;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

/**
 * Add a topic to Grammar Leitner when graded below 8
 */
async function addToGrammarLeitner(topicData) {
  if (!currentUser) return;

  const { topic, feedback, grade, testTitle, materialTitle, submissionId, drillSentences } = topicData;
  const requiredDrills = getRequiredDrills(grade);

  if (requiredDrills === 0) {
    await addToGrammarMastery(topicData);
    return;
  }

  try {
    const existingQuery = await db.collection('grammarLeitner')
      .where('studentId', '==', currentUser.uid)
      .where('topic', '==', topic)
      .where('submissionId', '==', submissionId)
      .get();

    if (!existingQuery.empty) {
      const docId = existingQuery.docs[0].id;
      await db.collection('grammarLeitner').doc(docId).update({
        feedback: feedback,
        grade: grade,
        requiredDrills: requiredDrills,
        completedDrillsToday: 0,
        drillSentences: drillSentences || [],
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else {
      await db.collection('grammarLeitner').add({
        studentId: currentUser.uid,
        topic: topic,
        feedback: feedback,
        grade: grade,
        requiredDrills: requiredDrills,
        completedDrillsToday: 0,
        drillSentences: drillSentences || [],
        testTitle: testTitle,
        materialTitle: materialTitle,
        submissionId: submissionId,
        box: 1,
        lapseCount: 0,
        correctCount: 0,
        totalReviews: 0,
        firstSeenDate: firebase.firestore.FieldValue.serverTimestamp(),
        nextReviewDate: firebase.firestore.FieldValue.serverTimestamp(),
        lastReviewDate: null,
        addedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    console.log(`Added "${topic}" to Grammar Leitner (Grade: ${grade}, Drills: ${requiredDrills}/day)`);

  } catch (error) {
  }
}

/**
 * Add topic to Grammar Mastery (for grade 10)
 */
async function addToGrammarMastery(topicData) {
  if (!currentUser) return;

  const { topic, testTitle, materialTitle, submissionId } = topicData;

  try {
    const existingQuery = await db.collection('grammarMastery')
      .where('studentId', '==', currentUser.uid)
      .where('topic', '==', topic)
      .get();

    if (existingQuery.empty) {
      await db.collection('grammarMastery').add({
        studentId: currentUser.uid,
        topic: topic,
        testTitle: testTitle,
        materialTitle: materialTitle,
        submissionId: submissionId,
        masteredAt: firebase.firestore.FieldValue.serverTimestamp(),
        practiceCount: 0
      });
    }
  } catch (error) {
  }
}

/**
 * Load Grammar Mastery Deck
 */
async function loadGrammarMasteryDeck() {
  const container = document.getElementById('grammarMasteryContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  try {
    const snapshot = await db.collection('grammarMastery')
      .where('studentId', '==', currentUser.uid)
      .get();

    grammarMasteryCards = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    if (grammarMasteryCards.length === 0) {
      container.innerHTML = `
        <div class="mastery-empty-state">
          <div class="icon"></div>
          <h4>No Mastered Grammar Topics Yet!</h4>
          <p>Complete Grammar Evaluations with a score of 10 to add topics to your Mastery Deck.</p>
          <button class="btn" onclick="switchTab('availableTests')" style="margin-top: 15px;">
             Take Grammar Tests
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="mastery-deck-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);">
        <div class="mastery-deck-header">
          <div class="mastery-deck-title"> Mastered Grammar Topics</div>
          <div class="mastery-count-badge">${grammarMasteryCards.length}</div>
        </div>
        <div class="mastery-word-preview">
          ${grammarMasteryCards.slice(0, 10).map(card =>
            `<span class="mastery-word-tag">${card.topic}</span>`
          ).join('')}
          ${grammarMasteryCards.length > 10 ? `<span class="mastery-word-tag">+${grammarMasteryCards.length - 10} more</span>` : ''}
        </div>
      </div>

      <h3 style="margin-top: 30px; color: #4a5568;">All Mastered Topics</h3>
      <div style="display: grid; gap: 15px; margin-top: 15px;">
        ${grammarMasteryCards.map(card => `
          <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #fbbf24;">
            <div style="font-weight: 600; color: #2d3748; font-size: 16px;">${card.topic}</div>
            <div style="color: #718096; font-size: 14px; margin-top: 5px;">
              From: ${card.testTitle || 'Unknown Test'} - ${card.materialTitle || ''}
            </div>
            <div style="color: #48bb78; font-size: 13px; margin-top: 8px;">
               Mastered with score of 10
            </div>
          </div>
        `).join('')}
      </div>
    `;

  } catch (error) {
    container.innerHTML = `<p style="color: #e53e3e;">Error loading mastery deck: ${error.message}</p>`;
  }
}

/**
 * Render Grammar Leitner Daily Review
 */
async function renderGrammarLeitnerReview() {
  const container = document.getElementById('grammarLeitnerContainer');
  if (!container) return;

  container.innerHTML = '<div class="loading"></div>';

  await loadGrammarLeitnerCards();

  if (grammarLeitnerCards.length === 0) {
    container.innerHTML = `
      <div class="leitner-empty-state">
        <div class="icon"></div>
        <h3>No grammar topics to review!</h3>
        <p>Complete Grammar Evaluations with scores below 10 to get feedback for drilling practice.</p>
        <button class="btn btn-secondary" onclick="switchTab('availableTests')" style="margin-top: 20px;">
           Take Grammar Tests
        </button>
      </div>
    `;
    return;
  }

  const today = new Date().toISOString().split('T')[0];

  const totalCards = grammarLeitnerCards.length;
  const day1Cards = grammarLeitnerCards.filter(c => c.box === 1);
  const masteredCards = grammarLeitnerCards.filter(c => c.box >= 8);

  const cardsNeedingDrills = grammarLeitnerCards.filter(card => {
    if (card.box >= 8) return false;
    const lastDrillDate = card.lastDrillDate?.toDate ?
      card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
    const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
    return completedToday < card.requiredDrills;
  });

  container.innerHTML = `
    <!-- Walk Away Mode Toggle -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
      <button id="grammarWalkAwayModeBtn" onclick="toggleWalkAwayMode()" style="background: linear-gradient(135deg, ${walkAwayMode.enabled ? '#48bb78 0%, #38b2ac' : '#a0aec0 0%, #718096'} 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);">
         Walk Away Mode: ${walkAwayMode.enabled ? 'ON' : 'OFF'}
      </button>
    </div>

    ${walkAwayMode.enabled ? `
      <div style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <p style="color: #276749; margin: 0; font-size: 14px;">
          <strong> Walk Away Mode Active!</strong> Questions will be spoken aloud. Listen and say the Korean translation.
        </p>
      </div>
    ` : ''}

    <!-- Drilling Overview -->
    <div style="background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border: 2px solid #667eea; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
      <h3 style="color: #667eea; margin-bottom: 15px;"> Today's Grammar Drilling</h3>
      <p style="color: #4a5568; margin-bottom: 15px;">
        <strong>${cardsNeedingDrills.length}</strong> topic${cardsNeedingDrills.length !== 1 ? 's' : ''} need drilling today
      </p>

      ${cardsNeedingDrills.length > 0 ? `
        <button class="btn" onclick="startGrammarDrilling()" style="padding: 12px 25px;">
           Start Drilling Session
        </button>
      ` : `
        <p style="color: #48bb78; font-weight: 600;"> All drilling complete for today!</p>
      `}
    </div>

    <!-- Topics to Drill -->
    <h3 style="color: #4a5568; margin-bottom: 15px;"> Topics to Practice</h3>
    <div style="display: grid; gap: 15px;">
      ${grammarLeitnerCards.filter(c => c.box < 8).map(card => {
        const lastDrillDate = card.lastDrillDate?.toDate ?
          card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
        const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
        const remaining = Math.max(0, card.requiredDrills - completedToday);
        const progressPercent = card.requiredDrills > 0 ? (completedToday / card.requiredDrills * 100) : 100;

        return `
          <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid ${remaining === 0 ? '#48bb78' : '#f59e0b'};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
              <div>
                <div style="font-weight: 600; color: #2d3748; font-size: 16px;">${card.topic}</div>
                <div style="color: #718096; font-size: 14px; margin-top: 5px;">
                  Grade: ${card.grade}/10 | Box: Day ${card.box}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 14px; color: ${remaining === 0 ? '#48bb78' : '#f59e0b'}; font-weight: 600;">
                  ${completedToday}/${card.requiredDrills} drills today
                </div>
                ${remaining > 0 ? `<div style="font-size: 12px; color: #718096;">${remaining} remaining</div>` : ''}
              </div>
            </div>

            <!-- Progress Bar -->
            <div style="background: #e2e8f0; border-radius: 10px; height: 8px; margin-top: 15px; overflow: hidden;">
              <div style="background: ${remaining === 0 ? '#48bb78' : '#f59e0b'}; height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
            </div>

            <!-- Feedback Preview -->
            ${card.feedback ? `
              <div style="background: #f7fafc; border-radius: 8px; padding: 12px; margin-top: 15px;">
                <div style="font-size: 12px; color: #667eea; font-weight: 600; margin-bottom: 5px;">Teacher Feedback:</div>
                <div style="font-size: 14px; color: #4a5568;">${card.feedback.substring(0, 150)}${card.feedback.length > 150 ? '...' : ''}</div>
              </div>
            ` : ''}

            ${remaining > 0 ? `
              <button onclick="startSingleTopicDrill('${card.id}')" class="btn btn-secondary" style="margin-top: 15px; padding: 8px 16px; font-size: 14px;">
                 Drill This Topic (${remaining} left)
              </button>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Start grammar drilling session
 */
async function startGrammarDrilling() {
  const today = new Date().toISOString().split('T')[0];

  const cardsNeedingDrills = grammarLeitnerCards.filter(card => {
    if (card.box >= 8) return false;
    const lastDrillDate = card.lastDrillDate?.toDate ?
      card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
    const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
    return completedToday < card.requiredDrills;
  });

  if (cardsNeedingDrills.length === 0) {
    alert('All drilling complete for today!');
    return;
  }

  startSingleTopicDrill(cardsNeedingDrills[0].id);
}

/**
 * Start drilling a single topic
 */
let oldGrammarDrillState = {
  cardId: null,
  sentences: [],
  currentSentenceIndex: 0,
  completedSentences: [],
  isListening: false,
  timer: null,
  timeRemaining: 30,
  recognition: null,
  inPassiveRecall: true,
  currentSetIndex: 0,
  sentencesPerSet: 5,
  totalSets: 1,
  isProcessingMatch: false  // Prevent multiple matches at once
};

async function startSingleTopicDrill(cardId) {
  startStudySession('grammar');

  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) return;

  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card.lastDrillDate?.toDate ?
    card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
  const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
  const remaining = Math.max(0, card.requiredDrills - completedToday);

  if (remaining === 0) {
    alert('All drills completed for this topic today!');
    return;
  }

  const drillSentences = card.drillSentences || [];

  if (drillSentences.length === 0) {
    showSimpleDrillInterface(card, completedToday);
    return;
  }

  oldGrammarDrillState.cardId = cardId;
  oldGrammarDrillState.sentences = shuffleArray([...drillSentences]);
  oldGrammarDrillState.currentSentenceIndex = 0;
  oldGrammarDrillState.completedSentences = [];
  oldGrammarDrillState.inPassiveRecall = true;
  oldGrammarDrillState.currentSetIndex = 0;
  oldGrammarDrillState.sentencesPerSet = 5;
  oldGrammarDrillState.totalSets = Math.ceil(drillSentences.length / 5);

  showPassiveRecallView(card, completedToday);
}

function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function showPassiveRecallView(card, completedToday) {
  const container = document.getElementById('grammarLeitnerContainer');
  const sentences = oldGrammarDrillState.sentences;

  container.innerHTML = `
    <div class="grammar-drill-container">
      <button onclick="renderGrammarLeitnerReview()" class="btn btn-secondary" style="margin-bottom: 20px;"> Back</button>

      <div style="text-align: center; margin-bottom: 25px;">
        <h2 style="color: #667eea;"> ${card.topic}</h2>
        <p style="color: #718096;">Grade: ${card.grade}/10 | ${completedToday}/${card.requiredDrills} drills today</p>
      </div>

      <div style="background: #fef3c7; border: 2px solid #fcd34d; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: center;">
        <h3 style="color: #92400e;"> Study Phase - Memorize These!</h3>
        <p style="color: #78350f;">You'll see 5 questions at a time and speak the answers.</p>
      </div>

      <div class="grammar-drill-passive-view">
        <div class="grammar-drill-column questions">
          <h4 style="color: #92400e;"> Questions</h4>
          ${sentences.map((s, i) => `
            <div class="grammar-drill-sentence">
              <span class="number">${i + 1}</span>
              <span>${s.question}</span>
            </div>
          `).join('')}
        </div>
        <div class="grammar-drill-column answers">
          <h4 style="color: #166534;"> Answers (Memorize!)</h4>
          ${sentences.map((s, i) => `
            <div class="grammar-drill-sentence">
              <span class="number">${i + 1}</span>
              <span>${s.answer}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <button onclick="startActiveDrill()" class="btn" style="padding: 20px 60px; font-size: 22px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
           I'm Ready - Start Speaking!
        </button>
      </div>
    </div>
  `;
}

function startActiveDrill() {
  const card = grammarLeitnerCards.find(c => c.id === oldGrammarDrillState.cardId);
  if (!card) return;

  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card.lastDrillDate?.toDate ?
    card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
  const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;

  oldGrammarDrillState.inPassiveRecall = false;
  oldGrammarDrillState.timeRemaining = 30;

  renderFlashcardSet(card, completedToday);
}

function renderFlashcardSet(card, completedToday) {
  const container = document.getElementById('grammarLeitnerContainer');
  const sentences = oldGrammarDrillState.sentences;
  const setIndex = oldGrammarDrillState.currentSetIndex;
  const sentencesPerSet = oldGrammarDrillState.sentencesPerSet;
  const totalSets = oldGrammarDrillState.totalSets;

  const startIdx = setIndex * sentencesPerSet;
  const endIdx = Math.min(startIdx + sentencesPerSet, sentences.length);
  const currentSetSentences = sentences.slice(startIdx, endIdx);

  const currentIdx = oldGrammarDrillState.currentSentenceIndex;
  const currentQuestion = sentences[currentIdx]?.question || '';

  container.innerHTML = `
    <div class="grammar-drill-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button onclick="exitGrammarDrill()" class="btn btn-danger"> Exit</button>
        <button id="grammarWalkAwayModeBtn" onclick="toggleWalkAwayMode()" style="background: linear-gradient(135deg, ${walkAwayMode.enabled ? '#48bb78 0%, #38b2ac' : '#a0aec0 0%, #718096'} 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;">
           Walk Away Mode: ${walkAwayMode.enabled ? 'ON' : 'OFF'}
        </button>
      </div>

      ${walkAwayMode.enabled ? `
        <div style="background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); border: 2px solid #48bb78; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
          <p style="color: #276749; margin: 0; font-size: 13px;">
            <strong> Walk Away Mode Active!</strong> Questions will be spoken aloud.
          </p>
        </div>
      ` : ''}

      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: #667eea;"> ${card.topic}</h2>
        <div style="color: #718096;">Set ${setIndex + 1} of ${totalSets}  Drill ${completedToday + 1}/${card.requiredDrills}</div>
      </div>

      <div class="grammar-drill-timer" id="grammarDrillTimer">${oldGrammarDrillState.timeRemaining}</div>

      <!-- Flashcard with questions only -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 25px; margin: 20px 0;">
        <div style="text-align: center; margin-bottom: 15px; color: rgba(255,255,255,0.8);">
          Speak the answers aloud (${startIdx + 1}-${endIdx} of ${sentences.length})
        </div>
        <div id="flashcardSentences" style="display: grid; gap: 12px;">
          ${currentSetSentences.map((s, i) => {
            const globalIdx = startIdx + i;
            const isCompleted = oldGrammarDrillState.completedSentences.includes(globalIdx);
            const isCurrent = globalIdx === oldGrammarDrillState.currentSentenceIndex;
            return `
              <div id="sentence-row-${globalIdx}"
                   onclick="selectSentence(${globalIdx})"
                   style="display: flex; align-items: center; gap: 15px; padding: 15px 20px;
                     background: ${isCompleted ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : isCurrent ? 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)' : 'rgba(255,255,255,0.15)'};
                     border-radius: 12px; cursor: pointer; border: 3px solid ${isCurrent ? '#fbbf24' : isCompleted ? '#10b981' : 'transparent'};
                     box-shadow: ${isCurrent ? '0 4px 20px rgba(251, 191, 36, 0.5)' : 'none'};">
                <div style="width: 36px; height: 36px; border-radius: 50%;
                  background: ${isCompleted ? 'white' : isCurrent ? '#fbbf24' : 'rgba(255,255,255,0.3)'};
                  color: ${isCompleted ? '#10b981' : isCurrent ? '#1e3a8a' : 'white'}; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">
                  ${isCompleted ? '' : globalIdx + 1}
                </div>
                <div style="flex: 1; color: white; font-size: 20px; font-weight: ${isCurrent ? '700' : '400'};">
                  ${s.question}
                </div>
                ${isCurrent ? '<div style="font-size: 24px;"></div>' : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <!-- Mic Status -->
      <div class="grammar-drill-mic-status" id="grammarMicStatus">
        <div style="font-size: 32px;"></div>
        <div style="margin-top: 10px;">Press Start to begin</div>
        <div class="grammar-drill-recognized" id="grammarRecognized">-</div>
      </div>

      <!-- Controls -->
      <div style="display: flex; gap: 15px; justify-content: center; margin: 25px 0; flex-wrap: wrap;">
        <button id="startListeningBtn" onclick="startGrammarListening()" class="btn btn-secondary" style="padding: 15px 30px;">
           Start Listening
        </button>
        <button onclick="speakCurrentAnswer()" class="btn" style="padding: 15px 30px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
           Hear Answer
        </button>
      </div>

      <!-- Progress -->
      <div style="text-align: center; color: #718096; font-size: 14px;">
        ${oldGrammarDrillState.completedSentences.length}/${sentences.length} sentences complete
      </div>

      <!-- Complete Button -->
      <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
        <button id="completeDrillBtn" onclick="completeGrammarDrill()" class="btn btn-drill-complete"
          ${oldGrammarDrillState.completedSentences.length < sentences.length ? 'disabled' : ''}>
           Complete Drill (+1)
        </button>
        <p style="color: #718096; font-size: 14px; margin-top: 10px;">
          ${oldGrammarDrillState.completedSentences.length < sentences.length
            ? 'Complete all sentences to unlock'
            : ' Ready to submit!'}
        </p>
      </div>
    </div>
  `;

  if (!oldGrammarDrillState.timer) {
    startGrammarDrillTimer();
  }

  if (walkAwayMode.enabled && currentQuestion) {
    setTimeout(() => {
      speakEnglish(currentQuestion);
    }, 500);
  }
}

function selectSentence(index) {
  oldGrammarDrillState.currentSentenceIndex = index;
  const card = grammarLeitnerCards.find(c => c.id === oldGrammarDrillState.cardId);
  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card?.lastDrillDate?.toDate?.()?.toISOString().split('T')[0] || null;
  const completedToday = lastDrillDate === today ? (card?.completedDrillsToday || 0) : 0;
  oldGrammarDrillState.currentSetIndex = Math.floor(index / oldGrammarDrillState.sentencesPerSet);
  renderFlashcardSet(card, completedToday);
}

function markCurrentCorrectAndAdvance() {
  const currentIndex = oldGrammarDrillState.currentSentenceIndex;
  const sentences = oldGrammarDrillState.sentences;

  if (!oldGrammarDrillState.completedSentences.includes(currentIndex)) {
    oldGrammarDrillState.completedSentences.push(currentIndex);
  }

  const sentencesPerSet = oldGrammarDrillState.sentencesPerSet;
  const currentSetStart = oldGrammarDrillState.currentSetIndex * sentencesPerSet;
  const currentSetEnd = Math.min(currentSetStart + sentencesPerSet, sentences.length);

  for (let i = currentSetStart; i < currentSetEnd; i++) {
    if (!oldGrammarDrillState.completedSentences.includes(i)) {
      oldGrammarDrillState.currentSentenceIndex = i;
      updateFlashcardUI();
      return;
    }
  }

  if (oldGrammarDrillState.completedSentences.length >= sentences.length) {
    allSentencesCompleted();
    return;
  }

  oldGrammarDrillState.currentSetIndex++;
  oldGrammarDrillState.currentSentenceIndex = oldGrammarDrillState.currentSetIndex * sentencesPerSet;
  oldGrammarDrillState.timeRemaining = 30;

  const card = grammarLeitnerCards.find(c => c.id === oldGrammarDrillState.cardId);
  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card?.lastDrillDate?.toDate?.()?.toISOString().split('T')[0] || null;
  const completedToday = lastDrillDate === today ? (card?.completedDrillsToday || 0) : 0;
  renderFlashcardSet(card, completedToday);
}

function updateFlashcardUI() {
  const sentences = oldGrammarDrillState.sentences;
  const sentencesPerSet = oldGrammarDrillState.sentencesPerSet;
  const setIndex = oldGrammarDrillState.currentSetIndex;
  const startIdx = setIndex * sentencesPerSet;
  const endIdx = Math.min(startIdx + sentencesPerSet, sentences.length);

  for (let i = startIdx; i < endIdx; i++) {
    const row = document.getElementById(`sentence-row-${i}`);
    if (!row) continue;

    const isCompleted = oldGrammarDrillState.completedSentences.includes(i);
    const isCurrent = i === oldGrammarDrillState.currentSentenceIndex;

    if (isCompleted) {
      row.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      row.style.border = '3px solid #10b981';
      row.style.boxShadow = 'none';
    } else if (isCurrent) {
      row.style.background = 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)';
      row.style.border = '3px solid #fbbf24';
      row.style.boxShadow = '0 4px 20px rgba(251, 191, 36, 0.5)';
    } else {
      row.style.background = 'rgba(255,255,255,0.15)';
      row.style.border = '3px solid transparent';
      row.style.boxShadow = 'none';
    }

    const circle = row.querySelector('div > div:first-child');
    if (circle) {
      if (isCompleted) {
        circle.style.background = 'white';
        circle.style.color = '#10b981';
        circle.textContent = '';
      } else if (isCurrent) {
        circle.style.background = '#fbbf24';
        circle.style.color = '#1e3a8a';
        circle.textContent = i + 1;
      } else {
        circle.style.background = 'rgba(255,255,255,0.3)';
        circle.style.color = 'white';
        circle.textContent = i + 1;
      }
    }

    const textDiv = row.querySelector('div > div:nth-child(2)');
    if (textDiv) {
      textDiv.style.color = 'white';
      textDiv.style.fontWeight = isCurrent ? '700' : '400';
    }
  }

  if (oldGrammarDrillState.completedSentences.length >= sentences.length) {
    const btn = document.getElementById('completeDrillBtn');
    if (btn) btn.disabled = false;
  }

  if (walkAwayMode.enabled) {
    const currentQuestion = sentences[oldGrammarDrillState.currentSentenceIndex]?.question;
    if (currentQuestion) {
      setTimeout(() => {
        speakEnglish(currentQuestion);
      }, 300);
    }
  }
}

function allSentencesCompleted() {
  if (oldGrammarDrillState.timer) {
    clearInterval(oldGrammarDrillState.timer);
    oldGrammarDrillState.timer = null;
  }
  stopGrammarListening();

  const btn = document.getElementById('completeDrillBtn');
  if (btn) {
    btn.disabled = false;
    btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
  }
}

function startGrammarDrillTimer() {
  if (oldGrammarDrillState.timer) clearInterval(oldGrammarDrillState.timer);

  oldGrammarDrillState.timer = setInterval(() => {
    oldGrammarDrillState.timeRemaining--;
    const timerEl = document.getElementById('grammarDrillTimer');
    if (timerEl) {
      timerEl.textContent = oldGrammarDrillState.timeRemaining;
      timerEl.className = 'grammar-drill-timer' +
        (oldGrammarDrillState.timeRemaining <= 5 ? ' critical' : oldGrammarDrillState.timeRemaining <= 10 ? ' warning' : '');
    }

    if (oldGrammarDrillState.timeRemaining <= 0) {
      clearInterval(oldGrammarDrillState.timer);
      oldGrammarDrillState.timer = null;
      handleTimerExpired();
    }
  }, 1000);
}

function handleTimerExpired() {
  stopGrammarListening();

  playWalkAwaySound('timeup');

  const completed = oldGrammarDrillState.completedSentences.length;
  const total = oldGrammarDrillState.sentences.length;

  const currentIndex = oldGrammarDrillState.currentSentenceIndex;
  const currentSentence = oldGrammarDrillState.sentences[currentIndex];
  if (currentSentence && !oldGrammarDrillState.completedSentences.includes(currentIndex)) {
    let answerToSpeak = currentSentence.answer;
    if (answerToSpeak.includes('  ')) {
      answerToSpeak = answerToSpeak.split('  ')[0].trim();
    } else if (answerToSpeak.includes(' - ')) {
      answerToSpeak = answerToSpeak.split(' - ')[0].trim();
    }
    speakKorean(answerToSpeak);
  }

  if (completed >= total) {
    allSentencesCompleted();
  } else {
    const container = document.getElementById('grammarLeitnerContainer');
    container.innerHTML = `
      <div class="grammar-drill-container" style="text-align: center;">
        <h2 style="color: #f59e0b;"> Time's Up!</h2>
        <p>${completed}/${total} sentences completed</p>
        <p style="color: #718096; margin-top: 10px;">The correct answer was: <strong style="color: #1e40af; font-size: 20px;">${currentSentence ? currentSentence.answer : ''}</strong></p>
        <div style="margin-top: 20px;">
          <button onclick="continueGrammarDrill()" class="btn btn-secondary" style="margin-right: 10px;">Continue (${total - completed} left)</button>
          <button onclick="renderGrammarLeitnerReview()" class="btn">Back to Review</button>
        </div>
      </div>
    `;
  }
}

function continueGrammarDrill() {
  oldGrammarDrillState.timeRemaining = 30;
  for (let i = 0; i < oldGrammarDrillState.sentences.length; i++) {
    if (!oldGrammarDrillState.completedSentences.includes(i)) {
      oldGrammarDrillState.currentSentenceIndex = i;
      oldGrammarDrillState.currentSetIndex = Math.floor(i / oldGrammarDrillState.sentencesPerSet);
      break;
    }
  }
  const card = grammarLeitnerCards.find(c => c.id === oldGrammarDrillState.cardId);
  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card?.lastDrillDate?.toDate?.()?.toISOString().split('T')[0] || null;
  const completedToday = lastDrillDate === today ? (card?.completedDrillsToday || 0) : 0;
  renderFlashcardSet(card, completedToday);
}

/**
 * Speak Korean text using Google Cloud TTS API (high quality)
 */
let currentTTSAudio = null;

async function speakKorean(text) {
  if (!text) return;

  if (currentTTSAudio) {
    currentTTSAudio.pause();
    currentTTSAudio = null;
  }

  try {

    const response = await fetch('https://us-central1-korean-tts-proxy.cloudfunctions.net/synthesizeSpeech', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        voiceName: 'ko-KR-Wavenet-A',
        speakingRate: 0.9
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'TTS API error');
    }

    const data = await response.json();
    if (!data.audioContent) throw new Error('No audio content returned');

    playBase64Audio(data.audioContent);

  } catch (err) {
    speakKoreanFallback(text);
  }
}

/**
 * Play base64-encoded audio
 */
function playBase64Audio(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binary.charCodeAt(i);
  }

  const blob = new Blob([bytes], { type: 'audio/mpeg' });
  const url = URL.createObjectURL(blob);

  currentTTSAudio = new Audio(url);
  currentTTSAudio.play().catch(() => {});

  currentTTSAudio.onended = () => {
    URL.revokeObjectURL(url);
    currentTTSAudio = null;
  };
}

/**
 * Fallback to browser speech synthesis if API fails
 */
function speakKoreanFallback(text) {
  if (!window.speechSynthesis) return;

  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'ko-KR';
  utterance.rate = 0.9;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  const voices = window.speechSynthesis.getVoices();
  const koreanVoice = voices.find(v => v.lang.startsWith('ko'));
  if (koreanVoice) {
    utterance.voice = koreanVoice;
  }

  window.speechSynthesis.speak(utterance);
}

/**
 * Speak English text with optional callback when done
 * Used for hands-free continuation prompts
 */
function speakText(text, onEnd) {
  if (!window.speechSynthesis) {
    if (onEnd) setTimeout(onEnd, 100);
    return;
  }

  window.speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US';
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  const voices = window.speechSynthesis.getVoices();
  const englishVoice = voices.find(v => v.lang.startsWith('en'));
  if (englishVoice) {
    utterance.voice = englishVoice;
  }

  if (onEnd) {
    utterance.onend = onEnd;
    utterance.onerror = () => {
      onEnd();
    };
  }

  window.speechSynthesis.speak(utterance);

  if (onEnd) {
    const estimatedDuration = Math.max(2000, text.length * 80); // Rough estimate
    setTimeout(() => {
      if (utterance.pending || utterance.speaking) return;
    }, estimatedDuration + 500);
  }
}

/**
 * Speak the current answer (for the Hear Answer button)
 */
function speakCurrentAnswer() {
  const currentIndex = oldGrammarDrillState.currentSentenceIndex;
  const currentSentence = oldGrammarDrillState.sentences[currentIndex];

  if (currentSentence) {
    let answerToSpeak = currentSentence.answer;
    if (answerToSpeak.includes('  ')) {
      answerToSpeak = answerToSpeak.split('  ')[0].trim();
    } else if (answerToSpeak.includes(' - ')) {
      answerToSpeak = answerToSpeak.split(' - ')[0].trim();
    }
    speakKorean(answerToSpeak);
  }
}

if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {
    console.log('Voices loaded:', window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('ko')).map(v => v.name));
  };
}

function initGrammarSpeechRecognition() {
  if (oldGrammarDrillState.recognition) return;

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  oldGrammarDrillState.recognition = new SpeechRecognition();
  oldGrammarDrillState.recognition.lang = 'ko-KR';
  oldGrammarDrillState.recognition.continuous = true;
  oldGrammarDrillState.recognition.interimResults = true;  // Show what's being heard, but only match on final

  oldGrammarDrillState.recognition.onresult = (event) => {
    if (oldGrammarDrillState.isProcessingMatch) return;

    const el = document.getElementById('grammarRecognized');

    const latestResultIndex = event.results.length - 1;
    const latestResult = event.results[latestResultIndex];
    const transcript = latestResult[0].transcript.trim();

    if (el) el.textContent = transcript || '-';

    if (!latestResult.isFinal) {
      console.log('Interim result (ignoring):', transcript);
      return;
    }


    const currentIndex = oldGrammarDrillState.currentSentenceIndex;
    const currentSentence = oldGrammarDrillState.sentences[currentIndex];

    if (oldGrammarDrillState.completedSentences.includes(currentIndex)) return;

    if (currentSentence && transcript) {
      const normalizeKorean = (str) => {
        return str.replace(/\s+/g, '')
                  .replace(/[.,!?~'"'""]/g, '');
      };

      const normalizedTranscript = normalizeKorean(transcript);

      let answerToMatch = currentSentence.answer;

      if (answerToMatch.includes('  ')) {
        answerToMatch = answerToMatch.split('  ')[0].trim();
      } else if (answerToMatch.includes(' - ')) {
        answerToMatch = answerToMatch.split(' - ')[0].trim();
      }

      const normalizedAnswer = normalizeKorean(answerToMatch);

      console.log('Comparing:', {
        said: normalizedTranscript,
        expected: normalizedAnswer
      });

      let isMatch = false;

      if (normalizedTranscript === normalizedAnswer) {
        isMatch = true;
      }

      if (isMatch) {
        oldGrammarDrillState.isProcessingMatch = true;

        playWalkAwaySound('correct');

        if (el) {
          el.style.color = '#10b981';
          el.textContent = ' ' + answerToMatch;
        }

        speakKorean(answerToMatch);

        setTimeout(() => {
          if (el) {
            el.style.color = '#1e40af';
            el.textContent = '-';
          }

          markCurrentCorrectAndAdvance();

          setTimeout(() => {
            oldGrammarDrillState.isProcessingMatch = false;
          }, 500);

        }, 1200);  // Longer delay to let TTS finish
      } else if (normalizedTranscript.length > 0) {
        playWalkAwaySound('wrong');

        if (el && walkAwayMode.enabled) {
          el.style.color = '#f56565';
          el.textContent = ' ' + transcript;

          setTimeout(() => {
            el.style.color = '#1e40af';
            el.textContent = '-';
          }, 1000);
        }
      }
    }
  };

  oldGrammarDrillState.recognition.onerror = (event) => {
  };

  oldGrammarDrillState.recognition.onend = () => {
    if (oldGrammarDrillState.isListening && oldGrammarDrillState.timeRemaining > 0) {
      setTimeout(() => {
        if (oldGrammarDrillState.isListening &&
            oldGrammarDrillState.timeRemaining > 0 &&
            !oldGrammarDrillState.isProcessingMatch) {
          try {
            oldGrammarDrillState.recognition.start();
          } catch (e) {
          }
        }
      }, 300);
    }
  };
}

function startGrammarListening() {
  if (!oldGrammarDrillState.recognition) initGrammarSpeechRecognition();
  if (!oldGrammarDrillState.recognition) {
    alert('Speech recognition not supported. Use Chrome.');
    return;
  }

  oldGrammarDrillState.isListening = true;
  oldGrammarDrillState.isProcessingMatch = false;  // Reset processing flag

  const statusEl = document.getElementById('grammarMicStatus');
  if (statusEl) statusEl.classList.add('listening');

  const btn = document.getElementById('startListeningBtn');
  if (btn) {
    btn.innerHTML = ' Listening...';
    btn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    btn.style.color = 'white';
    btn.onclick = stopGrammarListening;
  }

  try { oldGrammarDrillState.recognition.start(); } catch (e) {}
}

function stopGrammarListening() {
  oldGrammarDrillState.isListening = false;
  oldGrammarDrillState.isProcessingMatch = false;  // Reset processing flag

  if (oldGrammarDrillState.recognition) {
    try { oldGrammarDrillState.recognition.stop(); } catch (e) {}
  }

  const statusEl = document.getElementById('grammarMicStatus');
  if (statusEl) statusEl.classList.remove('listening');

  const btn = document.getElementById('startListeningBtn');
  if (btn) {
    btn.innerHTML = ' Start Listening';
    btn.style.background = '';
    btn.style.color = '';
    btn.onclick = startGrammarListening;
  }
}

function exitGrammarDrill() {
  if (oldGrammarDrillState.timer) {
    clearInterval(oldGrammarDrillState.timer);
    oldGrammarDrillState.timer = null;
  }
  stopGrammarListening();
  renderGrammarLeitnerReview();
}

async function completeGrammarDrill() {
  endStudySession();

  const cardId = oldGrammarDrillState.cardId;
  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) return;

  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card.lastDrillDate?.toDate?.()?.toISOString().split('T')[0] || null;
  let completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
  completedToday++;

  try {
    await db.collection('grammarLeitner').doc(cardId).update({
      completedDrillsToday: completedToday,
      lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
      totalReviews: firebase.firestore.FieldValue.increment(1)
    });

    card.completedDrillsToday = completedToday;
    card.lastDrillDate = { toDate: () => new Date() };

    if (completedToday >= card.requiredDrills) {
      await advanceGrammarCard(cardId);

      await loadGrammarLeitnerCards();

      if (allInOneState.isActive && allInOneState.currentPhase === 'grammar') {
        if (grammarDueCards.length === 0) {
          const container = document.getElementById('grammarLeitnerContainer');
          container.innerHTML = `
            <div class="grammar-drill-container" style="text-align: center;">
              <div style="font-size: 80px;"></div>
              <h2 style="color: #10b981;">Grammar Phase Complete!</h2>
              <p>${card.topic} advanced to next stage.</p>
              <p style="color: #718096; margin-top: 10px;">All grammar cards done!</p>

              ${walkAwayMode.enabled ? `
                <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
                  <p style="color: #6b46c1; font-size: 14px; margin: 0;">
                     <strong>Listening...</strong> Say "Yes" to continue to next phase
                  </p>
                </div>
              ` : ''}

              <button onclick="completeAllInOnePhase('grammar')" class="btn" style="margin-top: 20px;">Continue to Next Phase</button>
            </div>
          `;

          if (walkAwayMode.enabled) {
            setTimeout(() => {
              startHandsFreeContinuation(
                () => { completeAllInOnePhase('grammar'); },
                () => {
                  const statusEl = document.getElementById('handsFreeContinueStatus');
                  if (statusEl) {
                    statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                      No response detected. Click the button to continue.
                    </p>`;
                  }
                }
              );
            }, 1000);
          }
          return;
        } else {
          const container = document.getElementById('grammarLeitnerContainer');
          container.innerHTML = `
            <div class="grammar-drill-container" style="text-align: center;">
              <div style="font-size: 80px;"></div>
              <h2 style="color: #10b981;">Card Complete!</h2>
              <p>${card.topic} advanced to next stage.</p>
              <p style="color: #718096; margin-top: 10px;">${grammarDueCards.length} more grammar cards to go</p>

              ${walkAwayMode.enabled ? `
                <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
                  <p style="color: #6b46c1; font-size: 14px; margin: 0;">
                     <strong>Listening...</strong> Say "Yes" to continue to next card
                  </p>
                </div>
              ` : ''}

              <button onclick="startNextGrammarDrillForAllInOne()" class="btn" style="margin-top: 20px;">Continue to Next Card</button>
            </div>
          `;

          if (walkAwayMode.enabled) {
            setTimeout(() => {
              startHandsFreeContinuation(
                () => { startNextGrammarDrillForAllInOne(); },
                () => {
                  const statusEl = document.getElementById('handsFreeContinueStatus');
                  if (statusEl) {
                    statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                      No response detected. Click the button to continue.
                    </p>`;
                  }
                }
              );
            }, 1000);
          }
          return;
        }
      }

      const container = document.getElementById('grammarLeitnerContainer');

      const moreGrammarDue = grammarDueCards.length > 0;

      container.innerHTML = `
        <div class="grammar-drill-container" style="text-align: center;">
          <div style="font-size: 80px;"></div>
          <h2 style="color: #10b981;">All Drills Complete!</h2>
          <p>${card.topic} advanced to next stage.</p>

          ${moreGrammarDue ? `
            ${walkAwayMode.enabled ? `
              <div id="handsFreeContinueStatus" style="background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); border: 2px solid #9f7aea; padding: 15px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
                <p style="color: #6b46c1; font-size: 14px; margin: 0;">
                   <strong>Listening...</strong> Say "Yes" to continue to next card (${grammarDueCards.length} more)
                </p>
              </div>
            ` : `
              <p style="color: #718096; margin-top: 10px;">${grammarDueCards.length} more grammar card${grammarDueCards.length !== 1 ? 's' : ''} due today</p>
            `}
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <button id="grammarContinueBtn" class="btn" style="padding: 12px 30px; background: #48bb78;">
                 Next Card (${grammarDueCards.length})
              </button>
              <button onclick="renderGrammarLeitnerReview()" class="btn btn-secondary" style="padding: 12px 30px;">
                Done
              </button>
            </div>
          ` : `
            <p style="color: #276749; margin-top: 10px;">All grammar cards done for today! </p>
            <button onclick="renderGrammarLeitnerReview()" class="btn" style="margin-top: 20px;">Continue</button>
          `}
        </div>
      `;

      if (moreGrammarDue) {
        const continueBtn = document.getElementById('grammarContinueBtn');
        if (continueBtn) {
          continueBtn.onclick = () => {
            const nextCard = grammarDueCards[0];
            if (nextCard) startGrammarDrill(nextCard.id);
          };
        }

        if (walkAwayMode.enabled) {
          setTimeout(() => {
            startHandsFreeContinuation(
              () => {
                const nextCard = grammarDueCards[0];
                if (nextCard) startGrammarDrill(nextCard.id);
              },
              () => {
                const statusEl = document.getElementById('handsFreeContinueStatus');
                if (statusEl) {
                  statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
                    No response detected. Click a button to continue.
                  </p>`;
                }
              }
            );
          }, 1000);
        }
      }
    } else {
      oldGrammarDrillState.sentences = shuffleArray([...oldGrammarDrillState.sentences]);
      oldGrammarDrillState.completedSentences = [];
      oldGrammarDrillState.currentSentenceIndex = 0;
      oldGrammarDrillState.currentSetIndex = 0;
      showPassiveRecallView(card, completedToday);
    }
  } catch (error) {
    alert('Error saving progress');
  }
}

function showSimpleDrillInterface(card, completedToday) {
  const container = document.getElementById('grammarLeitnerContainer');
  container.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <button onclick="renderGrammarLeitnerReview()" class="btn btn-secondary" style="margin-bottom: 20px;"> Back</button>

      <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="color: #667eea;"> ${card.topic}</h2>
        <p style="color: #718096;">Grade: ${card.grade}/10 | ${completedToday}/${card.requiredDrills} drills today</p>
      </div>

      <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <p style="color: #92400e;"> No drill sentences set up for this topic. Using simple drill mode.</p>
      </div>

      <div style="background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border-radius: 12px; padding: 25px; margin: 25px 0;">
        <h3 style="color: #667eea;"> Study This:</h3>
        <div style="font-size: 18px; color: #2d3748;">${card.feedback || 'Practice this grammar concept.'}</div>
      </div>

      <div style="text-align: center;">
        <button onclick="completeSimpleDrill('${card.id}')" class="btn" style="padding: 20px 50px; font-size: 20px;">
           I Practiced This (+1 Drill)
        </button>
      </div>
    </div>
  `;
}

async function completeSimpleDrill(cardId) {
  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) return;

  const today = new Date().toISOString().split('T')[0];
  const lastDrillDate = card.lastDrillDate?.toDate?.()?.toISOString().split('T')[0] || null;
  let completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
  completedToday++;

  try {
    await db.collection('grammarLeitner').doc(cardId).update({
      completedDrillsToday: completedToday,
      lastDrillDate: firebase.firestore.FieldValue.serverTimestamp(),
      totalReviews: firebase.firestore.FieldValue.increment(1)
    });

    card.completedDrillsToday = completedToday;
    card.lastDrillDate = { toDate: () => new Date() };

    if (completedToday >= card.requiredDrills) {
      await advanceGrammarCard(cardId);
      alert('All drills complete! Topic advanced.');
      renderGrammarLeitnerReview();
    } else {
      showSimpleDrillInterface(card, completedToday);
    }
  } catch (error) {
  }
}

/**
 * Advance grammar card to next Leitner box
 */
async function advanceGrammarCard(cardId) {
  const card = grammarLeitnerCards.find(c => c.id === cardId);
  if (!card) return;

  const newBox = Math.min(card.box + 1, 8);
  const nextReviewDate = new Date();

  const intervals = { 1: 1, 2: 2, 3: 4, 4: 7, 5: 14, 6: 30, 7: 60 };
  if (newBox < 8) {
    nextReviewDate.setDate(nextReviewDate.getDate() + (intervals[newBox] || 1));
  }

  try {
    const updateData = {
      box: newBox,
      correctCount: firebase.firestore.FieldValue.increment(1),
      lastReviewDate: firebase.firestore.FieldValue.serverTimestamp(),
      completedDrillsToday: 0 // Reset for next day
    };

    if (newBox < 8) {
      updateData.nextReviewDate = firebase.firestore.Timestamp.fromDate(nextReviewDate);
    } else {
      updateData.masteredDate = firebase.firestore.FieldValue.serverTimestamp();
    }

    await db.collection('grammarLeitner').doc(cardId).update(updateData);

    card.box = newBox;

    calculateGrammarDueCards();
    updateGrammarLeitnerBadge();

  } catch (error) {
  }
}

/**
 * Render Grammar Box Grid (Calendar view)
 */
async function renderGrammarBoxGrid() {
  const container = document.getElementById('grammarBoxGrid');
  if (!container) return;

  document.getElementById('grammarBoxDetail').style.display = 'none';
  container.style.display = 'grid';

  await loadGrammarLeitnerCards();

  const boxCounts = {};
  const dueCounts = {};
  const nextDueDate = {};

  for (let i = 1; i <= 8; i++) {
    const boxCards = grammarLeitnerCards.filter(c => c.box === i);
    boxCounts[i] = boxCards.length;
    dueCounts[i] = grammarDueCards.filter(c => c.box === i).length;

    const notDueCards = boxCards.filter(c => {
      const isDue = grammarDueCards.some(dc => dc.id === c.id);
      return !isDue && c.nextReviewDate;
    });

    if (notDueCards.length > 0) {
      const dates = notDueCards.map(c => {
        return c.nextReviewDate?.toDate ? c.nextReviewDate.toDate() : new Date(c.nextReviewDate);
      }).sort((a, b) => a - b);
      nextDueDate[i] = dates[0];
    }
  }

  if (grammarLeitnerCards.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1 / -1;">
        <div class="leitner-empty-state">
          <div class="icon"></div>
          <h3>No grammar topics in your review calendar</h3>
          <p>Complete Grammar Evaluations with feedback to start building your review schedule.</p>
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = Object.entries(LEITNER_BOX_NAMES).map(([box, name]) => {
    const boxNum = parseInt(box);
    const count = boxCounts[boxNum] || 0;
    const due = dueCounts[boxNum] || 0;
    const cssClass = LEITNER_BOX_CLASSES[boxNum];
    const isDay1 = boxNum === 1;
    const isMastery = boxNum === 8;

    let dueIndicator = '';
    if (due > 0 && boxNum < 8) {
      dueIndicator = `<div class="leitner-due-indicator">!</div>`;
    }

    let statusText = '';
    if (isDay1 && count > 0) {
      statusText = `<div style="font-size: 11px; color: #667eea; margin-top: 5px;">Drill daily</div>`;
    } else if (isMastery) {
      statusText = `<div style="font-size: 11px; color: #9f7aea; margin-top: 5px;">Completed!</div>`;
    } else if (due > 0) {
    } else if (count > 0 && nextDueDate[boxNum]) {
      const dueDate = nextDueDate[boxNum];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      let dateStr;
      if (dueDate.toDateString() === today.toDateString()) {
        dateStr = 'Today';
      } else if (dueDate.toDateString() === tomorrow.toDateString()) {
        dateStr = 'Tomorrow';
      } else {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        dateStr = `${monthNames[dueDate.getMonth()]} ${dueDate.getDate()}`;
      }
      statusText = `<div style="font-size: 11px; color: #a0aec0; margin-top: 5px;"> Due: ${dateStr}</div>`;
    }

    return `
      <div class="leitner-box-card ${cssClass}" onclick="showGrammarBoxDetail(${boxNum})">
        ${dueIndicator}
        <div class="box-label">${name}</div>
        <div class="box-count">${count}</div>
        ${due > 0 && !isMastery ? `<div class="box-due">${due} due</div>` : ''}
        ${statusText}
      </div>
    `;
  }).join('');
}

/**
 * Show grammar box detail
 */
function showGrammarBoxDetail(boxNum) {
  const container = document.getElementById('grammarBoxGrid');
  const detailView = document.getElementById('grammarBoxDetail');
  const titleEl = document.getElementById('grammarBoxDetailTitle');
  const listEl = document.getElementById('grammarBoxDetailList');

  container.style.display = 'none';
  detailView.style.display = 'block';
  titleEl.textContent = `${LEITNER_BOX_NAMES[boxNum]} - Grammar Topics`;

  const boxCards = grammarLeitnerCards.filter(c => c.box === boxNum);

  if (boxCards.length === 0) {
    listEl.innerHTML = `
      <div class="leitner-empty-state">
        <div class="icon"></div>
        <h3>No topics in this box</h3>
      </div>
    `;
    return;
  }

  listEl.innerHTML = boxCards.map(card => `
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
      <div style="font-weight: 600; color: #2d3748; font-size: 16px;">${card.topic}</div>
      <div style="color: #718096; font-size: 14px; margin-top: 5px;">
        Grade: ${card.grade}/10 | Drills Required: ${card.requiredDrills}/day
      </div>
      ${card.feedback ? `
        <div style="background: #f7fafc; border-radius: 8px; padding: 12px; margin-top: 10px;">
          <div style="font-size: 12px; color: #667eea; font-weight: 600;">Feedback:</div>
          <div style="font-size: 14px; color: #4a5568; margin-top: 5px;">${card.feedback}</div>
        </div>
      ` : ''}
    </div>
  `).join('');
}

/**
 * Close grammar box detail
 */
function closeGrammarBoxDetail() {
  document.getElementById('grammarBoxDetail').style.display = 'none';
  document.getElementById('grammarBoxGrid').style.display = 'grid';
}

/**
 * Render Grammar Stats
 */
async function renderGrammarStats() {
  await loadGrammarLeitnerCards();

  const boxCounts = {};
  for (let i = 1; i <= 8; i++) {
    boxCounts[i] = grammarLeitnerCards.filter(c => c.box === i).length;
  }

  const totalLearning = grammarLeitnerCards.filter(c => c.box < 8).length;
  const totalMastered = boxCounts[8] || 0;

  let masteryDeckCount = 0;
  try {
    const masterySnapshot = await db.collection('grammarMastery')
      .where('studentId', '==', currentUser.uid)
      .get();
    masteryDeckCount = masterySnapshot.size;
  } catch (e) {}

  const combinedMastered = totalMastered + masteryDeckCount;
  const totalCards = grammarLeitnerCards.length + masteryDeckCount;
  const masteryRate = totalCards > 0 ? (combinedMastered / totalCards * 100).toFixed(1) : 0;

  const today = new Date().toISOString().split('T')[0];
  let totalDrillsToday = 0;
  let totalDrillsRequired = 0;

  grammarLeitnerCards.filter(c => c.box < 8).forEach(card => {
    const lastDrillDate = card.lastDrillDate?.toDate ?
      card.lastDrillDate.toDate().toISOString().split('T')[0] : null;
    const completedToday = lastDrillDate === today ? (card.completedDrillsToday || 0) : 0;
    totalDrillsToday += completedToday;
    totalDrillsRequired += card.requiredDrills || 0;
  });

  const drillProgress = totalDrillsRequired > 0 ? (totalDrillsToday / totalDrillsRequired * 100).toFixed(1) : 100;

  document.getElementById('grammarCoreProgress').innerHTML = `
    <div class="leitner-stat-card">
      <h4> Grammar Mastery</h4>
      <div class="stat-value" style="color: #f59e0b;">${masteryDeckCount}</div>
      <div class="stat-label">topics scored 10</div>
    </div>
    <div class="leitner-stat-card">
      <h4> Leitner Graduated</h4>
      <div class="stat-value" style="color: #9f7aea;">${totalMastered}</div>
      <div class="stat-label">through SRS review</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Mastery Rate</h4>
      <div class="stat-value" style="color: #667eea;">${masteryRate}%</div>
      <div class="stat-label">of all topics</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Total Learning</h4>
      <div class="stat-value">${totalLearning}</div>
      <div class="stat-label">topics in rotation</div>
    </div>
  `;

  document.getElementById('grammarDrillingProgress').innerHTML = `
    <div class="leitner-stat-card">
      <h4>Today's Drills</h4>
      <div class="stat-value" style="color: #48bb78;">${totalDrillsToday}</div>
      <div class="stat-label">of ${totalDrillsRequired} required</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Progress</h4>
      <div class="stat-value" style="color: ${drillProgress >= 100 ? '#48bb78' : '#f59e0b'};">${drillProgress}%</div>
      <div class="stat-label">drilling complete today</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Day 1 Topics</h4>
      <div class="stat-value">${boxCounts[1] || 0}</div>
      <div class="stat-label">need daily drilling</div>
    </div>
    <div class="leitner-stat-card">
      <h4>Total Reviews</h4>
      <div class="stat-value">${grammarLeitnerCards.reduce((sum, c) => sum + (c.totalReviews || 0), 0)}</div>
      <div class="stat-label">all time</div>
    </div>
  `;

  const needsWork = grammarLeitnerCards
    .filter(c => c.box < 8 && c.grade <= 5)
    .sort((a, b) => a.grade - b.grade)
    .slice(0, 5);

  document.getElementById('grammarTopicsNeedingWork').innerHTML = needsWork.length > 0 ? `
    <div style="display: grid; gap: 15px;">
      ${needsWork.map(card => `
        <div style="background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #f56565;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #2d3748;">${card.topic}</div>
              <div style="font-size: 13px; color: #718096;">Grade: ${card.grade}/10 | ${card.requiredDrills} drills/day</div>
            </div>
            <button onclick="startSingleTopicDrill('${card.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">
              Drill
            </button>
          </div>
        </div>
      `).join('')}
    </div>
  ` : `
    <div style="background: #d4edda; border-radius: 12px; padding: 20px; text-align: center;">
      <div style="color: #155724; font-weight: 600;"> No topics need urgent attention!</div>
      <p style="color: #155724; margin-top: 5px;">Keep up the great work with your grammar practice.</p>
    </div>
  `;
}

/**
 * Get avatar HTML for leaderboards
 */
async function getAvatarForUser(userId) {
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      if (data.avatarUrl) {
        return `<img src="${data.avatarUrl}" alt="">`;
      } else if (data.avatarEmoji) {
        return data.avatarEmoji;
      }
    }
  } catch (e) {}
  return null;
}


/**
 * Global state for Walk Away Mode
 */
let walkAwayMode = {
  enabled: false,
  sounds: {
    wrong: null,
    timeup: null,
    correct: null,
    continue: null,
    movingon: null,
    playAgain: null
  },
  audioElements: {
    wrong: null,
    timeup: null,
    correct: null,
    continue: null,
    movingon: null,
    playAgain: null
  },
  continuation: {
    isListening: false,
    recognition: null,
    callback: null
  }
};

/**
 * Global state for Swipe Mode (no voice, manual correct/incorrect buttons)
 * When enabled: voice recognition is disabled, user swipes/taps to mark correct/incorrect
 * Awards only 1 coin per correct answer instead of full coins
 */
let swipeMode = {
  enabled: false
};

function toggleSwipeMode() {
  swipeMode.enabled = !swipeMode.enabled;
  if (swipeMode.enabled) {
    walkAwayMode.enabled = false;
  }
  localStorage.setItem('swipeModeEnabled', swipeMode.enabled);
  return swipeMode.enabled;
}

function loadSwipeModePreference() {
  const saved = localStorage.getItem('swipeModeEnabled');
  if (saved === 'true') {
    swipeMode.enabled = true;
  }
}

function setFlashcardMode(mode) {
  if (mode === 'voice') {
    swipeMode.enabled = false;
    walkAwayMode.enabled = false;
  } else if (mode === 'walkaway') {
    swipeMode.enabled = false;
    walkAwayMode.enabled = true;
  } else if (mode === 'swipe') {
    swipeMode.enabled = true;
    walkAwayMode.enabled = false;
  }
  localStorage.setItem('swipeModeEnabled', swipeMode.enabled);
  updateFlashcardModeDisplay();
}

function updateFlashcardModeDisplay() {
  const voiceBtn = document.getElementById('flashcardVoiceModeBtn');
  const walkAwayBtn = document.getElementById('flashcardWalkAwayModeBtn');
  const swipeBtn = document.getElementById('flashcardSwipeModeBtn');
  const description = document.getElementById('flashcardModeDescription');
  const voiceSection = document.getElementById('englishVoiceSection');

  if (!voiceBtn || !walkAwayBtn || !swipeBtn) return;

  const activeStyle = (color1, color2) => `flex: 1; min-width: 80px; max-width: 120px; padding: 8px 12px; background: linear-gradient(135deg, ${color1} 0%, ${color2} 100%); color: white; border: 2px solid transparent; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 11px;`;
  const inactiveStyle = 'flex: 1; min-width: 80px; max-width: 120px; padding: 8px 12px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 11px;';

  if (swipeMode.enabled) {
    voiceBtn.style.cssText = inactiveStyle;
    walkAwayBtn.style.cssText = inactiveStyle;
    swipeBtn.style.cssText = activeStyle('#f59e0b', '#d97706');
    if (description) description.textContent = ' Swipe mode: Only 1 coin per correct (no voice required)';
    if (voiceSection) voiceSection.style.display = 'none';
  } else if (walkAwayMode.enabled) {
    voiceBtn.style.cssText = inactiveStyle;
    walkAwayBtn.style.cssText = activeStyle('#48bb78', '#38b2ac');
    swipeBtn.style.cssText = inactiveStyle;
    if (description) description.textContent = ' Hands-free mode with voice prompts';
    if (voiceSection) voiceSection.style.display = 'block';
  } else {
    voiceBtn.style.cssText = activeStyle('#667eea', '#764ba2');
    walkAwayBtn.style.cssText = inactiveStyle;
    swipeBtn.style.cssText = inactiveStyle;
    if (description) description.textContent = ' Speak Korean words to earn full coins';
    if (voiceSection) voiceSection.style.display = 'block';
  }
}

/**
 * Load Walk Away Mode sounds from Firestore
 */
async function loadWalkAwaySounds() {
  try {
    const doc = await db.collection('settings').doc('walkAwayMode').get();
    if (doc.exists) {
      const data = doc.data();
      walkAwayMode.sounds.wrong = data.wrongSound || null;
      walkAwayMode.sounds.timeup = data.timeupSound || null;
      walkAwayMode.sounds.correct = data.correctSound || null;
      walkAwayMode.sounds.continue = data.continueSound || null;
      walkAwayMode.sounds.movingon = data.movingonSound || null;
      walkAwayMode.sounds.playAgain = data.playAgainSound || null;

      if (walkAwayMode.sounds.wrong) {
        walkAwayMode.audioElements.wrong = new Audio(walkAwayMode.sounds.wrong);
      }
      if (walkAwayMode.sounds.timeup) {
        walkAwayMode.audioElements.timeup = new Audio(walkAwayMode.sounds.timeup);
      }
      if (walkAwayMode.sounds.correct) {
        walkAwayMode.audioElements.correct = new Audio(walkAwayMode.sounds.correct);
      }
      if (walkAwayMode.sounds.continue) {
        walkAwayMode.audioElements.continue = new Audio(walkAwayMode.sounds.continue);
      }
      if (walkAwayMode.sounds.movingon) {
        walkAwayMode.audioElements.movingon = new Audio(walkAwayMode.sounds.movingon);
      }
      if (walkAwayMode.sounds.playAgain) {
        walkAwayMode.audioElements.playAgain = new Audio(walkAwayMode.sounds.playAgain);
      }


      updateWalkAwaySoundsDisplay();
    }
  } catch (error) {
  }
}

/**
 * Play a Walk Away Mode sound
 */
function playWalkAwaySound(type) {
  if (!walkAwayMode.enabled) return;

  const audio = walkAwayMode.audioElements[type];
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }
}

/**
 * Start hands-free continuation - asks "Continue?" and listens for "Yes"
 * @param {Function} onYes - Callback when user says "Yes"
 * @param {Function} onNo - Callback when user says "No" or timeout
 */
function startHandsFreeContinuation(onYes, onNo) {
  if (!walkAwayMode.enabled) {
    return;
  }


  const statusEl = document.getElementById('handsFreeContinueStatus');
  if (statusEl) {
    statusEl.innerHTML = `<p style="color: #6b46c1; font-size: 14px; margin: 0;">
       <strong>Playing prompt...</strong>
    </p>`;
  }

  if (walkAwayMode.audioElements.continue) {
    const audio = walkAwayMode.audioElements.continue;
    audio.currentTime = 0; // Reset to beginning

    audio.onended = () => {
      updateContinuationStatusToListening();
      startContinuationListening(onYes, onNo);
    };

    audio.play().then(() => {
    }).catch(e => {
      speakContinuationPrompt(onYes, onNo);
    });

    setTimeout(() => {
      if (!walkAwayMode.continuation.isListening) {
        updateContinuationStatusToListening();
        startContinuationListening(onYes, onNo);
      }
    }, 5000); // 5 second max wait
  } else {
    speakContinuationPrompt(onYes, onNo);
  }
}

/**
 * Speak the continuation prompt using TTS
 */
function speakContinuationPrompt(onYes, onNo) {
  speakText('Would you like to continue?', () => {
    updateContinuationStatusToListening();
    startContinuationListening(onYes, onNo);
  });
}

/**
 * Update the continuation status UI to show listening state
 */
function updateContinuationStatusToListening() {
  const statusEl = document.getElementById('handsFreeContinueStatus');
  if (statusEl) {
    statusEl.innerHTML = `<p style="color: #6b46c1; font-size: 14px; margin: 0;">
       <strong>Listening...</strong> Say "Yes" to continue or "No" to stop
    </p>`;
  }
}

/**
 * Start listening for Yes/No response
 */
function startContinuationListening(onYes, onNo) {

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    const statusEl = document.getElementById('handsFreeContinueStatus');
    if (statusEl) {
      statusEl.innerHTML = `<p style="color: #c53030; font-size: 14px; margin: 0;">
         Voice recognition not supported. Please click a button.
      </p>`;
    }
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();

  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US'; // Listen for English "Yes"
  recognition.maxAlternatives = 3;

  let responded = false;
  let timeoutId = null;
  let restartCount = 0;
  const maxRestarts = 3;

  walkAwayMode.continuation.isListening = true;
  walkAwayMode.continuation.recognition = recognition;
  walkAwayMode.continuation.callback = { onYes, onNo };

  recognition.onresult = (event) => {
    if (responded) return;

    for (let i = 0; i < event.results.length; i++) {
      const result = event.results[i];
      for (let j = 0; j < result.length; j++) {
        const transcript = result[j].transcript.toLowerCase().trim();

        const statusEl = document.getElementById('handsFreeContinueStatus');
        if (statusEl) {
          statusEl.innerHTML = `<p style="color: #6b46c1; font-size: 14px; margin: 0;">
             Heard: "${transcript}"
          </p>`;
        }

        if (transcript.includes('yes') || transcript.includes('yeah') ||
            transcript.includes('yep') || transcript.includes('sure') ||
            transcript.includes('okay') || transcript.includes('continue') ||
            transcript.includes('') || transcript.includes('')) {
          responded = true;
          clearTimeout(timeoutId);
          walkAwayMode.continuation.isListening = false;
          try { recognition.stop(); } catch(e) {}

          if (statusEl) {
            statusEl.innerHTML = `<p style="color: #48bb78; font-size: 14px; margin: 0;">
               Moving on...
            </p>`;
          }

          if (walkAwayMode.audioElements.movingon) {
            const audio = walkAwayMode.audioElements.movingon;
            audio.currentTime = 0;
            audio.onended = () => {
              if (onYes) onYes();
            };
            audio.play().catch(e => {
              if (onYes) onYes();
            });
            setTimeout(() => {
              if (onYes) onYes();
            }, 3000);
          } else {
            speakText('Moving on!', () => {
              if (onYes) onYes();
            });
          }
          return;
        }

        if (transcript.includes('no') || transcript.includes('stop') ||
            transcript.includes('done') || transcript.includes('quit') ||
            transcript.includes('')) {
          responded = true;
          clearTimeout(timeoutId);
          walkAwayMode.continuation.isListening = false;
          try { recognition.stop(); } catch(e) {}

          if (statusEl) {
            statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
               Okay, stopping here.
            </p>`;
          }
          if (onNo) onNo();
          return;
        }
      }
    }
  };

  recognition.onerror = (event) => {
    if (!responded && event.error !== 'no-speech') {
    }
  };

  recognition.onend = () => {
    if (!responded && walkAwayMode.continuation.isListening && restartCount < maxRestarts) {
      restartCount++;
      try {
        recognition.start();
      } catch (e) {
      }
    }
  };

  try {
    recognition.start();
  } catch (e) {
    const statusEl = document.getElementById('handsFreeContinueStatus');
    if (statusEl) {
      statusEl.innerHTML = `<p style="color: #c53030; font-size: 14px; margin: 0;">
         Could not start listening. Please click a button.
      </p>`;
    }
  }

  timeoutId = setTimeout(() => {
    if (!responded) {
      responded = true;
      walkAwayMode.continuation.isListening = false;
      try { recognition.stop(); } catch (e) {}

      const statusEl = document.getElementById('handsFreeContinueStatus');
      if (statusEl) {
        statusEl.innerHTML = `<p style="color: #718096; font-size: 14px; margin: 0;">
           No response detected. Click a button to continue.
        </p>`;
      }
      if (onNo) onNo();
    }
  }, 10000);
}

/**
 * Stop continuation listening
 */
function stopContinuationListening() {
  walkAwayMode.continuation.isListening = false;
  if (walkAwayMode.continuation.recognition) {
    try {
      walkAwayMode.continuation.recognition.stop();
    } catch (e) {}
    walkAwayMode.continuation.recognition = null;
  }
}

/**
 * Update the admin display of current sounds
 */
function updateWalkAwaySoundsDisplay() {
  const container = document.getElementById('walkAwaySoundsList');
  if (!container) return;

  let html = '<div style="display: grid; gap: 10px;">';

  html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${walkAwayMode.sounds.wrong ? '#fed7d7' : '#e2e8f0'}; border-radius: 8px;">
    <span> Wrong Sound:</span>
    ${walkAwayMode.sounds.wrong ?
      `<audio controls src="${walkAwayMode.sounds.wrong}" style="height: 30px;"></audio>
       <button onclick="removeWalkAwaySound('wrong')" style="padding: 4px 10px; background: #f56565; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>` :
      '<span style="color: #a0aec0;">Not set</span>'}
  </div>`;

  html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${walkAwayMode.sounds.timeup ? '#feebc8' : '#e2e8f0'}; border-radius: 8px;">
    <span> Time's Up Sound:</span>
    ${walkAwayMode.sounds.timeup ?
      `<audio controls src="${walkAwayMode.sounds.timeup}" style="height: 30px;"></audio>
       <button onclick="removeWalkAwaySound('timeup')" style="padding: 4px 10px; background: #ed8936; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>` :
      '<span style="color: #a0aec0;">Not set</span>'}
  </div>`;

  html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${walkAwayMode.sounds.correct ? '#c6f6d5' : '#e2e8f0'}; border-radius: 8px;">
    <span> Correct Sound:</span>
    ${walkAwayMode.sounds.correct ?
      `<audio controls src="${walkAwayMode.sounds.correct}" style="height: 30px;"></audio>
       <button onclick="removeWalkAwaySound('correct')" style="padding: 4px 10px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>` :
      '<span style="color: #a0aec0;">Not set</span>'}
  </div>`;

  html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${walkAwayMode.sounds.playAgain ? '#e9d8fd' : '#e2e8f0'}; border-radius: 8px;">
    <span> Play Again Sound:</span>
    ${walkAwayMode.sounds.playAgain ?
      `<audio controls src="${walkAwayMode.sounds.playAgain}" style="height: 30px;"></audio>
       <button onclick="removeWalkAwaySound('playAgain')" style="padding: 4px 10px; background: #9f7aea; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>` :
      '<span style="color: #a0aec0;">Not set</span>'}
  </div>`;

  html += '</div>';
  container.innerHTML = html;
}

/**
 * Handle Walk Away Mode sound upload
 */
async function handleWalkAwaySoundUpload(type) {
  const inputIdMap = {
    'wrong': 'walkAwayWrongSound',
    'timeup': 'walkAwayTimeUpSound',
    'correct': 'walkAwayCorrectSound',
    'playAgain': 'walkAwayPlayAgainSound'
  };
  const statusIdMap = {
    'wrong': 'walkAwayWrongStatus',
    'timeup': 'walkAwayTimeUpStatus',
    'correct': 'walkAwayCorrectStatus',
    'playAgain': 'walkAwayPlayAgainStatus'
  };
  const fieldNameMap = {
    'wrong': 'wrongSound',
    'timeup': 'timeupSound',
    'correct': 'correctSound',
    'playAgain': 'playAgainSound'
  };

  const inputId = inputIdMap[type];
  const statusId = statusIdMap[type];
  const fieldName = fieldNameMap[type];

  const input = document.getElementById(inputId);
  const statusEl = document.getElementById(statusId);

  if (!input || !input.files || !input.files[0]) return;

  const file = input.files[0];
  if (statusEl) statusEl.innerHTML = '<span style="color: #667eea;"> Uploading...</span>';

  try {
    const storageRef = storage.ref(`walkAwayMode/${type}_${Date.now()}_${file.name}`);
    const snapshot = await storageRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();

    await db.collection('settings').doc('walkAwayMode').set({
      [fieldName]: downloadURL
    }, { merge: true });

    walkAwayMode.sounds[type] = downloadURL;
    walkAwayMode.audioElements[type] = new Audio(downloadURL);

    if (statusEl) statusEl.innerHTML = '<span style="color: #48bb78;"> Uploaded successfully!</span>';

    updateWalkAwaySoundsDisplay();

  } catch (error) {
    if (statusEl) statusEl.innerHTML = `<span style="color: #f56565;"> Error: ${error.message}</span>`;
  }
}

/**
 * Remove a Walk Away Mode sound
 */
async function removeWalkAwaySound(type) {
  if (!confirm(`Remove the ${type} sound?`)) return;

  const fieldNameMap = {
    'wrong': 'wrongSound',
    'timeup': 'timeupSound',
    'correct': 'correctSound',
    'playAgain': 'playAgainSound'
  };
  const fieldName = fieldNameMap[type];

  try {
    await db.collection('settings').doc('walkAwayMode').update({
      [fieldName]: firebase.firestore.FieldValue.delete()
    });

    walkAwayMode.sounds[type] = null;
    walkAwayMode.audioElements[type] = null;

    updateWalkAwaySoundsDisplay();
    alert('Sound removed!');

  } catch (error) {
    alert('Error removing sound: ' + error.message);
  }
}

/**
 * Toggle Walk Away Mode
 */
function toggleWalkAwayMode() {
  walkAwayMode.enabled = !walkAwayMode.enabled;

  const btn = document.getElementById('walkAwayModeBtn');
  if (btn) {
    if (walkAwayMode.enabled) {
      btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)';
      btn.innerHTML = ' Walk Away Mode: ON';
    } else {
      btn.style.background = 'linear-gradient(135deg, #a0aec0 0%, #718096 100%)';
      btn.innerHTML = ' Walk Away Mode: OFF';
    }
  }

  const grammarBtn = document.getElementById('grammarWalkAwayModeBtn');
  if (grammarBtn) {
    if (walkAwayMode.enabled) {
      grammarBtn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)';
      grammarBtn.innerHTML = ' Walk Away Mode: ON';
    } else {
      grammarBtn.style.background = 'linear-gradient(135deg, #a0aec0 0%, #718096 100%)';
      grammarBtn.innerHTML = ' Walk Away Mode: OFF';
    }
  }

  updateFlashcardWalkAwayDisplay();

}

/**
 * Update flashcard game Walk Away Mode display
 */
function updateFlashcardWalkAwayDisplay() {
  const statusEl = document.getElementById('flashcardWalkAwayStatus');
  const descEl = document.getElementById('flashcardWalkAwayDescription');
  const toggleDiv = document.getElementById('flashcardWalkAwayToggle');

  if (statusEl) {
    statusEl.textContent = walkAwayMode.enabled ? 'ON' : 'OFF';
  }

  if (descEl) {
    if (walkAwayMode.enabled) {
      descEl.textContent = ' Hands-free mode active! Voice prompts will guide you between rounds.';
      descEl.style.color = '#276749';
    } else {
      descEl.textContent = 'Enable for hands-free practice with voice prompts';
      descEl.style.color = '#718096';
    }
  }

  if (toggleDiv) {
    if (walkAwayMode.enabled) {
      toggleDiv.style.background = 'linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%)';
      toggleDiv.style.borderColor = '#48bb78';
    } else {
      toggleDiv.style.background = 'linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%)';
      toggleDiv.style.borderColor = '#e2e8f0';
    }
  }
}

/**
 * Speak English text (for Walk Away Mode)
 */
function speakEnglish(text) {
  if (!('speechSynthesis' in window)) return;

  speechSynthesis.cancel();

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US';
  utterance.rate = 0.9;
  utterance.pitch = 1;

  const selectedVoiceName = localStorage.getItem('selectedEnglishVoice');
  if (selectedVoiceName) {
    const voices = speechSynthesis.getVoices();
    const selectedVoice = voices.find(v => v.name === selectedVoiceName);
    if (selectedVoice) {
      utterance.voice = selectedVoice;
    }
  }

  speechSynthesis.speak(utterance);
}

/**
 * Populate English voice selector dropdown
 */
function populateEnglishVoiceSelector() {
  const selector = document.getElementById('englishVoiceSelector');
  if (!selector) return;

  const voices = speechSynthesis.getVoices();

  const englishVoices = voices.filter(v =>
    v.lang.startsWith('en') || v.lang.startsWith('EN')
  );

  if (englishVoices.length === 0) {
    selector.innerHTML = '<option value="">No English voices found</option>';
    return;
  }

  englishVoices.sort((a, b) => {
    const aGoogle = a.name.toLowerCase().includes('google');
    const bGoogle = b.name.toLowerCase().includes('google');
    if (aGoogle && !bGoogle) return -1;
    if (!aGoogle && bGoogle) return 1;

    const aPremium = /premium|enhanced|natural|neural/i.test(a.name);
    const bPremium = /premium|enhanced|natural|neural/i.test(b.name);
    if (aPremium && !bPremium) return -1;
    if (!aPremium && bPremium) return 1;

    return a.name.localeCompare(b.name);
  });

  selector.innerHTML = englishVoices.map(voice => {
    const label = `${voice.name} (${voice.lang})`;
    return `<option value="${voice.name}">${label}</option>`;
  }).join('');

  const savedVoice = localStorage.getItem('selectedEnglishVoice');
  if (savedVoice) {
    selector.value = savedVoice;
  }
}

/**
 * Save selected English voice to localStorage
 */
function saveSelectedEnglishVoice() {
  const selector = document.getElementById('englishVoiceSelector');
  if (selector && selector.value) {
    localStorage.setItem('selectedEnglishVoice', selector.value);
  }
}

/**
 * Test the selected English voice
 */
function testEnglishVoice() {
  speakEnglish('Hello! This is how I will read the English words.');
}

if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = populateEnglishVoiceSelector;
  setTimeout(populateEnglishVoiceSelector, 100);
}


let universalGameAssets = {
  startImage: null,
  startSound: null,
  progressImage: null,
  progressSounds: [null, null, null, null],
  perfectImage: null,
  perfectSound: null,
  almostImage: null,
  almostSound: null,
  timeoutImage: null,
  timeoutSound: null,
  endGifs: [null, null, null, null, null, null],
  endSounds: [null, null, null, null, null, null]
};

/**
 * Handle universal asset upload
 */
async function handleUniversalAssetUpload(input, assetType) {
  if (!input.files || !input.files[0]) return;

  const file = input.files[0];
  const previewId = `universal${assetType.charAt(0).toUpperCase() + assetType.slice(1)}Preview`;
  const previewEl = document.getElementById(previewId);

  if (previewEl) {
    previewEl.innerHTML = '<span style="color: #667eea; font-size: 12px;"> Uploading...</span>';
  }

  try {
    const base64Data = await fileToBase64(file);

    let updateData = {};

    if (assetType.startsWith('progressSound')) {
      const index = parseInt(assetType.replace('progressSound', '')) - 1;
      const currentAssets = await db.collection('settings').doc('universalGameAssets').get();
      let progressSounds = currentAssets.exists && currentAssets.data().progressSounds ?
                          [...currentAssets.data().progressSounds] : [null, null, null, null];
      progressSounds[index] = base64Data;
      updateData = { progressSounds };
      universalGameAssets.progressSounds[index] = base64Data;
    } else if (assetType.startsWith('endGif')) {
      const index = parseInt(assetType.replace('endGif', '')) - 1;
      const currentAssets = await db.collection('settings').doc('universalGameAssets').get();
      let endGifs = currentAssets.exists && currentAssets.data().endGifs ?
                   [...currentAssets.data().endGifs] : [null, null, null, null, null, null];
      endGifs[index] = base64Data;
      updateData = { endGifs };
      universalGameAssets.endGifs[index] = base64Data;
    } else if (assetType.startsWith('endSound')) {
      const index = parseInt(assetType.replace('endSound', '')) - 1;
      const currentAssets = await db.collection('settings').doc('universalGameAssets').get();
      let endSounds = currentAssets.exists && currentAssets.data().endSounds ?
                     [...currentAssets.data().endSounds] : [null, null, null, null, null, null];
      endSounds[index] = base64Data;
      updateData = { endSounds };
      universalGameAssets.endSounds[index] = base64Data;
    } else {
      updateData = { [assetType]: base64Data };
      universalGameAssets[assetType] = base64Data;
    }

    await db.collection('settings').doc('universalGameAssets').set(updateData, { merge: true });

    if (previewEl) {
      if (file.type.startsWith('image/')) {
        previewEl.innerHTML = `<img src="${base64Data}" style="max-width: 80px; max-height: 60px; border-radius: 4px;">`;
      } else if (file.type.startsWith('audio/')) {
        previewEl.innerHTML = `<span style="color: #48bb78; font-size: 12px;"> ${file.name}</span>`;
      }
    }


  } catch (error) {
    if (previewEl) {
      previewEl.innerHTML = `<span style="color: #f56565; font-size: 12px;"> Error</span>`;
    }
  }
}

/**
 * Convert file to base64
 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/**
 * Load universal game assets from Firestore
 */
async function loadUniversalGameAssets() {
  try {
    const doc = await db.collection('settings').doc('universalGameAssets').get();

    if (doc.exists) {
      const data = doc.data();

      universalGameAssets.startImage = data.startImage || null;
      universalGameAssets.startSound = data.startSound || null;
      universalGameAssets.progressImage = data.progressImage || null;
      universalGameAssets.progressSounds = data.progressSounds || [null, null, null, null];
      universalGameAssets.perfectImage = data.perfectImage || null;
      universalGameAssets.perfectSound = data.perfectSound || null;
      universalGameAssets.almostImage = data.almostImage || null;
      universalGameAssets.almostSound = data.almostSound || null;
      universalGameAssets.timeoutImage = data.timeoutImage || null;
      universalGameAssets.timeoutSound = data.timeoutSound || null;
      universalGameAssets.endGifs = data.endGifs || [null, null, null, null, null, null];
      universalGameAssets.endSounds = data.endSounds || [null, null, null, null, null, null];

    }

    updateUniversalAssetsDisplay();

  } catch (error) {
  }
}

/**
 * Update the universal assets display in admin panel
 */
function updateUniversalAssetsDisplay() {
  const container = document.getElementById('universalAssetsList');
  if (!container) return;

  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';

  const assetLabels = {
    startImage: ' Start Image',
    startSound: ' Start Sound',
    progressImage: ' Progress Image',
    perfectImage: ' Perfect Image',
    perfectSound: ' Perfect Sound',
    almostImage: ' Almost Image',
    almostSound: ' Almost Sound',
    timeoutImage: ' Timeout Image',
    timeoutSound: ' Timeout Sound'
  };

  for (const [key, label] of Object.entries(assetLabels)) {
    const hasAsset = universalGameAssets[key];
    html += `
      <div style="background: ${hasAsset ? '#c6f6d5' : '#fed7d7'}; padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 12px; font-weight: bold;">${label}</div>
        <div style="font-size: 20px; margin: 5px 0;">${hasAsset ? '' : ''}</div>
        ${hasAsset && key.includes('Image') ? `<img src="${universalGameAssets[key]}" style="max-width: 60px; max-height: 40px; border-radius: 4px;">` : ''}
      </div>
    `;
  }

  for (let i = 0; i < 4; i++) {
    const hasSound = universalGameAssets.progressSounds[i];
    html += `
      <div style="background: ${hasSound ? '#c6f6d5' : '#fed7d7'}; padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 12px; font-weight: bold;"> Progress Sound ${i + 1}</div>
        <div style="font-size: 20px; margin: 5px 0;">${hasSound ? '' : ''}</div>
      </div>
    `;
  }

  const tierNames = ['50%', '65%', '75%', '85%', '99%', '100%'];
  for (let i = 0; i < 6; i++) {
    const hasGif = universalGameAssets.endGifs[i];
    const hasSound = universalGameAssets.endSounds[i];
    html += `
      <div style="background: ${hasGif || hasSound ? '#c6f6d5' : '#fed7d7'}; padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 12px; font-weight: bold;"> End ${tierNames[i]}</div>
        <div style="font-size: 14px; margin: 5px 0;">
          GIF: ${hasGif ? '' : ''} | Sound: ${hasSound ? '' : ''}
        </div>
        ${hasGif ? `<img src="${universalGameAssets.endGifs[i]}" style="max-width: 50px; max-height: 35px; border-radius: 4px;">` : ''}
      </div>
    `;
  }

  html += '</div>';
  container.innerHTML = html;
}

/**
 * Clear all universal assets
 */
async function clearAllUniversalAssets() {
  if (!confirm('Are you sure you want to clear ALL universal game assets? This cannot be undone.')) {
    return;
  }

  try {
    await db.collection('settings').doc('universalGameAssets').delete();

    universalGameAssets = {
      startImage: null,
      startSound: null,
      progressImage: null,
      progressSounds: [null, null, null, null],
      perfectImage: null,
      perfectSound: null,
      almostImage: null,
      almostSound: null,
      timeoutImage: null,
      timeoutSound: null,
      endGifs: [null, null, null, null, null, null],
      endSounds: [null, null, null, null, null, null]
    };

    updateUniversalAssetsDisplay();
    alert('All universal assets cleared!');

  } catch (error) {
    alert('Error clearing assets: ' + error.message);
  }
}

/**
 * Get effective game assets (universal as fallback if set doesn't have its own)
 */
function getEffectiveGameAssets(setAssets) {
  if (!setAssets) {
    return universalGameAssets;
  }

  return {
    startImage: setAssets.startImage || universalGameAssets.startImage,
    startSound: setAssets.startSound || universalGameAssets.startSound,
    progressImage: setAssets.progressImage || universalGameAssets.progressImage,
    progressSounds: setAssets.progressSounds && setAssets.progressSounds.some(s => s) ?
                    setAssets.progressSounds.map((s, i) => s || universalGameAssets.progressSounds[i]) :
                    universalGameAssets.progressSounds,
    perfectImage: setAssets.perfectImage || universalGameAssets.perfectImage,
    perfectSound: setAssets.perfectSound || universalGameAssets.perfectSound,
    almostImage: setAssets.almostImage || universalGameAssets.almostImage,
    almostSound: setAssets.almostSound || universalGameAssets.almostSound,
    timeoutImage: setAssets.timeoutImage || universalGameAssets.timeoutImage,
    timeoutSound: setAssets.timeoutSound || universalGameAssets.timeoutSound,
    endGifs: setAssets.endGifs && setAssets.endGifs.some(g => g) ?
             setAssets.endGifs.map((g, i) => g || universalGameAssets.endGifs[i]) :
             universalGameAssets.endGifs,
    endSounds: setAssets.endSounds && setAssets.endSounds.some(s => s) ?
               setAssets.endSounds.map((s, i) => s || universalGameAssets.endSounds[i]) :
               universalGameAssets.endSounds
  };
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if (db) {
      loadWalkAwaySounds();
      loadUniversalGameAssets();
    }
  }, 2000);
});


let currentGameData = null;
let currentGameQuestions = [];
let currentQuestionIndex = 0;
let gameScore = 0;
let gameTotalPossiblePoints = 0;
let gameStreak = 0;
let maxStreak = 0;
let gameTimerInterval = null;
let gameTimeRemaining = 0;
let isPaused = false;
let usedFiftyFifty = false;
let usedSkip = false;
let backgroundMusicAudio = null;
let tickSoundAudio = null;
let editingGameId = null;
let questionBank = [];
let isPreviewMode = false;

/**
 * Toggle reason input type (text vs image)
 */
function toggleReasonInput() {
  const reasonType = document.getElementById('newReasonType')?.value;
  const textInput = document.getElementById('reasonTextInput');
  const imageInput = document.getElementById('reasonImageInput');
  if (textInput) textInput.style.display = reasonType === 'text' ? 'block' : 'none';
  if (imageInput) imageInput.style.display = reasonType === 'image' ? 'block' : 'none';
}

/**
 * Add a question to the current game being created
 */
function addGameQuestion() {
  const questionText = document.getElementById('newQuestionText').value.trim();
  const answerA = document.getElementById('newAnswerA').value.trim();
  const answerB = document.getElementById('newAnswerB').value.trim();
  const answerC = document.getElementById('newAnswerC').value.trim();
  const answerD = document.getElementById('newAnswerD').value.trim();
  const correctAnswer = document.getElementById('newCorrectAnswer').value;
  const category = document.getElementById('newQuestionCategory').value.trim();
  const difficulty = document.getElementById('newQuestionDifficulty').value;
  const reasonType = document.getElementById('newReasonType').value;
  const reasonText = document.getElementById('newReasonText').value.trim();
  const reasonImage = document.getElementById('newReasonImage').value.trim();
  const reasonGif = document.getElementById('newReasonGif').value.trim();

  if (!questionText || !answerA || !answerB || !answerC || !answerD) {
    alert('Please fill in the question and all 4 answer options.');
    return;
  }

  const question = {
    id: Date.now(),
    question: questionText,
    answers: { A: answerA, B: answerB, C: answerC, D: answerD },
    correctAnswer: correctAnswer,
    category: category || 'General',
    difficulty: difficulty,
    reasonType: reasonType,
    reasonContent: reasonType === 'text' ? reasonText : reasonImage,
    reasonGif: reasonGif
  };

  currentGameQuestions.push(question);
  renderGameQuestionsList();
  clearQuestionForm();
}

/**
 * Clear the question form inputs
 */
function clearQuestionForm() {
  document.getElementById('newQuestionText').value = '';
  document.getElementById('newAnswerA').value = '';
  document.getElementById('newAnswerB').value = '';
  document.getElementById('newAnswerC').value = '';
  document.getElementById('newAnswerD').value = '';
  document.getElementById('newCorrectAnswer').value = 'A';
  document.getElementById('newQuestionCategory').value = '';
  document.getElementById('newQuestionDifficulty').value = 'easy';
  document.getElementById('newReasonType').value = 'text';
  document.getElementById('newReasonText').value = '';
  document.getElementById('newReasonImage').value = '';
  document.getElementById('newReasonGif').value = '';
  toggleReasonInput();
}

/**
 * Render the list of questions added to the current game
 */
function renderGameQuestionsList() {
  const container = document.getElementById('gameQuestionsList');
  if (!container) return;

  if (currentGameQuestions.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 30px; color: #a0aec0;"><p>No questions added yet. Add your first question below!</p></div>';
    return;
  }

  const difficultyColors = { easy: '#48bb78', medium: '#ed8936', hard: '#e53e3e' };
  const difficultyPoints = { easy: '1x', medium: '2x', hard: '3x' };

  container.innerHTML = currentGameQuestions.map((q, index) => `
    <div class="question-card">
      <div class="question-card-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span class="question-number">Q${index + 1}</span>
          <span style="background: rgba(0, 217, 255, 0.2); color: #00d9ff; padding: 3px 10px; border-radius: 10px; font-size: 11px;">${q.category}</span>
          <span style="background: ${difficultyColors[q.difficulty]}33; color: ${difficultyColors[q.difficulty]}; padding: 3px 10px; border-radius: 10px; font-size: 11px;">${q.difficulty.toUpperCase()} (${difficultyPoints[q.difficulty]})</span>
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="editGameQuestion(${index})" style="background: #3182ce; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;"> Edit</button>
          <button onclick="deleteGameQuestion(${index})" style="background: #e53e3e; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;"></button>
          ${index > 0 ? `<button onclick="moveQuestionUp(${index})" style="background: #718096; color: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 12px;"></button>` : ''}
          ${index < currentGameQuestions.length - 1 ? `<button onclick="moveQuestionDown(${index})" style="background: #718096; color: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 12px;"></button>` : ''}
        </div>
      </div>
      <p style="color: white; font-size: 16px; margin-bottom: 15px;">${q.question}</p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        ${['A', 'B', 'C', 'D'].map(letter => `
          <div class="answer-option-create ${q.correctAnswer === letter ? 'correct' : ''}" onclick="setCorrectAnswer(${index}, '${letter}')">
            <span class="answer-marker">${letter}</span>
            <span style="color: white; flex: 1;">${q.answers[letter]}</span>
            ${q.correctAnswer === letter ? '<span style="color: #48bb78;"></span>' : ''}
          </div>
        `).join('')}
      </div>
      ${q.reasonContent ? `
        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <p style="color: #a0aec0; font-size: 12px; margin-bottom: 5px;"> Reason:</p>
          ${q.reasonType === 'text' ? `<p style="color: white; font-size: 14px;">${q.reasonContent}</p>` : `<img src="${q.reasonContent}" style="max-height: 100px; border-radius: 8px;">`}
        </div>
      ` : ''}
    </div>
  `).join('');
}

/**
 * Set the correct answer for a question
 */
function setCorrectAnswer(questionIndex, letter) {
  currentGameQuestions[questionIndex].correctAnswer = letter;
  renderGameQuestionsList();
}

/**
 * Delete a question from the game
 */
function deleteGameQuestion(index) {
  if (confirm('Delete this question?')) {
    currentGameQuestions.splice(index, 1);
    renderGameQuestionsList();
  }
}

/**
 * Move question up
 */
function moveQuestionUp(index) {
  if (index > 0) {
    [currentGameQuestions[index], currentGameQuestions[index - 1]] = [currentGameQuestions[index - 1], currentGameQuestions[index]];
    renderGameQuestionsList();
  }
}

/**
 * Move question down
 */
function moveQuestionDown(index) {
  if (index < currentGameQuestions.length - 1) {
    [currentGameQuestions[index], currentGameQuestions[index + 1]] = [currentGameQuestions[index + 1], currentGameQuestions[index]];
    renderGameQuestionsList();
  }
}

/**
 * Edit a game question
 */
function editGameQuestion(index) {
  const q = currentGameQuestions[index];
  document.getElementById('newQuestionText').value = q.question;
  document.getElementById('newAnswerA').value = q.answers.A;
  document.getElementById('newAnswerB').value = q.answers.B;
  document.getElementById('newAnswerC').value = q.answers.C;
  document.getElementById('newAnswerD').value = q.answers.D;
  document.getElementById('newCorrectAnswer').value = q.correctAnswer;
  document.getElementById('newQuestionCategory').value = q.category;
  document.getElementById('newQuestionDifficulty').value = q.difficulty;
  document.getElementById('newReasonType').value = q.reasonType;
  if (q.reasonType === 'text') {
    document.getElementById('newReasonText').value = q.reasonContent || '';
  } else {
    document.getElementById('newReasonImage').value = q.reasonContent || '';
  }
  document.getElementById('newReasonGif').value = q.reasonGif || '';
  toggleReasonInput();
  currentGameQuestions.splice(index, 1);
  renderGameQuestionsList();
  document.getElementById('newQuestionText').scrollIntoView({ behavior: 'smooth' });
}

/**
 * Save the game to Firestore
 */
async function saveGame() {
  const title = document.getElementById('gameTitle').value.trim();
  const timer = parseInt(document.getElementById('gameTimer').value) || 0;
  const randomize = document.getElementById('gameRandomize').value === 'true';

  if (!title) { alert('Please enter a game title.'); return; }
  if (currentGameQuestions.length === 0) { alert('Please add at least one question.'); return; }

  const gameData = {
    title: title,
    timer: timer,
    randomize: randomize,
    questions: currentGameQuestions,
    assets: {
      startImage: document.getElementById('gameStartImage').value.trim(),
      startAudio: document.getElementById('gameStartAudio').value.trim(),
      correctImage: document.getElementById('gameCorrectImage').value.trim(),
      correctAudio: document.getElementById('gameCorrectAudio').value.trim(),
      wrongImage: document.getElementById('gameWrongImage').value.trim(),
      wrongAudio: document.getElementById('gameWrongAudio').value.trim(),
      backgroundMusic: document.getElementById('gameBackgroundMusic').value.trim(),
      tickSound: document.getElementById('gameTickSound').value.trim()
    },
    scoreTiers: {
      tier1: { gif: document.getElementById('gameTier1Gif').value.trim(), audio: document.getElementById('gameTier1Audio').value.trim() },
      tier2: { gif: document.getElementById('gameTier2Gif').value.trim(), audio: document.getElementById('gameTier2Audio').value.trim() },
      tier3: { gif: document.getElementById('gameTier3Gif').value.trim(), audio: document.getElementById('gameTier3Audio').value.trim() },
      tier4: { gif: document.getElementById('gameTier4Gif').value.trim(), audio: document.getElementById('gameTier4Audio').value.trim() },
      tier5: { gif: document.getElementById('gameTier5Gif').value.trim(), audio: document.getElementById('gameTier5Audio').value.trim() }
    },
    teacherId: currentUser.uid,
    teacherEmail: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    playCount: 0
  };

  try {
    if (editingGameId) {
      delete gameData.createdAt;
      await db.collection('teacherGames').doc(editingGameId).update(gameData);
      alert('Game updated!');
      editingGameId = null;
    } else {
      await db.collection('teacherGames').add(gameData);
      alert('Game saved!');
    }
    clearGameForm();
    loadTeacherGames();
    switchTab('manageGames');
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Clear game form
 */
function clearGameForm() {
  document.getElementById('gameTitle').value = '';
  document.getElementById('gameTimer').value = '0';
  document.getElementById('gameRandomize').value = 'true';
  ['gameStartImage','gameStartAudio','gameCorrectImage','gameCorrectAudio','gameWrongImage','gameWrongAudio','gameBackgroundMusic','gameTickSound',
   'gameTier1Gif','gameTier1Audio','gameTier2Gif','gameTier2Audio','gameTier3Gif','gameTier3Audio','gameTier4Gif','gameTier4Audio','gameTier5Gif','gameTier5Audio'
  ].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ''; });
  currentGameQuestions = [];
  editingGameId = null;
  renderGameQuestionsList();
}

/**
 * Load teacher's games
 */
async function loadTeacherGames() {
  const container = document.getElementById('teacherGamesList');
  if (!container) return;
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="spinner"></span> Loading...</div>';

  try {
    const snapshot = await db.collection('teacherGames').where('teacherId', '==', currentUser.uid).get();

    if (snapshot.empty) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px; border: 2px dashed #0f3460;">
          <p style="font-size: 48px; margin-bottom: 20px;"></p>
          <h3 style="color: white; margin-bottom: 10px;">No Games Yet</h3>
          <p style="color: #a0aec0; margin-bottom: 20px;">Create your first space quiz game!</p>
          <button class="btn" onclick="switchTab('createGame')" style="background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); color: #1a1a2e;"> Create Game</button>
        </div>`;
      return;
    }

    let games = [];
    snapshot.forEach(doc => {
      games.push({ id: doc.id, ...doc.data() });
    });
    games.sort((a, b) => {
      const aTime = a.createdAt?.toMillis?.() || 0;
      const bTime = b.createdAt?.toMillis?.() || 0;
      return bTime - aTime; // Descending order
    });

    let html = '';
    games.forEach(game => {
      const qCount = game.questions ? game.questions.length : 0;
      html += `
        <div class="game-list-card">
          <div style="flex: 1;">
            <h4 style="color: white; margin-bottom: 5px;">${game.title}</h4>
            <div class="game-stats">
              <span class="game-stat"> ${qCount} Questions</span>
              <span class="game-stat"> ${game.timer > 0 ? game.timer + 's' : 'No Timer'}</span>
              <span class="game-stat"> Played ${game.playCount || 0}x</span>
            </div>
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="playGame('${game.id}')" class="btn" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 10px 20px;"> Play</button>
            <button onclick="previewGameById('${game.id}')" class="btn btn-secondary" style="padding: 10px 20px;"> Preview</button>
            <button onclick="editGame('${game.id}')" class="btn" style="background: #3182ce; padding: 10px 20px;"> Edit</button>
            <button onclick="duplicateGame('${game.id}')" class="btn" style="background: #9f7aea; padding: 10px 20px;"> Copy</button>
            <button onclick="deleteGame('${game.id}')" class="btn" style="background: #e53e3e; padding: 10px 20px;"></button>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = `<div style="color: #e53e3e; padding: 20px;">Error: ${error.message}</div>`;
  }
}

/**
 * Edit game
 */
async function editGame(gameId) {
  try {
    const doc = await db.collection('teacherGames').doc(gameId).get();
    if (!doc.exists) { alert('Game not found'); return; }
    const game = doc.data();
    editingGameId = gameId;

    document.getElementById('gameTitle').value = game.title || '';
    document.getElementById('gameTimer').value = game.timer || 0;
    document.getElementById('gameRandomize').value = game.randomize ? 'true' : 'false';
    document.getElementById('gameStartImage').value = game.assets?.startImage || '';
    document.getElementById('gameStartAudio').value = game.assets?.startAudio || '';
    document.getElementById('gameCorrectImage').value = game.assets?.correctImage || '';
    document.getElementById('gameCorrectAudio').value = game.assets?.correctAudio || '';
    document.getElementById('gameWrongImage').value = game.assets?.wrongImage || '';
    document.getElementById('gameWrongAudio').value = game.assets?.wrongAudio || '';
    document.getElementById('gameBackgroundMusic').value = game.assets?.backgroundMusic || '';
    document.getElementById('gameTickSound').value = game.assets?.tickSound || '';
    document.getElementById('gameTier1Gif').value = game.scoreTiers?.tier1?.gif || '';
    document.getElementById('gameTier1Audio').value = game.scoreTiers?.tier1?.audio || '';
    document.getElementById('gameTier2Gif').value = game.scoreTiers?.tier2?.gif || '';
    document.getElementById('gameTier2Audio').value = game.scoreTiers?.tier2?.audio || '';
    document.getElementById('gameTier3Gif').value = game.scoreTiers?.tier3?.gif || '';
    document.getElementById('gameTier3Audio').value = game.scoreTiers?.tier3?.audio || '';
    document.getElementById('gameTier4Gif').value = game.scoreTiers?.tier4?.gif || '';
    document.getElementById('gameTier4Audio').value = game.scoreTiers?.tier4?.audio || '';
    document.getElementById('gameTier5Gif').value = game.scoreTiers?.tier5?.gif || '';
    document.getElementById('gameTier5Audio').value = game.scoreTiers?.tier5?.audio || '';

    currentGameQuestions = game.questions || [];
    renderGameQuestionsList();
    switchTab('createGame');
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Duplicate game
 */
async function duplicateGame(gameId) {
  try {
    const doc = await db.collection('teacherGames').doc(gameId).get();
    if (!doc.exists) { alert('Game not found'); return; }
    const game = doc.data();
    await db.collection('teacherGames').add({
      ...game,
      title: game.title + ' (Copy)',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      playCount: 0
    });
    alert('Game duplicated!');
    loadTeacherGames();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Delete game
 */
async function deleteGame(gameId) {
  if (!confirm('Delete this game?')) return;
  try {
    await db.collection('teacherGames').doc(gameId).delete();
    alert('Deleted!');
    loadTeacherGames();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Shuffle array
 */
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/**
 * Play game
 */
async function playGame(gameId) {
  try {
    const doc = await db.collection('teacherGames').doc(gameId).get();
    if (!doc.exists) { alert('Game not found'); return; }
    currentGameData = { id: doc.id, ...doc.data() };
    await db.collection('teacherGames').doc(gameId).update({ playCount: firebase.firestore.FieldValue.increment(1) });
    isPreviewMode = false;
    startGamePresentation();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Preview game from form
 */
function previewGame() {
  const title = document.getElementById('gameTitle').value.trim();
  if (!title) { alert('Enter a game title to preview.'); return; }
  if (currentGameQuestions.length === 0) { alert('Add at least one question.'); return; }

  currentGameData = {
    title: title,
    timer: parseInt(document.getElementById('gameTimer').value) || 0,
    randomize: document.getElementById('gameRandomize').value === 'true',
    questions: currentGameQuestions,
    assets: {
      startImage: document.getElementById('gameStartImage').value.trim(),
      startAudio: document.getElementById('gameStartAudio').value.trim(),
      correctImage: document.getElementById('gameCorrectImage').value.trim(),
      correctAudio: document.getElementById('gameCorrectAudio').value.trim(),
      wrongImage: document.getElementById('gameWrongImage').value.trim(),
      wrongAudio: document.getElementById('gameWrongAudio').value.trim(),
      backgroundMusic: document.getElementById('gameBackgroundMusic').value.trim(),
      tickSound: document.getElementById('gameTickSound').value.trim()
    },
    scoreTiers: {
      tier1: { gif: document.getElementById('gameTier1Gif').value.trim(), audio: document.getElementById('gameTier1Audio').value.trim() },
      tier2: { gif: document.getElementById('gameTier2Gif').value.trim(), audio: document.getElementById('gameTier2Audio').value.trim() },
      tier3: { gif: document.getElementById('gameTier3Gif').value.trim(), audio: document.getElementById('gameTier3Audio').value.trim() },
      tier4: { gif: document.getElementById('gameTier4Gif').value.trim(), audio: document.getElementById('gameTier4Audio').value.trim() },
      tier5: { gif: document.getElementById('gameTier5Gif').value.trim(), audio: document.getElementById('gameTier5Audio').value.trim() }
    }
  };
  isPreviewMode = true;
  startGamePresentation();
}

/**
 * Preview game by ID
 */
async function previewGameById(gameId) {
  try {
    const doc = await db.collection('teacherGames').doc(gameId).get();
    if (!doc.exists) { alert('Game not found'); return; }
    currentGameData = { id: doc.id, ...doc.data() };
    isPreviewMode = true;
    startGamePresentation();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Start fullscreen game presentation
 */
function startGamePresentation() {
  currentQuestionIndex = 0;
  gameScore = 0;
  gameTotalPossiblePoints = 0;
  gameStreak = 0;
  maxStreak = 0;
  isPaused = false;
  usedFiftyFifty = false;
  usedSkip = false;

  const diffPoints = { easy: 1, medium: 2, hard: 3 };
  currentGameData.questions.forEach(q => {
    gameTotalPossiblePoints += diffPoints[q.difficulty] || 1;
  });

  let questions = [...currentGameData.questions];
  if (currentGameData.randomize) questions = shuffleArray(questions);
  currentGameData.preparedQuestions = questions;

  const existing = document.getElementById('gameFullscreenContainer');
  if (existing) existing.remove();

  const container = document.createElement('div');
  container.id = 'gameFullscreenContainer';
  container.className = 'game-fullscreen';
  container.innerHTML = createGameHTML();
  document.body.appendChild(container);

  initPresentationTools();

  generateStars();
  showStartScreen();

  if (currentGameData.assets?.startAudio) {
    playGameAudio(currentGameData.assets.startAudio);
  }

  try { container.requestFullscreen?.(); } catch(e) {}
}

/**
 * Create game HTML
 */
function createGameHTML() {
  const totalQ = currentGameData.preparedQuestions.length;
  return `
    <!-- Teacher Presentation Tools -->
    <div id="teacherToolsBar" class="teacher-tools-bar">
      <span style="color: #a0aec0; font-size: 12px; margin-right: 5px;"> Fingers: Zoom/Pan</span>
      <span style="color: #a0aec0; font-size: 12px; margin-right: 10px;"> Pen: Draw</span>
      <button class="teacher-tool-btn" onclick="clearGameDrawing()" title="Clear drawings" style="background: #f56565;">
         Clear
      </button>
      <button class="teacher-tool-btn" onclick="undoGameDrawing()" title="Undo last drawing" style="background: #718096;">
         Undo
      </button>
      <button class="teacher-tool-btn" onclick="resetGameTools()" title="Reset zoom & clear" style="background: #4a5568;">
         Reset
      </button>
    </div>

    <!-- Zoom Indicator -->
    <div id="gameZoomIndicator" class="zoom-indicator visible">100%</div>

    <!-- Drawing Canvas Overlay - Pen only, doesn't block touch -->
    <div id="gameDrawingOverlay">
      <canvas id="gameDrawingCanvas"></canvas>
    </div>

    <!-- Color picker (smaller, top-left) -->
    <div id="gameColorPicker" class="color-picker-mini">
      <button class="color-dot selected" style="background: #f56565;" onclick="setGameDrawColor('#f56565', this)"></button>
      <button class="color-dot" style="background: #48bb78;" onclick="setGameDrawColor('#48bb78', this)"></button>
      <button class="color-dot" style="background: #4299e1;" onclick="setGameDrawColor('#4299e1', this)"></button>
      <button class="color-dot" style="background: #ecc94b;" onclick="setGameDrawColor('#ecc94b', this)"></button>
      <button class="color-dot" style="background: #ffffff;" onclick="setGameDrawColor('#ffffff', this)"></button>
    </div>

    <div class="game-zoom-wrapper" id="gameZoomWrapper">
    <div class="stars-container" id="starsContainer"></div>
    <div class="planet planet-1"></div>
    <div class="planet planet-2"></div>
    <div class="planet planet-3"></div>

    <div class="game-header">
      <div class="game-title-display"> ${currentGameData.title}${isPreviewMode ? ' (Preview)' : ''}</div>
      <div class="game-controls">
        <div class="score-display" id="scoreDisplay">Score: 0</div>
        <button class="game-control-btn" onclick="toggleGamePause()"> Pause</button>
        <button class="game-control-btn" id="musicToggleBtn" onclick="toggleBgMusic()"> Music</button>
        <button class="game-control-btn" onclick="restartQuizGame()"> Restart</button>
        <button class="game-control-btn exit-btn" onclick="exitGame()"> Exit</button>
      </div>
    </div>

    <div class="game-progress-container">
      <div class="game-progress-bar"><div class="game-progress-fill" id="progressFill" style="width: 0%"></div></div>
      <div class="game-progress-text" id="progressText">Question 1 of ${totalQ}</div>
    </div>

    ${currentGameData.timer > 0 ? '<div class="timer-container"><div class="timer-display" id="timerDisplay">' + currentGameData.timer + '</div></div>' : ''}

    <div class="streak-display" id="streakDisplay" style="display: none;">
      <div class="streak-flames"></div>
      <div class="streak-count" id="streakCount">0 in a row!</div>
    </div>

    <div class="game-question-container" id="gameQuestionContainer"></div>

    <div class="lifelines-container" id="lifelinesContainer" style="display: none;">
      <button class="lifeline-btn" id="fiftyFiftyBtn" onclick="useFiftyFiftyLifeline()"> 50/50</button>
      <button class="lifeline-btn" id="skipBtn" onclick="useSkipLifeline()"> Skip</button>
    </div>

    <div class="game-paused-overlay" id="pausedOverlay" style="display: none;">
      <div class="paused-text"> PAUSED</div>
      <button class="game-control-btn" onclick="toggleGamePause()" style="font-size: 20px; padding: 15px 40px;"> Resume</button>
    </div>
    </div><!-- End game-zoom-wrapper -->
  `;
}

/**
 * Generate stars
 */
function generateStars() {
  const container = document.getElementById('starsContainer');
  if (!container) return;
  for (let i = 0; i < 100; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    const size = Math.random() * 3 + 1;
    star.style.width = size + 'px';
    star.style.height = size + 'px';
    star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
    container.appendChild(star);
  }
}

/**
 * Show start screen
 */
function showStartScreen() {
  const container = document.getElementById('gameQuestionContainer');
  container.innerHTML = `
    <div class="game-start-screen">
      <div class="game-start-title"> ${currentGameData.title}</div>
      ${currentGameData.assets?.startImage ? `<img src="${currentGameData.assets.startImage}" class="game-start-image" onerror="this.style.display='none'">` : ''}
      <p style="color: #a0aec0; margin-bottom: 30px; font-size: 18px;">${currentGameData.preparedQuestions.length} Questions${currentGameData.timer > 0 ? '  ' + currentGameData.timer + 's per question' : ''}</p>
      <button class="game-start-btn" onclick="beginGame()"> START GAME</button>
    </div>
  `;
}

/**
 * Begin game
 */
function beginGame() {
  document.getElementById('lifelinesContainer').style.display = 'flex';
  if (currentGameData.assets?.backgroundMusic) {
    startBgMusic(currentGameData.assets.backgroundMusic);
  }
  showQuestion();
}

/**
 * Show question
 */
function showQuestion() {
  if (currentQuestionIndex >= currentGameData.preparedQuestions.length) {
    endGame();
    return;
  }

  const q = currentGameData.preparedQuestions[currentQuestionIndex];
  const container = document.getElementById('gameQuestionContainer');
  const totalQ = currentGameData.preparedQuestions.length;

  document.getElementById('progressFill').style.width = ((currentQuestionIndex / totalQ) * 100) + '%';
  document.getElementById('progressText').textContent = `Question ${currentQuestionIndex + 1} of ${totalQ}`;

  let answerOrder = ['A', 'B', 'C', 'D'];
  if (currentGameData.randomize) answerOrder = shuffleArray(answerOrder);
  q.displayOrder = answerOrder;

  const diffPoints = { easy: 1, medium: 2, hard: 3 };
  const points = diffPoints[q.difficulty] || 1;

  container.innerHTML = `
    <div class="game-question-text">${q.question}</div>
    <div style="color: #a0aec0; margin-bottom: 20px; font-size: 14px;">${q.category}  ${q.difficulty.toUpperCase()} (${points}x points)</div>
    <div class="game-answers-grid" id="answersGrid">
      ${answerOrder.map((letter, idx) => `
        <button class="game-answer-btn" id="answerBtn${letter}" onclick="selectAnswer('${letter}')" data-letter="${letter}">
          <span class="answer-letter">${['A','B','C','D'][idx]}</span>
          <span>${q.answers[letter]}</span>
        </button>
      `).join('')}
    </div>
  `;

  applyGameFontSize();

  if (currentGameData.timer > 0) {
    gameTimeRemaining = currentGameData.timer;
    updateTimerDisplay();
    startTimer();
  }

  if (gameStreak >= 2) {
    document.getElementById('streakDisplay').style.display = 'block';
    document.getElementById('streakCount').textContent = gameStreak + ' in a row!';
  } else {
    document.getElementById('streakDisplay').style.display = 'none';
  }
}

/**
 * Start timer
 */
function startTimer() {
  clearInterval(gameTimerInterval);
  gameTimerInterval = setInterval(() => {
    if (isPaused) return;
    gameTimeRemaining--;
    updateTimerDisplay();

    if (gameTimeRemaining <= 5 && gameTimeRemaining > 0 && currentGameData.assets?.tickSound) {
      playGameAudio(currentGameData.assets.tickSound);
    }

    if (gameTimeRemaining <= 0) {
      clearInterval(gameTimerInterval);
      timeUp();
    }
  }, 1000);
}

/**
 * Update timer display
 */
function updateTimerDisplay() {
  const display = document.getElementById('timerDisplay');
  if (!display) return;
  display.textContent = gameTimeRemaining;
  display.className = 'timer-display';
  if (gameTimeRemaining <= 5) display.classList.add('danger');
  else if (gameTimeRemaining <= 10) display.classList.add('warning');
}

/**
 * Time up
 */
function timeUp() {
  gameStreak = 0;
  showFeedback(false, null);
}

/**
 * Select answer
 */
function selectAnswer(letter) {
  clearInterval(gameTimerInterval);
  const q = currentGameData.preparedQuestions[currentQuestionIndex];
  const isCorrect = letter === q.correctAnswer;

  document.querySelectorAll('.game-answer-btn').forEach(btn => btn.disabled = true);

  document.querySelectorAll('.game-answer-btn').forEach(btn => {
    const btnLetter = btn.dataset.letter;
    if (btnLetter === q.correctAnswer) {
      btn.classList.add('correct-reveal');
    } else if (btnLetter === letter && !isCorrect) {
      btn.classList.add('wrong-reveal');
    }
  });

  if (isCorrect) {
    const diffPoints = { easy: 1, medium: 2, hard: 3 };
    gameScore += diffPoints[q.difficulty] || 1;
    gameStreak++;
    if (gameStreak > maxStreak) maxStreak = gameStreak;
    document.getElementById('scoreDisplay').textContent = 'Score: ' + gameScore;
  } else {
    gameStreak = 0;
  }

  setTimeout(() => showFeedback(isCorrect, q), 800);
}

/**
 * Show feedback
 */
function showFeedback(isCorrect, question) {
  const container = document.getElementById('gameQuestionContainer');
  const q = question || currentGameData.preparedQuestions[currentQuestionIndex];

  if (isCorrect && currentGameData.assets?.correctAudio) {
    playGameAudio(currentGameData.assets.correctAudio);
  } else if (!isCorrect && currentGameData.assets?.wrongAudio) {
    playGameAudio(currentGameData.assets.wrongAudio);
  }

  const feedbackImage = isCorrect ? currentGameData.assets?.correctImage : currentGameData.assets?.wrongImage;

  container.innerHTML = `
    <div class="game-feedback-overlay" style="position: relative; background: transparent;">
      ${feedbackImage ? `<img src="${feedbackImage}" class="feedback-image" onerror="this.style.display='none'">` : ''}
      <div class="feedback-text ${isCorrect ? 'correct' : 'wrong'}">${isCorrect ? ' CORRECT!' : ' WRONG!'}</div>
      ${!isCorrect ? `<p style="color: #a0aec0; font-size: 18px; margin-bottom: 20px;">The correct answer was: ${q.correctAnswer}</p>` : ''}

      ${q.reasonContent || q.reasonGif ? `
        <div class="reason-container">
          <div class="reason-title"> Explanation</div>
          ${q.reasonType === 'text' ? `<div class="reason-content">${q.reasonContent}</div>` :
            q.reasonContent ? `<img src="${q.reasonContent}" class="reason-image" onerror="this.style.display='none'">` : ''}
          ${q.reasonGif ? `<img src="${q.reasonGif}" class="reason-gif" onerror="this.style.display='none'">` : ''}
        </div>
      ` : ''}

      <button class="next-question-btn" onclick="nextQuestion()">
        ${currentQuestionIndex < currentGameData.preparedQuestions.length - 1 ? ' Next Question' : ' See Results'}
      </button>
    </div>
  `;

  if (isCorrect) createConfetti();
}

/**
 * Next question
 */
function nextQuestion() {
  currentQuestionIndex++;
  showQuestion();
}

/**
 * Create confetti
 */
function createConfetti() {
  const colors = ['#00d9ff', '#48bb78', '#f6e05e', '#ed64a6', '#9f7aea'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    document.getElementById('gameFullscreenContainer').appendChild(confetti);
    setTimeout(() => confetti.remove(), 4000);
  }
}

/**
 * End game
 */
function endGame() {
  clearInterval(gameTimerInterval);
  stopBgMusic();

  const percentage = gameTotalPossiblePoints > 0 ? Math.round((gameScore / gameTotalPossiblePoints) * 100) : 0;

  let tier, tierData;
  if (percentage <= 50) { tier = 'tier1'; tierData = currentGameData.scoreTiers?.tier1; }
  else if (percentage <= 74) { tier = 'tier2'; tierData = currentGameData.scoreTiers?.tier2; }
  else if (percentage <= 84) { tier = 'tier3'; tierData = currentGameData.scoreTiers?.tier3; }
  else if (percentage <= 94) { tier = 'tier4'; tierData = currentGameData.scoreTiers?.tier4; }
  else { tier = 'tier5'; tierData = currentGameData.scoreTiers?.tier5; }

  if (tierData?.audio) playGameAudio(tierData.audio);

  const container = document.getElementById('gameQuestionContainer');
  document.getElementById('lifelinesContainer').style.display = 'none';
  document.getElementById('progressFill').style.width = '100%';

  let message = '';
  if (percentage >= 95) message = ' AMAZING! Perfect or near-perfect!';
  else if (percentage >= 85) message = ' GREAT JOB! Almost there!';
  else if (percentage >= 75) message = ' GOOD WORK! Keep practicing!';
  else if (percentage >= 51) message = ' NOT BAD! Room to improve!';
  else message = ' Keep studying! You\'ll get better!';

  container.innerHTML = `
    <div class="game-end-screen">
      <div class="end-screen-title"> GAME COMPLETE!</div>
      <div class="end-screen-score">${gameScore} / ${gameTotalPossiblePoints}</div>
      <div class="end-screen-percentage">${percentage}%</div>
      <p style="color: white; font-size: 20px; margin-bottom: 20px;">${message}</p>
      <p style="color: #a0aec0; margin-bottom: 20px;">Max Streak: ${maxStreak} </p>
      ${tierData?.gif ? `<img src="${tierData.gif}" class="end-screen-gif" onerror="this.style.display='none'">` : ''}
      <div class="end-screen-buttons">
        <button class="game-control-btn" onclick="restartQuizGame()" style="font-size: 18px; padding: 15px 30px;"> Play Again</button>
        <button class="game-control-btn exit-btn" onclick="exitGame()" style="font-size: 18px; padding: 15px 30px;"> Exit</button>
      </div>
    </div>
  `;

  if (percentage >= 75) createConfetti();
}

/**
 * 50/50 Lifeline
 */
function useFiftyFiftyLifeline() {
  if (usedFiftyFifty) return;
  usedFiftyFifty = true;
  document.getElementById('fiftyFiftyBtn').disabled = true;

  const q = currentGameData.preparedQuestions[currentQuestionIndex];
  const wrongAnswers = ['A', 'B', 'C', 'D'].filter(l => l !== q.correctAnswer);
  const toRemove = shuffleArray(wrongAnswers).slice(0, 2);

  toRemove.forEach(letter => {
    const btn = document.getElementById('answerBtn' + letter);
    if (btn) {
      btn.style.opacity = '0.3';
      btn.disabled = true;
    }
  });
}

/**
 * Skip Lifeline
 */
function useSkipLifeline() {
  if (usedSkip) return;
  usedSkip = true;
  document.getElementById('skipBtn').disabled = true;
  clearInterval(gameTimerInterval);
  currentQuestionIndex++;
  showQuestion();
}

/**
 * Toggle pause
 */
function toggleGamePause() {
  isPaused = !isPaused;
  document.getElementById('pausedOverlay').style.display = isPaused ? 'flex' : 'none';
}

/**
 * Restart game
 */
function restartQuizGame() {
  resetGameTools(); // Reset teacher tools
  exitGame();
  setTimeout(() => {
    if (currentGameData.id) {
      playGame(currentGameData.id);
    } else {
      startGamePresentation();
    }
  }, 100);
}

/**
 * Exit game
 */
function exitGame() {
  resetGameTools(); // Reset teacher tools
  clearInterval(gameTimerInterval);
  stopBgMusic();
  const container = document.getElementById('gameFullscreenContainer');
  if (container) container.remove();
  if (document.fullscreenElement) document.exitFullscreen?.();
}


let gameZoomLevel = 1;
let gameDrawContext = null;
let gameIsDrawing = false;
let gameLastX = 0;
let gameLastY = 0;
let gameDrawColor = '#f56565';
let gameDrawSize = 8;
let gameDrawHistory = [];

let gameIsPanning = false;
let gamePanStartX = 0;
let gamePanStartY = 0;
let gameTranslateX = 0;
let gameTranslateY = 0;
let initialTranslateX = 0;
let initialTranslateY = 0;

/**
 * Initialize all presentation tools (called when game starts)
 */
function initPresentationTools() {
  initGameDrawCanvas();
  setupZoomPanGestures();
  setupPenDrawing();
  updateGameZoomIndicator();

  applyGameFontSize();
}

/**
 * Initialize drawing canvas
 */
function initGameDrawCanvas() {
  const canvas = document.getElementById('gameDrawingCanvas');
  if (!canvas) return;

  const dpr = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';

  gameDrawContext = canvas.getContext('2d');
  gameDrawContext.scale(dpr, dpr);
  gameDrawContext.lineCap = 'round';
  gameDrawContext.lineJoin = 'round';
}

/**
 * Setup pen drawing - listen on the fullscreen container
 */
function setupPenDrawing() {
  const container = document.getElementById('gameFullscreenContainer');
  if (!container) return;

  let isErasing = false;

  container.addEventListener('pointerdown', function(e) {
    if (e.pointerType === 'pen') {
      e.preventDefault();
      e.stopPropagation();
      gameIsDrawing = true;
      gameLastX = e.clientX;
      gameLastY = e.clientY;

      isErasing = (e.button === 5) || (e.button === 2) || (e.buttons === 2) || (e.buttons === 6) || ((e.buttons & 2) === 2) || ((e.buttons & 32) === 32);

      if (!isErasing) {
        saveGameDrawState();
      }

      if (gameDrawContext) {
        if (isErasing) {
          eraseAt(e.clientX, e.clientY);
        } else {
          gameDrawContext.globalCompositeOperation = 'source-over';
          gameDrawContext.strokeStyle = gameDrawColor;
          gameDrawContext.lineWidth = gameDrawSize;
          gameDrawContext.beginPath();
          gameDrawContext.moveTo(e.clientX, e.clientY);
          gameDrawContext.lineTo(e.clientX + 0.1, e.clientY + 0.1);
          gameDrawContext.stroke();
        }
      }
    }
  }, { passive: false, capture: true });

  container.addEventListener('pointermove', function(e) {
    if (e.pointerType === 'pen' && gameIsDrawing && gameDrawContext) {
      e.preventDefault();
      e.stopPropagation();

      const buttonPressed = (e.buttons === 2) || (e.buttons === 6) || ((e.buttons & 2) === 2) || ((e.buttons & 32) === 32);

      if (isErasing || buttonPressed) {
        eraseAt(e.clientX, e.clientY);
      } else {
        let size = gameDrawSize;
        if (e.pressure > 0) {
          size = gameDrawSize * (0.5 + e.pressure);
        }

        gameDrawContext.globalCompositeOperation = 'source-over';
        gameDrawContext.strokeStyle = gameDrawColor;
        gameDrawContext.lineWidth = size;
        gameDrawContext.lineTo(e.clientX, e.clientY);
        gameDrawContext.stroke();

        gameDrawContext.beginPath();
        gameDrawContext.moveTo(e.clientX, e.clientY);
      }

      gameLastX = e.clientX;
      gameLastY = e.clientY;
    }
  }, { passive: false, capture: true });

  container.addEventListener('pointerup', function(e) {
    if (e.pointerType === 'pen') {
      gameIsDrawing = false;
      isErasing = false;
      if (gameDrawContext) {
        gameDrawContext.globalCompositeOperation = 'source-over';
        gameDrawContext.beginPath();
      }
    }
  }, { capture: true });

  container.addEventListener('pointercancel', function(e) {
    if (e.pointerType === 'pen') {
      gameIsDrawing = false;
      isErasing = false;
      if (gameDrawContext) {
        gameDrawContext.globalCompositeOperation = 'source-over';
        gameDrawContext.beginPath();
      }
    }
  }, { capture: true });

  container.addEventListener('pointerleave', function(e) {
    if (e.pointerType === 'pen') {
      gameIsDrawing = false;
      isErasing = false;
      if (gameDrawContext) {
        gameDrawContext.globalCompositeOperation = 'source-over';
        gameDrawContext.beginPath();
      }
    }
  }, { capture: true });

  container.style.touchAction = 'none';

  container.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });
}

/**
 * Erase at a specific point
 */
function eraseAt(x, y) {
  if (!gameDrawContext) return;

  const eraserSize = 25; // Eraser radius

  gameDrawContext.save();
  gameDrawContext.globalCompositeOperation = 'destination-out';
  gameDrawContext.beginPath();
  gameDrawContext.arc(x, y, eraserSize, 0, Math.PI * 2);
  gameDrawContext.fill();
  gameDrawContext.restore();
}

/**
 * Setup zoom and pan gestures (fingers only - ignore pen)
 */
function setupZoomPanGestures() {
  const wrapper = document.getElementById('gameZoomWrapper');
  if (!wrapper) return;

  let initialDist = 0;
  let initialZoom = 1;
  let touchStartX = 0;
  let touchStartY = 0;
  let activeTouchIds = []; // Track finger touch IDs only

  wrapper.addEventListener('pointerdown', function(e) {
    if (e.pointerType === 'touch') {
      activeTouchIds.push(e.pointerId);

      if (activeTouchIds.length === 1 && gameZoomLevel > 1) {
        gameIsPanning = true;
        touchStartX = e.clientX;
        touchStartY = e.clientY;
        initialTranslateX = gameTranslateX;
        initialTranslateY = gameTranslateY;
      }
    }
  }, { passive: true });

  wrapper.addEventListener('pointermove', function(e) {
    if (e.pointerType !== 'touch') return;

    if (activeTouchIds.length === 1 && gameIsPanning && gameZoomLevel > 1) {
      const deltaX = (e.clientX - touchStartX) / gameZoomLevel;
      const deltaY = (e.clientY - touchStartY) / gameZoomLevel;

      gameTranslateX = initialTranslateX + deltaX;
      gameTranslateY = initialTranslateY + deltaY;

      const maxPan = (gameZoomLevel - 1) * 400;
      gameTranslateX = Math.min(Math.max(gameTranslateX, -maxPan), maxPan);
      gameTranslateY = Math.min(Math.max(gameTranslateY, -maxPan), maxPan);

      updateGameTransform();
    }
  }, { passive: true });

  wrapper.addEventListener('pointerup', function(e) {
    if (e.pointerType === 'touch') {
      activeTouchIds = activeTouchIds.filter(id => id !== e.pointerId);
      if (activeTouchIds.length === 0) {
        gameIsPanning = false;
      }
    }
  });

  wrapper.addEventListener('pointercancel', function(e) {
    if (e.pointerType === 'touch') {
      activeTouchIds = activeTouchIds.filter(id => id !== e.pointerId);
      if (activeTouchIds.length === 0) {
        gameIsPanning = false;
      }
    }
  });

  wrapper.addEventListener('touchstart', function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      initialDist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      initialZoom = gameZoomLevel;
      gameIsPanning = false; // Stop panning when pinching
    }
  }, { passive: false });

  wrapper.addEventListener('touchmove', function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      gameZoomLevel = Math.min(Math.max(initialZoom * (dist / initialDist), 1), 4);

      if (gameZoomLevel <= 1.05) {
        gameZoomLevel = 1;
        gameTranslateX = 0;
        gameTranslateY = 0;
      }

      updateGameTransform();
      updateGameZoomIndicator();
    }
  }, { passive: false });

  wrapper.addEventListener('touchend', function(e) {
    if (e.touches.length < 2) {
      initialDist = 0;
    }
    if (e.touches.length === 0) {
      gameIsPanning = false;
      activeTouchIds = [];
    }
  });

  wrapper.addEventListener('wheel', function(e) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.15 : 0.15;
    gameZoomLevel = Math.min(Math.max(gameZoomLevel + delta, 1), 4);

    if (gameZoomLevel <= 1.05) {
      gameZoomLevel = 1;
      gameTranslateX = 0;
      gameTranslateY = 0;
    }

    updateGameTransform();
    updateGameZoomIndicator();
  }, { passive: false });
}

function updateGameTransform() {
  const wrapper = document.getElementById('gameZoomWrapper');
  if (wrapper) {
    wrapper.style.transform = `scale(${gameZoomLevel}) translate(${gameTranslateX}px, ${gameTranslateY}px)`;
  }
}

function updateGameZoomIndicator() {
  const ind = document.getElementById('gameZoomIndicator');
  if (ind) ind.textContent = `${Math.round(gameZoomLevel * 100)}%`;
}

/**
 * Set drawing color
 */
function setGameDrawColor(color, btn) {
  gameDrawColor = color;
  document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('selected'));
  if (btn) btn.classList.add('selected');
}

/**
 * Save drawing state for undo
 */
function saveGameDrawState() {
  const canvas = document.getElementById('gameDrawingCanvas');
  if (canvas && gameDrawContext) {
    try {
      gameDrawHistory.push(canvas.toDataURL());
      if (gameDrawHistory.length > 30) gameDrawHistory.shift();
    } catch(e) {}
  }
}

/**
 * Undo last drawing
 */
function undoGameDrawing() {
  if (gameDrawHistory.length > 0) {
    const canvas = document.getElementById('gameDrawingCanvas');
    const dpr = window.devicePixelRatio || 1;
    const state = gameDrawHistory.pop();
    const img = new Image();
    img.onload = function() {
      gameDrawContext.setTransform(1, 0, 0, 1, 0, 0);
      gameDrawContext.clearRect(0, 0, canvas.width, canvas.height);
      gameDrawContext.drawImage(img, 0, 0);
      gameDrawContext.scale(dpr, dpr);
    };
    img.src = state;
  }
}

/**
 * Clear all drawings
 */
function clearGameDrawing() {
  const canvas = document.getElementById('gameDrawingCanvas');
  if (canvas && gameDrawContext) {
    const dpr = window.devicePixelRatio || 1;
    saveGameDrawState();
    gameDrawContext.setTransform(1, 0, 0, 1, 0, 0);
    gameDrawContext.clearRect(0, 0, canvas.width, canvas.height);
    gameDrawContext.scale(dpr, dpr);
  }
}

/**
 * Apply XX-Large font size (always)
 */
function applyGameFontSize() {
  const scale = 1.8; // XX-Large

  const questionText = document.querySelector('.game-question-text');
  const answerBtns = document.querySelectorAll('.game-answer-btn');
  const progressText = document.querySelector('.game-progress-text');
  const timerDisplay = document.querySelector('.timer-display');

  if (questionText) questionText.style.fontSize = `${2.2 * scale}rem`;
  answerBtns.forEach(b => b.style.fontSize = `${1.3 * scale}rem`);
  if (progressText) progressText.style.fontSize = `${1 * scale}rem`;
  if (timerDisplay) timerDisplay.style.fontSize = `${4 * scale}rem`;
}

/**
 * Reset tools (zoom and drawings only - font stays XX-Large)
 */
function resetGameTools() {
  gameZoomLevel = 1;
  gameTranslateX = 0;
  gameTranslateY = 0;
  updateGameTransform();
  updateGameZoomIndicator();

  clearGameDrawing();
  gameDrawHistory = [];

  applyGameFontSize();
}


/**
 * Play audio
 */
function playGameAudio(url) {
  if (!url) return;
  try {
    const audio = new Audio(url);
    audio.volume = 0.5;
    audio.play().catch(() => {});
  } catch(e) {}
}

/**
 * Start background music
 */
function startBgMusic(url) {
  if (!url) return;
  try {
    backgroundMusicAudio = new Audio(url);
    backgroundMusicAudio.loop = true;
    backgroundMusicAudio.volume = 0.3;
    backgroundMusicAudio.play().catch(() => {});
  } catch(e) {}
}

/**
 * Stop background music
 */
function stopBgMusic() {
  if (backgroundMusicAudio) {
    backgroundMusicAudio.pause();
    backgroundMusicAudio = null;
  }
}

/**
 * Toggle background music
 */
function toggleBgMusic() {
  const btn = document.getElementById('musicToggleBtn');
  if (backgroundMusicAudio) {
    if (backgroundMusicAudio.paused) {
      backgroundMusicAudio.play().catch(() => {});
      btn.textContent = ' Music';
    } else {
      backgroundMusicAudio.pause();
      btn.textContent = ' Music';
    }
  }
}

/**
 * Add from question bank (placeholder)
 */
function addFromQuestionBank() {
  alert('Question Bank feature - select questions from your saved bank to add to this game.');
}

/**
 * Save to question bank
 */
async function saveToQuestionBank() {
  const questionText = document.getElementById('bankQuestionText').value.trim();
  const answerA = document.getElementById('bankAnswerA').value.trim();
  const answerB = document.getElementById('bankAnswerB').value.trim();
  const answerC = document.getElementById('bankAnswerC').value.trim();
  const answerD = document.getElementById('bankAnswerD').value.trim();

  if (!questionText || !answerA || !answerB || !answerC || !answerD) {
    alert('Fill in all fields.');
    return;
  }

  try {
    await db.collection('questionBank').add({
      teacherId: currentUser.uid,
      question: questionText,
      answers: { A: answerA, B: answerB, C: answerC, D: answerD },
      correctAnswer: document.getElementById('bankCorrectAnswer').value,
      category: document.getElementById('bankQuestionCategory').value.trim() || 'General',
      difficulty: document.getElementById('bankQuestionDifficulty').value,
      reasonType: document.getElementById('bankReasonType').value,
      reasonContent: document.getElementById('bankReasonContent').value.trim(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Saved to Question Bank!');
    ['bankQuestionText','bankAnswerA','bankAnswerB','bankAnswerC','bankAnswerD','bankQuestionCategory','bankReasonContent'].forEach(id => {
      document.getElementById(id).value = '';
    });
    loadQuestionBank();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Load question bank
 */
async function loadQuestionBank() {
  const container = document.getElementById('questionBankList');
  if (!container) return;

  try {
    const snapshot = await db.collection('questionBank').where('teacherId', '==', currentUser.uid).get();

    if (snapshot.empty) {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">No questions in your bank yet.</div>';
      return;
    }

    let questions = [];
    snapshot.forEach(doc => {
      questions.push({ id: doc.id, ...doc.data() });
    });
    questions.sort((a, b) => {
      const aTime = a.createdAt?.toMillis?.() || 0;
      const bTime = b.createdAt?.toMillis?.() || 0;
      return bTime - aTime;
    });

    const categories = new Set();
    let html = '';
    questions.forEach(q => {
      categories.add(q.category);
      html += `
        <div class="question-bank-item">
          <div class="question-preview">${q.question}</div>
          <span class="question-category">${q.category}</span>
          <span class="question-difficulty ${q.difficulty}">${q.difficulty}</span>
          <button onclick="deleteFromBank('${q.id}')" style="background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px;"></button>
        </div>
      `;
    });
    container.innerHTML = html;

    const catFilter = document.getElementById('bankFilterCategory');
    if (catFilter) {
      catFilter.innerHTML = '<option value="">All Categories</option>' +
        Array.from(categories).map(c => `<option value="${c}">${c}</option>`).join('');
    }
  } catch (error) {
    container.innerHTML = `<div style="color: #e53e3e;">Error: ${error.message}</div>`;
  }
}

/**
 * Delete from question bank
 */
async function deleteFromBank(docId) {
  if (!confirm('Delete this question from bank?')) return;
  try {
    await db.collection('questionBank').doc(docId).delete();
    loadQuestionBank();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

/**
 * Filter question bank
 */
function filterQuestionBank() {
  loadQuestionBank();
}


let myFlashcardsData = [];
let myFoldersData = [];
let selectedFolderId = 'all';
let myCardsLeitnerChart = null;
let myCardsFolderChart = null;
let marketplaceData = [];
let pendingVocabWord = null; // Store word being added to vocabulary
let myCardsSyncedToGames = false; // Track if initial sync has been done
let syncedMyCardsFolders = []; // Track synced folder IDs

const FLASHCARD_CATEGORIES = {
  food: { name: 'Food & Dining', icon: '', color: '#f6ad55' },
  travel: { name: 'Travel', icon: '', color: '#63b3ed' },
  business: { name: 'Business', icon: '', color: '#68d391' },
  kdrama: { name: 'K-Drama', icon: '', color: '#f687b3' },
  kpop: { name: 'K-Pop', icon: '', color: '#b794f4' },
  daily: { name: 'Daily Life', icon: '', color: '#f6e05e' },
  academic: { name: 'Academic', icon: '', color: '#7f9cf5' },
  slang: { name: 'Slang & Informal', icon: '', color: '#fc8181' },
  other: { name: 'Other', icon: '', color: '#a0aec0' }
};

/**
 * Show word hover tooltip with definition and grammar forms
 * Tooltip stays open when mouse enters it
 */
let hoverTimeout = null;

function showWordHover(event, element) {
  if (hoverTimeout) {
    clearTimeout(hoverTimeout);
    hoverTimeout = null;
  }

  const tooltip = document.getElementById('wordHoverTooltip');
  const content = document.getElementById('tooltipContent');

  try {
    const wordData = JSON.parse(decodeURIComponent(element.dataset.word));

    window.currentHoverWord = {
      ...wordData,
      sourceSetId: wordData.sourceSetId || currentFlashcardSet?.id || null,
      sourceSetTitle: wordData.sourceSetTitle || currentFlashcardSet?.title || 'My Flashcards'
    };

    let html = `
      <div style="margin-bottom: 10px;">
        <span style="font-size: 20px; font-weight: bold; color: #667eea;">${wordData.word}</span>
        <span style="background: #e9d8fd; color: #6b46c1; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">${wordData.partOfSpeech || 'word'}</span>
      </div>
      <div style="color: #2d3748; margin-bottom: 10px;">
        <strong>Definition:</strong> ${wordData.definition}
      </div>
    `;

    if (wordData.exampleSentence) {
      html += `
        <div style="background: #f7fafc; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 13px;">
          <strong>Example:</strong> ${wordData.exampleSentence}
        </div>
      `;
    }

    if (wordData.grammarForms && Object.keys(wordData.grammarForms).length > 0) {
      html += `<div style="border-top: 1px solid #e2e8f0; padding-top: 10px; margin-top: 5px;">
        <strong style="font-size: 12px; color: #718096;">Grammar Forms:</strong>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; font-size: 12px;">`;

      const formLabels = {
        dictionaryForm: ' Dictionary',
        presentTense: ' Present',
        pastTense: ' Past',
        futureTense: ' Future',
        adjectiveForm: ' Adjective',
        adverbForm: ' Adverb',
        modifierForm: ' Modifier'
      };

      for (const [key, value] of Object.entries(wordData.grammarForms)) {
        if (value) {
          const label = formLabels[key] || key;
          html += `<div><span style="color: #718096;">${label}:</span> <span style="color: #2d3748;">${value}</span></div>`;
        }
      }

      html += `</div></div>`;
    }

    html += `
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
        <button onclick="importWordFromHover()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
           Add to My Vocabulary
        </button>
      </div>
    `;

    content.innerHTML = html;

    tooltip.style.visibility = 'hidden';
    tooltip.style.display = 'block';

    const rect = element.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const tooltipWidth = tooltipRect.width || 340;
    const tooltipHeight = tooltipRect.height || 300;
    const padding = 10;

    let leftPos = rect.left;
    if (leftPos + tooltipWidth > window.innerWidth - padding) {
      leftPos = window.innerWidth - tooltipWidth - padding;
    }
    if (leftPos < padding) leftPos = padding;

    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;

    let topPos;
    if (spaceBelow >= tooltipHeight + padding) {
      topPos = rect.bottom + padding;
    } else if (spaceAbove >= tooltipHeight + padding) {
      topPos = rect.top - tooltipHeight - padding;
    } else {
      topPos = Math.max(padding, Math.min(
        window.innerHeight - tooltipHeight - padding,
        rect.top - (tooltipHeight / 2) + (rect.height / 2)
      ));
    }

    if (topPos + tooltipHeight > window.innerHeight - padding) {
      topPos = window.innerHeight - tooltipHeight - padding;
    }

    if (topPos < padding) {
      topPos = padding;
    }

    tooltip.style.left = leftPos + 'px';
    tooltip.style.top = topPos + 'px';
    tooltip.style.visibility = 'visible';

    tooltip.onmouseenter = () => {
      if (hoverTimeout) {
        clearTimeout(hoverTimeout);
        hoverTimeout = null;
      }
    };

    tooltip.onmouseleave = () => {
      hideWordHover();
    };

  } catch (e) {
  }
}

/**
 * Hide word hover tooltip with delay
 */
function hideWordHover() {
  hoverTimeout = setTimeout(() => {
    document.getElementById('wordHoverTooltip').style.display = 'none';
    window.currentHoverWord = null;
  }, 200); // Small delay to allow moving to tooltip
}

/**
 * Import word from hover tooltip to vocabulary
 */
async function importWordFromHover() {
  if (!window.currentHoverWord || !currentUser) {
    alert('Error: No word selected');
    return;
  }

  const wordData = window.currentHoverWord;

  try {
    const posFolders = {
      'noun': ' Nouns',
      'action verb': ' Action Verbs',
      'descriptive verb': ' Descriptive Verbs',
      'adjective': ' Adjectives',
      'adverb': ' Adverbs',
      'conjunction': ' Conjunctions',
      'expression': ' Expressions',
      'verb': ' Action Verbs' // Default verbs to action verbs
    };

    const pos = (wordData.partOfSpeech || 'noun').toLowerCase();
    const folderName = posFolders[pos] || ' Nouns';

    let vocabFolderId = null;
    const foldersSnapshot = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('name', '==', folderName)
      .get();

    if (foldersSnapshot.empty) {
      const folderRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: folderName,
        isPartOfSpeechFolder: true,
        isVocabulary: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      vocabFolderId = folderRef.id;
    } else {
      vocabFolderId = foldersSnapshot.docs[0].id;
    }

    const existingSnapshot = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('korean', '==', wordData.word)
      .get();

    if (!existingSnapshot.empty) {
      const existingCard = existingSnapshot.docs[0].data();
      let existingFolderName = 'your flashcards';
      try {
        const folderDoc = await db.collection('studentFolders').doc(existingCard.folderId).get();
        if (folderDoc.exists) existingFolderName = folderDoc.data().name || 'your flashcards';
      } catch(e) {}

      showToast(` "${wordData.word}" already exists in ${existingFolderName}!`);
      document.getElementById('wordHoverTooltip').style.display = 'none';
      return;
    }

    document.getElementById('wordHoverTooltip').style.display = 'none';

    const wordId = wordData.word.replace(/\s/g, '_');
    showToast(`Saving "${wordData.word}"...`, { isLoading: true, id: wordId });

    let situationalData = null;
    try {
      const prompt = buildSituationalPrompt(wordData.word, wordData.definition);
      situationalData = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert who specializes in creating natural, colloquial Korean conversation examples. You understand Korean culture and how native speakers actually talk in everyday situations. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.7);
    } catch (aiError) {
    }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: vocabFolderId,
      korean: wordData.word,
      english: wordData.definition,
      partOfSpeech: wordData.partOfSpeech || null,
      exampleSentence: wordData.exampleSentence || null,
      grammarForms: wordData.grammarForms || null,
      situationalData: situationalData,
      sourceSetId: wordData.sourceSetId,
      sourceSetTitle: wordData.sourceSetTitle,
      isVocabulary: true,
      leitnerBox: 1,
      correctCount: 0,
      incorrectCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    window.currentHoverWord = null;

    showToast(` "${wordData.word}" added to ${folderName}!`);

    if (myFlashcardsData) {
      loadMyFlashcards();
    }

  } catch (error) {
    alert('Error adding word: ' + error.message);
  }
}

/**
 * Show vocabulary add modal
 */
/**
 * Show toast notification with duplicate prevention
 */
let activeToastId = null;
let activeToastElement = null;

function showToast(message, options = {}) {
  const { duration = 3000, isLoading = false, id = null } = options;

  if (isLoading && id) {
    activeToastId = id;
  }

  if (!isLoading && id && activeToastElement && activeToastId === id) {
    activeToastElement.remove();
    activeToastElement = null;
    activeToastId = null;
  }

  const existingToasts = document.querySelectorAll('.korealand-toast');
  existingToasts.forEach(t => {
    if (t.textContent === message) t.remove();
  });

  const isMobileView = window.innerWidth <= 768;
  const bottomPosition = isMobileView ? '85px' : '30px';

  const toast = document.createElement('div');
  toast.className = 'korealand-toast';
  toast.style.cssText = `
    position: fixed;
    bottom: ${bottomPosition};
    left: 50%;
    transform: translateX(-50%);
    background: ${isLoading ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #48bb78 0%, #38b2ac 100%)'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 999999;
    animation: slideUp 0.3s ease-out;
    display: flex;
    align-items: center;
    gap: 10px;
  `;

  if (isLoading) {
    toast.innerHTML = `
      <div style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <span>${message}</span>
    `;
    activeToastElement = toast;
  } else {
    toast.textContent = message;
  }

  document.body.appendChild(toast);

  if (!document.getElementById('toastSpinStyle')) {
    const style = document.createElement('style');
    style.id = 'toastSpinStyle';
    style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
  }

  if (!isLoading) {
    setTimeout(() => {
      toast.style.animation = 'slideDown 0.3s ease-in';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  return toast;
}

let currentSituationalData = null;

/**
 * Open situational responses slideout panel
 */
function openSituationalSlideout(vocabCard) {

  try {
    const modal = document.getElementById('situationalModal');

    if (!modal) {
      alert('Error: Modal not found.');
      return;
    }

    const wordInfo = document.getElementById('situationalWordInfo');
    const scenario = document.getElementById('situationalScenario');
    const responses = document.getElementById('situationalResponses');


    currentSituationalData = {
      korean: vocabCard.korean,
      english: vocabCard.english
    };

    wordInfo.innerHTML = `
      <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${vocabCard.korean || 'No Korean'}</div>
      <div style="font-size: 16px; opacity: 0.9;">${vocabCard.english || 'No English'}</div>
      ${vocabCard.partOfSpeech ? `<div style="margin-top: 8px;"><span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 15px; font-size: 12px;">${vocabCard.partOfSpeech}</span></div>` : ''}
  `;

  const situationalData = vocabCard.situationalData || vocabCard.aiData?.situationalData;

  if (situationalData && situationalData.situation) {
    scenario.innerHTML = `
      <div style="font-size: 12px; color: #718096; margin-bottom: 8px; font-weight: 600;"> SITUATION</div>
      <div style="font-size: 16px; color: #2d3748; margin-bottom: 8px; line-height: 1.5;">${situationalData.situation.korean}</div>
      <div style="font-size: 14px; color: #718096; font-style: italic;">${situationalData.situation.english}</div>
    `;

    window.currentSituationalResponses = situationalData.responses || [];

    const sortedResponses = [...(situationalData.responses || [])].sort((a, b) => a.points - b.points);

    window.currentSortedResponses = sortedResponses;

    responses.innerHTML = sortedResponses.map((resp, idx) => {
      const levelColors = {
        'Novice': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
        'Beginner': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
        'Advanced Beginner': { bg: '#ede9fe', border: '#8b5cf6', text: '#5b21b6' }
      };
      const colors = levelColors[resp.level] || { bg: '#f3f4f6', border: '#9ca3af', text: '#374151' };

      return `
        <div style="background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="background: ${colors.border}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">${resp.level}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${colors.text}; font-size: 12px; font-weight: 600;">${resp.points} pt${resp.points > 1 ? 's' : ''}</span>
              <button onclick="addPhraseByIndex(${idx})" style="background: #48bb78; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center;" title="Add to My Phrases">+</button>
            </div>
          </div>

          <div style="color: ${colors.text}; font-size: 14px; margin-bottom: 10px; line-height: 1.5;">${resp.english}</div>

          ${resp.keywords && resp.keywords.length > 0 ? `
            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px;">
              ${resp.keywords.map(kw => `<span style="background: white; padding: 3px 8px; border-radius: 6px; font-size: 11px; color: #4a5568;">${kw.korean} <span style="color: #a0aec0;"></span> ${kw.english}</span>`).join('')}
            </div>
          ` : ''}

          <button onclick="toggleKoreanResponse(this)" style="width: 100%; padding: 10px; background: white; border: 2px solid ${colors.border}; border-radius: 8px; cursor: pointer; font-size: 13px; color: ${colors.text}; font-weight: 600;">
             Show Korean Response
          </button>
          <div class="korean-response" style="display: none; margin-top: 10px; padding: 12px; background: white; border-radius: 8px; font-size: 16px; color: #2d3748; line-height: 1.6;">
            ${resp.korean}
            <button onclick="speakText('${resp.korean.replace(/'/g, "\\'")}', 'ko-KR')" style="margin-top: 8px; padding: 6px 12px; background: ${colors.border}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
               Listen
            </button>
          </div>
        </div>
      `;
    }).join('');

  } else {
    scenario.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #718096;">
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div>No situational responses available for this word.</div>
        <div style="font-size: 13px; margin-top: 5px;">Situational data is generated when flashcard sets are created with AI.</div>
      </div>
    `;
    responses.innerHTML = '';
  }

  modal.style.display = 'flex';

  } catch (error) {
    alert('Error opening modal: ' + error.message);
  }
}

/**
 * Close situational responses modal
 */
function closeSituationalModal() {
  const modal = document.getElementById('situationalModal');
  if (modal) {
    modal.style.display = 'none';
  }
  currentSituationalData = null;
}

function closeSituationalSlideout() {
  closeSituationalModal();
}

/**
 * Toggle Korean response visibility
 */
function toggleKoreanResponse(btn) {
  const responseDiv = btn.nextElementSibling;
  if (responseDiv.style.display === 'none') {
    responseDiv.style.display = 'block';
    btn.textContent = ' Hide Korean Response';
  } else {
    responseDiv.style.display = 'none';
    btn.textContent = ' Show Korean Response';
  }
}

/**
 * Speak situational word
 */
function speakSituationalWord(lang) {
  if (!currentSituationalData) return;

  if (lang === 'korean') {
    speakText(currentSituationalData.korean, 'ko-KR');
  } else {
    speakText(currentSituationalData.english, 'en-US');
  }
}

/**
 * Speak text using browser TTS
 */
function speakText(text, lang) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.9;

    const voices = window.speechSynthesis.getVoices();
    const voice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
    if (voice) utterance.voice = voice;

    window.speechSynthesis.speak(utterance);
  }
}

/**
 * Load My Flashcards data
 */
async function loadMyFlashcards() {
  if (!currentUser) return;

  try {
    const foldersSnapshot = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .get();

    myFoldersData = [];
    foldersSnapshot.forEach(doc => {
      myFoldersData.push({ id: doc.id, ...doc.data() });
    });

    const hasMyPhrases = myFoldersData.some(f => f.name === 'My Phrases' && f.isPhrases === true);
    if (!hasMyPhrases) {
      const newFolderRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: 'My Phrases',
        isPhrases: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      myFoldersData.push({
        id: newFolderRef.id,
        studentId: currentUser.uid,
        name: 'My Phrases',
        isPhrases: true
      });
    }

    const hasBasicVocab = myFoldersData.some(f => f.name === ' Vocabulary - Basic Test Vocab' && f.isBasicVocab === true);
    if (!hasBasicVocab) {
      const basicVocabRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: ' Vocabulary - Basic Test Vocab',
        isBasicVocab: true,
        isVocabulary: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      myFoldersData.push({
        id: basicVocabRef.id,
        studentId: currentUser.uid,
        name: ' Vocabulary - Basic Test Vocab',
        isBasicVocab: true,
        isVocabulary: true
      });
    }

    const posFolders = [
      { name: ' Nouns', icon: '' },
      { name: ' Action Verbs', icon: '' },
      { name: ' Descriptive Verbs', icon: '' },
      { name: ' Adjectives', icon: '' },
      { name: ' Adverbs', icon: '' },
      { name: ' Conjunctions', icon: '' },
      { name: ' Expressions', icon: '' }
    ];

    for (const posFolder of posFolders) {
      const hasFolder = myFoldersData.some(f => f.name === posFolder.name);
      if (!hasFolder) {
        const newFolderRef = await db.collection('studentFolders').add({
          studentId: currentUser.uid,
          name: posFolder.name,
          isPartOfSpeechFolder: true,
          isVocabulary: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        myFoldersData.push({
          id: newFolderRef.id,
          studentId: currentUser.uid,
          name: posFolder.name,
          isPartOfSpeechFolder: true,
          isVocabulary: true
        });
      }
    }

    const cardsSnapshot = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .get();

    myFlashcardsData = [];
    cardsSnapshot.forEach(doc => {
      myFlashcardsData.push({ id: doc.id, ...doc.data() });
    });

    renderMyFolders();
    renderMyCards();
    updateMyFlashcardsStats();
    updateStudyFolderSelect();

  } catch (error) {
  }
}

/**
 * Render folders list
 */
function renderMyFolders() {
  const container = document.getElementById('myFoldersList');
  if (!container) return;

  const allCardsCountEl = document.getElementById('allCardsCount');
  if (allCardsCountEl) allCardsCountEl.textContent = myFlashcardsData.length;

  if (myFoldersData.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0; font-size: 12px;">No folders yet. Create one!</div>';
    return;
  }

  myFoldersData.sort((a, b) => {
    if (a.isPhrases) return -1;
    if (b.isPhrases) return 1;
    if (a.isVocabulary && !b.isVocabulary) return -1;
    if (!a.isVocabulary && b.isVocabulary) return 1;
    return (a.name || '').localeCompare(b.name || '');
  });

  let html = '';
  myFoldersData.forEach(folder => {
    const cardCount = myFlashcardsData.filter(c => c.folderId === folder.id).length;
    const isActive = selectedFolderId === folder.id;
    const publicBadge = folder.isPublic ? `<span class="folder-public-badge"> ${folder.price || 0}</span>` : '';
    const folderIcon = folder.isPhrases ? '' : (folder.isVocabulary ? '' : '');

    html += `
      <div class="my-folder-item ${isActive ? 'active' : ''}" id="myFolder-${folder.id}" style="display: flex; justify-content: space-between; align-items: center;">
        <div onclick="selectMyFolder('${folder.id}')" style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 8px;">
          <span>${folderIcon} ${folder.name} ${publicBadge}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <span class="folder-count" style="margin-right: 5px;">${cardCount}</span>
          <button onclick="event.stopPropagation(); openFolderReview('${folder.id}')"
                  style="background: #667eea; color: white; border: none; border-radius: 4px; padding: 3px 8px; font-size: 11px; cursor: pointer;"
                  title="Review cards in this folder"></button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

/**
 * Select a folder
 */
function selectMyFolder(folderId) {
  selectedFolderId = folderId;

  document.querySelectorAll('.my-folder-item').forEach(item => item.classList.remove('active'));
  const el = document.getElementById('myFolder-' + folderId);
  if (el) el.classList.add('active');

  const folder = myFoldersData.find(f => f.id === folderId);
  const nameEl = document.getElementById('selectedFolderName');
  if (nameEl) nameEl.textContent = folder ? folder.name : 'All Cards';

  const settingsBtn = document.getElementById('folderSettingsBtn');
  if (settingsBtn) settingsBtn.style.display = folderId === 'all' ? 'none' : 'inline-flex';

  renderMyCards();
}

/**
 * Render cards grid
 */
function renderMyCards() {
  const container = document.getElementById('myCardsGrid');
  if (!container) return;

  let cards = selectedFolderId === 'all'
    ? myFlashcardsData
    : myFlashcardsData.filter(c => c.folderId === selectedFolderId);

  const searchTerm = document.getElementById('myCardsSearch')?.value?.toLowerCase() || '';
  if (searchTerm) {
    cards = cards.filter(c =>
      (c.korean || '').toLowerCase().includes(searchTerm) ||
      (c.english || '').toLowerCase().includes(searchTerm)
    );
  }

  const sortBy = document.getElementById('myCardsSort')?.value || 'newest';
  cards.sort((a, b) => {
    switch (sortBy) {
      case 'oldest': return (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0);
      case 'korean': return (a.korean || '').localeCompare(b.korean || '');
      case 'box': return (b.leitnerBox || 1) - (a.leitnerBox || 1);
      default: return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
    }
  });

  const countEl = document.getElementById('selectedFolderCount');
  if (countEl) countEl.textContent = `${cards.length} cards`;

  if (cards.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #a0aec0; grid-column: 1 / -1;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>${searchTerm ? 'No cards match your search.' : 'No cards in this folder yet.'}</p>
      </div>
    `;
    return;
  }

  let html = '';
  cards.forEach((card, cardIndex) => {
    const boxStars = ''.repeat(card.leitnerBox || 1);
    const isPurchased = card.copiedFrom ? true : false;
    const isVocabulary = card.isVocabulary || false;
    const hasSituational = card.situationalData || (card.aiData && card.aiData.situationalData);

    const koreanEscaped = (card.korean || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const englishEscaped = (card.english || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

    html += `
      <div class="my-card-item" data-card-id="${card.id}" data-card-index="${cardIndex}">
        <div class="card-actions">
          <button class="situational-btn" onclick="openSituationalFromCard(${cardIndex})" title="Situational Responses" style="background: #667eea; color: white; border: none; border-radius: 4px; padding: 3px 6px; cursor: pointer; font-size: 11px;"></button>
          <button class="speaker-btn" onclick="speakCard('${koreanEscaped}', '${englishEscaped}')" title="Listen" style="background: #4299e1; color: white; border: none; border-radius: 4px; padding: 3px 6px; cursor: pointer; font-size: 11px;"></button>
          <button class="edit-btn" onclick="openEditCardModal('${card.id}')" title="Edit"></button>
          <button class="delete-btn" onclick="deleteMyCard('${card.id}')" title="Delete"></button>
        </div>
        <div class="card-korean">${card.korean || ''}</div>
        <div class="card-english">${card.english || ''}</div>
        ${card.partOfSpeech ? `<div style="font-size: 10px; color: #9f7aea; margin-top: 5px;">${card.partOfSpeech}</div>` : ''}
        <div class="card-meta">
          <div class="card-box">${boxStars}</div>
          ${isPurchased ? '<span style="color: #667eea; font-size: 10px;"> Purchased</span>' : ''}
          ${isVocabulary ? '<span style="color: #9f7aea; font-size: 10px;"> Vocab</span>' : ''}
        </div>
      </div>
    `;
  });

  container.innerHTML = html;

  window.currentMyCards = cards;
}

/**
 * Open situational slideout from card button
 */
function openSituationalFromCard(cardIndex) {

  if (window.currentMyCards && window.currentMyCards[cardIndex]) {
    openSituationalSlideout(window.currentMyCards[cardIndex]);
  } else {
    alert('Error: Could not load card data. Please refresh the page.');
  }
}

/**
 * Speak card Korean and English
 */
function speakCard(korean, english) {
  speakText(korean, 'ko-KR');
  setTimeout(() => {
    speakText(english, 'en-US');
  }, 1500);
}

function filterMyCards() { renderMyCards(); }

function updateMyFlashcardsStats() {
  const total = myFlashcardsData.length;
  const mastered = myFlashcardsData.filter(c => (c.leitnerBox || 1) >= 5).length;

  const totalEl = document.getElementById('myTotalCards');
  const masteredEl = document.getElementById('myMasteredCards');
  if (totalEl) totalEl.textContent = total;
  if (masteredEl) masteredEl.textContent = mastered;

  let totalEarnings = 0;
  myFoldersData.forEach(folder => {
    if (folder.isPublic && folder.totalEarnings) totalEarnings += folder.totalEarnings;
  });
  const earningsEl = document.getElementById('myTotalEarnings');
  if (earningsEl) earningsEl.textContent = totalEarnings + ' ';
}

function updateStudyFolderSelect() {
  const select = document.getElementById('studyFolderSelect');
  if (!select) return;

  let html = '<option value="all">All Cards</option><option value="due">Due for Review</option>';
  myFoldersData.forEach(folder => {
    const cardCount = myFlashcardsData.filter(c => c.folderId === folder.id).length;
    html += `<option value="${folder.id}">${folder.name} (${cardCount})</option>`;
  });
  select.innerHTML = html;
}

function closeFlashcardModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) modal.remove();
}

function openCreateFolderModal() {
  const modalHtml = `
    <div class="flashcard-modal" id="createFolderModal" onclick="if(event.target === this) closeFlashcardModal('createFolderModal')">
      <div class="flashcard-modal-content">
        <button class="close-modal" onclick="closeFlashcardModal('createFolderModal')"></button>
        <h3> Create New Folder</h3>
        <div class="form-group">
          <label>Folder Name</label>
          <input type="text" id="newFolderName" placeholder="e.g., Food Vocabulary" maxlength="50">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="newFolderCategory">
            ${Object.entries(FLASHCARD_CATEGORIES).map(([key, cat]) =>
              `<option value="${key}">${cat.icon} ${cat.name}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Description (optional)</label>
          <textarea id="newFolderDescription" placeholder="What's this folder about?" rows="2"></textarea>
        </div>
        <button onclick="createFolder()" class="btn" style="width: 100%; margin-top: 15px;"> Create Folder</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function createFolder() {
  const name = document.getElementById('newFolderName').value.trim();
  const category = document.getElementById('newFolderCategory').value;
  const description = document.getElementById('newFolderDescription').value.trim();

  if (!name) { alert('Please enter a folder name'); return; }

  const duplicateFolder = myFoldersData.find(f =>
    f.name.toLowerCase() === name.toLowerCase()
  );

  if (duplicateFolder) {
    alert(`A folder named "${name}" already exists. Duplicate folder names are not allowed.\n\nSuggestion: Try adding a number, e.g. "${name} 2"`);
    return;
  }

  try {
    await db.collection('studentFolders').add({
      name, category, description,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      studentName: currentUser.displayName || currentUser.email,
      cardCount: 0, isPublic: false, price: 10, downloads: 0, totalEarnings: 0,
      ratings: [], avgRating: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeFlashcardModal('createFolderModal');
    loadMyFlashcards();

    if (myCardsSyncedToGames) {
      await autoSyncMyCardsToGames();
    }
  } catch (error) { alert('Error creating folder: ' + error.message); }
}

function openFolderSettingsModal() {
  if (selectedFolderId === 'all') return;
  const folder = myFoldersData.find(f => f.id === selectedFolderId);
  if (!folder) return;
  if (folder.copiedFrom) { alert('Purchased folders cannot be published to the marketplace.'); return; }

  const modalHtml = `
    <div class="flashcard-modal" id="folderSettingsModal" onclick="if(event.target === this) closeFlashcardModal('folderSettingsModal')">
      <div class="flashcard-modal-content">
        <button class="close-modal" onclick="closeFlashcardModal('folderSettingsModal')"></button>
        <h3> Folder Settings</h3>
        <div class="form-group"><label>Folder Name</label><input type="text" id="editFolderName" value="${folder.name || ''}" maxlength="50"></div>
        <div class="form-group"><label>Category</label>
          <select id="editFolderCategory">${Object.entries(FLASHCARD_CATEGORIES).map(([key, cat]) =>
            `<option value="${key}" ${folder.category === key ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
          ).join('')}</select>
        </div>
        <div class="form-group"><label>Description</label><textarea id="editFolderDescription" rows="2">${folder.description || ''}</textarea></div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
        <h4 style="margin-bottom: 15px;"> Marketplace Settings</h4>
        <div style="background: ${folder.isPublic ? '#c6f6d5' : '#f7fafc'}; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="folderIsPublic" ${folder.isPublic ? 'checked' : ''} onchange="togglePublicSettings()">
            <span style="font-weight: 600;">Publish to Marketplace</span>
          </label>
          <p style="margin: 10px 0 0 0; font-size: 12px; color: #718096;">Make this folder visible to other students.</p>
        </div>
        <div id="publicSettings" style="display: ${folder.isPublic ? 'block' : 'none'};">
          <div class="form-group">
            <label>Price (minimum 10 coins)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="number" id="folderPrice" value="${folder.price || 10}" min="10" max="1000" style="flex: 1;">
              <span style="font-size: 24px;"></span>
            </div>
          </div>
          ${folder.isPublic ? `<div style="background: #e9d8fd; padding: 12px; border-radius: 8px;"><div style="font-size: 12px; color: #553c9a;"> Stats: ${folder.downloads || 0} downloads | ${folder.totalEarnings || 0} coins earned</div></div>` : ''}
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="saveFolderSettings()" class="btn" style="flex: 1;"> Save Changes</button>
          <button onclick="deleteFolder('${folder.id}')" class="btn" style="flex: 1; background: #e53e3e;"> Delete Folder</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function togglePublicSettings() {
  const isPublic = document.getElementById('folderIsPublic').checked;
  document.getElementById('publicSettings').style.display = isPublic ? 'block' : 'none';
}

async function saveFolderSettings() {
  const name = document.getElementById('editFolderName').value.trim();
  const category = document.getElementById('editFolderCategory').value;
  const description = document.getElementById('editFolderDescription').value.trim();
  const isPublic = document.getElementById('folderIsPublic').checked;
  const price = parseInt(document.getElementById('folderPrice').value) || 10;

  if (!name) { alert('Please enter a folder name'); return; }
  if (isPublic && price < 10) { alert('Minimum price is 10 coins'); return; }

  const duplicateFolder = myFoldersData.find(f =>
    f.id !== selectedFolderId &&
    f.name.toLowerCase() === name.toLowerCase()
  );

  if (duplicateFolder) {
    alert(`A folder named "${name}" already exists. Duplicate folder names are not allowed.\n\nSuggestion: Try adding a number, e.g. "${name} 2"`);
    return;
  }

  try {
    await db.collection('studentFolders').doc(selectedFolderId).update({
      name, category, description, isPublic, price: isPublic ? price : 10,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });


    closeFlashcardModal('folderSettingsModal');
    loadMyFlashcards();
  } catch (error) { alert('Error saving folder: ' + error.message); }
}

async function deleteFolder(folderId) {
  const folder = myFoldersData.find(f => f.id === folderId);
  const cardCount = myFlashcardsData.filter(c => c.folderId === folderId).length;
  if (!confirm(`Delete "${folder?.name}"? This will also delete ${cardCount} cards and remove from Flashcard Games.`)) return;

  try {
    const batch = db.batch();
    myFlashcardsData.filter(c => c.folderId === folderId).forEach(card => {
      batch.delete(db.collection('studentFlashcards').doc(card.id));
    });
    batch.delete(db.collection('studentFolders').doc(folderId));


    await batch.commit();
    closeFlashcardModal('folderSettingsModal');
    selectedFolderId = 'all';
    loadMyFlashcards();
    showToast(' Folder deleted');
  } catch (error) { alert('Error deleting folder: ' + error.message); }
}

function openAddCardModal() {
  const defaultFolder = selectedFolderId !== 'all' ? selectedFolderId : '';

  const modalHtml = `
    <div class="flashcard-modal" id="addCardModal" onclick="if(event.target === this) closeFlashcardModal('addCardModal')">
      <div class="flashcard-modal-content" style="max-width: 700px;">
        <button class="close-modal" onclick="closeFlashcardModal('addCardModal')"></button>
        <h3> Add Multiple Cards</h3>
        <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
          Enter words in each column (one per line). Lines are matched by row number.
        </p>

        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">English (Column 1)</label>
            <textarea id="bulkEnglish" placeholder="Hello&#10;Thank you&#10;Goodbye&#10;Yes&#10;No"
              style="width: 100%; height: 250px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical;"></textarea>
          </div>
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Korean (Column 2)</label>
            <textarea id="bulkKorean" placeholder="&#10;&#10; &#10;&#10;"
              style="width: 100%; height: 250px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical;"></textarea>
          </div>
        </div>

        <div style="background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;"></span>
            <div style="font-size: 12px; color: #276749;">
              <strong>Tip:</strong> You can paste directly from Excel or Google Sheets! Copy column A, paste into English. Copy column B, paste into Korean.
            </div>
          </div>
        </div>

        <div id="bulkPreview" style="display: none; background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 15px; max-height: 150px; overflow-y: auto;">
          <div style="font-weight: 600; color: #4a5568; margin-bottom: 10px;"> Preview (<span id="previewCount">0</span> cards)</div>
          <div id="previewList" style="font-size: 13px;"></div>
        </div>

        <div class="form-group">
          <label>Folder *</label>
          <select id="newCardFolder" required>
            <option value="">-- Select Folder --</option>
            ${myFoldersData.map(f => {
              const count = myFlashcardsData.filter(c => c.folderId === f.id).length;
              return `<option value="${f.id}" ${f.id === defaultFolder ? 'selected' : ''}>${f.name} (${count}/100 cards)</option>`;
            }).join('')}
          </select>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button onclick="previewBulkCards()" class="btn" style="flex: 1; background: #718096;"> Preview</button>
          <button onclick="addBulkCards()" class="btn" style="flex: 2;"> Add All Cards</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  document.getElementById('bulkEnglish').addEventListener('input', previewBulkCards);
  document.getElementById('bulkKorean').addEventListener('input', previewBulkCards);
}

function previewBulkCards() {
  const englishLines = document.getElementById('bulkEnglish').value.split('\n').map(l => l.trim()).filter(l => l);
  const koreanLines = document.getElementById('bulkKorean').value.split('\n').map(l => l.trim()).filter(l => l);

  const previewDiv = document.getElementById('bulkPreview');
  const previewList = document.getElementById('previewList');
  const previewCount = document.getElementById('previewCount');

  if (englishLines.length === 0 && koreanLines.length === 0) {
    previewDiv.style.display = 'none';
    return;
  }

  const maxLines = Math.max(englishLines.length, koreanLines.length);
  let html = '<table style="width: 100%; border-collapse: collapse;">';
  html += '<tr style="color: #718096; font-size: 11px;"><th style="text-align: left; padding: 2px 5px;">#</th><th style="text-align: left; padding: 2px 5px;">English</th><th style="text-align: left; padding: 2px 5px;">Korean</th><th style="padding: 2px 5px;">Status</th></tr>';

  let validCount = 0;
  for (let i = 0; i < maxLines; i++) {
    const eng = englishLines[i] || '';
    const kor = koreanLines[i] || '';
    const isValid = eng && kor;
    if (isValid) validCount++;

    const statusIcon = isValid ? '' : '';
    const rowStyle = isValid ? '' : 'background: #fff5f5;';

    html += `<tr style="${rowStyle}">
      <td style="padding: 3px 5px; color: #a0aec0;">${i + 1}</td>
      <td style="padding: 3px 5px;">${eng || '<span style="color: #e53e3e; font-style: italic;">missing</span>'}</td>
      <td style="padding: 3px 5px;">${kor || '<span style="color: #e53e3e; font-style: italic;">missing</span>'}</td>
      <td style="padding: 3px 5px; text-align: center;">${statusIcon}</td>
    </tr>`;
  }
  html += '</table>';

  if (englishLines.length !== koreanLines.length) {
    html += `<div style="color: #c53030; font-size: 11px; margin-top: 8px;"> Column mismatch: ${englishLines.length} English vs ${koreanLines.length} Korean lines</div>`;
  }

  previewList.innerHTML = html;
  previewCount.textContent = validCount;
  previewDiv.style.display = 'block';
}

async function addBulkCards() {
  const englishLines = document.getElementById('bulkEnglish').value.split('\n').map(l => l.trim()).filter(l => l);
  const koreanLines = document.getElementById('bulkKorean').value.split('\n').map(l => l.trim()).filter(l => l);
  const folderId = document.getElementById('newCardFolder').value;

  if (!folderId) { alert('Please select a folder'); return; }

  const pairs = [];
  const maxLines = Math.max(englishLines.length, koreanLines.length);
  for (let i = 0; i < maxLines; i++) {
    const eng = englishLines[i] || '';
    const kor = koreanLines[i] || '';
    if (eng && kor) {
      pairs.push({ english: eng, korean: kor });
    }
  }

  if (pairs.length === 0) {
    alert('No valid card pairs found. Make sure both columns have matching entries.');
    return;
  }

  const currentCount = myFlashcardsData.filter(c => c.folderId === folderId).length;
  const availableSlots = 100 - currentCount;

  if (pairs.length > availableSlots) {
    alert(`This folder can only hold ${availableSlots} more cards (${currentCount}/100 used). You're trying to add ${pairs.length} cards.`);
    return;
  }

  try {
    const addBtn = document.querySelector('#addCardModal .btn:last-child');
    addBtn.disabled = true;
    addBtn.innerHTML = ' Adding cards...';

    const batch = db.batch();

    pairs.forEach(pair => {
      const docRef = db.collection('studentFlashcards').doc();
      batch.set(docRef, {
        korean: pair.korean,
        english: pair.english,
        exampleSentence: null,
        image: null,
        audio: null,
        folderId: folderId,
        studentId: currentUser.uid,
        leitnerBox: 1,
        correctCount: 0,
        incorrectCount: 0,
        lastStudied: null,
        nextReviewDate: new Date(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    const folderRef = db.collection('studentFolders').doc(folderId);
    batch.update(folderRef, { cardCount: firebase.firestore.FieldValue.increment(pairs.length) });

    await batch.commit();

    closeFlashcardModal('addCardModal');
    loadMyFlashcards();
    alert(`Successfully added ${pairs.length} cards!`);

    if (myCardsSyncedToGames) {
      await autoSyncMyCardsToGames();
    }
  } catch (error) {
    alert('Error adding cards: ' + error.message);
  }
}

function openEditCardModal(cardId) {
  const card = myFlashcardsData.find(c => c.id === cardId);
  if (!card) return;

  const modalHtml = `
    <div class="flashcard-modal" id="editCardModal" onclick="if(event.target === this) closeFlashcardModal('editCardModal')">
      <div class="flashcard-modal-content">
        <button class="close-modal" onclick="closeFlashcardModal('editCardModal')"></button>
        <h3> Edit Card</h3>
        <input type="hidden" id="editCardId" value="${cardId}">
        <div class="form-group"><label>Korean Word/Phrase *</label><input type="text" id="editCardKorean" value="${card.korean || ''}"></div>
        <div class="form-group"><label>English Translation *</label><input type="text" id="editCardEnglish" value="${card.english || ''}"></div>
        <div class="form-group"><label>Example Sentence (optional)</label><input type="text" id="editCardExample" value="${card.exampleSentence || ''}"></div>
        <div class="form-group"><label>Image URL (optional)</label><input type="url" id="editCardImage" value="${card.image || ''}"></div>
        <div class="form-group"><label>Audio URL (optional)</label><input type="url" id="editCardAudio" value="${card.audio || ''}"></div>
        <div class="form-group"><label>Move to Folder</label>
          <select id="editCardFolder">
            ${myFoldersData.map(f => {
              const count = myFlashcardsData.filter(c => c.folderId === f.id).length;
              const isCurrent = f.id === card.folderId;
              return `<option value="${f.id}" ${isCurrent ? 'selected' : ''} ${count >= 100 && !isCurrent ? 'disabled' : ''}>${f.name} (${count}/100)</option>`;
            }).join('')}
          </select>
        </div>
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-top: 15px;">
          <div style="font-size: 12px; color: #718096;"> Stats: Box ${card.leitnerBox || 1} |  ${card.correctCount || 0} |  ${card.incorrectCount || 0}</div>
        </div>
        <button onclick="saveEditedCard()" class="btn" style="width: 100%; margin-top: 15px;"> Save Changes</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function saveEditedCard() {
  const cardId = document.getElementById('editCardId').value;
  const korean = document.getElementById('editCardKorean').value.trim();
  const english = document.getElementById('editCardEnglish').value.trim();
  const example = document.getElementById('editCardExample').value.trim();
  const image = document.getElementById('editCardImage').value.trim();
  const audio = document.getElementById('editCardAudio').value.trim();
  const folderId = document.getElementById('editCardFolder').value;

  if (!korean || !english) { alert('Please enter both Korean and English'); return; }

  try {
    const card = myFlashcardsData.find(c => c.id === cardId);
    const oldFolderId = card?.folderId;

    await db.collection('studentFlashcards').doc(cardId).update({
      korean, english, exampleSentence: example || null, image: image || null, audio: audio || null, folderId,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (oldFolderId !== folderId) {
      if (oldFolderId) await db.collection('studentFolders').doc(oldFolderId).update({ cardCount: firebase.firestore.FieldValue.increment(-1) });
      await db.collection('studentFolders').doc(folderId).update({ cardCount: firebase.firestore.FieldValue.increment(1) });
    }
    closeFlashcardModal('editCardModal');
    loadMyFlashcards();

    if (myCardsSyncedToGames) {
      await autoSyncMyCardsToGames();
    }
  } catch (error) { alert('Error saving card: ' + error.message); }
}

async function deleteMyCard(cardId) {
  if (!confirm('Delete this card?')) return;
  try {
    const card = myFlashcardsData.find(c => c.id === cardId);
    await db.collection('studentFlashcards').doc(cardId).delete();
    if (card?.folderId) await db.collection('studentFolders').doc(card.folderId).update({ cardCount: firebase.firestore.FieldValue.increment(-1) });
    loadMyFlashcards();

    if (myCardsSyncedToGames) {
      await autoSyncMyCardsToGames();
    }
  } catch (error) { alert('Error deleting card: ' + error.message); }
}


/**
 * Main sync function - syncs all My Cards folders to Flashcard Games
 * Called when user clicks "Sync to Games" button
 */
async function syncMyCardsToGames() {
  if (!currentUser) return;

  const modal = document.getElementById('syncProgressModal');
  modal.style.display = 'flex';

  const progressBar = document.getElementById('syncProgressBar');
  const progressText = document.getElementById('syncProgressText');
  const progressCount = document.getElementById('syncProgressCount');

  try {
    const foldersToSync = myFoldersData.filter(folder => {
      const cards = myFlashcardsData.filter(c => c.folderId === folder.id);
      return cards.some(c => c.korean && c.english);
    });

    if (foldersToSync.length === 0) {
      progressText.textContent = 'No folders with valid cards to sync.';
      setTimeout(() => { modal.style.display = 'none'; }, 2000);
      return;
    }

    let totalCards = 0;

    for (let i = 0; i < foldersToSync.length; i++) {
      const folder = foldersToSync[i];
      const cards = myFlashcardsData.filter(c =>
        c.folderId === folder.id && c.korean && c.english
      );

      progressText.textContent = `Syncing "${folder.name}"...`;
      progressCount.textContent = `${i + 1} of ${foldersToSync.length}`;
      progressBar.style.width = `${((i + 1) / foldersToSync.length) * 100}%`;

      await db.collection('studentFolders').doc(folder.id).update({
        syncedToGames: true,
        syncedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      totalCards += cards.length;
    }

    myCardsSyncedToGames = true;

    progressText.textContent = 'Sync complete!';
    progressBar.style.width = '100%';

    setTimeout(() => {
      modal.style.display = 'none';
      showToast(` Synced ${foldersToSync.length} folders with ${totalCards} cards to Flashcard Games`);
      loadMyFlashcards();
    }, 1000);

  } catch (error) {
    progressText.textContent = 'Error: ' + error.message;
    setTimeout(() => { modal.style.display = 'none'; }, 3000);
  }
}

/**
 * Auto-sync function - called automatically when cards/folders are modified
 * Only runs if initial sync has been done
 */
async function autoSyncMyCardsToGames() {
  if (!currentUser || !myCardsSyncedToGames) return;

  try {
    const foldersToSync = myFoldersData.filter(folder => {
      const cards = myFlashcardsData.filter(c => c.folderId === folder.id);
      return cards.some(c => c.korean && c.english);
    });

    const batch = db.batch();

    for (const folder of foldersToSync) {
      if (!folder.syncedToGames) {
        const folderRef = db.collection('studentFolders').doc(folder.id);
        batch.update(folderRef, {
          syncedToGames: true,
          syncedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    const foldersToUnsync = myFoldersData.filter(folder => {
      const cards = myFlashcardsData.filter(c => c.folderId === folder.id);
      const hasValidCards = cards.some(c => c.korean && c.english);
      return folder.syncedToGames && !hasValidCards;
    });

    for (const folder of foldersToUnsync) {
      const folderRef = db.collection('studentFolders').doc(folder.id);
      batch.update(folderRef, {
        syncedToGames: false
      });
    }

    await batch.commit();

  } catch (error) {
  }
}

/**
 * Check if sync state exists on load
 */
async function checkMyCardsSyncState() {
  if (!currentUser) return;

  try {
    const syncedFoldersSnap = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('syncedToGames', '==', true)
      .limit(1)
      .get();

    if (!syncedFoldersSnap.empty) {
      myCardsSyncedToGames = true;
    }
  } catch (error) {
  }
}

/**
 * Start flashcard game with My Cards folder
 * This creates a virtual flashcard set from the folder's cards
 */
async function startMyCardsFlashcardGame(sourceFolderId) {
  try {
    const flashcardGamesTab = document.getElementById('flashcardGames');
    if (flashcardGamesTab && !flashcardGamesTab.classList.contains('active')) {
      flashcardGamesTab.classList.add('active');
    }

    let folder = myFoldersData.find(f => f.id === sourceFolderId);
    if (!folder) {
      const folderDoc = await db.collection('studentFolders').doc(sourceFolderId).get();
      if (!folderDoc.exists) {
        alert('Folder not found');
        return;
      }
      folder = { id: folderDoc.id, ...folderDoc.data() };
    }

    const cardsSnapshot = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('folderId', '==', sourceFolderId)
      .get();

    const cards = [];
    cardsSnapshot.forEach(doc => {
      const card = doc.data();
      if (card.korean && card.english) {
        cards.push({
          id: doc.id,
          english: card.english,
          korean: card.korean,
          audioUrl: card.audio || null,
          imageUrl: card.image || null,
          aiData: card.aiData || null
        });
      }
    });

    if (cards.length < 5) {
      alert(`Unable to start game. This folder has only ${cards.length} valid cards.\n\nMinimum required: 5 cards with both Korean and English.`);
      return;
    }

    const folderName = folder?.name || 'My Cards';
    currentFlashcardSet = {
      id: `mycards_${sourceFolderId}`,
      title: folderName,
      wordPairs: cards,
      timerSeconds: 15,
      isMyCardsSet: true,
      sourceFolderId: sourceFolderId,
      assets: null
    };

    currentFlashcardSet.wordPairs = shuffleArray([...currentFlashcardSet.wordPairs]);

    currentSetIndex = 0;
    gameResults = [];
    missedWords = [];

    currentGameAssets = getEffectiveGameAssets(null);
    correctStreakInSet = 0;
    currentSetCorrectCount = 0;
    totalGameCorrect = 0;
    totalGameWords = 0;

    initializeSpeechRecognition();

    showJunbiPage();

  } catch (error) {
    alert('Error starting game: ' + error.message);
  }
}

/**
 * Check for duplicate Korean word in Leitner box (case-insensitive)
 */
async function isWordInLeitnerBox(koreanWord) {
  if (!currentUser || !koreanWord) return false;

  const normalizedKorean = koreanWord.toLowerCase().trim();

  const existingCard = leitnerCards.find(card =>
    card.korean && card.korean.toLowerCase().trim() === normalizedKorean
  );

  return !!existingCard;
}

/**
 * Add card to Leitner box with duplicate checking
 * Modified version that checks for duplicates before adding
 */
async function addCardToLeitnerBoxWithDupeCheck(cardData, setId) {
  if (!currentUser) return;

  const isDuplicate = await isWordInLeitnerBox(cardData.korean);

  if (isDuplicate) {
    return false; // Indicate card was not added (duplicate)
  }

  await addCardToLeitnerBox(cardData, setId);
  return true; // Indicate card was added
}

function openBulkImportModal() {
  if (selectedFolderId === 'all') { alert('Please select a folder first'); return; }
  const folder = myFoldersData.find(f => f.id === selectedFolderId);
  const cardCount = myFlashcardsData.filter(c => c.folderId === selectedFolderId).length;
  const remaining = 100 - cardCount;
  if (remaining <= 0) { alert('This folder has reached the maximum of 100 cards.'); return; }

  const modalHtml = `
    <div class="flashcard-modal" id="bulkImportModal" onclick="if(event.target === this) closeFlashcardModal('bulkImportModal')">
      <div class="flashcard-modal-content" style="max-width: 700px;">
        <button class="close-modal" onclick="closeFlashcardModal('bulkImportModal')"></button>
        <h3> Bulk Import Cards</h3>
        <p style="color: #718096; margin-bottom: 15px;">Import up to <strong>${remaining}</strong> more cards to "${folder?.name}".</p>
        <div class="form-group">
          <label>Paste your cards (Korean, English - one per line)</label>
          <textarea id="bulkImportText" rows="10" placeholder=", Hello&#10;, Thank you"></textarea>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="previewBulkImport()" class="btn btn-secondary" style="flex: 1;"> Preview</button>
          <button onclick="executeBulkImport()" class="btn" style="flex: 1;"> Import</button>
        </div>
        <div id="bulkImportPreview" style="display: none; margin-top: 15px;">
          <h4>Preview (<span id="bulkPreviewCount">0</span> cards)</h4>
          <div id="bulkPreviewList" style="max-height: 150px; overflow-y: auto; background: #f7fafc; padding: 10px; border-radius: 8px; margin-top: 10px;"></div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function previewBulkImport() {
  const text = document.getElementById('bulkImportText').value;
  const lines = text.trim().split('\n').filter(l => l.trim());
  const cardCount = myFlashcardsData.filter(c => c.folderId === selectedFolderId).length;
  const maxToAdd = 100 - cardCount;

  const parsed = [];
  lines.forEach(line => {
    let parts = line.includes('\t') ? line.split('\t') : line.includes('|') ? line.split('|') : line.split(',');
    if (parts.length >= 2) {
      parsed.push({ korean: parts[0].trim(), english: parts.slice(1).join(',').trim() });
    }
  });

  const toAdd = parsed.slice(0, maxToAdd);
  document.getElementById('bulkPreviewCount').textContent = toAdd.length;
  document.getElementById('bulkPreviewList').innerHTML = toAdd.map(c =>
    `<div style="padding: 5px; border-bottom: 1px solid #e2e8f0;"><strong>${c.korean}</strong>  ${c.english}</div>`
  ).join('');
  document.getElementById('bulkImportPreview').style.display = 'block';
}

async function executeBulkImport() {
  const text = document.getElementById('bulkImportText').value;
  const lines = text.trim().split('\n').filter(l => l.trim());
  const cardCount = myFlashcardsData.filter(c => c.folderId === selectedFolderId).length;
  const maxToAdd = 100 - cardCount;

  const parsed = [];
  lines.forEach(line => {
    let parts = line.includes('\t') ? line.split('\t') : line.includes('|') ? line.split('|') : line.split(',');
    if (parts.length >= 2) parsed.push({ korean: parts[0].trim(), english: parts.slice(1).join(',').trim() });
  });

  const toAdd = parsed.slice(0, maxToAdd);
  if (toAdd.length === 0) { alert('No valid cards to import'); return; }

  try {
    const batch = db.batch();
    toAdd.forEach(card => {
      const ref = db.collection('studentFlashcards').doc();
      batch.set(ref, {
        korean: card.korean, english: card.english, folderId: selectedFolderId,
        studentId: currentUser.uid, leitnerBox: 1, correctCount: 0, incorrectCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await batch.commit();
    await db.collection('studentFolders').doc(selectedFolderId).update({ cardCount: firebase.firestore.FieldValue.increment(toAdd.length) });
    closeFlashcardModal('bulkImportModal');
    loadMyFlashcards();
    alert(`Successfully imported ${toAdd.length} cards!`);
  } catch (error) { alert('Error importing cards: ' + error.message); }
}


async function loadMarketplace(sortBy = 'popular') {
  const container = sortBy === 'popular' ? document.getElementById('marketplaceGrid') : document.getElementById('marketplaceNewestGrid');
  if (!container) return;

  container.innerHTML = '<div style="text-align: center; padding: 60px; color: #a0aec0;">Loading...</div>';

  try {
    let query = db.collection('studentFolders').where('isPublic', '==', true);
    const snapshot = await query.get();

    marketplaceData = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.studentId !== currentUser.uid) { // Don't show own sets
        marketplaceData.push({ id: doc.id, ...data });
      }
    });

    if (sortBy === 'popular') {
      marketplaceData.sort((a, b) => (b.downloads || 0) - (a.downloads || 0));
    } else {
      marketplaceData.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
    }

    renderMarketplace(container);
    updateMarketplaceBalance();
    loadCategoryCounts();
  } catch (error) {
    container.innerHTML = `<div style="color: #e53e3e;">Error loading marketplace</div>`;
  }
}

function renderMarketplace(container) {
  if (marketplaceData.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px; color: #a0aec0; background: white; border-radius: 16px;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>No flashcard sets available yet.</p>
        <p style="font-size: 13px;">Be the first to publish!</p>
      </div>
    `;
    return;
  }

  let html = '';
  marketplaceData.forEach(set => {
    const cat = FLASHCARD_CATEGORIES[set.category] || FLASHCARD_CATEGORIES.other;
    const stars = set.avgRating ? ''.repeat(Math.round(set.avgRating)) : 'No ratings';

    html += `
      <div class="marketplace-set-card">
        <div class="set-header">
          <div>
            <h4 class="set-title">${cat.icon} ${set.name}</h4>
            <p class="set-creator">by @${set.studentName || 'Anonymous'}</p>
          </div>
          <div class="set-price">${set.price || 10} </div>
        </div>
        <p class="set-description">${set.description || 'No description provided.'}</p>
        <div class="set-stats">
          <span class="set-stat"> ${set.cardCount || 0} cards</span>
          <span class="set-stat"> ${set.downloads || 0} downloads</span>
          <span class="set-rating">${stars}</span>
        </div>
        <span class="set-category" style="background: ${cat.color}20; color: ${cat.color};">${cat.name}</span>
        <div class="set-actions">
          <button class="preview-btn" onclick="previewMarketplaceSet('${set.id}')"> Preview</button>
          <button class="buy-btn" onclick="purchaseSet('${set.id}')"> Get for ${set.price || 10} </button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

async function updateMarketplaceBalance() {
  const el = document.getElementById('marketplaceBalance');
  if (!el || !currentUser) return;

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const coins = userDoc.data()?.coins || 0;
    el.textContent = coins;
  } catch (error) {
  }
}

async function loadCategoryCounts() {
  const counts = {};
  marketplaceData.forEach(set => {
    const cat = set.category || 'other';
    counts[cat] = (counts[cat] || 0) + 1;
  });

  Object.keys(FLASHCARD_CATEGORIES).forEach(key => {
    const el = document.getElementById('catCount' + key.charAt(0).toUpperCase() + key.slice(1));
    if (el) el.textContent = `${counts[key] || 0} sets`;
  });
}

async function previewMarketplaceSet(setId) {
  const set = marketplaceData.find(s => s.id === setId);
  if (!set) return;

  try {
    const cardsSnapshot = await db.collection('studentFlashcards')
      .where('folderId', '==', setId)
      .limit(5)
      .get();

    let previewCards = [];
    cardsSnapshot.forEach(doc => previewCards.push(doc.data()));

    const cat = FLASHCARD_CATEGORIES[set.category] || FLASHCARD_CATEGORIES.other;

    const modalHtml = `
      <div class="flashcard-modal" id="previewSetModal" onclick="if(event.target === this) closeFlashcardModal('previewSetModal')">
        <div class="flashcard-modal-content">
          <button class="close-modal" onclick="closeFlashcardModal('previewSetModal')"></button>
          <h3>${cat.icon} ${set.name}</h3>
          <p style="color: #718096; margin-bottom: 15px;">by @${set.studentName || 'Anonymous'}</p>
          <p style="margin-bottom: 20px;">${set.description || 'No description.'}</p>

          <h4 style="margin-bottom: 10px;">Preview Cards (${previewCards.length} of ${set.cardCount || 0})</h4>
          <div class="preview-cards-grid">
            ${previewCards.map(c => `
              <div class="preview-card-mini">
                <div class="korean">${c.korean}</div>
                <div class="english">${c.english}</div>
              </div>
            `).join('')}
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closeFlashcardModal('previewSetModal')" class="btn btn-secondary" style="flex: 1;">Close</button>
            <button onclick="closeFlashcardModal('previewSetModal'); purchaseSet('${setId}')" class="btn" style="flex: 1;"> Get for ${set.price || 10} </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  } catch (error) {
    alert('Error loading preview: ' + error.message);
  }
}

async function purchaseSet(setId) {
  const set = marketplaceData.find(s => s.id === setId);
  if (!set) return;

  const existingFolder = myFoldersData.find(f => f.copiedFrom === setId);
  if (existingFolder) {
    alert('You already own this set!');
    return;
  }

  const userDoc = await db.collection('users').doc(currentUser.uid).get();
  const currentCoins = userDoc.data()?.coins || 0;

  if (currentCoins < (set.price || 10)) {
    alert(`Not enough coins! You need ${set.price || 10} coins but only have ${currentCoins}.`);
    return;
  }

  if (!confirm(`Purchase "${set.name}" for ${set.price || 10} coins?`)) return;

  try {
    await db.collection('users').doc(currentUser.uid).update({
      coins: firebase.firestore.FieldValue.increment(-(set.price || 10))
    });

    await db.collection('users').doc(set.studentId).update({
      coins: firebase.firestore.FieldValue.increment(set.price || 10)
    });

    const newFolderRef = await db.collection('studentFolders').add({
      name: set.name,
      category: set.category,
      description: set.description,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      studentName: currentUser.displayName || currentUser.email,
      cardCount: 0,
      isPublic: false, // Purchased sets cannot be republished
      copiedFrom: setId,
      originalCreator: set.studentName,
      originalCreatorId: set.studentId,
      purchasedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const cardsSnapshot = await db.collection('studentFlashcards')
      .where('folderId', '==', setId)
      .get();

    const batch = db.batch();
    let cardCount = 0;
    cardsSnapshot.forEach(doc => {
      const cardData = doc.data();
      const newCardRef = db.collection('studentFlashcards').doc();
      batch.set(newCardRef, {
        korean: cardData.korean,
        english: cardData.english,
        exampleSentence: cardData.exampleSentence || null,
        image: cardData.image || null,
        audio: cardData.audio || null,
        folderId: newFolderRef.id,
        studentId: currentUser.uid,
        leitnerBox: 1,
        correctCount: 0,
        incorrectCount: 0,
        copiedFrom: doc.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      cardCount++;
    });
    await batch.commit();

    await db.collection('studentFolders').doc(newFolderRef.id).update({ cardCount });

    await db.collection('studentFolders').doc(setId).update({
      downloads: firebase.firestore.FieldValue.increment(1),
      totalEarnings: firebase.firestore.FieldValue.increment(set.price || 10)
    });

    await db.collection('purchases').add({
      buyerId: currentUser.uid,
      buyerEmail: currentUser.email,
      sellerId: set.studentId,
      folderId: setId,
      newFolderId: newFolderRef.id,
      price: set.price || 10,
      purchasedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert(`Successfully purchased "${set.name}"! Check your My Flashcards.`);
    loadMyFlashcards();
    updateMarketplaceBalance();

  } catch (error) {
    alert('Error purchasing set: ' + error.message);
  }
}

function switchMarketplaceTab(tab) {
  document.querySelectorAll('.marketplace-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');

  if (tab === 'popular') {
    loadMarketplace('popular');
  } else {
    loadMarketplace('newest');
  }
}

function browseCategory(category) {
  switchTab('marketplacePopular');
  document.getElementById('marketplaceCategory').value = category;
  filterMarketplace();
}

function filterMarketplace() {
  const category = document.getElementById('marketplaceCategory')?.value || 'all';
  const container = document.getElementById('marketplaceGrid');

  let filtered = marketplaceData;
  if (category !== 'all') {
    filtered = marketplaceData.filter(s => s.category === category);
  }

  if (filtered.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px; color: #a0aec0; background: white; border-radius: 16px;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>No sets found in this category.</p>
      </div>
    `;
  } else {
    const originalData = marketplaceData;
    marketplaceData = filtered;
    renderMarketplace(container);
    marketplaceData = originalData;
  }
}

function searchMarketplace() {
  const term = document.getElementById('marketplaceSearch')?.value?.toLowerCase() || '';
  const container = document.getElementById('marketplaceGrid');

  let filtered = marketplaceData.filter(s =>
    (s.name || '').toLowerCase().includes(term) ||
    (s.description || '').toLowerCase().includes(term) ||
    (s.studentName || '').toLowerCase().includes(term)
  );

  const originalData = marketplaceData;
  marketplaceData = filtered;
  renderMarketplace(container);
  marketplaceData = originalData;
}

async function loadMyPurchases() {
  const container = document.getElementById('myPurchasesList');
  if (!container) return;

  try {
    const purchasedFolders = myFoldersData.filter(f => f.copiedFrom);

    if (purchasedFolders.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px; color: #a0aec0; background: white; border-radius: 16px;">
          <div style="font-size: 48px; margin-bottom: 15px;"></div>
          <p>No purchases yet.</p>
          <button onclick="switchTab('marketplacePopular')" class="btn" style="margin-top: 15px;">Browse Marketplace</button>
        </div>
      `;
      return;
    }

    let html = '';
    purchasedFolders.forEach(folder => {
      const cardCount = myFlashcardsData.filter(c => c.folderId === folder.id).length;
      html += `
        <div class="purchase-card">
          <div class="purchase-info">
            <h4> ${folder.name}</h4>
            <p>from @${folder.originalCreator || 'Unknown'}  ${cardCount} cards</p>
          </div>
          <div class="purchase-meta">
            <button onclick="selectMyFolder('${folder.id}'); switchTab('myFlashcards')" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">View Cards</button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  } catch (error) {
  }
}

async function loadCreatorProfile() {
  if (!currentUser) return;

  const nameEl = document.getElementById('creatorDisplayName');
  if (nameEl) nameEl.textContent = currentUser.displayName || currentUser.email;

  const publishedSets = myFoldersData.filter(f => f.isPublic && !f.copiedFrom);
  const totalDownloads = publishedSets.reduce((sum, f) => sum + (f.downloads || 0), 0);
  const totalEarnings = publishedSets.reduce((sum, f) => sum + (f.totalEarnings || 0), 0);

  const setsEl = document.getElementById('creatorSetsPublished');
  const downloadsEl = document.getElementById('creatorTotalDownloads');
  const earningsEl = document.getElementById('creatorTotalEarnings');

  if (setsEl) setsEl.textContent = publishedSets.length;
  if (downloadsEl) downloadsEl.textContent = totalDownloads;
  if (earningsEl) earningsEl.textContent = totalEarnings + ' ';

  const listContainer = document.getElementById('myPublishedSetsList');
  if (!listContainer) return;

  if (publishedSets.length === 0) {
    listContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #a0aec0;">
        <div style="font-size: 48px; margin-bottom: 15px;"></div>
        <p>You haven't published any sets yet.</p>
        <p style="font-size: 13px;">Make a folder public to start earning coins!</p>
      </div>
    `;
    return;
  }

  let html = '';
  publishedSets.forEach(set => {
    const cat = FLASHCARD_CATEGORIES[set.category] || FLASHCARD_CATEGORIES.other;
    html += `
      <div style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h4 style="margin: 0 0 5px 0;">${cat.icon} ${set.name}</h4>
          <p style="margin: 0; font-size: 12px; color: #718096;">${set.cardCount || 0} cards  ${set.price || 10} </p>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 18px; font-weight: bold; color: #667eea;"> ${set.downloads || 0}</div>
          <div style="font-size: 12px; color: #48bb78;">+${set.totalEarnings || 0} </div>
        </div>
      </div>
    `;
  });
  listContainer.innerHTML = html;
}

function updateStudyPreview() {
  const folderId = document.getElementById('studyFolderSelect')?.value || 'all';

  let cards = [];
  if (folderId === 'all') {
    cards = myFlashcardsData;
  } else if (folderId === 'due') {
    const now = new Date();
    cards = myFlashcardsData.filter(c => !c.nextReviewDate || new Date(c.nextReviewDate.toDate?.() || c.nextReviewDate) <= now);
  } else {
    cards = myFlashcardsData.filter(c => c.folderId === folderId);
  }

  document.getElementById('studyCardCount').textContent = `${cards.length} cards to study`;

  for (let i = 1; i <= 5; i++) {
    const count = cards.filter(c => (c.leitnerBox || 1) === i).length;
    const el = document.getElementById('studyBox' + i);
    if (el) el.textContent = count;
  }
}

let myCardsStudyState = {
  cards: [],
  currentIndex: 0,
  direction: 'kr-en',
  mode: 'voice',
  correctCount: 0,
  incorrectCount: 0,
  isFlipped: false,
  recognition: null,
  timer: null,
  timerSeconds: 10
};

function startMyCardsStudy() {
  const folderId = document.getElementById('studyFolderSelect')?.value || 'all';
  const direction = document.querySelector('input[name="studyDirection"]:checked')?.value || 'kr-en';
  const mode = document.getElementById('studyModeSelect')?.value || 'voice';

  let cards = [];
  if (folderId === 'all') {
    cards = [...myFlashcardsData];
  } else if (folderId === 'due') {
    const now = new Date();
    cards = myFlashcardsData.filter(c => !c.nextReviewDate || new Date(c.nextReviewDate.toDate?.() || c.nextReviewDate) <= now);
  } else {
    cards = myFlashcardsData.filter(c => c.folderId === folderId);
  }

  if (cards.length === 0) {
    alert('No cards to study!');
    return;
  }

  cards = cards.sort(() => Math.random() - 0.5);

  myCardsStudyState = {
    cards: cards,
    currentIndex: 0,
    direction: direction,
    mode: mode,
    correctCount: 0,
    incorrectCount: 0,
    isFlipped: false,
    recognition: null,
    timer: null,
    timerSeconds: 10
  };

  document.querySelectorAll('#myFlashcardsStudy > div:not(#myCardsStudyInterface)').forEach(el => {
    if (!el.matches('h2')) el.style.display = 'none';
  });
  document.getElementById('myCardsStudyInterface').style.display = 'block';

  showMyCardsNextCard();
}

function exitMyCardsStudy() {
  stopMyCardsRecognition();
  stopMyCardsTimer();

  document.getElementById('myCardsStudyInterface').style.display = 'none';
  document.querySelectorAll('#myFlashcardsStudy > div').forEach(el => {
    el.style.display = '';
  });
}

function showMyCardsNextCard() {
  const state = myCardsStudyState;

  stopMyCardsTimer();
  stopMyCardsRecognition();

  if (state.currentIndex >= state.cards.length) {
    showMyCardsSessionComplete();
    return;
  }

  const card = state.cards[state.currentIndex];
  state.isFlipped = false;

  document.getElementById('myCardsStudyProgress').textContent = `${state.currentIndex + 1} / ${state.cards.length}`;
  document.getElementById('myCardsStudyProgressBar').style.width = `${((state.currentIndex) / state.cards.length) * 100}%`;
  document.getElementById('myCardsStudyScore').textContent = ` ${state.correctCount} |  ${state.incorrectCount}`;

  let question, answer;
  if (state.direction === 'kr-en') {
    question = card.korean;
    answer = card.english;
    document.getElementById('myCardsPromptLabel').textContent = 'What does this mean?';
  } else {
    question = card.english;
    answer = card.korean;
    document.getElementById('myCardsPromptLabel').textContent = 'Say this in Korean:';
  }

  document.getElementById('myCardsCardQuestion').textContent = question;
  document.getElementById('myCardsCardAnswer').textContent = answer;

  document.getElementById('myCardsCardFront').style.display = 'block';
  document.getElementById('myCardsCardBack').style.display = 'none';
  document.getElementById('myCardsFlashcard').style.borderColor = '#e2e8f0';

  document.getElementById('myCardsAnswerButtons').style.display = 'none';
  document.getElementById('myCardsVoiceStatus').style.display = 'none';
  document.getElementById('myCardsMultipleChoice').style.display = 'none';
  document.getElementById('myCardsStudyTimer').style.display = 'none';
  document.getElementById('myCardsRecognizedText').textContent = '';

  if (state.mode === 'voice') {
    document.getElementById('myCardsVoiceStatus').style.display = 'block';
    document.getElementById('myCardsStudyTimer').style.display = 'block';
    startMyCardsTimer();
    startMyCardsRecognition();
  } else if (state.mode === 'flip') {
  } else if (state.mode === 'quiz') {
    generateMyCardsMultipleChoice(card, answer);
  }
}

function flipMyCard() {
  const state = myCardsStudyState;

  if (state.isFlipped) return;

  state.isFlipped = true;

  stopMyCardsTimer();
  stopMyCardsRecognition();

  document.getElementById('myCardsCardFront').style.display = 'none';
  document.getElementById('myCardsCardBack').style.display = 'block';
  document.getElementById('myCardsFlashcard').style.borderColor = '#667eea';

  if (state.mode === 'flip' || state.mode === 'voice') {
    document.getElementById('myCardsAnswerButtons').style.display = 'block';
    document.getElementById('myCardsVoiceStatus').style.display = 'none';
  }
}

function submitMyCardAnswer(isCorrect) {
  const state = myCardsStudyState;
  const card = state.cards[state.currentIndex];

  if (isCorrect) {
    state.correctCount++;
    card.correctCount = (card.correctCount || 0) + 1;
    card.leitnerBox = Math.min((card.leitnerBox || 1) + 1, 5);
  } else {
    state.incorrectCount++;
    card.incorrectCount = (card.incorrectCount || 0) + 1;
    card.leitnerBox = Math.max((card.leitnerBox || 1) - 1, 1);
  }

  const daysUntilReview = [0, 1, 3, 7, 14, 30][card.leitnerBox] || 1;
  const nextReview = new Date();
  nextReview.setDate(nextReview.getDate() + daysUntilReview);
  card.nextReviewDate = nextReview;

  updateMyCardProgress(card);

  state.currentIndex++;
  showMyCardsNextCard();
}

function skipMyCard() {
  myCardsStudyState.currentIndex++;
  showMyCardsNextCard();
}

async function updateMyCardProgress(card) {
  try {
    await db.collection('studentFlashcards').doc(card.id).update({
      correctCount: card.correctCount,
      incorrectCount: card.incorrectCount,
      leitnerBox: card.leitnerBox,
      nextReviewDate: card.nextReviewDate,
      lastReviewDate: new Date()
    });

    const today = new Date();
    const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    await db.collection('studentFlashcardStats').doc(currentUser.uid).set({
      totalReviews: firebase.firestore.FieldValue.increment(1),
      [`reviewLog.${dateKey}`]: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });

  } catch (e) {
  }
}

function showMyCardsSessionComplete() {
  const state = myCardsStudyState;
  const total = state.correctCount + state.incorrectCount;
  const accuracy = total > 0 ? Math.round((state.correctCount / total) * 100) : 0;

  const interface = document.getElementById('myCardsStudyInterface');
  interface.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="font-size: 60px; margin-bottom: 20px;"></div>
      <h2 style="color: #2d3748; margin-bottom: 15px;">Session Complete!</h2>
      <p style="color: #718096; margin-bottom: 30px;">You studied ${state.cards.length} cards</p>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 400px; margin: 0 auto 30px;">
        <div style="background: #c6f6d5; padding: 20px; border-radius: 12px;">
          <div style="font-size: 28px; font-weight: bold; color: #276749;">${state.correctCount}</div>
          <div style="font-size: 12px; color: #22543d;">Correct</div>
        </div>
        <div style="background: #fed7d7; padding: 20px; border-radius: 12px;">
          <div style="font-size: 28px; font-weight: bold; color: #c53030;">${state.incorrectCount}</div>
          <div style="font-size: 12px; color: #9b2c2c;">Incorrect</div>
        </div>
        <div style="background: #bee3f8; padding: 20px; border-radius: 12px;">
          <div style="font-size: 28px; font-weight: bold; color: #2b6cb0;">${accuracy}%</div>
          <div style="font-size: 12px; color: #2c5282;">Accuracy</div>
        </div>
      </div>

      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="exitMyCardsStudy()" class="btn btn-secondary" style="padding: 12px 25px;">
           Back to Options
        </button>
        <button onclick="restartMyCardsStudy()" class="btn" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
           Study Again
        </button>
      </div>
    </div>
  `;
}

function restartMyCardsStudy() {
  const container = document.getElementById('myCardsStudyInterface');
  container.innerHTML = `
    <!-- Study Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <button onclick="exitMyCardsStudy()" class="btn btn-secondary" style="padding: 8px 16px;"> Exit Study</button>
      <div id="myCardsStudyProgress" style="font-size: 14px; color: #718096;">1 / 10</div>
      <div id="myCardsStudyScore" style="font-size: 14px; font-weight: 600;"> 0 |  0</div>
    </div>

    <!-- Progress Bar -->
    <div style="height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 20px; overflow: hidden;">
      <div id="myCardsStudyProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
    </div>

    <!-- Timer -->
    <div id="myCardsStudyTimer" style="display: none; margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <span style="font-size: 13px; color: #718096;"> Time</span>
        <span id="myCardsTimerText" style="font-size: 16px; font-weight: bold; color: #667eea;">10</span>
      </div>
      <div style="height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
        <div id="myCardsTimerBar" style="height: 100%; width: 100%; background: linear-gradient(90deg, #48bb78 0%, #667eea 100%); transition: width 0.1s linear;"></div>
      </div>
    </div>

    <!-- Flashcard -->
    <div id="myCardsFlashcard" style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 16px; padding: 40px; text-align: center; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 3px solid #e2e8f0; transition: all 0.3s;" onclick="flipMyCard()">
      <div id="myCardsCardFront">
        <div style="font-size: 14px; color: #718096; margin-bottom: 15px;" id="myCardsPromptLabel">Say this in Korean:</div>
        <div style="font-size: 36px; font-weight: bold; color: #2d3748;" id="myCardsCardQuestion">Loading...</div>
      </div>
      <div id="myCardsCardBack" style="display: none;">
        <div style="font-size: 14px; color: #718096; margin-bottom: 15px;">Answer:</div>
        <div style="font-size: 36px; font-weight: bold; color: #667eea;" id="myCardsCardAnswer">Answer</div>
      </div>
    </div>

    <!-- Voice Recognition Status -->
    <div id="myCardsVoiceStatus" style="display: none; text-align: center; margin: 20px 0;">
      <div class="listening-pulse" style="width: 50px; height: 50px; background: #48bb78; border-radius: 50%; margin: 0 auto 10px; animation: leitnerPulse 1.5s infinite;"></div>
      <div style="font-size: 14px; color: #48bb78;"> Listening...</div>
      <div id="myCardsRecognizedText" style="font-size: 18px; color: #2d3748; font-weight: 600; margin-top: 10px;"></div>
    </div>

    <!-- Multiple Choice Options -->
    <div id="myCardsMultipleChoice" style="display: none; margin-top: 20px;">
      <div id="myCardsChoices" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </div>

    <!-- Answer Buttons -->
    <div id="myCardsAnswerButtons" style="display: none; margin-top: 20px;">
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="submitMyCardAnswer(false)" class="btn" style="flex: 1; max-width: 200px; padding: 15px; background: #fed7d7; color: #c53030; font-size: 16px;">
           Wrong
        </button>
        <button onclick="submitMyCardAnswer(true)" class="btn" style="flex: 1; max-width: 200px; padding: 15px; background: #c6f6d5; color: #276749; font-size: 16px;">
           Correct
        </button>
      </div>
    </div>

    <!-- Skip Button -->
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="skipMyCard()" class="btn btn-secondary" style="padding: 8px 20px; font-size: 13px;">
        Skip 
      </button>
    </div>
  `;

  myCardsStudyState.cards = myCardsStudyState.cards.sort(() => Math.random() - 0.5);
  myCardsStudyState.currentIndex = 0;
  myCardsStudyState.correctCount = 0;
  myCardsStudyState.incorrectCount = 0;

  showMyCardsNextCard();
}

function startMyCardsTimer() {
  myCardsStudyState.timerSeconds = 10;
  updateMyCardsTimerDisplay();

  myCardsStudyState.timer = setInterval(() => {
    myCardsStudyState.timerSeconds--;
    updateMyCardsTimerDisplay();

    if (myCardsStudyState.timerSeconds <= 0) {
      stopMyCardsTimer();
      flipMyCard();
    }
  }, 1000);
}

function stopMyCardsTimer() {
  if (myCardsStudyState.timer) {
    clearInterval(myCardsStudyState.timer);
    myCardsStudyState.timer = null;
  }
}

function updateMyCardsTimerDisplay() {
  const timerText = document.getElementById('myCardsTimerText');
  const timerBar = document.getElementById('myCardsTimerBar');
  if (timerText) timerText.textContent = myCardsStudyState.timerSeconds;
  if (timerBar) timerBar.style.width = `${(myCardsStudyState.timerSeconds / 10) * 100}%`;
}

function startMyCardsRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  myCardsStudyState.recognition = new SpeechRecognition();
  myCardsStudyState.recognition.lang = myCardsStudyState.direction === 'en-kr' ? 'ko-KR' : 'en-US';
  myCardsStudyState.recognition.continuous = true;
  myCardsStudyState.recognition.interimResults = true;

  const card = myCardsStudyState.cards[myCardsStudyState.currentIndex];
  const expectedAnswer = myCardsStudyState.direction === 'kr-en' ? card.english : card.korean;

  myCardsStudyState.recognition.onresult = (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }

    document.getElementById('myCardsRecognizedText').textContent = transcript;

    const normalized = normalizeKoreanForVoice(transcript);
    const expected = normalizeKoreanForVoice(expectedAnswer);

    const similarity = calculateSimilarity(normalized, expected);
    if (similarity >= 0.90) {
      stopMyCardsRecognition();
      stopMyCardsTimer();

      document.getElementById('myCardsFlashcard').style.borderColor = '#48bb78';
      document.getElementById('myCardsVoiceStatus').innerHTML = `
        <div style="font-size: 40px; margin-bottom: 10px;"></div>
        <div style="font-size: 16px; color: #48bb78; font-weight: 600;">Correct!</div>
      `;

      setTimeout(() => {
        submitMyCardAnswer(true);
      }, 1000);
    }
  };

  myCardsStudyState.recognition.onerror = (event) => {
  };

  myCardsStudyState.recognition.start();
}

function stopMyCardsRecognition() {
  if (myCardsStudyState.recognition) {
    try {
      myCardsStudyState.recognition.stop();
    } catch (e) {}
    myCardsStudyState.recognition = null;
  }
}

function generateMyCardsMultipleChoice(currentCard, correctAnswer) {
  const choices = [correctAnswer];
  const allAnswers = myCardsStudyState.cards.map(c =>
    myCardsStudyState.direction === 'kr-en' ? c.english : c.korean
  ).filter(a => a !== correctAnswer);

  while (choices.length < 4 && allAnswers.length > 0) {
    const randomIndex = Math.floor(Math.random() * allAnswers.length);
    choices.push(allAnswers.splice(randomIndex, 1)[0]);
  }

  choices.sort(() => Math.random() - 0.5);

  const choicesContainer = document.getElementById('myCardsChoices');
  choicesContainer.innerHTML = choices.map(choice => `
    <button onclick="selectMyCardsChoice(this, '${choice.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')"
            class="btn" style="padding: 15px; background: white; border: 2px solid #e2e8f0; color: #2d3748; font-size: 14px; text-align: left;">
      ${choice}
    </button>
  `).join('');

  document.getElementById('myCardsMultipleChoice').style.display = 'block';
}

function selectMyCardsChoice(btn, selected, correct) {
  const isCorrect = selected === correct;

  document.querySelectorAll('#myCardsChoices button').forEach(b => {
    b.disabled = true;
    if (b.textContent.trim() === correct) {
      b.style.background = '#c6f6d5';
      b.style.borderColor = '#48bb78';
    }
  });

  if (isCorrect) {
    btn.style.background = '#c6f6d5';
    btn.style.borderColor = '#48bb78';
  } else {
    btn.style.background = '#fed7d7';
    btn.style.borderColor = '#c53030';
  }

  setTimeout(() => {
    submitMyCardAnswer(isCorrect);
  }, 1000);
}


let myCardsJunbiVisible = false;

function toggleMyCardsJunbi() {
  myCardsJunbiVisible = !myCardsJunbiVisible;
  const list = document.getElementById('myCardsJunbiList');
  const btn = document.getElementById('myCardsJunbiToggle');

  if (myCardsJunbiVisible) {
    list.style.display = 'block';
    btn.textContent = ' Hide Word List';
    populateMyCardsJunbi();
  } else {
    list.style.display = 'none';
    btn.textContent = ' Show Word List';
  }
}

function populateMyCardsJunbi() {
  const tbody = document.getElementById('myCardsJunbiTableBody');
  if (!tbody) return;

  const folderId = document.getElementById('studyFolderSelect')?.value || 'all';
  let cards = [];

  if (folderId === 'all') {
    cards = [...myFlashcardsData];
  } else if (folderId === 'due') {
    const now = new Date();
    cards = myFlashcardsData.filter(c => !c.nextReviewDate || new Date(c.nextReviewDate.toDate?.() || c.nextReviewDate) <= now);
  } else {
    cards = myFlashcardsData.filter(c => c.folderId === folderId);
  }

  if (cards.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="padding: 30px; text-align: center; color: #a0aec0;">
          No cards to display. Select a different folder or add some cards first!
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = cards.map((card, index) => {
    // Always use the original Korean text for display
    let koreanCell = card.korean || '';

    const boxColors = ['#c53030', '#c05621', '#975a16', '#276749', '#2b6cb0'];
    const boxColor = boxColors[Math.min((card.leitnerBox || 1) - 1, 4)];

    return `
      <tr style="border-bottom: 1px solid #e2e8f0;">
        <td style="padding: 12px; color: #718096; font-weight: 500;">${index + 1}</td>
        <td style="padding: 12px;">${card.english || ''}</td>
        <td style="padding: 12px; font-size: 18px;">${koreanCell}</td>
        <td style="padding: 12px; text-align: center;">
          <span style="background: ${boxColor}20; color: ${boxColor}; padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: 600;">
            Box ${card.leitnerBox || 1}
          </span>
        </td>
      </tr>
    `;
  }).join('');
}


/**
 * Add phrase by index from stored responses
 */
function addPhraseByIndex(index) {
  if (!window.currentSortedResponses || !window.currentSortedResponses[index]) {
    alert('Error: Response not found');
    return;
  }

  const resp = window.currentSortedResponses[index];
  addPhraseToMyPhrasesDirectly(resp);
}

/**
 * Add a phrase from situational responses to My Phrases folder
 */
async function addPhraseToMyPhrases(encodedResp) {
  if (!currentUser) {
    alert('Please log in first');
    return;
  }

  try {
    const resp = JSON.parse(decodeURIComponent(encodedResp));
    await addPhraseToMyPhrasesDirectly(resp);
  } catch (error) {
    alert('Error adding phrase');
  }
}

/**
 * Add phrase directly (used by both methods)
 */
async function addPhraseToMyPhrasesDirectly(resp) {
  if (!currentUser) {
    alert('Please log in first');
    return;
  }

  const korean = resp.korean;
  const english = resp.english;

  const confirmed = confirm(`Add this phrase to "My Phrases"?\n\n ${korean}\n ${english}`);
  if (!confirmed) return;

  try {
    let phrasesFolderId = null;
    const foldersSnapshot = await db.collection('studentFolders')
      .where('studentId', '==', currentUser.uid)
      .where('name', '==', 'My Phrases')
      .where('isPhrases', '==', true)
      .get();

    if (foldersSnapshot.empty) {
      const folderRef = await db.collection('studentFolders').add({
        studentId: currentUser.uid,
        name: 'My Phrases',
        isPhrases: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      phrasesFolderId = folderRef.id;
    } else {
      phrasesFolderId = foldersSnapshot.docs[0].id;
    }

    const existingSnapshot = await db.collection('studentFlashcards')
      .where('studentId', '==', currentUser.uid)
      .where('folderId', '==', phrasesFolderId)
      .where('korean', '==', korean)
      .get();

    if (!existingSnapshot.empty) {
      showToast(` This phrase is already in My Phrases!`);
      return;
    }

    showToast(` Adding phrase and generating word data... (10-15 seconds)`);

    let aiData = null;
    try {
      const prompt = buildWordAnalysisPrompt(korean, english);
      const wordData = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.3);

      aiData = {
        wordData: Array.isArray(wordData) ? wordData : []
      };
    } catch (aiError) {
    }

    await db.collection('studentFlashcards').add({
      studentId: currentUser.uid,
      folderId: phrasesFolderId,
      korean: korean,
      english: english,
      level: resp.level || null,
      points: resp.points || null,
      keywords: resp.keywords || [],
      aiData: aiData,
      isPhrases: true,
      leitnerBox: 1,
      correctCount: 0,
      incorrectCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast(` Phrase added to "My Phrases"!`);

    if (myFlashcardsData) {
      loadMyFlashcards();
    }

  } catch (error) {
    alert('Error adding phrase: ' + error.message);
  }
}

/**
 * Update study preview when folder changes
 */
function updateStudyPreviewWithJunbi() {
  updateStudyPreview();
  if (myCardsJunbiVisible) {
    populateMyCardsJunbi();
  }
}


let currentReviewFolderId = null;
let currentReviewCards = [];
let selectedReviewCards = new Set();

/**
 * Open folder review page
 */
async function openFolderReview(folderId) {
  currentReviewFolderId = folderId;
  selectedReviewCards = new Set();

  const folder = myFoldersData.find(f => f.id === folderId);
  if (!folder) {
    alert('Folder not found');
    return;
  }

  currentReviewCards = myFlashcardsData.filter(c => c.folderId === folderId);

  document.getElementById('reviewFolderTitle').textContent = ` Review: ${folder.name}`;
  document.getElementById('folderReviewPage').style.display = 'block';
  document.getElementById('reviewBulkActions').style.display = 'block';

  const moveSelect = document.getElementById('reviewMoveToFolder');
  moveSelect.innerHTML = '<option value="">Move to folder...</option>';
  myFoldersData.forEach(f => {
    if (f.id !== folderId && !f.isPhrases) {
      const icon = f.isVocabulary ? '' : '';
      moveSelect.innerHTML += `<option value="${f.id}">${icon} ${f.name}</option>`;
    }
  });

  const cardsNeedingAI = currentReviewCards.filter(c => !c.aiData || !c.aiData.wordData || c.aiData.wordData.length === 0);

  if (cardsNeedingAI.length > 0) {
    await generateAIDataForReviewCards(cardsNeedingAI);
  }

  renderReviewTable();
  updateReviewStats();
}

/**
 * Close folder review page
 */
function closeFolderReview() {
  document.getElementById('folderReviewPage').style.display = 'none';
  currentReviewFolderId = null;
  currentReviewCards = [];
  selectedReviewCards = new Set();

  loadMyFlashcards();
}

/**
 * Generate AI word data for cards that don't have it
 */
async function generateAIDataForReviewCards(cards) {
  const statusEl = document.getElementById('reviewAIStatus');
  const progressEl = document.getElementById('reviewAIProgress');

  statusEl.style.display = 'block';

  for (let i = 0; i < cards.length; i++) {
    const card = cards[i];
    progressEl.textContent = `${i + 1} / ${cards.length} cards`;

    try {
      const prompt = buildWordAnalysisPrompt(card.korean, card.english);
      const wordData = await callAIProxy([
        { role: 'system', content: 'You are a Korean language expert. Always respond with valid JSON only, no markdown or explanation.' },
        { role: 'user', content: prompt }
      ], 0.3);

      const aiData = {
        wordData: Array.isArray(wordData) ? wordData : []
      };

      await db.collection('studentFlashcards').doc(card.id).update({ aiData });

      card.aiData = aiData;
      const globalCard = myFlashcardsData.find(c => c.id === card.id);
      if (globalCard) globalCard.aiData = aiData;

    } catch (error) {
    }
  }

  statusEl.style.display = 'none';
}

/**
 * Render the review table with hoverable Korean words
 */
function renderReviewTable() {
  const tbody = document.getElementById('reviewTableBody');

  if (currentReviewCards.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="padding: 40px; text-align: center; color: #a0aec0;">
          <div style="font-size: 40px; margin-bottom: 10px;"></div>
          <div>No cards in this folder yet.</div>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = currentReviewCards.map((card, index) => {
    const isSelected = selectedReviewCards.has(card.id);

    // Always use the original Korean text for display
    let koreanCell = card.korean || '';

    const boxColors = ['#c53030', '#c05621', '#975a16', '#276749', '#2b6cb0'];
    const boxColor = boxColors[Math.min((card.leitnerBox || 1) - 1, 4)];

    return `
      <tr style="border-bottom: 1px solid #e2e8f0; ${isSelected ? 'background: #ebf8ff;' : ''}" id="reviewRow-${card.id}">
        <td style="padding: 12px; text-align: center;">
          <input type="checkbox"
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleReviewCardSelection('${card.id}')"
                 style="width: 16px; height: 16px; cursor: pointer;">
        </td>
        <td style="padding: 12px; color: #718096; font-weight: 500;">${index + 1}</td>
        <td style="padding: 12px;" class="review-english-cell">${card.english || ''}</td>
        <td style="padding: 12px; font-size: 18px;" class="review-korean-cell">${koreanCell}</td>
        <td style="padding: 12px; text-align: center;">
          <span style="background: ${boxColor}20; color: ${boxColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${card.leitnerBox || 1}
          </span>
        </td>
      </tr>
    `;
  }).join('');
}

let reviewHiddenColumn = null;

/**
 * Toggle column visibility (hide English, Korean, or show both)
 */
function toggleReviewColumn(column) {
  const englishCells = document.querySelectorAll('.review-english-cell, .review-english-col');
  const koreanCells = document.querySelectorAll('.review-korean-cell, .review-korean-col');
  const englishBtn = document.getElementById('reviewHideEnglishBtn');
  const koreanBtn = document.getElementById('reviewHideKoreanBtn');

  englishCells.forEach(cell => {
    cell.style.color = '';
    cell.style.background = '';
    cell.classList.remove('hidden-column');
  });
  koreanCells.forEach(cell => {
    cell.style.color = '';
    cell.style.background = '';
    cell.classList.remove('hidden-column');
  });
  englishBtn.textContent = ' Hide English';
  koreanBtn.textContent = ' Hide Korean';

  if (column === 'both') {
    reviewHiddenColumn = null;
    return;
  }

  if (column === 'english') {
    reviewHiddenColumn = 'english';
    englishCells.forEach(cell => {
      cell.style.color = 'transparent';
      cell.style.background = 'linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%)';
      cell.style.cursor = 'pointer';
      cell.classList.add('hidden-column');
      cell.title = 'Click to peek';
    });
    englishBtn.textContent = ' Show English';
  } else if (column === 'korean') {
    reviewHiddenColumn = 'korean';
    koreanCells.forEach(cell => {
      cell.style.color = 'transparent';
      cell.style.background = 'linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%)';
      cell.style.cursor = 'pointer';
      cell.classList.add('hidden-column');
      cell.title = 'Click to peek';
    });
    koreanBtn.textContent = ' Show Korean';
  }

  document.querySelectorAll('.hidden-column').forEach(cell => {
    cell.onclick = function() {
      if (this.classList.contains('peeking')) {
        this.style.color = 'transparent';
        this.classList.remove('peeking');
      } else {
        this.style.color = '';
        this.classList.add('peeking');
      }
    };
  });
}

/**
 * Toggle selection of a single card
 */
function toggleReviewCardSelection(cardId) {
  if (selectedReviewCards.has(cardId)) {
    selectedReviewCards.delete(cardId);
  } else {
    selectedReviewCards.add(cardId);
  }

  updateReviewSelectionUI();
}

/**
 * Toggle select all cards
 */
function toggleSelectAllReviewCards() {
  const allSelected = selectedReviewCards.size === currentReviewCards.length;

  if (allSelected) {
    selectedReviewCards.clear();
  } else {
    currentReviewCards.forEach(c => selectedReviewCards.add(c.id));
  }

  updateReviewSelectionUI();
  renderReviewTable();
}

/**
 * Update selection UI (count, checkboxes)
 */
function updateReviewSelectionUI() {
  document.getElementById('reviewSelectedCount').textContent = `${selectedReviewCards.size} selected`;

  const selectAllCheckbox = document.getElementById('reviewSelectAll');
  const headerCheckbox = document.getElementById('reviewHeaderCheckbox');
  const allSelected = selectedReviewCards.size === currentReviewCards.length && currentReviewCards.length > 0;

  if (selectAllCheckbox) selectAllCheckbox.checked = allSelected;
  if (headerCheckbox) headerCheckbox.checked = allSelected;
}

/**
 * Bulk move selected cards to another folder
 */
async function bulkMoveReviewCards() {
  const targetFolderId = document.getElementById('reviewMoveToFolder').value;

  if (!targetFolderId) {
    alert('Please select a folder to move cards to.');
    return;
  }

  if (selectedReviewCards.size === 0) {
    alert('Please select at least one card to move.');
    return;
  }

  const targetFolder = myFoldersData.find(f => f.id === targetFolderId);
  const confirmed = confirm(`Move ${selectedReviewCards.size} card(s) to "${targetFolder?.name}"?`);

  if (!confirmed) return;

  try {
    showToast(` Moving ${selectedReviewCards.size} cards...`);

    const batch = db.batch();
    selectedReviewCards.forEach(cardId => {
      const cardRef = db.collection('studentFlashcards').doc(cardId);
      batch.update(cardRef, { folderId: targetFolderId });
    });

    await batch.commit();

    selectedReviewCards.forEach(cardId => {
      const card = myFlashcardsData.find(c => c.id === cardId);
      if (card) card.folderId = targetFolderId;
    });

    currentReviewCards = currentReviewCards.filter(c => !selectedReviewCards.has(c.id));
    selectedReviewCards.clear();

    renderReviewTable();
    updateReviewStats();
    updateReviewSelectionUI();

    showToast(` Cards moved to "${targetFolder?.name}"!`);

  } catch (error) {
    alert('Error moving cards: ' + error.message);
  }
}

/**
 * Update review page stats
 */
function updateReviewStats() {
  document.getElementById('reviewTotalCards').textContent = currentReviewCards.length;

  const withAI = currentReviewCards.filter(c => c.aiData && c.aiData.wordData && c.aiData.wordData.length > 0).length;
  document.getElementById('reviewWithAI').textContent = withAI;
}

function loadMyFlashcardsAnalytics() {
  const total = myFlashcardsData.length;
  const mastered = myFlashcardsData.filter(c => (c.leitnerBox || 1) >= 5).length;
  const due = myFlashcardsData.filter(c => {
    if (!c.nextReviewDate) return true;
    return new Date(c.nextReviewDate.toDate?.() || c.nextReviewDate) <= new Date();
  }).length;

  let totalCorrect = 0, totalIncorrect = 0;
  myFlashcardsData.forEach(c => {
    totalCorrect += c.correctCount || 0;
    totalIncorrect += c.incorrectCount || 0;
  });
  const accuracy = totalCorrect + totalIncorrect > 0 ? Math.round((totalCorrect / (totalCorrect + totalIncorrect)) * 100) : 0;

  document.getElementById('analyticsTotal').textContent = total;
  document.getElementById('analyticsMastered').textContent = mastered;
  document.getElementById('analyticsDue').textContent = due;
  document.getElementById('analyticsAccuracy').textContent = accuracy + '%';

  const boxCounts = [0, 0, 0, 0, 0];
  myFlashcardsData.forEach(c => {
    const box = (c.leitnerBox || 1) - 1;
    if (box >= 0 && box < 5) boxCounts[box]++;
  });

  const leitnerCtx = document.getElementById('myCardsLeitnerChart')?.getContext('2d');
  if (leitnerCtx) {
    if (myCardsLeitnerChart) myCardsLeitnerChart.destroy();
    myCardsLeitnerChart = new Chart(leitnerCtx, {
      type: 'bar',
      data: {
        labels: ['Box 1', 'Box 2', 'Box 3', 'Box 4', 'Box 5'],
        datasets: [{
          label: 'Cards',
          data: boxCounts,
          backgroundColor: ['#fc8181', '#f6ad55', '#f6e05e', '#68d391', '#63b3ed']
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  const folderLabels = myFoldersData.map(f => f.name).slice(0, 8);
  const folderCounts = myFoldersData.slice(0, 8).map(f => myFlashcardsData.filter(c => c.folderId === f.id).length);

  const folderCtx = document.getElementById('myCardsFolderChart')?.getContext('2d');
  if (folderCtx) {
    if (myCardsFolderChart) myCardsFolderChart.destroy();
    myCardsFolderChart = new Chart(folderCtx, {
      type: 'doughnut',
      data: {
        labels: folderLabels,
        datasets: [{
          data: folderCounts,
          backgroundColor: ['#667eea', '#48bb78', '#ed8936', '#9f7aea', '#f56565', '#38b2ac', '#d69e2e', '#e53e3e']
        }]
      },
      options: { responsive: true }
    });
  }

  const weakest = [...myFlashcardsData]
    .filter(c => c.incorrectCount > 0)
    .sort((a, b) => (b.incorrectCount || 0) - (a.incorrectCount || 0))
    .slice(0, 5);

  const weakestContainer = document.getElementById('weakestCardsList');
  if (weakestContainer) {
    if (weakest.length === 0) {
      weakestContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0;">No problem cards yet!</div>';
    } else {
      weakestContainer.innerHTML = weakest.map(c => `
        <div style="display: flex; justify-content: space-between; padding: 10px; background: #fff5f5; border-radius: 8px;">
          <div><strong>${c.korean}</strong>  ${c.english}</div>
          <div style="color: #e53e3e;"> ${c.incorrectCount}</div>
        </div>
      `).join('');
    }
  }
}

const originalSwitchTab = window.switchTab;
if (originalSwitchTab) {
  window.switchTab = function(tabName) {
    originalSwitchTab(tabName);

    if (tabName === 'myFlashcards') loadMyFlashcards();
    if (tabName === 'myFlashcardsStudy') { loadMyFlashcards(); updateStudyPreview(); }
    if (tabName === 'myFlashcardsAnalytics') { loadMyFlashcards(); loadMyFlashcardsAnalytics(); }
    if (tabName === 'myCreatorProfile') { loadMyFlashcards(); loadCreatorProfile(); }
    if (tabName === 'marketplacePopular') loadMarketplace('popular');
    if (tabName === 'marketplaceNewest') loadMarketplace('newest');
    if (tabName === 'marketplaceCategories') loadMarketplace('popular');
    if (tabName === 'myPurchases') { loadMyFlashcards(); loadMyPurchases(); }

    if (tabName === 'createGrammarEval') loadGrammarTopicsForSelection();
    if (tabName === 'manageGrammarEvals') loadGrammarEvaluations();
    if (tabName === 'gradeGrammarEvals') loadGrammarSubmissionsForGrading();
    if (tabName === 'grammarDrillTracking') loadGrammarDrillTracking();
    if (tabName === 'availableGrammarTests' && currentUserRole === 'student') loadAvailableGrammarTests();
    if (tabName === 'grammarDrills' && currentUserRole === 'student') renderGrammarDrills();
    if (tabName === 'grammarAnalytics' && currentUserRole === 'student') loadGrammarAnalytics();
  };
}


let grammarDrillCards = [];
let grammarDrillDueCards = [];
let grammarDrillCompletedCards = [];
let grammarWalkAwayMode = false;
let grammarDrillState = {
  cardId: null,
  sentences: [],
  currentIndex: 0,
  currentRepetition: 1,
  requiredRepetitions: 5,
  totalCorrect: 0,
  totalAttempts: 0,
  isActive: false
};

const GRAMMAR_DRILL_REPS = 5;
const GRAMMAR_DRILL_DAYS = 7;
let adminGrammarConfig = null;

async function loadAdminGrammarConfig() {
  try {
    const doc = await db.collection('adminSettings').doc('grammarDrillsConfig').get();
    if (doc.exists) {
      adminGrammarConfig = doc.data();
    }
    return adminGrammarConfig;
  } catch (error) {
    return null;
  }
}

async function loadGrammarDrillCards() {
  if (!currentUser) return;
  try {
    const snapshot = await db.collection('grammarLeitner').where('studentId', '==', currentUser.uid).get();
    grammarDrillCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (const card of grammarDrillCards) {
      if (card.isComplete) continue;
      const lastCompleted = card.lastCompletedDate?.toDate ? card.lastCompletedDate.toDate() : null;
      if (lastCompleted) {
        const lastDay = new Date(lastCompleted);
        lastDay.setHours(0, 0, 0, 0);
        if (lastDay.getTime() < today.getTime() && card.completedToday) {
          await db.collection('grammarLeitner').doc(card.id).update({ completedToday: false, completedRepetitionsToday: 0 });
          card.completedToday = false;
          card.completedRepetitionsToday = 0;
        }
      }
    }

    grammarDrillDueCards = grammarDrillCards.filter(c => !c.isComplete && !c.completedToday);
    grammarDrillCompletedCards = grammarDrillCards.filter(c => c.isComplete);
    updateGrammarDrillBadge();
  } catch (error) {
  }
}

function updateGrammarDrillBadge() {
  const badge = document.getElementById('grammarDrillsBadge');
  if (badge) {
    badge.textContent = grammarDrillDueCards.length;
    badge.style.display = grammarDrillDueCards.length > 0 ? 'inline-block' : 'none';
  }
}

function switchGrammarDrillView(view) {
  ['drills', 'junbi', 'calendar', 'stats'].forEach(v => {
    const btn = document.getElementById(`grammar${v.charAt(0).toUpperCase() + v.slice(1)}ViewBtn`);
    if (btn) {
      btn.style.background = v === view ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : '#e2e8f0';
      btn.style.color = v === view ? 'white' : '#4a5568';
    }
  });
  document.getElementById('grammarDrillsContainer').style.display = view === 'drills' ? 'block' : 'none';
  document.getElementById('grammarJunbiContainer').style.display = view === 'junbi' ? 'block' : 'none';
  document.getElementById('grammarCalendarContainer').style.display = view === 'calendar' ? 'block' : 'none';
  document.getElementById('grammarStatsContainer').style.display = view === 'stats' ? 'block' : 'none';

  if (view === 'drills') renderGrammarDrills();
  if (view === 'junbi') renderGrammarJunbiSelection();
  if (view === 'calendar') renderGrammarCalendar();
  if (view === 'stats') renderGrammarStats();
}

async function renderGrammarDrills() {
  await loadGrammarDrillCards();
  const container = document.getElementById('grammarDrillsContainer');
  if (!container) return;

  if (grammarDrillCards.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #718096;"><div style="font-size: 80px; margin-bottom: 20px;"></div><h3 style="color: #4a5568; margin-bottom: 10px;">No Grammar Drills Yet</h3><p>Once your teacher grades your grammar evaluations, your drill assignments will appear here.</p></div>';
    return;
  }

  const activeDrills = grammarDrillCards.filter(c => !c.isComplete);
  const completedDrills = grammarDrillCards.filter(c => c.isComplete);
  const dueToday = activeDrills.filter(c => !c.completedToday).length;
  const doneToday = activeDrills.filter(c => c.completedToday).length;

  let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f59e0b;"><div style="font-size: 32px; font-weight: bold; color: #92400e;">${dueToday}</div><div style="font-size: 12px; color: #78350f;">Due Today</div></div>
    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #10b981;"><div style="font-size: 32px; font-weight: bold; color: #065f46;">${doneToday}</div><div style="font-size: 12px; color: #047857;">Done Today</div></div>
    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #6366f1;"><div style="font-size: 32px; font-weight: bold; color: #3730a3;">${completedDrills.length}</div><div style="font-size: 12px; color: #4338ca;">Completed</div></div>
  </div>`;

  if (activeDrills.length > 0) {
    html += '<h3 style="margin-bottom: 15px; color: #92400e;"> Active Drills</h3><div style="display: grid; gap: 15px; margin-bottom: 30px;">';
    activeDrills.forEach(card => {
      const currentDay = card.currentDay || 1;
      const progress = Math.round((currentDay / GRAMMAR_DRILL_DAYS) * 100);
      const isDue = !card.completedToday;
      html += `<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${isDue ? '#f59e0b' : '#10b981'};">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 1;"><h4 style="font-size: 16px; color: #2d3748; margin-bottom: 8px;"> ${card.topicTitle || 'Grammar Topic'}</h4>
            <p style="font-size: 12px; color: #718096; margin-bottom: 10px;">${card.topicDescription || ''}</p>
            <div style="font-size: 11px; color: #a0aec0;">Grade: ${card.grade}/10  Day ${currentDay}/${GRAMMAR_DRILL_DAYS}  ${card.sentences?.length || 20} sentences</div>
            <div style="margin-top: 12px; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;"><div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div></div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${isDue ? `<button onclick="startGrammarDrill('${card.id}')" class="btn" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"> Start</button>
              <button onclick="openGrammarJunbi('${card.id}')" class="btn" style="padding: 8px 16px; background: #e2e8f0; color: #4a5568; font-size: 12px;"> JUNBI</button>`
              : '<div style="padding: 12px 24px; background: #d1fae5; color: #065f46; border-radius: 8px; text-align: center;"> Done</div>'}
          </div>
        </div>
      </div>`;
    });
    html += '</div>';
  }

  if (completedDrills.length > 0) {
    html += `<h3 style="margin-bottom: 15px; color: #065f46;"> Completed (${completedDrills.length})</h3><div style="display: grid; gap: 10px;">`;
    completedDrills.forEach(card => {
      html += `<div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 1px solid #48bb78;"><span style="font-weight: 600; color: #276749;">${card.topicTitle || 'Grammar Topic'}</span><span style="color: #48bb78; float: right;"></span></div>`;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

async function startGrammarDrill(cardId) {
  const card = grammarDrillCards.find(c => c.id === cardId);
  if (!card) return;

  grammarDrillState = {
    cardId: cardId,
    sentences: shuffleGrammarArray([...(card.sentences || [])]),
    currentIndex: 0,
    currentRepetition: (card.completedRepetitionsToday || 0) + 1,
    requiredRepetitions: GRAMMAR_DRILL_REPS,
    totalCorrect: 0,
    totalAttempts: 0,
    isActive: true
  };

  renderGrammarDrillInterface();
}

function shuffleGrammarArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

let grammarDrillTimerInterval = null;
let grammarDrillTimeRemaining = 10;
let grammarRecognition = null;

function renderGrammarDrillInterface() {
  const container = document.getElementById('grammarDrillsContainer');
  if (!container || !grammarDrillState.isActive) return;

  const card = grammarDrillCards.find(c => c.id === grammarDrillState.cardId);
  const sentence = grammarDrillState.sentences[grammarDrillState.currentIndex];

  if (!sentence) { finishGrammarDrillRepetition(); return; }

  const progress = Math.round((grammarDrillState.currentIndex / grammarDrillState.sentences.length) * 100);

  container.innerHTML = `<div style="max-width: 800px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px 20px; border-radius: 12px 12px 0 0; border: 2px solid #f59e0b; border-bottom: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: 600; color: #92400e;">${card?.topicTitle || 'Grammar'} - Rep ${grammarDrillState.currentRepetition}/${grammarDrillState.requiredRepetitions}</span><span style="color: #92400e;">${grammarDrillState.currentIndex + 1}/${grammarDrillState.sentences.length}</span></div>
      <div style="margin-top: 10px; background: #fcd34d; height: 6px; border-radius: 3px;"><div style="width: ${progress}%; height: 100%; background: #f59e0b;"></div></div>
    </div>
    <div style="background: white; padding: 40px; border: 2px solid #f59e0b; border-top: none; border-radius: 0 0 12px 12px; text-align: center;">
      <p style="font-size: 12px; color: #a0aec0; margin-bottom: 10px;"> Say this in Korean:</p>
      <h2 style="font-size: 28px; color: #2d3748; margin-bottom: 30px;">${sentence.english}</h2>
      <div id="grammarDrillTimer" style="font-size: 48px; font-weight: bold; color: #f59e0b; margin-bottom: 20px;">10</div>
      <div id="grammarVoiceStatus" style="min-height: 40px; margin-bottom: 15px; color: #f59e0b;"><span style="animation: pulse 1.5s infinite;"></span> Listening...</div>
      <div id="grammarRecognizedText" style="min-height: 40px; padding: 15px; background: #fafafa; border-radius: 8px; margin-bottom: 20px; font-size: 18px; color: #4a5568;"><em style="color: #a0aec0;">Speak Korean...</em></div>
      <div id="grammarKoreanAnswer" style="display: none; padding: 20px; background: #f0fff4; border-radius: 8px; border: 2px solid #48bb78; margin-bottom: 20px;"><p style="font-size: 12px; color: #48bb78;"> Answer:</p><h3 style="font-size: 24px; color: #276749;">${sentence.korean}</h3></div>
      <div id="grammarDrillActions" style="display: none; gap: 10px; justify-content: center;"><button onclick="grammarDrillTryAgain()" class="btn" style="padding: 12px 24px; background: #f56565; color: white;"> Try Again</button><button onclick="grammarDrillNext()" class="btn" style="padding: 12px 24px; background: #48bb78; color: white;"> Next</button></div>
      <button onclick="skipGrammarDrillSentence()" class="btn" style="margin-top: 15px; padding: 8px 16px; background: #e2e8f0; color: #718096; font-size: 12px;">Skip</button>
    </div>
    <div style="text-align: center; margin-top: 15px;"><button onclick="exitGrammarDrill()" class="btn" style="padding: 10px 20px; background: #e2e8f0; color: #718096;"> Exit</button></div>
  </div>`;

  startGrammarDrillTimer();
  startGrammarVoiceRecognition();

  if (grammarWalkAwayMode) setTimeout(() => speakGrammarTTS(sentence.english, 'en-US'), 500);
}

function startGrammarDrillTimer() {
  grammarDrillTimeRemaining = 10;
  clearInterval(grammarDrillTimerInterval);
  grammarDrillTimerInterval = setInterval(() => {
    grammarDrillTimeRemaining--;
    const el = document.getElementById('grammarDrillTimer');
    if (el) { el.textContent = grammarDrillTimeRemaining; if (grammarDrillTimeRemaining <= 3) el.style.color = '#f56565'; }
    if (grammarDrillTimeRemaining <= 0) { clearInterval(grammarDrillTimerInterval); handleGrammarTimeout(); }
  }, 1000);
}

function handleGrammarTimeout() {
  stopGrammarVoiceRecognition();
  const ans = document.getElementById('grammarKoreanAnswer');
  const act = document.getElementById('grammarDrillActions');
  const stat = document.getElementById('grammarVoiceStatus');
  if (ans) ans.style.display = 'block';
  if (act) act.style.display = 'flex';
  if (stat) stat.innerHTML = '<span style="color: #f56565;"> Time up!</span>';
  grammarDrillState.totalAttempts++;
  if (grammarWalkAwayMode) { speakGrammarTTS(grammarDrillState.sentences[grammarDrillState.currentIndex].korean, 'ko-KR'); setTimeout(() => grammarDrillNext(), 3000); }
}

function startGrammarVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  grammarRecognition = new SR();
  grammarRecognition.lang = 'ko-KR';
  grammarRecognition.continuous = true;
  grammarRecognition.interimResults = true;
  grammarRecognition.onresult = (e) => {
    let final = '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const text = final || interim;
    const el = document.getElementById('grammarRecognizedText');
    if (el && text) el.innerHTML = text;
    if (final) checkGrammarAnswer(final);
  };
  grammarRecognition.start();
}

function stopGrammarVoiceRecognition() { if (grammarRecognition) { grammarRecognition.stop(); grammarRecognition = null; } }

function checkGrammarAnswer(spoken) {
  const sentence = grammarDrillState.sentences[grammarDrillState.currentIndex];
  if (!sentence) return;
  const norm = s => s.replace(/\s+/g, '').replace(/[.,!?]/g, '').toLowerCase();
  const sim = calcGrammarSimilarity(norm(spoken), norm(sentence.korean));
  if (sim >= 0.75) {
    clearInterval(grammarDrillTimerInterval);
    stopGrammarVoiceRecognition();
    grammarDrillState.totalCorrect++;
    grammarDrillState.totalAttempts++;
    const ans = document.getElementById('grammarKoreanAnswer');
    const stat = document.getElementById('grammarVoiceStatus');
    if (ans) { ans.style.display = 'block'; ans.style.background = '#d1fae5'; }
    if (stat) stat.innerHTML = '<span style="color: #10b981; font-size: 24px;"> Correct!</span>';
    setTimeout(() => grammarDrillNext(), grammarWalkAwayMode ? 2000 : 1500);
  }
}

function calcGrammarSimilarity(s1, s2) {
  if (s1 === s2) return 1;
  if (!s1.length || !s2.length) return 0;
  const m = [];
  for (let i = 0; i <= s1.length; i++) m[i] = [i];
  for (let j = 0; j <= s2.length; j++) m[0][j] = j;
  for (let i = 1; i <= s1.length; i++) for (let j = 1; j <= s2.length; j++) m[i][j] = s1[i-1] === s2[j-1] ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
  return 1 - m[s1.length][s2.length] / Math.max(s1.length, s2.length);
}

function grammarDrillTryAgain() {
  document.getElementById('grammarKoreanAnswer').style.display = 'none';
  document.getElementById('grammarDrillActions').style.display = 'none';
  document.getElementById('grammarRecognizedText').innerHTML = '<em style="color: #a0aec0;">Speak Korean...</em>';
  startGrammarDrillTimer();
  startGrammarVoiceRecognition();
}

function grammarDrillNext() {
  grammarDrillState.currentIndex++;
  if (grammarDrillState.currentIndex >= grammarDrillState.sentences.length) finishGrammarDrillRepetition();
  else renderGrammarDrillInterface();
}

function skipGrammarDrillSentence() { grammarDrillState.totalAttempts++; clearInterval(grammarDrillTimerInterval); stopGrammarVoiceRecognition(); grammarDrillNext(); }
function exitGrammarDrill() { clearInterval(grammarDrillTimerInterval); stopGrammarVoiceRecognition(); grammarDrillState.isActive = false; renderGrammarDrills(); }

async function finishGrammarDrillRepetition() {
  clearInterval(grammarDrillTimerInterval);
  stopGrammarVoiceRecognition();
  const card = grammarDrillCards.find(c => c.id === grammarDrillState.cardId);
  if (!card) { renderGrammarDrills(); return; }

  const accuracy = grammarDrillState.totalAttempts > 0 ? Math.round((grammarDrillState.totalCorrect / grammarDrillState.totalAttempts) * 100) : 0;
  const isRepComplete = grammarDrillState.currentRepetition >= GRAMMAR_DRILL_REPS;
  const currentDay = card.currentDay || 1;

  try {
    const upd = { totalReviews: (card.totalReviews||0) + grammarDrillState.totalAttempts, correctCount: (card.correctCount||0) + grammarDrillState.totalCorrect, completedRepetitionsToday: grammarDrillState.currentRepetition };
    if (isRepComplete) {
      upd.completedToday = true;
      upd.lastCompletedDate = firebase.firestore.FieldValue.serverTimestamp();
      if (currentDay >= GRAMMAR_DRILL_DAYS) { upd.isComplete = true; upd.completedAt = firebase.firestore.FieldValue.serverTimestamp(); }
      else upd.currentDay = currentDay + 1;
    }
    await db.collection('grammarLeitner').doc(grammarDrillState.cardId).update(upd);
  } catch (e) { console.error('Save error:', e); }

  grammarDrillState.isActive = false;
  await loadGrammarDrillCards();

  const container = document.getElementById('grammarDrillsContainer');

  const hasMoreDrills = grammarDrillDueCards.length > 0;
  const canContinueRep = !isRepComplete;

  container.innerHTML = `<div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 40px;">
    <div style="font-size: 80px; margin-bottom: 20px;">${isRepComplete ? '' : ''}</div>
    <h2 style="color: ${isRepComplete ? '#10b981' : '#f59e0b'};">${isRepComplete ? 'Day Complete!' : 'Rep Complete!'}</h2>
    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #e2e8f0;"><p style="font-size: 24px; font-weight: bold;">${accuracy}% Accuracy</p></div>
    ${isRepComplete ? `<p style="color: #10b981;">${currentDay >= GRAMMAR_DRILL_DAYS ? ' Topic Mastered!' : 'Come back tomorrow!'}</p>` : `<button onclick="continueGrammarDrill()" class="btn" style="padding: 15px 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">Continue Rep ${grammarDrillState.currentRepetition + 1}</button>`}

    ${grammarWalkAwayMode && (canContinueRep || hasMoreDrills) ? `
      <div id="walkAwayPrompt" style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
        <p style="color: #92400e; font-size: 14px; margin-bottom: 10px;">
           <strong>Walk-Away Mode Active</strong>
        </p>
        <p style="color: #78350f; font-size: 16px; margin: 0;">
          Say <strong>"Yes"</strong> to ${canContinueRep ? 'continue to next rep' : 'move to next drill'}
        </p>
        <p style="color: #a0aec0; font-size: 12px; margin-top: 10px;">Or say "Stop" to exit</p>
      </div>
    ` : ''}

    <br><button onclick="renderGrammarDrills()" class="btn" style="margin-top: 15px; padding: 12px 30px; background: #e2e8f0; color: #4a5568;">Back to Drills</button>
  </div>`;

  if (grammarWalkAwayMode) {
    if (canContinueRep) {
      speakGrammarTTS(`Repetition complete. ${accuracy} percent accuracy. Say yes to continue to repetition ${grammarDrillState.currentRepetition + 1}.`, 'en-US');
    } else if (hasMoreDrills) {
      speakGrammarTTS(`Day complete for this topic. Say yes to move to the next drill.`, 'en-US');
    } else {
      speakGrammarTTS(`All grammar drills complete for today. Great job!`, 'en-US');
    }

    if (canContinueRep || hasMoreDrills) {
      startGrammarWalkAwayListening();
    }
  }
}

function continueGrammarDrill() { const card = grammarDrillCards.find(c => c.id === grammarDrillState.cardId); if (card && !card.completedToday) startGrammarDrill(grammarDrillState.cardId); }

function openGrammarJunbi(cardId) { switchGrammarDrillView('junbi'); renderGrammarJunbiForCard(cardId); }

function renderGrammarJunbiSelection() {
  const container = document.getElementById('grammarJunbiContainer');
  const active = grammarDrillCards.filter(c => !c.isComplete);
  if (active.length === 0) { container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;"><div style="font-size: 50px;"></div><p>No active drills for JUNBI.</p></div>'; return; }
  let html = '<div style="max-width: 800px; margin: 0 auto;"><div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #f59e0b;"><h3 style="color: #92400e;"> JUNBI Mode</h3><p style="color: #78350f; font-size: 14px;">Preview sentences before drilling.</p></div><h4 style="margin-bottom: 15px;">Select a topic:</h4><div style="display: grid; gap: 12px;">';
  active.forEach(c => html += `<button onclick="renderGrammarJunbiForCard('${c.id}')" style="width: 100%; text-align: left; padding: 15px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;"><div style="font-weight: 600; color: #2d3748;">${c.topicTitle || 'Topic'}</div><div style="font-size: 12px; color: #718096;">${c.sentences?.length || 20} sentences</div></button>`);
  html += '</div></div>';
  container.innerHTML = html;
}

function renderGrammarJunbiForCard(cardId) {
  const container = document.getElementById('grammarJunbiContainer');
  const card = grammarDrillCards.find(c => c.id === cardId);
  if (!card) { renderGrammarJunbiSelection(); return; }

  let html = `<div style="max-width: 800px; margin: 0 auto;"><div style="display: flex; justify-content: space-between; margin-bottom: 20px;"><h3 style="color: #92400e;"> ${card.topicTitle || 'Topic'}</h3><button onclick="renderGrammarJunbiSelection()" class="btn" style="padding: 8px 16px; background: #e2e8f0;"> Back</button></div><div style="display: grid; gap: 12px;">`;
  (card.sentences || []).forEach((s, i) => html += `<div onclick="speakGrammarTTS('${s.korean.replace(/'/g, "\\'")}', 'ko-KR')" style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0; cursor: pointer;"><div style="display: flex; gap: 15px;"><div style="min-width: 30px; height: 30px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #92400e;">${i+1}</div><div style="flex: 1;"><p style="font-size: 11px; color: #a0aec0;"> English</p><p style="font-size: 16px; color: #2d3748;">${s.english}</p><p style="font-size: 11px; color: #a0aec0; margin-top: 8px;"> Korean (tap to hear)</p><p style="font-size: 18px; color: #f59e0b; font-weight: 500;">${s.korean}</p></div><div style="color: #a0aec0; font-size: 20px;"></div></div></div>`);
  html += `</div><div style="text-align: center; margin-top: 25px;"><button onclick="startGrammarDrill('${cardId}')" class="btn" style="padding: 15px 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"> Start Drill</button></div></div>`;
  container.innerHTML = html;
}

function speakGrammarTTS(text, lang) { if ('speechSynthesis' in window) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = lang; u.rate = 0.9; speechSynthesis.speak(u); } }

function toggleGrammarWalkAwayMode() {
  const toggle = document.getElementById('grammarWalkAwayToggle');
  const slider = document.getElementById('grammarWalkAwaySlider');
  grammarWalkAwayMode = toggle?.checked || false;

  if (slider) {
    slider.style.transform = grammarWalkAwayMode ? 'translateX(30px)' : 'translateX(0)';
    const track = slider.previousElementSibling;
    if (track) track.style.background = grammarWalkAwayMode ? '#f59e0b' : '#cbd5e0';
  }

  if (grammarWalkAwayMode) {
    startGrammarWalkAwayListening();
    speakGrammarTTS('Walk-away mode enabled. Say yes to continue between drills.', 'en-US');
  } else {
    stopGrammarWalkAwayListening();
  }
}

function renderGrammarCalendar() { document.getElementById('grammarCalendarContainer').innerHTML = `<div style="text-align: center; padding: 40px;"><div style="font-size: 50px;"></div><h3>Grammar Calendar</h3><p>Active: ${grammarDrillCards.filter(c=>!c.isComplete).length} | Completed: ${grammarDrillCards.filter(c=>c.isComplete).length}</p></div>`; }

function renderGrammarStats() {
  const total = grammarDrillCards.length, completed = grammarDrillCards.filter(c=>c.isComplete).length;
  const reviews = grammarDrillCards.reduce((s,c)=>s+(c.totalReviews||0),0), correct = grammarDrillCards.reduce((s,c)=>s+(c.correctCount||0),0);
  const acc = reviews > 0 ? Math.round((correct/reviews)*100) : 0;
  document.getElementById('grammarStatsContainer').innerHTML = `<div style="max-width: 600px; margin: 0 auto;"><h3 style="margin-bottom: 20px;"> Grammar Statistics</h3><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;"><div style="background: #fef3c7; padding: 25px; border-radius: 12px; text-align: center;"><div style="font-size: 36px; font-weight: bold; color: #92400e;">${total}</div><div style="font-size: 12px;">Total Topics</div></div><div style="background: #d1fae5; padding: 25px; border-radius: 12px; text-align: center;"><div style="font-size: 36px; font-weight: bold; color: #065f46;">${completed}</div><div style="font-size: 12px;">Completed</div></div><div style="background: #e0e7ff; padding: 25px; border-radius: 12px; text-align: center;"><div style="font-size: 36px; font-weight: bold; color: #3730a3;">${reviews}</div><div style="font-size: 12px;">Reviews</div></div><div style="background: #fce7f3; padding: 25px; border-radius: 12px; text-align: center;"><div style="font-size: 36px; font-weight: bold; color: #9d174d;">${acc}%</div><div style="font-size: 12px;">Accuracy</div></div></div></div>`;
}

function loadGrammarAnalytics() { document.getElementById('grammarAnalyticsContainer').innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 50px;"></div><p>Grammar analytics coming soon.</p></div>'; }

let grammarEvalTopics = [];
let selectedGrammarTopics = [];

async function loadGrammarTopicsForSelection() {
  const el = document.getElementById('grammarTopicSelectionList');
  if (!el) return;
  el.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div></div>';
  try {
    await loadAdminGrammarConfig();
    if (!adminGrammarConfig?.topics?.length) { el.innerHTML = '<div style="text-align: center; padding: 30px; color: #718096;"><p>No grammar topics configured. Ask admin to add topics.</p></div>'; return; }
    grammarEvalTopics = adminGrammarConfig.topics;
    selectedGrammarTopics = [];
    let html = '<div style="display: grid; gap: 10px;">';
    grammarEvalTopics.forEach((t, i) => {
      const cnt = Object.values(t.sentences||{}).flat().filter(s=>s.english&&s.korean).length;
      html += `<label id="grammarTopicLabel-${i}" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #fafafa; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0;"><input type="checkbox" id="grammarTopicCheck-${i}" onchange="toggleGrammarTopicSelection(${i})" style="width: 20px; height: 20px;"><div><div style="font-weight: 600;">${t.title}</div><div style="font-size: 12px; color: #718096;">${t.description||''}</div><div style="font-size: 11px; color: #a0aec0;">${cnt} sentences</div></div></label>`;
    });
    html += '</div><div style="margin-top: 15px;"><button onclick="selectAllGrammarTopics()" class="btn btn-secondary" style="font-size: 12px;">Select All</button> <button onclick="deselectAllGrammarTopics()" class="btn" style="font-size: 12px; background: #e2e8f0;">Deselect All</button></div>';
    el.innerHTML = html;
  } catch (e) { el.innerHTML = '<p style="color: red;">Error: ' + e.message + '</p>'; }
}

function toggleGrammarTopicSelection(i) {
  const cb = document.getElementById(`grammarTopicCheck-${i}`), lbl = document.getElementById(`grammarTopicLabel-${i}`);
  if (cb.checked) { if (!selectedGrammarTopics.includes(i)) selectedGrammarTopics.push(i); lbl.style.borderColor = '#48bb78'; lbl.style.background = '#f0fff4'; }
  else { selectedGrammarTopics = selectedGrammarTopics.filter(x=>x!==i); lbl.style.borderColor = '#e2e8f0'; lbl.style.background = '#fafafa'; }
  updateSelectedGrammarTopicsPreview();
}

function selectAllGrammarTopics() { grammarEvalTopics.forEach((_,i) => { const cb = document.getElementById(`grammarTopicCheck-${i}`); if (cb && !cb.checked) { cb.checked = true; toggleGrammarTopicSelection(i); } }); }
function deselectAllGrammarTopics() { grammarEvalTopics.forEach((_,i) => { const cb = document.getElementById(`grammarTopicCheck-${i}`); if (cb && cb.checked) { cb.checked = false; toggleGrammarTopicSelection(i); } }); }

function updateSelectedGrammarTopicsPreview() {
  const pre = document.getElementById('selectedGrammarTopicsPreview'), cnt = document.getElementById('selectedGrammarTopicsCount'), lst = document.getElementById('selectedGrammarTopicsList');
  if (selectedGrammarTopics.length === 0) { pre.style.display = 'none'; return; }
  pre.style.display = 'block';
  cnt.textContent = selectedGrammarTopics.length;
  lst.innerHTML = selectedGrammarTopics.map(i => `<span style="display: inline-block; padding: 5px 12px; background: #d1fae5; color: #065f46; border-radius: 20px; font-size: 12px; margin: 3px;">${grammarEvalTopics[i].title}</span>`).join('');
}

async function createGrammarEvaluation() {
  const title = document.getElementById('grammarEvalTitle').value.trim();
  if (!title) { alert('Enter a title.'); return; }
  if (selectedGrammarTopics.length === 0) { alert('Select at least one topic.'); return; }
  try {
    const topics = selectedGrammarTopics.map(i => grammarEvalTopics[i]);
    await db.collection('grammarEvaluations').add({ title, description: document.getElementById('grammarEvalDescription').value.trim(), topics, createdBy: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp(), status: 'active' });
    alert(' Grammar Evaluation created!');
    document.getElementById('grammarEvalTitle').value = '';
    document.getElementById('grammarEvalDescription').value = '';
    deselectAllGrammarTopics();
    switchTab('manageGrammarEvals');
  } catch (e) { alert('Error: ' + e.message); }
}

async function loadGrammarEvaluations() {
  const container = document.getElementById('grammarEvalsListContainer');
  if (!container) return;
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div></div>';
  try {
    const snap = await db.collection('grammarEvaluations').where('createdBy', '==', currentUser.uid).orderBy('createdAt', 'desc').get();
    if (snap.empty) { container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;"><div style="font-size: 50px;"></div><p>No evaluations yet.</p><button onclick="switchTab(\'createGrammarEval\')" class="btn" style="margin-top: 15px;">Create One</button></div>'; return; }
    let html = '<div style="display: grid; gap: 15px;">';
    snap.docs.forEach(d => {
      const e = { id: d.id, ...d.data() };
      html += `<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;"><div style="display: flex; justify-content: space-between; align-items: start;"><div><h4 style="color: #2d3748;">${e.title}</h4><p style="font-size: 12px; color: #718096;">${e.topics?.length||0} topics</p></div><button onclick="deleteGrammarEvaluation('${e.id}')" class="btn" style="padding: 8px 15px; background: #fed7d7; color: #c53030; font-size: 12px;"></button></div></div>`;
    });
    html += '</div>';
    container.innerHTML = html;
  } catch (e) { container.innerHTML = '<p style="color: red;">Error: ' + e.message + '</p>'; }
}

async function deleteGrammarEvaluation(id) { if (!confirm('Delete this evaluation?')) return; try { await db.collection('grammarEvaluations').doc(id).delete(); loadGrammarEvaluations(); } catch (e) { alert('Error: ' + e.message); } }


async function loadAvailableGrammarTests() {
  const container = document.getElementById('availableGrammarTestsContainer');
  if (!container) return;
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div></div>';

  try {
    const evalsSnap = await db.collection('grammarEvaluations').where('status', '==', 'active').get();

    const subsSnap = await db.collection('grammarSubmissions').where('studentId', '==', currentUser.uid).get();
    const submittedEvalIds = subsSnap.docs.map(d => d.data().evaluationId);

    const availableEvals = evalsSnap.docs.filter(d => !submittedEvalIds.includes(d.id)).map(d => ({ id: d.id, ...d.data() }));

    if (availableEvals.length === 0) {
      container.innerHTML = `<div style="text-align: center; padding: 60px 20px; color: #718096;">
        <div style="font-size: 80px; margin-bottom: 20px;"></div>
        <h3 style="color: #4a5568; margin-bottom: 10px;">All Caught Up!</h3>
        <p>You've completed all available grammar tests.</p>
        <button onclick="switchTab('grammarDrills')" class="btn" style="margin-top: 20px; padding: 12px 24px;">Go to Grammar Drills</button>
      </div>`;
      updateAvailableGrammarTestsBadge(0);
      return;
    }

    updateAvailableGrammarTestsBadge(availableEvals.length);

    let html = '<div style="display: grid; gap: 15px;">';
    availableEvals.forEach(eval_ => {
      const topicCount = eval_.topics?.length || 0;
      html += `<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 1;">
            <h3 style="color: #2d3748; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;"></span> ${eval_.title}
            </h3>
            <p style="font-size: 13px; color: #718096; margin-bottom: 10px;">${eval_.description || 'Grammar evaluation'}</p>
            <div style="font-size: 12px; color: #a0aec0;">${topicCount} topics to complete</div>
          </div>
          <button onclick="startGrammarTest('${eval_.id}')" class="btn" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600;">
             Start Test
          </button>
        </div>
      </div>`;
    });
    html += '</div>';
    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `<p style="color: red; text-align: center;">Error loading tests: ${error.message}</p>`;
  }
}

function updateAvailableGrammarTestsBadge(count) {
  const badge = document.getElementById('availableGrammarTestsBadge');
  if (badge) {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline-block' : 'none';
  }
}

let currentGrammarTest = null;
let grammarTestAnswers = {};

async function startGrammarTest(evalId) {
  try {
    const doc = await db.collection('grammarEvaluations').doc(evalId).get();
    if (!doc.exists) { alert('Test not found.'); return; }

    currentGrammarTest = { id: evalId, ...doc.data() };
    grammarTestAnswers = {};

    (currentGrammarTest.topics || []).forEach((topic, index) => {
      grammarTestAnswers[index] = null;
    });

    switchTab('takeGrammarTest');
    renderGrammarTestInterface();
  } catch (error) {
    alert('Error starting test: ' + error.message);
  }
}

function renderGrammarTestInterface() {
  const container = document.getElementById('grammarTestInterface');
  if (!container || !currentGrammarTest) return;

  const topics = currentGrammarTest.topics || [];
  const answeredCount = Object.values(grammarTestAnswers).filter(v => v !== null).length;

  let html = `
    <div style="max-width: 900px; margin: 0 auto;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #f59e0b;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div>
            <h2 style="color: #92400e; margin-bottom: 5px;">${currentGrammarTest.title}</h2>
            <p style="font-size: 13px; color: #78350f;">${currentGrammarTest.description || 'Complete each topic below'}</p>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #92400e;">${answeredCount}/${topics.length}</div>
            <div style="font-size: 11px; color: #78350f;">Completed</div>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #48bb78;">
        <p style="color: #276749; font-size: 14px; margin: 0;">
          <strong> Instructions:</strong> For each topic, click to view the sentences, then rate your confidence from 1 (need lots of practice) to 10 (fully mastered).
        </p>
      </div>

      <!-- Topics List -->
      <div style="display: grid; gap: 15px; margin-bottom: 25px;">
  `;

  topics.forEach((topic, index) => {
    const answer = grammarTestAnswers[index];
    const isAnswered = answer !== null;

    html += `
      <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${isAnswered ? '#48bb78' : '#e2e8f0'};">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 1; cursor: pointer;" onclick="previewGrammarTestTopic(${index})">
            <h4 style="color: #2d3748; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
              ${isAnswered ? '' : ''} ${topic.title}
            </h4>
            <p style="font-size: 12px; color: #718096;">${topic.description || 'Grammar topic'}</p>
            <p style="font-size: 11px; color: #a0aec0; margin-top: 5px;">Click to preview sentences</p>
          </div>
          <div style="min-width: 200px;">
            <label style="font-size: 11px; color: #718096; display: block; margin-bottom: 5px;">Your Confidence (1-10):</label>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
              ${[1,2,3,4,5,6,7,8,9,10].map(score => `
                <button onclick="setGrammarTestAnswer(${index}, ${score})"
                  style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid ${answer === score ? '#f59e0b' : '#e2e8f0'};
                         background: ${answer === score ? '#fef3c7' : 'white'}; cursor: pointer; font-weight: ${answer === score ? '600' : '400'};
                         color: ${answer === score ? '#92400e' : '#4a5568'};">
                  ${score}
                </button>
              `).join('')}
            </div>
            ${isAnswered ? `<p style="font-size: 11px; color: #48bb78; margin-top: 5px;"> Rated ${answer}/10</p>` : ''}
          </div>
        </div>
      </div>
    `;
  });

  html += `
      </div>

      <!-- Submit Button -->
      <div style="display: flex; gap: 15px; justify-content: space-between; align-items: center;">
        <button onclick="cancelGrammarTest()" class="btn" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568;">
           Cancel
        </button>
        <button onclick="submitGrammarTest()" class="btn" style="padding: 15px 40px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; font-size: 16px; ${answeredCount < topics.length ? 'opacity: 0.5;' : ''}">
           Submit Test (${answeredCount}/${topics.length})
        </button>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

function previewGrammarTestTopic(topicIndex) {
  const topic = currentGrammarTest?.topics?.[topicIndex];
  if (!topic) return;

  const sentences = topic.sentences?.[5] || topic.sentences?.[1] || [];

  let previewHtml = '<div style="max-height: 300px; overflow-y: auto;">';
  if (sentences.length > 0) {
    sentences.slice(0, 10).forEach((s, i) => {
      previewHtml += `<div style="padding: 10px; background: ${i % 2 === 0 ? '#fafafa' : 'white'}; border-radius: 6px; margin-bottom: 5px;">
        <p style="font-size: 14px; color: #2d3748; margin-bottom: 4px;"><strong></strong> ${s.english}</p>
        <p style="font-size: 14px; color: #f59e0b;"><strong></strong> ${s.korean}</p>
      </div>`;
    });
    if (sentences.length > 10) {
      previewHtml += `<p style="text-align: center; color: #718096; font-size: 12px;">...and ${sentences.length - 10} more sentences</p>`;
    }
  } else {
    previewHtml += '<p style="color: #718096; text-align: center;">No preview sentences available</p>';
  }
  previewHtml += '</div>';

  const modal = document.createElement('div');
  modal.id = 'grammarTopicPreviewModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99999; display: flex; align-items: center; justify-content: center;';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; color: #2d3748;"> ${topic.title}</h3>
        <button onclick="this.closest('#grammarTopicPreviewModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="color: #718096; margin-bottom: 15px;">${topic.description || 'Sample sentences from this topic:'}</p>
        ${previewHtml}
      </div>
      <div style="padding: 15px 20px; background: #f7fafc; border-top: 1px solid #e2e8f0;">
        <p style="font-size: 12px; color: #718096; margin: 0;">Rate 1-10 based on how confident you feel with these patterns.</p>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function setGrammarTestAnswer(topicIndex, score) {
  grammarTestAnswers[topicIndex] = score;
  renderGrammarTestInterface();
}

function cancelGrammarTest() {
  if (confirm('Are you sure you want to cancel? Your progress will be lost.')) {
    currentGrammarTest = null;
    grammarTestAnswers = {};
    switchTab('availableGrammarTests');
  }
}

async function submitGrammarTest() {
  if (!currentGrammarTest) return;

  const topics = currentGrammarTest.topics || [];
  const answeredCount = Object.values(grammarTestAnswers).filter(v => v !== null).length;

  if (answeredCount < topics.length) {
    alert(`Please rate all ${topics.length} topics before submitting.`);
    return;
  }

  try {
    const submissionData = {
      evaluationId: currentGrammarTest.id,
      evaluationTitle: currentGrammarTest.title,
      studentId: currentUser.uid,
      studentEmail: currentUser.email,
      answers: grammarTestAnswers,
      topics: topics.map((t, i) => ({
        title: t.title,
        description: t.description,
        videoUrl: t.videoUrl,
        sentences: t.sentences,
        studentScore: grammarTestAnswers[i]
      })),
      status: 'pending',
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const docRef = await db.collection('grammarSubmissions').add(submissionData);

    alert(` Grammar Test Submitted!\n\nYour teacher will review your answers and assign drills based on your scores.`);

    currentGrammarTest = null;
    grammarTestAnswers = {};
    switchTab('availableGrammarTests');
    loadAvailableGrammarTests();

  } catch (error) {
    alert('Error submitting test: ' + error.message);
  }
}


let currentGradingSubmission = null;

async function loadGrammarSubmissionsForGrading() {
  const container = document.getElementById('grammarSubmissionsContainer');
  if (!container) return;
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div></div>';

  try {
    const evalsSnap = await db.collection('grammarEvaluations').where('createdBy', '==', currentUser.uid).get();
    const evalIds = evalsSnap.docs.map(d => d.id);

    if (evalIds.length === 0) {
      container.innerHTML = `<div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 50px; margin-bottom: 15px;"></div>
        <p>Create a grammar evaluation first to receive submissions.</p>
        <button onclick="switchTab('createGrammarEval')" class="btn" style="margin-top: 15px;">Create Evaluation</button>
      </div>`;
      return;
    }

    const subsSnap = await db.collection('grammarSubmissions').where('status', 'in', ['pending', 'graded']).orderBy('submittedAt', 'desc').get();
    const submissions = subsSnap.docs.filter(d => evalIds.includes(d.data().evaluationId)).map(d => ({ id: d.id, ...d.data() }));

    const pending = submissions.filter(s => s.status === 'pending');
    const graded = submissions.filter(s => s.status === 'graded');

    if (submissions.length === 0) {
      container.innerHTML = `<div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 50px; margin-bottom: 15px;"></div>
        <p>No submissions yet. Students will appear here once they complete your evaluations.</p>
      </div>`;
      return;
    }

    let html = '';

    if (pending.length > 0) {
      html += `<h3 style="margin-bottom: 15px; color: #f59e0b;"> Pending (${pending.length})</h3><div style="display: grid; gap: 15px; margin-bottom: 30px;">`;
      pending.forEach(sub => {
        const submitDate = sub.submittedAt?.toDate ? sub.submittedAt.toDate().toLocaleDateString() : 'Recently';
        html += `<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #f59e0b;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
              <h4 style="color: #2d3748; margin-bottom: 5px;">${sub.studentEmail}</h4>
              <p style="font-size: 12px; color: #718096;">${sub.evaluationTitle}  ${sub.topics?.length || 0} topics</p>
              <p style="font-size: 11px; color: #a0aec0;">Submitted ${submitDate}</p>
            </div>
            <button onclick="openGrammarGradingModal('${sub.id}')" class="btn" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
               Grade
            </button>
          </div>
        </div>`;
      });
      html += '</div>';
    }

    if (graded.length > 0) {
      html += `<h3 style="margin-bottom: 15px; color: #48bb78;"> Graded (${graded.length})</h3><div style="display: grid; gap: 10px;">`;
      graded.forEach(sub => {
        const gradedDate = sub.gradedAt?.toDate ? sub.gradedAt.toDate().toLocaleDateString() : 'Recently';
        html += `<div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 1px solid #48bb78;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-weight: 600; color: #276749;">${sub.studentEmail}</span>
              <span style="font-size: 12px; color: #48bb78; margin-left: 10px;">${sub.evaluationTitle}</span>
            </div>
            <span style="font-size: 12px; color: #48bb78;">Graded ${gradedDate}</span>
          </div>
        </div>`;
      });
      html += '</div>';
    }

    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `<p style="color: red; text-align: center;">Error: ${error.message}</p>`;
  }
}

async function openGrammarGradingModal(submissionId) {
  try {
    const doc = await db.collection('grammarSubmissions').doc(submissionId).get();
    if (!doc.exists) { alert('Submission not found.'); return; }

    currentGradingSubmission = { id: submissionId, ...doc.data() };
    renderGrammarGradingModal();
  } catch (error) {
    alert('Error loading submission: ' + error.message);
  }
}

function renderGrammarGradingModal() {
  if (!currentGradingSubmission) return;

  const topics = currentGradingSubmission.topics || [];

  let existingModal = document.getElementById('grammarGradingModal');
  if (existingModal) existingModal.remove();

  const modal = document.createElement('div');
  modal.id = 'grammarGradingModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 20px;';

  let html = `
    <div style="background: white; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; background: white; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 style="margin: 0 0 5px 0; color: #2d3748;"> Grade Grammar Submission</h3>
            <p style="font-size: 13px; color: #718096; margin: 0;">${currentGradingSubmission.studentEmail} - ${currentGradingSubmission.evaluationTitle}</p>
          </div>
          <button onclick="closeGrammarGradingModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #a0aec0;">&times;</button>
        </div>
      </div>

      <div style="padding: 20px;">
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f59e0b;">
          <p style="color: #92400e; font-size: 13px; margin: 0;">
            <strong> Grading Guide:</strong> The student rated themselves. Review and adjust scores if needed. Score determines which drill set they receive (1-9). Score 10 = Mastered (no drills).
          </p>
        </div>

        <div style="display: grid; gap: 15px;">
  `;

  topics.forEach((topic, index) => {
    const studentScore = topic.studentScore || grammarTestAnswers[index] || 5;
    html += `
      <div style="background: #fafafa; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 1;">
            <h4 style="color: #2d3748; margin-bottom: 5px;">${topic.title}</h4>
            <p style="font-size: 12px; color: #718096; margin-bottom: 10px;">${topic.description || ''}</p>
            <p style="font-size: 11px; color: #f59e0b;">Student self-rated: ${studentScore}/10</p>
          </div>
          <div style="min-width: 220px;">
            <label style="font-size: 11px; color: #718096; display: block; margin-bottom: 8px;">Teacher Grade (1-10):</label>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
              ${[1,2,3,4,5,6,7,8,9,10].map(score => `
                <button onclick="setGrammarGrade(${index}, ${score})" id="gradeBtn-${index}-${score}"
                  style="width: 35px; height: 35px; border-radius: 6px; border: 2px solid ${score === studentScore ? '#f59e0b' : '#e2e8f0'};
                         background: ${score === studentScore ? '#fef3c7' : 'white'}; cursor: pointer; font-weight: 500;
                         color: ${score === studentScore ? '#92400e' : '#4a5568'}; font-size: 14px;">
                  ${score}
                </button>
              `).join('')}
            </div>
            <input type="hidden" id="grammarGrade-${index}" value="${studentScore}">
          </div>
        </div>
      </div>
    `;
  });

  html += `
        </div>

        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between;">
          <button onclick="closeGrammarGradingModal()" class="btn" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568;">
            Cancel
          </button>
          <button onclick="submitGrammarGrades()" class="btn" style="padding: 15px 40px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; font-size: 16px;">
             Submit Grades & Send Drills
          </button>
        </div>
      </div>
    </div>
  `;

  modal.innerHTML = html;
  document.body.appendChild(modal);
}

function setGrammarGrade(topicIndex, score) {
  document.getElementById(`grammarGrade-${topicIndex}`).value = score;

  for (let s = 1; s <= 10; s++) {
    const btn = document.getElementById(`gradeBtn-${topicIndex}-${s}`);
    if (btn) {
      btn.style.borderColor = s === score ? '#48bb78' : '#e2e8f0';
      btn.style.background = s === score ? '#d1fae5' : 'white';
      btn.style.color = s === score ? '#276749' : '#4a5568';
      btn.style.fontWeight = s === score ? '600' : '500';
    }
  }
}

function closeGrammarGradingModal() {
  const modal = document.getElementById('grammarGradingModal');
  if (modal) modal.remove();
  currentGradingSubmission = null;
}

async function submitGrammarGrades() {
  if (!currentGradingSubmission) return;

  const topics = currentGradingSubmission.topics || [];
  const grades = {};

  topics.forEach((_, index) => {
    const input = document.getElementById(`grammarGrade-${index}`);
    grades[index] = parseInt(input?.value || '5');
  });

  try {
    await db.collection('grammarSubmissions').doc(currentGradingSubmission.id).update({
      status: 'graded',
      teacherGrades: grades,
      gradedAt: firebase.firestore.FieldValue.serverTimestamp(),
      gradedBy: currentUser.uid
    });

    await sendGrammarDrillsToStudent(currentGradingSubmission.studentId, currentGradingSubmission.id, topics, grades);

    alert(` Grades submitted!\n\nDrills have been sent to the student based on their scores.`);

    closeGrammarGradingModal();
    loadGrammarSubmissionsForGrading();

  } catch (error) {
    alert('Error: ' + error.message);
  }
}

async function sendGrammarDrillsToStudent(studentId, submissionId, topics, grades) {
  for (let i = 0; i < topics.length; i++) {
    const topic = topics[i];
    const grade = grades[i];

    if (grade >= 10) continue;

    const sentences = topic.sentences?.[grade] || topic.sentences?.[5] || [];
    if (sentences.length === 0) continue;

    try {
      const existing = await db.collection('grammarLeitner')
        .where('studentId', '==', studentId)
        .where('topicTitle', '==', topic.title)
        .where('submissionId', '==', submissionId)
        .get();

      if (!existing.empty) {
        await db.collection('grammarLeitner').doc(existing.docs[0].id).update({
          grade: grade,
          sentences: sentences,
          currentDay: 1,
          completedToday: false,
          completedRepetitionsToday: 0,
          isComplete: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection('grammarLeitner').add({
          studentId: studentId,
          submissionId: submissionId,
          topicTitle: topic.title,
          topicDescription: topic.description || '',
          videoUrl: topic.videoUrl || '',
          grade: grade,
          sentences: sentences,
          requiredRepetitions: GRAMMAR_DRILL_REPS,
          totalDays: GRAMMAR_DRILL_DAYS,
          currentDay: 1,
          completedToday: false,
          completedRepetitionsToday: 0,
          isComplete: false,
          totalReviews: 0,
          correctCount: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      console.log(`Sent grammar drill for "${topic.title}" (grade ${grade}) to student`);
    } catch (error) {
    }
  }
}


async function loadGrammarDrillTracking() {
  const container = document.getElementById('grammarDrillTrackingContainer');
  if (!container) return;
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div></div>';

  try {
    const drillsSnap = await db.collection('grammarLeitner').get();

    if (drillsSnap.empty) {
      container.innerHTML = `<div style="text-align: center; padding: 40px; color: #718096;">
        <div style="font-size: 50px; margin-bottom: 15px;"></div>
        <p>No grammar drills assigned yet.</p>
        <p style="font-size: 12px; margin-top: 10px;">Grade student submissions to assign drills.</p>
      </div>`;
      return;
    }

    const studentDrills = {};
    drillsSnap.docs.forEach(doc => {
      const data = doc.data();
      if (!studentDrills[data.studentId]) {
        studentDrills[data.studentId] = { drills: [], email: '' };
      }
      studentDrills[data.studentId].drills.push({ id: doc.id, ...data });
    });

    const studentIds = Object.keys(studentDrills);
    for (const studentId of studentIds) {
      try {
        const userDoc = await db.collection('users').doc(studentId).get();
        if (userDoc.exists) {
          studentDrills[studentId].email = userDoc.data().email || studentId;
        }
      } catch (e) {}
    }

    let html = `
      <div style="background: white; border-radius: 12px; overflow: hidden; border: 2px solid #e2e8f0;">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; padding: 15px; background: #f7fafc; font-weight: 600; font-size: 12px; color: #4a5568; border-bottom: 2px solid #e2e8f0;">
          <div>Student</div>
          <div style="text-align: center;">Total Topics</div>
          <div style="text-align: center;">Active</div>
          <div style="text-align: center;">Completed</div>
          <div style="text-align: center;">Done Today</div>
        </div>
    `;

    Object.entries(studentDrills).forEach(([studentId, data]) => {
      const drills = data.drills;
      const total = drills.length;
      const completed = drills.filter(d => d.isComplete).length;
      const active = drills.filter(d => !d.isComplete).length;
      const doneToday = drills.filter(d => d.completedToday && !d.isComplete).length;

      html += `
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; padding: 15px; border-bottom: 1px solid #e2e8f0; align-items: center;">
          <div>
            <div style="font-weight: 600; color: #2d3748;">${data.email || studentId.substring(0, 8)}</div>
          </div>
          <div style="text-align: center; font-size: 16px; font-weight: 600; color: #667eea;">${total}</div>
          <div style="text-align: center; font-size: 16px; font-weight: 600; color: #f59e0b;">${active}</div>
          <div style="text-align: center; font-size: 16px; font-weight: 600; color: #48bb78;">${completed}</div>
          <div style="text-align: center;">
            <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
                         background: ${doneToday > 0 ? '#d1fae5' : '#fed7d7'}; color: ${doneToday > 0 ? '#065f46' : '#c53030'};">
              ${doneToday}/${active}
            </span>
          </div>
        </div>
      `;
    });

    html += '</div>';

    const allDrills = drillsSnap.docs.map(d => d.data());
    const totalActive = allDrills.filter(d => !d.isComplete).length;
    const totalCompleted = allDrills.filter(d => d.isComplete).length;
    const totalDoneToday = allDrills.filter(d => d.completedToday && !d.isComplete).length;

    html = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #6366f1;">
          <div style="font-size: 32px; font-weight: bold; color: #3730a3;">${studentIds.length}</div>
          <div style="font-size: 12px; color: #4338ca;">Students</div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f59e0b;">
          <div style="font-size: 32px; font-weight: bold; color: #92400e;">${totalActive}</div>
          <div style="font-size: 12px; color: #78350f;">Active Drills</div>
        </div>
        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
          <div style="font-size: 32px; font-weight: bold; color: #065f46;">${totalCompleted}</div>
          <div style="font-size: 12px; color: #047857;">Completed</div>
        </div>
        <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ec4899;">
          <div style="font-size: 32px; font-weight: bold; color: #9d174d;">${totalDoneToday}</div>
          <div style="font-size: 12px; color: #be185d;">Done Today</div>
        </div>
      </div>
    ` + html;

    container.innerHTML = html;

  } catch (error) {
    container.innerHTML = `<p style="color: red; text-align: center;">Error: ${error.message}</p>`;
  }
}


let grammarWalkAwayRecognition = null;

function startGrammarWalkAwayListening() {
  if (!grammarWalkAwayMode) return;
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;

  stopGrammarWalkAwayListening();

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  grammarWalkAwayRecognition = new SR();
  grammarWalkAwayRecognition.lang = 'en-US';
  grammarWalkAwayRecognition.continuous = true;
  grammarWalkAwayRecognition.interimResults = false;

  grammarWalkAwayRecognition.onresult = (e) => {
    const transcript = e.results[e.results.length - 1][0].transcript.toLowerCase().trim();

    if (transcript.includes('yes') || transcript.includes('yeah') || transcript.includes('continue') || transcript.includes('next')) {
      handleGrammarWalkAwayContinue();
    } else if (transcript.includes('stop') || transcript.includes('exit') || transcript.includes('quit')) {
      grammarWalkAwayMode = false;
      exitGrammarDrill();
    }
  };

  grammarWalkAwayRecognition.onerror = (e) => {
    if (e.error !== 'no-speech') console.error('Walk-away recognition error:', e.error);
  };

  grammarWalkAwayRecognition.onend = () => {
    if (grammarWalkAwayMode && !grammarDrillState.isActive) {
      setTimeout(() => startGrammarWalkAwayListening(), 500);
    }
  };

  grammarWalkAwayRecognition.start();
}

function stopGrammarWalkAwayListening() {
  if (grammarWalkAwayRecognition) {
    grammarWalkAwayRecognition.stop();
    grammarWalkAwayRecognition = null;
  }
}

function handleGrammarWalkAwayContinue() {
  stopGrammarWalkAwayListening();

  const currentCard = grammarDrillCards.find(c => c.id === grammarDrillState.cardId);
  if (currentCard && !currentCard.completedToday && grammarDrillState.currentRepetition < GRAMMAR_DRILL_REPS) {
    continueGrammarDrill();
    return;
  }

  if (grammarDrillDueCards.length > 0) {
    const nextCard = grammarDrillDueCards[0];
    speakGrammarTTS('Starting next drill.', 'en-US');
    setTimeout(() => {
      startGrammarDrill(nextCard.id);
    }, 1000);
  }
}

</script>

<div id="situationalModal" onclick="if(event.target === this) closeSituationalModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99998; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="padding: 20px;">

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
        <h3 style="margin: 0; color: #2d3748; display: flex; align-items: center; gap: 10px;">
           Situational Responses
        </h3>
        <button onclick="closeSituationalModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #a0aec0; line-height: 1;">&times;</button>
      </div>

      <div id="situationalWordInfo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">

      </div>

      <div id="situationalScenario" style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">

      </div>

      <div id="situationalResponses">

      </div>

      <div style="margin-top: 20px; padding: 15px; background: #ebf8ff; border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <span style="font-size: 20px;"></span>
          <span style="font-weight: 600; color: #2b6cb0;">Listen & Practice</span>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="speakSituationalWord('korean')" class="btn" style="flex: 1; padding: 10px; background: #4299e1;">
             Korean
          </button>
          <button onclick="speakSituationalWord('english')" class="btn" style="flex: 1; padding: 10px; background: #48bb78;">
             English
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="folderReviewPage" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f7fafc; z-index: 99997; overflow-y: auto;">
  <div style="max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 100px;">

    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px;">
      <div style="width: 100%; display: flex; justify-content: flex-start;">
        <button onclick="closeFolderReview()" class="btn btn-secondary" style="padding: 10px 12px;">
           Back to My Flashcards
        </button>
      </div>
      <h2 id="reviewFolderTitle" style="margin: 0; color: #2d3748; text-align: center;"> Review: Folder Name</h2>
    </div>

    <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <button onclick="toggleReviewColumn('english')" id="reviewHideEnglishBtn" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
           Hide English
        </button>
        <button onclick="toggleReviewColumn('korean')" id="reviewHideKoreanBtn" class="btn" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
           Hide Korean
        </button>
        <button onclick="toggleReviewColumn('both')" id="reviewShowBothBtn" class="btn btn-secondary" style="padding: 10px 20px;">
           Show Both
        </button>
      </div>
      <p style="text-align: center; color: #718096; font-size: 12px; margin: 10px 0 0 0;">
        Cover one side to test yourself, then hover to reveal!
      </p>
    </div>

    <div id="reviewAIStatus" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
      <div style="font-size: 14px;"> Generating word data for your cards...</div>
      <div id="reviewAIProgress" style="font-size: 12px; margin-top: 5px; opacity: 0.9;">0 / 0 cards</div>
    </div>

    <div id="reviewBulkActions" style="display: none; background: #ebf8ff; border: 2px solid #4299e1; border-radius: 12px; padding: 15px; margin-bottom: 20px; overflow: hidden;">
      <div class="review-bulk-actions-container" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div class="review-bulk-select" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <input type="checkbox" id="reviewSelectAll" onchange="toggleSelectAllReviewCards()" style="width: 18px; height: 18px; cursor: pointer;">
          <label for="reviewSelectAll" style="cursor: pointer; font-weight: 600; color: #2b6cb0;">Select All</label>
          <span id="reviewSelectedCount" style="background: #4299e1; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">0 selected</span>
        </div>
        <div class="review-bulk-move" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <select id="reviewMoveToFolder" style="padding: 8px 12px; border: 2px solid #4299e1; border-radius: 8px; font-size: 13px; min-width: 140px; max-width: 100%;">
            <option value="">Move to folder...</option>
          </select>
          <button onclick="bulkMoveReviewCards()" class="btn" style="padding: 8px 16px; background: #4299e1; font-size: 13px; white-space: nowrap;">
             Move
          </button>
        </div>
      </div>
    </div>

    <div style="background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;">
      <div style="max-height: 70vh; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse;" id="reviewTable">
          <thead>
            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 10;">
              <th style="padding: 15px; text-align: center; width: 50px;">
                <input type="checkbox" id="reviewHeaderCheckbox" onchange="toggleSelectAllReviewCards()" style="width: 16px; height: 16px; cursor: pointer;">
              </th>
              <th style="padding: 15px; text-align: left; width: 50px;">#</th>
              <th style="padding: 15px; text-align: left;" class="review-english-col">English</th>
              <th style="padding: 15px; text-align: left;" class="review-korean-col">Korean (hover for definitions)</th>
              <th style="padding: 15px; text-align: center; width: 80px;">Box</th>
            </tr>
          </thead>
          <tbody id="reviewTableBody">

          </tbody>
        </table>
      </div>
    </div>

    <div style="margin-top: 20px; margin-bottom: 30px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <div style="background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div id="reviewTotalCards" style="font-size: 28px; font-weight: bold; color: #667eea;">0</div>
        <div style="font-size: 12px; color: #718096;">Total Cards</div>
      </div>
      <div style="background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <div id="reviewWithAI" style="font-size: 28px; font-weight: bold; color: #48bb78;">0</div>
        <div style="font-size: 12px; color: #718096;">With Word Data</div>
      </div>
    </div>
  </div>
</div>

<div id="wordHoverTooltip" style="display: none; position: fixed; background: white; border: 2px solid #667eea; border-radius: 12px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 999999; max-width: 320px; font-size: 14px;">
  <div id="tooltipContent"></div>
</div>

<div id="studentProfileModal" onclick="if(event.target === this) closeStudentProfileModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 20px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="padding: 25px;">

      <div style="display: flex; justify-content: flex-end; margin-bottom: -10px;">
        <button onclick="closeStudentProfileModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #a0aec0; line-height: 1;">&times;</button>
      </div>

      <div style="text-align: center; margin-bottom: 20px;">
        <div id="modalProfileAvatar" style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; overflow: hidden; border: 4px solid #667eea; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 40px; color: white;">
          
        </div>
        <h2 id="modalProfileName" style="margin: 0 0 5px 0; color: #2d3748; font-size: 24px;">Student Name</h2>
        <div id="modalProfileLevel" style="display: inline-block; background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">
           Novice
        </div>
      </div>

      <div id="modalProfileBioSection" style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <div style="font-size: 12px; color: #718096; margin-bottom: 5px; font-weight: 600;"> About</div>
        <div id="modalProfileBio" style="color: #4a5568; font-size: 14px; line-height: 1.5;">No bio yet</div>
      </div>

      <div id="modalProfileKContentSection" style="background: #faf5ff; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <div style="font-size: 12px; color: #805ad5; margin-bottom: 5px; font-weight: 600;"> Favorite K-Drama/K-Pop</div>
        <div id="modalProfileKContent" style="color: #553c9a; font-size: 14px;">Not specified</div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">

        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px 10px; border-radius: 12px; text-align: center;">
          <div id="modalProfileCoins" style="font-size: 24px; font-weight: bold; color: #92400e;">0</div>
          <div style="font-size: 11px; color: #a16207;"> Coins</div>
        </div>

        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px 10px; border-radius: 12px; text-align: center;">
          <div id="modalProfileVocab" style="font-size: 24px; font-weight: bold; color: #1e40af;">0</div>
          <div style="font-size: 11px; color: #1d4ed8;"> Vocab</div>
        </div>

        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px 10px; border-radius: 12px; text-align: center;">
          <div id="modalProfileWeekly" style="font-size: 24px; font-weight: bold; color: #065f46;">0</div>
          <div style="font-size: 11px; color: #047857;"> Day 4+</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">

        <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 15px; border-radius: 12px; text-align: center;">
          <div id="modalProfileMastered" style="font-size: 24px; font-weight: bold; color: #9d174d;">0</div>
          <div style="font-size: 11px; color: #be185d;"> Mastered</div>
        </div>

        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 12px; text-align: center;">
          <div id="modalProfileStreak" style="font-size: 24px; font-weight: bold; color: #991b1b;">0</div>
          <div style="font-size: 11px; color: #dc2626;"> Day Streak</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

(function() {
  'use strict';
  if (window._mobileNavInitialized) return;
  window._mobileNavInitialized = true;

  function isMobile() { return window.innerWidth <= 768; }

  function checkMobileLoginState() {
    var dashboard = document.getElementById('dashboard');
    var isLoggedIn = dashboard && !dashboard.classList.contains('hidden');
    if (isLoggedIn) document.body.classList.add('mobile-logged-in');
    else document.body.classList.remove('mobile-logged-in');
  }

  window.mobileNavTo = function(tabId) {
    closeMobileGamesMenu(); closeMobileHomeMenu(); closeMobileProfile();
    if (typeof switchTab === 'function') switchTab(tabId);
    updateMobileNavActive(tabId);
    if (tabId === 'mobileHome') {
      setTimeout(updateMobileHomeStats, 100);
    }
  };

  window.updateMobileNavActive = function(tabId) {
    document.querySelectorAll('.mobile-nav-item').forEach(function(item) {
      item.classList.remove('active');
      var itemTab = item.getAttribute('data-tab');
      if (itemTab === 'home' && (tabId === 'mobileHome' || ['grammarDrill', 'pronunciationDrills', 'grammarDrills'].includes(tabId))) item.classList.add('active');
      else if (itemTab === 'allInOne' && tabId === 'allInOne') item.classList.add('active');
      else if (itemTab === 'dailyActivity' && tabId === 'dailyActivity') item.classList.add('active');
      else if (itemTab === 'leaderboard' && tabId === 'studentLeaderboard') item.classList.add('active');
      else if (itemTab === 'games' && ['flashcardGames', 'myFlashcards', 'marketplacePopular', 'marketplaceCategories', 'myPurchases', 'masteryDeck', 'leitnerBoxes', 'leitnerStats'].includes(tabId)) item.classList.add('active');
    });
  };

  window.toggleMobileGamesMenu = function() {
    closeMobileHomeMenu();
    closeMobileProfile();
    var menu = document.getElementById('mobileGamesMenu');
    var overlay = document.getElementById('mobileMenuOverlay');
    if (menu && menu.classList.contains('active')) { closeMobileGamesMenu(); }
    else { if (menu) menu.classList.add('active'); if (overlay) overlay.classList.add('active'); }
  };

  window.closeMobileGamesMenu = function() {
    var menu = document.getElementById('mobileGamesMenu');
    var overlay = document.getElementById('mobileMenuOverlay');
    if (menu) menu.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
  };

  window.toggleMobileDrillsMenu = function() {
    toggleMobileHomeMenu();
  };

  window.closeMobileDrillsMenu = function() {
    closeMobileHomeMenu();
  };

  window.toggleMobileHomeMenu = function() {
    closeMobileGamesMenu();
    closeMobileProfile();
    var menu = document.getElementById('mobileHomeMenu');
    var overlay = document.getElementById('mobileHomeOverlay');
    if (menu && menu.classList.contains('active')) { closeMobileHomeMenu(); }
    else { if (menu) menu.classList.add('active'); if (overlay) overlay.classList.add('active'); }
  };

  window.closeMobileHomeMenu = function() {
    var menu = document.getElementById('mobileHomeMenu');
    var overlay = document.getElementById('mobileHomeOverlay');
    if (menu) menu.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
  };

  function init() {
    checkMobileLoginState();
    setInterval(checkMobileLoginState, 2000);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  var origShowDashboard = window.showDashboard;
  if (typeof origShowDashboard === 'function') {
    window.showDashboard = function() {
      origShowDashboard.apply(this, arguments);
      setTimeout(function() {
        checkMobileLoginState();
        if (isMobile()) {

          document.querySelectorAll('.mobile-nav-item').forEach(function(i) { i.classList.remove('active'); });

          var dailyNav = document.querySelector('.mobile-nav-item[data-tab="dailyActivity"]');
          if (dailyNav) {
            dailyNav.classList.add('active');
          }

          var allTabs = document.querySelectorAll('#studentDashboard .tab-content');
          allTabs.forEach(function(tab) {
            tab.classList.remove('active');
          });

          var dailyActivityTab = document.getElementById('dailyActivity');
          if (dailyActivityTab) {
            dailyActivityTab.classList.add('active');
          }

          if (typeof loadStudentDailyActivity === 'function') {
            loadStudentDailyActivity();
          }
          if (typeof initTeamworkActivity === 'function') {
            initTeamworkActivity();
          }
          if (typeof initKpopActivity === 'function') {
            initKpopActivity();
          }
          if (typeof initGrammarBlabber === 'function') {
            initGrammarBlabber();
          }
        }
      }, 300);
    };
  }

  window.dailyProgressData = {
    date: new Date().toDateString(),
    coins: 0,
    activities: 0
  };

  window.trackDailyProgress = function(type, amount) {
    var today = new Date().toDateString();
    if (window.dailyProgressData.date !== today) {
      window.dailyProgressData = { date: today, coins: 0, activities: 0 };
    }
    if (type === 'coins') {
      window.dailyProgressData.coins += amount;
    } else if (type === 'activity') {
      window.dailyProgressData.activities += (amount || 1);
    }
    updateMobileHomeDailyStats();
    
    try {
      localStorage.setItem('dailyProgressData', JSON.stringify(window.dailyProgressData));
    } catch(e) {}
  };

  window.loadDailyProgressData = function() {
    try {
      var saved = localStorage.getItem('dailyProgressData');
      if (saved) {
        var data = JSON.parse(saved);
        var today = new Date().toDateString();
        if (data.date === today) {
          window.dailyProgressData = data;
        } else {
          window.dailyProgressData = { date: today, coins: 0, activities: 0 };
          localStorage.setItem('dailyProgressData', JSON.stringify(window.dailyProgressData));
        }
      }
    } catch(e) {}
    updateMobileHomeDailyStats();
  };

  window.updateMobileHomeDailyStats = function() {
    var dailyCoinsEl = document.getElementById('mobileHomeDailyCoins');
    var dailyActivitiesEl = document.getElementById('mobileHomeDailyActivities');
    
    if (dailyCoinsEl) {
      dailyCoinsEl.textContent = window.dailyProgressData.coins || 0;
    }
    if (dailyActivitiesEl) {
      dailyActivitiesEl.textContent = window.dailyProgressData.activities || 0;
    }
  };

  window.updateMobileHomeStats = function() {
    updateMobileHomeDailyStats();
  };

  function setupMobileHomeStatsObserver() {
    loadDailyProgressData();
    
    setInterval(function() {
      var mobileHomeTab = document.getElementById('mobileHome');
      if (mobileHomeTab && mobileHomeTab.classList.contains('active')) {
        updateMobileHomeDailyStats();
      }
    }, 2000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMobileHomeStatsObserver);
  } else {
    setupMobileHomeStatsObserver();
  }

  var origSwitchTab = window.switchTab;
  if (typeof origSwitchTab === 'function') {
    window.switchTab = function(tabName) {
      origSwitchTab.apply(this, arguments);
      if (isMobile()) updateMobileNavActive(tabName);
    };
  }

})();


async function loadMobileProfileData() {

  var user = window.currentUser || (window.firebase && firebase.auth().currentUser);
  if (!user) {
    if (window.firebase && firebase.auth) {
      user = firebase.auth().currentUser;
    }
  }

  if (!user) {
    return;
  }

  var database = window.db || (window.firebase && firebase.firestore());
  if (!database) {
    return;
  }

  var uid = user.uid;

  try {
    var displayName = 'Student';
    var avatarUrl = null;
    var bio = '';
    var koreanLevel = 'beginner';
    var favoriteKContent = '';

    try {
      var userDoc = await database.collection('users').doc(uid).get();
      if (userDoc.exists) {
        var userData = userDoc.data();
        displayName = userData.displayName || user.email?.split('@')[0] || 'Student';
        avatarUrl = userData.avatarUrl || null;
      }
    } catch(e) { }

    var coins = 0;
    var monthlyGoal = 50;
    var activityOptIn = true;

    try {
      var profileDoc = await database.collection('studentProfiles').doc(uid).get();
      if (profileDoc.exists) {
        var profileData = profileDoc.data();
        coins = profileData.coins || 0;
        monthlyGoal = profileData.monthlyGoal || 50;
        koreanLevel = profileData.koreanLevel || 'beginner';
        bio = profileData.bio || '';
        favoriteKContent = profileData.favoriteKContent || '';
        activityOptIn = profileData.activityOptIn !== false;
      }
    } catch(e) { }

    var nameEl = document.getElementById('mobileProfileName');
    if (nameEl) nameEl.textContent = displayName;

    var coinsEl = document.getElementById('mobileProfileCoinsHeader');
    if (coinsEl) coinsEl.textContent = coins;

    var avatarEl = document.getElementById('mobileProfileAvatar');
    if (avatarEl && avatarUrl) {
      avatarEl.innerHTML = '<img src="' + avatarUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"><div class="mobile-avatar-edit"></div>';
    }

    var currentStreak = 0;
    try {
      var statsDoc = await database.collection('leitnerStats').doc(uid).get();
      if (statsDoc.exists) {
        currentStreak = statsDoc.data().currentStreak || 0;
      }
    } catch(e) {}

    var streakEl = document.getElementById('mobileStreakCount');
    var statStreakEl = document.getElementById('mobileStatStreak');
    if (streakEl) streakEl.textContent = currentStreak;
    if (statStreakEl) statStreakEl.textContent = currentStreak;

    var weekStart = getMobileWeekStart();

    var pronDrillsThisWeek = 0;
    try {
      var pronStatsDoc = await database.collection('studentPronunciationStats').doc(uid).get();
      if (pronStatsDoc.exists) {
        var drillLog = pronStatsDoc.data().drillLog || {};
        pronDrillsThisWeek = sumMobileWeeklyFromLog(drillLog, weekStart);
      }
    } catch(e) {}

    var pronDrillsEl = document.getElementById('mobileStatPronDrills');
    if (pronDrillsEl) pronDrillsEl.textContent = pronDrillsThisWeek;

    var leitnerRepsThisWeek = 0;
    try {
      var leitnerStatsDoc = await database.collection('leitnerStats').doc(uid).get();
      if (leitnerStatsDoc.exists) {
        leitnerRepsThisWeek += sumMobileWeeklyFromLog(leitnerStatsDoc.data().studyLog || {}, weekStart);
      }
    } catch(e) {}

    try {
      var myCardsStatsDoc = await database.collection('myCardsStats').doc(uid).get();
      if (myCardsStatsDoc.exists) {
        leitnerRepsThisWeek += sumMobileWeeklyFromLog(myCardsStatsDoc.data().reviewLog || {}, weekStart);
      }
    } catch(e) {}

    try {
      var studentFlashcardStatsDoc = await database.collection('studentFlashcardStats').doc(uid).get();
      if (studentFlashcardStatsDoc.exists) {
        leitnerRepsThisWeek += sumMobileWeeklyFromLog(studentFlashcardStatsDoc.data().reviewLog || {}, weekStart);
      }
    } catch(e) {}

    var leitnerRepsEl = document.getElementById('mobileStatLeitnerReps');
    if (leitnerRepsEl) leitnerRepsEl.textContent = leitnerRepsThisWeek;

    var totalRecordingSeconds = 0;
    try {
      var submissionsSnap = await database.collection('dailySubmissions')
        .where('studentId', '==', uid)
        .get();
      submissionsSnap.docs.forEach(function(doc) {
        if (doc.data().recordingDuration) {
          totalRecordingSeconds += doc.data().recordingDuration;
        }
      });
    } catch(e) {}

    var recordingTimeEl = document.getElementById('mobileStatRecordingTime');
    if (recordingTimeEl) recordingTimeEl.textContent = formatMobileDuration(totalRecordingSeconds);

    var totalMastered = 0;
    try {
      var masterySnapshot = await database.collection('masteryDeck')
        .where('studentId', '==', uid)
        .get();
      totalMastered = masterySnapshot.size;
    } catch(e) {}

    var percent = Math.min(100, Math.round((totalMastered / monthlyGoal) * 100));

    var goalFill = document.getElementById('mobileGoalsProgressFill');
    var goalText = document.getElementById('mobileGoalsProgressText');
    var goalPercent = document.getElementById('mobileGoalsPercentText');
    if (goalFill) goalFill.style.width = percent + '%';
    if (goalText) goalText.textContent = totalMastered + ' / ' + monthlyGoal;
    if (goalPercent) goalPercent.textContent = percent + '%';

    await loadMobileCalendar(database, uid);

    await loadMobileDailyCorrectionsPreview(database, uid);

    loadMobileAchievements(totalMastered, currentStreak, leitnerRepsThisWeek, coins, pronDrillsThisWeek);

    await loadMobileActivityFeed(database);

    var optInEl = document.getElementById('mobileActivityOptIn');
    if (optInEl) optInEl.checked = activityOptIn;

    var editNameEl = document.getElementById('mobileEditDisplayName');
    if (editNameEl) editNameEl.value = displayName;

    var editBioEl = document.getElementById('mobileEditBio');
    if (editBioEl) editBioEl.value = bio;

    var editLevelEl = document.getElementById('mobileEditKoreanLevel');
    if (editLevelEl) editLevelEl.value = koreanLevel;

    var editKContentEl = document.getElementById('mobileEditFavoriteKContent');
    if (editKContentEl) editKContentEl.value = favoriteKContent;


  } catch (error) {
  }
}

async function loadMobileCalendar(database, uid) {
  var calendarGrid = document.getElementById('mobileCalendarGrid');
  var monthLabel = document.getElementById('mobileCalendarMonth');
  if (!calendarGrid) return;

  var now = new Date();
  var year = now.getFullYear();
  var month = now.getMonth();

  var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
  if (monthLabel) monthLabel.textContent = monthNames[month] + ' ' + year;

  var startOfMonth = new Date(year, month, 1);
  var endOfMonth = new Date(year, month + 1, 0);

  try {
    var activityDoc = await database.collection('studentActivity').doc(uid).get();
    var activityData = activityDoc.exists ? activityDoc.data() : {};
    var dailyActivity = activityData.dailyActivity || {};

    var submissionsSnapshot = await database.collection('dailySubmissions')
      .where('studentId', '==', uid)
      .get();

    var submissionDates = {};
    var gradedDates = {};
    submissionsSnapshot.docs.forEach(function(doc) {
      var data = doc.data();
      var submitDate = data.submittedAt && data.submittedAt.toDate ? data.submittedAt.toDate() : null;
      if (submitDate) {
        var dateKey = submitDate.getFullYear() + '-' + String(submitDate.getMonth() + 1).padStart(2, '0') + '-' + String(submitDate.getDate()).padStart(2, '0');
        submissionDates[dateKey] = true;
        if (data.isGraded) {
          gradedDates[dateKey] = true;
        }
      }
    });

    var characterImages = {
      0: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246',
      1: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Pixel_Fox_Character_remix_01k6575q5hfdc80wrh32w9qr8k.png?v=1766748246',
      2: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0430_Gameboy_Chibi_Polar_Bear_remix_01k654mybgen38nj0ka69mkhsb.png?v=1766748246',
      3: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20251019_1559_Chibi_Shark_Charm_remix_01k7z0t53be7cbmdvf32a4m776.png?v=1766748286',
      4: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/chib1.png?v=1766748245',
      5: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Chibi_Moon_Character_remix_01k6574v2yekcvhkxcr306kj29.png?v=1766748246',
      6: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/20250927_0514_Chibi_Moon_Character_remix_01k6574v2yekcvhkxcr306kj29.png?v=1766748246'
    };

    var html = '';

    var dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    dayLabels.forEach(function(d) {
      html += '<div class="mobile-calendar-day-label">' + d + '</div>';
    });

    var firstDay = startOfMonth.getDay();
    for (var i = 0; i < firstDay; i++) {
      html += '<div class="mobile-calendar-day empty"></div>';
    }

    var daysInMonth = endOfMonth.getDate();
    var today = now.getDate();

    for (var day = 1; day <= daysInMonth; day++) {
      var dateKey = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
      var activity = dailyActivity[dateKey] || 0;

      var level = 0;
      if (activity >= 10) level = 4;
      else if (activity >= 5) level = 3;
      else if (activity >= 3) level = 2;
      else if (activity >= 1) level = 1;

      var isToday = day === today;
      var hasSubmission = submissionDates[dateKey];
      var isGraded = gradedDates[dateKey];

      var dateObj = new Date(year, month, day);
      var dayOfWeek = dateObj.getDay();
      var characterUrl = characterImages[dayOfWeek];

      var indicator = '';
      if (isGraded && level > 0 && characterUrl) {
        indicator = '<img src="' + characterUrl + '" style="position:absolute;top:-6px;right:-6px;width:16px;height:16px;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));animation:calendarBounce 2s ease-in-out infinite;">';
      } else if (hasSubmission) {
        indicator = '<span style="position:absolute;top:-2px;right:-2px;font-size:6px;">' + (isGraded ? '' : '') + '</span>';
      }

      var border = hasSubmission ? 'border:2px solid ' + (isGraded ? '#48bb78' : '#f687b3') + ';' : '';
      var todayClass = isToday ? ' today' : '';

      var clickHandler = hasSubmission ? 'onclick="openDailyCorrectionsPage(\'' + dateKey + '\'); closeMobileProfile();" style="cursor:pointer;position:relative;' + border + '"' : 'style="position:relative;' + border + '"';

      html += '<div class="mobile-calendar-day level-' + level + todayClass + '" ' + clickHandler + '>'+
              '<span style="font-size:8px;">' + day + '</span>' + indicator + '</div>';
    }

    calendarGrid.innerHTML = html;

  } catch (e) {
  }
}

async function loadMobileDailyCorrectionsPreview(database, uid) {
  var preview = document.getElementById('mobileDailyCorrectionsPreview');
  if (!preview) return;

  try {
    var snapshot = await database.collection('pronunciationLeitner')
      .where('studentId', '==', uid)
      .get();

    var pendingCount = 0;
    snapshot.docs.forEach(function(doc) {
      var data = doc.data();
      if (data.isDailyActivity && !data.isComplete) {
        pendingCount++;
      }
    });

    if (pendingCount > 0) {
      preview.innerHTML = '<span style="color: #f687b3; font-weight: 500;"> ' + pendingCount + ' drill' + (pendingCount > 1 ? 's' : '') + ' pending</span>';
    } else {
      preview.innerHTML = '<span style="color: #68d391;"> All drills complete!</span>';
    }
  } catch(e) {
    preview.innerHTML = '';
  }
}

function loadMobileAchievements(totalMastered, currentStreak, totalReviews, coins, pronDrills) {
  var grid = document.getElementById('mobileBadgesGrid');
  if (!grid) return;

  var badges = [
    { icon: '', name: '7-Day Streak', earned: currentStreak >= 7 },
    { icon: '', name: '30-Day Streak', earned: currentStreak >= 30 },
    { icon: '', name: '100 Words', earned: totalMastered >= 100 },
    { icon: '', name: '500 Words', earned: totalMastered >= 500 },
    { icon: '', name: '50 Phrases', earned: false }, // Same as desktop - will be updated
    { icon: '', name: 'Perfect Pron', earned: false }, // Same as desktop
    { icon: '', name: 'Grammar Master', earned: false }, // Same as desktop
    { icon: '', name: '1000 Coins', earned: coins >= 1000 }
  ];

  var html = '';
  badges.forEach(function(badge) {
    html += '<div class="mobile-badge-item ' + (badge.earned ? 'earned' : 'unearned') + '">';
    html += '<div class="mobile-badge-icon">' + badge.icon + '</div>';
    html += '<div class="mobile-badge-name">' + badge.name + '</div>';
    html += '</div>';
  });

  grid.innerHTML = html;
}

async function loadMobileActivityFeed(database) {
  var feed = document.getElementById('mobileActivityFeed');
  if (!feed) return;

  try {
    var activitySnapshot = await database.collection('activityFeed')
      .orderBy('timestamp', 'desc')
      .limit(5)
      .get();

    if (activitySnapshot.empty) {
      feed.innerHTML = '<div class="mobile-activity-empty">No recent activity</div>';
      return;
    }

    var html = '';
    activitySnapshot.docs.forEach(function(doc) {
      var a = doc.data();
      if (a.optIn === false) return;

      var timeAgo = '';
      if (a.timestamp) {
        var time = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
        var diff = Math.floor((new Date() - time) / 1000);
        if (diff < 60) timeAgo = 'Just now';
        else if (diff < 3600) timeAgo = Math.floor(diff / 60) + 'm ago';
        else if (diff < 86400) timeAgo = Math.floor(diff / 3600) + 'h ago';
        else timeAgo = Math.floor(diff / 86400) + 'd ago';
      }

      html += '<div class="mobile-activity-item">';
      html += '<div class="mobile-activity-avatar">';
      if (a.avatarUrl) {
        html += '<img src="' + a.avatarUrl + '">';
      } else {
        html += a.initials || '';
      }
      html += '</div>';
      html += '<div class="mobile-activity-content">';
      html += '<div class="mobile-activity-text">' + (a.message || '') + '</div>';
      html += '<div class="mobile-activity-time">' + timeAgo + '</div>';
      html += '</div></div>';
    });

    feed.innerHTML = html || '<div class="mobile-activity-empty">No activity</div>';
  } catch(e) {
    feed.innerHTML = '<div class="mobile-activity-empty">Unable to load</div>';
  }
}

async function saveMobileProfileEdits() {
  var user = window.currentUser || (window.firebase && firebase.auth().currentUser);
  if (!user) return;

  var database = window.db || (window.firebase && firebase.firestore());
  if (!database) return;

  var displayName = document.getElementById('mobileEditDisplayName')?.value?.trim() || '';
  var bio = document.getElementById('mobileEditBio')?.value?.trim() || '';
  var koreanLevel = document.getElementById('mobileEditKoreanLevel')?.value || 'beginner';
  var favoriteKContent = document.getElementById('mobileEditFavoriteKContent')?.value?.trim() || '';

  try {
    await database.collection('users').doc(user.uid).set({
      displayName: displayName
    }, { merge: true });

    await database.collection('studentProfiles').doc(user.uid).set({
      bio: bio,
      koreanLevel: koreanLevel,
      favoriteKContent: favoriteKContent
    }, { merge: true });

    var nameEl = document.getElementById('mobileProfileName');
    if (nameEl) nameEl.textContent = displayName || 'Student';

    var panelName = document.getElementById('panelDisplayName');
    if (panelName) panelName.textContent = displayName || 'Student';

    alert(' Profile saved!');
  } catch(e) {
    alert(' Error saving profile');
  }
}

async function toggleMobileActivityOptIn() {
  var user = window.currentUser || (window.firebase && firebase.auth().currentUser);
  if (!user) return;

  var database = window.db || (window.firebase && firebase.firestore());
  if (!database) return;

  var mobileOptIn = document.getElementById('mobileActivityOptIn');
  var newValue = mobileOptIn ? mobileOptIn.checked : true;

  var desktopOptIn = document.getElementById('activityOptIn');
  if (desktopOptIn) desktopOptIn.checked = newValue;

  try {
    await database.collection('studentProfiles').doc(user.uid).set({
      activityOptIn: newValue
    }, { merge: true });
  } catch(e) {}
}

function getMobileWeekStart() {
  var now = new Date();
  var estOffset = -5 * 60;
  var utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  var estTime = new Date(utc + (estOffset * 60000));
  if (estTime.getHours() < 3) estTime.setDate(estTime.getDate() - 1);
  var dayOfWeek = estTime.getDay();
  var daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
  var monday = new Date(estTime);
  monday.setDate(monday.getDate() - daysToMonday);
  monday.setHours(3, 0, 0, 0);
  return monday;
}

function sumMobileWeeklyFromLog(log, weekStart) {
  if (!log) return 0;
  var total = 0;
  var weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 7);
  Object.entries(log).forEach(function([dateStr, count]) {
    var logDate = new Date(dateStr + 'T12:00:00');
    if (logDate >= weekStart && logDate < weekEnd) total += count;
  });
  return total;
}

function formatMobileDuration(totalSeconds) {
  if (!totalSeconds) return '0:00';
  totalSeconds = Math.round(totalSeconds);
  var hours = Math.floor(totalSeconds / 3600);
  var minutes = Math.floor((totalSeconds % 3600) / 60);
  var seconds = totalSeconds % 60;
  if (hours > 0) return hours + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  return minutes + ':' + String(seconds).padStart(2, '0');
}

function syncMobileThemeToggle() {
  var mobileToggle = document.getElementById('mobileThemeToggle');
  var profileToggle = document.getElementById('profileThemeToggle');
  var themeToggle = document.getElementById('themeToggle');

  if (mobileToggle) {
    var isDark = !document.body.classList.contains('light-mode');
    mobileToggle.checked = isDark;
  }
}

window.openMobileProfile = function() {
  var overlay = document.getElementById('mobileProfileOverlay');
  if (overlay) {
    overlay.classList.add('active');
    loadMobileProfileData();
    syncMobileThemeToggle();
    document.querySelectorAll('.mobile-nav-item').forEach(function(item) {
      item.classList.remove('active');
    });
    var profileNav = document.querySelector('.mobile-nav-item[data-tab="profile"]');
    if (profileNav) profileNav.classList.add('active');
  }
};

window.closeMobileProfile = function() {
  var overlay = document.getElementById('mobileProfileOverlay');
  if (overlay) overlay.classList.remove('active');
  var profileNav = document.querySelector('.mobile-nav-item[data-tab="profile"]');
  if (profileNav) profileNav.classList.remove('active');
};

window.mobileLogout = function() {
  closeMobileProfile();
  if (typeof logout === 'function') logout();
};

window.loadMobileProfileData = loadMobileProfileData;
window.saveMobileProfileEdits = saveMobileProfileEdits;
window.toggleMobileActivityOptIn = toggleMobileActivityOptIn;
window.syncMobileThemeToggle = syncMobileThemeToggle;

(function() {
  var origToggleLightMode = window.toggleLightMode;
  if (typeof origToggleLightMode === 'function') {
    window.toggleLightMode = function(event) {
      origToggleLightMode.apply(this, arguments);

      var mobileToggle = document.getElementById('mobileThemeToggle');
      if (mobileToggle) {
        var isDark = !document.body.classList.contains('light-mode');
        mobileToggle.checked = isDark;
      }
    };
  }

  var origLoadTheme = window.loadThemePreference;
  if (typeof origLoadTheme === 'function') {
    window.loadThemePreference = function() {
      origLoadTheme.apply(this, arguments);

      var mobileToggle = document.getElementById('mobileThemeToggle');
      if (mobileToggle) {
        var isDark = !document.body.classList.contains('light-mode');
        mobileToggle.checked = isDark;
      }
    };
  }
})();


</script>

</body>
</html>
